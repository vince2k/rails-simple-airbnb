// mapbox-gl@3.9.4 downloaded from https://ga.jspm.io/npm:mapbox-gl@3.9.4/dist/mapbox-gl.js

var k=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var F={};(function(k,Me){F=Me()})(0,(function(){var F,Me,Ae;function define(k,Oe){if(F)if(Me){var Fe="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+F+")(sharedChunk); ("+Me+")(sharedChunk); self.onerror = null;";var je={};F(je);Ae=Oe(je);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(Ae.workerUrl=window.URL.createObjectURL(new Blob([Fe],{type:"text/javascript"})))}else Me=Oe;else F=Oe}define(["exports"],(function(F){function e(k){return k&&k.__esModule&&Object.prototype.hasOwnProperty.call(k,"default")?k.default:k}var Me,Ae={},Oe={};function a(){if(Me)return Oe;Me=1,Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.setMatrixArrayType=function(k){Oe.ARRAY_TYPE=F=k},Oe.toRadian=function(k){return k*Fe},Oe.equals=function(F,Me){return Math.abs(F-Me)<=k*Math.max(1,Math.abs(F),Math.abs(Me))},Oe.RANDOM=Oe.ARRAY_TYPE=Oe.EPSILON=void 0;var k=1e-6;Oe.EPSILON=k;var F="undefined"!=typeof Float32Array?Float32Array:Array;Oe.ARRAY_TYPE=F;var Ae=Math.random;Oe.RANDOM=Ae;var Fe=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var k=0,F=arguments.length;F--;)k+=arguments[F]*arguments[F];return Math.sqrt(k)}),Oe}var Fe,je={};function l(){if(Fe)return je;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}Fe=1,Object.defineProperty(je,"__esModule",{value:!0}),je.create=function(){var F=new k.ARRAY_TYPE(4);return k.ARRAY_TYPE!=Float32Array&&(F[1]=0,F[2]=0),F[0]=1,F[3]=1,F},je.clone=function(F){var Me=new k.ARRAY_TYPE(4);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me[3]=F[3],Me},je.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k},je.identity=function(k){return k[0]=1,k[1]=0,k[2]=0,k[3]=1,k},je.fromValues=function(F,Me,Ae,Oe){var Fe=new k.ARRAY_TYPE(4);return Fe[0]=F,Fe[1]=Me,Fe[2]=Ae,Fe[3]=Oe,Fe},je.set=function(k,F,Me,Ae,Oe){return k[0]=F,k[1]=Me,k[2]=Ae,k[3]=Oe,k},je.transpose=function(k,F){if(k===F){var Me=F[1];k[1]=F[2],k[2]=Me}else k[0]=F[0],k[1]=F[2],k[2]=F[1],k[3]=F[3];return k},je.invert=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Me*Fe-Oe*Ae;return je?(k[0]=Fe*(je=1/je),k[1]=-Ae*je,k[2]=-Oe*je,k[3]=Me*je,k):null},je.adjoint=function(k,F){var Me=F[0];return k[0]=F[3],k[1]=-F[1],k[2]=-F[2],k[3]=Me,k},je.determinant=function(k){return k[0]*k[3]-k[2]*k[1]},je.multiply=n,je.rotate=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Math.sin(Me),pt=Math.cos(Me);return k[0]=Ae*pt+Fe*qe,k[1]=Oe*pt+je*qe,k[2]=Ae*-qe+Fe*pt,k[3]=Oe*-qe+je*pt,k},je.scale=function(k,F,Me){var Ae=F[1],Oe=F[2],Fe=F[3],je=Me[0],qe=Me[1];return k[0]=F[0]*je,k[1]=Ae*je,k[2]=Oe*qe,k[3]=Fe*qe,k},je.fromRotation=function(k,F){var Me=Math.sin(F),Ae=Math.cos(F);return k[0]=Ae,k[1]=Me,k[2]=-Me,k[3]=Ae,k},je.fromScaling=function(k,F){return k[0]=F[0],k[1]=0,k[2]=0,k[3]=F[1],k},je.str=function(k){return"mat2("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+")"},je.frob=function(k){return Math.hypot(k[0],k[1],k[2],k[3])},je.LDU=function(k,F,Me,Ae){return k[2]=Ae[2]/Ae[0],Me[0]=Ae[0],Me[1]=Ae[1],Me[3]=Ae[3]-k[2]*Me[1],[k,F,Me]},je.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k[3]=F[3]+Me[3],k},je.subtract=i,je.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]&&k[3]===F[3]},je.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Me[0],pt=Me[1],vt=Me[2],Ut=Me[3];return Math.abs(Ae-qe)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(qe))&&Math.abs(Oe-pt)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(pt))&&Math.abs(Fe-vt)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(vt))&&Math.abs(je-Ut)<=k.EPSILON*Math.max(1,Math.abs(je),Math.abs(Ut))},je.multiplyScalar=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k[3]=F[3]*Me,k},je.multiplyScalarAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k[2]=F[2]+Me[2]*Ae,k[3]=F[3]+Me[3]*Ae,k},je.sub=je.mul=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Me[0],pt=Me[1],vt=Me[2],Ut=Me[3];return k[0]=Ae*qe+Fe*pt,k[1]=Oe*qe+je*pt,k[2]=Ae*vt+Fe*Ut,k[3]=Oe*vt+je*Ut,k}function i(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k[2]=F[2]-Me[2],k[3]=F[3]-Me[3],k}return je.mul=n,je.sub=i,je}var qe,pt={};function h(){if(qe)return pt;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}qe=1,Object.defineProperty(pt,"__esModule",{value:!0}),pt.create=function(){var F=new k.ARRAY_TYPE(6);return k.ARRAY_TYPE!=Float32Array&&(F[1]=0,F[2]=0,F[4]=0,F[5]=0),F[0]=1,F[3]=1,F},pt.clone=function(F){var Me=new k.ARRAY_TYPE(6);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me[3]=F[3],Me[4]=F[4],Me[5]=F[5],Me},pt.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k[4]=F[4],k[5]=F[5],k},pt.identity=function(k){return k[0]=1,k[1]=0,k[2]=0,k[3]=1,k[4]=0,k[5]=0,k},pt.fromValues=function(F,Me,Ae,Oe,Fe,je){var qe=new k.ARRAY_TYPE(6);return qe[0]=F,qe[1]=Me,qe[2]=Ae,qe[3]=Oe,qe[4]=Fe,qe[5]=je,qe},pt.set=function(k,F,Me,Ae,Oe,Fe,je){return k[0]=F,k[1]=Me,k[2]=Ae,k[3]=Oe,k[4]=Fe,k[5]=je,k},pt.invert=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=Me*Fe-Ae*Oe;return pt?(k[0]=Fe*(pt=1/pt),k[1]=-Ae*pt,k[2]=-Oe*pt,k[3]=Me*pt,k[4]=(Oe*qe-Fe*je)*pt,k[5]=(Ae*je-Me*qe)*pt,k):null},pt.determinant=function(k){return k[0]*k[3]-k[1]*k[2]},pt.multiply=n,pt.rotate=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=Math.sin(Me),Ut=Math.cos(Me);return k[0]=Ae*Ut+Fe*vt,k[1]=Oe*Ut+je*vt,k[2]=Ae*-vt+Fe*Ut,k[3]=Oe*-vt+je*Ut,k[4]=qe,k[5]=pt,k},pt.scale=function(k,F,Me){var Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=Me[0],vt=Me[1];return k[0]=F[0]*pt,k[1]=Ae*pt,k[2]=Oe*vt,k[3]=Fe*vt,k[4]=je,k[5]=qe,k},pt.translate=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=Me[0],Ut=Me[1];return k[0]=Ae,k[1]=Oe,k[2]=Fe,k[3]=je,k[4]=Ae*vt+Fe*Ut+qe,k[5]=Oe*vt+je*Ut+pt,k},pt.fromRotation=function(k,F){var Me=Math.sin(F),Ae=Math.cos(F);return k[0]=Ae,k[1]=Me,k[2]=-Me,k[3]=Ae,k[4]=0,k[5]=0,k},pt.fromScaling=function(k,F){return k[0]=F[0],k[1]=0,k[2]=0,k[3]=F[1],k[4]=0,k[5]=0,k},pt.fromTranslation=function(k,F){return k[0]=1,k[1]=0,k[2]=0,k[3]=1,k[4]=F[0],k[5]=F[1],k},pt.str=function(k){return"mat2d("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+", "+k[4]+", "+k[5]+")"},pt.frob=function(k){return Math.hypot(k[0],k[1],k[2],k[3],k[4],k[5],1)},pt.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k[3]=F[3]+Me[3],k[4]=F[4]+Me[4],k[5]=F[5]+Me[5],k},pt.subtract=i,pt.multiplyScalar=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k[3]=F[3]*Me,k[4]=F[4]*Me,k[5]=F[5]*Me,k},pt.multiplyScalarAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k[2]=F[2]+Me[2]*Ae,k[3]=F[3]+Me[3]*Ae,k[4]=F[4]+Me[4]*Ae,k[5]=F[5]+Me[5]*Ae,k},pt.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]&&k[3]===F[3]&&k[4]===F[4]&&k[5]===F[5]},pt.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=Me[0],Ut=Me[1],xi=Me[2],vi=Me[3],bi=Me[4],wi=Me[5];return Math.abs(Ae-vt)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(vt))&&Math.abs(Oe-Ut)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(Ut))&&Math.abs(Fe-xi)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(xi))&&Math.abs(je-vi)<=k.EPSILON*Math.max(1,Math.abs(je),Math.abs(vi))&&Math.abs(qe-bi)<=k.EPSILON*Math.max(1,Math.abs(qe),Math.abs(bi))&&Math.abs(pt-wi)<=k.EPSILON*Math.max(1,Math.abs(pt),Math.abs(wi))},pt.sub=pt.mul=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=Me[0],Ut=Me[1],xi=Me[2],vi=Me[3],bi=Me[4],wi=Me[5];return k[0]=Ae*vt+Fe*Ut,k[1]=Oe*vt+je*Ut,k[2]=Ae*xi+Fe*vi,k[3]=Oe*xi+je*vi,k[4]=Ae*bi+Fe*wi+qe,k[5]=Oe*bi+je*wi+pt,k}function i(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k[2]=F[2]-Me[2],k[3]=F[3]-Me[3],k[4]=F[4]-Me[4],k[5]=F[5]-Me[5],k}return pt.mul=n,pt.sub=i,pt}var vt,Ut={};function d(){if(vt)return Ut;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}vt=1,Object.defineProperty(Ut,"__esModule",{value:!0}),Ut.create=function(){var F=new k.ARRAY_TYPE(9);return k.ARRAY_TYPE!=Float32Array&&(F[1]=0,F[2]=0,F[3]=0,F[5]=0,F[6]=0,F[7]=0),F[0]=1,F[4]=1,F[8]=1,F},Ut.fromMat4=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[4],k[4]=F[5],k[5]=F[6],k[6]=F[8],k[7]=F[9],k[8]=F[10],k},Ut.clone=function(F){var Me=new k.ARRAY_TYPE(9);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me[3]=F[3],Me[4]=F[4],Me[5]=F[5],Me[6]=F[6],Me[7]=F[7],Me[8]=F[8],Me},Ut.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k[4]=F[4],k[5]=F[5],k[6]=F[6],k[7]=F[7],k[8]=F[8],k},Ut.fromValues=function(F,Me,Ae,Oe,Fe,je,qe,pt,vt){var Ut=new k.ARRAY_TYPE(9);return Ut[0]=F,Ut[1]=Me,Ut[2]=Ae,Ut[3]=Oe,Ut[4]=Fe,Ut[5]=je,Ut[6]=qe,Ut[7]=pt,Ut[8]=vt,Ut},Ut.set=function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt){return k[0]=F,k[1]=Me,k[2]=Ae,k[3]=Oe,k[4]=Fe,k[5]=je,k[6]=qe,k[7]=pt,k[8]=vt,k},Ut.identity=function(k){return k[0]=1,k[1]=0,k[2]=0,k[3]=0,k[4]=1,k[5]=0,k[6]=0,k[7]=0,k[8]=1,k},Ut.transpose=function(k,F){if(k===F){var Me=F[1],Ae=F[2],Oe=F[5];k[1]=F[3],k[2]=F[6],k[3]=Me,k[5]=F[7],k[6]=Ae,k[7]=Oe}else k[0]=F[0],k[1]=F[3],k[2]=F[6],k[3]=F[1],k[4]=F[4],k[5]=F[7],k[6]=F[2],k[7]=F[5],k[8]=F[8];return k},Ut.invert=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=F[6],vt=F[7],Ut=F[8],xi=Ut*je-qe*vt,vi=-Ut*Fe+qe*pt,bi=vt*Fe-je*pt,wi=Me*xi+Ae*vi+Oe*bi;return wi?(k[0]=xi*(wi=1/wi),k[1]=(-Ut*Ae+Oe*vt)*wi,k[2]=(qe*Ae-Oe*je)*wi,k[3]=vi*wi,k[4]=(Ut*Me-Oe*pt)*wi,k[5]=(-qe*Me+Oe*Fe)*wi,k[6]=bi*wi,k[7]=(-vt*Me+Ae*pt)*wi,k[8]=(je*Me-Ae*Fe)*wi,k):null},Ut.adjoint=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=F[6],vt=F[7],Ut=F[8];return k[0]=je*Ut-qe*vt,k[1]=Oe*vt-Ae*Ut,k[2]=Ae*qe-Oe*je,k[3]=qe*pt-Fe*Ut,k[4]=Me*Ut-Oe*pt,k[5]=Oe*Fe-Me*qe,k[6]=Fe*vt-je*pt,k[7]=Ae*pt-Me*vt,k[8]=Me*je-Ae*Fe,k},Ut.determinant=function(k){var F=k[3],Me=k[4],Ae=k[5],Oe=k[6],Fe=k[7],je=k[8];return k[0]*(je*Me-Ae*Fe)+k[1]*(-je*F+Ae*Oe)+k[2]*(Fe*F-Me*Oe)},Ut.multiply=n,Ut.translate=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=Me[0],bi=Me[1];return k[0]=Ae,k[1]=Oe,k[2]=Fe,k[3]=je,k[4]=qe,k[5]=pt,k[6]=vi*Ae+bi*je+vt,k[7]=vi*Oe+bi*qe+Ut,k[8]=vi*Fe+bi*pt+xi,k},Ut.rotate=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=Math.sin(Me),bi=Math.cos(Me);return k[0]=bi*Ae+vi*je,k[1]=bi*Oe+vi*qe,k[2]=bi*Fe+vi*pt,k[3]=bi*je-vi*Ae,k[4]=bi*qe-vi*Oe,k[5]=bi*pt-vi*Fe,k[6]=vt,k[7]=Ut,k[8]=xi,k},Ut.scale=function(k,F,Me){var Ae=Me[0],Oe=Me[1];return k[0]=Ae*F[0],k[1]=Ae*F[1],k[2]=Ae*F[2],k[3]=Oe*F[3],k[4]=Oe*F[4],k[5]=Oe*F[5],k[6]=F[6],k[7]=F[7],k[8]=F[8],k},Ut.fromTranslation=function(k,F){return k[0]=1,k[1]=0,k[2]=0,k[3]=0,k[4]=1,k[5]=0,k[6]=F[0],k[7]=F[1],k[8]=1,k},Ut.fromRotation=function(k,F){var Me=Math.sin(F),Ae=Math.cos(F);return k[0]=Ae,k[1]=Me,k[2]=0,k[3]=-Me,k[4]=Ae,k[5]=0,k[6]=0,k[7]=0,k[8]=1,k},Ut.fromScaling=function(k,F){return k[0]=F[0],k[1]=0,k[2]=0,k[3]=0,k[4]=F[1],k[5]=0,k[6]=0,k[7]=0,k[8]=1,k},Ut.fromMat2d=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=0,k[3]=F[2],k[4]=F[3],k[5]=0,k[6]=F[4],k[7]=F[5],k[8]=1,k},Ut.fromQuat=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Me+Me,qe=Ae+Ae,pt=Oe+Oe,vt=Me*je,Ut=Ae*je,xi=Ae*qe,vi=Oe*je,bi=Oe*qe,wi=Oe*pt,Mi=Fe*je,pr=Fe*qe,Ur=Fe*pt;return k[0]=1-xi-wi,k[3]=Ut-Ur,k[6]=vi+pr,k[1]=Ut+Ur,k[4]=1-vt-wi,k[7]=bi-Mi,k[2]=vi-pr,k[5]=bi+Mi,k[8]=1-vt-xi,k},Ut.normalFromMat4=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=F[6],vt=F[7],Ut=F[8],xi=F[9],vi=F[10],bi=F[11],wi=F[12],Mi=F[13],pr=F[14],Ur=F[15],Wr=Me*qe-Ae*je,Jr=Me*pt-Oe*je,Qr=Me*vt-Fe*je,co=Ae*pt-Oe*qe,mo=Ae*vt-Fe*qe,yo=Oe*vt-Fe*pt,To=Ut*Mi-xi*wi,zo=Ut*pr-vi*wi,ko=Ut*Ur-bi*wi,na=xi*pr-vi*Mi,aa=xi*Ur-bi*Mi,_a=vi*Ur-bi*pr,wa=Wr*_a-Jr*aa+Qr*na+co*ko-mo*zo+yo*To;return wa?(k[0]=(qe*_a-pt*aa+vt*na)*(wa=1/wa),k[1]=(pt*ko-je*_a-vt*zo)*wa,k[2]=(je*aa-qe*ko+vt*To)*wa,k[3]=(Oe*aa-Ae*_a-Fe*na)*wa,k[4]=(Me*_a-Oe*ko+Fe*zo)*wa,k[5]=(Ae*ko-Me*aa-Fe*To)*wa,k[6]=(Mi*yo-pr*mo+Ur*co)*wa,k[7]=(pr*Qr-wi*yo-Ur*Jr)*wa,k[8]=(wi*mo-Mi*Qr+Ur*Wr)*wa,k):null},Ut.projection=function(k,F,Me){return k[0]=2/F,k[1]=0,k[2]=0,k[3]=0,k[4]=-2/Me,k[5]=0,k[6]=-1,k[7]=1,k[8]=1,k},Ut.str=function(k){return"mat3("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+", "+k[4]+", "+k[5]+", "+k[6]+", "+k[7]+", "+k[8]+")"},Ut.frob=function(k){return Math.hypot(k[0],k[1],k[2],k[3],k[4],k[5],k[6],k[7],k[8])},Ut.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k[3]=F[3]+Me[3],k[4]=F[4]+Me[4],k[5]=F[5]+Me[5],k[6]=F[6]+Me[6],k[7]=F[7]+Me[7],k[8]=F[8]+Me[8],k},Ut.subtract=i,Ut.multiplyScalar=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k[3]=F[3]*Me,k[4]=F[4]*Me,k[5]=F[5]*Me,k[6]=F[6]*Me,k[7]=F[7]*Me,k[8]=F[8]*Me,k},Ut.multiplyScalarAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k[2]=F[2]+Me[2]*Ae,k[3]=F[3]+Me[3]*Ae,k[4]=F[4]+Me[4]*Ae,k[5]=F[5]+Me[5]*Ae,k[6]=F[6]+Me[6]*Ae,k[7]=F[7]+Me[7]*Ae,k[8]=F[8]+Me[8]*Ae,k},Ut.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]&&k[3]===F[3]&&k[4]===F[4]&&k[5]===F[5]&&k[6]===F[6]&&k[7]===F[7]&&k[8]===F[8]},Ut.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=Me[0],bi=Me[1],wi=Me[2],Mi=Me[3],pr=Me[4],Ur=Me[5],Wr=Me[6],Jr=Me[7],Qr=Me[8];return Math.abs(Ae-vi)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(vi))&&Math.abs(Oe-bi)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(bi))&&Math.abs(Fe-wi)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(wi))&&Math.abs(je-Mi)<=k.EPSILON*Math.max(1,Math.abs(je),Math.abs(Mi))&&Math.abs(qe-pr)<=k.EPSILON*Math.max(1,Math.abs(qe),Math.abs(pr))&&Math.abs(pt-Ur)<=k.EPSILON*Math.max(1,Math.abs(pt),Math.abs(Ur))&&Math.abs(vt-Wr)<=k.EPSILON*Math.max(1,Math.abs(vt),Math.abs(Wr))&&Math.abs(Ut-Jr)<=k.EPSILON*Math.max(1,Math.abs(Ut),Math.abs(Jr))&&Math.abs(xi-Qr)<=k.EPSILON*Math.max(1,Math.abs(xi),Math.abs(Qr))},Ut.sub=Ut.mul=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=Me[0],bi=Me[1],wi=Me[2],Mi=Me[3],pr=Me[4],Ur=Me[5],Wr=Me[6],Jr=Me[7],Qr=Me[8];return k[0]=vi*Ae+bi*je+wi*vt,k[1]=vi*Oe+bi*qe+wi*Ut,k[2]=vi*Fe+bi*pt+wi*xi,k[3]=Mi*Ae+pr*je+Ur*vt,k[4]=Mi*Oe+pr*qe+Ur*Ut,k[5]=Mi*Fe+pr*pt+Ur*xi,k[6]=Wr*Ae+Jr*je+Qr*vt,k[7]=Wr*Oe+Jr*qe+Qr*Ut,k[8]=Wr*Fe+Jr*pt+Qr*xi,k}function i(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k[2]=F[2]-Me[2],k[3]=F[3]-Me[3],k[4]=F[4]-Me[4],k[5]=F[5]-Me[5],k[6]=F[6]-Me[6],k[7]=F[7]-Me[7],k[8]=F[8]-Me[8],k}return Ut.mul=n,Ut.sub=i,Ut}var xi,vi={};function g(){if(xi)return vi;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}xi=1,Object.defineProperty(vi,"__esModule",{value:!0}),vi.create=function(){var F=new k.ARRAY_TYPE(16);return k.ARRAY_TYPE!=Float32Array&&(F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=0,F[12]=0,F[13]=0,F[14]=0),F[0]=1,F[5]=1,F[10]=1,F[15]=1,F},vi.clone=function(F){var Me=new k.ARRAY_TYPE(16);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me[3]=F[3],Me[4]=F[4],Me[5]=F[5],Me[6]=F[6],Me[7]=F[7],Me[8]=F[8],Me[9]=F[9],Me[10]=F[10],Me[11]=F[11],Me[12]=F[12],Me[13]=F[13],Me[14]=F[14],Me[15]=F[15],Me},vi.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k[4]=F[4],k[5]=F[5],k[6]=F[6],k[7]=F[7],k[8]=F[8],k[9]=F[9],k[10]=F[10],k[11]=F[11],k[12]=F[12],k[13]=F[13],k[14]=F[14],k[15]=F[15],k},vi.fromValues=function(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr){var Ur=new k.ARRAY_TYPE(16);return Ur[0]=F,Ur[1]=Me,Ur[2]=Ae,Ur[3]=Oe,Ur[4]=Fe,Ur[5]=je,Ur[6]=qe,Ur[7]=pt,Ur[8]=vt,Ur[9]=Ut,Ur[10]=xi,Ur[11]=vi,Ur[12]=bi,Ur[13]=wi,Ur[14]=Mi,Ur[15]=pr,Ur},vi.set=function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr){return k[0]=F,k[1]=Me,k[2]=Ae,k[3]=Oe,k[4]=Fe,k[5]=je,k[6]=qe,k[7]=pt,k[8]=vt,k[9]=Ut,k[10]=xi,k[11]=vi,k[12]=bi,k[13]=wi,k[14]=Mi,k[15]=pr,k},vi.identity=n,vi.transpose=function(k,F){if(k===F){var Me=F[1],Ae=F[2],Oe=F[3],Fe=F[6],je=F[7],qe=F[11];k[1]=F[4],k[2]=F[8],k[3]=F[12],k[4]=Me,k[6]=F[9],k[7]=F[13],k[8]=Ae,k[9]=Fe,k[11]=F[14],k[12]=Oe,k[13]=je,k[14]=qe}else k[0]=F[0],k[1]=F[4],k[2]=F[8],k[3]=F[12],k[4]=F[1],k[5]=F[5],k[6]=F[9],k[7]=F[13],k[8]=F[2],k[9]=F[6],k[10]=F[10],k[11]=F[14],k[12]=F[3],k[13]=F[7],k[14]=F[11],k[15]=F[15];return k},vi.invert=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=F[6],vt=F[7],Ut=F[8],xi=F[9],vi=F[10],bi=F[11],wi=F[12],Mi=F[13],pr=F[14],Ur=F[15],Wr=Me*qe-Ae*je,Jr=Me*pt-Oe*je,Qr=Me*vt-Fe*je,co=Ae*pt-Oe*qe,mo=Ae*vt-Fe*qe,yo=Oe*vt-Fe*pt,To=Ut*Mi-xi*wi,zo=Ut*pr-vi*wi,ko=Ut*Ur-bi*wi,na=xi*pr-vi*Mi,aa=xi*Ur-bi*Mi,_a=vi*Ur-bi*pr,wa=Wr*_a-Jr*aa+Qr*na+co*ko-mo*zo+yo*To;return wa?(k[0]=(qe*_a-pt*aa+vt*na)*(wa=1/wa),k[1]=(Oe*aa-Ae*_a-Fe*na)*wa,k[2]=(Mi*yo-pr*mo+Ur*co)*wa,k[3]=(vi*mo-xi*yo-bi*co)*wa,k[4]=(pt*ko-je*_a-vt*zo)*wa,k[5]=(Me*_a-Oe*ko+Fe*zo)*wa,k[6]=(pr*Qr-wi*yo-Ur*Jr)*wa,k[7]=(Ut*yo-vi*Qr+bi*Jr)*wa,k[8]=(je*aa-qe*ko+vt*To)*wa,k[9]=(Ae*ko-Me*aa-Fe*To)*wa,k[10]=(wi*mo-Mi*Qr+Ur*Wr)*wa,k[11]=(xi*Qr-Ut*mo-bi*Wr)*wa,k[12]=(qe*zo-je*na-pt*To)*wa,k[13]=(Me*na-Ae*zo+Oe*To)*wa,k[14]=(Mi*Jr-wi*co-pr*Wr)*wa,k[15]=(Ut*co-xi*Jr+vi*Wr)*wa,k):null},vi.adjoint=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],pt=F[6],vt=F[7],Ut=F[8],xi=F[9],vi=F[10],bi=F[11],wi=F[12],Mi=F[13],pr=F[14],Ur=F[15];return k[0]=qe*(vi*Ur-bi*pr)-xi*(pt*Ur-vt*pr)+Mi*(pt*bi-vt*vi),k[1]=-(Ae*(vi*Ur-bi*pr)-xi*(Oe*Ur-Fe*pr)+Mi*(Oe*bi-Fe*vi)),k[2]=Ae*(pt*Ur-vt*pr)-qe*(Oe*Ur-Fe*pr)+Mi*(Oe*vt-Fe*pt),k[3]=-(Ae*(pt*bi-vt*vi)-qe*(Oe*bi-Fe*vi)+xi*(Oe*vt-Fe*pt)),k[4]=-(je*(vi*Ur-bi*pr)-Ut*(pt*Ur-vt*pr)+wi*(pt*bi-vt*vi)),k[5]=Me*(vi*Ur-bi*pr)-Ut*(Oe*Ur-Fe*pr)+wi*(Oe*bi-Fe*vi),k[6]=-(Me*(pt*Ur-vt*pr)-je*(Oe*Ur-Fe*pr)+wi*(Oe*vt-Fe*pt)),k[7]=Me*(pt*bi-vt*vi)-je*(Oe*bi-Fe*vi)+Ut*(Oe*vt-Fe*pt),k[8]=je*(xi*Ur-bi*Mi)-Ut*(qe*Ur-vt*Mi)+wi*(qe*bi-vt*xi),k[9]=-(Me*(xi*Ur-bi*Mi)-Ut*(Ae*Ur-Fe*Mi)+wi*(Ae*bi-Fe*xi)),k[10]=Me*(qe*Ur-vt*Mi)-je*(Ae*Ur-Fe*Mi)+wi*(Ae*vt-Fe*qe),k[11]=-(Me*(qe*bi-vt*xi)-je*(Ae*bi-Fe*xi)+Ut*(Ae*vt-Fe*qe)),k[12]=-(je*(xi*pr-vi*Mi)-Ut*(qe*pr-pt*Mi)+wi*(qe*vi-pt*xi)),k[13]=Me*(xi*pr-vi*Mi)-Ut*(Ae*pr-Oe*Mi)+wi*(Ae*vi-Oe*xi),k[14]=-(Me*(qe*pr-pt*Mi)-je*(Ae*pr-Oe*Mi)+wi*(Ae*pt-Oe*qe)),k[15]=Me*(qe*vi-pt*xi)-je*(Ae*vi-Oe*xi)+Ut*(Ae*pt-Oe*qe),k},vi.determinant=function(k){var F=k[0],Me=k[1],Ae=k[2],Oe=k[3],Fe=k[4],je=k[5],qe=k[6],pt=k[7],vt=k[8],Ut=k[9],xi=k[10],vi=k[11],bi=k[12],wi=k[13],Mi=k[14],pr=k[15];return(F*je-Me*Fe)*(xi*pr-vi*Mi)-(F*qe-Ae*Fe)*(Ut*pr-vi*wi)+(F*pt-Oe*Fe)*(Ut*Mi-xi*wi)+(Me*qe-Ae*je)*(vt*pr-vi*bi)-(Me*pt-Oe*je)*(vt*Mi-xi*bi)+(Ae*pt-Oe*qe)*(vt*wi-Ut*bi)},vi.multiply=i,vi.translate=function(k,F,Me){var Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi=Me[0],pr=Me[1],Ur=Me[2];return F===k?(k[12]=F[0]*Mi+F[4]*pr+F[8]*Ur+F[12],k[13]=F[1]*Mi+F[5]*pr+F[9]*Ur+F[13],k[14]=F[2]*Mi+F[6]*pr+F[10]*Ur+F[14],k[15]=F[3]*Mi+F[7]*pr+F[11]*Ur+F[15]):(Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=F[9],bi=F[10],wi=F[11],k[0]=Ae=F[0],k[1]=Oe,k[2]=Fe,k[3]=je,k[4]=qe,k[5]=pt,k[6]=vt,k[7]=Ut,k[8]=xi,k[9]=vi,k[10]=bi,k[11]=wi,k[12]=Ae*Mi+qe*pr+xi*Ur+F[12],k[13]=Oe*Mi+pt*pr+vi*Ur+F[13],k[14]=Fe*Mi+vt*pr+bi*Ur+F[14],k[15]=je*Mi+Ut*pr+wi*Ur+F[15]),k},vi.scale=function(k,F,Me){var Ae=Me[0],Oe=Me[1],Fe=Me[2];return k[0]=F[0]*Ae,k[1]=F[1]*Ae,k[2]=F[2]*Ae,k[3]=F[3]*Ae,k[4]=F[4]*Oe,k[5]=F[5]*Oe,k[6]=F[6]*Oe,k[7]=F[7]*Oe,k[8]=F[8]*Fe,k[9]=F[9]*Fe,k[10]=F[10]*Fe,k[11]=F[11]*Fe,k[12]=F[12],k[13]=F[13],k[14]=F[14],k[15]=F[15],k},vi.rotate=function(F,Me,Ae,Oe){var Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co,mo,yo,To,zo,ko,na,aa,_a=Oe[0],wa=Oe[1],Sa=Oe[2],Ya=Math.hypot(_a,wa,Sa);return Ya<k.EPSILON?null:(_a*=Ya=1/Ya,wa*=Ya,Sa*=Ya,Fe=Math.sin(Ae),je=Math.cos(Ae),vt=Me[1],Ut=Me[2],xi=Me[3],bi=Me[5],wi=Me[6],Mi=Me[7],Ur=Me[9],Wr=Me[10],Jr=Me[11],Qr=_a*_a*(qe=1-je)+je,yo=_a*wa*qe-Sa*Fe,To=wa*wa*qe+je,zo=Sa*wa*qe+_a*Fe,ko=_a*Sa*qe+wa*Fe,na=wa*Sa*qe-_a*Fe,aa=Sa*Sa*qe+je,F[0]=(pt=Me[0])*Qr+(vi=Me[4])*(co=wa*_a*qe+Sa*Fe)+(pr=Me[8])*(mo=Sa*_a*qe-wa*Fe),F[1]=vt*Qr+bi*co+Ur*mo,F[2]=Ut*Qr+wi*co+Wr*mo,F[3]=xi*Qr+Mi*co+Jr*mo,F[4]=pt*yo+vi*To+pr*zo,F[5]=vt*yo+bi*To+Ur*zo,F[6]=Ut*yo+wi*To+Wr*zo,F[7]=xi*yo+Mi*To+Jr*zo,F[8]=pt*ko+vi*na+pr*aa,F[9]=vt*ko+bi*na+Ur*aa,F[10]=Ut*ko+wi*na+Wr*aa,F[11]=xi*ko+Mi*na+Jr*aa,Me!==F&&(F[12]=Me[12],F[13]=Me[13],F[14]=Me[14],F[15]=Me[15]),F)},vi.rotateX=function(k,F,Me){var Ae=Math.sin(Me),Oe=Math.cos(Me),Fe=F[4],je=F[5],qe=F[6],pt=F[7],vt=F[8],Ut=F[9],xi=F[10],vi=F[11];return F!==k&&(k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k[12]=F[12],k[13]=F[13],k[14]=F[14],k[15]=F[15]),k[4]=Fe*Oe+vt*Ae,k[5]=je*Oe+Ut*Ae,k[6]=qe*Oe+xi*Ae,k[7]=pt*Oe+vi*Ae,k[8]=vt*Oe-Fe*Ae,k[9]=Ut*Oe-je*Ae,k[10]=xi*Oe-qe*Ae,k[11]=vi*Oe-pt*Ae,k},vi.rotateY=function(k,F,Me){var Ae=Math.sin(Me),Oe=Math.cos(Me),Fe=F[0],je=F[1],qe=F[2],pt=F[3],vt=F[8],Ut=F[9],xi=F[10],vi=F[11];return F!==k&&(k[4]=F[4],k[5]=F[5],k[6]=F[6],k[7]=F[7],k[12]=F[12],k[13]=F[13],k[14]=F[14],k[15]=F[15]),k[0]=Fe*Oe-vt*Ae,k[1]=je*Oe-Ut*Ae,k[2]=qe*Oe-xi*Ae,k[3]=pt*Oe-vi*Ae,k[8]=Fe*Ae+vt*Oe,k[9]=je*Ae+Ut*Oe,k[10]=qe*Ae+xi*Oe,k[11]=pt*Ae+vi*Oe,k},vi.rotateZ=function(k,F,Me){var Ae=Math.sin(Me),Oe=Math.cos(Me),Fe=F[0],je=F[1],qe=F[2],pt=F[3],vt=F[4],Ut=F[5],xi=F[6],vi=F[7];return F!==k&&(k[8]=F[8],k[9]=F[9],k[10]=F[10],k[11]=F[11],k[12]=F[12],k[13]=F[13],k[14]=F[14],k[15]=F[15]),k[0]=Fe*Oe+vt*Ae,k[1]=je*Oe+Ut*Ae,k[2]=qe*Oe+xi*Ae,k[3]=pt*Oe+vi*Ae,k[4]=vt*Oe-Fe*Ae,k[5]=Ut*Oe-je*Ae,k[6]=xi*Oe-qe*Ae,k[7]=vi*Oe-pt*Ae,k},vi.fromTranslation=function(k,F){return k[0]=1,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=1,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[10]=1,k[11]=0,k[12]=F[0],k[13]=F[1],k[14]=F[2],k[15]=1,k},vi.fromScaling=function(k,F){return k[0]=F[0],k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=F[1],k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[10]=F[2],k[11]=0,k[12]=0,k[13]=0,k[14]=0,k[15]=1,k},vi.fromRotation=function(F,Me,Ae){var Oe,Fe,je,qe=Ae[0],pt=Ae[1],vt=Ae[2],Ut=Math.hypot(qe,pt,vt);return Ut<k.EPSILON?null:(qe*=Ut=1/Ut,pt*=Ut,vt*=Ut,Oe=Math.sin(Me),Fe=Math.cos(Me),F[0]=qe*qe*(je=1-Fe)+Fe,F[1]=pt*qe*je+vt*Oe,F[2]=vt*qe*je-pt*Oe,F[3]=0,F[4]=qe*pt*je-vt*Oe,F[5]=pt*pt*je+Fe,F[6]=vt*pt*je+qe*Oe,F[7]=0,F[8]=qe*vt*je+pt*Oe,F[9]=pt*vt*je-qe*Oe,F[10]=vt*vt*je+Fe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F)},vi.fromXRotation=function(k,F){var Me=Math.sin(F),Ae=Math.cos(F);return k[0]=1,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=Ae,k[6]=Me,k[7]=0,k[8]=0,k[9]=-Me,k[10]=Ae,k[11]=0,k[12]=0,k[13]=0,k[14]=0,k[15]=1,k},vi.fromYRotation=function(k,F){var Me=Math.sin(F),Ae=Math.cos(F);return k[0]=Ae,k[1]=0,k[2]=-Me,k[3]=0,k[4]=0,k[5]=1,k[6]=0,k[7]=0,k[8]=Me,k[9]=0,k[10]=Ae,k[11]=0,k[12]=0,k[13]=0,k[14]=0,k[15]=1,k},vi.fromZRotation=function(k,F){var Me=Math.sin(F),Ae=Math.cos(F);return k[0]=Ae,k[1]=Me,k[2]=0,k[3]=0,k[4]=-Me,k[5]=Ae,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[10]=1,k[11]=0,k[12]=0,k[13]=0,k[14]=0,k[15]=1,k},vi.fromRotationTranslation=s,vi.fromQuat2=function(F,Me){var Ae=new k.ARRAY_TYPE(3),Oe=-Me[0],Fe=-Me[1],je=-Me[2],qe=Me[3],pt=Me[4],vt=Me[5],Ut=Me[6],xi=Me[7],vi=Oe*Oe+Fe*Fe+je*je+qe*qe;return vi>0?(Ae[0]=2*(pt*qe+xi*Oe+vt*je-Ut*Fe)/vi,Ae[1]=2*(vt*qe+xi*Fe+Ut*Oe-pt*je)/vi,Ae[2]=2*(Ut*qe+xi*je+pt*Fe-vt*Oe)/vi):(Ae[0]=2*(pt*qe+xi*Oe+vt*je-Ut*Fe),Ae[1]=2*(vt*qe+xi*Fe+Ut*Oe-pt*je),Ae[2]=2*(Ut*qe+xi*je+pt*Fe-vt*Oe)),s(F,Me,Ae),F},vi.getTranslation=function(k,F){return k[0]=F[12],k[1]=F[13],k[2]=F[14],k},vi.getScaling=o,vi.getRotation=function(F,Me){var Ae=new k.ARRAY_TYPE(3);o(Ae,Me);var Oe=1/Ae[0],Fe=1/Ae[1],je=1/Ae[2],qe=Me[0]*Oe,pt=Me[1]*Fe,vt=Me[2]*je,Ut=Me[4]*Oe,xi=Me[5]*Fe,vi=Me[6]*je,bi=Me[8]*Oe,wi=Me[9]*Fe,Mi=Me[10]*je,pr=qe+xi+Mi,Ur=0;return pr>0?(Ur=2*Math.sqrt(pr+1),F[3]=.25*Ur,F[0]=(vi-wi)/Ur,F[1]=(bi-vt)/Ur,F[2]=(pt-Ut)/Ur):qe>xi&&qe>Mi?(Ur=2*Math.sqrt(1+qe-xi-Mi),F[3]=(vi-wi)/Ur,F[0]=.25*Ur,F[1]=(pt+Ut)/Ur,F[2]=(bi+vt)/Ur):xi>Mi?(Ur=2*Math.sqrt(1+xi-qe-Mi),F[3]=(bi-vt)/Ur,F[0]=(pt+Ut)/Ur,F[1]=.25*Ur,F[2]=(vi+wi)/Ur):(Ur=2*Math.sqrt(1+Mi-qe-xi),F[3]=(pt-Ut)/Ur,F[0]=(bi+vt)/Ur,F[1]=(vi+wi)/Ur,F[2]=.25*Ur),F},vi.fromRotationTranslationScale=function(k,F,Me,Ae){var Oe=F[0],Fe=F[1],je=F[2],qe=F[3],pt=Oe+Oe,vt=Fe+Fe,Ut=je+je,xi=Oe*pt,vi=Oe*vt,bi=Oe*Ut,wi=Fe*vt,Mi=Fe*Ut,pr=je*Ut,Ur=qe*pt,Wr=qe*vt,Jr=qe*Ut,Qr=Ae[0],co=Ae[1],mo=Ae[2];return k[0]=(1-(wi+pr))*Qr,k[1]=(vi+Jr)*Qr,k[2]=(bi-Wr)*Qr,k[3]=0,k[4]=(vi-Jr)*co,k[5]=(1-(xi+pr))*co,k[6]=(Mi+Ur)*co,k[7]=0,k[8]=(bi+Wr)*mo,k[9]=(Mi-Ur)*mo,k[10]=(1-(xi+wi))*mo,k[11]=0,k[12]=Me[0],k[13]=Me[1],k[14]=Me[2],k[15]=1,k},vi.fromRotationTranslationScaleOrigin=function(k,F,Me,Ae,Oe){var Fe=F[0],je=F[1],qe=F[2],pt=F[3],vt=Fe+Fe,Ut=je+je,xi=qe+qe,vi=Fe*vt,bi=Fe*Ut,wi=Fe*xi,Mi=je*Ut,pr=je*xi,Ur=qe*xi,Wr=pt*vt,Jr=pt*Ut,Qr=pt*xi,co=Ae[0],mo=Ae[1],yo=Ae[2],To=Oe[0],zo=Oe[1],ko=Oe[2],na=(1-(Mi+Ur))*co,aa=(bi+Qr)*co,_a=(wi-Jr)*co,wa=(bi-Qr)*mo,Sa=(1-(vi+Ur))*mo,Ya=(pr+Wr)*mo,rl=(wi+Jr)*yo,sl=(pr-Wr)*yo,ml=(1-(vi+Mi))*yo;return k[0]=na,k[1]=aa,k[2]=_a,k[3]=0,k[4]=wa,k[5]=Sa,k[6]=Ya,k[7]=0,k[8]=rl,k[9]=sl,k[10]=ml,k[11]=0,k[12]=Me[0]+To-(na*To+wa*zo+rl*ko),k[13]=Me[1]+zo-(aa*To+Sa*zo+sl*ko),k[14]=Me[2]+ko-(_a*To+Ya*zo+ml*ko),k[15]=1,k},vi.fromQuat=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Me+Me,qe=Ae+Ae,pt=Oe+Oe,vt=Me*je,Ut=Ae*je,xi=Ae*qe,vi=Oe*je,bi=Oe*qe,wi=Oe*pt,Mi=Fe*je,pr=Fe*qe,Ur=Fe*pt;return k[0]=1-xi-wi,k[1]=Ut+Ur,k[2]=vi-pr,k[3]=0,k[4]=Ut-Ur,k[5]=1-vt-wi,k[6]=bi+Mi,k[7]=0,k[8]=vi+pr,k[9]=bi-Mi,k[10]=1-vt-xi,k[11]=0,k[12]=0,k[13]=0,k[14]=0,k[15]=1,k},vi.frustum=function(k,F,Me,Ae,Oe,Fe,je){var qe=1/(Me-F),pt=1/(Oe-Ae),vt=1/(Fe-je);return k[0]=2*Fe*qe,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=2*Fe*pt,k[6]=0,k[7]=0,k[8]=(Me+F)*qe,k[9]=(Oe+Ae)*pt,k[10]=(je+Fe)*vt,k[11]=-1,k[12]=0,k[13]=0,k[14]=je*Fe*2*vt,k[15]=0,k},vi.perspectiveNO=l,vi.perspectiveZO=function(k,F,Me,Ae,Oe){var Fe,je=1/Math.tan(F/2);return k[0]=je/Me,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=je,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[11]=-1,k[12]=0,k[13]=0,k[15]=0,null!=Oe&&Oe!==1/0?(k[10]=Oe*(Fe=1/(Ae-Oe)),k[14]=Oe*Ae*Fe):(k[10]=-1,k[14]=-Ae),k},vi.perspectiveFromFieldOfView=function(k,F,Me,Ae){var Oe=Math.tan(F.upDegrees*Math.PI/180),Fe=Math.tan(F.downDegrees*Math.PI/180),je=Math.tan(F.leftDegrees*Math.PI/180),qe=Math.tan(F.rightDegrees*Math.PI/180),pt=2/(je+qe),vt=2/(Oe+Fe);return k[0]=pt,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=vt,k[6]=0,k[7]=0,k[8]=-(je-qe)*pt*.5,k[9]=(Oe-Fe)*vt*.5,k[10]=Ae/(Me-Ae),k[11]=-1,k[12]=0,k[13]=0,k[14]=Ae*Me/(Me-Ae),k[15]=0,k},vi.orthoNO=u,vi.orthoZO=function(k,F,Me,Ae,Oe,Fe,je){var qe=1/(F-Me),pt=1/(Ae-Oe),vt=1/(Fe-je);return k[0]=-2*qe,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=-2*pt,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[10]=vt,k[11]=0,k[12]=(F+Me)*qe,k[13]=(Oe+Ae)*pt,k[14]=Fe*vt,k[15]=1,k},vi.lookAt=function(F,Me,Ae,Oe){var Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi=Me[0],pr=Me[1],Ur=Me[2],Wr=Oe[0],Jr=Oe[1],Qr=Oe[2],co=Ae[0],mo=Ae[1],yo=Ae[2];return Math.abs(Mi-co)<k.EPSILON&&Math.abs(pr-mo)<k.EPSILON&&Math.abs(Ur-yo)<k.EPSILON?n(F):(xi=Mi-co,vi=pr-mo,bi=Ur-yo,Fe=Jr*(bi*=wi=1/Math.hypot(xi,vi,bi))-Qr*(vi*=wi),je=Qr*(xi*=wi)-Wr*bi,qe=Wr*vi-Jr*xi,(wi=Math.hypot(Fe,je,qe))?(Fe*=wi=1/wi,je*=wi,qe*=wi):(Fe=0,je=0,qe=0),pt=vi*qe-bi*je,vt=bi*Fe-xi*qe,Ut=xi*je-vi*Fe,(wi=Math.hypot(pt,vt,Ut))?(pt*=wi=1/wi,vt*=wi,Ut*=wi):(pt=0,vt=0,Ut=0),F[0]=Fe,F[1]=pt,F[2]=xi,F[3]=0,F[4]=je,F[5]=vt,F[6]=vi,F[7]=0,F[8]=qe,F[9]=Ut,F[10]=bi,F[11]=0,F[12]=-(Fe*Mi+je*pr+qe*Ur),F[13]=-(pt*Mi+vt*pr+Ut*Ur),F[14]=-(xi*Mi+vi*pr+bi*Ur),F[15]=1,F)},vi.targetTo=function(k,F,Me,Ae){var Oe=F[0],Fe=F[1],je=F[2],qe=Ae[0],pt=Ae[1],vt=Ae[2],Ut=Oe-Me[0],xi=Fe-Me[1],vi=je-Me[2],bi=Ut*Ut+xi*xi+vi*vi;bi>0&&(Ut*=bi=1/Math.sqrt(bi),xi*=bi,vi*=bi);var wi=pt*vi-vt*xi,Mi=vt*Ut-qe*vi,pr=qe*xi-pt*Ut;return(bi=wi*wi+Mi*Mi+pr*pr)>0&&(wi*=bi=1/Math.sqrt(bi),Mi*=bi,pr*=bi),k[0]=wi,k[1]=Mi,k[2]=pr,k[3]=0,k[4]=xi*pr-vi*Mi,k[5]=vi*wi-Ut*pr,k[6]=Ut*Mi-xi*wi,k[7]=0,k[8]=Ut,k[9]=xi,k[10]=vi,k[11]=0,k[12]=Oe,k[13]=Fe,k[14]=je,k[15]=1,k},vi.str=function(k){return"mat4("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+", "+k[4]+", "+k[5]+", "+k[6]+", "+k[7]+", "+k[8]+", "+k[9]+", "+k[10]+", "+k[11]+", "+k[12]+", "+k[13]+", "+k[14]+", "+k[15]+")"},vi.frob=function(k){return Math.hypot(k[0],k[1],k[2],k[3],k[4],k[5],k[6],k[7],k[8],k[9],k[10],k[11],k[12],k[13],k[14],k[15])},vi.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k[3]=F[3]+Me[3],k[4]=F[4]+Me[4],k[5]=F[5]+Me[5],k[6]=F[6]+Me[6],k[7]=F[7]+Me[7],k[8]=F[8]+Me[8],k[9]=F[9]+Me[9],k[10]=F[10]+Me[10],k[11]=F[11]+Me[11],k[12]=F[12]+Me[12],k[13]=F[13]+Me[13],k[14]=F[14]+Me[14],k[15]=F[15]+Me[15],k},vi.subtract=c,vi.multiplyScalar=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k[3]=F[3]*Me,k[4]=F[4]*Me,k[5]=F[5]*Me,k[6]=F[6]*Me,k[7]=F[7]*Me,k[8]=F[8]*Me,k[9]=F[9]*Me,k[10]=F[10]*Me,k[11]=F[11]*Me,k[12]=F[12]*Me,k[13]=F[13]*Me,k[14]=F[14]*Me,k[15]=F[15]*Me,k},vi.multiplyScalarAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k[2]=F[2]+Me[2]*Ae,k[3]=F[3]+Me[3]*Ae,k[4]=F[4]+Me[4]*Ae,k[5]=F[5]+Me[5]*Ae,k[6]=F[6]+Me[6]*Ae,k[7]=F[7]+Me[7]*Ae,k[8]=F[8]+Me[8]*Ae,k[9]=F[9]+Me[9]*Ae,k[10]=F[10]+Me[10]*Ae,k[11]=F[11]+Me[11]*Ae,k[12]=F[12]+Me[12]*Ae,k[13]=F[13]+Me[13]*Ae,k[14]=F[14]+Me[14]*Ae,k[15]=F[15]+Me[15]*Ae,k},vi.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]&&k[3]===F[3]&&k[4]===F[4]&&k[5]===F[5]&&k[6]===F[6]&&k[7]===F[7]&&k[8]===F[8]&&k[9]===F[9]&&k[10]===F[10]&&k[11]===F[11]&&k[12]===F[12]&&k[13]===F[13]&&k[14]===F[14]&&k[15]===F[15]},vi.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=F[9],bi=F[10],wi=F[11],Mi=F[12],pr=F[13],Ur=F[14],Wr=F[15],Jr=Me[0],Qr=Me[1],co=Me[2],mo=Me[3],yo=Me[4],To=Me[5],zo=Me[6],ko=Me[7],na=Me[8],aa=Me[9],_a=Me[10],wa=Me[11],Sa=Me[12],Ya=Me[13],rl=Me[14],sl=Me[15];return Math.abs(Ae-Jr)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(Jr))&&Math.abs(Oe-Qr)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(Qr))&&Math.abs(Fe-co)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(co))&&Math.abs(je-mo)<=k.EPSILON*Math.max(1,Math.abs(je),Math.abs(mo))&&Math.abs(qe-yo)<=k.EPSILON*Math.max(1,Math.abs(qe),Math.abs(yo))&&Math.abs(pt-To)<=k.EPSILON*Math.max(1,Math.abs(pt),Math.abs(To))&&Math.abs(vt-zo)<=k.EPSILON*Math.max(1,Math.abs(vt),Math.abs(zo))&&Math.abs(Ut-ko)<=k.EPSILON*Math.max(1,Math.abs(Ut),Math.abs(ko))&&Math.abs(xi-na)<=k.EPSILON*Math.max(1,Math.abs(xi),Math.abs(na))&&Math.abs(vi-aa)<=k.EPSILON*Math.max(1,Math.abs(vi),Math.abs(aa))&&Math.abs(bi-_a)<=k.EPSILON*Math.max(1,Math.abs(bi),Math.abs(_a))&&Math.abs(wi-wa)<=k.EPSILON*Math.max(1,Math.abs(wi),Math.abs(wa))&&Math.abs(Mi-Sa)<=k.EPSILON*Math.max(1,Math.abs(Mi),Math.abs(Sa))&&Math.abs(pr-Ya)<=k.EPSILON*Math.max(1,Math.abs(pr),Math.abs(Ya))&&Math.abs(Ur-rl)<=k.EPSILON*Math.max(1,Math.abs(Ur),Math.abs(rl))&&Math.abs(Wr-sl)<=k.EPSILON*Math.max(1,Math.abs(Wr),Math.abs(sl))},vi.sub=vi.mul=vi.ortho=vi.perspective=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(k){return k[0]=1,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=1,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[10]=1,k[11]=0,k[12]=0,k[13]=0,k[14]=0,k[15]=1,k}function i(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=F[8],vi=F[9],bi=F[10],wi=F[11],Mi=F[12],pr=F[13],Ur=F[14],Wr=F[15],Jr=Me[0],Qr=Me[1],co=Me[2],mo=Me[3];return k[0]=Jr*Ae+Qr*qe+co*xi+mo*Mi,k[1]=Jr*Oe+Qr*pt+co*vi+mo*pr,k[2]=Jr*Fe+Qr*vt+co*bi+mo*Ur,k[3]=Jr*je+Qr*Ut+co*wi+mo*Wr,k[4]=(Jr=Me[4])*Ae+(Qr=Me[5])*qe+(co=Me[6])*xi+(mo=Me[7])*Mi,k[5]=Jr*Oe+Qr*pt+co*vi+mo*pr,k[6]=Jr*Fe+Qr*vt+co*bi+mo*Ur,k[7]=Jr*je+Qr*Ut+co*wi+mo*Wr,k[8]=(Jr=Me[8])*Ae+(Qr=Me[9])*qe+(co=Me[10])*xi+(mo=Me[11])*Mi,k[9]=Jr*Oe+Qr*pt+co*vi+mo*pr,k[10]=Jr*Fe+Qr*vt+co*bi+mo*Ur,k[11]=Jr*je+Qr*Ut+co*wi+mo*Wr,k[12]=(Jr=Me[12])*Ae+(Qr=Me[13])*qe+(co=Me[14])*xi+(mo=Me[15])*Mi,k[13]=Jr*Oe+Qr*pt+co*vi+mo*pr,k[14]=Jr*Fe+Qr*vt+co*bi+mo*Ur,k[15]=Jr*je+Qr*Ut+co*wi+mo*Wr,k}function s(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Ae+Ae,pt=Oe+Oe,vt=Fe+Fe,Ut=Ae*qe,xi=Ae*pt,vi=Ae*vt,bi=Oe*pt,wi=Oe*vt,Mi=Fe*vt,pr=je*qe,Ur=je*pt,Wr=je*vt;return k[0]=1-(bi+Mi),k[1]=xi+Wr,k[2]=vi-Ur,k[3]=0,k[4]=xi-Wr,k[5]=1-(Ut+Mi),k[6]=wi+pr,k[7]=0,k[8]=vi+Ur,k[9]=wi-pr,k[10]=1-(Ut+bi),k[11]=0,k[12]=Me[0],k[13]=Me[1],k[14]=Me[2],k[15]=1,k}function o(k,F){var Me=F[4],Ae=F[5],Oe=F[6],Fe=F[8],je=F[9],qe=F[10];return k[0]=Math.hypot(F[0],F[1],F[2]),k[1]=Math.hypot(Me,Ae,Oe),k[2]=Math.hypot(Fe,je,qe),k}function l(k,F,Me,Ae,Oe){var Fe,je=1/Math.tan(F/2);return k[0]=je/Me,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=je,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[11]=-1,k[12]=0,k[13]=0,k[15]=0,null!=Oe&&Oe!==1/0?(k[10]=(Oe+Ae)*(Fe=1/(Ae-Oe)),k[14]=2*Oe*Ae*Fe):(k[10]=-1,k[14]=-2*Ae),k}function u(k,F,Me,Ae,Oe,Fe,je){var qe=1/(F-Me),pt=1/(Ae-Oe),vt=1/(Fe-je);return k[0]=-2*qe,k[1]=0,k[2]=0,k[3]=0,k[4]=0,k[5]=-2*pt,k[6]=0,k[7]=0,k[8]=0,k[9]=0,k[10]=2*vt,k[11]=0,k[12]=(F+Me)*qe,k[13]=(Oe+Ae)*pt,k[14]=(je+Fe)*vt,k[15]=1,k}function c(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k[2]=F[2]-Me[2],k[3]=F[3]-Me[3],k[4]=F[4]-Me[4],k[5]=F[5]-Me[5],k[6]=F[6]-Me[6],k[7]=F[7]-Me[7],k[8]=F[8]-Me[8],k[9]=F[9]-Me[9],k[10]=F[10]-Me[10],k[11]=F[11]-Me[11],k[12]=F[12]-Me[12],k[13]=F[13]-Me[13],k[14]=F[14]-Me[14],k[15]=F[15]-Me[15],k}return vi.perspective=l,vi.ortho=u,vi.mul=i,vi.sub=c,vi}var bi,wi={},Mi={};function _(){if(bi)return Mi;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}bi=1,Object.defineProperty(Mi,"__esModule",{value:!0}),Mi.create=n,Mi.clone=function(F){var Me=new k.ARRAY_TYPE(3);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me},Mi.length=i,Mi.fromValues=function(F,Me,Ae){var Oe=new k.ARRAY_TYPE(3);return Oe[0]=F,Oe[1]=Me,Oe[2]=Ae,Oe},Mi.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k},Mi.set=function(k,F,Me,Ae){return k[0]=F,k[1]=Me,k[2]=Ae,k},Mi.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k},Mi.subtract=s,Mi.multiply=o,Mi.divide=l,Mi.ceil=function(k,F){return k[0]=Math.ceil(F[0]),k[1]=Math.ceil(F[1]),k[2]=Math.ceil(F[2]),k},Mi.floor=function(k,F){return k[0]=Math.floor(F[0]),k[1]=Math.floor(F[1]),k[2]=Math.floor(F[2]),k},Mi.min=function(k,F,Me){return k[0]=Math.min(F[0],Me[0]),k[1]=Math.min(F[1],Me[1]),k[2]=Math.min(F[2],Me[2]),k},Mi.max=function(k,F,Me){return k[0]=Math.max(F[0],Me[0]),k[1]=Math.max(F[1],Me[1]),k[2]=Math.max(F[2],Me[2]),k},Mi.round=function(k,F){return k[0]=Math.round(F[0]),k[1]=Math.round(F[1]),k[2]=Math.round(F[2]),k},Mi.scale=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k},Mi.scaleAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k[2]=F[2]+Me[2]*Ae,k},Mi.distance=u,Mi.squaredDistance=c,Mi.squaredLength=h,Mi.negate=function(k,F){return k[0]=-F[0],k[1]=-F[1],k[2]=-F[2],k},Mi.inverse=function(k,F){return k[0]=1/F[0],k[1]=1/F[1],k[2]=1/F[2],k},Mi.normalize=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=Me*Me+Ae*Ae+Oe*Oe;return Fe>0&&(Fe=1/Math.sqrt(Fe)),k[0]=F[0]*Fe,k[1]=F[1]*Fe,k[2]=F[2]*Fe,k},Mi.dot=p,Mi.cross=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=Me[0],qe=Me[1],pt=Me[2];return k[0]=Oe*pt-Fe*qe,k[1]=Fe*je-Ae*pt,k[2]=Ae*qe-Oe*je,k},Mi.lerp=function(k,F,Me,Ae){var Oe=F[0],Fe=F[1],je=F[2];return k[0]=Oe+Ae*(Me[0]-Oe),k[1]=Fe+Ae*(Me[1]-Fe),k[2]=je+Ae*(Me[2]-je),k},Mi.hermite=function(k,F,Me,Ae,Oe,Fe){var je=Fe*Fe,qe=je*(2*Fe-3)+1,pt=je*(Fe-2)+Fe,vt=je*(Fe-1),Ut=je*(3-2*Fe);return k[0]=F[0]*qe+Me[0]*pt+Ae[0]*vt+Oe[0]*Ut,k[1]=F[1]*qe+Me[1]*pt+Ae[1]*vt+Oe[1]*Ut,k[2]=F[2]*qe+Me[2]*pt+Ae[2]*vt+Oe[2]*Ut,k},Mi.bezier=function(k,F,Me,Ae,Oe,Fe){var je=1-Fe,qe=je*je,pt=Fe*Fe,vt=qe*je,Ut=3*Fe*qe,xi=3*pt*je,vi=pt*Fe;return k[0]=F[0]*vt+Me[0]*Ut+Ae[0]*xi+Oe[0]*vi,k[1]=F[1]*vt+Me[1]*Ut+Ae[1]*xi+Oe[1]*vi,k[2]=F[2]*vt+Me[2]*Ut+Ae[2]*xi+Oe[2]*vi,k},Mi.random=function(F,Me){Me=Me||1;var Ae=2*k.RANDOM()*Math.PI,Oe=2*k.RANDOM()-1,Fe=Math.sqrt(1-Oe*Oe)*Me;return F[0]=Math.cos(Ae)*Fe,F[1]=Math.sin(Ae)*Fe,F[2]=Oe*Me,F},Mi.transformMat4=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=Me[3]*Ae+Me[7]*Oe+Me[11]*Fe+Me[15];return k[0]=(Me[0]*Ae+Me[4]*Oe+Me[8]*Fe+Me[12])/(je=je||1),k[1]=(Me[1]*Ae+Me[5]*Oe+Me[9]*Fe+Me[13])/je,k[2]=(Me[2]*Ae+Me[6]*Oe+Me[10]*Fe+Me[14])/je,k},Mi.transformMat3=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2];return k[0]=Ae*Me[0]+Oe*Me[3]+Fe*Me[6],k[1]=Ae*Me[1]+Oe*Me[4]+Fe*Me[7],k[2]=Ae*Me[2]+Oe*Me[5]+Fe*Me[8],k},Mi.transformQuat=function(k,F,Me){var Ae=Me[0],Oe=Me[1],Fe=Me[2],je=F[0],qe=F[1],pt=F[2],vt=Oe*pt-Fe*qe,Ut=Fe*je-Ae*pt,xi=Ae*qe-Oe*je,vi=Oe*xi-Fe*Ut,bi=Fe*vt-Ae*xi,wi=Ae*Ut-Oe*vt,Mi=2*Me[3];return Ut*=Mi,xi*=Mi,bi*=2,wi*=2,k[0]=je+(vt*=Mi)+(vi*=2),k[1]=qe+Ut+bi,k[2]=pt+xi+wi,k},Mi.rotateX=function(k,F,Me,Ae){var Oe=[],Fe=[];return Oe[0]=F[0]-Me[0],Oe[1]=F[1]-Me[1],Oe[2]=F[2]-Me[2],Fe[0]=Oe[0],Fe[1]=Oe[1]*Math.cos(Ae)-Oe[2]*Math.sin(Ae),Fe[2]=Oe[1]*Math.sin(Ae)+Oe[2]*Math.cos(Ae),k[0]=Fe[0]+Me[0],k[1]=Fe[1]+Me[1],k[2]=Fe[2]+Me[2],k},Mi.rotateY=function(k,F,Me,Ae){var Oe=[],Fe=[];return Oe[0]=F[0]-Me[0],Oe[1]=F[1]-Me[1],Oe[2]=F[2]-Me[2],Fe[0]=Oe[2]*Math.sin(Ae)+Oe[0]*Math.cos(Ae),Fe[1]=Oe[1],Fe[2]=Oe[2]*Math.cos(Ae)-Oe[0]*Math.sin(Ae),k[0]=Fe[0]+Me[0],k[1]=Fe[1]+Me[1],k[2]=Fe[2]+Me[2],k},Mi.rotateZ=function(k,F,Me,Ae){var Oe=[],Fe=[];return Oe[0]=F[0]-Me[0],Oe[1]=F[1]-Me[1],Oe[2]=F[2]-Me[2],Fe[0]=Oe[0]*Math.cos(Ae)-Oe[1]*Math.sin(Ae),Fe[1]=Oe[0]*Math.sin(Ae)+Oe[1]*Math.cos(Ae),Fe[2]=Oe[2],k[0]=Fe[0]+Me[0],k[1]=Fe[1]+Me[1],k[2]=Fe[2]+Me[2],k},Mi.angle=function(k,F){var Me=k[0],Ae=k[1],Oe=k[2],Fe=F[0],je=F[1],qe=F[2],pt=Math.sqrt(Me*Me+Ae*Ae+Oe*Oe)*Math.sqrt(Fe*Fe+je*je+qe*qe),vt=pt&&p(k,F)/pt;return Math.acos(Math.min(Math.max(vt,-1),1))},Mi.zero=function(k){return k[0]=0,k[1]=0,k[2]=0,k},Mi.str=function(k){return"vec3("+k[0]+", "+k[1]+", "+k[2]+")"},Mi.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]},Mi.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=Me[0],qe=Me[1],pt=Me[2];return Math.abs(Ae-je)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(je))&&Math.abs(Oe-qe)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(qe))&&Math.abs(Fe-pt)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(pt))},Mi.forEach=Mi.sqrLen=Mi.len=Mi.sqrDist=Mi.dist=Mi.div=Mi.mul=Mi.sub=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(){var F=new k.ARRAY_TYPE(3);return k.ARRAY_TYPE!=Float32Array&&(F[0]=0,F[1]=0,F[2]=0),F}function i(k){return Math.hypot(k[0],k[1],k[2])}function s(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k[2]=F[2]-Me[2],k}function o(k,F,Me){return k[0]=F[0]*Me[0],k[1]=F[1]*Me[1],k[2]=F[2]*Me[2],k}function l(k,F,Me){return k[0]=F[0]/Me[0],k[1]=F[1]/Me[1],k[2]=F[2]/Me[2],k}function u(k,F){return Math.hypot(F[0]-k[0],F[1]-k[1],F[2]-k[2])}function c(k,F){var Me=F[0]-k[0],Ae=F[1]-k[1],Oe=F[2]-k[2];return Me*Me+Ae*Ae+Oe*Oe}function h(k){var F=k[0],Me=k[1],Ae=k[2];return F*F+Me*Me+Ae*Ae}function p(k,F){return k[0]*F[0]+k[1]*F[1]+k[2]*F[2]}Mi.sub=s,Mi.mul=o,Mi.div=l,Mi.dist=u,Mi.sqrDist=c,Mi.len=i,Mi.sqrLen=h;var F,Me=(F=n(),function(k,Me,Ae,Oe,Fe,je){var qe,pt;for(Me||(Me=3),Ae||(Ae=0),pt=Oe?Math.min(Oe*Me+Ae,k.length):k.length,qe=Ae;qe<pt;qe+=Me)F[0]=k[qe],F[1]=k[qe+1],F[2]=k[qe+2],Fe(F,F,je),k[qe]=F[0],k[qe+1]=F[1],k[qe+2]=F[2];return k});return Mi.forEach=Me,Mi}var pr,Ur,Wr={};function S(){if(pr)return Wr;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}pr=1,Object.defineProperty(Wr,"__esModule",{value:!0}),Wr.create=n,Wr.clone=function(F){var Me=new k.ARRAY_TYPE(4);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me[3]=F[3],Me},Wr.fromValues=function(F,Me,Ae,Oe){var Fe=new k.ARRAY_TYPE(4);return Fe[0]=F,Fe[1]=Me,Fe[2]=Ae,Fe[3]=Oe,Fe},Wr.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k},Wr.set=function(k,F,Me,Ae,Oe){return k[0]=F,k[1]=Me,k[2]=Ae,k[3]=Oe,k},Wr.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k[3]=F[3]+Me[3],k},Wr.subtract=i,Wr.multiply=s,Wr.divide=o,Wr.ceil=function(k,F){return k[0]=Math.ceil(F[0]),k[1]=Math.ceil(F[1]),k[2]=Math.ceil(F[2]),k[3]=Math.ceil(F[3]),k},Wr.floor=function(k,F){return k[0]=Math.floor(F[0]),k[1]=Math.floor(F[1]),k[2]=Math.floor(F[2]),k[3]=Math.floor(F[3]),k},Wr.min=function(k,F,Me){return k[0]=Math.min(F[0],Me[0]),k[1]=Math.min(F[1],Me[1]),k[2]=Math.min(F[2],Me[2]),k[3]=Math.min(F[3],Me[3]),k},Wr.max=function(k,F,Me){return k[0]=Math.max(F[0],Me[0]),k[1]=Math.max(F[1],Me[1]),k[2]=Math.max(F[2],Me[2]),k[3]=Math.max(F[3],Me[3]),k},Wr.round=function(k,F){return k[0]=Math.round(F[0]),k[1]=Math.round(F[1]),k[2]=Math.round(F[2]),k[3]=Math.round(F[3]),k},Wr.scale=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k[3]=F[3]*Me,k},Wr.scaleAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k[2]=F[2]+Me[2]*Ae,k[3]=F[3]+Me[3]*Ae,k},Wr.distance=l,Wr.squaredDistance=u,Wr.length=c,Wr.squaredLength=h,Wr.negate=function(k,F){return k[0]=-F[0],k[1]=-F[1],k[2]=-F[2],k[3]=-F[3],k},Wr.inverse=function(k,F){return k[0]=1/F[0],k[1]=1/F[1],k[2]=1/F[2],k[3]=1/F[3],k},Wr.normalize=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Me*Me+Ae*Ae+Oe*Oe+Fe*Fe;return je>0&&(je=1/Math.sqrt(je)),k[0]=Me*je,k[1]=Ae*je,k[2]=Oe*je,k[3]=Fe*je,k},Wr.dot=function(k,F){return k[0]*F[0]+k[1]*F[1]+k[2]*F[2]+k[3]*F[3]},Wr.cross=function(k,F,Me,Ae){var Oe=Me[0]*Ae[1]-Me[1]*Ae[0],Fe=Me[0]*Ae[2]-Me[2]*Ae[0],je=Me[0]*Ae[3]-Me[3]*Ae[0],qe=Me[1]*Ae[2]-Me[2]*Ae[1],pt=Me[1]*Ae[3]-Me[3]*Ae[1],vt=Me[2]*Ae[3]-Me[3]*Ae[2],Ut=F[0],xi=F[1],vi=F[2],bi=F[3];return k[0]=xi*vt-vi*pt+bi*qe,k[1]=-Ut*vt+vi*je-bi*Fe,k[2]=Ut*pt-xi*je+bi*Oe,k[3]=-Ut*qe+xi*Fe-vi*Oe,k},Wr.lerp=function(k,F,Me,Ae){var Oe=F[0],Fe=F[1],je=F[2],qe=F[3];return k[0]=Oe+Ae*(Me[0]-Oe),k[1]=Fe+Ae*(Me[1]-Fe),k[2]=je+Ae*(Me[2]-je),k[3]=qe+Ae*(Me[3]-qe),k},Wr.random=function(F,Me){var Ae,Oe,Fe,je,qe,pt;Me=Me||1;do{qe=(Ae=2*k.RANDOM()-1)*Ae+(Oe=2*k.RANDOM()-1)*Oe}while(qe>=1);do{pt=(Fe=2*k.RANDOM()-1)*Fe+(je=2*k.RANDOM()-1)*je}while(pt>=1);var vt=Math.sqrt((1-qe)/pt);return F[0]=Me*Ae,F[1]=Me*Oe,F[2]=Me*Fe*vt,F[3]=Me*je*vt,F},Wr.transformMat4=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3];return k[0]=Me[0]*Ae+Me[4]*Oe+Me[8]*Fe+Me[12]*je,k[1]=Me[1]*Ae+Me[5]*Oe+Me[9]*Fe+Me[13]*je,k[2]=Me[2]*Ae+Me[6]*Oe+Me[10]*Fe+Me[14]*je,k[3]=Me[3]*Ae+Me[7]*Oe+Me[11]*Fe+Me[15]*je,k},Wr.transformQuat=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=Me[0],qe=Me[1],pt=Me[2],vt=Me[3],Ut=vt*Ae+qe*Fe-pt*Oe,xi=vt*Oe+pt*Ae-je*Fe,vi=vt*Fe+je*Oe-qe*Ae,bi=-je*Ae-qe*Oe-pt*Fe;return k[0]=Ut*vt+bi*-je+xi*-pt-vi*-qe,k[1]=xi*vt+bi*-qe+vi*-je-Ut*-pt,k[2]=vi*vt+bi*-pt+Ut*-qe-xi*-je,k[3]=F[3],k},Wr.zero=function(k){return k[0]=0,k[1]=0,k[2]=0,k[3]=0,k},Wr.str=function(k){return"vec4("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+")"},Wr.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]&&k[3]===F[3]},Wr.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Me[0],pt=Me[1],vt=Me[2],Ut=Me[3];return Math.abs(Ae-qe)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(qe))&&Math.abs(Oe-pt)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(pt))&&Math.abs(Fe-vt)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(vt))&&Math.abs(je-Ut)<=k.EPSILON*Math.max(1,Math.abs(je),Math.abs(Ut))},Wr.forEach=Wr.sqrLen=Wr.len=Wr.sqrDist=Wr.dist=Wr.div=Wr.mul=Wr.sub=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(){var F=new k.ARRAY_TYPE(4);return k.ARRAY_TYPE!=Float32Array&&(F[0]=0,F[1]=0,F[2]=0,F[3]=0),F}function i(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k[2]=F[2]-Me[2],k[3]=F[3]-Me[3],k}function s(k,F,Me){return k[0]=F[0]*Me[0],k[1]=F[1]*Me[1],k[2]=F[2]*Me[2],k[3]=F[3]*Me[3],k}function o(k,F,Me){return k[0]=F[0]/Me[0],k[1]=F[1]/Me[1],k[2]=F[2]/Me[2],k[3]=F[3]/Me[3],k}function l(k,F){return Math.hypot(F[0]-k[0],F[1]-k[1],F[2]-k[2],F[3]-k[3])}function u(k,F){var Me=F[0]-k[0],Ae=F[1]-k[1],Oe=F[2]-k[2],Fe=F[3]-k[3];return Me*Me+Ae*Ae+Oe*Oe+Fe*Fe}function c(k){return Math.hypot(k[0],k[1],k[2],k[3])}function h(k){var F=k[0],Me=k[1],Ae=k[2],Oe=k[3];return F*F+Me*Me+Ae*Ae+Oe*Oe}Wr.sub=i,Wr.mul=s,Wr.div=o,Wr.dist=l,Wr.sqrDist=u,Wr.len=c,Wr.sqrLen=h;var F,Me=(F=n(),function(k,Me,Ae,Oe,Fe,je){var qe,pt;for(Me||(Me=4),Ae||(Ae=0),pt=Oe?Math.min(Oe*Me+Ae,k.length):k.length,qe=Ae;qe<pt;qe+=Me)F[0]=k[qe],F[1]=k[qe+1],F[2]=k[qe+2],F[3]=k[qe+3],Fe(F,F,je),k[qe]=F[0],k[qe+1]=F[1],k[qe+2]=F[2],k[qe+3]=F[3];return k});return Wr.forEach=Me,Wr}function I(){if(Ur)return wi;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}Ur=1,Object.defineProperty(wi,"__esModule",{value:!0}),wi.create=l,wi.identity=function(k){return k[0]=0,k[1]=0,k[2]=0,k[3]=1,k},wi.setAxisAngle=u,wi.getAxisAngle=function(F,Me){var Ae=2*Math.acos(Me[3]),Oe=Math.sin(Ae/2);return Oe>k.EPSILON?(F[0]=Me[0]/Oe,F[1]=Me[1]/Oe,F[2]=Me[2]/Oe):(F[0]=1,F[1]=0,F[2]=0),Ae},wi.getAngle=function(k,F){var Me=Fe(k,F);return Math.acos(2*Me*Me-1)},wi.multiply=c,wi.rotateX=function(k,F,Me){Me*=.5;var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Math.sin(Me),pt=Math.cos(Me);return k[0]=Ae*pt+je*qe,k[1]=Oe*pt+Fe*qe,k[2]=Fe*pt-Oe*qe,k[3]=je*pt-Ae*qe,k},wi.rotateY=function(k,F,Me){Me*=.5;var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Math.sin(Me),pt=Math.cos(Me);return k[0]=Ae*pt-Fe*qe,k[1]=Oe*pt+je*qe,k[2]=Fe*pt+Ae*qe,k[3]=je*pt-Oe*qe,k},wi.rotateZ=function(k,F,Me){Me*=.5;var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Math.sin(Me),pt=Math.cos(Me);return k[0]=Ae*pt+Oe*qe,k[1]=Oe*pt-Ae*qe,k[2]=Fe*pt+je*qe,k[3]=je*pt-Fe*qe,k},wi.calculateW=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2];return k[0]=Me,k[1]=Ae,k[2]=Oe,k[3]=Math.sqrt(Math.abs(1-Me*Me-Ae*Ae-Oe*Oe)),k},wi.exp=h,wi.ln=p,wi.pow=function(k,F,Me){return p(k,F),Oe(k,k,Me),h(k,k),k},wi.slerp=f,wi.random=function(F){var Me=k.RANDOM(),Ae=k.RANDOM(),Oe=k.RANDOM(),Fe=Math.sqrt(1-Me),je=Math.sqrt(Me);return F[0]=Fe*Math.sin(2*Math.PI*Ae),F[1]=Fe*Math.cos(2*Math.PI*Ae),F[2]=je*Math.sin(2*Math.PI*Oe),F[3]=je*Math.cos(2*Math.PI*Oe),F},wi.invert=function(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Me*Me+Ae*Ae+Oe*Oe+Fe*Fe,qe=je?1/je:0;return k[0]=-Me*qe,k[1]=-Ae*qe,k[2]=-Oe*qe,k[3]=Fe*qe,k},wi.conjugate=function(k,F){return k[0]=-F[0],k[1]=-F[1],k[2]=-F[2],k[3]=F[3],k},wi.fromMat3=m,wi.fromEuler=function(k,F,Me,Ae){var Oe=.5*Math.PI/180;F*=Oe,Me*=Oe,Ae*=Oe;var Fe=Math.sin(F),je=Math.cos(F),qe=Math.sin(Me),pt=Math.cos(Me),vt=Math.sin(Ae),Ut=Math.cos(Ae);return k[0]=Fe*pt*Ut-je*qe*vt,k[1]=je*qe*Ut+Fe*pt*vt,k[2]=je*pt*vt-Fe*qe*Ut,k[3]=je*pt*Ut+Fe*qe*vt,k},wi.str=function(k){return"quat("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+")"},wi.setAxes=wi.sqlerp=wi.rotationTo=wi.equals=wi.exactEquals=wi.normalize=wi.sqrLen=wi.squaredLength=wi.len=wi.length=wi.lerp=wi.dot=wi.scale=wi.mul=wi.add=wi.set=wi.copy=wi.fromValues=wi.clone=void 0;var k=o(a()),F=o(d()),Me=o(_()),Ae=o(S());function s(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(s=function(k){return k?Me:F})(k)}function o(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=s(F);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}function l(){var F=new k.ARRAY_TYPE(4);return k.ARRAY_TYPE!=Float32Array&&(F[0]=0,F[1]=0,F[2]=0),F[3]=1,F}function u(k,F,Me){Me*=.5;var Ae=Math.sin(Me);return k[0]=Ae*F[0],k[1]=Ae*F[1],k[2]=Ae*F[2],k[3]=Math.cos(Me),k}function c(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Me[0],pt=Me[1],vt=Me[2],Ut=Me[3];return k[0]=Ae*Ut+je*qe+Oe*vt-Fe*pt,k[1]=Oe*Ut+je*pt+Fe*qe-Ae*vt,k[2]=Fe*Ut+je*vt+Ae*pt-Oe*qe,k[3]=je*Ut-Ae*qe-Oe*pt-Fe*vt,k}function h(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Math.sqrt(Me*Me+Ae*Ae+Oe*Oe),qe=Math.exp(Fe),pt=je>0?qe*Math.sin(je)/je:0;return k[0]=Me*pt,k[1]=Ae*pt,k[2]=Oe*pt,k[3]=qe*Math.cos(je),k}function p(k,F){var Me=F[0],Ae=F[1],Oe=F[2],Fe=F[3],je=Math.sqrt(Me*Me+Ae*Ae+Oe*Oe),qe=je>0?Math.atan2(je,Fe)/je:0;return k[0]=Me*qe,k[1]=Ae*qe,k[2]=Oe*qe,k[3]=.5*Math.log(Me*Me+Ae*Ae+Oe*Oe+Fe*Fe),k}function f(F,Me,Ae,Oe){var Fe,je,qe,pt,vt,Ut=Me[0],xi=Me[1],vi=Me[2],bi=Me[3],wi=Ae[0],Mi=Ae[1],pr=Ae[2],Ur=Ae[3];return(je=Ut*wi+xi*Mi+vi*pr+bi*Ur)<0&&(je=-je,wi=-wi,Mi=-Mi,pr=-pr,Ur=-Ur),1-je>k.EPSILON?(Fe=Math.acos(je),qe=Math.sin(Fe),pt=Math.sin((1-Oe)*Fe)/qe,vt=Math.sin(Oe*Fe)/qe):(pt=1-Oe,vt=Oe),F[0]=pt*Ut+vt*wi,F[1]=pt*xi+vt*Mi,F[2]=pt*vi+vt*pr,F[3]=pt*bi+vt*Ur,F}function m(k,F){var Me,Ae=F[0]+F[4]+F[8];if(Ae>0)Me=Math.sqrt(Ae+1),k[3]=.5*Me,k[0]=(F[5]-F[7])*(Me=.5/Me),k[1]=(F[6]-F[2])*Me,k[2]=(F[1]-F[3])*Me;else{var Oe=0;F[4]>F[0]&&(Oe=1),F[8]>F[3*Oe+Oe]&&(Oe=2);var Fe=(Oe+1)%3,je=(Oe+2)%3;Me=Math.sqrt(F[3*Oe+Oe]-F[3*Fe+Fe]-F[3*je+je]+1),k[Oe]=.5*Me,k[3]=(F[3*Fe+je]-F[3*je+Fe])*(Me=.5/Me),k[Fe]=(F[3*Fe+Oe]+F[3*Oe+Fe])*Me,k[je]=(F[3*je+Oe]+F[3*Oe+je])*Me}return k}wi.clone=Ae.clone,wi.fromValues=Ae.fromValues,wi.copy=Ae.copy,wi.set=Ae.set,wi.add=Ae.add,wi.mul=c;var Oe=Ae.scale;wi.scale=Oe;var Fe=Ae.dot;wi.dot=Fe,wi.lerp=Ae.lerp;var je=Ae.length;wi.length=je,wi.len=je;var qe=Ae.squaredLength;wi.squaredLength=qe,wi.sqrLen=qe;var pt=Ae.normalize;wi.normalize=pt,wi.exactEquals=Ae.exactEquals,wi.equals=Ae.equals;var vt,Ut,xi,vi=(vt=Me.create(),Ut=Me.fromValues(1,0,0),xi=Me.fromValues(0,1,0),function(k,F,Ae){var Oe=Me.dot(F,Ae);return Oe<-.999999?(Me.cross(vt,Ut,F),Me.len(vt)<1e-6&&Me.cross(vt,xi,F),Me.normalize(vt,vt),u(k,vt,Math.PI),k):Oe>.999999?(k[0]=0,k[1]=0,k[2]=0,k[3]=1,k):(Me.cross(vt,F,Ae),k[0]=vt[0],k[1]=vt[1],k[2]=vt[2],k[3]=1+Oe,pt(k,k))});wi.rotationTo=vi;var bi,Mi,pr=(bi=l(),Mi=l(),function(k,F,Me,Ae,Oe,Fe){return f(bi,F,Oe,Fe),f(Mi,Me,Ae,Fe),f(k,bi,Mi,2*Fe*(1-Fe)),k});wi.sqlerp=pr;var Wr,Jr=(Wr=F.create(),function(k,F,Me,Ae){return Wr[0]=Me[0],Wr[3]=Me[1],Wr[6]=Me[2],Wr[1]=Ae[0],Wr[4]=Ae[1],Wr[7]=Ae[2],Wr[2]=-F[0],Wr[5]=-F[1],Wr[8]=-F[2],pt(k,m(k,Wr))});return wi.setAxes=Jr,wi}var Jr,Qr={};function E(){if(Jr)return Qr;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}Jr=1,Object.defineProperty(Qr,"__esModule",{value:!0}),Qr.create=function(){var F=new k.ARRAY_TYPE(8);return k.ARRAY_TYPE!=Float32Array&&(F[0]=0,F[1]=0,F[2]=0,F[4]=0,F[5]=0,F[6]=0,F[7]=0),F[3]=1,F},Qr.clone=function(F){var Me=new k.ARRAY_TYPE(8);return Me[0]=F[0],Me[1]=F[1],Me[2]=F[2],Me[3]=F[3],Me[4]=F[4],Me[5]=F[5],Me[6]=F[6],Me[7]=F[7],Me},Qr.fromValues=function(F,Me,Ae,Oe,Fe,je,qe,pt){var vt=new k.ARRAY_TYPE(8);return vt[0]=F,vt[1]=Me,vt[2]=Ae,vt[3]=Oe,vt[4]=Fe,vt[5]=je,vt[6]=qe,vt[7]=pt,vt},Qr.fromRotationTranslationValues=function(F,Me,Ae,Oe,Fe,je,qe){var pt=new k.ARRAY_TYPE(8);pt[0]=F,pt[1]=Me,pt[2]=Ae,pt[3]=Oe;var vt=.5*Fe,Ut=.5*je,xi=.5*qe;return pt[4]=vt*Oe+Ut*Ae-xi*Me,pt[5]=Ut*Oe+xi*F-vt*Ae,pt[6]=xi*Oe+vt*Me-Ut*F,pt[7]=-vt*F-Ut*Me-xi*Ae,pt},Qr.fromRotationTranslation=o,Qr.fromTranslation=function(k,F){return k[0]=0,k[1]=0,k[2]=0,k[3]=1,k[4]=.5*F[0],k[5]=.5*F[1],k[6]=.5*F[2],k[7]=0,k},Qr.fromRotation=function(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k[4]=0,k[5]=0,k[6]=0,k[7]=0,k},Qr.fromMat4=function(Ae,Oe){var Fe=F.create();Me.getRotation(Fe,Oe);var je=new k.ARRAY_TYPE(3);return Me.getTranslation(je,Oe),o(Ae,Fe,je),Ae},Qr.copy=l,Qr.identity=function(k){return k[0]=0,k[1]=0,k[2]=0,k[3]=1,k[4]=0,k[5]=0,k[6]=0,k[7]=0,k},Qr.set=function(k,F,Me,Ae,Oe,Fe,je,qe,pt){return k[0]=F,k[1]=Me,k[2]=Ae,k[3]=Oe,k[4]=Fe,k[5]=je,k[6]=qe,k[7]=pt,k},Qr.getDual=function(k,F){return k[0]=F[4],k[1]=F[5],k[2]=F[6],k[3]=F[7],k},Qr.setDual=function(k,F){return k[4]=F[0],k[5]=F[1],k[6]=F[2],k[7]=F[3],k},Qr.getTranslation=function(k,F){var Me=F[4],Ae=F[5],Oe=F[6],Fe=F[7],je=-F[0],qe=-F[1],pt=-F[2],vt=F[3];return k[0]=2*(Me*vt+Fe*je+Ae*pt-Oe*qe),k[1]=2*(Ae*vt+Fe*qe+Oe*je-Me*pt),k[2]=2*(Oe*vt+Fe*pt+Me*qe-Ae*je),k},Qr.translate=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=.5*Me[0],pt=.5*Me[1],vt=.5*Me[2],Ut=F[4],xi=F[5],vi=F[6],bi=F[7];return k[0]=Ae,k[1]=Oe,k[2]=Fe,k[3]=je,k[4]=je*qe+Oe*vt-Fe*pt+Ut,k[5]=je*pt+Fe*qe-Ae*vt+xi,k[6]=je*vt+Ae*pt-Oe*qe+vi,k[7]=-Ae*qe-Oe*pt-Fe*vt+bi,k},Qr.rotateX=function(k,Me,Ae){var Oe=-Me[0],Fe=-Me[1],je=-Me[2],qe=Me[3],pt=Me[4],vt=Me[5],Ut=Me[6],xi=Me[7],vi=pt*qe+xi*Oe+vt*je-Ut*Fe,bi=vt*qe+xi*Fe+Ut*Oe-pt*je,wi=Ut*qe+xi*je+pt*Fe-vt*Oe,Mi=xi*qe-pt*Oe-vt*Fe-Ut*je;return F.rotateX(k,Me,Ae),k[4]=vi*(qe=k[3])+Mi*(Oe=k[0])+bi*(je=k[2])-wi*(Fe=k[1]),k[5]=bi*qe+Mi*Fe+wi*Oe-vi*je,k[6]=wi*qe+Mi*je+vi*Fe-bi*Oe,k[7]=Mi*qe-vi*Oe-bi*Fe-wi*je,k},Qr.rotateY=function(k,Me,Ae){var Oe=-Me[0],Fe=-Me[1],je=-Me[2],qe=Me[3],pt=Me[4],vt=Me[5],Ut=Me[6],xi=Me[7],vi=pt*qe+xi*Oe+vt*je-Ut*Fe,bi=vt*qe+xi*Fe+Ut*Oe-pt*je,wi=Ut*qe+xi*je+pt*Fe-vt*Oe,Mi=xi*qe-pt*Oe-vt*Fe-Ut*je;return F.rotateY(k,Me,Ae),k[4]=vi*(qe=k[3])+Mi*(Oe=k[0])+bi*(je=k[2])-wi*(Fe=k[1]),k[5]=bi*qe+Mi*Fe+wi*Oe-vi*je,k[6]=wi*qe+Mi*je+vi*Fe-bi*Oe,k[7]=Mi*qe-vi*Oe-bi*Fe-wi*je,k},Qr.rotateZ=function(k,Me,Ae){var Oe=-Me[0],Fe=-Me[1],je=-Me[2],qe=Me[3],pt=Me[4],vt=Me[5],Ut=Me[6],xi=Me[7],vi=pt*qe+xi*Oe+vt*je-Ut*Fe,bi=vt*qe+xi*Fe+Ut*Oe-pt*je,wi=Ut*qe+xi*je+pt*Fe-vt*Oe,Mi=xi*qe-pt*Oe-vt*Fe-Ut*je;return F.rotateZ(k,Me,Ae),k[4]=vi*(qe=k[3])+Mi*(Oe=k[0])+bi*(je=k[2])-wi*(Fe=k[1]),k[5]=bi*qe+Mi*Fe+wi*Oe-vi*je,k[6]=wi*qe+Mi*je+vi*Fe-bi*Oe,k[7]=Mi*qe-vi*Oe-bi*Fe-wi*je,k},Qr.rotateByQuatAppend=function(k,F,Me){var Ae=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=F[0],pt=F[1],vt=F[2],Ut=F[3];return k[0]=qe*je+Ut*Ae+pt*Fe-vt*Oe,k[1]=pt*je+Ut*Oe+vt*Ae-qe*Fe,k[2]=vt*je+Ut*Fe+qe*Oe-pt*Ae,k[3]=Ut*je-qe*Ae-pt*Oe-vt*Fe,k[4]=(qe=F[4])*je+(Ut=F[7])*Ae+(pt=F[5])*Fe-(vt=F[6])*Oe,k[5]=pt*je+Ut*Oe+vt*Ae-qe*Fe,k[6]=vt*je+Ut*Fe+qe*Oe-pt*Ae,k[7]=Ut*je-qe*Ae-pt*Oe-vt*Fe,k},Qr.rotateByQuatPrepend=function(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Me[0],pt=Me[1],vt=Me[2],Ut=Me[3];return k[0]=Ae*Ut+je*qe+Oe*vt-Fe*pt,k[1]=Oe*Ut+je*pt+Fe*qe-Ae*vt,k[2]=Fe*Ut+je*vt+Ae*pt-Oe*qe,k[3]=je*Ut-Ae*qe-Oe*pt-Fe*vt,k[4]=Ae*(Ut=Me[7])+je*(qe=Me[4])+Oe*(vt=Me[6])-Fe*(pt=Me[5]),k[5]=Oe*Ut+je*pt+Fe*qe-Ae*vt,k[6]=Fe*Ut+je*vt+Ae*pt-Oe*qe,k[7]=je*Ut-Ae*qe-Oe*pt-Fe*vt,k},Qr.rotateAroundAxis=function(F,Me,Ae,Oe){if(Math.abs(Oe)<k.EPSILON)return l(F,Me);var Fe=Math.hypot(Ae[0],Ae[1],Ae[2]);Oe*=.5;var je=Math.sin(Oe),qe=je*Ae[0]/Fe,pt=je*Ae[1]/Fe,vt=je*Ae[2]/Fe,Ut=Math.cos(Oe),xi=Me[0],vi=Me[1],bi=Me[2],wi=Me[3];F[0]=xi*Ut+wi*qe+vi*vt-bi*pt,F[1]=vi*Ut+wi*pt+bi*qe-xi*vt,F[2]=bi*Ut+wi*vt+xi*pt-vi*qe,F[3]=wi*Ut-xi*qe-vi*pt-bi*vt;var Mi=Me[4],pr=Me[5],Ur=Me[6],Wr=Me[7];return F[4]=Mi*Ut+Wr*qe+pr*vt-Ur*pt,F[5]=pr*Ut+Wr*pt+Ur*qe-Mi*vt,F[6]=Ur*Ut+Wr*vt+Mi*pt-pr*qe,F[7]=Wr*Ut-Mi*qe-pr*pt-Ur*vt,F},Qr.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k[2]=F[2]+Me[2],k[3]=F[3]+Me[3],k[4]=F[4]+Me[4],k[5]=F[5]+Me[5],k[6]=F[6]+Me[6],k[7]=F[7]+Me[7],k},Qr.multiply=u,Qr.scale=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k[2]=F[2]*Me,k[3]=F[3]*Me,k[4]=F[4]*Me,k[5]=F[5]*Me,k[6]=F[6]*Me,k[7]=F[7]*Me,k},Qr.lerp=function(k,F,Me,Oe){var Fe=1-Oe;return Ae(F,Me)<0&&(Oe=-Oe),k[0]=F[0]*Fe+Me[0]*Oe,k[1]=F[1]*Fe+Me[1]*Oe,k[2]=F[2]*Fe+Me[2]*Oe,k[3]=F[3]*Fe+Me[3]*Oe,k[4]=F[4]*Fe+Me[4]*Oe,k[5]=F[5]*Fe+Me[5]*Oe,k[6]=F[6]*Fe+Me[6]*Oe,k[7]=F[7]*Fe+Me[7]*Oe,k},Qr.invert=function(k,F){var Me=Fe(F);return k[0]=-F[0]/Me,k[1]=-F[1]/Me,k[2]=-F[2]/Me,k[3]=F[3]/Me,k[4]=-F[4]/Me,k[5]=-F[5]/Me,k[6]=-F[6]/Me,k[7]=F[7]/Me,k},Qr.conjugate=function(k,F){return k[0]=-F[0],k[1]=-F[1],k[2]=-F[2],k[3]=F[3],k[4]=-F[4],k[5]=-F[5],k[6]=-F[6],k[7]=F[7],k},Qr.normalize=function(k,F){var Me=Fe(F);if(Me>0){Me=Math.sqrt(Me);var Ae=F[0]/Me,Oe=F[1]/Me,je=F[2]/Me,qe=F[3]/Me,pt=F[4],vt=F[5],Ut=F[6],xi=F[7],vi=Ae*pt+Oe*vt+je*Ut+qe*xi;k[0]=Ae,k[1]=Oe,k[2]=je,k[3]=qe,k[4]=(pt-Ae*vi)/Me,k[5]=(vt-Oe*vi)/Me,k[6]=(Ut-je*vi)/Me,k[7]=(xi-qe*vi)/Me}return k},Qr.str=function(k){return"quat2("+k[0]+", "+k[1]+", "+k[2]+", "+k[3]+", "+k[4]+", "+k[5]+", "+k[6]+", "+k[7]+")"},Qr.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]&&k[2]===F[2]&&k[3]===F[3]&&k[4]===F[4]&&k[5]===F[5]&&k[6]===F[6]&&k[7]===F[7]},Qr.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],pt=F[5],vt=F[6],Ut=F[7],xi=Me[0],vi=Me[1],bi=Me[2],wi=Me[3],Mi=Me[4],pr=Me[5],Ur=Me[6],Wr=Me[7];return Math.abs(Ae-xi)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(xi))&&Math.abs(Oe-vi)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(vi))&&Math.abs(Fe-bi)<=k.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(bi))&&Math.abs(je-wi)<=k.EPSILON*Math.max(1,Math.abs(je),Math.abs(wi))&&Math.abs(qe-Mi)<=k.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Mi))&&Math.abs(pt-pr)<=k.EPSILON*Math.max(1,Math.abs(pt),Math.abs(pr))&&Math.abs(vt-Ur)<=k.EPSILON*Math.max(1,Math.abs(vt),Math.abs(Ur))&&Math.abs(Ut-Wr)<=k.EPSILON*Math.max(1,Math.abs(Ut),Math.abs(Wr))},Qr.sqrLen=Qr.squaredLength=Qr.len=Qr.length=Qr.dot=Qr.mul=Qr.setReal=Qr.getReal=void 0;var k=s(a()),F=s(I()),Me=s(g());function i(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(i=function(k){return k?Me:F})(k)}function s(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=i(F);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}function o(k,F,Me){var Ae=.5*Me[0],Oe=.5*Me[1],Fe=.5*Me[2],je=F[0],qe=F[1],pt=F[2],vt=F[3];return k[0]=je,k[1]=qe,k[2]=pt,k[3]=vt,k[4]=Ae*vt+Oe*pt-Fe*qe,k[5]=Oe*vt+Fe*je-Ae*pt,k[6]=Fe*vt+Ae*qe-Oe*je,k[7]=-Ae*je-Oe*qe-Fe*pt,k}function l(k,F){return k[0]=F[0],k[1]=F[1],k[2]=F[2],k[3]=F[3],k[4]=F[4],k[5]=F[5],k[6]=F[6],k[7]=F[7],k}function u(k,F,Me){var Ae=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=Me[4],pt=Me[5],vt=Me[6],Ut=Me[7],xi=F[4],vi=F[5],bi=F[6],wi=F[7],Mi=Me[0],pr=Me[1],Ur=Me[2],Wr=Me[3];return k[0]=Ae*Wr+je*Mi+Oe*Ur-Fe*pr,k[1]=Oe*Wr+je*pr+Fe*Mi-Ae*Ur,k[2]=Fe*Wr+je*Ur+Ae*pr-Oe*Mi,k[3]=je*Wr-Ae*Mi-Oe*pr-Fe*Ur,k[4]=Ae*Ut+je*qe+Oe*vt-Fe*pt+xi*Wr+wi*Mi+vi*Ur-bi*pr,k[5]=Oe*Ut+je*pt+Fe*qe-Ae*vt+vi*Wr+wi*pr+bi*Mi-xi*Ur,k[6]=Fe*Ut+je*vt+Ae*pt-Oe*qe+bi*Wr+wi*Ur+xi*pr-vi*Mi,k[7]=je*Ut-Ae*qe-Oe*pt-Fe*vt+wi*Wr-xi*Mi-vi*pr-bi*Ur,k}Qr.getReal=F.copy,Qr.setReal=F.copy,Qr.mul=u;var Ae=F.dot;Qr.dot=Ae;var Oe=F.length;Qr.length=Oe,Qr.len=Oe;var Fe=F.squaredLength;return Qr.squaredLength=Fe,Qr.sqrLen=Fe,Qr}var co,mo,yo={};function V(){if(co)return yo;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}co=1,Object.defineProperty(yo,"__esModule",{value:!0}),yo.create=n,yo.clone=function(F){var Me=new k.ARRAY_TYPE(2);return Me[0]=F[0],Me[1]=F[1],Me},yo.fromValues=function(F,Me){var Ae=new k.ARRAY_TYPE(2);return Ae[0]=F,Ae[1]=Me,Ae},yo.copy=function(k,F){return k[0]=F[0],k[1]=F[1],k},yo.set=function(k,F,Me){return k[0]=F,k[1]=Me,k},yo.add=function(k,F,Me){return k[0]=F[0]+Me[0],k[1]=F[1]+Me[1],k},yo.subtract=i,yo.multiply=s,yo.divide=o,yo.ceil=function(k,F){return k[0]=Math.ceil(F[0]),k[1]=Math.ceil(F[1]),k},yo.floor=function(k,F){return k[0]=Math.floor(F[0]),k[1]=Math.floor(F[1]),k},yo.min=function(k,F,Me){return k[0]=Math.min(F[0],Me[0]),k[1]=Math.min(F[1],Me[1]),k},yo.max=function(k,F,Me){return k[0]=Math.max(F[0],Me[0]),k[1]=Math.max(F[1],Me[1]),k},yo.round=function(k,F){return k[0]=Math.round(F[0]),k[1]=Math.round(F[1]),k},yo.scale=function(k,F,Me){return k[0]=F[0]*Me,k[1]=F[1]*Me,k},yo.scaleAndAdd=function(k,F,Me,Ae){return k[0]=F[0]+Me[0]*Ae,k[1]=F[1]+Me[1]*Ae,k},yo.distance=l,yo.squaredDistance=u,yo.length=c,yo.squaredLength=h,yo.negate=function(k,F){return k[0]=-F[0],k[1]=-F[1],k},yo.inverse=function(k,F){return k[0]=1/F[0],k[1]=1/F[1],k},yo.normalize=function(k,F){var Me=F[0],Ae=F[1],Oe=Me*Me+Ae*Ae;return Oe>0&&(Oe=1/Math.sqrt(Oe)),k[0]=F[0]*Oe,k[1]=F[1]*Oe,k},yo.dot=function(k,F){return k[0]*F[0]+k[1]*F[1]},yo.cross=function(k,F,Me){var Ae=F[0]*Me[1]-F[1]*Me[0];return k[0]=k[1]=0,k[2]=Ae,k},yo.lerp=function(k,F,Me,Ae){var Oe=F[0],Fe=F[1];return k[0]=Oe+Ae*(Me[0]-Oe),k[1]=Fe+Ae*(Me[1]-Fe),k},yo.random=function(F,Me){Me=Me||1;var Ae=2*k.RANDOM()*Math.PI;return F[0]=Math.cos(Ae)*Me,F[1]=Math.sin(Ae)*Me,F},yo.transformMat2=function(k,F,Me){var Ae=F[0],Oe=F[1];return k[0]=Me[0]*Ae+Me[2]*Oe,k[1]=Me[1]*Ae+Me[3]*Oe,k},yo.transformMat2d=function(k,F,Me){var Ae=F[0],Oe=F[1];return k[0]=Me[0]*Ae+Me[2]*Oe+Me[4],k[1]=Me[1]*Ae+Me[3]*Oe+Me[5],k},yo.transformMat3=function(k,F,Me){var Ae=F[0],Oe=F[1];return k[0]=Me[0]*Ae+Me[3]*Oe+Me[6],k[1]=Me[1]*Ae+Me[4]*Oe+Me[7],k},yo.transformMat4=function(k,F,Me){var Ae=F[0],Oe=F[1];return k[0]=Me[0]*Ae+Me[4]*Oe+Me[12],k[1]=Me[1]*Ae+Me[5]*Oe+Me[13],k},yo.rotate=function(k,F,Me,Ae){var Oe=F[0]-Me[0],Fe=F[1]-Me[1],je=Math.sin(Ae),qe=Math.cos(Ae);return k[0]=Oe*qe-Fe*je+Me[0],k[1]=Oe*je+Fe*qe+Me[1],k},yo.angle=function(k,F){var Me=k[0],Ae=k[1],Oe=F[0],Fe=F[1],je=Math.sqrt(Me*Me+Ae*Ae)*Math.sqrt(Oe*Oe+Fe*Fe);return Math.acos(Math.min(Math.max(je&&(Me*Oe+Ae*Fe)/je,-1),1))},yo.zero=function(k){return k[0]=0,k[1]=0,k},yo.str=function(k){return"vec2("+k[0]+", "+k[1]+")"},yo.exactEquals=function(k,F){return k[0]===F[0]&&k[1]===F[1]},yo.equals=function(F,Me){var Ae=F[0],Oe=F[1],Fe=Me[0],je=Me[1];return Math.abs(Ae-Fe)<=k.EPSILON*Math.max(1,Math.abs(Ae),Math.abs(Fe))&&Math.abs(Oe-je)<=k.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(je))},yo.forEach=yo.sqrLen=yo.sqrDist=yo.dist=yo.div=yo.mul=yo.sub=yo.len=void 0;var k=function(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=r(void 0);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}(a());function r(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(r=function(k){return k?Me:F})(k)}function n(){var F=new k.ARRAY_TYPE(2);return k.ARRAY_TYPE!=Float32Array&&(F[0]=0,F[1]=0),F}function i(k,F,Me){return k[0]=F[0]-Me[0],k[1]=F[1]-Me[1],k}function s(k,F,Me){return k[0]=F[0]*Me[0],k[1]=F[1]*Me[1],k}function o(k,F,Me){return k[0]=F[0]/Me[0],k[1]=F[1]/Me[1],k}function l(k,F){return Math.hypot(F[0]-k[0],F[1]-k[1])}function u(k,F){var Me=F[0]-k[0],Ae=F[1]-k[1];return Me*Me+Ae*Ae}function c(k){return Math.hypot(k[0],k[1])}function h(k){var F=k[0],Me=k[1];return F*F+Me*Me}yo.len=c,yo.sub=i,yo.mul=s,yo.div=o,yo.dist=l,yo.sqrDist=u,yo.sqrLen=h;var F,Me=(F=n(),function(k,Me,Ae,Oe,Fe,je){var qe,pt;for(Me||(Me=2),Ae||(Ae=0),pt=Oe?Math.min(Oe*Me+Ae,k.length):k.length,qe=Ae;qe<pt;qe+=Me)F[0]=k[qe],F[1]=k[qe+1],Fe(F,F,je),k[qe]=F[0],k[qe+1]=F[1];return k});return yo.forEach=Me,yo}function C(){if(mo)return Ae;function t(k){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(k){return typeof k}:function(k){return k&&"function"==typeof Symbol&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},t(k)}mo=1,Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.vec4=Ae.vec3=Ae.vec2=Ae.quat2=Ae.quat=Ae.mat4=Ae.mat3=Ae.mat2d=Ae.mat2=Ae.glMatrix=void 0;var k=x(a());Ae.glMatrix=k;var F=x(l());Ae.mat2=F;var Me=x(h());Ae.mat2d=Me;var Oe=x(d());Ae.mat3=Oe;var Fe=x(g());Ae.mat4=Fe;var je=x(I());Ae.quat=je;var qe=x(E());Ae.quat2=qe;var pt=x(V());Ae.vec2=pt;var vt=x(_());Ae.vec3=vt;var Ut=x(S());function y(k){if("function"!=typeof WeakMap)return null;var F=new WeakMap,Me=new WeakMap;return(y=function(k){return k?Me:F})(k)}function x(k,F){if(k&&k.__esModule)return k;if(null===k||"object"!==t(k)&&"function"!=typeof k)return{default:k};var Me=y(F);if(Me&&Me.has(k))return Me.get(k);var Ae={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in k)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(k,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(k,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Ae,Fe,je):Ae[Fe]=k[Fe]}return Ae.default=k,Me&&Me.set(k,Ae),Ae}return Ae.vec4=Ut,Ae}var To,zo,ko,na,aa=C(),_a=function(){if(zo)return To;function t(F,Me,Ae,Oe){(this||k).cx=3*F,(this||k).bx=3*(Ae-F)-(this||k).cx,(this||k).ax=1-(this||k).cx-(this||k).bx,(this||k).cy=3*Me,(this||k).by=3*(Oe-Me)-(this||k).cy,(this||k).ay=1-(this||k).cy-(this||k).by,(this||k).p1x=F,(this||k).p1y=Me,(this||k).p2x=Ae,(this||k).p2y=Oe}return zo=1,To=t,t.prototype={sampleCurveX:function(F){return(((this||k).ax*F+(this||k).bx)*F+(this||k).cx)*F},sampleCurveY:function(F){return(((this||k).ay*F+(this||k).by)*F+(this||k).cy)*F},sampleCurveDerivativeX:function(F){return(3*(this||k).ax*F+2*(this||k).bx)*F+(this||k).cx},solveCurveX:function(k,F){if(void 0===F&&(F=1e-6),k<0)return 0;if(k>1)return 1;for(var Me=k,Ae=0;Ae<8;Ae++){var Oe=this.sampleCurveX(Me)-k;if(Math.abs(Oe)<F)return Me;var Fe=this.sampleCurveDerivativeX(Me);if(Math.abs(Fe)<1e-6)break;Me-=Oe/Fe}var je=0,qe=1;for(Me=k,Ae=0;Ae<20&&(Oe=this.sampleCurveX(Me),!(Math.abs(Oe-k)<F));Ae++)k>Oe?je=Me:qe=Me,Me=.5*(qe-je)+je;return Me},solve:function(k,F){return this.sampleCurveY(this.solveCurveX(k,F))}},To}(),wa=e(_a);function j(){if(na)return ko;function t(F,Me){(this||k).x=F,(this||k).y=Me}return na=1,ko=t,t.prototype={clone:function(){return new t((this||k).x,(this||k).y)},add:function(k){return this.clone()._add(k)},sub:function(k){return this.clone()._sub(k)},multByPoint:function(k){return this.clone()._multByPoint(k)},divByPoint:function(k){return this.clone()._divByPoint(k)},mult:function(k){return this.clone()._mult(k)},div:function(k){return this.clone()._div(k)},rotate:function(k){return this.clone()._rotate(k)},rotateAround:function(k,F){return this.clone()._rotateAround(k,F)},matMult:function(k){return this.clone()._matMult(k)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||k).x*(this||k).x+(this||k).y*(this||k).y)},equals:function(F){return(this||k).x===F.x&&(this||k).y===F.y},dist:function(k){return Math.sqrt(this.distSqr(k))},distSqr:function(F){var Me=F.x-(this||k).x,Ae=F.y-(this||k).y;return Me*Me+Ae*Ae},angle:function(){return Math.atan2((this||k).y,(this||k).x)},angleTo:function(F){return Math.atan2((this||k).y-F.y,(this||k).x-F.x)},angleWith:function(k){return this.angleWithSep(k.x,k.y)},angleWithSep:function(F,Me){return Math.atan2((this||k).x*Me-(this||k).y*F,(this||k).x*F+(this||k).y*Me)},_matMult:function(F){var Me=F[2]*(this||k).x+F[3]*(this||k).y;return(this||k).x=F[0]*(this||k).x+F[1]*(this||k).y,(this||k).y=Me,this||k},_add:function(F){return(this||k).x+=F.x,(this||k).y+=F.y,this||k},_sub:function(F){return(this||k).x-=F.x,(this||k).y-=F.y,this||k},_mult:function(F){return(this||k).x*=F,(this||k).y*=F,this||k},_div:function(F){return(this||k).x/=F,(this||k).y/=F,this||k},_multByPoint:function(F){return(this||k).x*=F.x,(this||k).y*=F.y,this||k},_divByPoint:function(F){return(this||k).x/=F.x,(this||k).y/=F.y,this||k},_unit:function(){return this._div(this.mag()),this||k},_perp:function(){var F=(this||k).y;return(this||k).y=(this||k).x,(this||k).x=-F,this||k},_rotate:function(F){var Me=Math.cos(F),Ae=Math.sin(F),Oe=Ae*(this||k).x+Me*(this||k).y;return(this||k).x=Me*(this||k).x-Ae*(this||k).y,(this||k).y=Oe,this||k},_rotateAround:function(F,Me){var Ae=Math.cos(F),Oe=Math.sin(F),Fe=Me.y+Oe*((this||k).x-Me.x)+Ae*((this||k).y-Me.y);return(this||k).x=Me.x+Ae*((this||k).x-Me.x)-Oe*((this||k).y-Me.y),(this||k).y=Fe,this||k},_round:function(){return(this||k).x=Math.round((this||k).x),(this||k).y=Math.round((this||k).y),this||k}},t.convert=function(k){return k instanceof t?k:Array.isArray(k)?new t(k[0],k[1]):k},ko}var Sa=e(j());function $(k,F){if(Array.isArray(k)){if(!Array.isArray(F)||k.length!==F.length)return!1;for(let Me=0;Me<k.length;Me++)if(!$(k[Me],F[Me]))return!1;return!0}if("object"==typeof k&&null!==k&&null!==F){if("object"!=typeof F)return!1;if(Object.keys(k).length!==Object.keys(F).length)return!1;for(const Me in k)if(!$(k[Me],F[Me]))return!1;return!0}return k===F}const Ya=Math.PI/180,rl=180/Math.PI;function X(k){return k*Ya}function Z(k){return k*rl}const sl=[[0,0],[1,0],[1,1],[0,1]];function W(k){if(k<=0)return 0;if(k>=1)return 1;const F=k*k,Me=F*k;return 4*(k<.5?Me:3*(k-F)+Me-.75)}function K(k,F,Me,Ae){const Oe=new wa(k,F,Me,Ae);return function(k){return Oe.solve(k)}}const ml=K(.25,.1,.25,1);function Q(k,F,Me){return Math.min(Me,Math.max(F,k))}function tt(k,F,Me){return(Me=Q((Me-k)/(F-k),0,1))*Me*(3-2*Me)}function et(k,F,Me){const Ae=Me-F,Oe=((k-F)%Ae+Ae)%Ae+F;return Oe===F?Me:Oe}function rt(k,F,Me){if(!k.length)return Me(null,[]);let Ae=k.length;const Oe=new Array(k.length);let Fe=null;k.forEach(((k,je)=>{F(k,((k,F)=>{k&&(Fe=k),Oe[je]=F,0==--Ae&&Me(Fe,Oe)}))}))}function nt(k,...F){for(const Me of F)for(const F in Me)k[F]=Me[F];return k}let Sl=1;function at(){return Sl++}function st(k){return k<=1?1:Math.pow(2,Math.ceil(Math.log(k)/Math.LN2))}function ot(k,F){k.forEach((k=>{F[k]&&(F[k]=F[k].bind(F))}))}function lt(k,F){return-1!==k.indexOf(F,k.length-F.length)}function ut(F,Me,Ae){const Oe={};for(const Ae in F)Oe[Ae]=Me.call(this||k,F[Ae],Ae,F);return Oe}function ct(F,Me,Ae){const Oe={};for(const Ae in F)Me.call(this||k,F[Ae],Ae,F)&&(Oe[Ae]=F[Ae]);return Oe}function ht(k){return Array.isArray(k)?k.map(ht):"object"==typeof k&&k?ut(k,ht):k}const Il={};function ft(k){Il[k]||("undefined"!=typeof console&&console.warn(k),Il[k]=!0)}function dt(k,F,Me){return(Me.y-k.y)*(F.x-k.x)>(F.y-k.y)*(Me.x-k.x)}function mt(k){let F=0;for(let Me,Ae,Oe=0,Fe=k.length,je=Fe-1;Oe<Fe;je=Oe++)Me=k[Oe],Ae=k[je],F+=(Ae.x-Me.x)*(Me.y+Ae.y);return F}function yt([k,F,Me]){const Ae=X(F+90),Oe=X(Me);return{x:k*Math.cos(Ae)*Math.sin(Oe),y:k*Math.sin(Ae)*Math.sin(Oe),z:k*Math.cos(Oe),azimuthal:F,polar:Me}}function gt(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function xt(k){const F={};if(k.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((k,Me,Ae,Oe)=>{const Fe=Ae||Oe;return F[Me]=!Fe||Fe.toLowerCase(),""})),F["max-age"]){const k=parseInt(F["max-age"],10);isNaN(k)?delete F["max-age"]:F["max-age"]=k}return F}let Kl=null;function bt(k,F){return[k[4*F],k[4*F+1],k[4*F+2],k[4*F+3]]}function _t(k,F,Me,Ae){for(;F<Me;){const Oe=F+Me>>1;k[Oe]<Ae?F=Oe+1:Me=Oe}return F}function wt(k,F,Me,Ae){for(;F<Me;){const Oe=F+Me>>1;k[Oe]<=Ae?F=Oe+1:Me=Oe}return F}function Mt(k){return k>0?1/(1.001-k):1+k}function At(k){return k>0?1-1/(1.001-k):-k}const Jl={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Jl.API_URL)return null;try{const k=new URL(Jl.API_URL);return"api.mapbox.cn"===k.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===k.hostname?"https://events.mapbox.com/events/v2":null}catch(k){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function It(k){return Jl.API_URL_REGEX.test(k)}function Pt(k){return Jl.API_SPRITE_REGEX.test(k)}let Ql,ec,tc,cc,uc,jc;function Ct(){return null==Ql&&(Ql=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),Ql}const Gc={now:()=>void 0!==cc?cc:performance.now(),setNow(k){cc=k},restoreNow(){cc=void 0},frame(k){const F=requestAnimationFrame(k);return{cancel:()=>cancelAnimationFrame(F)}},getImageData(k,F=0){const{width:Me,height:Ae}=k;uc||(uc=document.createElement("canvas"));const Oe=uc.getContext("2d",{willReadFrequently:!0});if(!Oe)throw new Error("failed to create canvas 2d context");return(Me>uc.width||Ae>uc.height)&&(uc.width=Me,uc.height=Ae),Oe.clearRect(-F,-F,Me+2*F,Ae+2*F),Oe.drawImage(k,0,0,Me,Ae),Oe.getImageData(-F,-F,Me+2*F,Ae+2*F)},resolveURL:k=>(ec||(ec=document.createElement("a")),ec.href=k,ec.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==tc&&(tc=window.matchMedia("(prefers-reduced-motion: reduce)")),tc.matches)},hasCanvasFingerprintNoise(){if(void 0!==jc)return jc;if(!Ct())return jc=!1,!1;const k=new OffscreenCanvas(85,1),F=k.getContext("2d",{willReadFrequently:!0});let Me=0;for(let Ae=0;Ae<k.width;++Ae)F.fillStyle=`rgba(${Me++},${Me++},${Me++}, 255)`,F.fillRect(Ae,0,1,1);const Ae=F.getImageData(0,0,k.width,k.height);Me=0;for(let k=0;k<Ae.data.length;++k)if(k%4!=3&&Me++!==Ae.data[k])return jc=!0,!0;return jc=!1,!1}};function Lt(k,F){const Me=k.indexOf("?");if(Me<0)return`${k}?${new URLSearchParams(F).toString()}`;const Ae=new URLSearchParams(k.slice(Me));for(const k in F)Ae.set(k,F[k]);return`${k.slice(0,Me)}?${Ae.toString()}`}function Rt(k,F={persistentParams:[]}){const Me=k.indexOf("?");if(Me<0)return k;const Ae=new URLSearchParams,Oe=new URLSearchParams(k.slice(Me));for(const k of F.persistentParams){const F=Oe.get(k);F&&Ae.set(k,F)}const Fe=Ae.toString();return`${k.slice(0,Me)}${Fe.length>0?`?${Fe}`:""}`}const qc="mapbox-tiles";let Hc=500,$c=50;const Wc=["language","worldview","jobid"];let Kc,Jc;function $t(){try{return caches}catch(k){}}function Gt(){const k=$t();k&&null==Kc&&(Kc=k.open(qc))}let Qc=1/0;const eh={supported:!1,testSupport:function(k){!rh&&ih&&(nh?Qt(k):th=k)}};let th,ih,rh=!1,nh=!1;const oh="undefined"!=typeof self?self:{};function Qt(k){const F=k.createTexture();k.bindTexture(k.TEXTURE_2D,F);try{if(k.texImage2D(k.TEXTURE_2D,0,k.RGBA,k.RGBA,k.UNSIGNED_BYTE,ih),k.isContextLost())return;eh.supported=!0}catch(k){}k.deleteTexture(F),rh=!0}oh.document&&(ih=oh.document.createElement("img"),ih.onload=function(){th&&Qt(th),th=null,nh=!0},ih.onerror=function(){rh=!0,th=null},ih.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const sh={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(sh);class ee extends Error{constructor(k,F,Me){401===F&&It(Me)&&(k+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(k),this.status=F,this.url=Me}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const ah=gt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const ne=function(k,F){if(!(/^file:/.test(Me=k.url)||/^file:/.test(ah())&&!/^\w+:/.test(Me))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(k,F){const Me=new AbortController,Ae=new Request(k.url,{method:k.method||"GET",body:k.body,credentials:k.credentials,headers:k.headers,referrer:ah(),referrerPolicy:k.referrerPolicy,signal:Me.signal});let Oe=!1,Fe=!1;const je=(qe=Ae.url).indexOf("sku=")>0&&It(qe);var qe;"json"===k.type&&Ae.headers.set("Accept","application/json");const l=(Me,Oe,qe)=>{if(Fe)return;if(Me&&"SecurityError"!==Me.message&&ft(Me.toString()),Oe&&qe)return u(Oe);const pt=Date.now();fetch(Ae).then((Me=>{if(Me.ok){const k=je?Me.clone():null;return u(Me,k,pt)}return F(new ee(Me.statusText,Me.status,k.url))})).catch((Me=>{"AbortError"!==Me.name&&F(new Error(`${Me.message} ${k.url}`))}))},u=(Me,je,qe)=>{("arrayBuffer"===k.type?Me.arrayBuffer():"json"===k.type?Me.json():Me.text()).then((k=>{Fe||(je&&qe&&function(k,F,Me){if(Gt(),null==Kc)return;const Ae=xt(F.headers.get("Cache-Control")||"");if(Ae["no-store"])return;const Oe={status:F.status,statusText:F.statusText,headers:new Headers};F.headers.forEach(((k,F)=>Oe.headers.set(F,k))),Ae["max-age"]&&Oe.headers.set("Expires",new Date(Me+1e3*Ae["max-age"]).toUTCString());const Fe=Oe.headers.get("Expires");if(!Fe)return;if(new Date(Fe).getTime()-Me<42e4)return;let je=Rt(k.url,{persistentParams:Wc});if(206===F.status){const F=k.headers.get("Range");if(!F)return;Oe.status=200,je=Lt(je,{range:F})}!function(k,F){if(void 0===Jc)try{new Response(new ReadableStream),Jc=!0}catch(k){Jc=!1}Jc?F(k.body):k.blob().then(F)}(F,(k=>{const Me=new Response(200!==(Ae=F.status)&&404!==Ae&&[101,103,204,205,304].includes(Ae)?null:k,Oe);var Ae;Gt(),null!=Kc&&Kc.then((k=>k.put(je,Me))).catch((k=>ft(k.message)))}))}(Ae,je,qe),Oe=!0,F(null,k,Me.headers.get("Cache-Control"),Me.headers.get("Expires")))})).catch((k=>{Fe||F(new Error(k.message))}))};return je?function(k,F){if(Gt(),null==Kc)return F(null);Kc.then((Me=>{let Ae=Rt(k.url,{persistentParams:Wc});const Oe=k.headers.get("Range");Oe&&(Ae=Lt(Ae,{range:Oe})),Me.match(Ae).then((k=>{const Oe=function(k){if(!k)return!1;const F=new Date(k.headers.get("Expires")||0),Me=xt(k.headers.get("Cache-Control")||"");return F>Date.now()&&!Me["no-cache"]}(k);Me.delete(Ae),Oe&&Me.put(Ae,k.clone()),F(null,k,Oe)})).catch(F)})).catch(F)}(Ae,l):l(null,null),{cancel:()=>{Fe=!0,Oe||Me.abort()}}}(k,F);if(gt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",k,F,void 0,!0)}var Me;return function(k,F){const Me=new XMLHttpRequest;Me.open(k.method||"GET",k.url,!0),"arrayBuffer"===k.type&&(Me.responseType="arraybuffer");for(const F in k.headers)Me.setRequestHeader(F,k.headers[F]);return"json"===k.type&&(Me.responseType="text",Me.setRequestHeader("Accept","application/json")),Me.withCredentials="include"===k.credentials,Me.onerror=()=>{F(new Error(Me.statusText))},Me.onload=()=>{if((Me.status>=200&&Me.status<300||0===Me.status)&&null!==Me.response){let Ae=Me.response;if("json"===k.type)try{Ae=JSON.parse(Me.response)}catch(k){return F(k)}F(null,Ae,Me.getResponseHeader("Cache-Control"),Me.getResponseHeader("Expires"))}else F(new ee(Me.statusText,Me.status,k.url))},Me.send(k.body),{cancel:()=>Me.abort()}}(k,F)},ie=function(k,F){return ne(nt(k,{type:"arrayBuffer"}),F)};function ae(k){const F=document.createElement("a");return F.href=k,F.protocol===location.protocol&&F.host===location.host}const lh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let uh,fh;uh=[],fh=0;const ue=function(F,Me){if(eh.supported&&(F.headers||(F.headers={}),F.headers.accept="image/webp,*/*"),fh>=Jl.MAX_PARALLEL_IMAGE_REQUESTS){const Ae={requestParameters:F,callback:Me,cancelled:!1,cancel(){(this||k).cancelled=!0}};return uh.push(Ae),Ae}fh++;let Ae=!1;const n=()=>{if(!Ae)for(Ae=!0,fh--;uh.length&&fh<Jl.MAX_PARALLEL_IMAGE_REQUESTS;){const k=uh.shift(),{requestParameters:F,callback:Me,cancelled:Ae}=k;Ae||(k.cancel=ue(F,Me).cancel)}},Oe=ie(F,((k,F,Ae,Oe)=>{n(),k?Me(k):F&&(self.createImageBitmap?function(k,F){const Me=new Blob([new Uint8Array(k)],{type:"image/png"});createImageBitmap(Me).then((k=>{F(null,k)})).catch((k=>{F(new Error(`Could not load image because of ${k.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(F,((k,F)=>Me(k,F,Ae,Oe))):function(k,F){const Me=new Image;Me.onload=()=>{F(null,Me),URL.revokeObjectURL(Me.src),Me.onload=null,requestAnimationFrame((()=>{Me.src=lh}))},Me.onerror=()=>F(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const Ae=new Blob([new Uint8Array(k)],{type:"image/png"});Me.src=k.byteLength?URL.createObjectURL(Ae):lh}(F,((k,F)=>Me(k,F,Ae,Oe))))}));return{cancel:()=>{Oe.cancel(),n()}}};var vh,Th,Ch,Dh={exports:{}},Rh={exports:{}},Lh={exports:{}},Oh=function(){if(Ch)return Dh.exports;Ch=1;var k=(vh||(vh=1,Rh.exports=function(k,F){var Me,Ae,Oe,Fe,je,qe,pt,vt;for(Ae=k.length-(Me=3&k.length),Oe=F,je=3432918353,qe=461845907,vt=0;vt<Ae;)pt=255&k.charCodeAt(vt)|(255&k.charCodeAt(++vt))<<8|(255&k.charCodeAt(++vt))<<16|(255&k.charCodeAt(++vt))<<24,++vt,Oe=27492+(65535&(Fe=5*(65535&(Oe=(Oe^=pt=(65535&(pt=(pt=(65535&pt)*je+(((pt>>>16)*je&65535)<<16)&4294967295)<<15|pt>>>17))*qe+(((pt>>>16)*qe&65535)<<16)&4294967295)<<13|Oe>>>19))+((5*(Oe>>>16)&65535)<<16)&4294967295))+((58964+(Fe>>>16)&65535)<<16);switch(pt=0,Me){case 3:pt^=(255&k.charCodeAt(vt+2))<<16;case 2:pt^=(255&k.charCodeAt(vt+1))<<8;case 1:Oe^=pt=(65535&(pt=(pt=(65535&(pt^=255&k.charCodeAt(vt)))*je+(((pt>>>16)*je&65535)<<16)&4294967295)<<15|pt>>>17))*qe+(((pt>>>16)*qe&65535)<<16)&4294967295}return Oe^=k.length,Oe=2246822507*(65535&(Oe^=Oe>>>16))+((2246822507*(Oe>>>16)&65535)<<16)&4294967295,Oe=3266489909*(65535&(Oe^=Oe>>>13))+((3266489909*(Oe>>>16)&65535)<<16)&4294967295,(Oe^=Oe>>>16)>>>0}),Rh.exports),F=(Th||(Th=1,Lh.exports=function(k,F){for(var Me,Ae=k.length,Oe=F^Ae,Fe=0;Ae>=4;)Me=1540483477*(65535&(Me=255&k.charCodeAt(Fe)|(255&k.charCodeAt(++Fe))<<8|(255&k.charCodeAt(++Fe))<<16|(255&k.charCodeAt(++Fe))<<24))+((1540483477*(Me>>>16)&65535)<<16),Oe=1540483477*(65535&Oe)+((1540483477*(Oe>>>16)&65535)<<16)^(Me=1540483477*(65535&(Me^=Me>>>24))+((1540483477*(Me>>>16)&65535)<<16)),Ae-=4,++Fe;switch(Ae){case 3:Oe^=(255&k.charCodeAt(Fe+2))<<16;case 2:Oe^=(255&k.charCodeAt(Fe+1))<<8;case 1:Oe=1540483477*(65535&(Oe^=255&k.charCodeAt(Fe)))+((1540483477*(Oe>>>16)&65535)<<16)}return Oe=1540483477*(65535&(Oe^=Oe>>>13))+((1540483477*(Oe>>>16)&65535)<<16),(Oe^=Oe>>>15)>>>0}),Lh.exports);return Dh.exports=k,Dh.exports.murmur3=k,Dh.exports.murmur2=F,Dh.exports}(),Fh=e(Oh);class xe{constructor(k,...F){nt(this,F[0]||{}),this.type=k}}class ve extends xe{constructor(k,F={}){super("error",nt({error:k},F))}}function be(k,F,Me){Me[k]&&-1!==Me[k].indexOf(F)||(Me[k]=Me[k]||[],Me[k].push(F))}function _e(k,F,Me){if(Me&&Me[k]){const Ae=Me[k].indexOf(F);-1!==Ae&&Me[k].splice(Ae,1)}}class we{on(k,F){return this._listeners=this._listeners||{},be(k,F,this._listeners),this}off(k,F){return _e(k,F,this._listeners),_e(k,F,this._oneTimeListeners),this}once(k,F){return F?(this._oneTimeListeners=this._oneTimeListeners||{},be(k,F,this._oneTimeListeners),this):new Promise((F=>this.once(k,F)))}fire(k,F){const Me="string"==typeof k?new xe(k,F):k,Ae=Me.type;if(this.listens(Ae)){Me.target=this;const k=this._listeners&&this._listeners[Ae]?this._listeners[Ae].slice():[];for(const F of k)F.call(this,Me);const F=this._oneTimeListeners&&this._oneTimeListeners[Ae]?this._oneTimeListeners[Ae].slice():[];for(const k of F)_e(Ae,k,this._oneTimeListeners),k.call(this,Me);const Oe=this._eventedParent;Oe&&(nt(Me,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),Oe.fire(Me))}else Me instanceof ve&&console.error(Me.error);return this}listens(k){return!!(this._listeners&&this._listeners[k]&&this._listeners[k].length>0||this._oneTimeListeners&&this._oneTimeListeners[k]&&this._oneTimeListeners[k].length>0||this._eventedParent&&this._eventedParent.listens(k))}setEventedParent(k,F){return this._eventedParent=k,this._eventedParentData=F,this}}var Vh,Zh={},eu=function(){if(Vh)return Zh;Vh=1;var k={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(k){return(k=Math.round(k))<0?0:k>255?255:k}function r(k){return e("%"===k[k.length-1]?parseFloat(k)/100*255:parseInt(k))}function n(k){return(F="%"===k[k.length-1]?parseFloat(k)/100:parseFloat(k))<0?0:F>1?1:F;var F}function i(k,F,Me){return Me<0?Me+=1:Me>1&&(Me-=1),6*Me<1?k+(F-k)*Me*6:2*Me<1?F:3*Me<2?k+(F-k)*(2/3-Me)*6:k}try{Zh.parseCSSColor=function(F){var Me,Ae=F.replace(/ /g,"").toLowerCase();if(Ae in k)return k[Ae].slice();if("#"===Ae[0])return 4===Ae.length?(Me=parseInt(Ae.substr(1),16))>=0&&Me<=4095?[(3840&Me)>>4|(3840&Me)>>8,240&Me|(240&Me)>>4,15&Me|(15&Me)<<4,1]:null:7===Ae.length&&(Me=parseInt(Ae.substr(1),16))>=0&&Me<=16777215?[(16711680&Me)>>16,(65280&Me)>>8,255&Me,1]:null;var Oe=Ae.indexOf("("),Fe=Ae.indexOf(")");if(-1!==Oe&&Fe+1===Ae.length){var je=Ae.substr(0,Oe),qe=Ae.substr(Oe+1,Fe-(Oe+1)).split(","),pt=1;switch(je){case"rgba":if(4!==qe.length)return null;pt=n(qe.pop());case"rgb":return 3!==qe.length?null:[r(qe[0]),r(qe[1]),r(qe[2]),pt];case"hsla":if(4!==qe.length)return null;pt=n(qe.pop());case"hsl":if(3!==qe.length)return null;var vt=(parseFloat(qe[0])%360+360)%360/360,Ut=n(qe[1]),xi=n(qe[2]),vi=xi<=.5?xi*(Ut+1):xi+Ut-xi*Ut,bi=2*xi-vi;return[e(255*i(bi,vi,vt+1/3)),e(255*i(bi,vi,vt)),e(255*i(bi,vi,vt-1/3)),pt];default:return null}}return null}}catch(k){}return Zh}();class Ie{constructor(k,F,Me,Ae=1){this.r=k,this.g=F,this.b=Me,this.a=Ae}static parse(k){if(!k)return;if(k instanceof Ie)return k;if("string"!=typeof k)return;const F=eu.parseCSSColor(k);return F?new Ie(F[0]/255*F[3],F[1]/255*F[3],F[2]/255*F[3],F[3]):void 0}toStringPremultipliedAlpha(){const[k,F,Me,Ae]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(k)},${Math.round(F)},${Math.round(Me)},${Ae})`}toString(){const[k,F,Me,Ae]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*k)},${Math.round(255*F)},${Math.round(255*Me)},${Ae})`}toRenderColor(k){const{r:F,g:Me,b:Ae,a:Oe}=this;return new Pe(k,F,Me,Ae,Oe)}clone(){return new Ie(this.r,this.g,this.b,this.a)}}class Pe{constructor(k,F,Me,Ae,Oe){if(k){const Fe=k.image.height,je=Fe*Fe;F=0===Oe?0:F/Oe*(Fe-1),Me=0===Oe?0:Me/Oe*(Fe-1),Ae=0===Oe?0:Ae/Oe*(Fe-1);const qe=Math.floor(F),pt=Math.floor(Me),vt=Math.floor(Ae),Ut=Math.ceil(F),xi=Math.ceil(Me),vi=Math.ceil(Ae),bi=F-qe,wi=Me-pt,Mi=Ae-vt,pr=k.image.data,Ur=4*(qe+pt*je+vt*Fe),Wr=4*(qe+pt*je+vi*Fe),Jr=4*(qe+xi*je+vt*Fe),Qr=4*(qe+xi*je+vi*Fe),co=4*(Ut+pt*je+vt*Fe),mo=4*(Ut+pt*je+vi*Fe),yo=4*(Ut+xi*je+vt*Fe),To=4*(Ut+xi*je+vi*Fe);if(Ur<0||To>=pr.length)throw new Error("out of range");this.r=ze(ze(ze(pr[Ur],pr[Wr],Mi),ze(pr[Jr],pr[Qr],Mi),wi),ze(ze(pr[co],pr[mo],Mi),ze(pr[yo],pr[To],Mi),wi),bi)/255*Oe,this.g=ze(ze(ze(pr[Ur+1],pr[Wr+1],Mi),ze(pr[Jr+1],pr[Qr+1],Mi),wi),ze(ze(pr[co+1],pr[mo+1],Mi),ze(pr[yo+1],pr[To+1],Mi),wi),bi)/255*Oe,this.b=ze(ze(ze(pr[Ur+2],pr[Wr+2],Mi),ze(pr[Jr+2],pr[Qr+2],Mi),wi),ze(ze(pr[co+2],pr[mo+2],Mi),ze(pr[yo+2],pr[To+2],Mi),wi),bi)/255*Oe,this.a=Oe}else this.r=F,this.g=Me,this.b=Ae,this.a=Oe}toArray(){const{r:k,g:F,b:Me,a:Ae}=this;return 0===Ae?[0,0,0,0]:[255*k/Ae,255*F/Ae,255*Me/Ae,Ae]}toHslaArray(){if(0===this.a)return[0,0,0,0];const{r:k,g:F,b:Me,a:Ae}=this,Oe=Math.min(Math.max(k/Ae,0),1),Fe=Math.min(Math.max(F/Ae,0),1),je=Math.min(Math.max(Me/Ae,0),1),qe=Math.min(Oe,Fe,je),pt=Math.max(Oe,Fe,je),vt=(qe+pt)/2;if(qe===pt)return[0,0,100*vt,Ae];const Ut=pt-qe,xi=vt>.5?Ut/(2-pt-qe):Ut/(pt+qe);let vi=0;return pt===Oe?vi=(Fe-je)/Ut+(Fe<je?6:0):pt===Fe?vi=(je-Oe)/Ut+2:pt===je&&(vi=(Oe-Fe)/Ut+4),vi*=60,[Math.min(Math.max(vi,0),360),Math.min(Math.max(100*xi,0),100),Math.min(Math.max(100*vt,0),100),Ae]}toArray01(){const{r:k,g:F,b:Me,a:Ae}=this;return 0===Ae?[0,0,0,0]:[k/Ae,F/Ae,Me/Ae,Ae]}toArray01Scaled(k){const{r:F,g:Me,b:Ae,a:Oe}=this;return 0===Oe?[0,0,0]:[F/Oe*k,Me/Oe*k,Ae/Oe*k]}toArray01PremultipliedAlpha(){const{r:k,g:F,b:Me,a:Ae}=this;return[k,F,Me,Ae]}toArray01Linear(){const{r:k,g:F,b:Me,a:Ae}=this;return 0===Ae?[0,0,0,0]:[Math.pow(k/Ae,2.2),Math.pow(F/Ae,2.2),Math.pow(Me/Ae,2.2),Ae]}}function ze(k,F,Me){return k*(1-Me)+F*Me}function Ee(k,F,Me){return k.map(((k,Ae)=>ze(k,F[Ae],Me)))}Ie.black=new Ie(0,0,0,1),Ie.white=new Ie(1,1,1,1),Ie.transparent=new Ie(0,0,0,0),Ie.red=new Ie(1,0,0,1),Ie.blue=new Ie(0,0,1,1);var tu=Object.freeze({__proto__:null,array:Ee,color:function(k,F,Me){return new Ie(ze(k.r,F.r,Me),ze(k.g,F.g,Me),ze(k.b,F.b,Me),ze(k.a,F.a,Me))},number:ze});function Te(k,...F){for(const Me of F)for(const F in Me)k[F]=Me[F];return k}class Be extends Error{constructor(k,F){super(F),this.message=F,this.key=k}}class Ve{constructor(k,F=[]){this.parent=k,this.bindings={};for(const[k,Me]of F)this.bindings[k]=Me}concat(k){return new Ve(this,k)}get(k){if(this.bindings[k])return this.bindings[k];if(this.parent)return this.parent.get(k);throw new Error(`${k} not found in scope.`)}has(k){return!!this.bindings[k]||!!this.parent&&this.parent.has(k)}}const ou={kind:"null"},su={kind:"number"},lu={kind:"string"},cu={kind:"boolean"},uu={kind:"color"},bu={kind:"object"},Bu={kind:"value"},Uu={kind:"collator"},ju={kind:"formatted"},qu={kind:"resolvedImage"};function $e(k,F){return{kind:"array",itemType:k,N:F}}function Ge(k){if("array"===k.kind){const F=Ge(k.itemType);return"number"==typeof k.N?`array<${F}, ${k.N}>`:"value"===k.itemType.kind?"array":`array<${F}>`}return k.kind}const Zu=[ou,su,lu,cu,uu,ju,bu,$e(Bu),qu];function Xe(k,F){if("error"===F.kind)return null;if("array"===k.kind){if("array"===F.kind&&(0===F.N&&"value"===F.itemType.kind||!Xe(k.itemType,F.itemType))&&("number"!=typeof k.N||k.N===F.N))return null}else{if(k.kind===F.kind)return null;if("value"===k.kind)for(const k of Zu)if(!Xe(k,F))return null}return`Expected ${Ge(k)} but found ${Ge(F)} instead.`}function Ze(k,F){return F.some((F=>F.kind===k.kind))}function He(k,F){return F.some((F=>"null"===F?null===k:"array"===F?Array.isArray(k):"object"===F?k&&!Array.isArray(k)&&"object"==typeof k:F===typeof k))}class We{constructor(k,F,Me){this.sensitivity=k?F?"variant":"case":F?"accent":"base",this.locale=Me,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(k,F){return this.collator.compare(k,F)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ke{constructor(k,F,Me,Ae,Oe){this.text=k.normalize?k.normalize():k,this.image=F,this.scale=Me,this.fontStack=Ae,this.textColor=Oe}}class Je{constructor(k){this.sections=k}static fromString(k){return new Je([new Ke(k,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((k=>0!==k.text.length||k.image&&k.image.namePrimary))}static factory(k){return k instanceof Je?k:Je.fromString(k)}toString(){return 0===this.sections.length?"":this.sections.map((k=>k.text)).join("")}serialize(){const k=["format"];for(const F of this.sections){if(F.image){k.push(["image",F.image.namePrimary]);continue}k.push(F.text);const Me={};F.fontStack&&(Me["text-font"]=["literal",F.fontStack.split(",")]),F.scale&&(Me["font-scale"]=F.scale),F.textColor&&(Me["text-color"]=["rgba"].concat(F.textColor.toRenderColor(null).toArray())),k.push(Me)}return k}}class Qe{constructor(k,F){if(this.id=k,this.options=F||{params:{}},this.options.transform){const{a:k,b:F,c:Me,d:Ae,e:Oe,f:Fe}=this.options.transform;this.options.transform=new DOMMatrix([k,F,Me,Ae,Oe,Fe])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}static deserializeId(k){return JSON.parse(k).id}static deserializeFromString(k){const F=JSON.parse(k),{a:Me,b:Ae,c:Oe,d:Fe,e:je,f:qe}=F.options.transform;return new DOMMatrix([Me,Ae,Oe,Fe,je,qe]),new Qe(F.id,F.options)}scaleSelf(k){return this.options.transform=this.options.transform.scale(k),this}serialize(){const k={id:this.id};this.options&&(k.options=this.options);const{a:F,b:Me,c:Ae,d:Oe,e:Fe,f:je}=this.options.transform;return k.options.transform={a:F,b:Me,c:Ae,d:Oe,e:Fe,f:je},JSON.stringify(k)}}class tr{constructor(k){this.namePrimary=k.namePrimary,k.nameSecondary&&(this.nameSecondary=k.nameSecondary),k.optionsPrimary&&(this.optionsPrimary=k.optionsPrimary),k.optionsSecondary&&(this.optionsSecondary=k.optionsSecondary),this.available=k.available}toString(){return this.namePrimary&&this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}getPrimary(){return new Qe(this.namePrimary,{params:this.optionsPrimary&&this.optionsPrimary.params||{}})}getSerializedPrimary(){return this.getPrimary().serialize()}getSecondary(){return this.nameSecondary?new Qe(this.nameSecondary,{params:this.optionsSecondary&&this.optionsSecondary.params||{}}):null}static from(k){return"string"==typeof k?tr.build(k):k}static build(k,F,Me,Ae){return k?new tr({namePrimary:k,nameSecondary:F,optionsPrimary:Me,optionsSecondary:Ae,available:!1}):null}}function er(k,F,Me,Ae){return"number"==typeof k&&k>=0&&k<=255&&"number"==typeof F&&F>=0&&F<=255&&"number"==typeof Me&&Me>=0&&Me<=255?void 0===Ae||"number"==typeof Ae&&Ae>=0&&Ae<=1?null:`Invalid rgba value [${[k,F,Me,Ae].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof Ae?[k,F,Me,Ae]:[k,F,Me]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function rr(k){if(null===k)return!0;if("string"==typeof k)return!0;if("boolean"==typeof k)return!0;if("number"==typeof k)return!0;if(k instanceof Ie)return!0;if(k instanceof We)return!0;if(k instanceof Je)return!0;if(k instanceof tr)return!0;if(Array.isArray(k)){for(const F of k)if(!rr(F))return!1;return!0}if("object"==typeof k){for(const F in k)if(!rr(k[F]))return!1;return!0}return!1}function nr(k){if(null===k)return ou;if("string"==typeof k)return lu;if("boolean"==typeof k)return cu;if("number"==typeof k)return su;if(k instanceof Ie)return uu;if(k instanceof We)return Uu;if(k instanceof Je)return ju;if(k instanceof tr)return qu;if(Array.isArray(k)){const F=k.length;let Me;for(const F of k){const k=nr(F);if(Me){if(Me===k)continue;Me=Bu;break}Me=k}return $e(Me||Bu,F)}return bu}function ir(k){const F=typeof k;return null===k?"":"string"===F||"number"===F||"boolean"===F?String(k):k instanceof Ie?k.toStringPremultipliedAlpha():k instanceof Je||k instanceof tr?k.toString():JSON.stringify(k)}class ar{constructor(k,F){this.type=k,this.value=F}static parse(k,F){if(2!==k.length)return F.error(`'literal' expression requires exactly one argument, but found ${k.length-1} instead.`);if(!rr(k[1]))return F.error("invalid value");const Me=k[1];let Ae=nr(Me);const Oe=F.expectedType;return"array"!==Ae.kind||0!==Ae.N||!Oe||"array"!==Oe.kind||"number"==typeof Oe.N&&0!==Oe.N||(Ae=Oe),new ar(Ae,Me)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Ie?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Je?this.value.serialize():this.value}}class sr{constructor(k){this.name="ExpressionEvaluationError",this.message=k}toJSON(){return this.message}}const Hu={string:lu,number:su,boolean:cu,object:bu};class lr{constructor(k,F){this.type=k,this.args=F}static parse(k,F){if(k.length<2)return F.error("Expected at least one argument.");let Me,Ae=1;const Oe=k[0];if("array"===Oe){let Oe,Fe;if(k.length>2){const Me=k[1];if("string"!=typeof Me||!(Me in Hu)||"object"===Me)return F.error('The item type argument of "array" must be one of string, number, boolean',1);Oe=Hu[Me],Ae++}else Oe=Bu;if(k.length>3){if(null!==k[2]&&("number"!=typeof k[2]||k[2]<0||k[2]!==Math.floor(k[2])))return F.error('The length argument to "array" must be a positive integer literal',2);Fe=k[2],Ae++}Me=$e(Oe,Fe)}else Me=Hu[Oe];const Fe=[];for(;Ae<k.length;Ae++){const Me=F.parse(k[Ae],Ae,Bu);if(!Me)return null;Fe.push(Me)}return new lr(Me,Fe)}evaluate(k){for(let F=0;F<this.args.length;F++){const Me=this.args[F].evaluate(k);if(!Xe(this.type,nr(Me)))return Me;if(F===this.args.length-1)throw new sr(`The expression ${JSON.stringify(this.args[F].serialize())} evaluated to ${Ge(nr(Me))} but was expected to be of type ${Ge(this.type)}.`)}return null}eachChild(k){this.args.forEach(k)}outputDefined(){return this.args.every((k=>k.outputDefined()))}serialize(){const k=this.type,F=[k.kind];if("array"===k.kind){const Me=k.itemType;if("string"===Me.kind||"number"===Me.kind||"boolean"===Me.kind){F.push(Me.kind);const Ae=k.N;("number"==typeof Ae||this.args.length>1)&&F.push(Ae)}}return F.concat(this.args.map((k=>k.serialize())))}}class ur{constructor(k){this.type=ju,this.sections=k}static parse(k,F){if(k.length<2)return F.error("Expected at least one argument.");const Me=k[1];if(!Array.isArray(Me)&&"object"==typeof Me)return F.error("First argument must be an image or text section.");const Ae=[];let Oe=!1;for(let Me=1;Me<=k.length-1;++Me){const Fe=k[Me];if(Oe&&"object"==typeof Fe&&!Array.isArray(Fe)){Oe=!1;let k=null;if(Fe["font-scale"]&&(k=F.parseObjectValue(Fe["font-scale"],Me,"font-scale",su),!k))return null;let je=null;if(Fe["text-font"]&&(je=F.parseObjectValue(Fe["text-font"],Me,"text-font",$e(lu)),!je))return null;let qe=null;if(Fe["text-color"]&&(qe=F.parseObjectValue(Fe["text-color"],Me,"text-color",uu),!qe))return null;const pt=Ae[Ae.length-1];pt.scale=k,pt.font=je,pt.textColor=qe}else{const Fe=F.parse(k[Me],Me,Bu);if(!Fe)return null;const je=Fe.type.kind;if("string"!==je&&"value"!==je&&"null"!==je&&"resolvedImage"!==je)return F.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");Oe=!0,Ae.push({content:Fe,scale:null,font:null,textColor:null})}}return new ur(Ae)}evaluate(k){return new Je(this.sections.map((F=>{const Me=F.content.evaluate(k);return nr(Me)===qu?new Ke("",Me,null,null,null):new Ke(ir(Me),null,F.scale?F.scale.evaluate(k):null,F.font?F.font.evaluate(k).join(","):null,F.textColor?F.textColor.evaluate(k):null)})))}eachChild(k){for(const F of this.sections)k(F.content),F.scale&&k(F.scale),F.font&&k(F.font),F.textColor&&k(F.textColor)}outputDefined(){return!1}serialize(){const k=["format"];for(const F of this.sections){k.push(F.content.serialize());const Me={};F.scale&&(Me["font-scale"]=F.scale.serialize()),F.font&&(Me["text-font"]=F.font.serialize()),F.textColor&&(Me["text-color"]=F.textColor.serialize()),k.push(Me)}return k}}class cr{constructor(k,F,Me,Ae){this._imageWarnHistory={},this.type=qu,this.inputPrimary=k,this.inputSecondary=F,this.inputPrimaryParams=Me,this.inputSecondaryParams=Ae}static parse(k,F){if(k.length<2)return F.error("Expected two or more arguments.");let Me=1;const Ae=[];function i(){if(Me<k.length){const Oe=F.parse(k[Me],Me++,lu);return Oe?(Ae.push({image:Oe,options:void 0}),!0):(F.error(Ae.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function a(){if(Me<k.length){if(null===(Oe=k[Me])||"object"!=typeof Oe||Array.isArray(Oe))return!0;const Fe=k[Me].params,je=F.concat(Me);if(!Fe)return Me++,!0;if("object"!=typeof Fe||Fe.constructor!==Object)return je.error('Image options "params" should be an object'),!1;const qe={},pt=je.concat(void 0,"params");for(const k in Fe){if(!k)return pt.error("Image parameter name should be non-empty"),!1;const F=pt.concat(void 0,k).parse(Fe[k],void 0,uu,void 0,{typeAnnotation:"coerce"});if(!F)return!1;qe[k]=F}return Ae[Ae.length-1].options=qe,Me++,!0}var Oe;return!0}for(let k=0;k<2;k++)if(!i()||!a())return;return new cr(Ae[0].image,Ae[1]?Ae[1].image:void 0,Ae[0].options,Ae[1]?Ae[1].options:void 0)}evaluateParams(k,F){const Me={};if(F){for(const Ae in F)if(F[Ae])try{const Oe=F[Ae].evaluate(k),Fe=`Ignoring image parameter "${Ae}" with semi-transparent color ${Oe.toString()}`;if(1!==Oe.a){this._imageWarnHistory[Fe]||(console.warn(Fe),this._imageWarnHistory[Fe]=!0);continue}Me[Ae]=Oe}catch(k){continue}if(0!==Object.keys(Me).length)return{params:Me}}}evaluate(k){const F=tr.build(this.inputPrimary.evaluate(k),this.inputSecondary?this.inputSecondary.evaluate(k):void 0,this.inputPrimaryParams?this.evaluateParams(k,this.inputPrimaryParams):void 0,this.inputSecondaryParams?this.evaluateParams(k,this.inputSecondaryParams):void 0);return F&&k.availableImages&&(F.available=k.availableImages.indexOf(F.namePrimary)>-1,F.nameSecondary&&F.available&&k.availableImages&&(F.available=k.availableImages.indexOf(F.nameSecondary)>-1)),F}eachChild(k){if(k(this.inputPrimary),this.inputPrimaryParams)for(const F in this.inputPrimaryParams)this.inputPrimaryParams[F]&&k(this.inputPrimaryParams[F]);if(this.inputSecondary&&(k(this.inputSecondary),this.inputSecondaryParams))for(const F in this.inputSecondaryParams)this.inputSecondaryParams[F]&&k(this.inputSecondaryParams[F])}outputDefined(){return!1}serializeParams(k){const F={};if(k){for(const Me in k)k[Me]&&(F[Me]=k[Me].serialize());return{params:F}}}serialize(){const k=["image",this.inputPrimary.serialize()];return this.inputPrimaryParams&&k.push(this.serializeParams(this.inputPrimaryParams)),this.inputSecondary&&(k.push(this.inputSecondary.serialize()),this.inputSecondaryParams&&k.push(this.serializeParams(this.inputSecondaryParams))),k}}function hr(k){return k instanceof Number?"number":k instanceof String?"string":k instanceof Boolean?"boolean":Array.isArray(k)?"array":null===k?"null":typeof k}const $u={"to-boolean":cu,"to-color":uu,"to-number":su,"to-string":lu};class fr{constructor(k,F){this.type=k,this.args=F}static parse(k,F){if(k.length<2)return F.error("Expected at least one argument.");const Me=k[0],Ae=[];let Oe=ou;if("to-array"===Me){if(!Array.isArray(k[1]))return null;const Me=k[1].length;if(F.expectedType){if("array"!==F.expectedType.kind)return F.error(`Expected ${F.expectedType.kind} but found array.`);Oe=$e(F.expectedType.itemType,Me)}else{if(!(Me>0&&rr(k[1][0])))return null;Oe=$e(nr(k[1][0]),Me)}for(let Fe=0;Fe<Me;Fe++){const Me=k[1][Fe];let je;if("array"===hr(Me))je=F.parse(Me,void 0,Oe.itemType);else{const k=hr(Me);if(k!==Oe.itemType.kind)return F.error(`Expected ${Oe.itemType.kind} but found ${k}.`);je=F.registry.literal.parse(["literal",void 0===Me?null:Me],F)}if(!je)return null;Ae.push(je)}}else{if(("to-boolean"===Me||"to-string"===Me)&&2!==k.length)return F.error("Expected one argument.");Oe=$u[Me];for(let Me=1;Me<k.length;Me++){const Oe=F.parse(k[Me],Me,Bu);if(!Oe)return null;Ae.push(Oe)}}return new fr(Oe,Ae)}evaluate(k){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(k));if("color"===this.type.kind){let F,Me;for(const Ae of this.args){if(F=Ae.evaluate(k),Me=null,F instanceof Ie)return F;if("string"==typeof F){const Me=k.parseColor(F);if(Me)return Me}else if(Array.isArray(F)&&(Me=F.length<3||F.length>4?`Invalid rbga value ${JSON.stringify(F)}: expected an array containing either three or four numeric values.`:er(F[0],F[1],F[2],F[3]),!Me))return new Ie(F[0]/255,F[1]/255,F[2]/255,F[3])}throw new sr(Me||`Could not parse color from value '${"string"==typeof F?F:String(JSON.stringify(F))}'`)}if("number"===this.type.kind){let F=null;for(const Me of this.args){if(F=Me.evaluate(k),null===F)return 0;const Ae=Number(F);if(!isNaN(Ae))return Ae}throw new sr(`Could not convert ${JSON.stringify(F)} to number.`)}return"formatted"===this.type.kind?Je.fromString(ir(this.args[0].evaluate(k))):"resolvedImage"===this.type.kind?tr.build(ir(this.args[0].evaluate(k))):"array"===this.type.kind?this.args.map((F=>F.evaluate(k))):ir(this.args[0].evaluate(k))}eachChild(k){this.args.forEach(k)}outputDefined(){return this.args.every((k=>k.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new ur([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new cr(this.args[0]).serialize();const k="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((F=>{k.push(F.serialize())})),k}}const Ju=["Unknown","Point","LineString","Polygon"];class mr{constructor(k,F){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=k,this.options=F}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Ju[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(k){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const k=this.featureDistanceData.center,F=this.featureDistanceData.scale,{x:Me,y:Ae}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(Me*F-k[0])+this.featureDistanceData.bearing[1]*(Ae*F-k[1])}return 0}parseColor(k){let F=this._parseColorCache[k];return F||(F=this._parseColorCache[k]=Ie.parse(k)),F}getConfig(k){return this.options?this.options.get(k):null}}class yr{constructor(k,F,Me,Ae,Oe){this.name=k,this.type=F,this._evaluate=Me,this.args=Ae,this._overloadIndex=Oe}evaluate(k){if(!this._evaluate){const k=yr.definitions[this.name];this._evaluate=Array.isArray(k)?k[2]:k.overloads[this._overloadIndex][1]}return this._evaluate(k,this.args)}eachChild(k){this.args.forEach(k)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((k=>k.serialize())))}static parse(k,F){const Me=k[0],Ae=yr.definitions[Me];if(!Ae)return F.error(`Unknown expression "${Me}". If you wanted a literal array, use ["literal", [...]].`,0);const Oe=Array.isArray(Ae)?Ae[0]:Ae.type,Fe=Array.isArray(Ae)?[[Ae[1],Ae[2]]]:Ae.overloads,je=[];let qe=null,pt=-1;for(const[Ae,vt]of Fe){if(Array.isArray(Ae)&&Ae.length!==k.length-1)continue;je.push(Ae),pt++,qe=new Cd(F.registry,F.path,null,F.scope,void 0,F._scope,F.options);const Fe=[];let Ut=!1;for(let F=1;F<k.length;F++){const Me=k[F],Oe=Array.isArray(Ae)?Ae[F-1]:Ae.type,je=qe.parse(Me,1+Fe.length,Oe);if(!je){Ut=!0;break}Fe.push(je)}if(!Ut)if(Array.isArray(Ae)&&Ae.length!==Fe.length)qe.error(`Expected ${Ae.length} arguments, but found ${Fe.length} instead.`);else{for(let k=0;k<Fe.length;k++){const F=Array.isArray(Ae)?Ae[k]:Ae.type,Me=Fe[k];qe.concat(k+1).checkSubtype(F,Me.type)}if(0===qe.errors.length)return new yr(Me,Oe,vt,Fe,pt)}}if(1===je.length)F.errors.push(...qe.errors);else{const Me=(je.length?je:Fe.map((([k])=>k))).map(gr).join(" | "),Ae=[];for(let Me=1;Me<k.length;Me++){const Oe=F.parse(k[Me],1+Ae.length);if(!Oe)return null;Ae.push(Ge(Oe.type))}F.error(`Expected arguments of type ${Me}, but found (${Ae.join(", ")}) instead.`)}return null}static register(k,F){yr.definitions=F;for(const Me in F)k[Me]=yr}}function gr(k){return Array.isArray(k)?`(${k.map(Ge).join(", ")})`:`(${Ge(k.type)}...)`}class xr{constructor(k,F,Me){this.type=Uu,this.locale=Me,this.caseSensitive=k,this.diacriticSensitive=F}static parse(k,F){if(2!==k.length)return F.error("Expected one argument.");const Me=k[1];if("object"!=typeof Me||Array.isArray(Me))return F.error("Collator options argument must be an object.");const Ae=void 0===Me["case-sensitive"]?F.parse(!1,1,cu):F.parseObjectValue(Me["case-sensitive"],1,"case-sensitive",cu);if(!Ae)return null;const Oe=void 0===Me["diacritic-sensitive"]?F.parse(!1,1,cu):F.parseObjectValue(Me["diacritic-sensitive"],1,"diacritic-sensitive",cu);if(!Oe)return null;let Fe=null;return Me.locale&&(Fe=F.parseObjectValue(Me.locale,1,"locale",lu),!Fe)?null:new xr(Ae,Oe,Fe)}evaluate(k){return new We(this.caseSensitive.evaluate(k),this.diacriticSensitive.evaluate(k),this.locale?this.locale.evaluate(k):null)}eachChild(k){k(this.caseSensitive),k(this.diacriticSensitive),this.locale&&k(this.locale)}outputDefined(){return!1}serialize(){const k={};return k["case-sensitive"]=this.caseSensitive.serialize(),k["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(k.locale=this.locale.serialize()),["collator",k]}}function vr(k,F,Me=0,Ae=k.length-1,Oe=_r){for(;Ae>Me;){if(Ae-Me>600){const Fe=Ae-Me+1,je=F-Me+1,qe=Math.log(Fe),pt=.5*Math.exp(2*qe/3),vt=.5*Math.sqrt(qe*pt*(Fe-pt)/Fe)*(je-Fe/2<0?-1:1);vr(k,F,Math.max(Me,Math.floor(F-je*pt/Fe+vt)),Math.min(Ae,Math.floor(F+(Fe-je)*pt/Fe+vt)),Oe)}const Fe=k[F];let je=Me,qe=Ae;for(br(k,Me,F),Oe(k[Ae],Fe)>0&&br(k,Me,Ae);je<qe;){for(br(k,je,qe),je++,qe--;Oe(k[je],Fe)<0;)je++;for(;Oe(k[qe],Fe)>0;)qe--}0===Oe(k[Me],Fe)?br(k,Me,qe):(qe++,br(k,qe,Ae)),qe<=F&&(Me=qe+1),F<=qe&&(Ae=qe-1)}}function br(k,F,Me){const Ae=k[F];k[F]=k[Me],k[Me]=Ae}function _r(k,F){return k<F?-1:k>F?1:0}function wr(k){let F=0;for(let Me,Ae,Oe=0,Fe=k.length,je=Fe-1;Oe<Fe;je=Oe++)Me=k[Oe],Ae=k[je],F+=(Ae.x-Me.x)*(Me.y+Ae.y);return F}function Mr(k,F){k[0]=Math.min(k[0],F[0]),k[1]=Math.min(k[1],F[1]),k[2]=Math.max(k[2],F[0]),k[3]=Math.max(k[3],F[1])}function Ar(k,F){return!(k[0]<=F[0]||k[2]>=F[2]||k[1]<=F[1]||k[3]>=F[3])}function Sr(k,F,Me){const Ae=k[0]-F[0],Oe=k[1]-F[1],Fe=k[0]-Me[0],je=k[1]-Me[1];return Ae*je-Fe*Oe==0&&Ae*Fe<=0&&Oe*je<=0}function Ir(k,F,Me=!1){let Ae=!1;for(let qe=0,pt=F.length;qe<pt;qe++){const pt=F[qe];for(let F=0,qe=pt.length,vt=qe-1;F<qe;vt=F++){const qe=pt[vt],Ut=pt[F];if(Sr(k,qe,Ut))return Me;(Fe=qe)[1]>(Oe=k)[1]!=(je=Ut)[1]>Oe[1]&&Oe[0]<(je[0]-Fe[0])*(Oe[1]-Fe[1])/(je[1]-Fe[1])+Fe[0]&&(Ae=!Ae)}}var Oe,Fe,je;return Ae}function Pr(k,F,Me,Ae){const Oe=Ae[0]-Me[0],Fe=Ae[1]-Me[1],je=(k[0]-Me[0])*Fe-Oe*(k[1]-Me[1]),qe=(F[0]-Me[0])*Fe-Oe*(F[1]-Me[1]);return je>0&&qe<0||je<0&&qe>0}function zr(k,F,Me,Ae){return 0!=(Oe=[Ae[0]-Me[0],Ae[1]-Me[1]])[0]*(Fe=[F[0]-k[0],F[1]-k[1]])[1]-Oe[1]*Fe[0]&&!(!Pr(k,F,Me,Ae)||!Pr(Me,Ae,k,F));var Oe,Fe}const Qu=8192;function kr(k,F){const Me=(180+k[0])/360,Ae=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+k[1]*Math.PI/360)))/360,Oe=Math.pow(2,F.z);return[Math.round(Me*Oe*Qu),Math.round(Ae*Oe*Qu)]}function Tr(k,F){for(let Me=0;Me<F.length;Me++)if(Ir(k,F[Me]))return!0;return!1}function Br(k,F,Me){for(const Ae of Me)for(let Me=0,Oe=Ae.length,Fe=Oe-1;Me<Oe;Fe=Me++)if(zr(k,F,Ae[Fe],Ae[Me]))return!0;return!1}function Vr(k,F){for(let Me=0;Me<k.length;++Me)if(!Ir(k[Me],F))return!1;for(let Me=0;Me<k.length-1;++Me)if(Br(k[Me],k[Me+1],F))return!1;return!0}function Cr(k,F){for(let Me=0;Me<F.length;Me++)if(Vr(k,F[Me]))return!0;return!1}function Dr(k,F,Me){const Ae=[];for(let Oe=0;Oe<k.length;Oe++){const Fe=[];for(let Ae=0;Ae<k[Oe].length;Ae++){const je=kr(k[Oe][Ae],Me);Mr(F,je),Fe.push(je)}Ae.push(Fe)}return Ae}function Lr(k,F,Me){const Ae=[];for(let Oe=0;Oe<k.length;Oe++){const Fe=Dr(k[Oe],F,Me);Ae.push(Fe)}return Ae}function Rr(k,F,Me,Ae){if(k[0]<Me[0]||k[0]>Me[2]){const F=.5*Ae;let Oe=k[0]-Me[0]>F?-Ae:Me[0]-k[0]>F?Ae:0;0===Oe&&(Oe=k[0]-Me[2]>F?-Ae:Me[2]-k[0]>F?Ae:0),k[0]+=Oe}Mr(F,k)}function Fr(k,F,Me,Ae){const Oe=Math.pow(2,Ae.z)*Qu,Fe=[Ae.x*Qu,Ae.y*Qu],je=[];if(!k)return je;for(const Ae of k)for(const k of Ae){const Ae=[k.x+Fe[0],k.y+Fe[1]];Rr(Ae,F,Me,Oe),je.push(Ae)}return je}function Or(k,F,Me,Ae){const Oe=Math.pow(2,Ae.z)*Qu,Fe=[Ae.x*Qu,Ae.y*Qu],je=[];if(!k)return je;for(const Me of k){const k=[];for(const Ae of Me){const Me=[Ae.x+Fe[0],Ae.y+Fe[1]];Mr(F,Me),k.push(Me)}je.push(k)}if(F[2]-F[0]<=Oe/2){(qe=F)[0]=qe[1]=1/0,qe[2]=qe[3]=-1/0;for(const k of je)for(const Ae of k)Rr(Ae,F,Me,Oe)}var qe;return je}class Nr{constructor(k,F){this.type=cu,this.geojson=k,this.geometries=F}static parse(k,F){if(2!==k.length)return F.error(`'within' expression requires exactly one argument, but found ${k.length-1} instead.`);if(rr(k[1])){const F=k[1];if("FeatureCollection"===F.type)for(let k=0;k<F.features.length;++k){const Me=F.features[k].geometry.type;if("Polygon"===Me||"MultiPolygon"===Me)return new Nr(F,F.features[k].geometry)}else if("Feature"===F.type){const k=F.geometry.type;if("Polygon"===k||"MultiPolygon"===k)return new Nr(F,F.geometry)}else if("Polygon"===F.type||"MultiPolygon"===F.type)return new Nr(F,F)}return F.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(k){if(null!=k.geometry()&&null!=k.canonicalID()){if("Point"===k.geometryType())return function(k,F){const Me=[1/0,1/0,-1/0,-1/0],Ae=[1/0,1/0,-1/0,-1/0],Oe=k.canonicalID();if(!Oe)return!1;if("Polygon"===F.type){const Fe=Dr(F.coordinates,Ae,Oe),je=Fr(k.geometry(),Me,Ae,Oe);if(!Ar(Me,Ae))return!1;for(const k of je)if(!Ir(k,Fe))return!1}if("MultiPolygon"===F.type){const Fe=Lr(F.coordinates,Ae,Oe),je=Fr(k.geometry(),Me,Ae,Oe);if(!Ar(Me,Ae))return!1;for(const k of je)if(!Tr(k,Fe))return!1}return!0}(k,this.geometries);if("LineString"===k.geometryType())return function(k,F){const Me=[1/0,1/0,-1/0,-1/0],Ae=[1/0,1/0,-1/0,-1/0],Oe=k.canonicalID();if(!Oe)return!1;if("Polygon"===F.type){const Fe=Dr(F.coordinates,Ae,Oe),je=Or(k.geometry(),Me,Ae,Oe);if(!Ar(Me,Ae))return!1;for(const k of je)if(!Vr(k,Fe))return!1}if("MultiPolygon"===F.type){const Fe=Lr(F.coordinates,Ae,Oe),je=Or(k.geometry(),Me,Ae,Oe);if(!Ar(Me,Ae))return!1;for(const k of je)if(!Cr(k,Fe))return!1}return!0}(k,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const cd={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},ud=1/298.257223563,dd=ud*(2-ud),md=Math.PI/180;class Gr{static fromTile(k,F,Me){const Ae=Math.PI*(1-2*(k+.5)/Math.pow(2,F)),Oe=Math.atan(.5*(Math.exp(Ae)-Math.exp(-Ae)))/md;return new Gr(Oe,Me)}static get units(){return cd}constructor(k,F){if(void 0===k)throw new Error("No latitude given.");if(F&&!cd[F])throw new Error(`Unknown unit ${F}. Use one of: ${Object.keys(cd).join(", ")}`);const Me=6378.137*md*(F?cd[F]:1),Ae=Math.cos(k*md),Oe=1/(1-dd*(1-Ae*Ae)),Fe=Math.sqrt(Oe);this.kx=Me*Fe*Ae,this.ky=Me*Fe*Oe*(1-dd)}distance(k,F){const Me=Zr(k[0]-F[0])*this.kx,Ae=(k[1]-F[1])*this.ky;return Math.sqrt(Me*Me+Ae*Ae)}bearing(k,F){const Me=Zr(F[0]-k[0])*this.kx;return Math.atan2(Me,(F[1]-k[1])*this.ky)/md}destination(k,F,Me){const Ae=Me*md;return this.offset(k,Math.sin(Ae)*F,Math.cos(Ae)*F)}offset(k,F,Me){return[k[0]+F/this.kx,k[1]+Me/this.ky]}lineDistance(k){let F=0;for(let Me=0;Me<k.length-1;Me++)F+=this.distance(k[Me],k[Me+1]);return F}area(k){let F=0;for(let Me=0;Me<k.length;Me++){const Ae=k[Me];for(let k=0,Oe=Ae.length,Fe=Oe-1;k<Oe;Fe=k++)F+=Zr(Ae[k][0]-Ae[Fe][0])*(Ae[k][1]+Ae[Fe][1])*(Me?-1:1)}return Math.abs(F)/2*this.kx*this.ky}along(k,F){let Me=0;if(F<=0)return k[0];for(let Ae=0;Ae<k.length-1;Ae++){const Oe=k[Ae],Fe=k[Ae+1],je=this.distance(Oe,Fe);if(Me+=je,Me>F)return Xr(Oe,Fe,(F-(Me-je))/je)}return k[k.length-1]}pointToSegmentDistance(k,F,Me){let[Ae,Oe]=F,Fe=Zr(Me[0]-Ae)*this.kx,je=(Me[1]-Oe)*this.ky;if(0!==Fe||0!==je){const F=(Zr(k[0]-Ae)*this.kx*Fe+(k[1]-Oe)*this.ky*je)/(Fe*Fe+je*je);F>1?(Ae=Me[0],Oe=Me[1]):F>0&&(Ae+=Fe/this.kx*F,Oe+=je/this.ky*F)}return Fe=Zr(k[0]-Ae)*this.kx,je=(k[1]-Oe)*this.ky,Math.sqrt(Fe*Fe+je*je)}pointOnLine(k,F){let Me=1/0,Ae=k[0][0],Oe=k[0][1],Fe=0,je=0;for(let qe=0;qe<k.length-1;qe++){let pt=k[qe][0],vt=k[qe][1],Ut=Zr(k[qe+1][0]-pt)*this.kx,xi=(k[qe+1][1]-vt)*this.ky,vi=0;0===Ut&&0===xi||(vi=(Zr(F[0]-pt)*this.kx*Ut+(F[1]-vt)*this.ky*xi)/(Ut*Ut+xi*xi),vi>1?(pt=k[qe+1][0],vt=k[qe+1][1]):vi>0&&(pt+=Ut/this.kx*vi,vt+=xi/this.ky*vi)),Ut=Zr(F[0]-pt)*this.kx,xi=(F[1]-vt)*this.ky;const bi=Ut*Ut+xi*xi;bi<Me&&(Me=bi,Ae=pt,Oe=vt,Fe=qe,je=vi)}return{point:[Ae,Oe],index:Fe,t:Math.max(0,Math.min(1,je))}}lineSlice(k,F,Me){let Ae=this.pointOnLine(Me,k),Oe=this.pointOnLine(Me,F);if(Ae.index>Oe.index||Ae.index===Oe.index&&Ae.t>Oe.t){const k=Ae;Ae=Oe,Oe=k}const Fe=[Ae.point],je=Ae.index+1,qe=Oe.index;!Yr(Me[je],Fe[0])&&je<=qe&&Fe.push(Me[je]);for(let k=je+1;k<=qe;k++)Fe.push(Me[k]);return Yr(Me[qe],Oe.point)||Fe.push(Oe.point),Fe}lineSliceAlong(k,F,Me){let Ae=0;const Oe=[];for(let Fe=0;Fe<Me.length-1;Fe++){const je=Me[Fe],qe=Me[Fe+1],pt=this.distance(je,qe);if(Ae+=pt,Ae>k&&0===Oe.length&&Oe.push(Xr(je,qe,(k-(Ae-pt))/pt)),Ae>=F)return Oe.push(Xr(je,qe,(F-(Ae-pt))/pt)),Oe;Ae>k&&Oe.push(qe)}return Oe}bufferPoint(k,F){const Me=F/this.ky,Ae=F/this.kx;return[k[0]-Ae,k[1]-Me,k[0]+Ae,k[1]+Me]}bufferBBox(k,F){const Me=F/this.ky,Ae=F/this.kx;return[k[0]-Ae,k[1]-Me,k[2]+Ae,k[3]+Me]}insideBBox(k,F){return Zr(k[0]-F[0])>=0&&Zr(k[0]-F[2])<=0&&k[1]>=F[1]&&k[1]<=F[3]}}function Yr(k,F){return k[0]===F[0]&&k[1]===F[1]}function Xr(k,F,Me){const Ae=Zr(F[0]-k[0]);return[k[0]+Ae*Me,k[1]+(F[1]-k[1])*Me]}function Zr(k){for(;k<-180;)k+=360;for(;k>180;)k-=360;return k}class Hr{constructor(k=[],F=((k,F)=>k<F?-1:k>F?1:0)){if(this.data=k,this.length=this.data.length,this.compare=F,this.length>0)for(let k=(this.length>>1)-1;k>=0;k--)this._down(k)}push(k){this.data.push(k),this._up(this.length++)}pop(){if(0===this.length)return;const k=this.data[0],F=this.data.pop();return--this.length>0&&(this.data[0]=F,this._down(0)),k}peek(){return this.data[0]}_up(k){const{data:F,compare:Me}=this,Ae=F[k];for(;k>0;){const Oe=k-1>>1,Fe=F[Oe];if(Me(Ae,Fe)>=0)break;F[k]=Fe,k=Oe}F[k]=Ae}_down(k){const{data:F,compare:Me}=this,Ae=this.length>>1,Oe=F[k];for(;k<Ae;){let Ae=1+(k<<1);const Fe=Ae+1;if(Fe<this.length&&Me(F[Fe],F[Ae])<0&&(Ae=Fe),Me(F[Ae],Oe)>=0)break;F[k]=F[Ae],k=Ae}F[k]=Oe}}var Td=8192;function Kr(k,F){return F.dist-k.dist}const Ed=100,Ad=50;function tn(k){const F=[1/0,1/0,-1/0,-1/0];if(F.length!==k.length)return!1;for(let Me=0;Me<F.length;Me++)if(F[Me]!==k[Me])return!1;return!0}function en(k){return k[1]-k[0]+1}function rn(k,F){const Me=k[1]>=k[0]&&k[1]<F;return Me||console.warn("Distance Expression: Index is out of range"),Me}function nn(k,F){if(k[0]>k[1])return[null,null];const Me=en(k);if(F){if(2===Me)return[k,null];const F=Math.floor(Me/2);return[[k[0],k[0]+F],[k[0]+F,k[1]]]}{if(1===Me)return[k,null];const F=Math.floor(Me/2)-1;return[[k[0],k[0]+F],[k[0]+F+1,k[1]]]}}function an(k,F){const Me=[1/0,1/0,-1/0,-1/0];if(!rn(F,k.length))return Me;for(let Ae=F[0];Ae<=F[1];++Ae)Mr(Me,k[Ae]);return Me}function sn(k){const F=[1/0,1/0,-1/0,-1/0];for(let Me=0;Me<k.length;++Me)for(let Ae=0;Ae<k[Me].length;++Ae)Mr(F,k[Me][Ae]);return F}function on(k,F,Me){if(tn(k)||tn(F))return NaN;let Ae=0,Oe=0;return k[2]<F[0]&&(Ae=F[0]-k[2]),k[0]>F[2]&&(Ae=k[0]-F[2]),k[1]>F[3]&&(Oe=k[1]-F[3]),k[3]<F[1]&&(Oe=F[1]-k[3]),Me.distance([0,0],[Ae,Oe])}function ln(k){return 360*k-180}function un(k){return 360/Math.PI*Math.atan(Math.exp((180-360*k)*Math.PI/180))-90}function cn(k,F){const Me=Math.pow(2,F.z),Ae=(k.y/Td+F.y)/Me;return[ln((k.x/Td+F.x)/Me),un(Ae)]}function hn(k,F){const Me=[];for(let Ae=0;Ae<k.length;++Ae)Me.push(cn(k[Ae],F));return Me}function pn(k,F,Me){const Ae=Me.pointOnLine(F,k).point;return Me.distance(k,Ae)}function fn(k,F,Me,Ae,Oe){const Fe=Me.slice(Ae[0],Ae[1]+1);let je=1/0;for(let Me=F[0];Me<=F[1];++Me)if(0===(je=Math.min(je,pn(k[Me],Fe,Oe))))return 0;return je}function dn(k,F,Me,Ae,Oe){const Fe=Math.min(Oe.pointToSegmentDistance(k,Me,Ae),Oe.pointToSegmentDistance(F,Me,Ae)),je=Math.min(Oe.pointToSegmentDistance(Me,k,F),Oe.pointToSegmentDistance(Ae,k,F));return Math.min(Fe,je)}function mn(k,F,Me,Ae,Oe){if(!rn(F,k.length)||!rn(Ae,Me.length))return NaN;let Fe=1/0;for(let je=F[0];je<F[1];++je)for(let F=Ae[0];F<Ae[1];++F){if(zr(k[je],k[je+1],Me[F],Me[F+1]))return 0;Fe=Math.min(Fe,dn(k[je],k[je+1],Me[F],Me[F+1],Oe))}return Fe}function yn(k,F,Me,Ae,Oe){if(!rn(F,k.length)||!rn(Ae,Me.length))return NaN;let Fe=1/0;for(let je=F[0];je<=F[1];++je)for(let F=Ae[0];F<=Ae[1];++F)if(0===(Fe=Math.min(Fe,Oe.distance(k[je],Me[F]))))return Fe;return Fe}function gn(k,F,Me){if(Ir(k,F,!0))return 0;let Ae=1/0;for(const Oe of F){const F=Oe.length;if(F<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(Oe[0]!==Oe[F-1]&&0===(Ae=Math.min(Ae,Me.pointToSegmentDistance(k,Oe[F-1],Oe[0]))))return Ae;if(0===(Ae=Math.min(Ae,pn(k,Oe,Me))))return Ae}return Ae}function xn(k,F,Me,Ae){if(!rn(F,k.length))return NaN;for(let Ae=F[0];Ae<=F[1];++Ae)if(Ir(k[Ae],Me,!0))return 0;let Oe=1/0;for(let Fe=F[0];Fe<F[1];++Fe)for(const F of Me)for(let Me=0,je=F.length,qe=je-1;Me<je;qe=Me++){if(zr(k[Fe],k[Fe+1],F[qe],F[Me]))return 0;Oe=Math.min(Oe,dn(k[Fe],k[Fe+1],F[qe],F[Me],Ae))}return Oe}function vn(k,F){for(const Me of k)for(let k=0;k<=Me.length-1;++k)if(Ir(Me[k],F,!0))return!0;return!1}function bn(k,F,Me,Ae=1/0){const Oe=sn(k),Fe=sn(F);if(Ae!==1/0&&on(Oe,Fe,Me)>=Ae)return Ae;if(Ar(Oe,Fe)){if(vn(k,F))return 0}else if(vn(F,k))return 0;let je=Ae;for(const Ae of k)for(let k=0,Oe=Ae.length,Fe=Oe-1;k<Oe;Fe=k++)for(const Oe of F)for(let F=0,qe=Oe.length,pt=qe-1;F<qe;pt=F++){if(zr(Ae[Fe],Ae[k],Oe[pt],Oe[F]))return 0;je=Math.min(je,dn(Ae[Fe],Ae[k],Oe[pt],Oe[F],Me))}return je}function _n(k,F,Me,Ae,Oe,Fe,je){if(null===Fe||null===je)return;const qe=on(an(Ae,Fe),an(Oe,je),Me);qe<F&&k.push({dist:qe,range1:Fe,range2:je})}function wn(k,F,Me,Ae,Oe=1/0){let Fe=Math.min(Ae.distance(k[0],Me[0][0]),Oe);if(0===Fe)return Fe;const je=new Hr([{dist:0,range1:[0,k.length-1],range2:[0,0]}],Kr),qe=F?Ad:Ed,pt=sn(Me);for(;je.length;){const Oe=je.pop();if(Oe.dist>=Fe)continue;const vt=Oe.range1;if(en(vt)<=qe){if(!rn(vt,k.length))return NaN;if(F){const F=xn(k,vt,Me,Ae);if(0===(Fe=Math.min(Fe,F)))return Fe}else for(let F=vt[0];F<=vt[1];++F){const Oe=gn(k[F],Me,Ae);if(0===(Fe=Math.min(Fe,Oe)))return Fe}}else{const Me=nn(vt,F);if(null!==Me[0]){const F=on(an(k,Me[0]),pt,Ae);F<Fe&&je.push({dist:F,range1:Me[0],range2:[0,0]})}if(null!==Me[1]){const F=on(an(k,Me[1]),pt,Ae);F<Fe&&je.push({dist:F,range1:Me[1],range2:[0,0]})}}}return Fe}function Mn(k,F,Me,Ae,Oe,Fe=1/0){let je=Math.min(Fe,Oe.distance(k[0],Me[0]));if(0===je)return je;const qe=new Hr([{dist:0,range1:[0,k.length-1],range2:[0,Me.length-1]}],Kr),pt=F?Ad:Ed,vt=Ae?Ad:Ed;for(;qe.length;){const Fe=qe.pop();if(Fe.dist>=je)continue;const Ut=Fe.range1,xi=Fe.range2;if(en(Ut)<=pt&&en(xi)<=vt){if(!rn(Ut,k.length)||!rn(xi,Me.length))return NaN;if(F&&Ae?je=Math.min(je,mn(k,Ut,Me,xi,Oe)):F||Ae?F&&!Ae?je=Math.min(je,fn(Me,xi,k,Ut,Oe)):!F&&Ae&&(je=Math.min(je,fn(k,Ut,Me,xi,Oe))):je=Math.min(je,yn(k,Ut,Me,xi,Oe)),0===je)return je}else{const Fe=nn(Ut,F),pt=nn(xi,Ae);_n(qe,je,Oe,k,Me,Fe[0],pt[0]),_n(qe,je,Oe,k,Me,Fe[0],pt[1]),_n(qe,je,Oe,k,Me,Fe[1],pt[0]),_n(qe,je,Oe,k,Me,Fe[1],pt[1])}}return je}function An(k,F,Me,Ae,Oe=1/0){let Fe=Oe;const je=an(k,[0,k.length-1]);for(const Oe of Me)if(!(Fe!==1/0&&on(je,an(Oe,[0,Oe.length-1]),Ae)>=Fe)&&(Fe=Math.min(Fe,Mn(k,F,Oe,!0,Ae,Fe)),0===Fe))return Fe;return Fe}function Sn(k,F,Me,Ae,Oe=1/0){let Fe=Oe;const je=an(k,[0,k.length-1]);for(const Oe of Me){if(Fe!==1/0&&on(je,sn(Oe),Ae)>=Fe)continue;const Me=wn(k,F,Oe,Ae,Fe);if(isNaN(Me))return Me;if(0===(Fe=Math.min(Fe,Me)))return Fe}return Fe}function In(k){return"Point"===k||"MultiPoint"===k||"LineString"===k||"MultiLineString"===k||"Polygon"===k||"MultiPolygon"===k}class Pn{constructor(k,F){this.type=su,this.geojson=k,this.geometries=F}static parse(k,F){if(2!==k.length)return F.error(`'distance' expression requires either one argument, but found ' ${k.length-1} instead.`);if(rr(k[1])){const F=k[1];if("FeatureCollection"===F.type){for(let k=0;k<F.features.length;++k)if(In(F.features[k].geometry.type))return new Pn(F,F.features[k].geometry)}else if("Feature"===F.type){if(In(F.geometry.type))return new Pn(F,F.geometry)}else if(In(F.type))return new Pn(F,F)}return F.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(k){const F=k.geometry(),Me=k.canonicalID();if(null!=F&&null!=Me){if("Point"===k.geometryType())return function(k,F,Me){const Ae=[];for(const Me of k)for(const k of Me)Ae.push(cn(k,F));const Oe=new Gr(Ae[0][1],"meters");return"Point"===Me.type||"MultiPoint"===Me.type||"LineString"===Me.type?Mn(Ae,!1,"Point"===Me.type?[Me.coordinates]:Me.coordinates,"LineString"===Me.type,Oe):"MultiLineString"===Me.type?An(Ae,!1,Me.coordinates,Oe):"Polygon"===Me.type||"MultiPolygon"===Me.type?Sn(Ae,!1,"Polygon"===Me.type?[Me.coordinates]:Me.coordinates,Oe):null}(F,Me,this.geometries);if("LineString"===k.geometryType())return function(k,F,Me){const Ae=[];for(const Me of k){const k=[];for(const Ae of Me)k.push(cn(Ae,F));Ae.push(k)}const Oe=new Gr(Ae[0][0][1],"meters");if("Point"===Me.type||"MultiPoint"===Me.type||"LineString"===Me.type)return An("Point"===Me.type?[Me.coordinates]:Me.coordinates,"LineString"===Me.type,Ae,Oe);if("MultiLineString"===Me.type){let k=1/0;for(let F=0;F<Me.coordinates.length;F++){const Fe=An(Me.coordinates[F],!0,Ae,Oe,k);if(isNaN(Fe))return Fe;if(0===(k=Math.min(k,Fe)))return k}return k}if("Polygon"===Me.type||"MultiPolygon"===Me.type){let k=1/0;for(let F=0;F<Ae.length;F++){const Fe=Sn(Ae[F],!0,"Polygon"===Me.type?[Me.coordinates]:Me.coordinates,Oe,k);if(isNaN(Fe))return Fe;if(0===(k=Math.min(k,Fe)))return k}return k}return null}(F,Me,this.geometries);if("Polygon"===k.geometryType())return function(k,F,Me){const Ae=[];for(const Me of function(k,F){const Me=k.length;if(Me<=1)return[k];const Ae=[];let Oe,Fe;for(let F=0;F<Me;F++){const Me=wr(k[F]);0!==Me&&(k[F].area=Math.abs(Me),void 0===Fe&&(Fe=Me<0),Fe===Me<0?(Oe&&Ae.push(Oe),Oe=[k[F]]):Oe.push(k[F]))}return Oe&&Ae.push(Oe),Ae}(k)){const k=[];for(let Ae=0;Ae<Me.length;++Ae)k.push(hn(Me[Ae],F));Ae.push(k)}const Oe=new Gr(Ae[0][0][0][1],"meters");if("Point"===Me.type||"MultiPoint"===Me.type||"LineString"===Me.type)return Sn("Point"===Me.type?[Me.coordinates]:Me.coordinates,"LineString"===Me.type,Ae,Oe);if("MultiLineString"===Me.type){let k=1/0;for(let F=0;F<Me.coordinates.length;F++){const Fe=Sn(Me.coordinates[F],!0,Ae,Oe,k);if(isNaN(Fe))return Fe;if(0===(k=Math.min(k,Fe)))return k}return k}return"Polygon"===Me.type||"MultiPolygon"===Me.type?function(k,F,Me){let Ae=1/0;for(const Oe of k)for(const k of F){const F=bn(Oe,k,Me,Ae);if(isNaN(F))return F;if(0===(Ae=Math.min(Ae,F)))return Ae}return Ae}("Polygon"===Me.type?[Me.coordinates]:Me.coordinates,Ae,Oe):null}(F,Me,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function zn(k,F){switch(k){case"string":return ir(F);case"number":return+F;case"boolean":return!!F;case"color":return Ie.parse(F);case"formatted":return Je.fromString(ir(F));case"resolvedImage":return tr.build(ir(F))}return F}function En(k,F,Me,Ae){return void 0!==Ae&&(k=Ae*Math.round(k/Ae)),void 0!==F&&k<F&&(k=F),void 0!==Me&&k>Me&&(k=Me),k}class kn{constructor(k,F,Me){this.type=k,this.key=F,this.scope=Me}static parse(k,F){let Me=F.expectedType;if(null==Me&&(Me=Bu),k.length<2||k.length>3)return F.error("Invalid number of arguments for 'config' expression.");const Ae=F.parse(k[1],1);if(!(Ae instanceof ar))return F.error("Key name of 'config' expression must be a string literal.");if(k.length>=3){const Oe=F.parse(k[2],2);return Oe instanceof ar?new kn(Me,ir(Ae.value),ir(Oe.value)):F.error("Scope of 'config' expression must be a string literal.")}return new kn(Me,ir(Ae.value))}evaluate(k){const F=[this.key,this.scope,k.scope].filter(Boolean).join(""),Me=k.getConfig(F);if(!Me)return null;const{type:Ae,value:Oe,values:Fe,minValue:je,maxValue:qe,stepValue:pt}=Me,vt=Me.default.evaluate(k);let Ut=vt;if(Oe){const F=k.scope;k.scope=(F||"").split("").slice(1).join(""),Ut=Oe.evaluate(k),k.scope=F}return Ae&&(Ut=zn(Ae,Ut)),void 0===Ut||void 0===je&&void 0===qe&&void 0===pt||("number"==typeof Ut?Ut=En(Ut,je,qe,pt):Array.isArray(Ut)&&(Ut=Ut.map((k=>"number"==typeof k?En(k,je,qe,pt):k)))),void 0!==Oe&&void 0!==Ut&&Fe&&!Fe.includes(Ut)&&(Ut=vt,Ae&&(Ut=zn(Ae,Ut))),(Ae&&Ae!==this.type||void 0!==Ut&&nr(Ut)!==this.type)&&(Ut=zn(this.type.kind,Ut)),Ut}eachChild(){}outputDefined(){return!1}serialize(){const k=["config",this.key];return this.scope&&k.concat(this.key),k}}function Tn(k){if(k instanceof yr){if("get"===k.name&&1===k.args.length)return!1;if("feature-state"===k.name)return!1;if("has"===k.name&&1===k.args.length)return!1;if("properties"===k.name||"geometry-type"===k.name||"id"===k.name)return!1;if(/^filter-/.test(k.name))return!1}if(k instanceof Nr)return!1;if(k instanceof Pn)return!1;let F=!0;return k.eachChild((k=>{F&&!Tn(k)&&(F=!1)})),F}function Bn(k){if(k instanceof yr&&"feature-state"===k.name)return!1;let F=!0;return k.eachChild((k=>{F&&!Bn(k)&&(F=!1)})),F}function Vn(k){if(k instanceof kn)return new Set([k.key]);let F=new Set;return k.eachChild((k=>{F=new Set([...F,...Vn(k)])})),F}function Cn(k,F){if(k instanceof yr&&F.indexOf(k.name)>=0)return!1;let Me=!0;return k.eachChild((k=>{Me&&!Cn(k,F)&&(Me=!1)})),Me}class Dn{constructor(k,F){this.type=F.type,this.name=k,this.boundExpression=F}static parse(k,F){if(2!==k.length||"string"!=typeof k[1])return F.error("'var' expression requires exactly one string literal argument.");const Me=k[1];return F.scope.has(Me)?new Dn(Me,F.scope.get(Me)):F.error(`Unknown variable "${Me}". Make sure "${Me}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(k){return this.boundExpression.evaluate(k)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ln{constructor(k,F=[],Me,Ae=new Ve,Oe=[],Fe,je){this.registry=k,this.path=F,this.key=F.map((k=>"string"==typeof k?`['${k}']`:`[${k}]`)).join(""),this.scope=Ae,this.errors=Oe,this.expectedType=Me,this._scope=Fe,this.options=je}parse(k,F,Me,Ae,Oe={}){return F||Me?this.concat(F,null,Me,Ae)._parse(k,Oe):this._parse(k,Oe)}parseObjectValue(k,F,Me,Ae,Oe,Fe={}){return this.concat(F,Me,Ae,Oe)._parse(k,Fe)}_parse(k,F){function r(k,F,Me){return"assert"===Me?new lr(F,[k]):"coerce"===Me?new fr(F,[k]):k}if(null!==k&&"string"!=typeof k&&"boolean"!=typeof k&&"number"!=typeof k||(k=["literal",k]),Array.isArray(k)){if(0===k.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const Me="string"==typeof k[0]?this.registry[k[0]]:void 0;if(Me){let Ae=Me.parse(k,this);if(!Ae)return null;if(this.expectedType){const k=this.expectedType,Me=Ae.type;if("string"!==k.kind&&"number"!==k.kind&&"boolean"!==k.kind&&"object"!==k.kind&&"array"!==k.kind||"value"!==Me.kind)if("color"!==k.kind&&"formatted"!==k.kind&&"resolvedImage"!==k.kind||"value"!==Me.kind&&"string"!==Me.kind){if(this.checkSubtype(k,Me))return null}else Ae=r(Ae,k,F.typeAnnotation||"coerce");else Ae=r(Ae,k,F.typeAnnotation||"assert")}if(!(Ae instanceof ar)&&"resolvedImage"!==Ae.type.kind&&Fn(Ae)){const F=new mr(this._scope,this.options);try{Ae=new ar(Ae.type,Ae.evaluate(F))}catch(k){return this.error(k.message),null}}return Ae}return fr.parse(["to-array",k],this)}return this.error(void 0===k?"'undefined' value invalid. Use null instead.":"object"==typeof k?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof k} instead.`)}concat(k,F,Me,Ae){let Oe="number"==typeof k?this.path.concat(k):this.path;Oe="string"==typeof F?Oe.concat(F):Oe;const Fe=Ae?this.scope.concat(Ae):this.scope;return new Ln(this.registry,Oe,Me||null,Fe,this.errors,this._scope,this.options)}error(k,...F){const Me=`${this.key}${F.map((k=>`[${k}]`)).join("")}`;this.errors.push(new Be(Me,k))}checkSubtype(k,F){const Me=Xe(k,F);return Me&&this.error(Me),Me}}var Cd=Ln;function Fn(k){if(k instanceof Dn)return Fn(k.boundExpression);if(k instanceof yr&&"error"===k.name)return!1;if(k instanceof xr)return!1;if(k instanceof Nr)return!1;if(k instanceof Pn)return!1;if(k instanceof kn)return!1;const F=k instanceof fr||k instanceof lr;let Me=!0;return k.eachChild((k=>{Me=F?Me&&Fn(k):Me&&k instanceof ar})),!!Me&&Tn(k)&&Cn(k,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function On(k,F){const Me=k.length-1;let Ae,Oe,Fe=0,je=Me,qe=0;for(;Fe<=je;)if(qe=Math.floor((Fe+je)/2),Ae=k[qe],Oe=k[qe+1],Ae<=F){if(qe===Me||F<Oe)return qe;Fe=qe+1}else{if(!(Ae>F))throw new sr("Input is not a number.");je=qe-1}return 0}class Nn{constructor(k,F,Me){this.type=k,this.input=F,this.labels=[],this.outputs=[];for(const[k,F]of Me)this.labels.push(k),this.outputs.push(F)}static parse(k,F){if(k.length-1<4)return F.error(`Expected at least 4 arguments, but found only ${k.length-1}.`);if((k.length-1)%2!=0)return F.error("Expected an even number of arguments.");const Me=F.parse(k[1],1,su);if(!Me)return null;const Ae=[];let Oe=null;F.expectedType&&"value"!==F.expectedType.kind&&(Oe=F.expectedType);for(let Me=1;Me<k.length;Me+=2){const Fe=1===Me?-1/0:k[Me],je=k[Me+1],qe=Me,pt=Me+1;if("number"!=typeof Fe)return F.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',qe);if(Ae.length&&Ae[Ae.length-1][0]>=Fe)return F.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',qe);const vt=F.parse(je,pt,Oe);if(!vt)return null;Oe=Oe||vt.type,Ae.push([Fe,vt])}return new Nn(Oe,Me,Ae)}evaluate(k){const F=this.labels,Me=this.outputs;if(1===F.length)return Me[0].evaluate(k);const Ae=this.input.evaluate(k);if(Ae<=F[0])return Me[0].evaluate(k);const Oe=F.length;return Ae>=F[Oe-1]?Me[Oe-1].evaluate(k):Me[On(F,Ae)].evaluate(k)}eachChild(k){k(this.input);for(const F of this.outputs)k(F)}outputDefined(){return this.outputs.every((k=>k.outputDefined()))}serialize(){const k=["step",this.input.serialize()];for(let F=0;F<this.labels.length;F++)F>0&&k.push(this.labels[F]),k.push(this.outputs[F].serialize());return k}}const zd=.95047,Pd=1.08883,kd=4/29,Fd=6/29,Nd=3*Fd*Fd,Gd=Fd*Fd*Fd,Yd=Math.PI/180,lp=180/Math.PI;function Hn(k){return k>Gd?Math.pow(k,1/3):k/Nd+kd}function Wn(k){return k>Fd?k*k*k:Nd*(k-kd)}function Kn(k){return 255*(k<=.0031308?12.92*k:1.055*Math.pow(k,1/2.4)-.055)}function Jn(k){return(k/=255)<=.04045?k/12.92:Math.pow((k+.055)/1.055,2.4)}function Qn(k){const F=Jn(k.r),Me=Jn(k.g),Ae=Jn(k.b),Oe=Hn((.4124564*F+.3575761*Me+.1804375*Ae)/zd),Fe=Hn((.2126729*F+.7151522*Me+.072175*Ae)/1);return{l:116*Fe-16,a:500*(Oe-Fe),b:200*(Fe-Hn((.0193339*F+.119192*Me+.9503041*Ae)/Pd)),alpha:k.a}}function ti(k){let F=(k.l+16)/116,Me=isNaN(k.a)?F:F+k.a/500,Ae=isNaN(k.b)?F:F-k.b/200;return F=1*Wn(F),Me=zd*Wn(Me),Ae=Pd*Wn(Ae),new Ie(Kn(3.2404542*Me-1.5371385*F-.4985314*Ae),Kn(-.969266*Me+1.8760108*F+.041556*Ae),Kn(.0556434*Me-.2040259*F+1.0572252*Ae),k.alpha)}function ei(k,F,Me){const Ae=F-k;return k+Me*(Ae>180||Ae<-180?Ae-360*Math.round(Ae/360):Ae)}const up={forward:Qn,reverse:ti,interpolate:function(k,F,Me){return{l:ze(k.l,F.l,Me),a:ze(k.a,F.a,Me),b:ze(k.b,F.b,Me),alpha:ze(k.alpha,F.alpha,Me)}}},dp={forward:function(k){const{l:F,a:Me,b:Ae}=Qn(k),Oe=Math.atan2(Ae,Me)*lp;return{h:Oe<0?Oe+360:Oe,c:Math.sqrt(Me*Me+Ae*Ae),l:F,alpha:k.a}},reverse:function(k){const F=k.h*Yd,Me=k.c;return ti({l:k.l,a:Math.cos(F)*Me,b:Math.sin(F)*Me,alpha:k.alpha})},interpolate:function(k,F,Me){return{h:ei(k.h,F.h,Me),c:ze(k.c,F.c,Me),l:ze(k.l,F.l,Me),alpha:ze(k.alpha,F.alpha,Me)}}};var fp=Object.freeze({__proto__:null,hcl:dp,lab:up});class ai{constructor(k,F,Me,Ae,Oe,Fe){this.type=k,this.operator=F,this.interpolation=Me,this.input=Ae,this.dynamicStops=Oe,this.labels=[],this.outputs=[];for(const[k,F]of Fe)this.labels.push(k),this.outputs.push(F)}static interpolationFactor(k,F,Me,Ae){let Oe=0;if("exponential"===k.name)Oe=si(F,k.base,Me,Ae);else if("linear"===k.name)Oe=si(F,1,Me,Ae);else if("cubic-bezier"===k.name){const Fe=k.controlPoints;Oe=new wa(Fe[0],Fe[1],Fe[2],Fe[3]).solve(si(F,1,Me,Ae))}return Oe}static parse(k,F){let[Me,Ae,Oe,...Fe]=k;if(!Array.isArray(Ae)||0===Ae.length)return F.error("Expected an interpolation type expression.",1);if("linear"===Ae[0])Ae={name:"linear"};else if("exponential"===Ae[0]){const k=Ae[1];if("number"!=typeof k)return F.error("Exponential interpolation requires a numeric base.",1,1);Ae={name:"exponential",base:k}}else{if("cubic-bezier"!==Ae[0])return F.error(`Unknown interpolation type ${String(Ae[0])}`,1,0);{const k=Ae.slice(1);if(4!==k.length||k.some((k=>"number"!=typeof k||k<0||k>1)))return F.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);Ae={name:"cubic-bezier",controlPoints:k}}}if(k.length-1<3)return F.error(`Expected at least 3 arguments, but found only ${k.length-1}.`);if(k.length-1>3&&(k.length-1)%2!=0)return F.error("Expected an even number of arguments.");if(Oe=F.parse(Oe,2,su),!Oe)return null;const je=[];let qe=null;if("interpolate-hcl"===Me||"interpolate-lab"===Me?qe=uu:F.expectedType&&"value"!==F.expectedType.kind&&(qe=F.expectedType),k.length-1==3){const k=F.parse(Fe[0],3,Bu);return k?new ai(qe,Me,Ae,Oe,k,je):null}for(let k=0;k<Fe.length;k+=2){const Me=Fe[k],Ae=Fe[k+1],Oe=k+3,pt=k+4;if("number"!=typeof Me)return F.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Oe);if(je.length&&je[je.length-1][0]>=Me)return F.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',Oe);const vt=F.parse(Ae,pt,qe);if(!vt)return null;qe=qe||vt.type,je.push([Me,vt])}return"number"===qe.kind||"color"===qe.kind||"array"===qe.kind&&"number"===qe.itemType.kind&&"number"==typeof qe.N?new ai(qe,Me,Ae,Oe,null,je):F.error(`Type ${Ge(qe)} is not interpolatable.`)}evaluate(k){let F=this.labels,Me=this.outputs;if(this.dynamicStops){const Ae=this.dynamicStops.evaluate(k);if(Ae.length%2!=0)throw new sr("Expected an even number of arguments.");F=[],Me=[];for(let k=0;k<Ae.length;k+=2){const Oe=Ae[k],Fe=new ar(su,Ae[k+1]);if("number"!=typeof Oe)throw new sr('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.');if(F.length&&F[F.length-1]>=Oe)throw new sr('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.');F.push(Oe),Me.push(Fe)}if(0===F.length)throw new sr("Expected at least one input/output pair.")}if(1===F.length)return Me[0].evaluate(k);const Ae=this.input.evaluate(k);if(Ae<=F[0])return Me[0].evaluate(k);const Oe=F.length;if(Ae>=F[Oe-1])return Me[Oe-1].evaluate(k);const Fe=On(F,Ae),je=ai.interpolationFactor(this.interpolation,Ae,F[Fe],F[Fe+1]),qe=Me[Fe].evaluate(k),pt=Me[Fe+1].evaluate(k);return"interpolate"===this.operator?tu[this.type.kind.toLowerCase()](qe,pt,je):"interpolate-hcl"===this.operator?dp.reverse(dp.interpolate(dp.forward(qe),dp.forward(pt),je)):up.reverse(up.interpolate(up.forward(qe),up.forward(pt),je))}eachChild(k){k(this.input);for(const F of this.outputs)k(F)}outputDefined(){return this.outputs.every((k=>k.outputDefined()))}serialize(){let k;k="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const F=[this.operator,k,this.input.serialize()];if(this.dynamicStops)F.push(this.dynamicStops.serialize());else for(let k=0;k<this.labels.length;k++)F.push(this.labels[k],this.outputs[k].serialize());return F}}function si(k,F,Me,Ae){const Oe=Ae-Me,Fe=k-Me;return 0===Oe?0:1===F?Fe/Oe:(Math.pow(F,Fe)-1)/(Math.pow(F,Oe)-1)}class oi{constructor(k,F){this.type=k,this.args=F}static parse(k,F){if(k.length<2)return F.error("Expectected at least one argument.");let Me=null;const Ae=F.expectedType;Ae&&"value"!==Ae.kind&&(Me=Ae);const Oe=[];for(const Ae of k.slice(1)){const k=F.parse(Ae,1+Oe.length,Me,void 0,{typeAnnotation:"omit"});if(!k)return null;Me=Me||k.type,Oe.push(k)}const Fe=Ae&&Oe.some((k=>Xe(Ae,k.type)));return new oi(Fe?Bu:Me,Oe)}evaluate(k){let F,Me=null,Ae=0;for(const Oe of this.args){if(Ae++,Me=Oe.evaluate(k),Me&&Me instanceof tr&&!Me.available&&(F||(F=Me),Me=null,Ae===this.args.length))return F;if(null!==Me)break}return Me}eachChild(k){this.args.forEach(k)}outputDefined(){return this.args.every((k=>k.outputDefined()))}serialize(){const k=["coalesce"];return this.eachChild((F=>{k.push(F.serialize())})),k}}class li{constructor(k,F){this.type=F.type,this.bindings=[].concat(k),this.result=F}evaluate(k){return this.result.evaluate(k)}eachChild(k){for(const F of this.bindings)k(F[1]);k(this.result)}static parse(k,F){if(k.length<4)return F.error(`Expected at least 3 arguments, but found ${k.length-1} instead.`);const Me=[];for(let Ae=1;Ae<k.length-1;Ae+=2){const Oe=k[Ae];if("string"!=typeof Oe)return F.error(`Expected string, but found ${typeof Oe} instead.`,Ae);if(/[^a-zA-Z0-9_]/.test(Oe))return F.error("Variable names must contain only alphanumeric characters or '_'.",Ae);const Fe=F.parse(k[Ae+1],Ae+1);if(!Fe)return null;Me.push([Oe,Fe])}const Ae=F.parse(k[k.length-1],k.length-1,F.expectedType,Me);return Ae?new li(Me,Ae):null}outputDefined(){return this.result.outputDefined()}serialize(){const k=["let"];for(const[F,Me]of this.bindings)k.push(F,Me.serialize());return k.push(this.result.serialize()),k}}class ui{constructor(k,F,Me){this.type=k,this.index=F,this.input=Me}static parse(k,F){if(3!==k.length)return F.error(`Expected 2 arguments, but found ${k.length-1} instead.`);const Me=F.parse(k[1],1,su),Ae=F.parse(k[2],2,$e(F.expectedType||Bu));return Me&&Ae?new ui(Ae.type.itemType,Me,Ae):null}evaluate(k){const F=this.index.evaluate(k),Me=this.input.evaluate(k);if(F<0)throw new sr(`Array index out of bounds: ${F} < 0.`);if(F>Me.length-1)throw new sr(`Array index out of bounds: ${F} > ${Me.length-1}.`);if(F===Math.floor(F))return Me[F];const Ae=Math.floor(F),Oe=Math.ceil(F),Fe=Me[Ae],je=Me[Oe];if("number"!=typeof Fe||"number"!=typeof je)throw new sr(`Cannot interpolate between non-number values at index ${F}.`);const qe=F-Ae;return Fe*(1-qe)+je*qe}eachChild(k){k(this.index),k(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class ci{constructor(k,F){this.type=cu,this.needle=k,this.haystack=F}static parse(k,F){if(3!==k.length)return F.error(`Expected 2 arguments, but found ${k.length-1} instead.`);const Me=F.parse(k[1],1,Bu),Ae=F.parse(k[2],2,Bu);return Me&&Ae?Ze(Me.type,[cu,lu,su,ou,Bu])?new ci(Me,Ae):F.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(Me.type)} instead`):null}evaluate(k){const F=this.needle.evaluate(k),Me=this.haystack.evaluate(k);if(null==Me)return!1;if(!He(F,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(nr(F))} instead.`);if(!He(Me,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${Ge(nr(Me))} instead.`);return Me.indexOf(F)>=0}eachChild(k){k(this.needle),k(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class hi{constructor(k,F,Me){this.type=su,this.needle=k,this.haystack=F,this.fromIndex=Me}static parse(k,F){if(k.length<=2||k.length>=5)return F.error(`Expected 3 or 4 arguments, but found ${k.length-1} instead.`);const Me=F.parse(k[1],1,Bu),Ae=F.parse(k[2],2,Bu);if(!Me||!Ae)return null;if(!Ze(Me.type,[cu,lu,su,ou,Bu]))return F.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(Me.type)} instead`);if(4===k.length){const Oe=F.parse(k[3],3,su);return Oe?new hi(Me,Ae,Oe):null}return new hi(Me,Ae)}evaluate(k){const F=this.needle.evaluate(k),Me=this.haystack.evaluate(k);if(!He(F,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(nr(F))} instead.`);if(!He(Me,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${Ge(nr(Me))} instead.`);if(this.fromIndex){const Ae=this.fromIndex.evaluate(k);return Me.indexOf(F,Ae)}return Me.indexOf(F)}eachChild(k){k(this.needle),k(this.haystack),this.fromIndex&&k(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const k=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),k]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class pi{constructor(k,F,Me,Ae,Oe,Fe){this.inputType=k,this.type=F,this.input=Me,this.cases=Ae,this.outputs=Oe,this.otherwise=Fe}static parse(k,F){if(k.length<5)return F.error(`Expected at least 4 arguments, but found only ${k.length-1}.`);if(k.length%2!=1)return F.error("Expected an even number of arguments.");let Me,Ae;F.expectedType&&"value"!==F.expectedType.kind&&(Ae=F.expectedType);const Oe={},Fe=[];for(let je=2;je<k.length-1;je+=2){let qe=k[je];const pt=k[je+1];Array.isArray(qe)||(qe=[qe]);const vt=F.concat(je);if(0===qe.length)return vt.error("Expected at least one branch label.");for(const k of qe){if("number"!=typeof k&&"string"!=typeof k)return vt.error("Branch labels must be numbers or strings.");if("number"==typeof k&&Math.abs(k)>Number.MAX_SAFE_INTEGER)return vt.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof k&&Math.floor(k)!==k)return vt.error("Numeric branch labels must be integer values.");if(Me){if(vt.checkSubtype(Me,nr(k)))return null}else Me=nr(k);if(void 0!==Oe[String(k)])return vt.error("Branch labels must be unique.");Oe[String(k)]=Fe.length}const Ut=F.parse(pt,je,Ae);if(!Ut)return null;Ae=Ae||Ut.type,Fe.push(Ut)}const je=F.parse(k[1],1,Bu);if(!je)return null;const qe=F.parse(k[k.length-1],k.length-1,Ae);return qe?"value"!==je.type.kind&&F.concat(1).checkSubtype(Me,je.type)?null:new pi(Me,Ae,je,Oe,Fe,qe):null}evaluate(k){const F=this.input.evaluate(k);return(nr(F)===this.inputType&&this.outputs[this.cases[F]]||this.otherwise).evaluate(k)}eachChild(k){k(this.input),this.outputs.forEach(k),k(this.otherwise)}outputDefined(){return this.outputs.every((k=>k.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const k=["match",this.input.serialize()],F=Object.keys(this.cases).sort(),Me=[],Ae={};for(const k of F){const F=Ae[this.cases[k]];void 0===F?(Ae[this.cases[k]]=Me.length,Me.push([this.cases[k],[k]])):Me[F][1].push(k)}const i=k=>"number"===this.inputType.kind?Number(k):k;for(const[F,Ae]of Me)k.push(1===Ae.length?i(Ae[0]):Ae.map(i)),k.push(this.outputs[F].serialize());return k.push(this.otherwise.serialize()),k}}class fi{constructor(k,F,Me){this.type=k,this.branches=F,this.otherwise=Me}static parse(k,F){if(k.length<4)return F.error(`Expected at least 3 arguments, but found only ${k.length-1}.`);if(k.length%2!=0)return F.error("Expected an odd number of arguments.");let Me;F.expectedType&&"value"!==F.expectedType.kind&&(Me=F.expectedType);const Ae=[];for(let Oe=1;Oe<k.length-1;Oe+=2){const Fe=F.parse(k[Oe],Oe,cu);if(!Fe)return null;const je=F.parse(k[Oe+1],Oe+1,Me);if(!je)return null;Ae.push([Fe,je]),Me=Me||je.type}const Oe=F.parse(k[k.length-1],k.length-1,Me);return Oe?new fi(Me,Ae,Oe):null}evaluate(k){for(const[F,Me]of this.branches)if(F.evaluate(k))return Me.evaluate(k);return this.otherwise.evaluate(k)}eachChild(k){for(const[F,Me]of this.branches)k(F),k(Me);k(this.otherwise)}outputDefined(){return this.branches.every((([k,F])=>F.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const k=["case"];return this.eachChild((F=>{k.push(F.serialize())})),k}}class di{constructor(k,F,Me,Ae){this.type=k,this.input=F,this.beginIndex=Me,this.endIndex=Ae}static parse(k,F){if(k.length<=2||k.length>=5)return F.error(`Expected 3 or 4 arguments, but found ${k.length-1} instead.`);const Me=F.parse(k[1],1,Bu),Ae=F.parse(k[2],2,su);if(!Me||!Ae)return null;if(!Ze(Me.type,[$e(Bu),lu,Bu]))return F.error(`Expected first argument to be of type array or string, but found ${Ge(Me.type)} instead`);if(4===k.length){const Oe=F.parse(k[3],3,su);return Oe?new di(Me.type,Me,Ae,Oe):null}return new di(Me.type,Me,Ae)}evaluate(k){const F=this.input.evaluate(k),Me=this.beginIndex.evaluate(k);if(!He(F,["string","array"]))throw new sr(`Expected first argument to be of type array or string, but found ${Ge(nr(F))} instead.`);if(this.endIndex){const Ae=this.endIndex.evaluate(k);return F.slice(Me,Ae)}return F.slice(Me)}eachChild(k){k(this.input),k(this.beginIndex),this.endIndex&&k(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const k=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),k]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function mi(k,F){return"=="===k||"!="===k?"boolean"===F.kind||"string"===F.kind||"number"===F.kind||"null"===F.kind||"value"===F.kind:"string"===F.kind||"number"===F.kind||"value"===F.kind}function yi(k,F,Me,Ae){return 0===Ae.compare(F,Me)}function gi(k,F,Me){const Ae="=="!==k&&"!="!==k;return class i{constructor(k,F,Me){this.type=cu,this.lhs=k,this.rhs=F,this.collator=Me,this.hasUntypedArgument="value"===k.type.kind||"value"===F.type.kind}static parse(k,F){if(3!==k.length&&4!==k.length)return F.error("Expected two or three arguments.");const Me=k[0];let Oe=F.parse(k[1],1,Bu);if(!Oe)return null;if(!mi(Me,Oe.type))return F.concat(1).error(`"${Me}" comparisons are not supported for type '${Ge(Oe.type)}'.`);let Fe=F.parse(k[2],2,Bu);if(!Fe)return null;if(!mi(Me,Fe.type))return F.concat(2).error(`"${Me}" comparisons are not supported for type '${Ge(Fe.type)}'.`);if(Oe.type.kind!==Fe.type.kind&&"value"!==Oe.type.kind&&"value"!==Fe.type.kind)return F.error(`Cannot compare types '${Ge(Oe.type)}' and '${Ge(Fe.type)}'.`);Ae&&("value"===Oe.type.kind&&"value"!==Fe.type.kind?Oe=new lr(Fe.type,[Oe]):"value"!==Oe.type.kind&&"value"===Fe.type.kind&&(Fe=new lr(Oe.type,[Fe])));let je=null;if(4===k.length){if("string"!==Oe.type.kind&&"string"!==Fe.type.kind&&"value"!==Oe.type.kind&&"value"!==Fe.type.kind)return F.error("Cannot use collator to compare non-string types.");if(je=F.parse(k[3],3,Uu),!je)return null}return new i(Oe,Fe,je)}evaluate(Oe){const Fe=this.lhs.evaluate(Oe),je=this.rhs.evaluate(Oe);if(Ae&&this.hasUntypedArgument){const F=nr(Fe),Me=nr(je);if(F.kind!==Me.kind||"string"!==F.kind&&"number"!==F.kind)throw new sr(`Expected arguments for "${k}" to be (string, string) or (number, number), but found (${F.kind}, ${Me.kind}) instead.`)}if(this.collator&&!Ae&&this.hasUntypedArgument){const k=nr(Fe),Me=nr(je);if("string"!==k.kind||"string"!==Me.kind)return F(Oe,Fe,je)}return this.collator?Me(Oe,Fe,je,this.collator.evaluate(Oe)):F(Oe,Fe,je)}eachChild(k){k(this.lhs),k(this.rhs),this.collator&&k(this.collator)}outputDefined(){return!0}serialize(){const F=[k];return this.eachChild((k=>{F.push(k.serialize())})),F}}}const mp=gi("==",(function(k,F,Me){return F===Me}),yi),_p=gi("!=",(function(k,F,Me){return F!==Me}),(function(k,F,Me,Ae){return!yi(0,F,Me,Ae)})),gp=gi("<",(function(k,F,Me){return F<Me}),(function(k,F,Me,Ae){return Ae.compare(F,Me)<0})),yp=gi(">",(function(k,F,Me){return F>Me}),(function(k,F,Me,Ae){return Ae.compare(F,Me)>0})),xp=gi("<=",(function(k,F,Me){return F<=Me}),(function(k,F,Me,Ae){return Ae.compare(F,Me)<=0})),vp=gi(">=",(function(k,F,Me){return F>=Me}),(function(k,F,Me,Ae){return Ae.compare(F,Me)>=0}));class Ai{constructor(k,F,Me,Ae,Oe,Fe){this.type=lu,this.number=k,this.locale=F,this.currency=Me,this.unit=Ae,this.minFractionDigits=Oe,this.maxFractionDigits=Fe}static parse(k,F){if(3!==k.length)return F.error("Expected two arguments.");const Me=F.parse(k[1],1,su);if(!Me)return null;const Ae=k[2];if("object"!=typeof Ae||Array.isArray(Ae))return F.error("NumberFormat options argument must be an object.");let Oe=null;if(Ae.locale&&(Oe=F.parseObjectValue(Ae.locale,2,"locale",lu),!Oe))return null;let Fe=null;if(Ae.currency&&(Fe=F.parseObjectValue(Ae.currency,2,"currency",lu),!Fe))return null;let je=null;if(Ae.unit&&(je=F.parseObjectValue(Ae.unit,2,"unit",lu),!je))return null;let qe=null;if(Ae["min-fraction-digits"]&&(qe=F.parseObjectValue(Ae["min-fraction-digits"],2,"min-fraction-digits",su),!qe))return null;let pt=null;return Ae["max-fraction-digits"]&&(pt=F.parseObjectValue(Ae["max-fraction-digits"],2,"max-fraction-digits",su),!pt)?null:new Ai(Me,Oe,Fe,je,qe,pt)}evaluate(k){return new Intl.NumberFormat(this.locale?this.locale.evaluate(k):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(k):void 0,unit:this.unit?this.unit.evaluate(k):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(k):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(k):void 0}).format(this.number.evaluate(k))}eachChild(k){k(this.number),this.locale&&k(this.locale),this.currency&&k(this.currency),this.unit&&k(this.unit),this.minFractionDigits&&k(this.minFractionDigits),this.maxFractionDigits&&k(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const k={};return this.locale&&(k.locale=this.locale.serialize()),this.currency&&(k.currency=this.currency.serialize()),this.unit&&(k.unit=this.unit.serialize()),this.minFractionDigits&&(k["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(k["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),k]}}class Si{constructor(k){this.type=su,this.input=k}static parse(k,F){if(2!==k.length)return F.error(`Expected 1 argument, but found ${k.length-1} instead.`);const Me=F.parse(k[1],1);return Me?"array"!==Me.type.kind&&"string"!==Me.type.kind&&"value"!==Me.type.kind?F.error(`Expected argument of type string or array, but found ${Ge(Me.type)} instead.`):new Si(Me):null}evaluate(k){const F=this.input.evaluate(k);if("string"==typeof F)return F.length;if(Array.isArray(F))return F.length;throw new sr(`Expected value to be of type string or array, but found ${Ge(nr(F))} instead.`)}eachChild(k){k(this.input)}outputDefined(){return!1}serialize(){const k=["length"];return this.eachChild((F=>{k.push(F.serialize())})),k}}function Ii(k){return function(){k=1831565813+(k|=0)|0;let F=Math.imul(k^k>>>15,1|k);return F=F+Math.imul(F^F>>>7,61|F)^F,((F^F>>>14)>>>0)/4294967296}}const wp={"==":mp,"!=":_p,">":yp,"<":gp,">=":vp,"<=":xp,array:lr,at:ui,boolean:lr,case:fi,coalesce:oi,collator:xr,format:ur,image:cr,in:ci,"index-of":hi,interpolate:ai,"interpolate-hcl":ai,"interpolate-lab":ai,length:Si,let:li,literal:ar,match:pi,number:lr,"number-format":Ai,object:lr,slice:di,step:Nn,string:lr,"to-boolean":fr,"to-color":fr,"to-number":fr,"to-string":fr,var:Dn,within:Nr,distance:Pn,config:kn};function zi(k,[F,Me,Ae,Oe]){F=F.evaluate(k),Me=Me.evaluate(k),Ae=Ae.evaluate(k);const Fe=Oe?Oe.evaluate(k):1,je=er(F,Me,Ae,Fe);if(je)throw new sr(je);return new Ie(F/255*Fe,Me/255*Fe,Ae/255*Fe,Fe)}function Ei(k,[F,Me,Ae,Oe]){F=F.evaluate(k),Me=Me.evaluate(k),Ae=Ae.evaluate(k);const Fe=Oe?Oe.evaluate(k):1,je=function(k,F,Me,Ae){return"number"==typeof k&&k>=0&&k<=360?"number"==typeof F&&F>=0&&F<=100&&"number"==typeof Me&&Me>=0&&Me<=100?void 0===Ae||"number"==typeof Ae&&Ae>=0&&Ae<=1?null:`Invalid hsla value [${[k,F,Me,Ae].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof Ae?[k,F,Me,Ae]:[k,F,Me]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof Ae?[k,F,Me,Ae]:[k,F,Me]).join(", ")}]: 'h' must be between 0 and 360.`}(F,Me,Ae,Fe);if(je)throw new sr(je);const qe=`hsla(${F}, ${Me}%, ${Ae}%, ${Fe})`,pt=Ie.parse(qe);if(!pt)throw new sr(`Failed to parse HSLA color: ${qe}`);return pt}function ki(k,F){return k in F}function Ti(k,F){const Me=F[k];return void 0===Me?null:Me}function Bi(k){return{type:k}}function Vi(k){return{result:"success",value:k}}function Ci(k){return{result:"error",value:k}}function Di(k,F){return!!k&&!!k.parameters&&k.parameters.indexOf(F)>-1}function Li(k){return"data-driven"===k["property-type"]}function Ri(k){return Di(k.expression,"measure-light")}function Fi(k){return Di(k.expression,"zoom")}function Oi(k){return!!k.expression&&k.expression.interpolated}function Ni(k){return"object"==typeof k&&null!==k&&!Array.isArray(k)}function Ui(k){return k}function ji(k,F){const Me="color"===F.type,Ae=k.stops&&"object"==typeof k.stops[0][0],Oe=Ae||!(Ae||void 0!==k.property),Fe=k.type||(Oi(F)?"exponential":"interval");if(Me&&((k=Te({},k)).stops&&(k.stops=k.stops.map((k=>[k[0],Ie.parse(k[1])]))),k.default=Ie.parse(k.default?k.default:F.default)),k.colorSpace&&"rgb"!==k.colorSpace&&!fp[k.colorSpace])throw new Error(`Unknown color space: ${k.colorSpace}`);let je,qe,pt;if("exponential"===Fe)je=Yi;else if("interval"===Fe)je=Gi;else if("categorical"===Fe){je=$i,qe=Object.create(null);for(const F of k.stops)qe[F[0]]=F[1];pt=typeof k.stops[0][0]}else{if("identity"!==Fe)throw new Error(`Unknown function type "${Fe}"`);je=Xi}if(Ae){const Me={},Ae=[];for(let F=0;F<k.stops.length;F++){const Oe=k.stops[F],Fe=Oe[0].zoom;void 0===Me[Fe]&&(Me[Fe]={zoom:Fe,type:k.type,property:k.property,default:k.default,stops:[]},Ae.push(Fe)),Me[Fe].stops.push([Oe[0].value,Oe[1]])}const Oe=[];for(const k of Ae)Oe.push([Me[k].zoom,ji(Me[k],F)]);const Fe={name:"linear"};return{kind:"composite",interpolationType:Fe,interpolationFactor:ai.interpolationFactor.bind(void 0,Fe),zoomStops:Oe.map((k=>k[0])),evaluate:({zoom:Me},Ae)=>Yi({stops:Oe,base:k.base},F,Me).evaluate(Me,Ae)}}if(Oe){const Me="exponential"===Fe?{name:"exponential",base:void 0!==k.base?k.base:1}:null;return{kind:"camera",interpolationType:Me,interpolationFactor:ai.interpolationFactor.bind(void 0,Me),zoomStops:k.stops.map((k=>k[0])),evaluate:({zoom:Me})=>je(k,F,Me,qe,pt)}}return{kind:"source",evaluate(Me,Ae){const Oe=Ae&&Ae.properties?Ae.properties[k.property]:void 0;return void 0===Oe?qi(k.default,F.default):je(k,F,Oe,qe,pt)}}}function qi(k,F,Me){return void 0!==k?k:void 0!==F?F:void 0!==Me?Me:void 0}function $i(k,F,Me,Ae,Oe){return qi(typeof Me===Oe?Ae[Me]:void 0,k.default,F.default)}function Gi(k,F,Me){if("number"!==hr(Me))return qi(k.default,F.default);const Ae=k.stops.length;if(1===Ae)return k.stops[0][1];if(Me<=k.stops[0][0])return k.stops[0][1];if(Me>=k.stops[Ae-1][0])return k.stops[Ae-1][1];const Oe=On(k.stops.map((k=>k[0])),Me);return k.stops[Oe][1]}function Yi(k,F,Me){const Ae=void 0!==k.base?k.base:1;if("number"!==hr(Me))return qi(k.default,F.default);const Oe=k.stops.length;if(1===Oe)return k.stops[0][1];if(Me<=k.stops[0][0])return k.stops[0][1];if(Me>=k.stops[Oe-1][0])return k.stops[Oe-1][1];const Fe=On(k.stops.map((k=>k[0])),Me),je=function(k,F,Me,Ae){const Oe=Ae-Me,Fe=k-Me;return 0===Oe?0:1===F?Fe/Oe:(Math.pow(F,Fe)-1)/(Math.pow(F,Oe)-1)}(Me,Ae,k.stops[Fe][0],k.stops[Fe+1][0]),qe=k.stops[Fe][1],pt=k.stops[Fe+1][1];let vt=tu[F.type]||Ui;if(k.colorSpace&&"rgb"!==k.colorSpace){const F=fp[k.colorSpace];vt=(k,Me)=>F.reverse(F.interpolate(F.forward(k),F.forward(Me),je))}return"function"==typeof qe.evaluate?{evaluate(...k){const F=qe.evaluate.apply(void 0,k),Me=pt.evaluate.apply(void 0,k);if(void 0!==F&&void 0!==Me)return vt(F,Me,je)}}:vt(qe,pt,je)}function Xi(k,F,Me){return"color"===F.type?Me=Ie.parse(Me):"formatted"===F.type?Me=Je.fromString(Me.toString()):"resolvedImage"===F.type?Me=tr.build(Me.toString()):hr(Me)===F.type||"enum"===F.type&&F.values[Me]||(Me=void 0),qi(Me,k.default,F.default)}yr.register(wp,{error:[{kind:"error"},[lu],(k,[F])=>{throw new sr(F.evaluate(k))}],typeof:[lu,[Bu],(k,[F])=>Ge(nr(F.evaluate(k)))],"to-rgba":[$e(su,4),[uu],(k,[F])=>F.evaluate(k).toRenderColor(null).toArray()],"to-hsla":[$e(su,4),[uu],(k,[F])=>F.evaluate(k).toRenderColor(null).toHslaArray()],rgb:[uu,[su,su,su],zi],rgba:[uu,[su,su,su,su],zi],hsl:[uu,[su,su,su],Ei],hsla:[uu,[su,su,su,su],Ei],has:{type:cu,overloads:[[[lu],(k,[F])=>ki(F.evaluate(k),k.properties())],[[lu,bu],(k,[F,Me])=>ki(F.evaluate(k),Me.evaluate(k))]]},get:{type:Bu,overloads:[[[lu],(k,[F])=>Ti(F.evaluate(k),k.properties())],[[lu,bu],(k,[F,Me])=>Ti(F.evaluate(k),Me.evaluate(k))]]},"feature-state":[Bu,[lu],(k,[F])=>Ti(F.evaluate(k),k.featureState||{})],properties:[bu,[],k=>k.properties()],"geometry-type":[lu,[],k=>k.geometryType()],id:[Bu,[],k=>k.id()],zoom:[su,[],k=>k.globals.zoom],pitch:[su,[],k=>k.globals.pitch||0],"distance-from-center":[su,[],k=>k.distanceFromCenter()],"measure-light":[su,[lu],(k,[F])=>k.measureLight(F.evaluate(k))],"heatmap-density":[su,[],k=>k.globals.heatmapDensity||0],"line-progress":[su,[],k=>k.globals.lineProgress||0],"raster-value":[su,[],k=>k.globals.rasterValue||0],"raster-particle-speed":[su,[],k=>k.globals.rasterParticleSpeed||0],"sky-radial-progress":[su,[],k=>k.globals.skyRadialProgress||0],accumulated:[Bu,[],k=>void 0===k.globals.accumulated?null:k.globals.accumulated],"+":[su,Bi(su),(k,F)=>{let Me=0;for(const Ae of F)Me+=Ae.evaluate(k);return Me}],"*":[su,Bi(su),(k,F)=>{let Me=1;for(const Ae of F)Me*=Ae.evaluate(k);return Me}],"-":{type:su,overloads:[[[su,su],(k,[F,Me])=>F.evaluate(k)-Me.evaluate(k)],[[su],(k,[F])=>-F.evaluate(k)]]},"/":[su,[su,su],(k,[F,Me])=>F.evaluate(k)/Me.evaluate(k)],"%":[su,[su,su],(k,[F,Me])=>F.evaluate(k)%Me.evaluate(k)],ln2:[su,[],()=>Math.LN2],pi:[su,[],()=>Math.PI],e:[su,[],()=>Math.E],"^":[su,[su,su],(k,[F,Me])=>Math.pow(F.evaluate(k),Me.evaluate(k))],sqrt:[su,[su],(k,[F])=>Math.sqrt(F.evaluate(k))],log10:[su,[su],(k,[F])=>Math.log(F.evaluate(k))/Math.LN10],ln:[su,[su],(k,[F])=>Math.log(F.evaluate(k))],log2:[su,[su],(k,[F])=>Math.log(F.evaluate(k))/Math.LN2],sin:[su,[su],(k,[F])=>Math.sin(F.evaluate(k))],cos:[su,[su],(k,[F])=>Math.cos(F.evaluate(k))],tan:[su,[su],(k,[F])=>Math.tan(F.evaluate(k))],asin:[su,[su],(k,[F])=>Math.asin(F.evaluate(k))],acos:[su,[su],(k,[F])=>Math.acos(F.evaluate(k))],atan:[su,[su],(k,[F])=>Math.atan(F.evaluate(k))],min:[su,Bi(su),(k,F)=>Math.min(...F.map((F=>F.evaluate(k))))],max:[su,Bi(su),(k,F)=>Math.max(...F.map((F=>F.evaluate(k))))],abs:[su,[su],(k,[F])=>Math.abs(F.evaluate(k))],round:[su,[su],(k,[F])=>{const Me=F.evaluate(k);return Me<0?-Math.round(-Me):Math.round(Me)}],floor:[su,[su],(k,[F])=>Math.floor(F.evaluate(k))],ceil:[su,[su],(k,[F])=>Math.ceil(F.evaluate(k))],"filter-==":[cu,[lu,Bu],(k,[F,Me])=>k.properties()[F.value]===Me.value],"filter-id-==":[cu,[Bu],(k,[F])=>k.id()===F.value],"filter-type-==":[cu,[lu],(k,[F])=>k.geometryType()===F.value],"filter-<":[cu,[lu,Bu],(k,[F,Me])=>{const Ae=k.properties()[F.value],Oe=Me.value;return typeof Ae==typeof Oe&&Ae<Oe}],"filter-id-<":[cu,[Bu],(k,[F])=>{const Me=k.id(),Ae=F.value;return typeof Me==typeof Ae&&Me<Ae}],"filter->":[cu,[lu,Bu],(k,[F,Me])=>{const Ae=k.properties()[F.value],Oe=Me.value;return typeof Ae==typeof Oe&&Ae>Oe}],"filter-id->":[cu,[Bu],(k,[F])=>{const Me=k.id(),Ae=F.value;return typeof Me==typeof Ae&&Me>Ae}],"filter-<=":[cu,[lu,Bu],(k,[F,Me])=>{const Ae=k.properties()[F.value],Oe=Me.value;return typeof Ae==typeof Oe&&Ae<=Oe}],"filter-id-<=":[cu,[Bu],(k,[F])=>{const Me=k.id(),Ae=F.value;return typeof Me==typeof Ae&&Me<=Ae}],"filter->=":[cu,[lu,Bu],(k,[F,Me])=>{const Ae=k.properties()[F.value],Oe=Me.value;return typeof Ae==typeof Oe&&Ae>=Oe}],"filter-id->=":[cu,[Bu],(k,[F])=>{const Me=k.id(),Ae=F.value;return typeof Me==typeof Ae&&Me>=Ae}],"filter-has":[cu,[Bu],(k,[F])=>F.value in k.properties()],"filter-has-id":[cu,[],k=>null!==k.id()&&void 0!==k.id()],"filter-type-in":[cu,[$e(lu)],(k,[F])=>F.value.indexOf(k.geometryType())>=0],"filter-id-in":[cu,[$e(Bu)],(k,[F])=>F.value.indexOf(k.id())>=0],"filter-in-small":[cu,[lu,$e(Bu)],(k,[F,Me])=>Me.value.indexOf(k.properties()[F.value])>=0],"filter-in-large":[cu,[lu,$e(Bu)],(k,[F,Me])=>function(k,F,Me,Ae){for(;Me<=Ae;){const Oe=Me+Ae>>1;if(F[Oe]===k)return!0;F[Oe]>k?Ae=Oe-1:Me=Oe+1}return!1}(k.properties()[F.value],Me.value,0,Me.value.length-1)],all:{type:cu,overloads:[[[cu,cu],(k,[F,Me])=>F.evaluate(k)&&Me.evaluate(k)],[Bi(cu),(k,F)=>{for(const Me of F)if(!Me.evaluate(k))return!1;return!0}]]},any:{type:cu,overloads:[[[cu,cu],(k,[F,Me])=>F.evaluate(k)||Me.evaluate(k)],[Bi(cu),(k,F)=>{for(const Me of F)if(Me.evaluate(k))return!0;return!1}]]},"!":[cu,[cu],(k,[F])=>!F.evaluate(k)],"is-supported-script":[cu,[lu],(k,[F])=>{const Me=k.globals&&k.globals.isSupportedScript;return!Me||Me(F.evaluate(k))}],upcase:[lu,[lu],(k,[F])=>F.evaluate(k).toUpperCase()],downcase:[lu,[lu],(k,[F])=>F.evaluate(k).toLowerCase()],concat:[lu,Bi(Bu),(k,F)=>F.map((F=>ir(F.evaluate(k)))).join("")],"resolved-locale":[lu,[Uu],(k,[F])=>F.evaluate(k).resolvedLocale()],random:[su,[su,su,Bu],(k,F)=>{const[Me,Ae,Oe]=F.map((F=>F.evaluate(k)));if(Me>Ae)return Me;if(Me===Ae)return Me;let Fe;if("string"==typeof Oe)Fe=function(k){let F=0;if(0===k.length)return F;for(let Me=0;Me<k.length;Me++)F=(F<<5)-F+k.charCodeAt(Me),F|=0;return F}(Oe);else{if("number"!=typeof Oe)throw new sr(`Invalid seed input: ${Oe}`);Fe=Oe}return Me+Ii(Fe)()*(Ae-Me)}]});class Zi{constructor(k,F,Me,Ae){this.expression=k,this._warningHistory={},this._evaluator=new mr(Me,Ae),this._defaultValue=F?function(k){return"color"===k.type&&(Ni(k.default)||Array.isArray(k.default))?new Ie(0,0,0,0):"color"===k.type?Ie.parse(k.default)||null:void 0===k.default?null:k.default}(F):null,this._enumValues=F&&"enum"===F.type?F.values:null,this.configDependencies=Vn(k)}evaluateWithoutErrorHandling(k,F,Me,Ae,Oe,Fe,je,qe){return this._evaluator.globals=k,this._evaluator.feature=F,this._evaluator.featureState=Me,this._evaluator.canonical=Ae||null,this._evaluator.availableImages=Oe||null,this._evaluator.formattedSection=Fe,this._evaluator.featureTileCoord=je||null,this._evaluator.featureDistanceData=qe||null,this.expression.evaluate(this._evaluator)}evaluate(k,F,Me,Ae,Oe,Fe,je,qe){this._evaluator.globals=k,this._evaluator.feature=F||null,this._evaluator.featureState=Me||null,this._evaluator.canonical=Ae||null,this._evaluator.availableImages=Oe||null,this._evaluator.formattedSection=Fe||null,this._evaluator.featureTileCoord=je||null,this._evaluator.featureDistanceData=qe||null;try{const k=this.expression.evaluate(this._evaluator);if(null==k||"number"==typeof k&&k!=k)return this._defaultValue;if(this._enumValues&&!(k in this._enumValues))throw new sr(`Expected value to be one of ${Object.keys(this._enumValues).map((k=>JSON.stringify(k))).join(", ")}, but found ${JSON.stringify(k)} instead.`);return k}catch(k){return this._warningHistory[k.message]||(this._warningHistory[k.message]=!0,"undefined"!=typeof console&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${k.message}`)),this._defaultValue}}}function Hi(k){return Array.isArray(k)&&k.length>0&&"string"==typeof k[0]&&k[0]in wp}function Wi(k,F,Me,Ae){const Oe=new Cd(wp,[],F?function(k){const F={color:uu,string:lu,number:su,enum:lu,boolean:cu,formatted:ju,resolvedImage:qu};return"array"===k.type?$e(F[k.value]||Bu,k.length):F[k.type]}(F):void 0,void 0,void 0,Me,Ae),Fe=Oe.parse(k,void 0,void 0,void 0,F&&"string"===F.type?{typeAnnotation:"coerce"}:void 0);return Fe?Vi(new Zi(Fe,F,Me,Ae)):Ci(Oe.errors)}class Ki{constructor(k,F,Me,Ae){this.kind=k,this._styleExpression=F,this.isLightConstant=Me,this.isLineProgressConstant=Ae,this.isStateDependent="constant"!==k&&!Bn(F.expression),this.configDependencies=Vn(F.expression)}evaluateWithoutErrorHandling(k,F,Me,Ae,Oe,Fe){return this._styleExpression.evaluateWithoutErrorHandling(k,F,Me,Ae,Oe,Fe)}evaluate(k,F,Me,Ae,Oe,Fe){return this._styleExpression.evaluate(k,F,Me,Ae,Oe,Fe)}}class Ji{constructor(k,F,Me,Ae,Oe,Fe){this.kind=k,this.zoomStops=Me,this._styleExpression=F,this.isStateDependent="camera"!==k&&!Bn(F.expression),this.isLightConstant=Oe,this.isLineProgressConstant=Fe,this.configDependencies=Vn(F.expression),this.interpolationType=Ae}evaluateWithoutErrorHandling(k,F,Me,Ae,Oe,Fe){return this._styleExpression.evaluateWithoutErrorHandling(k,F,Me,Ae,Oe,Fe)}evaluate(k,F,Me,Ae,Oe,Fe){return this._styleExpression.evaluate(k,F,Me,Ae,Oe,Fe)}interpolationFactor(k,F,Me){return this.interpolationType?ai.interpolationFactor(this.interpolationType,k,F,Me):0}}function Qi(k,F,Me,Ae){if("error"===(k=Wi(k,F,Me,Ae)).result)return k;const Oe=k.value.expression,Fe=Tn(Oe);if(!Fe&&!Li(F))return Ci([new Be("","data expressions not supported")]);const je=Cn(Oe,["zoom","pitch","distance-from-center"]);if(!je&&!Fi(F))return Ci([new Be("","zoom expressions not supported")]);const qe=Cn(Oe,["measure-light"]);if(!qe&&!Ri(F))return Ci([new Be("","measure-light expression not supported")]);const pt=Cn(Oe,["line-progress"]);if(!pt&&!function(k){return Di(k.expression,"line-progress")}(F))return Ci([new Be("","line-progress expression not supported")]);const vt=F.expression&&F.expression.relaxZoomRestriction,Ut=ea(Oe);return Ut||je||vt?Ut instanceof Be?Ci([Ut]):Ut instanceof ai&&!Oi(F)?Ci([new Be("",'"interpolate" expressions cannot be used with this property')]):Vi(Ut?new Ji(Fe&&pt?"camera":"composite",k.value,Ut.labels,Ut instanceof ai?Ut.interpolation:void 0,qe,pt):new Ki(Fe&&pt?"constant":"source",k.value,qe,pt)):Ci([new Be("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class ta{constructor(k,F){this._parameters=k,this._specification=F,Te(this,ji(this._parameters,this._specification))}static deserialize(k){return new ta(k._parameters,k._specification)}static serialize(k){return{_parameters:k._parameters,_specification:k._specification}}}function ea(k){let F=null;if(k instanceof li)F=ea(k.result);else if(k instanceof oi){for(const Me of k.args)if(F=ea(Me),F)break}else(k instanceof Nn||k instanceof ai)&&k.input instanceof yr&&"zoom"===k.input.name&&(F=k);return F instanceof Be||k.eachChild((k=>{const Me=ea(k);Me instanceof Be?F=Me:F&&Me&&F!==Me&&(F=new Be("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),F}var Mp,Ip,Cp=function(){if(Ip)return Mp;Ip=1,Mp=e;var F=3;function e(Me,Ae,Oe){var Fe=(this||k).cells=[];if(Me instanceof ArrayBuffer){(this||k).arrayBuffer=Me;var je=new Int32Array((this||k).arrayBuffer);Me=je[0],(this||k).d=(Ae=je[1])+2*(Oe=je[2]);for(var qe=0;qe<(this||k).d*(this||k).d;qe++){var pt=je[F+qe],vt=je[F+qe+1];Fe.push(pt===vt?null:je.subarray(pt,vt))}var Ut=je[F+Fe.length+1];(this||k).keys=je.subarray(je[F+Fe.length],Ut),(this||k).bboxes=je.subarray(Ut),(this||k).insert=(this||k)._insertReadonly}else{(this||k).d=Ae+2*Oe;for(var xi=0;xi<(this||k).d*(this||k).d;xi++)Fe.push([]);(this||k).keys=[],(this||k).bboxes=[]}(this||k).n=Ae,(this||k).extent=Me,(this||k).padding=Oe,(this||k).scale=Ae/Me,(this||k).uid=0;var vi=Oe/Ae*Me;(this||k).min=-vi,(this||k).max=Me+vi}return e.prototype.insert=function(F,Me,Ae,Oe,Fe){this._forEachCell(Me,Ae,Oe,Fe,(this||k)._insertCell,(this||k).uid++),(this||k).keys.push(F),(this||k).bboxes.push(Me),(this||k).bboxes.push(Ae),(this||k).bboxes.push(Oe),(this||k).bboxes.push(Fe)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(F,Me,Ae,Oe,Fe,je){(this||k).cells[Fe].push(je)},e.prototype.query=function(F,Me,Ae,Oe,Fe){var je=(this||k).min,qe=(this||k).max;if(F<=je&&Me<=je&&qe<=Ae&&qe<=Oe&&!Fe)return Array.prototype.slice.call((this||k).keys);var pt=[];return this._forEachCell(F,Me,Ae,Oe,(this||k)._queryCell,pt,{},Fe),pt},e.prototype._queryCell=function(F,Me,Ae,Oe,Fe,je,qe,pt){var vt=(this||k).cells[Fe];if(null!==vt)for(var Ut=(this||k).keys,xi=(this||k).bboxes,vi=0;vi<vt.length;vi++){var bi=vt[vi];if(void 0===qe[bi]){var wi=4*bi;(pt?pt(xi[wi+0],xi[wi+1],xi[wi+2],xi[wi+3]):F<=xi[wi+2]&&Me<=xi[wi+3]&&Ae>=xi[wi+0]&&Oe>=xi[wi+1])?(qe[bi]=!0,je.push(Ut[bi])):qe[bi]=!1}}},e.prototype._forEachCell=function(F,Me,Ae,Oe,Fe,je,qe,pt){for(var vt=this._convertToCellCoord(F),Ut=this._convertToCellCoord(Me),xi=this._convertToCellCoord(Ae),vi=this._convertToCellCoord(Oe),bi=vt;bi<=xi;bi++)for(var wi=Ut;wi<=vi;wi++){var Mi=(this||k).d*wi+bi;if((!pt||pt(this._convertFromCellCoord(bi),this._convertFromCellCoord(wi),this._convertFromCellCoord(bi+1),this._convertFromCellCoord(wi+1)))&&Fe.call(this||k,F,Me,Ae,Oe,Mi,je,qe,pt))return}},e.prototype._convertFromCellCoord=function(F){return(F-(this||k).padding)/(this||k).scale},e.prototype._convertToCellCoord=function(F){return Math.max(0,Math.min((this||k).d-1,Math.floor(F*(this||k).scale)+(this||k).padding))},e.prototype.toArrayBuffer=function(){if((this||k).arrayBuffer)return(this||k).arrayBuffer;for(var Me=(this||k).cells,Ae=F+(this||k).cells.length+1+1,Oe=0,Fe=0;Fe<(this||k).cells.length;Fe++)Oe+=(this||k).cells[Fe].length;var je=new Int32Array(Ae+Oe+(this||k).keys.length+(this||k).bboxes.length);je[0]=(this||k).extent,je[1]=(this||k).n,je[2]=(this||k).padding;for(var qe=Ae,pt=0;pt<Me.length;pt++){var vt=Me[pt];je[F+pt]=qe,je.set(vt,qe),qe+=vt.length}return je[F+Me.length]=qe,je.set((this||k).keys,qe),je[F+Me.length+1]=qe+=(this||k).keys.length,je.set((this||k).bboxes,qe),qe+=(this||k).bboxes.length,je.buffer},Mp}(),Pp=e(Cp);const Rp={};function oa(k,F,Me={}){Object.defineProperty(k,"_classRegistryKey",{value:F,writable:!1}),Rp[F]={klass:k,omit:Me.omit||[]}}oa(Object,"Object"),Pp.serialize=function(k,F){const Me=k.toArrayBuffer();return F&&F.add(Me),{buffer:Me}},Pp.deserialize=function(k){return new Pp(k.buffer)},Object.defineProperty(Pp,"name",{value:"Grid"}),oa(Pp,"Grid"),"undefined"!=typeof DOMMatrix&&oa(DOMMatrix,"DOMMatrix"),oa(Ie,"Color"),oa(Error,"Error"),oa(Je,"Formatted"),oa(Ke,"FormattedSection"),oa(ee,"AJAXError"),oa(tr,"ResolvedImage"),oa(ta,"StylePropertyFunction"),oa(Zi,"StyleExpression",{omit:["_evaluator"]}),oa(Qe,"ImageIdWithOptions"),oa(Ji,"ZoomDependentExpression"),oa(Ki,"ZoomConstantExpression"),oa(yr,"CompoundExpression",{omit:["_evaluate"]});for(const k in wp)Rp[wp[k]._classRegistryKey]||oa(wp[k],`Expression${k}`);function la(k){return k&&"undefined"!=typeof ArrayBuffer&&(k instanceof ArrayBuffer||k.constructor&&"ArrayBuffer"===k.constructor.name)}function ua(k){return self.ImageBitmap&&k instanceof ImageBitmap}function ca(k,F){if(null==k||"boolean"==typeof k||"number"==typeof k||"string"==typeof k||k instanceof Boolean||k instanceof Number||k instanceof String||k instanceof Date||k instanceof RegExp)return k;if(la(k)||ua(k))return F&&F.add(k),k;if(ArrayBuffer.isView(k))return F&&F.add(k.buffer),k;if(k instanceof ImageData)return F&&F.add(k.data.buffer),k;if(Array.isArray(k)){const Me=[];for(const Ae of k)Me.push(ca(Ae,F));return Me}if(k instanceof Map){const F={$name:"Map"};for(const[Me,Ae]of k.entries())F[Me]=ca(Ae);return F}if(k instanceof Set){const F={$name:"Set"};let Me=0;for(const Ae of k.values())F[++Me]=ca(Ae);return F}if("object"==typeof k){const Me=k.constructor,Ae=Me._classRegistryKey;if(!Ae)throw new Error(`Can't serialize object of unregistered class "${Ae}".`);const Oe=Me.serialize?Me.serialize(k,F):{};if(!Me.serialize){for(const Me in k)k.hasOwnProperty(Me)&&(Rp[Ae].omit.indexOf(Me)>=0||(Oe[Me]=ca(k[Me],F)));k instanceof Error&&(Oe.message=k.message)}if(Oe.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==Ae&&(Oe.$name=Ae),Oe}throw new Error("can't serialize object of type "+typeof k)}function ha(k){if(null==k||"boolean"==typeof k||"number"==typeof k||"string"==typeof k||k instanceof Boolean||k instanceof Number||k instanceof String||k instanceof Date||k instanceof RegExp||la(k)||ua(k)||ArrayBuffer.isView(k)||k instanceof ImageData)return k;if(Array.isArray(k))return k.map(ha);if("object"==typeof k){const F=k.$name||"Object";if("Map"===F){const F=new Map;for(const Me of Object.keys(k))"$name"!==Me&&F.set(Me,ha(k[Me]));return F}if("Set"===F){const F=new Set;for(const Me of Object.keys(k))"$name"!==Me&&F.add(ha(k[Me]));return F}const{klass:Me}=Rp[F];if(!Me)throw new Error(`Can't deserialize unregistered class "${F}".`);if(Me.deserialize)return Me.deserialize(k);const Ae=Object.create(Me.prototype);for(const F of Object.keys(k))"$name"!==F&&(Ae[F]=ha(k[F]));return Ae}throw new Error("can't deserialize object of type "+typeof k)}const Op={"Latin-1 Supplement":k=>k>=128&&k<=255,Arabic:k=>k>=1536&&k<=1791,"Arabic Supplement":k=>k>=1872&&k<=1919,"Arabic Extended-A":k=>k>=2208&&k<=2303,"Hangul Jamo":k=>k>=4352&&k<=4607,"Unified Canadian Aboriginal Syllabics":k=>k>=5120&&k<=5759,Khmer:k=>k>=6016&&k<=6143,"Unified Canadian Aboriginal Syllabics Extended":k=>k>=6320&&k<=6399,"General Punctuation":k=>k>=8192&&k<=8303,"Letterlike Symbols":k=>k>=8448&&k<=8527,"Number Forms":k=>k>=8528&&k<=8591,"Miscellaneous Technical":k=>k>=8960&&k<=9215,"Control Pictures":k=>k>=9216&&k<=9279,"Optical Character Recognition":k=>k>=9280&&k<=9311,"Enclosed Alphanumerics":k=>k>=9312&&k<=9471,"Geometric Shapes":k=>k>=9632&&k<=9727,"Miscellaneous Symbols":k=>k>=9728&&k<=9983,"Miscellaneous Symbols and Arrows":k=>k>=11008&&k<=11263,"CJK Radicals Supplement":k=>k>=11904&&k<=12031,"Kangxi Radicals":k=>k>=12032&&k<=12255,"Ideographic Description Characters":k=>k>=12272&&k<=12287,"CJK Symbols and Punctuation":k=>k>=12288&&k<=12351,Hiragana:k=>k>=12352&&k<=12447,Katakana:k=>k>=12448&&k<=12543,Bopomofo:k=>k>=12544&&k<=12591,"Hangul Compatibility Jamo":k=>k>=12592&&k<=12687,Kanbun:k=>k>=12688&&k<=12703,"Bopomofo Extended":k=>k>=12704&&k<=12735,"CJK Strokes":k=>k>=12736&&k<=12783,"Katakana Phonetic Extensions":k=>k>=12784&&k<=12799,"Enclosed CJK Letters and Months":k=>k>=12800&&k<=13055,"CJK Compatibility":k=>k>=13056&&k<=13311,"CJK Unified Ideographs Extension A":k=>k>=13312&&k<=19903,"Yijing Hexagram Symbols":k=>k>=19904&&k<=19967,"CJK Unified Ideographs":k=>k>=19968&&k<=40959,"Yi Syllables":k=>k>=40960&&k<=42127,"Yi Radicals":k=>k>=42128&&k<=42191,"Hangul Jamo Extended-A":k=>k>=43360&&k<=43391,"Hangul Syllables":k=>k>=44032&&k<=55215,"Hangul Jamo Extended-B":k=>k>=55216&&k<=55295,"Private Use Area":k=>k>=57344&&k<=63743,"CJK Compatibility Ideographs":k=>k>=63744&&k<=64255,"Arabic Presentation Forms-A":k=>k>=64336&&k<=65023,"Vertical Forms":k=>k>=65040&&k<=65055,"CJK Compatibility Forms":k=>k>=65072&&k<=65103,"Small Form Variants":k=>k>=65104&&k<=65135,"Arabic Presentation Forms-B":k=>k>=65136&&k<=65279,"Halfwidth and Fullwidth Forms":k=>k>=65280&&k<=65519,Osage:k=>k>=66736&&k<=66815,"CJK Unified Ideographs Extension B":k=>k>=131072&&k<=173791};function fa(k){for(const F of k)if(ya(F.charCodeAt(0)))return!0;return!1}function da(k){for(const F of k)if(!ma(F.charCodeAt(0)))return!1;return!0}function ma(k){return!(Op.Arabic(k)||Op["Arabic Supplement"](k)||Op["Arabic Extended-A"](k)||Op["Arabic Presentation Forms-A"](k)||Op["Arabic Presentation Forms-B"](k))}function ya(k){return!(746!==k&&747!==k&&(k<4352||!(Op["Bopomofo Extended"](k)||Op.Bopomofo(k)||Op["CJK Compatibility Forms"](k)&&!(k>=65097&&k<=65103)||Op["CJK Compatibility Ideographs"](k)||Op["CJK Compatibility"](k)||Op["CJK Radicals Supplement"](k)||Op["CJK Strokes"](k)||!(!Op["CJK Symbols and Punctuation"](k)||k>=12296&&k<=12305||k>=12308&&k<=12319||12336===k)||Op["CJK Unified Ideographs Extension A"](k)||Op["CJK Unified Ideographs"](k)||Op["Enclosed CJK Letters and Months"](k)||Op["Hangul Compatibility Jamo"](k)||Op["Hangul Jamo Extended-A"](k)||Op["Hangul Jamo Extended-B"](k)||Op["Hangul Jamo"](k)||Op["Hangul Syllables"](k)||Op.Hiragana(k)||Op["Ideographic Description Characters"](k)||Op.Kanbun(k)||Op["Kangxi Radicals"](k)||Op["Katakana Phonetic Extensions"](k)||Op.Katakana(k)&&12540!==k||!(!Op["Halfwidth and Fullwidth Forms"](k)||65288===k||65289===k||65293===k||k>=65306&&k<=65310||65339===k||65341===k||65343===k||k>=65371&&k<=65503||65507===k||k>=65512&&k<=65519)||!(!Op["Small Form Variants"](k)||k>=65112&&k<=65118||k>=65123&&k<=65126)||Op["Unified Canadian Aboriginal Syllabics"](k)||Op["Unified Canadian Aboriginal Syllabics Extended"](k)||Op["Vertical Forms"](k)||Op["Yijing Hexagram Symbols"](k)||Op["Yi Syllables"](k)||Op["Yi Radicals"](k))))}function ga(k){return!(ya(k)||function(k){return!!(Op["Latin-1 Supplement"](k)&&(167===k||169===k||174===k||177===k||188===k||189===k||190===k||215===k||247===k)||Op["General Punctuation"](k)&&(8214===k||8224===k||8225===k||8240===k||8241===k||8251===k||8252===k||8258===k||8263===k||8264===k||8265===k||8273===k)||Op["Letterlike Symbols"](k)||Op["Number Forms"](k)||Op["Miscellaneous Technical"](k)&&(k>=8960&&k<=8967||k>=8972&&k<=8991||k>=8996&&k<=9e3||9003===k||k>=9085&&k<=9114||k>=9150&&k<=9165||9167===k||k>=9169&&k<=9179||k>=9186&&k<=9215)||Op["Control Pictures"](k)&&9251!==k||Op["Optical Character Recognition"](k)||Op["Enclosed Alphanumerics"](k)||Op["Geometric Shapes"](k)||Op["Miscellaneous Symbols"](k)&&!(k>=9754&&k<=9759)||Op["Miscellaneous Symbols and Arrows"](k)&&(k>=11026&&k<=11055||k>=11088&&k<=11097||k>=11192&&k<=11243)||Op["CJK Symbols and Punctuation"](k)||Op.Katakana(k)||Op["Private Use Area"](k)||Op["CJK Compatibility Forms"](k)||Op["Small Form Variants"](k)||Op["Halfwidth and Fullwidth Forms"](k)||8734===k||8756===k||8757===k||k>=9984&&k<=10087||k>=10102&&k<=10131||65532===k||65533===k)}(k))}function xa(k){return k>=1424&&k<=2303||Op["Arabic Presentation Forms-A"](k)||Op["Arabic Presentation Forms-B"](k)}function va(k,F){return!(!F&&xa(k)||k>=2304&&k<=3583||k>=3840&&k<=4255||Op.Khmer(k))}function ba(k){for(const F of k)if(xa(F.charCodeAt(0)))return!0;return!1}const Np="deferred",Up="loading",jp="loaded";let Gp=null,qp="unavailable",Zp=null;const Pa=function(k){k&&"string"==typeof k&&k.indexOf("NetworkError")>-1&&(qp="error"),Gp&&Gp(k)};function za(){Hp.fire(new xe("pluginStateChange",{pluginStatus:qp,pluginURL:Zp}))}const Hp=new we,ka=function(){return qp},Ta=function(){if(qp!==Np||!Zp)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");qp=Up,za(),Zp&&ie({url:Zp},(k=>{k?Pa(k):(qp=jp,za())}))},$p={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>qp===jp||null!=$p.applyArabicShaping,isLoading:()=>qp===Up,setState(k){qp=k.pluginStatus,Zp=k.pluginURL},isParsed:()=>null!=$p.applyArabicShaping&&null!=$p.processBidirectionalText&&null!=$p.processStyledBidirectionalText,getPluginURL:()=>Zp};class Va{constructor(k,F){this.zoom=k,F?(this.now=F.now,this.fadeDuration=F.fadeDuration,this.transition=F.transition,this.pitch=F.pitch,this.brightness=F.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(k){return function(k,F){for(const Me of k)if(!va(Me.charCodeAt(0),F))return!1;return!0}(k,$p.isLoaded())}}class Ca{constructor(k,F,Me,Ae){this.property=k,this.value=F,this.expression=function(k,F,Me,Ae){if(Ni(k))return new ta(k,F);if(Hi(k)||Array.isArray(k)&&k.length>0){const Oe=Qi(k,F,Me,Ae);if("error"===Oe.result)throw new Error(Oe.value.map((k=>`${k.key}: ${k.message}`)).join(", "));return Oe.value}{let Me=k;return"string"==typeof k&&"color"===F.type&&(Me=Ie.parse(k)),{kind:"constant",configDependencies:new Set,evaluate:()=>Me}}}(void 0===F?k.specification.default:F,k.specification,Me,Ae)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(k,F,Me){return this.property.possiblyEvaluate(this,k,F,Me)}}class Da{constructor(k,F,Me){this.property=k,this.value=new Ca(k,void 0,F,Me)}transitioned(k,F){return new Ra(this.property,this.value,F,nt({},k.transition,this.transition),k.now)}untransitioned(){return new Ra(this.property,this.value,null,{},0)}}class La{constructor(k,F,Me){this._properties=k,this._values=Object.create(k.defaultTransitionablePropertyValues),this._scope=F,this._options=Me,this.configDependencies=new Set}getValue(k){return ht(this._values[k].value.value)}setValue(k,F){this._values.hasOwnProperty(k)||(this._values[k]=new Da(this._values[k].property,this._scope,this._options)),this._values[k].value=new Ca(this._values[k].property,null===F?void 0:ht(F),this._scope,this._options),this._values[k].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[k].value.expression.configDependencies]))}setTransitionOrValue(k,F){F&&(this._options=F);const Me=this._properties.properties;if(k)for(const F in k){const Ae=k[F];if(lt(F,"-transition")){const k=F.slice(0,-11);Me[k]&&this.setTransition(k,Ae)}else Me.hasOwnProperty(F)&&this.setValue(F,Ae)}}getTransition(k){return ht(this._values[k].transition)}setTransition(k,F){this._values.hasOwnProperty(k)||(this._values[k]=new Da(this._values[k].property)),this._values[k].transition=ht(F)||void 0}serialize(){const k={};for(const F of Object.keys(this._values)){const Me=this.getValue(F);void 0!==Me&&(k[F]=Me);const Ae=this.getTransition(F);void 0!==Ae&&(k[`${F}-transition`]=Ae)}return k}transitioned(k,F){const Me=new Fa(this._properties);for(const Ae of Object.keys(this._values))Me._values[Ae]=this._values[Ae].transitioned(k,F._values[Ae]);return Me}untransitioned(){const k=new Fa(this._properties);for(const F of Object.keys(this._values))k._values[F]=this._values[F].untransitioned();return k}}class Ra{constructor(k,F,Me,Ae,Oe){const Fe=Ae.delay||0,je=Ae.duration||0;Oe=Oe||0,this.property=k,this.value=F,this.begin=Oe+Fe,this.end=this.begin+je,k.specification.transition&&(Ae.delay||Ae.duration)&&(this.prior=Me)}possiblyEvaluate(k,F,Me){const Ae=k.now||0,Oe=this.value.possiblyEvaluate(k,F,Me),Fe=this.prior;if(Fe){if(Ae>this.end)return this.prior=null,Oe;if(this.value.isDataDriven())return this.prior=null,Oe;if(Ae<this.begin)return Fe.possiblyEvaluate(k,F,Me);{const je=(Ae-this.begin)/(this.end-this.begin);return this.property.interpolate(Fe.possiblyEvaluate(k,F,Me),Oe,W(je))}}return Oe}}class Fa{constructor(k){this._properties=k,this._values=Object.create(k.defaultTransitioningPropertyValues)}possiblyEvaluate(k,F,Me){const Ae=new Ua(this._properties);for(const Oe of Object.keys(this._values))Ae._values[Oe]=this._values[Oe].possiblyEvaluate(k,F,Me);return Ae}hasTransition(){for(const k of Object.keys(this._values))if(this._values[k].prior)return!0;return!1}}class Oa{constructor(k,F,Me){this._properties=k,this._values=Object.create(k.defaultPropertyValues),this._scope=F,this._options=Me,this.configDependencies=new Set}getValue(k){return ht(this._values[k].value)}setValue(k,F){this._values[k]=new Ca(this._values[k].property,null===F?void 0:ht(F),this._scope,this._options),this._values[k].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[k].expression.configDependencies]))}serialize(){const k={};for(const F of Object.keys(this._values)){const Me=this.getValue(F);void 0!==Me&&(k[F]=Me)}return k}possiblyEvaluate(k,F,Me){const Ae=new Ua(this._properties);for(const Oe of Object.keys(this._values))Ae._values[Oe]=this._values[Oe].possiblyEvaluate(k,F,Me);return Ae}}class Na{constructor(k,F,Me){this.property=k,this.value=F,this.parameters=Me}isConstant(){return"constant"===this.value.kind}constantOr(k){return"constant"===this.value.kind?this.value.value:k}evaluate(k,F,Me,Ae){return this.property.evaluate(this.value,this.parameters,k,F,Me,Ae)}}class Ua{constructor(k){this._properties=k,this._values=Object.create(k.defaultPossiblyEvaluatedValues)}get(k){return this._values[k]}}class ja{constructor(k){this.specification=k}possiblyEvaluate(k,F){return k.expression.evaluate(F)}interpolate(k,F,Me){const Ae=tu[this.specification.type];return Ae?Ae(k,F,Me):k}}class qa{constructor(k,F){this.specification=k,this.overrides=F}possiblyEvaluate(k,F,Me,Ae){return new Na(this,"constant"===k.expression.kind||"camera"===k.expression.kind?{kind:"constant",value:k.expression.evaluate(F,null,{},Me,Ae)}:k.expression,F)}interpolate(k,F,Me){if("constant"!==k.value.kind||"constant"!==F.value.kind)return k;if(void 0===k.value.value||void 0===F.value.value)return new Na(this,{kind:"constant",value:void 0},k.parameters);const Ae=tu[this.specification.type];return Ae?new Na(this,{kind:"constant",value:Ae(k.value.value,F.value.value,Me)},k.parameters):k}evaluate(k,F,Me,Ae,Oe,Fe){return"constant"===k.kind?k.value:k.evaluate(F,Me,Ae,Oe,Fe)}}class $a{constructor(k){this.specification=k}possiblyEvaluate(k,F,Me,Ae){return!!k.expression.evaluate(F,null,{},Me,Ae)}interpolate(){return!1}}class Ga{constructor(k){this.properties=k,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const F=new Va(0,{});for(const Me in k){const Ae=k[Me];Ae.specification.overridable&&this.overridableProperties.push(Me);const Oe=this.defaultPropertyValues[Me]=new Ca(Ae,void 0),Fe=this.defaultTransitionablePropertyValues[Me]=new Da(Ae);this.defaultTransitioningPropertyValues[Me]=Fe.untransitioned(),this.defaultPossiblyEvaluatedValues[Me]=Oe.possiblyEvaluate(F)}}}oa(qa,"DataDrivenProperty"),oa(ja,"DataConstantProperty"),oa($a,"ColorRampProperty");var Xp=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"type":"string","required":true},"properties":{"type":"selectorProperty","required":false},"featureNamespace":{"type":"string","required":false}},"selectorProperty":{"experimental":true,"*":{"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Xa(k){return k instanceof Number||k instanceof String||k instanceof Boolean?k.valueOf():k}function Za(k){if(Array.isArray(k))return k.map(Za);if(k instanceof Object&&!(k instanceof Number||k instanceof String||k instanceof Boolean)){const F={};for(const Me in k)F[Me]=Za(k[Me]);return F}return Xa(k)}function Ha(k){if(!0===k||!1===k)return!0;if(!Array.isArray(k)||0===k.length)return!1;switch(k[0]){case"has":return k.length>=2&&"$id"!==k[1]&&"$type"!==k[1];case"in":return k.length>=3&&("string"!=typeof k[1]||Array.isArray(k[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==k.length||Array.isArray(k[1])||Array.isArray(k[2]);case"any":case"all":for(const F of k.slice(1))if(!Ha(F)&&"boolean"!=typeof F)return!1;return!0;default:return!0}}function Wa(k,F="",Me=null,Ae="fill"){if(null==k)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ha(k)||(k=ns(k));const Oe=k;let Fe=!0;try{Fe=function(k){if(!Qa(k))return k;let F=Za(k);return Ja(F),F=Ka(F),F}(Oe)}catch(k){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(Oe,null,2)}\n        `)}let je=null,qe=null;if("background"!==Ae&&"sky"!==Ae&&"slot"!==Ae){qe=Xp[`filter_${Ae}`];const k=Wi(Fe,qe,F,Me);if("error"===k.result)throw new Error(k.value.map((k=>`${k.key}: ${k.message}`)).join(", "));je=(F,Me,Ae)=>k.value.evaluate(F,Me,{},Ae)}let pt=null,vt=null;if(Fe!==Oe){const k=Wi(Oe,qe,F,Me);if("error"===k.result)throw new Error(k.value.map((k=>`${k.key}: ${k.message}`)).join(", "));pt=(F,Me,Ae,Oe,Fe)=>k.value.evaluate(F,Me,{},Ae,void 0,void 0,Oe,Fe),vt=!Tn(k.value.expression)}return{filter:je,dynamicFilter:pt||void 0,needGeometry:rs(Fe),needFeature:!!vt}}function Ka(k){if(!Array.isArray(k))return k;const F=function(k){if(Yp.has(k[0]))for(let F=1;F<k.length;F++)if(Qa(k[F]))return!0;return k}(k);return!0===F?F:F.map((k=>Ka(k)))}function Ja(k){let F=!1;const Me=[];if("case"===k[0]){for(let Ae=1;Ae<k.length-1;Ae+=2)F=F||Qa(k[Ae]),Me.push(k[Ae+1]);Me.push(k[k.length-1])}else if("match"===k[0]){F=F||Qa(k[1]);for(let F=2;F<k.length-1;F+=2)Me.push(k[F+1]);Me.push(k[k.length-1])}else if("step"===k[0]){F=F||Qa(k[1]);for(let F=1;F<k.length-1;F+=2)Me.push(k[F+1])}F&&(k.length=0,k.push("any",...Me));for(let F=1;F<k.length;F++)Ja(k[F])}function Qa(k){if(!Array.isArray(k))return!1;if("pitch"===(F=k[0])||"distance-from-center"===F)return!0;var F;for(let F=1;F<k.length;F++)if(Qa(k[F]))return!0;return!1}const Yp=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function es(k,F){return k<F?-1:k>F?1:0}function rs(k){if(!Array.isArray(k))return!1;if("within"===k[0]||"distance"===k[0])return!0;for(let F=1;F<k.length;F++)if(rs(k[F]))return!0;return!1}function ns(k){if(!k)return!0;const F=k[0];return k.length<=1?"any"!==F:"=="===F?is(k[1],k[2],"=="):"!="===F?os(is(k[1],k[2],"==")):"<"===F||">"===F||"<="===F||">="===F?is(k[1],k[2],F):"any"===F?(Me=k.slice(1),["any"].concat(Me.map(ns))):"all"===F?["all"].concat(k.slice(1).map(ns)):"none"===F?["all"].concat(k.slice(1).map(ns).map(os)):"in"===F?as(k[1],k.slice(2)):"!in"===F?os(as(k[1],k.slice(2))):"has"===F?ss(k[1]):"!has"!==F||os(ss(k[1]));var Me}function is(k,F,Me){switch(k){case"$type":return[`filter-type-${Me}`,F];case"$id":return[`filter-id-${Me}`,F];default:return[`filter-${Me}`,k,F]}}function as(k,F){if(0===F.length)return!1;switch(k){case"$type":return["filter-type-in",["literal",F]];case"$id":return["filter-id-in",["literal",F]];default:return F.length>200&&!F.some((k=>typeof k!=typeof F[0]))?["filter-in-large",k,["literal",F.sort(es)]]:["filter-in-small",k,["literal",F]]}}function ss(k){switch(k){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",k]}}function os(k){return["!",k]}const tf="";function us(k,F){return F?`${k}${tf}${F}`:k}const rf="-transition",of=new Set(["fill","line","background","hillshade","raster"]);class ps extends we{constructor(k,F,Me,Ae,Oe){if(super(),this.id=k.id,this.fqid=us(this.id,Me),this.type=k.type,this.scope=Me,this.lut=Ae,this.options=Oe,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==k.type){if(this.metadata=k.metadata,this.minzoom=k.minzoom,this.maxzoom=k.maxzoom,k.type&&"background"!==k.type&&"sky"!==k.type&&"slot"!==k.type){this.source=k.source,this.sourceLayer=k["source-layer"],this.filter=k.filter;const F=Wi(this.filter,Xp[`filter_${k.type}`]);"error"!==F.result&&(this.configDependencies=new Set([...this.configDependencies,...F.value.configDependencies]))}if(k.slot&&(this.slot=k.slot),F.layout&&(this._unevaluatedLayout=new Oa(F.layout,this.scope,Oe),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),F.paint){this._transitionablePaint=new La(F.paint,this.scope,Oe);for(const F in k.paint)this.setPaintProperty(F,k.paint[F]);for(const F in k.layout)this.setLayoutProperty(F,k.layout[F]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ua(F.paint)}}}onAdd(k){}onRemove(k){}isDraped(k){return!this.is3D()&&of.has(this.type)}getLayoutProperty(k){return"visibility"===k?this.visibility:this._unevaluatedLayout.getValue(k)}setLayoutProperty(k,F){if("custom"===this.type&&"visibility"===k)return void(this.visibility=F);const Me=this._unevaluatedLayout;Me._properties.properties[k]&&(Me.setValue(k,F),this.configDependencies=new Set([...this.configDependencies,...Me.configDependencies]),"visibility"===k&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(k){return lt(k,rf)?this._transitionablePaint.getTransition(k.slice(0,-11)):this._transitionablePaint.getValue(k)}setPaintProperty(k,F){const Me=this._transitionablePaint,Ae=Me._properties.properties;if(lt(k,rf)){const Oe=k.slice(0,-11);return Ae[Oe]&&Me.setTransition(Oe,F||void 0),!1}if(!Ae[k])return!1;const Oe=Me._values[k],Fe=Oe.value.isDataDriven(),je=Oe.value;Me.setValue(k,F),this.configDependencies=new Set([...this.configDependencies,...Me.configDependencies]),this._handleSpecialPaintPropertyUpdate(k);const qe=Me._values[k].value,pt=qe.isDataDriven(),vt=lt(k,"pattern")||"line-dasharray"===k;return pt||Fe||vt||this._handleOverridablePaintPropertyUpdate(k,je,qe)}_handleSpecialPaintPropertyUpdate(k){}getProgramIds(){return null}getDefaultProgramParams(k,F,Me){return null}_handleOverridablePaintPropertyUpdate(k,F,Me){return!1}isHidden(k){return!!(this.minzoom&&k<this.minzoom)||!!(this.maxzoom&&k>=this.maxzoom)||"none"===this.visibility}updateTransitions(k){this._transitioningPaint=this._transitionablePaint.transitioned(k,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(k,F){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(k,void 0,F)),this.paint=this._transitioningPaint.possiblyEvaluate(k,void 0,F)}serialize(){return ct({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((k,F)=>!(void 0===k||"layout"===F&&!Object.keys(k).length||"paint"===F&&!Object.keys(k).length)))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const k in this.paint._values){const F=this.paint.get(k);if(F instanceof Na&&Li(F.property.specification)&&("source"===F.value.kind||"composite"===F.value.kind)&&F.value.isStateDependent)return!0}return!1}compileFilter(k){this._filterCompiled||(this._featureFilter=Wa(this.filter,this.scope,k),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(k){this._stats&&("shadow"===k.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(k){}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe,je,qe,pt){}}const sf={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ds{constructor(k,F){this._structArray=k,this._pos1=F*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ms{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(k,F){return k._trim(),F&&(k.isTransferred=!0,F.add(k.arrayBuffer)),{length:k.length,arrayBuffer:k.arrayBuffer}}static deserialize(k){const F=Object.create(this.prototype);return F.arrayBuffer=k.arrayBuffer,F.length=k.length,F.capacity=k.arrayBuffer.byteLength/F.bytesPerElement,F._refreshViews(),F}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(k){this.reserve(k),this.length=k}reserve(k){if(k>this.capacity){this.capacity=Math.max(k,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const F=this.uint8;this._refreshViews(),F&&this.uint8.set(F)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...k){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...k){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ys(k,F=1){let Me=0,Ae=0;return{members:k.map((k=>{const Oe=sf[k.type].BYTES_PER_ELEMENT,Fe=Me=gs(Me,Math.max(F,Oe)),je=k.components||1;return Ae=Math.max(Ae,Oe),Me+=Oe*je,{name:k.name,type:k.type,components:je,offset:Fe}})),size:gs(Me,Math.max(Ae,F)),alignment:F}}function gs(k,F){return Math.ceil(k/F)*F}class xs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,k,F)}emplace(k,F,Me){const Ae=2*k;return this.int16[Ae+0]=F,this.int16[Ae+1]=Me,k}}xs.prototype.bytesPerElement=4,oa(xs,"StructArrayLayout2i4");class vs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F,Me){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,k,F,Me)}emplace(k,F,Me,Ae){const Oe=3*k;return this.int16[Oe+0]=F,this.int16[Oe+1]=Me,this.int16[Oe+2]=Ae,k}}vs.prototype.bytesPerElement=6,oa(vs,"StructArrayLayout3i6");class bs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,k,F,Me,Ae)}emplace(k,F,Me,Ae,Oe){const Fe=4*k;return this.int16[Fe+0]=F,this.int16[Fe+1]=Me,this.int16[Fe+2]=Ae,this.int16[Fe+3]=Oe,k}}bs.prototype.bytesPerElement=8,oa(bs,"StructArrayLayout4i8");class _s extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,k,F,Me,Ae,Oe)}emplace(k,F,Me,Ae,Oe,Fe){const je=5*k;return this.int16[je+0]=F,this.int16[je+1]=Me,this.int16[je+2]=Ae,this.int16[je+3]=Oe,this.int16[je+4]=Fe,k}}_s.prototype.bytesPerElement=10,oa(_s,"StructArrayLayout5i10");class ws extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,k,F,Me,Ae,Oe,Fe,je)}emplace(k,F,Me,Ae,Oe,Fe,je,qe){const pt=6*k,vt=12*k,Ut=3*k;return this.int16[pt+0]=F,this.int16[pt+1]=Me,this.uint8[vt+4]=Ae,this.uint8[vt+5]=Oe,this.uint8[vt+6]=Fe,this.uint8[vt+7]=je,this.float32[Ut+2]=qe,k}}ws.prototype.bytesPerElement=12,oa(ws,"StructArrayLayout2i4ub1f12");class Ms extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,k,F,Me,Ae)}emplace(k,F,Me,Ae,Oe){const Fe=4*k;return this.float32[Fe+0]=F,this.float32[Fe+1]=Me,this.float32[Fe+2]=Ae,this.float32[Fe+3]=Oe,k}}Ms.prototype.bytesPerElement=16,oa(Ms,"StructArrayLayout4f16");class As extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,k,F,Me)}emplace(k,F,Me,Ae){const Oe=3*k;return this.float32[Oe+0]=F,this.float32[Oe+1]=Me,this.float32[Oe+2]=Ae,k}}As.prototype.bytesPerElement=12,oa(As,"StructArrayLayout3f12");class Ss extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,k,F,Me,Ae,Oe)}emplace(k,F,Me,Ae,Oe,Fe){const je=6*k,qe=3*k;return this.uint16[je+0]=F,this.uint16[je+1]=Me,this.uint16[je+2]=Ae,this.uint16[je+3]=Oe,this.float32[qe+2]=Fe,k}}Ss.prototype.bytesPerElement=12,oa(Ss,"StructArrayLayout4ui1f12");class Is extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,k,F,Me,Ae)}emplace(k,F,Me,Ae,Oe){const Fe=4*k;return this.uint16[Fe+0]=F,this.uint16[Fe+1]=Me,this.uint16[Fe+2]=Ae,this.uint16[Fe+3]=Oe,k}}Is.prototype.bytesPerElement=8,oa(Is,"StructArrayLayout4ui8");class Ps extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,k,F,Me,Ae,Oe,Fe)}emplace(k,F,Me,Ae,Oe,Fe,je){const qe=6*k;return this.int16[qe+0]=F,this.int16[qe+1]=Me,this.int16[qe+2]=Ae,this.int16[qe+3]=Oe,this.int16[qe+4]=Fe,this.int16[qe+5]=je,k}}Ps.prototype.bytesPerElement=12,oa(Ps,"StructArrayLayout6i12");class zs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi){const vi=this.length;return this.resize(vi+1),this.emplace(vi,k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi){const bi=12*k;return this.int16[bi+0]=F,this.int16[bi+1]=Me,this.int16[bi+2]=Ae,this.int16[bi+3]=Oe,this.uint16[bi+4]=Fe,this.uint16[bi+5]=je,this.uint16[bi+6]=qe,this.uint16[bi+7]=pt,this.int16[bi+8]=vt,this.int16[bi+9]=Ut,this.int16[bi+10]=xi,this.int16[bi+11]=vi,k}}zs.prototype.bytesPerElement=24,oa(zs,"StructArrayLayout4i4ui4i24");class Es extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,k,F,Me,Ae,Oe,Fe)}emplace(k,F,Me,Ae,Oe,Fe,je){const qe=10*k,pt=5*k;return this.int16[qe+0]=F,this.int16[qe+1]=Me,this.int16[qe+2]=Ae,this.float32[pt+2]=Oe,this.float32[pt+3]=Fe,this.float32[pt+4]=je,k}}Es.prototype.bytesPerElement=20,oa(Es,"StructArrayLayout3i3f20");class ks extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(k){const F=this.length;return this.resize(F+1),this.emplace(F,k)}emplace(k,F){return this.uint32[1*k+0]=F,k}}ks.prototype.bytesPerElement=4,oa(ks,"StructArrayLayout1ul4");class Ts extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k,F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,k,F)}emplace(k,F,Me){const Ae=2*k;return this.uint16[Ae+0]=F,this.uint16[Ae+1]=Me,k}}Ts.prototype.bytesPerElement=4,oa(Ts,"StructArrayLayout2ui4");class Bs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi){const bi=this.length;return this.resize(bi+1),this.emplace(bi,k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi){const wi=20*k,Mi=10*k;return this.int16[wi+0]=F,this.int16[wi+1]=Me,this.int16[wi+2]=Ae,this.int16[wi+3]=Oe,this.int16[wi+4]=Fe,this.float32[Mi+3]=je,this.float32[Mi+4]=qe,this.float32[Mi+5]=pt,this.float32[Mi+6]=vt,this.int16[wi+14]=Ut,this.uint32[Mi+8]=xi,this.uint16[wi+18]=vi,this.uint16[wi+19]=bi,k}}Bs.prototype.bytesPerElement=40,oa(Bs,"StructArrayLayout5i4f1i1ul2ui40");class Vs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,k,F,Me,Ae,Oe,Fe,je)}emplace(k,F,Me,Ae,Oe,Fe,je,qe){const pt=8*k;return this.int16[pt+0]=F,this.int16[pt+1]=Me,this.int16[pt+2]=Ae,this.int16[pt+4]=Oe,this.int16[pt+5]=Fe,this.int16[pt+6]=je,this.int16[pt+7]=qe,k}}Vs.prototype.bytesPerElement=16,oa(Vs,"StructArrayLayout3i2i2i16");class Cs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,k,F,Me,Ae,Oe)}emplace(k,F,Me,Ae,Oe,Fe){const je=4*k,qe=8*k;return this.float32[je+0]=F,this.float32[je+1]=Me,this.float32[je+2]=Ae,this.int16[qe+6]=Oe,this.int16[qe+7]=Fe,k}}Cs.prototype.bytesPerElement=16,oa(Cs,"StructArrayLayout2f1f2i16");class Ds extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,k,F,Me,Ae,Oe,Fe)}emplace(k,F,Me,Ae,Oe,Fe,je){const qe=20*k,pt=5*k;return this.uint8[qe+0]=F,this.uint8[qe+1]=Me,this.float32[pt+1]=Ae,this.float32[pt+2]=Oe,this.float32[pt+3]=Fe,this.float32[pt+4]=je,k}}Ds.prototype.bytesPerElement=20,oa(Ds,"StructArrayLayout2ub4f20");class Ls extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k,F,Me){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,k,F,Me)}emplace(k,F,Me,Ae){const Oe=3*k;return this.uint16[Oe+0]=F,this.uint16[Oe+1]=Me,this.uint16[Oe+2]=Ae,k}}Ls.prototype.bytesPerElement=6,oa(Ls,"StructArrayLayout3ui6");class Rs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr){const co=this.length;return this.resize(co+1),this.emplace(co,k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co){const mo=30*k,yo=15*k,To=60*k;return this.int16[mo+0]=F,this.int16[mo+1]=Me,this.int16[mo+2]=Ae,this.float32[yo+2]=Oe,this.float32[yo+3]=Fe,this.uint16[mo+8]=je,this.uint16[mo+9]=qe,this.uint32[yo+5]=pt,this.uint32[yo+6]=vt,this.uint32[yo+7]=Ut,this.uint16[mo+16]=xi,this.uint16[mo+17]=vi,this.uint16[mo+18]=bi,this.float32[yo+10]=wi,this.float32[yo+11]=Mi,this.uint8[To+48]=pr,this.uint8[To+49]=Ur,this.uint8[To+50]=Wr,this.uint32[yo+13]=Jr,this.int16[mo+28]=Qr,this.uint8[To+58]=co,k}}Rs.prototype.bytesPerElement=60,oa(Rs,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Fs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co,mo,yo,To,zo,ko,na,aa,_a,wa,Sa){const Ya=this.length;return this.resize(Ya+1),this.emplace(Ya,k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co,mo,yo,To,zo,ko,na,aa,_a,wa,Sa)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co,mo,yo,To,zo,ko,na,aa,_a,wa,Sa,Ya){const rl=20*k,sl=40*k,ml=80*k;return this.float32[rl+0]=F,this.float32[rl+1]=Me,this.int16[sl+4]=Ae,this.int16[sl+5]=Oe,this.int16[sl+6]=Fe,this.int16[sl+7]=je,this.int16[sl+8]=qe,this.int16[sl+9]=pt,this.int16[sl+10]=vt,this.int16[sl+11]=Ut,this.int16[sl+12]=xi,this.uint16[sl+13]=vi,this.uint16[sl+14]=bi,this.uint16[sl+15]=wi,this.uint16[sl+16]=Mi,this.uint16[sl+17]=pr,this.uint16[sl+18]=Ur,this.uint16[sl+19]=Wr,this.uint16[sl+20]=Jr,this.uint16[sl+21]=Qr,this.uint16[sl+22]=co,this.uint16[sl+23]=mo,this.uint16[sl+24]=yo,this.uint16[sl+25]=To,this.uint16[sl+26]=zo,this.uint16[sl+27]=ko,this.uint32[rl+14]=na,this.float32[rl+15]=aa,this.float32[rl+16]=_a,this.float32[rl+17]=wa,this.float32[rl+18]=Sa,this.uint8[ml+76]=Ya,k}}Fs.prototype.bytesPerElement=80,oa(Fs,"StructArrayLayout2f9i15ui1ul4f1ub80");class Os extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k){const F=this.length;return this.resize(F+1),this.emplace(F,k)}emplace(k,F){return this.float32[1*k+0]=F,k}}Os.prototype.bytesPerElement=4,oa(Os,"StructArrayLayout1f4");class Ns extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,k,F,Me,Ae,Oe)}emplace(k,F,Me,Ae,Oe,Fe){const je=5*k;return this.float32[je+0]=F,this.float32[je+1]=Me,this.float32[je+2]=Ae,this.float32[je+3]=Oe,this.float32[je+4]=Fe,k}}Ns.prototype.bytesPerElement=20,oa(Ns,"StructArrayLayout5f20");class Us extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,k,F,Me,Ae,Oe,Fe,je)}emplace(k,F,Me,Ae,Oe,Fe,je,qe){const pt=7*k;return this.float32[pt+0]=F,this.float32[pt+1]=Me,this.float32[pt+2]=Ae,this.float32[pt+3]=Oe,this.float32[pt+4]=Fe,this.float32[pt+5]=je,this.float32[pt+6]=qe,k}}Us.prototype.bytesPerElement=28,oa(Us,"StructArrayLayout7f28");class js extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut){const xi=this.length;return this.resize(xi+1),this.emplace(xi,k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi){const vi=11*k;return this.float32[vi+0]=F,this.float32[vi+1]=Me,this.float32[vi+2]=Ae,this.float32[vi+3]=Oe,this.float32[vi+4]=Fe,this.float32[vi+5]=je,this.float32[vi+6]=qe,this.float32[vi+7]=pt,this.float32[vi+8]=vt,this.float32[vi+9]=Ut,this.float32[vi+10]=xi,k}}js.prototype.bytesPerElement=44,oa(js,"StructArrayLayout11f44");class qs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=this.length;return this.resize(vt+1),this.emplace(vt,k,F,Me,Ae,Oe,Fe,je,qe,pt)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt){const Ut=9*k;return this.float32[Ut+0]=F,this.float32[Ut+1]=Me,this.float32[Ut+2]=Ae,this.float32[Ut+3]=Oe,this.float32[Ut+4]=Fe,this.float32[Ut+5]=je,this.float32[Ut+6]=qe,this.float32[Ut+7]=pt,this.float32[Ut+8]=vt,k}}qs.prototype.bytesPerElement=36,oa(qs,"StructArrayLayout9f36");class $s extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,k,F)}emplace(k,F,Me){const Ae=2*k;return this.float32[Ae+0]=F,this.float32[Ae+1]=Me,k}}$s.prototype.bytesPerElement=8,oa($s,"StructArrayLayout2f8");class Gs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,k,F,Me,Ae)}emplace(k,F,Me,Ae,Oe){const Fe=6*k;return this.uint32[3*k+0]=F,this.uint16[Fe+2]=Me,this.uint16[Fe+3]=Ae,this.uint16[Fe+4]=Oe,k}}Gs.prototype.bytesPerElement=12,oa(Gs,"StructArrayLayout1ul3ui12");class Ys extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(k){const F=this.length;return this.resize(F+1),this.emplace(F,k)}emplace(k,F){return this.uint16[1*k+0]=F,k}}Ys.prototype.bytesPerElement=2,oa(Ys,"StructArrayLayout1ui2");class Xs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi){const pr=this.length;return this.resize(pr+1),this.emplace(pr,k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi)}emplace(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr){const Ur=16*k;return this.float32[Ur+0]=F,this.float32[Ur+1]=Me,this.float32[Ur+2]=Ae,this.float32[Ur+3]=Oe,this.float32[Ur+4]=Fe,this.float32[Ur+5]=je,this.float32[Ur+6]=qe,this.float32[Ur+7]=pt,this.float32[Ur+8]=vt,this.float32[Ur+9]=Ut,this.float32[Ur+10]=xi,this.float32[Ur+11]=vi,this.float32[Ur+12]=bi,this.float32[Ur+13]=wi,this.float32[Ur+14]=Mi,this.float32[Ur+15]=pr,k}}Xs.prototype.bytesPerElement=64,oa(Xs,"StructArrayLayout16f64");class Zs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(k,F,Me,Ae,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,k,F,Me,Ae,Oe,Fe,je)}emplace(k,F,Me,Ae,Oe,Fe,je,qe){const pt=10*k,vt=5*k;return this.uint16[pt+0]=F,this.uint16[pt+1]=Me,this.uint16[pt+2]=Ae,this.uint16[pt+3]=Oe,this.float32[vt+2]=Fe,this.float32[vt+3]=je,this.float32[vt+4]=qe,k}}Zs.prototype.bytesPerElement=20,oa(Zs,"StructArrayLayout4ui3f20");class Hs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(k){const F=this.length;return this.resize(F+1),this.emplace(F,k)}emplace(k,F){return this.int16[1*k+0]=F,k}}Hs.prototype.bytesPerElement=2,oa(Hs,"StructArrayLayout1i2");class Ws extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(k){const F=this.length;return this.resize(F+1),this.emplace(F,k)}emplace(k,F){return this.uint8[1*k+0]=F,k}}Ws.prototype.bytesPerElement=1,oa(Ws,"StructArrayLayout1ub1");class Ks extends ds{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Ks.prototype.size=40;class Js extends Bs{get(k){return new Ks(this,k)}}oa(Js,"CollisionBoxArray");class Qs extends ds{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(k){this._structArray.uint8[this._pos1+49]=k}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(k){this._structArray.uint8[this._pos1+50]=k}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(k){this._structArray.uint32[this._pos4+13]=k}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(k){this._structArray.uint8[this._pos1+58]=k}}Qs.prototype.size=60;class to extends Rs{get(k){return new Qs(this,k)}}oa(to,"PlacedSymbolArray");class eo extends ds{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(k){this._structArray.uint32[this._pos4+14]=k}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(k){this._structArray.float32[this._pos4+18]=k}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}eo.prototype.size=80;class ro extends Fs{get(k){return new eo(this,k)}}oa(ro,"SymbolInstanceArray");class no extends Os{getoffsetX(k){return this.float32[1*k+0]}}oa(no,"GlyphOffsetArray");class io extends xs{getx(k){return this.int16[2*k+0]}gety(k){return this.int16[2*k+1]}}oa(io,"SymbolLineVertexArray");class ao extends ds{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ao.prototype.size=12;class so extends Gs{get(k){return new ao(this,k)}}oa(so,"FeatureIndexArray");class oo extends Ts{geta_centroid_pos0(k){return this.uint16[2*k+0]}geta_centroid_pos1(k){return this.uint16[2*k+1]}}oa(oo,"FillExtrusionCentroidArray");class lo extends ds{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}lo.prototype.size=6;class uo extends vs{get(k){return new lo(this,k)}}oa(uo,"FillExtrusionWallArray");const lf=ys([{name:"a_pos",components:2,type:"Int16"}],4),uf=ys([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class po{constructor(k=[]){this.segments=k}_prepareSegment(k,F,Me,Ae){let Oe=this.segments[this.segments.length-1];return k>po.MAX_VERTEX_ARRAY_LENGTH&&ft(`Max vertices per segment is ${po.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${k}`),(!Oe||Oe.vertexLength+k>po.MAX_VERTEX_ARRAY_LENGTH||Oe.sortKey!==Ae)&&(Oe={vertexOffset:F,primitiveOffset:Me,vertexLength:0,primitiveLength:0},void 0!==Ae&&(Oe.sortKey=Ae),this.segments.push(Oe)),Oe}prepareSegment(k,F,Me,Ae){return this._prepareSegment(k,F.length,Me.length,Ae)}get(){return this.segments}destroy(){for(const k of this.segments)for(const F in k.vaos)k.vaos[F].destroy()}static simpleSegment(k,F,Me,Ae){return new po([{vertexOffset:k,primitiveOffset:F,vertexLength:Me,primitiveLength:Ae,vaos:{},sortKey:0}])}}function fo(k,F){return 256*(k=Q(Math.floor(k),0,255))+Q(Math.floor(F),0,255)}po.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,oa(po,"SegmentVector");const pf=ys([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),ff=ys([{name:"a_dash",components:4,type:"Uint16"}]);class go{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(k,F,Me,Ae){this.ids.push(xo(k)),this.positions.push(F,Me,Ae)}eachPosition(k,F){const Me=xo(k);let Ae=0,Oe=this.ids.length-1;for(;Ae<Oe;){const k=Ae+Oe>>1;this.ids[k]>=Me?Oe=k:Ae=k+1}for(;this.ids[Ae]===Me;)F(this.positions[3*Ae],this.positions[3*Ae+1],this.positions[3*Ae+2]),Ae++}static serialize(k,F){const Me=new Float64Array(k.ids),Ae=new Uint32Array(k.positions);return vo(Me,Ae,0,Me.length-1),F&&(F.add(Me.buffer),F.add(Ae.buffer)),{ids:Me,positions:Ae}}static deserialize(k){const F=new go;let Me;F.ids=k.ids,F.positions=k.positions;for(const k of F.ids)k!==Me&&F.uniqueIds.push(k),Me=k;return F.indexed=!0,F}}function xo(k){const F=+k;return!isNaN(F)&&Number.MIN_SAFE_INTEGER<=F&&F<=Number.MAX_SAFE_INTEGER?F:Fh(String(k))}function vo(k,F,Me,Ae){for(;Me<Ae;){const Oe=k[Me+Ae>>1];let Fe=Me-1,je=Ae+1;for(;;){do{Fe++}while(k[Fe]<Oe);do{je--}while(k[je]>Oe);if(Fe>=je)break;bo(k,Fe,je),bo(F,3*Fe,3*je),bo(F,3*Fe+1,3*je+1),bo(F,3*Fe+2,3*je+2)}je-Me<Ae-je?(vo(k,F,Me,je),Me=je+1):(vo(k,F,je+1,Ae),Ae=je)}}function bo(k,F,Me){const Ae=k[F];k[F]=k[Me],k[Me]=Ae}oa(go,"FeaturePositionMap");class _o{constructor(k){this.gl=k.gl,this.initialized=!1}fetchUniformLocation(k,F){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(k,F),this.initialized=!0),!!this.location}set(k,F,Me){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class wo extends _o{constructor(k){super(k),this.current=0}set(k,F,Me){this.fetchUniformLocation(k,F)&&this.current!==Me&&(this.current=Me,this.gl.uniform1i(this.location,Me))}}class Mo extends _o{constructor(k){super(k),this.current=0}set(k,F,Me){this.fetchUniformLocation(k,F)&&this.current!==Me&&(this.current=Me,this.gl.uniform1f(this.location,Me))}}class Ao extends _o{constructor(k){super(k),this.current=[0,0]}set(k,F,Me){this.fetchUniformLocation(k,F)&&(Me[0]===this.current[0]&&Me[1]===this.current[1]||(this.current=Me,this.gl.uniform2f(this.location,Me[0],Me[1])))}}class So extends _o{constructor(k){super(k),this.current=[0,0,0]}set(k,F,Me){this.fetchUniformLocation(k,F)&&(Me[0]===this.current[0]&&Me[1]===this.current[1]&&Me[2]===this.current[2]||(this.current=Me,this.gl.uniform3f(this.location,Me[0],Me[1],Me[2])))}}class Io extends _o{constructor(k){super(k),this.current=[0,0,0,0]}set(k,F,Me){this.fetchUniformLocation(k,F)&&(Me[0]===this.current[0]&&Me[1]===this.current[1]&&Me[2]===this.current[2]&&Me[3]===this.current[3]||(this.current=Me,this.gl.uniform4f(this.location,Me[0],Me[1],Me[2],Me[3])))}}class Po extends _o{constructor(k){super(k),this.current=Ie.transparent.toRenderColor(null)}set(k,F,Me){this.fetchUniformLocation(k,F)&&(Me.r===this.current.r&&Me.g===this.current.g&&Me.b===this.current.b&&Me.a===this.current.a||(this.current=Me,this.gl.uniform4f(this.location,Me.r,Me.g,Me.b,Me.a)))}}const gf=new Float32Array(16);class Eo extends _o{constructor(k){super(k),this.current=gf}set(k,F,Me){if(this.fetchUniformLocation(k,F)){if(Me[12]!==this.current[12]||Me[0]!==this.current[0])return this.current=Me,void this.gl.uniformMatrix4fv(this.location,!1,Me);for(let k=1;k<16;k++)if(Me[k]!==this.current[k]){this.current=Me,this.gl.uniformMatrix4fv(this.location,!1,Me);break}}}}const xf=new Float32Array(9),wf=new Float32Array(4);class Bo extends _o{constructor(k){super(k),this.current=wf}set(k,F,Me){if(this.fetchUniformLocation(k,F))for(let k=0;k<4;k++)if(Me[k]!==this.current[k]){this.current=Me,this.gl.uniformMatrix2fv(this.location,!1,Me);break}}}function Vo(k){return[fo(255*k.r,255*k.g),fo(255*k.b,255*k.a)]}class Co{constructor(k,F,Me,Ae){this.value=k,this.uniformNames=F.map((k=>`u_${k}`)),this.type=Me,this.context=Ae}setUniform(k,F,Me,Ae,Oe){const Fe=Ae.constantOr(this.value);F.set(k,Oe,Fe instanceof Ie?Fe.toRenderColor(this.ignoreLut?null:this.context.lut):Fe)}getBinding(k,F){return"color"===this.type?new Po(k):new Mo(k)}}class Do{constructor(k,F){this.uniformNames=F.map((k=>`u_${k}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(k){this.pixelRatio=k.pixelRatio||1,this.pattern=k.tl.concat(k.br)}setUniform(k,F,Me,Ae,Oe){const Fe="u_pattern"===Oe||"u_dash"===Oe?this.pattern:"u_pixel_ratio"===Oe?this.pixelRatio:null;Fe&&F.set(k,Oe,Fe)}getBinding(k,F){return"u_pattern"===F||"u_dash"===F?new Io(k):new Mo(k)}}class Lo{constructor(k,F,Me,Ae){this.expression=k,this.type=Me,this.maxValue=0,this.paintVertexAttributes=F.map((k=>({name:`a_${k}`,type:"Float32",components:"color"===Me?2:1,offset:0}))),this.paintVertexArray=new Ae}populatePaintArray(k,F,Me,Ae,Oe,Fe,je){const qe=this.paintVertexArray.length,pt=this.expression.evaluate(new Va(0,{brightness:Fe}),F,{},Oe,Ae,je);this.paintVertexArray.resize(k),this._setPaintValue(qe,k,pt,this.context)}updatePaintArray(k,F,Me,Ae,Oe,Fe,je){const qe=this.expression.evaluate({zoom:0,brightness:je},Me,Ae,void 0,Oe);this._setPaintValue(k,F,qe,this.context)}_setPaintValue(k,F,Me,Ae){if("color"===this.type){const Oe=Vo(Me.toRenderColor(this.ignoreLut?null:Ae.lut));for(let Me=k;Me<F;Me++)this.paintVertexArray.emplace(Me,Oe[0],Oe[1])}else{for(let Ae=k;Ae<F;Ae++)this.paintVertexArray.emplace(Ae,Me);this.maxValue=Math.max(this.maxValue,Math.abs(Me))}}upload(k){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=k.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ro{constructor(k,F,Me,Ae,Oe,Fe){this.expression=k,this.uniformNames=F.map((k=>`u_${k}_t`)),this.type=Me,this.useIntegerZoom=Ae,this.context=Oe,this.maxValue=0,this.paintVertexAttributes=F.map((k=>({name:`a_${k}`,type:"Float32",components:"color"===Me?4:2,offset:0}))),this.paintVertexArray=new Fe}populatePaintArray(k,F,Me,Ae,Oe,Fe,je){const qe=this.expression.evaluate(new Va(this.context.zoom,{brightness:Fe}),F,{},Oe,Ae,je),pt=this.expression.evaluate(new Va(this.context.zoom+1,{brightness:Fe}),F,{},Oe,Ae,je),vt=this.paintVertexArray.length;this.paintVertexArray.resize(k),this._setPaintValue(vt,k,qe,pt,this.context)}updatePaintArray(k,F,Me,Ae,Oe,Fe,je){const qe=this.expression.evaluate({zoom:this.context.zoom,brightness:je},Me,Ae,void 0,Oe),pt=this.expression.evaluate({zoom:this.context.zoom+1,brightness:je},Me,Ae,void 0,Oe);this._setPaintValue(k,F,qe,pt,this.context)}_setPaintValue(k,F,Me,Ae,Oe){if("color"===this.type){const Ae=Vo(Me.toRenderColor(this.ignoreLut?null:Oe.lut)),Fe=Vo(Me.toRenderColor(this.ignoreLut?null:Oe.lut));for(let Me=k;Me<F;Me++)this.paintVertexArray.emplace(Me,Ae[0],Ae[1],Fe[0],Fe[1])}else{for(let Oe=k;Oe<F;Oe++)this.paintVertexArray.emplace(Oe,Me,Ae);this.maxValue=Math.max(this.maxValue,Math.abs(Me),Math.abs(Ae))}}upload(k){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=k.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(k,F,Me,Ae,Oe){const Fe=this.useIntegerZoom?Math.floor(Me.zoom):Me.zoom,je=Q(this.expression.interpolationFactor(Fe,this.context.zoom,this.context.zoom+1),0,1);F.set(k,Oe,je)}getBinding(k,F){return new Mo(k)}}class Fo{constructor(k,F,Me,Ae,Oe){this.expression=k,this.layerId=Oe,this.paintVertexAttributes=("array"===Me?ff:pf).members;for(let k=0;k<F.length;++k);this.paintVertexArray=new Ae}populatePaintArray(k,F,Me,Ae){const Oe=this.paintVertexArray.length;this.paintVertexArray.resize(k),this._setPaintValues(Oe,k,F.patterns&&F.patterns[this.layerId],Me)}updatePaintArray(k,F,Me,Ae,Oe,Fe,je){this._setPaintValues(k,F,Me.patterns&&Me.patterns[this.layerId],Fe)}_setPaintValues(k,F,Me,Ae){if(!Ae||!Me)return;const Oe=Ae[Me];if(!Oe)return;const{tl:Fe,br:je,pixelRatio:qe}=Oe;for(let Me=k;Me<F;Me++)this.paintVertexArray.emplace(Me,Fe[0],Fe[1],je[0],je[1],qe)}upload(k){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=k.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Oo{constructor(k,F,Me=(()=>!0)){this.binders={},this._buffers=[],this.context=F;const Ae=[];for(const Oe in k.paint._values){const Fe=k.paint.get(Oe),je=k.paint.get(`${Oe}-use-theme`);if(Oe.endsWith("-use-theme"))continue;if(!Me(Oe))continue;if(!(Fe instanceof Na&&Li(Fe.property.specification)))continue;const qe=jo(Oe,k.type),pt=Fe.value,vt=Fe.property.specification.type,Ut=!!Fe.property.useIntegerZoom,xi="line-dasharray"===Oe||Oe.endsWith("pattern"),vi="line-dasharray"===Oe&&"constant"!==k.layout.get("line-cap").value.kind;if("constant"!==pt.kind||vi)if("source"===pt.kind||vi||xi){const F=Go(Oe,vt,"source");this.binders[Oe]=xi?new Fo(pt,qe,vt,F,k.id):new Lo(pt,qe,vt,F),Ae.push(`/a_${Oe}`)}else{const k=Go(Oe,vt,"composite");this.binders[Oe]=new Ro(pt,qe,vt,Ut,F,k),Ae.push(`/z_${Oe}`)}else this.binders[Oe]=xi?new Do(pt.value,qe):new Co(pt.value,qe,vt,F),Ae.push(`/u_${Oe}`);je&&(this.binders[Oe].ignoreLut="none"===je.constantOr("default"),this.binders[Oe].checkUseTheme=!0)}this.cacheKey=Ae.sort().join("")}getMaxValue(k){const F=this.binders[k];return F instanceof Lo||F instanceof Ro?F.maxValue:0}populatePaintArrays(k,F,Me,Ae,Oe,Fe,je){for(const qe in this.binders){const pt=this.binders[qe];pt.context=this.context,(pt instanceof Lo||pt instanceof Ro||pt instanceof Fo)&&pt.populatePaintArray(k,F,Me,Ae,Oe,Fe,je)}}setConstantPatternPositions(k){for(const F in this.binders){const Me=this.binders[F];Me instanceof Do&&Me.setConstantPatternPositions(k)}}updatePaintArrays(k,F,Me,Ae,Oe,Fe,je,qe,pt){let vt=!1;const Ut=Object.keys(k),xi=0!==Ut.length&&!qe,vi=xi?Ut:F.uniqueIds;this.context.lut=Oe.lut;for(const qe in this.binders){const Ut=this.binders[qe];if(Ut.context=this.context,(Ut instanceof Lo||Ut instanceof Ro||Ut instanceof Fo)&&(!0===Ut.expression.isStateDependent||!1===Ut.expression.isLightConstant)){const bi=Oe.paint.get(qe);Ut.expression=bi.value;for(const Me of vi){const Oe=k[Me.toString()];F.eachPosition(Me,((k,F,Me)=>{const qe=Ae.feature(k);Ut.updatePaintArray(F,Me,qe,Oe,Fe,je,pt)}))}if(!xi)for(const F of Me.uniqueIds){const Oe=k[F.toString()];Me.eachPosition(F,((k,F,Me)=>{const qe=Ae.feature(k);Ut.updatePaintArray(F,Me,qe,Oe,Fe,je,pt)}))}vt=!0}}return vt}defines(){const k=[];for(const F in this.binders){const Me=this.binders[F];(Me instanceof Co||Me instanceof Do)&&k.push(...Me.uniformNames.map((k=>`#define HAS_UNIFORM_${k}`)))}return k}getBinderAttributes(){const k=[];for(const F in this.binders){const Me=this.binders[F];if(Me instanceof Lo||Me instanceof Ro||Me instanceof Fo)for(let F=0;F<Me.paintVertexAttributes.length;F++)k.push(Me.paintVertexAttributes[F].name)}return k}getBinderUniforms(){const k=[];for(const F in this.binders){const Me=this.binders[F];if(Me instanceof Co||Me instanceof Do||Me instanceof Ro)for(const F of Me.uniformNames)k.push(F)}return k}getPaintVertexBuffers(){return this._buffers}getUniforms(k){const F=[];for(const Me in this.binders){const Ae=this.binders[Me];if(Ae instanceof Co||Ae instanceof Do||Ae instanceof Ro)for(const Oe of Ae.uniformNames)F.push({name:Oe,property:Me,binding:Ae.getBinding(k,Oe)})}return F}setUniforms(k,F,Me,Ae,Oe){for(const{name:F,property:Fe,binding:je}of Me){if(this.binders[Fe].checkUseTheme&&this.binders[Fe]instanceof Co){const k=Ae.get(`${Fe}-use-theme`);k.isConstant()&&(this.binders[Fe].ignoreLut="none"===k.constantOr("default"))}this.binders[Fe].setUniform(k,je,Oe,Ae.get(Fe),F)}}updatePaintBuffers(){this._buffers=[];for(const k in this.binders){const F=this.binders[k];(F instanceof Lo||F instanceof Ro||F instanceof Fo)&&F.paintVertexBuffer&&this._buffers.push(F.paintVertexBuffer)}}upload(k){for(const F in this.binders){const Me=this.binders[F];(Me instanceof Lo||Me instanceof Ro||Me instanceof Fo)&&Me.upload(k)}this.updatePaintBuffers()}destroy(){for(const k in this.binders){const F=this.binders[k];(F instanceof Lo||F instanceof Ro||F instanceof Fo)&&F.destroy()}}}class No{constructor(k,F,Me=(()=>!0)){this.programConfigurations={};for(const Ae of k)this.programConfigurations[Ae.id]=new Oo(Ae,F,Me);this.needsUpload=!1,this._featureMap=new go,this._featureMapWithoutIds=new go,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(k,F,Me,Ae,Oe,Fe,je,qe){for(const Me in this.programConfigurations)this.programConfigurations[Me].populatePaintArrays(k,F,Ae,Oe,Fe,je,qe);void 0!==F.id?this._featureMap.add(F.id,Me,this._bufferOffset,k):(this._featureMapWithoutIds.add(this._idlessCounter,Me,this._bufferOffset,k),this._idlessCounter+=1),this._bufferOffset=k,this.needsUpload=!0}updatePaintArrays(k,F,Me,Ae,Oe,Fe,je){for(const qe of Me)this.needsUpload=this.programConfigurations[qe.id].updatePaintArrays(k,this._featureMap,this._featureMapWithoutIds,F,qe,Ae,Oe,Fe,je||0)||this.needsUpload}get(k){return this.programConfigurations[k]}upload(k){if(this.needsUpload){for(const F in this.programConfigurations)this.programConfigurations[F].upload(k);this.needsUpload=!1}}destroy(){for(const k in this.programConfigurations)this.programConfigurations[k].destroy()}}const Mf={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function jo(k,F){return Mf[k]||[k.replace(`${F}-`,"").replace(/-/g,"_")]}const qf={"line-pattern":{source:Ss,composite:Ss},"fill-pattern":{source:Ss,composite:Ss},"fill-extrusion-pattern":{source:Ss,composite:Ss},"line-dasharray":{source:Is,composite:Is}},Hf={color:{source:$s,composite:Ms},number:{source:Os,composite:$s}};function Go(k,F,Me){const Ae=qf[k];return Ae&&Ae[Me]||Hf[F][Me]}oa(Co,"ConstantBinder"),oa(Do,"PatternConstantBinder"),oa(Lo,"SourceExpressionBinder"),oa(Fo,"PatternCompositeBinder"),oa(Ro,"CompositeExpressionBinder"),oa(Oo,"ProgramConfiguration",{omit:["_buffers"]}),oa(No,"ProgramConfigurationSet");const Wf=Td/Math.PI/2,Yf=5,Jf=6,em=16383,rm=64,nm=[rm,32,16],om=-Wf,lm=Wf;function tl(k,F,Me,Ae=Wf){return Me=X(Me),[k*Math.sin(Me)*Ae,-F*Ae,k*Math.cos(Me)*Ae]}function el(k,F,Me){return tl(Math.cos(X(k)),Math.sin(X(k)),F,Me)}const cm=6371008.8,hm=2*Math.PI*cm;class il{constructor(k,F){if(isNaN(k)||isNaN(F))throw new Error(`Invalid LngLat object: (${k}, ${F})`);if(this.lng=+k,this.lat=+F,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new il(et(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(k){const F=Math.PI/180,Me=this.lat*F,Ae=k.lat*F,Oe=Math.sin(Me)*Math.sin(Ae)+Math.cos(Me)*Math.cos(Ae)*Math.cos((k.lng-this.lng)*F);return cm*Math.acos(Math.min(Oe,1))}toBounds(k=0){const F=360*k/40075017,Me=F/Math.cos(Math.PI/180*this.lat);return new al({lng:this.lng-Me,lat:this.lat-F},{lng:this.lng+Me,lat:this.lat+F})}toEcef(k){return el(this.lat,this.lng,Wf+k*Wf/cm)}static convert(k){if(k instanceof il)return k;if(Array.isArray(k)&&(2===k.length||3===k.length))return new il(Number(k[0]),Number(k[1]));if(!Array.isArray(k)&&"object"==typeof k&&null!==k)return new il(Number("lng"in k?k.lng:k.lon),Number(k.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class al{constructor(k,F){if(k)if(F)this.setSouthWest(k).setNorthEast(F);else if(4===k.length){const F=k;this.setSouthWest([F[0],F[1]]).setNorthEast([F[2],F[3]])}else{const F=k;this.setSouthWest(F[0]).setNorthEast(F[1])}}setNorthEast(k){return this._ne=k instanceof il?new il(k.lng,k.lat):il.convert(k),this}setSouthWest(k){return this._sw=k instanceof il?new il(k.lng,k.lat):il.convert(k),this}extend(k){const F=this._sw,Me=this._ne;let Ae,Oe;if(k instanceof il)Ae=k,Oe=k;else{if(!(k instanceof al))return Array.isArray(k)?4===k.length||k.every(Array.isArray)?this.extend(al.convert(k)):this.extend(il.convert(k)):"object"==typeof k&&null!==k&&k.hasOwnProperty("lat")&&(k.hasOwnProperty("lon")||k.hasOwnProperty("lng"))?this.extend(il.convert(k)):this;if(Ae=k._sw,Oe=k._ne,!Ae||!Oe)return this}return F||Me?(F.lng=Math.min(Ae.lng,F.lng),F.lat=Math.min(Ae.lat,F.lat),Me.lng=Math.max(Oe.lng,Me.lng),Me.lat=Math.max(Oe.lat,Me.lat)):(this._sw=new il(Ae.lng,Ae.lat),this._ne=new il(Oe.lng,Oe.lat)),this}getCenter(){return new il((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new il(this.getWest(),this.getNorth())}getSouthEast(){return new il(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(k){const{lng:F,lat:Me}=il.convert(k);let Ae=this._sw.lng<=F&&F<=this._ne.lng;return this._sw.lng>this._ne.lng&&(Ae=this._sw.lng>=F&&F>=this._ne.lng),this._sw.lat<=Me&&Me<=this._ne.lat&&Ae}static convert(k){if(k)return k instanceof al?k:new al(k)}}const um=0,bm=25.5;function ll(k){return hm*Math.cos(k*Math.PI/180)}function ul(k){return(180+k)/360}function cl(k){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+k*Math.PI/360)))/360}function hl(k,F){return k/ll(F)}function pl(k){return 360*k-180}function fl(k){return 360/Math.PI*Math.atan(Math.exp((180-360*k)*Math.PI/180))-90}function dl(k,F){return k*ll(fl(F))}const wm=85.051129;function yl(k){return Math.cos(X(Q(k,-wm,wm)))}function gl(k,F){const Me=Q(F,um,bm),Ae=Math.pow(2,Me);return yl(k)*hm/(512*Ae)}function xl(k){return 1/Math.cos(k*Math.PI/180)}function vl(k,F=0){const Me=Math.exp(Math.PI*(1-(k.y+F/Td)/(1<<k.z)*2));return 80150034*Me/(Me*Me+1)/Td/(1<<k.z)}class bl{constructor(k,F,Me=0){this.x=+k,this.y=+F,this.z=+Me}static fromLngLat(k,F=0){const Me=il.convert(k);return new bl(ul(Me.lng),cl(Me.lat),hl(F,Me.lat))}toLngLat(){return new il(pl(this.x),fl(this.y))}toAltitude(){return dl(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/hm*xl(fl(this.y))}}function _l(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=(F+Ae)/2,Ut=(Me+Oe)/2,xi=new Sa(vt,Ut);qe(xi),function(k,F,Me,Ae,Oe,Fe){const je=Me-Oe,qe=Ae-Fe;return Math.abs((Ae-F)*je-(Me-k)*qe)/Math.hypot(je,qe)}(xi.x,xi.y,Fe.x,Fe.y,je.x,je.y)>=pt?(_l(k,F,Me,vt,Ut,Fe,xi,qe,pt),_l(k,vt,Ut,Ae,Oe,xi,je,qe,pt)):k.push(je)}function wl(k,F,Me){let Ae=k[0],Oe=Ae.x,Fe=Ae.y;F(Ae);const je=[Ae];for(let qe=1;qe<k.length;qe++){const pt=k[qe],{x:vt,y:Ut}=pt;F(pt),_l(je,Oe,Fe,vt,Ut,Ae,pt,F,Me),Oe=vt,Fe=Ut,Ae=pt}return je}function Ml(k,F,Me,Ae){if(Ae(F,Me)){const Oe=F.add(Me)._mult(.5);Ml(k,F,Oe,Ae),Ml(k,Oe,Me,Ae)}else k.push(Me)}function Al(k,F){let Me=k[0];const Ae=[Me];for(let Oe=1;Oe<k.length;Oe++){const Fe=k[Oe];Ml(Ae,Me,Fe,F),Me=Fe}return Ae}const Sm=Math.pow(2,14)-1,Mm=-Sm-1;function Pl(k,F){const Me=Math.round(k.x*F),Ae=Math.round(k.y*F);return k.x=Q(Me,Mm,Sm),k.y=Q(Ae,Mm,Sm),(Me<k.x||Me>k.x+1||Ae<k.y||Ae>k.y+1)&&ft("Geometry exceeds allowed extent, reduce your vector tile buffer size"),k}function zl(k,F,Me){const Ae=k.loadGeometry(),Oe=k.extent,Fe=Td/Oe;if(F&&Me&&Me.projection.isReprojectedInTileSpace){const Fe=1<<F.z,{scale:je,x:qe,y:pt,projection:vt}=Me,c=k=>{const Me=pl((F.x+k.x/Oe)/Fe),Ae=fl((F.y+k.y/Oe)/Fe),Ut=vt.project(Me,Ae);k.x=(Ut.x*je-qe)*Oe,k.y=(Ut.y*je-pt)*Oe};for(let F=0;F<Ae.length;F++)if(1!==k.type)Ae[F]=wl(Ae[F],c,1);else{const k=[];for(const Me of Ae[F])Me.x<0||Me.x>=Oe||Me.y<0||Me.y>=Oe||(c(Me),k.push(Me));Ae[F]=k}}for(const k of Ae)for(const F of k)Pl(F,Fe);return Ae}function El(k,F){return{type:k.type,id:k.id,properties:k.properties,geometry:F?zl(k):[]}}function kl(k,F,Me,Ae,Oe){k.emplaceBack(2*F+(Ae+1)/2,2*Me+(Oe+1)/2)}function Tl(k,F,Me){const Ae=16384;k.emplaceBack(F.x,F.y,F.z,Me[0]*Ae,Me[1]*Ae,Me[2]*Ae)}class Bl{constructor(k){this.zoom=k.zoom,this.overscaling=k.overscaling,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.index=k.index,this.hasPattern=!1,this.projection=k.projection,this.layoutVertexArray=new xs,this.indexArray=new Ls,this.segments=new po,this.programConfigurations=new No(k.layers,{zoom:k.zoom,lut:k.lut}),this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id))}updateFootprints(k,F){}populate(k,F,Me,Ae){const Oe=this.layers[0],Fe=[];let je=null;"circle"===Oe.type&&(je=Oe.layout.get("circle-sort-key"));for(const{feature:F,id:Oe,index:qe,sourceLayerIndex:pt}of k){const k=this.layers[0]._featureFilter.needGeometry,vt=El(F,k);if(!this.layers[0]._featureFilter.filter(new Va(this.zoom),vt,Me))continue;const Ut=je?je.evaluate(vt,{},Me):void 0,xi={id:Oe,properties:F.properties,type:F.type,sourceLayerIndex:pt,index:qe,geometry:k?vt.geometry:zl(F,Me,Ae),patterns:{},sortKey:Ut};Fe.push(xi)}je&&Fe.sort(((k,F)=>k.sortKey-F.sortKey));let qe=null;"globe"===Ae.projection.name&&(this.globeExtVertexArray=new Ps,qe=Ae.projection);for(const Ae of Fe){const{geometry:Oe,index:Fe,sourceLayerIndex:je}=Ae,pt=k[Fe].feature;this.addFeature(Ae,Oe,Fe,F.availableImages,Me,qe,F.brightness),F.featureIndex.insert(pt,Oe,Fe,je,this.index)}}update(k,F,Me,Ae,Oe,Fe,je){this.programConfigurations.updatePaintArrays(k,F,Oe,Me,Ae,Fe,je)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(k){this.uploaded||(this.layoutVertexBuffer=k.createVertexBuffer(this.layoutVertexArray,lf.members),this.indexBuffer=k.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=k.createVertexBuffer(this.globeExtVertexArray,uf.members))),this.programConfigurations.upload(k),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(k,F,Me,Ae,Oe,Fe,je){for(const Me of F)for(const F of Me){const Me=F.x,Ae=F.y;if(Me<0||Me>=Td||Ae<0||Ae>=Td)continue;if(Fe){const k=Fe.projectTilePoint(Me,Ae,Oe),F=Fe.upVector(Oe,Me,Ae),je=this.globeExtVertexArray;Tl(je,k,F),Tl(je,k,F),Tl(je,k,F),Tl(je,k,F)}const je=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,k.sortKey),qe=je.vertexLength;kl(this.layoutVertexArray,Me,Ae,-1,-1),kl(this.layoutVertexArray,Me,Ae,1,-1),kl(this.layoutVertexArray,Me,Ae,1,1),kl(this.layoutVertexArray,Me,Ae,-1,1),this.indexArray.emplaceBack(qe,qe+1,qe+2),this.indexArray.emplaceBack(qe,qe+2,qe+3),je.vertexLength+=4,je.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,k,Me,{},Ae,Oe,je)}}function Vl(k,F){for(let Me=0;Me<k.length;Me++)if(jl(F,k[Me]))return!0;for(let Me=0;Me<F.length;Me++)if(jl(k,F[Me]))return!0;return!!Rl(k,F)}function Cl(k,F,Me){return!!jl(k,F)||!!Ol(F,k,Me)}function Dl(k,F){if(1===k.length)return Ul(F,k[0]);for(let Me=0;Me<F.length;Me++){const Ae=F[Me];for(let F=0;F<Ae.length;F++)if(jl(k,Ae[F]))return!0}for(let Me=0;Me<k.length;Me++)if(Ul(F,k[Me]))return!0;for(let Me=0;Me<F.length;Me++)if(Rl(k,F[Me]))return!0;return!1}function Ll(k,F,Me){if(k.length>1){if(Rl(k,F))return!0;for(let Ae=0;Ae<F.length;Ae++)if(Ol(F[Ae],k,Me))return!0}for(let Ae=0;Ae<k.length;Ae++)if(Ol(k[Ae],F,Me))return!0;return!1}function Rl(k,F){if(0===k.length||0===F.length)return!1;for(let Me=0;Me<k.length-1;Me++){const Ae=k[Me],Oe=k[Me+1];for(let k=0;k<F.length-1;k++)if(Fl(Ae,Oe,F[k],F[k+1]))return!0}return!1}function Fl(k,F,Me,Ae){return dt(k,Me,Ae)!==dt(F,Me,Ae)&&dt(k,F,Me)!==dt(k,F,Ae)}function Ol(k,F,Me){const Ae=Me*Me;if(1===F.length)return k.distSqr(F[0])<Ae;for(let Me=1;Me<F.length;Me++)if(Nl(k,F[Me-1],F[Me])<Ae)return!0;return!1}function Nl(k,F,Me){const Ae=F.distSqr(Me);if(0===Ae)return k.distSqr(F);const Oe=((k.x-F.x)*(Me.x-F.x)+(k.y-F.y)*(Me.y-F.y))/Ae;return k.distSqr(Oe<0?F:Oe>1?Me:Me.sub(F)._mult(Oe)._add(F))}function Ul(k,F){let Me,Ae,Oe,Fe=!1;for(let je=0;je<k.length;je++){Me=k[je];for(let k=0,je=Me.length-1;k<Me.length;je=k++)Ae=Me[k],Oe=Me[je],Ae.y>F.y!=Oe.y>F.y&&F.x<(Oe.x-Ae.x)*(F.y-Ae.y)/(Oe.y-Ae.y)+Ae.x&&(Fe=!Fe)}return Fe}function jl(k,F){let Me=!1;for(let Ae=0,Oe=k.length-1;Ae<k.length;Oe=Ae++){const Fe=k[Ae],je=k[Oe];Fe.y>F.y!=je.y>F.y&&F.x<(je.x-Fe.x)*(F.y-Fe.y)/(je.y-Fe.y)+Fe.x&&(Me=!Me)}return Me}function ql(k,F,Me,Ae,Oe){for(const Fe of k)if(F<=Fe.x&&Me<=Fe.y&&Ae>=Fe.x&&Oe>=Fe.y)return!0;const Fe=[new Sa(F,Me),new Sa(F,Oe),new Sa(Ae,Oe),new Sa(Ae,Me)];if(k.length>2)for(const F of Fe)if(jl(k,F))return!0;for(let F=0;F<k.length-1;F++)if($l(k[F],k[F+1],Fe))return!0;return!1}function $l(k,F,Me){const Ae=Me[0],Oe=Me[2];if(k.x<Ae.x&&F.x<Ae.x||k.x>Oe.x&&F.x>Oe.x||k.y<Ae.y&&F.y<Ae.y||k.y>Oe.y&&F.y>Oe.y)return!1;const Fe=dt(k,F,Me[0]);return Fe!==dt(k,F,Me[1])||Fe!==dt(k,F,Me[2])||Fe!==dt(k,F,Me[3])}function Gl(k,F,Me,Ae,Oe,Fe){let je=F.y-k.y,qe=k.x-F.x;if(Fe=Fe||0){const k=je*je+qe*qe;if(0===k)return!0;const F=Math.sqrt(k);je/=F,qe/=F}return!((Me.x-k.x)*je+(Me.y-k.y)*qe-Fe<0||(Ae.x-k.x)*je+(Ae.y-k.y)*qe-Fe<0||(Oe.x-k.x)*je+(Oe.y-k.y)*qe-Fe<0)}function Yl(k,F,Me,Ae,Oe,Fe,je){return!(Gl(k,F,Ae,Oe,Fe,je)||Gl(F,Me,Ae,Oe,Fe,je)||Gl(Me,k,Ae,Oe,Fe,je)||Gl(Ae,Oe,k,F,Me,je)||Gl(Oe,Fe,k,F,Me,je)||Gl(Fe,Ae,k,F,Me,je))}function Xl(k,F,Me){const Ae=F.paint.get(k).value;return"constant"===Ae.kind?Ae.value:Me.programConfigurations.get(F.id).getMaxValue(k)}function Zl(k){return Math.sqrt(k[0]*k[0]+k[1]*k[1])}function Hl(k,F,Me,Ae,Oe){if(!F[0]&&!F[1])return k;const Fe=Sa.convert(F)._mult(Oe);"viewport"===Me&&Fe._rotate(-Ae);const je=[];for(let F=0;F<k.length;F++)je.push(k[F].sub(Fe));return je}function Wl(k,F,Me,Ae){const Oe=Sa.convert(k)._mult(Ae);return"viewport"===F&&Oe._rotate(-Me),Oe}let Im,Am;oa(Bl,"CircleBucket",{omit:["layers"]});var Nm,Vm={exports:{}},Um=(Nm||(Nm=1,function(k,F){!function(k){function e(k,F,Me){var Ae=r(256*k,256*(F=Math.pow(2,Me)-F-1),Me),Oe=r(256*(k+1),256*(F+1),Me);return Ae[0]+","+Ae[1]+","+Oe[0]+","+Oe[1]}function r(k,F,Me){var Ae=2*Math.PI*6378137/256/Math.pow(2,Me);return[k*Ae-2*Math.PI*6378137/2,F*Ae-2*Math.PI*6378137/2]}k.getURL=function(k,F,Me,Ae,Oe,Fe){return Fe=Fe||{},k+"?"+["bbox="+e(Me,Ae,Oe),"format="+(Fe.format||"image/png"),"service="+(Fe.service||"WMS"),"version="+(Fe.version||"1.1.1"),"request="+(Fe.request||"GetMap"),"srs="+(Fe.srs||"EPSG:3857"),"width="+(Fe.width||256),"height="+(Fe.height||256),"layers="+F].join("&")},k.getTileBBox=e,k.getMercCoords=r,Object.defineProperty(k,"__esModule",{value:!0})}(F)}(0,Vm.exports)),Vm.exports);class ru{constructor(k,F,Me){this.z=k,this.x=F,this.y=Me,this.key=au(0,k,k,F,Me)}equals(k){return this.z===k.z&&this.x===k.x&&this.y===k.y}url(k,F){const Me=Um.getTileBBox(this.x,this.y,this.z),Ae=function(k,F,Me){let Ae,Oe="";for(let Fe=k;Fe>0;Fe--)Ae=1<<Fe-1,Oe+=(F&Ae?1:0)+(Me&Ae?2:0);return Oe}(this.z,this.x,this.y);return k[(this.x+this.y)%k.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===F?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",Ae).replace("{bbox-epsg-3857}",Me)}toString(){return`${this.z}/${this.x}/${this.y}`}}class nu{constructor(k,F){this.wrap=k,this.canonical=F,this.key=au(k,F.z,F.z,F.x,F.y)}}class iu{constructor(k,F,Me,Ae,Oe){this.overscaledZ=k,this.wrap=F,this.canonical=new ru(Me,+Ae,+Oe),this.key=0===F&&k===Me?this.canonical.key:au(F,k,Me,Ae,Oe)}equals(k){return this.overscaledZ===k.overscaledZ&&this.wrap===k.wrap&&this.canonical.equals(k.canonical)}scaledTo(k){const F=this.canonical.z-k;return k>this.canonical.z?new iu(k,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new iu(k,this.wrap,k,this.canonical.x>>F,this.canonical.y>>F)}calculateScaledKey(k,F=!0){if(this.overscaledZ===k&&F)return this.key;if(k>this.canonical.z)return au(this.wrap*+F,k,this.canonical.z,this.canonical.x,this.canonical.y);{const Me=this.canonical.z-k;return au(this.wrap*+F,k,k,this.canonical.x>>Me,this.canonical.y>>Me)}}isChildOf(k){if(k.wrap!==this.wrap)return!1;const F=this.canonical.z-k.canonical.z;return 0===k.overscaledZ||k.overscaledZ<this.overscaledZ&&k.canonical.z<this.canonical.z&&k.canonical.x===this.canonical.x>>F&&k.canonical.y===this.canonical.y>>F}children(k){if(this.overscaledZ>=k)return[new iu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const F=this.canonical.z+1,Me=2*this.canonical.x,Ae=2*this.canonical.y;return[new iu(F,this.wrap,F,Me,Ae),new iu(F,this.wrap,F,Me+1,Ae),new iu(F,this.wrap,F,Me,Ae+1),new iu(F,this.wrap,F,Me+1,Ae+1)]}isLessThan(k){return this.wrap<k.wrap||!(this.wrap>k.wrap)&&(this.overscaledZ<k.overscaledZ||!(this.overscaledZ>k.overscaledZ)&&(this.canonical.x<k.canonical.x||!(this.canonical.x>k.canonical.x)&&this.canonical.y<k.canonical.y))}wrapped(){return new iu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(k){return new iu(this.overscaledZ,k,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new nu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function au(k,F,Me,Ae,Oe){const Fe=1<<Math.min(Me,22);let je=Fe*(Oe%Fe)+Ae%Fe;return k&&Me<22&&(je+=Fe*Fe*((k<0?-2*k-1:2*k)%(1<<2*(22-Me)))),16*(32*je+Me)+(F-Me)}const jm=[k=>{let F=k.canonical.x-1,Me=k.wrap;return F<0&&(F=(1<<k.canonical.z)-1,Me--),new iu(k.overscaledZ,Me,k.canonical.z,F,k.canonical.y)},k=>{let F=k.canonical.x+1,Me=k.wrap;return F===1<<k.canonical.z&&(F=0,Me++),new iu(k.overscaledZ,Me,k.canonical.z,F,k.canonical.y)},k=>new iu(k.overscaledZ,k.wrap,k.canonical.z,k.canonical.x,(0===k.canonical.y?1<<k.canonical.z:k.canonical.y)-1),k=>new iu(k.overscaledZ,k.wrap,k.canonical.z,k.canonical.x,k.canonical.y===(1<<k.canonical.z)-1?0:k.canonical.y+1)];oa(ru,"CanonicalTileID"),oa(iu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Gm=ys([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:qm}=Gm,$m=ys([{name:"a_pos_3",components:3,type:"Int16"}]);var Xm=ys([{name:"a_pos",type:"Int16",components:2}]);class hu{constructor(k,F){this.pos=k,this.dir=F}intersectsPlane(k,F,Me){const Ae=aa.vec3.dot(F,this.dir);if(Math.abs(Ae)<1e-6)return!1;const Oe=((k[0]-this.pos[0])*F[0]+(k[1]-this.pos[1])*F[1]+(k[2]-this.pos[2])*F[2])/Ae;return Me[0]=this.pos[0]+this.dir[0]*Oe,Me[1]=this.pos[1]+this.dir[1]*Oe,Me[2]=this.pos[2]+this.dir[2]*Oe,!0}closestPointOnSphere(k,F,Me){if(aa.vec3.equals(this.pos,k)||0===F)return Me[0]=Me[1]=Me[2]=0,!1;const[Ae,Oe,Fe]=this.dir,je=this.pos[0]-k[0],qe=this.pos[1]-k[1],pt=this.pos[2]-k[2],vt=Ae*Ae+Oe*Oe+Fe*Fe,Ut=2*(je*Ae+qe*Oe+pt*Fe),xi=Ut*Ut-4*vt*(je*je+qe*qe+pt*pt-F*F);if(xi<0){const k=Math.max(-Ut/2,0),vt=je+Ae*k,xi=qe+Oe*k,vi=pt+Fe*k,bi=Math.hypot(vt,xi,vi);return Me[0]=vt*F/bi,Me[1]=xi*F/bi,Me[2]=vi*F/bi,!1}{const k=(-Ut-Math.sqrt(xi))/(2*vt);if(k<0){const k=Math.hypot(je,qe,pt);return Me[0]=je*F/k,Me[1]=qe*F/k,Me[2]=pt*F/k,!1}return Me[0]=je+Ae*k,Me[1]=qe+Oe*k,Me[2]=pt+Fe*k,!0}}}class pu{constructor(k,F,Me,Ae,Oe){this.TL=k,this.TR=F,this.BR=Me,this.BL=Ae,this.horizon=Oe}static fromInvProjectionMatrix(k,F,Me){const Ae=[-1,1,1],Oe=[1,1,1],Fe=[1,-1,1],je=[-1,-1,1],qe=aa.vec3.transformMat4(Ae,Ae,k),pt=aa.vec3.transformMat4(Oe,Oe,k),vt=aa.vec3.transformMat4(Fe,Fe,k),Ut=aa.vec3.transformMat4(je,je,k);return new pu(qe,pt,vt,Ut,F/Me)}}function fu(k,F,Me){let Ae=1/0,Oe=-1/0;const Fe=[];for(const je of k){aa.vec3.sub(Fe,je,F);const k=aa.vec3.dot(Fe,Me);Ae=Math.min(Ae,k),Oe=Math.max(Oe,k)}return[Ae,Oe]}function du(k,F){let Me=!0;for(let Ae=0;Ae<k.planes.length;Ae++){const Oe=k.planes[Ae];let Fe=0;for(let k=0;k<F.length;k++)Fe+=aa.vec3.dot(Oe,F[k])+Oe[3]>=0;if(0===Fe)return 0;Fe!==F.length&&(Me=!1)}return Me?2:1}function mu(k,F){for(const Me of k.projections){const Ae=fu(F,k.points[0],Me.axis);if(Me.projection[1]<Ae[0]||Me.projection[0]>Ae[1])return 0}return 1}function yu(k,F){let Me=0;const Ae=[0,0,0,0];for(let Oe=0;Oe<k.length;Oe++)Ae[0]=k[Oe][0],Ae[1]=k[Oe][1],Ae[2]=k[Oe][2],Ae[3]=1,aa.vec4.dot(Ae,F)>=0&&Me++;return Me}class gu{constructor(k,F){this.points=k||new Array(8).fill([0,0,0]),this.planes=F||new Array(6).fill([0,0,0,0]),this.bounds=xu.fromPoints(this.points),this.projections=[],this.frustumEdges=[aa.vec3.sub([],this.points[2],this.points[3]),aa.vec3.sub([],this.points[0],this.points[3]),aa.vec3.sub([],this.points[4],this.points[0]),aa.vec3.sub([],this.points[5],this.points[1]),aa.vec3.sub([],this.points[6],this.points[2]),aa.vec3.sub([],this.points[7],this.points[3])];for(const k of this.frustumEdges){const F=[0,-k[2],k[1]],Me=[k[2],0,-k[0]];this.projections.push({axis:F,projection:fu(this.points,this.points[0],F)}),this.projections.push({axis:Me,projection:fu(this.points,this.points[0],Me)})}}static fromInvProjectionMatrix(k,F,Me,Ae){const Oe=Math.pow(2,Me),Fe=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((Me=>{const Fe=aa.vec4.transformMat4([],Me,k),je=1/Fe[3]/F*Oe;return aa.vec4.mul(Fe,Fe,[je,je,Ae?1/Fe[3]:je,je])})),je=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((k=>{const F=aa.vec3.sub([],Fe[k[0]],Fe[k[1]]),Me=aa.vec3.sub([],Fe[k[2]],Fe[k[1]]),Ae=aa.vec3.normalize([],aa.vec3.cross([],F,Me)),Oe=-aa.vec3.dot(Ae,Fe[k[1]]);return Ae.concat(Oe)})),qe=[];for(let k=0;k<Fe.length;k++)qe.push([Fe[k][0],Fe[k][1],Fe[k][2]]);return new gu(qe,je)}intersectsPrecise(k,F,Me){for(let Me=0;Me<F.length;Me++)if(!yu(k,F[Me]))return 0;for(let F=0;F<this.planes.length;F++)if(!yu(k,this.planes[F]))return 0;for(const F of Me)for(const Me of this.frustumEdges){const Ae=aa.vec3.cross([],F,Me),Oe=aa.vec3.length(Ae);if(0===Oe)continue;aa.vec3.scale(Ae,Ae,1/Oe);const Fe=fu(this.points,this.points[0],Ae),je=fu(k,this.points[0],Ae);if(Fe[0]>je[1]||je[0]>Fe[1])return 0}return 1}containsPoint(k){for(const F of this.planes){const Me=F[3];if(aa.vec3.dot([F[0],F[1],F[2]],k)+Me<0)return!1}return!0}}class xu{static fromPoints(k){const F=[1/0,1/0,1/0],Me=[-1/0,-1/0,-1/0];for(const Ae of k)aa.vec3.min(F,F,Ae),aa.vec3.max(Me,Me,Ae);return new xu(F,Me)}static fromTileIdAndHeight(k,F,Me){const Ae=1<<k.canonical.z,Oe=k.canonical.x,Fe=k.canonical.y;return new xu([Oe/Ae,Fe/Ae,F],[(Oe+1)/Ae,(Fe+1)/Ae,Me])}static applyTransform(k,F){const Me=k.getCorners();for(let k=0;k<Me.length;++k)aa.vec3.transformMat4(Me[k],Me[k],F);return xu.fromPoints(Me)}static applyTransformFast(k,F){const Me=[F[12],F[13],F[14]],Ae=[...Me];for(let Oe=0;Oe<3;Oe++)for(let Fe=0;Fe<3;Fe++){const je=F[4*Fe+Oe],qe=je*k.min[Fe],pt=je*k.max[Fe];Me[Oe]+=Math.min(qe,pt),Ae[Oe]+=Math.max(qe,pt)}return new xu(Me,Ae)}static projectAabbCorners(k,F){const Me=k.getCorners();for(let k=0;k<Me.length;++k)aa.vec3.transformMat4(Me[k],Me[k],F);return Me}constructor(k,F){this.min=k,this.max=F,this.center=aa.vec3.scale([],aa.vec3.add([],this.min,this.max),.5)}quadrant(k){const F=[k%2==0,k<2],Me=aa.vec3.clone(this.min),Ae=aa.vec3.clone(this.max);for(let k=0;k<F.length;k++)Me[k]=F[k]?this.min[k]:this.center[k],Ae[k]=F[k]?this.center[k]:this.max[k];return Ae[2]=this.max[2],new xu(Me,Ae)}distanceX(k){return Math.max(Math.min(this.max[0],k[0]),this.min[0])-k[0]}distanceY(k){return Math.max(Math.min(this.max[1],k[1]),this.min[1])-k[1]}distanceZ(k){return Math.max(Math.min(this.max[2],k[2]),this.min[2])-k[2]}getCorners(){const k=this.min,F=this.max;return[[k[0],k[1],k[2]],[F[0],k[1],k[2]],[F[0],F[1],k[2]],[k[0],F[1],k[2]],[k[0],k[1],F[2]],[F[0],k[1],F[2]],[F[0],F[1],F[2]],[k[0],F[1],F[2]]]}intersects(k){return this.intersectsAabb(k.bounds)?du(k,this.getCorners()):0}intersectsFlat(k){return this.intersectsAabb(k.bounds)?du(k,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(k,F){return F||this.intersects(k)?mu(k,this.getCorners()):0}intersectsPreciseFlat(k,F){return F||this.intersectsFlat(k)?mu(k,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(k){for(let F=0;F<3;++F)if(this.min[F]>k.max[F]||k.min[F]>this.max[F])return!1;return!0}intersectsAabbXY(k){return!(this.min[0]>k.max[0]||k.min[0]>this.max[0]||this.min[1]>k.max[1]||k.min[1]>this.max[1])}encapsulate(k){for(let F=0;F<3;F++)this.min[F]=Math.min(this.min[F],k.min[F]),this.max[F]=Math.max(this.max[F],k.max[F])}encapsulatePoint(k){for(let F=0;F<3;F++)this.min[F]=Math.min(this.min[F],k[F]),this.max[F]=Math.max(this.max[F],k[F])}closestPoint(k){return[Math.max(Math.min(this.max[0],k[0]),this.min[0]),Math.max(Math.min(this.max[1],k[1]),this.min[1]),Math.max(Math.min(this.max[2],k[2]),this.min[2])]}}function vu(k){return k*Wf/cm}oa(xu,"Aabb");const Ym=[new xu([om,om,om],[lm,lm,lm]),new xu([om,om,om],[0,0,lm]),new xu([0,om,om],[lm,0,lm]),new xu([om,0,om],[0,lm,lm]),new xu([0,0,om],[lm,lm,lm])];function _u(k,F,Me,Ae=!0){const Oe=aa.vec3.scale([],k._camera.position,k.worldSize),Fe=[F,Me,1,1];aa.vec4.transformMat4(Fe,Fe,k.pixelMatrixInverse),aa.vec4.scale(Fe,Fe,1/Fe[3]);const je=aa.vec3.sub([],Fe,Oe),qe=aa.vec3.normalize([],je),pt=k.globeMatrix,vt=[pt[12],pt[13],pt[14]],Ut=aa.vec3.sub([],vt,Oe),xi=aa.vec3.length(Ut),vi=aa.vec3.normalize([],Ut),bi=k.worldSize/(2*Math.PI),wi=aa.vec3.dot(vi,qe),Mi=Math.asin(bi/xi);if(Mi<Math.acos(wi)){if(!Ae)return null;const k=[],F=[];aa.vec3.scale(k,qe,xi/wi),aa.vec3.normalize(F,aa.vec3.sub(F,k,Ut)),aa.vec3.normalize(qe,aa.vec3.add(qe,Ut,aa.vec3.scale(qe,F,Math.tan(Mi)*xi)))}const pr=[];new hu(Oe,qe).closestPointOnSphere(vt,bi,pr);const Ur=aa.vec3.normalize([],bt(pt,0)),Wr=aa.vec3.normalize([],bt(pt,1)),Jr=aa.vec3.normalize([],bt(pt,2)),Qr=aa.vec3.dot(Ur,pr),co=aa.vec3.dot(Wr,pr),mo=aa.vec3.dot(Jr,pr),yo=Z(Math.asin(-co/bi));let To=Z(Math.atan2(Qr,mo));To=k.center.lng+function(k,F){const Me=(F-k+180)%360-180;return Me<-180?Me+360:Me}(k.center.lng,To);const zo=ul(To),ko=Q(cl(yo),0,1);return new bl(zo,ko)}class wu{constructor(k,F,Me){this.a=aa.vec3.sub([],k,Me),this.b=aa.vec3.sub([],F,Me),this.center=Me;const Ae=aa.vec3.normalize([],this.a),Oe=aa.vec3.normalize([],this.b);this.angle=Math.acos(aa.vec3.dot(Ae,Oe))}}function Mu(k,F){if(0===k.angle)return null;let Me;return Me=0===k.a[F]?1/k.angle*.5*Math.PI:1/k.angle*Math.atan(k.b[F]/k.a[F]/Math.sin(k.angle)-1/Math.tan(k.angle)),Me<0||Me>1?null:function(k,F,Me,Ae){const Oe=Math.sin(Me);return k*(Math.sin((1-Ae)*Me)/Oe)+F*(Math.sin(Ae*Me)/Oe)}(k.a[F],k.b[F],k.angle,Q(Me,0,1))+k.center[F]}function Au(k){if(k.z<=1)return Ym[k.z+2*k.y+k.x];const F=Eu(zu(k));return xu.fromPoints(F)}function Su(k,F,Me){return aa.vec3.scale(k,k,1-Me),aa.vec3.scaleAndAdd(k,k,F,Me)}function Iu(k,F,Me){for(const Ae of k)aa.vec3.transformMat4(Ae,Ae,F),aa.vec3.scale(Ae,Ae,Me)}function Pu(k,F,Me,Ae){const Oe=F/k.worldSize,Fe=k.globeMatrix;if(Me.z<=1){const k=Au(Me).getCorners();return Iu(k,Fe,Oe),xu.fromPoints(k)}const je=zu(Me,Ae),qe=Eu(je,Wf+vu(k._tileCoverLift));Iu(qe,Fe,Oe);const pt=Number.MAX_VALUE,vt=[-pt,-pt,-pt],Ut=[pt,pt,pt];if(je.contains(k.center)){for(const k of qe)aa.vec3.min(Ut,Ut,k),aa.vec3.max(vt,vt,k);vt[2]=0;const F=k.point,Me=[F.x*Oe,F.y*Oe,0];return aa.vec3.min(Ut,Ut,Me),aa.vec3.max(vt,vt,Me),new xu(Ut,vt)}if(k._tileCoverLift>0){for(const k of qe)aa.vec3.min(Ut,Ut,k),aa.vec3.max(vt,vt,k);return new xu(Ut,vt)}const xi=[Fe[12]*Oe,Fe[13]*Oe,Fe[14]*Oe],vi=je.getCenter(),bi=Q(k.center.lat,-wm,wm),wi=Q(vi.lat,-wm,wm),Mi=ul(k.center.lng),pr=cl(bi);let Ur=Mi-ul(vi.lng);const Wr=pr-cl(wi);Ur>.5?Ur-=1:Ur<-.5&&(Ur+=1);let Jr=0;if(Math.abs(Ur)>Math.abs(Wr))Jr=Ur>=0?1:3;else{Jr=Wr>=0?0:2;const k=[Fe[4]*Oe,Fe[5]*Oe,Fe[6]*Oe],F=-Math.sin(X(Wr>=0?je.getSouth():je.getNorth()))*Wf;aa.vec3.scaleAndAdd(xi,xi,k,F)}const Qr=qe[Jr],co=qe[(Jr+1)%4],mo=new wu(Qr,co,xi),yo=[Mu(mo,0)||Qr[0],Mu(mo,1)||Qr[1],Mu(mo,2)||Qr[2]],To=Fu(k.zoom);if(To>0){const Ae=function({x:k,y:F,z:Me},Ae,Oe,Fe,je){const qe=1/(1<<Me);let pt=k*qe,vt=pt+qe,Ut=F*qe,xi=Ut+qe,vi=0;const bi=(pt+vt)/2-Fe;return bi>.5?vi=-1:bi<-.5&&(vi=1),pt=((pt+vi)*Ae-(Fe*=Ae))*Oe+Fe,vt=((vt+vi)*Ae-Fe)*Oe+Fe,Ut=(Ut*Ae-(je*=Ae))*Oe+je,xi=(xi*Ae-je)*Oe+je,[[pt,xi,0],[vt,xi,0],[vt,Ut,0],[pt,Ut,0]]}(Me,F,k._pixelsPerMercatorPixel,Mi,pr);for(let k=0;k<qe.length;k++)Su(qe[k],Ae[k],To);const Oe=aa.vec3.add([],Ae[Jr],Ae[(Jr+1)%4]);aa.vec3.scale(Oe,Oe,.5),Su(yo,Oe,To)}for(const k of qe)aa.vec3.min(Ut,Ut,k),aa.vec3.max(vt,vt,k);return Ut[2]=Math.min(Qr[2],co[2]),aa.vec3.min(Ut,Ut,yo),aa.vec3.max(vt,vt,yo),new xu(Ut,vt)}function zu({x:k,y:F,z:Me},Ae=!1){const Oe=1/(1<<Me),Fe=new il(pl(k*Oe),F===(1<<Me)-1&&Ae?-90:fl((F+1)*Oe)),je=new il(pl((k+1)*Oe),0===F&&Ae?90:fl(F*Oe));return new al(Fe,je)}function Eu(k,F=Wf){const Me=X(k.getNorth()),Ae=X(k.getSouth()),Oe=Math.cos(Me),Fe=Math.cos(Ae),je=Math.sin(Me),qe=Math.sin(Ae),pt=k.getWest(),vt=k.getEast();return[tl(Fe,qe,pt,F),tl(Fe,qe,vt,F),tl(Oe,je,vt,F),tl(Oe,je,pt,F)]}function ku(k,F,Me,Ae){const Oe=1<<Me.z,Fe=(k/Td+Me.x)/Oe;return el(fl((F/Td+Me.y)/Oe),pl(Fe),Ae)}function Tu({min:k,max:F}){return em/Math.max(F[0]-k[0],F[1]-k[1],F[2]-k[2])}const Qm=new Float64Array(16);function Vu(k){const F=Tu(k),Me=aa.mat4.fromScaling(Qm,[F,F,F]);return aa.mat4.translate(Me,Me,aa.vec3.negate([],k.min))}function Cu(k){const F=aa.mat4.fromTranslation(Qm,k.min),Me=1/Tu(k);return aa.mat4.scale(F,F,[Me,Me,Me])}function Du(k){const F=Td/(2*Math.PI);return k/(2*Math.PI)/F}function Lu(k,F){return Td/(512*Math.pow(2,k))*Tu(Au(F))}function Ru(k,F,Me,Ae,Oe){const Fe=Du(Me),je=[k,F,-Me/(2*Math.PI)],qe=aa.mat4.identity(new Float64Array(16));return aa.mat4.translate(qe,qe,je),aa.mat4.scale(qe,qe,[Fe,Fe,Fe]),aa.mat4.rotateX(qe,qe,X(-Oe)),aa.mat4.rotateY(qe,qe,X(-Ae)),qe}function Fu(k){return tt(Yf,Jf,k)}function Ou(k,F){const Me=el(F.lat,F.lng),Ae=function(k){const F=el(k._center.lat,k._center.lng),Me=aa.vec3.fromValues(0,1,0);let Ae=aa.vec3.cross([],Me,F);const Oe=aa.mat4.fromRotation([],-k.angle,F);Ae=aa.vec3.transformMat4(Ae,Ae,Oe),aa.mat4.fromRotation(Oe,-k._pitch,Ae);const Fe=aa.vec3.normalize([],F);return aa.vec3.scale(Fe,Fe,vu(k.cameraToCenterDistance/k.pixelsPerMeter)),aa.vec3.transformMat4(Fe,Fe,Oe),aa.vec3.add([],F,Fe)}(k),Oe=aa.vec3.subtract([],Ae,Me);return aa.vec3.angle(Oe,Me)}function Nu(k,F){return Ou(k,F)>Math.PI/2*1.01}const e_=X(85),t_=Math.cos(e_),i_=Math.sin(e_),r_=aa.mat4.create(),Gu=k=>{const F=[];return"map"===k.paint.get("circle-pitch-alignment")&&F.push("PITCH_WITH_MAP"),"map"===k.paint.get("circle-pitch-scale")&&F.push("SCALE_WITH_MAP"),F};function Yu(k,F,Me,Ae,Oe,Fe,je,qe,pt){if(Fe&&k.queryGeometry.isAboveHorizon)return!1;Fe&&(pt*=k.pixelToTileUnitsFactor);const vt=k.tileID.canonical,Ut=Me.projection.upVectorScale(vt,Me.center.lat,Me.worldSize).metersToTile;for(const xi of F)for(const F of xi){const xi=F.add(qe),vi=Oe&&Me.elevation?Me.elevation.exaggeration()*Oe.getElevationAt(xi.x,xi.y,!0):0,bi=Me.projection.projectTilePoint(xi.x,xi.y,vt);if(vi>0){const k=Me.projection.upVector(vt,xi.x,xi.y);bi.x+=k[0]*Ut*vi,bi.y+=k[1]*Ut*vi,bi.z+=k[2]*Ut*vi}const wi=Fe?xi:Xu(bi.x,bi.y,bi.z,Ae),Mi=Fe?k.tilespaceRays.map((k=>Wu(k,vi))):k.queryGeometry.screenGeometry,pr=aa.vec4.transformMat4([],[bi.x,bi.y,bi.z,1],Ae);if(!je&&Fe?pt*=pr[3]/Me.cameraToCenterDistance:je&&!Fe&&(pt*=Me.cameraToCenterDistance/pr[3]),Fe){const k=fl((F.y/Td+vt.y)/(1<<vt.z));pt/=Me.projection.pixelsPerMeter(k,1)/hl(1,k)}if(Cl(Mi,wi,pt))return!0}return!1}function Xu(k,F,Me,Ae){const Oe=aa.vec4.transformMat4([],[k,F,Me,1],Ae);return new Sa(Oe[0]/Oe[3],Oe[1]/Oe[3])}const n_=aa.vec3.fromValues(0,0,0),o_=aa.vec3.fromValues(0,0,1);function Wu(k,F){const Me=aa.vec3.create();return n_[2]=F,k.intersectsPlane(n_,o_,Me),new Sa(Me[0],Me[1])}class Ku extends Bl{}let s_,a_,l_,c_;function rc(k,{width:F,height:Me},Ae,Oe){if(Oe){if(Oe instanceof Uint8ClampedArray)Oe=new Uint8Array(Oe.buffer);else if(Oe.length!==F*Me*Ae)throw new RangeError("mismatched image size")}else Oe=new Uint8Array(F*Me*Ae);return k.width=F,k.height=Me,k.data=Oe,k}function nc(k,F,Me){const{width:Ae,height:Oe}=F;Ae===k.width&&Oe===k.height||(ic(k,F,{x:0,y:0},{x:0,y:0},{width:Math.min(k.width,Ae),height:Math.min(k.height,Oe)},Me,null),k.width=Ae,k.height=Oe,k.data=F.data)}function ic(k,F,Me,Ae,Oe,Fe,je,qe){if(0===Oe.width||0===Oe.height)return F;if(Oe.width>k.width||Oe.height>k.height||Me.x>k.width-Oe.width||Me.y>k.height-Oe.height)throw new RangeError("out of range source coordinates for image copy");if(Oe.width>F.width||Oe.height>F.height||Ae.x>F.width-Oe.width||Ae.y>F.height-Oe.height)throw new RangeError("out of range destination coordinates for image copy");const pt=k.data,vt=F.data,Ut=4===Fe&&qe;for(let qe=0;qe<Oe.height;qe++){const xi=((Me.y+qe)*k.width+Me.x)*Fe,vi=((Ae.y+qe)*F.width+Ae.x)*Fe;if(Ut)for(let k=0;k<Oe.width;k++){const F=xi+k*Fe+3,Me=vi+k*Fe;vt[Me+0]=255,vt[Me+1]=255,vt[Me+2]=255,vt[Me+3]=pt[F]}else if(je)for(let k=0;k<Oe.width;k++){const F=xi+k*Fe,Me=vi+k*Fe,Ae=pt[F+3],Oe=new Ie(pt[F+0]/255*Ae,pt[F+1]/255*Ae,pt[F+2]/255*Ae,Ae).toRenderColor(je).toArray();vt[Me+0]=Oe[0],vt[Me+1]=Oe[1],vt[Me+2]=Oe[2],vt[Me+3]=Oe[3]}else for(let k=0;k<Oe.width*Fe;k++)vt[vi+k]=pt[xi+k]}return F}oa(Ku,"HeatmapBucket",{omit:["layers"]});class ac{constructor(k,F){rc(this,k,1,F)}resize(k){nc(this,new ac(k),1)}clone(){return new ac({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(k,F,Me,Ae,Oe){ic(k,F,Me,Ae,Oe,1,null)}}class sc{constructor(k,F){rc(this,k,4,F)}resize(k){nc(this,new sc(k),4)}replace(k,F){F?this.data.set(k):this.data=k instanceof Uint8ClampedArray?new Uint8Array(k.buffer):k}clone(){return new sc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(k,F,Me,Ae,Oe,Fe,je){ic(k,F,Me,Ae,Oe,4,Fe,je)}}class oc{constructor(k,F){this.width=k.width,this.height=k.height,this.data=F instanceof Uint8Array?new Float32Array(F.buffer):F}}function lc(k){const F={},Me=k.resolution||256,Ae=k.clips?k.clips.length:1,Oe=k.image||new sc({width:Me,height:Ae}),a=(Me,Ae,Fe)=>{F[k.evaluationKey]=Fe;const je=k.expression.evaluate(F);je&&(Oe.data[Me+Ae+0]=Math.floor(255*je.r/je.a),Oe.data[Me+Ae+1]=Math.floor(255*je.g/je.a),Oe.data[Me+Ae+2]=Math.floor(255*je.b/je.a),Oe.data[Me+Ae+3]=Math.floor(255*je.a))};if(k.clips)for(let F=0,Oe=0;F<Ae;++F,Oe+=4*Me)for(let Ae=0,Fe=0;Ae<Me;Ae++,Fe+=4){const je=Ae/(Me-1),{start:qe,end:pt}=k.clips[F];a(Oe,Fe,qe*(1-je)+pt*je)}else for(let k=0,F=0;k<Me;k++,F+=4)a(0,F,k/(Me-1));return Oe}oa(ac,"AlphaImage"),oa(sc,"RGBAImage");const h_=ys([{name:"a_pos",components:2,type:"Int16"}],4),{members:u_}=h_;function hc(k,F,Me=2){const Ae=F&&F.length,Oe=Ae?F[0]*Me:k.length;let Fe=pc(k,0,Oe,Me,!0);const je=[];if(!Fe||Fe.next===Fe.prev)return je;let qe,pt,vt;if(Ae&&(Fe=function(k,F,Me,Ae){const Oe=[];for(let Me=0,Fe=F.length;Me<Fe;Me++){const je=pc(k,F[Me]*Ae,Me<Fe-1?F[Me+1]*Ae:k.length,Ae,!1);je===je.next&&(je.steiner=!0),Oe.push(Mc(je))}Oe.sort(vc);for(let k=0;k<Oe.length;k++)Me=bc(Oe[k],Me);return Me}(k,F,Fe,Me)),k.length>80*Me){qe=1/0,pt=1/0;let F=-1/0,Ae=-1/0;for(let Fe=Me;Fe<Oe;Fe+=Me){const Me=k[Fe],Oe=k[Fe+1];Me<qe&&(qe=Me),Oe<pt&&(pt=Oe),Me>F&&(F=Me),Oe>Ae&&(Ae=Oe)}vt=Math.max(F-qe,Ae-pt),vt=0!==vt?32767/vt:0}return dc(Fe,je,Me,qe,pt,vt,0),je}function pc(k,F,Me,Ae,Oe){let Fe;if(Oe===function(k,F,Me,Ae){let Oe=0;for(let Fe=F,je=Me-Ae;Fe<Me;Fe+=Ae)Oe+=(k[je]-k[Fe])*(k[Fe+1]+k[je+1]),je=Fe;return Oe}(k,F,Me,Ae)>0)for(let Oe=F;Oe<Me;Oe+=Ae)Fe=Vc(Oe/Ae|0,k[Oe],k[Oe+1],Fe);else for(let Oe=Me-Ae;Oe>=F;Oe-=Ae)Fe=Vc(Oe/Ae|0,k[Oe],k[Oe+1],Fe);return Fe&&Pc(Fe,Fe.next)&&(Cc(Fe),Fe=Fe.next),Fe}function fc(k,F){if(!k)return k;F||(F=k);let Me,Ae=k;do{if(Me=!1,Ae.steiner||!Pc(Ae,Ae.next)&&0!==Ic(Ae.prev,Ae,Ae.next))Ae=Ae.next;else{if(Cc(Ae),Ae=F=Ae.prev,Ae===Ae.next)break;Me=!0}}while(Me||Ae!==F);return F}function dc(k,F,Me,Ae,Oe,Fe,je){if(!k)return;!je&&Fe&&function(k,F,Me,Ae){let Oe=k;do{0===Oe.z&&(Oe.z=wc(Oe.x,Oe.y,F,Me,Ae)),Oe.prevZ=Oe.prev,Oe.nextZ=Oe.next,Oe=Oe.next}while(Oe!==k);Oe.prevZ.nextZ=null,Oe.prevZ=null,function(k){let F,Me=1;do{let Ae,Oe=k;k=null;let Fe=null;for(F=0;Oe;){F++;let je=Oe,qe=0;for(let k=0;k<Me&&(qe++,je=je.nextZ,je);k++);let pt=Me;for(;qe>0||pt>0&&je;)0!==qe&&(0===pt||!je||Oe.z<=je.z)?(Ae=Oe,Oe=Oe.nextZ,qe--):(Ae=je,je=je.nextZ,pt--),Fe?Fe.nextZ=Ae:k=Ae,Ae.prevZ=Fe,Fe=Ae;Oe=je}Fe.nextZ=null,Me*=2}while(F>1)}(Oe)}(k,Ae,Oe,Fe);let qe=k;for(;k.prev!==k.next;){const pt=k.prev,vt=k.next;if(Fe?yc(k,Ae,Oe,Fe):mc(k))F.push(pt.i,k.i,vt.i),Cc(k),k=vt.next,qe=vt.next;else if((k=vt)===qe){je?1===je?dc(k=gc(fc(k),F),F,Me,Ae,Oe,Fe,2):2===je&&xc(k,F,Me,Ae,Oe,Fe):dc(fc(k),F,Me,Ae,Oe,Fe,1);break}}}function mc(k){const F=k.prev,Me=k,Ae=k.next;if(Ic(F,Me,Ae)>=0)return!1;const Oe=F.x,Fe=Me.x,je=Ae.x,qe=F.y,pt=Me.y,vt=Ae.y,Ut=Oe<Fe?Oe<je?Oe:je:Fe<je?Fe:je,xi=qe<pt?qe<vt?qe:vt:pt<vt?pt:vt,vi=Oe>Fe?Oe>je?Oe:je:Fe>je?Fe:je,bi=qe>pt?qe>vt?qe:vt:pt>vt?pt:vt;let wi=Ae.next;for(;wi!==F;){if(wi.x>=Ut&&wi.x<=vi&&wi.y>=xi&&wi.y<=bi&&Ac(Oe,qe,Fe,pt,je,vt,wi.x,wi.y)&&Ic(wi.prev,wi,wi.next)>=0)return!1;wi=wi.next}return!0}function yc(k,F,Me,Ae){const Oe=k.prev,Fe=k,je=k.next;if(Ic(Oe,Fe,je)>=0)return!1;const qe=Oe.x,pt=Fe.x,vt=je.x,Ut=Oe.y,xi=Fe.y,vi=je.y,bi=qe<pt?qe<vt?qe:vt:pt<vt?pt:vt,wi=Ut<xi?Ut<vi?Ut:vi:xi<vi?xi:vi,Mi=qe>pt?qe>vt?qe:vt:pt>vt?pt:vt,pr=Ut>xi?Ut>vi?Ut:vi:xi>vi?xi:vi,Ur=wc(bi,wi,F,Me,Ae),Wr=wc(Mi,pr,F,Me,Ae);let Jr=k.prevZ,Qr=k.nextZ;for(;Jr&&Jr.z>=Ur&&Qr&&Qr.z<=Wr;){if(Jr.x>=bi&&Jr.x<=Mi&&Jr.y>=wi&&Jr.y<=pr&&Jr!==Oe&&Jr!==je&&Ac(qe,Ut,pt,xi,vt,vi,Jr.x,Jr.y)&&Ic(Jr.prev,Jr,Jr.next)>=0)return!1;if(Jr=Jr.prevZ,Qr.x>=bi&&Qr.x<=Mi&&Qr.y>=wi&&Qr.y<=pr&&Qr!==Oe&&Qr!==je&&Ac(qe,Ut,pt,xi,vt,vi,Qr.x,Qr.y)&&Ic(Qr.prev,Qr,Qr.next)>=0)return!1;Qr=Qr.nextZ}for(;Jr&&Jr.z>=Ur;){if(Jr.x>=bi&&Jr.x<=Mi&&Jr.y>=wi&&Jr.y<=pr&&Jr!==Oe&&Jr!==je&&Ac(qe,Ut,pt,xi,vt,vi,Jr.x,Jr.y)&&Ic(Jr.prev,Jr,Jr.next)>=0)return!1;Jr=Jr.prevZ}for(;Qr&&Qr.z<=Wr;){if(Qr.x>=bi&&Qr.x<=Mi&&Qr.y>=wi&&Qr.y<=pr&&Qr!==Oe&&Qr!==je&&Ac(qe,Ut,pt,xi,vt,vi,Qr.x,Qr.y)&&Ic(Qr.prev,Qr,Qr.next)>=0)return!1;Qr=Qr.nextZ}return!0}function gc(k,F){let Me=k;do{const Ae=Me.prev,Oe=Me.next.next;!Pc(Ae,Oe)&&zc(Ae,Me,Me.next,Oe)&&Tc(Ae,Oe)&&Tc(Oe,Ae)&&(F.push(Ae.i,Me.i,Oe.i),Cc(Me),Cc(Me.next),Me=k=Oe),Me=Me.next}while(Me!==k);return fc(Me)}function xc(k,F,Me,Ae,Oe,Fe){let je=k;do{let k=je.next.next;for(;k!==je.prev;){if(je.i!==k.i&&Sc(je,k)){let qe=Bc(je,k);return je=fc(je,je.next),qe=fc(qe,qe.next),dc(je,F,Me,Ae,Oe,Fe,0),void dc(qe,F,Me,Ae,Oe,Fe,0)}k=k.next}je=je.next}while(je!==k)}function vc(k,F){return k.x-F.x}function bc(k,F){const Me=function(k,F){let Me=F;const Ae=k.x,Oe=k.y;let Fe,je=-1/0;do{if(Oe<=Me.y&&Oe>=Me.next.y&&Me.next.y!==Me.y){const k=Me.x+(Oe-Me.y)*(Me.next.x-Me.x)/(Me.next.y-Me.y);if(k<=Ae&&k>je&&(je=k,Fe=Me.x<Me.next.x?Me:Me.next,k===Ae))return Fe}Me=Me.next}while(Me!==F);if(!Fe)return null;const qe=Fe,pt=Fe.x,vt=Fe.y;let Ut=1/0;Me=Fe;do{if(Ae>=Me.x&&Me.x>=pt&&Ae!==Me.x&&Ac(Oe<vt?Ae:je,Oe,pt,vt,Oe<vt?je:Ae,Oe,Me.x,Me.y)){const F=Math.abs(Oe-Me.y)/(Ae-Me.x);Tc(Me,k)&&(F<Ut||F===Ut&&(Me.x>Fe.x||Me.x===Fe.x&&_c(Fe,Me)))&&(Fe=Me,Ut=F)}Me=Me.next}while(Me!==qe);return Fe}(k,F);if(!Me)return F;const Ae=Bc(Me,k);return fc(Ae,Ae.next),fc(Me,Me.next)}function _c(k,F){return Ic(k.prev,k,F.prev)<0&&Ic(F.next,k,k.next)<0}function wc(k,F,Me,Ae,Oe){return(k=1431655765&((k=858993459&((k=252645135&((k=16711935&((k=(k-Me)*Oe|0)|k<<8))|k<<4))|k<<2))|k<<1))|(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=(F-Ae)*Oe|0)|F<<8))|F<<4))|F<<2))|F<<1))<<1}function Mc(k){let F=k,Me=k;do{(F.x<Me.x||F.x===Me.x&&F.y<Me.y)&&(Me=F),F=F.next}while(F!==k);return Me}function Ac(k,F,Me,Ae,Oe,Fe,je,qe){return(Oe-je)*(F-qe)>=(k-je)*(Fe-qe)&&(k-je)*(Ae-qe)>=(Me-je)*(F-qe)&&(Me-je)*(Fe-qe)>=(Oe-je)*(Ae-qe)}function Sc(k,F){return k.next.i!==F.i&&k.prev.i!==F.i&&!function(k,F){let Me=k;do{if(Me.i!==k.i&&Me.next.i!==k.i&&Me.i!==F.i&&Me.next.i!==F.i&&zc(Me,Me.next,k,F))return!0;Me=Me.next}while(Me!==k);return!1}(k,F)&&(Tc(k,F)&&Tc(F,k)&&function(k,F){let Me=k,Ae=!1;const Oe=(k.x+F.x)/2,Fe=(k.y+F.y)/2;do{Me.y>Fe!=Me.next.y>Fe&&Me.next.y!==Me.y&&Oe<(Me.next.x-Me.x)*(Fe-Me.y)/(Me.next.y-Me.y)+Me.x&&(Ae=!Ae),Me=Me.next}while(Me!==k);return Ae}(k,F)&&(Ic(k.prev,k,F.prev)||Ic(k,F.prev,F))||Pc(k,F)&&Ic(k.prev,k,k.next)>0&&Ic(F.prev,F,F.next)>0)}function Ic(k,F,Me){return(F.y-k.y)*(Me.x-F.x)-(F.x-k.x)*(Me.y-F.y)}function Pc(k,F){return k.x===F.x&&k.y===F.y}function zc(k,F,Me,Ae){const Oe=kc(Ic(k,F,Me)),Fe=kc(Ic(k,F,Ae)),je=kc(Ic(Me,Ae,k)),qe=kc(Ic(Me,Ae,F));return Oe!==Fe&&je!==qe||!(0!==Oe||!Ec(k,Me,F))||!(0!==Fe||!Ec(k,Ae,F))||!(0!==je||!Ec(Me,k,Ae))||!(0!==qe||!Ec(Me,F,Ae))}function Ec(k,F,Me){return F.x<=Math.max(k.x,Me.x)&&F.x>=Math.min(k.x,Me.x)&&F.y<=Math.max(k.y,Me.y)&&F.y>=Math.min(k.y,Me.y)}function kc(k){return k>0?1:k<0?-1:0}function Tc(k,F){return Ic(k.prev,k,k.next)<0?Ic(k,F,k.next)>=0&&Ic(k,k.prev,F)>=0:Ic(k,F,k.prev)<0||Ic(k,k.next,F)<0}function Bc(k,F){const Me=Dc(k.i,k.x,k.y),Ae=Dc(F.i,F.x,F.y),Oe=k.next,Fe=F.prev;return k.next=F,F.prev=k,Me.next=Oe,Oe.prev=Me,Ae.next=Me,Me.prev=Ae,Fe.next=Ae,Ae.prev=Fe,Ae}function Vc(k,F,Me,Ae){const Oe=Dc(k,F,Me);return Ae?(Oe.next=Ae.next,Oe.prev=Ae,Ae.next.prev=Oe,Ae.next=Oe):(Oe.prev=Oe,Oe.next=Oe),Oe}function Cc(k){k.next.prev=k.prev,k.prev.next=k.next,k.prevZ&&(k.prevZ.nextZ=k.nextZ),k.nextZ&&(k.nextZ.prevZ=k.prevZ)}function Dc(k,F,Me){return{i:k,x:F,y:Me,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Lc(k,F){const Me=k.length;if(Me<=1)return[k];const Ae=[];let Oe,Fe;for(let F=0;F<Me;F++){const Me=mt(k[F]);0!==Me&&(k[F].area=Math.abs(Me),void 0===Fe&&(Fe=Me<0),Fe===Me<0?(Oe&&Ae.push(Oe),Oe=[k[F]]):Oe.push(k[F]))}if(Oe&&Ae.push(Oe),F>1)for(let k=0;k<Ae.length;k++)Ae[k].length<=F||(vr(Ae[k],F,1,Ae[k].length-1,Rc),Ae[k]=Ae[k].slice(0,F));return Ae}function Rc(k,F){return F.area-k.area}function Fc(k,F){if(!k)return null;const Me="string"==typeof k?k:k.getPrimary().id;F[Me]||(F[Me]=[]);const Ae=tr.from(k).getPrimary();return F[Me].push(Ae),Ae.serialize()}function Oc(k,F,Me){const Ae=Me.patternDependencies;let Oe=!1;for(const Me of F){const F=Me.paint.get(`${k}-pattern`);F.isConstant()||(Oe=!0),Fc(F.constantOr(null),Ae)&&(Oe=!0)}return Oe}function Nc(k,F,Me,Ae,Oe){const Fe=Oe.patternDependencies;for(const je of F){const F=je.paint.get(`${k}-pattern`).value;if("constant"!==F.kind){let k=F.evaluate({zoom:Ae},Me,{},Oe.availableImages);k=k&&k.name?k.name:k;const qe=Fc(k,Fe);qe&&(Me.patterns[je.id]=qe)}}return Me}class Uc{constructor(k){this.zoom=k.zoom,this.overscaling=k.overscaling,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.index=k.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new xs,this.indexArray=new Ls,this.indexArray2=new Ts,this.programConfigurations=new No(k.layers,{zoom:k.zoom,lut:k.lut}),this.segments=new po,this.segments2=new po,this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.projection=k.projection}updateFootprints(k,F){}populate(k,F,Me,Ae){this.hasPattern=Oc("fill",this.layers,F);const Oe=this.layers[0].layout.get("fill-sort-key"),Fe=[];for(const{feature:je,id:qe,index:pt,sourceLayerIndex:vt}of k){const k=this.layers[0]._featureFilter.needGeometry,Ut=El(je,k);if(!this.layers[0]._featureFilter.filter(new Va(this.zoom),Ut,Me))continue;const xi=Oe?Oe.evaluate(Ut,{},Me,F.availableImages):void 0,vi={id:qe,properties:je.properties,type:je.type,sourceLayerIndex:vt,index:pt,geometry:k?Ut.geometry:zl(je,Me,Ae),patterns:{},sortKey:xi};Fe.push(vi)}Oe&&Fe.sort(((k,F)=>k.sortKey-F.sortKey));for(const Ae of Fe){const{geometry:Oe,index:Fe,sourceLayerIndex:je}=Ae;if(this.hasPattern){const k=Nc("fill",this.layers,Ae,this.zoom,F);this.patternFeatures.push(k)}else this.addFeature(Ae,Oe,Fe,Me,{},F.availableImages,F.brightness);F.featureIndex.insert(k[Fe].feature,Oe,Fe,je,this.index)}}update(k,F,Me,Ae,Oe,Fe,je){this.programConfigurations.updatePaintArrays(k,F,Oe,Me,Ae,Fe,je)}addFeatures(k,F,Me,Ae,Oe,Fe){for(const k of this.patternFeatures)this.addFeature(k,k.geometry,k.index,F,Me,Ae,Fe)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(k){this.uploaded||(this.layoutVertexBuffer=k.createVertexBuffer(this.layoutVertexArray,u_),this.indexBuffer=k.createIndexBuffer(this.indexArray),this.indexBuffer2=k.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(k),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(k,F,Me,Ae,Oe,Fe=[],je){for(const k of Lc(F,500)){let F=0;for(const Me of k)F+=Me.length;const Me=this.segments.prepareSegment(F,this.layoutVertexArray,this.indexArray),Ae=Me.vertexLength,Oe=[],Fe=[];for(const F of k){if(0===F.length)continue;F!==k[0]&&Fe.push(Oe.length/2);const Me=this.segments2.prepareSegment(F.length,this.layoutVertexArray,this.indexArray2),Ae=Me.vertexLength;this.layoutVertexArray.emplaceBack(F[0].x,F[0].y),this.indexArray2.emplaceBack(Ae+F.length-1,Ae),Oe.push(F[0].x),Oe.push(F[0].y);for(let k=1;k<F.length;k++)this.layoutVertexArray.emplaceBack(F[k].x,F[k].y),this.indexArray2.emplaceBack(Ae+k-1,Ae+k),Oe.push(F[k].x),Oe.push(F[k].y);Me.vertexLength+=F.length,Me.primitiveLength+=F.length}const je=hc(Oe,Fe);for(let k=0;k<je.length;k+=3)this.indexArray.emplaceBack(Ae+je[k],Ae+je[k+1],Ae+je[k+2]);Me.vertexLength+=F,Me.primitiveLength+=je.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,k,Me,Oe,Fe,Ae,je)}}let d_,p_,f_,m_;oa(Uc,"FillBucket",{omit:["layers","patternFeatures"]});class Yc{constructor(k,F,Me,Ae){if(this.triangleCount=F.length/3,this.min=new Sa(0,0),this.max=new Sa(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===k.length)return;const[Oe,Fe]=[k[0].clone(),k[0].clone()];for(let F=1;F<k.length;++F){const Me=k[F];Oe.x=Math.min(Oe.x,Me.x),Oe.y=Math.min(Oe.y,Me.y),Fe.x=Math.max(Fe.x,Me.x),Fe.y=Math.max(Fe.y,Me.y)}if(Ae){const k=Math.ceil(Math.max(Fe.x-Oe.x,Fe.y-Oe.y)/Ae);Me=Math.max(Me,k)}if(0===Me)return;this.min=Oe,this.max=Fe;const je=this.max.sub(this.min);je.x=Math.max(je.x,1),je.y=Math.max(je.y,1);const qe=Math.max(je.x,je.y)/Me;this.cellsX=Math.max(1,Math.ceil(je.x/qe)),this.cellsY=Math.max(1,Math.ceil(je.y/qe)),this.xScale=1/qe,this.yScale=1/qe;const pt=[];for(let Me=0;Me<this.triangleCount;Me++){const Ae=k[F[3*Me+0]].sub(this.min),Oe=k[F[3*Me+1]].sub(this.min),Fe=k[F[3*Me+2]].sub(this.min),je=Xc(Math.floor(Math.min(Ae.x,Oe.x,Fe.x)),this.xScale,this.cellsX),vt=Xc(Math.floor(Math.max(Ae.x,Oe.x,Fe.x)),this.xScale,this.cellsX),Ut=Xc(Math.floor(Math.min(Ae.y,Oe.y,Fe.y)),this.yScale,this.cellsY),xi=Xc(Math.floor(Math.max(Ae.y,Oe.y,Fe.y)),this.yScale,this.cellsY),vi=new Sa(0,0),bi=new Sa(0,0),wi=new Sa(0,0),Mi=new Sa(0,0);for(let k=Ut;k<=xi;++k){vi.y=bi.y=k*qe,wi.y=Mi.y=(k+1)*qe;for(let F=je;F<=vt;++F)vi.x=wi.x=F*qe,bi.x=Mi.x=(F+1)*qe,(Yl(Ae,Oe,Fe,vi,bi,Mi)||Yl(Ae,Oe,Fe,vi,Mi,wi))&&pt.push({cellIdx:k*this.cellsX+F,triIdx:Me})}}if(0===pt.length)return;pt.sort(((k,F)=>k.cellIdx-F.cellIdx||k.triIdx-F.triIdx));let vt=0;for(;vt<pt.length;){const k=pt[vt].cellIdx,F={start:this.payload.length,len:0};for(;vt<pt.length&&pt[vt].cellIdx===k;)++F.len,this.payload.push(pt[vt++].triIdx);this.cells[k]=F}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(k,F){if(0===this.triangleCount||0===this.cells.length)return;if(k.x>this.max.x||this.min.x>k.x||k.y>this.max.y||this.min.y>k.y)return;const Me=Xc(k.x-this.min.x,this.xScale,this.cellsX),Ae=Xc(k.y-this.min.y,this.yScale,this.cellsY),Oe=this.cells[Ae*this.cellsX+Me];if(Oe){this._lazyInitLookup();for(let k=0;k<Oe.len;k++){const Me=this.payload[Oe.start+k],Ae=Math.floor(Me/8),Fe=1<<Me%8;if(!(this.lookup[Ae]&Fe)&&(this.lookup[Ae]|=Fe,F.push(Me),F.length===this.triangleCount))return}}}query(k,F,Me){if(0===this.triangleCount||0===this.cells.length)return;if(k.x>this.max.x||this.min.x>F.x)return;if(k.y>this.max.y||this.min.y>F.y)return;this._lazyInitLookup();const Ae=Xc(k.x-this.min.x,this.xScale,this.cellsX),Oe=Xc(F.x-this.min.x,this.xScale,this.cellsX),Fe=Xc(k.y-this.min.y,this.yScale,this.cellsY),je=Xc(F.y-this.min.y,this.yScale,this.cellsY);for(let k=Fe;k<=je;k++)for(let F=Ae;F<=Oe;F++){const Ae=this.cells[k*this.cellsX+F];if(Ae)for(let k=0;k<Ae.len;k++){const F=this.payload[Ae.start+k],Oe=Math.floor(F/8),Fe=1<<F%8;if(!(this.lookup[Oe]&Fe)&&(this.lookup[Oe]|=Fe,Me.push(F),Me.length===this.triangleCount))return}}}}function Xc(k,F,Me){return Math.max(0,Math.min(Me-1,Math.floor(k*F)))}oa(Yc,"TriangleGridIndex");class Zc{constructor(k){this.zoom=k.zoom,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.index=k.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.footprints=[]}updateFootprints(k,F){for(const Me of this.footprints)F.push({footprint:Me,id:k})}populate(k,F,Me,Ae){const Oe=[];for(const{feature:F,id:Fe,index:je,sourceLayerIndex:qe}of k){const k=this.layers[0]._featureFilter.needGeometry,pt=El(F,k);if(!this.layers[0]._featureFilter.filter(new Va(this.zoom),pt,Me))continue;const vt={id:Fe,properties:F.properties,type:F.type,sourceLayerIndex:qe,index:je,geometry:k?pt.geometry:zl(F,Me,Ae),patterns:{}};Oe.push(vt)}for(const Ae of Oe){const{geometry:Oe,index:Fe,sourceLayerIndex:je}=Ae;this.addFeature(Ae,Oe,Fe,Me,{},F.availableImages,F.brightness),F.featureIndex.insert(k[Fe].feature,Oe,Fe,je,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(k){}update(k,F,Me,Ae,Oe,Fe,je){}destroy(){}addFeature(k,F,Me,Ae,Oe,Fe=[],je){for(const k of Lc(F,2)){const F=[],Me=[],Ae=[],Oe=new Sa(1/0,1/0),Fe=new Sa(-1/0,-1/0);for(const je of k)if(0!==je.length){je!==k[0]&&Ae.push(Me.length/2);for(let k=0;k<je.length;k++)Me.push(je[k].x),Me.push(je[k].y),F.push(je[k]),Oe.x=Math.min(Oe.x,je[k].x),Oe.y=Math.min(Oe.y,je[k].y),Fe.x=Math.max(Fe.x,je[k].x),Fe.y=Math.max(Fe.y,je[k].y)}const je=hc(Me,Ae),qe=new Yc(F,je,8,256);this.footprints.push({vertices:F,indices:je,grid:qe,min:Oe,max:Fe})}}}oa(Zc,"ClipBucket",{omit:["layers"]});const __=ys([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),g_=ys([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),y_=ys([{name:"a_centroid_pos",components:2,type:"Uint16"}]),x_=ys([{name:"a_join_normal_inside",components:3,type:"Int16"}]),v_=ys([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),b_=ys([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:w_}=__;var T_,S_,M_,E_,I_,A_,C_,z_={};function ch(){if(S_)return T_;S_=1;var F=j();function e(F,Me,Ae,Oe,Fe){(this||k).properties={},(this||k).extent=Ae,(this||k).type=0,(this||k)._pbf=F,(this||k)._geometry=-1,(this||k)._keys=Oe,(this||k)._values=Fe,F.readFields(r,this||k,Me)}function r(k,F,Me){1==k?F.id=Me.readVarint():2==k?function(k,F){for(var Me=k.readVarint()+k.pos;k.pos<Me;){var Ae=F._keys[k.readVarint()],Oe=F._values[k.readVarint()];F.properties[Ae]=Oe}}(Me,F):3==k?F.type=Me.readVarint():4==k&&(F._geometry=Me.pos)}function n(k){for(var F,Me,Ae=0,Oe=0,Fe=k.length,je=Fe-1;Oe<Fe;je=Oe++)Ae+=((Me=k[je]).x-(F=k[Oe]).x)*(F.y+Me.y);return Ae}return T_=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var Me=(this||k)._pbf;Me.pos=(this||k)._geometry;for(var Ae,Oe=Me.readVarint()+Me.pos,Fe=1,je=0,qe=0,pt=0,vt=[];Me.pos<Oe;){if(je<=0){var Ut=Me.readVarint();Fe=7&Ut,je=Ut>>3}if(je--,1===Fe||2===Fe)qe+=Me.readSVarint(),pt+=Me.readSVarint(),1===Fe&&(Ae&&vt.push(Ae),Ae=[]),Ae.push(new F(qe,pt));else{if(7!==Fe)throw new Error("unknown command "+Fe);Ae&&Ae.push(Ae[0].clone())}}return Ae&&vt.push(Ae),vt},e.prototype.bbox=function(){var F=(this||k)._pbf;F.pos=(this||k)._geometry;for(var Me=F.readVarint()+F.pos,Ae=1,Oe=0,Fe=0,je=0,qe=1/0,pt=-1/0,vt=1/0,Ut=-1/0;F.pos<Me;){if(Oe<=0){var xi=F.readVarint();Ae=7&xi,Oe=xi>>3}if(Oe--,1===Ae||2===Ae)(Fe+=F.readSVarint())<qe&&(qe=Fe),Fe>pt&&(pt=Fe),(je+=F.readSVarint())<vt&&(vt=je),je>Ut&&(Ut=je);else if(7!==Ae)throw new Error("unknown command "+Ae)}return[qe,vt,pt,Ut]},e.prototype.toGeoJSON=function(F,Me,Ae){var Oe,Fe,je=(this||k).extent*Math.pow(2,Ae),qe=(this||k).extent*F,pt=(this||k).extent*Me,vt=this.loadGeometry(),Ut=e.types[(this||k).type];function p(k){for(var F=0;F<k.length;F++){var Me=k[F];k[F]=[360*(Me.x+qe)/je-180,360/Math.PI*Math.atan(Math.exp((180-360*(Me.y+pt)/je)*Math.PI/180))-90]}}switch((this||k).type){case 1:var xi=[];for(Oe=0;Oe<vt.length;Oe++)xi[Oe]=vt[Oe][0];p(vt=xi);break;case 2:for(Oe=0;Oe<vt.length;Oe++)p(vt[Oe]);break;case 3:for(vt=function(k){var F=k.length;if(F<=1)return[k];for(var Me,Ae,Oe=[],Fe=0;Fe<F;Fe++){var je=n(k[Fe]);0!==je&&(void 0===Ae&&(Ae=je<0),Ae===je<0?(Me&&Oe.push(Me),Me=[k[Fe]]):Me.push(k[Fe]))}return Me&&Oe.push(Me),Oe}(vt),Oe=0;Oe<vt.length;Oe++)for(Fe=0;Fe<vt[Oe].length;Fe++)p(vt[Oe][Fe])}1===vt.length?vt=vt[0]:Ut="Multi"+Ut;var vi={type:"Feature",geometry:{type:Ut,coordinates:vt},properties:(this||k).properties};return"id"in(this||k)&&(vi.id=(this||k).id),vi},T_}function hh(){if(E_)return M_;E_=1;var F=ch();function e(F,Me){(this||k).version=1,(this||k).name=null,(this||k).extent=4096,(this||k).length=0,(this||k)._pbf=F,(this||k)._keys=[],(this||k)._values=[],(this||k)._features=[],F.readFields(r,this||k,Me),(this||k).length=(this||k)._features.length}function r(k,F,Me){15===k?F.version=Me.readVarint():1===k?F.name=Me.readString():5===k?F.extent=Me.readVarint():2===k?F._features.push(Me.pos):3===k?F._keys.push(Me.readString()):4===k&&F._values.push(function(k){for(var F=null,Me=k.readVarint()+k.pos;k.pos<Me;){var Ae=k.readVarint()>>3;F=1===Ae?k.readString():2===Ae?k.readFloat():3===Ae?k.readDouble():4===Ae?k.readVarint64():5===Ae?k.readVarint():6===Ae?k.readSVarint():7===Ae?k.readBoolean():null}return F}(Me))}return M_=e,e.prototype.feature=function(Me){if(Me<0||Me>=(this||k)._features.length)throw new Error("feature index out of bounds");(this||k)._pbf.pos=(this||k)._features[Me];var Ae=(this||k)._pbf.readVarint()+(this||k)._pbf.pos;return new F((this||k)._pbf,Ae,(this||k).extent,(this||k)._keys,(this||k)._values)},M_}function ph(){return C_||(C_=1,z_.VectorTile=function(){if(A_)return I_;A_=1;var F=hh();function e(k,Me,Ae){if(3===k){var Oe=new F(Ae,Ae.readVarint()+Ae.pos);Oe.length&&(Me[Oe.name]=Oe)}}return I_=function(F,Me){(this||k).layers=F.readFields(e,{},Me)},I_}(),z_.VectorTileFeature=ch(),z_.VectorTileLayer=hh()),z_}var P_=ph();class dh extends Sa{constructor(k,F,Me){super(k,F),this.z=Me}}class mh extends dh{constructor(k,F,Me,Ae){super(k,F,Me),this.w=Ae}}function yh(k,F,Me,Ae){const Oe=[],Fe=0===Ae?(k,F,Me,Ae,Oe,Fe)=>{k.push(new Sa(Fe,Me+(Fe-F)/(Ae-F)*(Oe-Me)))}:(k,F,Me,Ae,Oe,Fe)=>{k.push(new Sa(F+(Fe-Me)/(Oe-Me)*(Ae-F),Fe))};for(const je of k){const k=[];for(const Oe of je){if(Oe.length<=2)continue;const je=[];for(let k=0;k<Oe.length-1;k++){const qe=Oe[k].x,pt=Oe[k].y,vt=Oe[k+1].x,Ut=Oe[k+1].y,xi=0===Ae?qe:pt,vi=0===Ae?vt:Ut;xi<F?vi>F&&Fe(je,qe,pt,vt,Ut,F):xi>Me?vi<Me&&Fe(je,qe,pt,vt,Ut,Me):je.push(Oe[k]),vi<F&&xi>=F&&Fe(je,qe,pt,vt,Ut,F),vi>Me&&xi<=Me&&Fe(je,qe,pt,vt,Ut,Me)}let qe=Oe[Oe.length-1];const pt=0===Ae?qe.x:qe.y;pt>=F&&pt<=Me&&je.push(qe),je.length&&(qe=je[je.length-1],je[0].x===qe.x&&je[0].y===qe.y||je.push(je[0]),k.push(je))}k.length&&Oe.push(k)}return Oe}function gh(k,F,Me,Ae){const Oe="x"===Me?"y":"x",Fe=(Ae-k[Me])/(F[Me]-k[Me]);k[Oe]=k[Oe]+(F[Oe]-k[Oe])*Fe,k[Me]=Ae,k.hasOwnProperty("z")&&(k.z=ze(k.z,F.z,Fe)),k.hasOwnProperty("w")&&(k.w=ze(k.w,F.w,Fe))}function xh(k,F,Me,Ae){const Oe=Me,Fe=Ae;for(const Me of["x","y"]){let Ae=k,je=F;Ae[Me]>=je[Me]&&(Ae=F,je=k),Ae[Me]<Oe&&je[Me]>Oe&&gh(Ae,je,Me,Oe),Ae[Me]<Fe&&je[Me]>Fe&&gh(je,Ae,Me,Fe)}}const D_=Number.MAX_SAFE_INTEGER;function bh(k,F,Me,Ae){return k.order<F||k.order===D_||!(k.clipMask&Me)||function(k,F){return 0!==F.length&&void 0===F.find((F=>F===k))}(Ae,k.clipScope)}function _h(k,F){return k.x-F.x||k.y-F.y}function wh(k,F){return 0===_h(k.min,F.min)&&0===_h(k.max,F.max)}function Mh(k,F){return!(k.min.x>F.max.x||k.max.x<F.min.x||k.min.y>F.max.y||k.max.y<F.min.y)}function Ah(k,F){if(k.length!==F.length)return!1;for(let Me=0;Me<k.length;Me++)if(k[Me].sourceId!==F[Me].sourceId||!wh(k[Me],F[Me])||k[Me].order!==F[Me].order||k[Me].clipMask!==F[Me].clipMask||!$(k[Me].clipScope,F[Me].clipScope))return!1;return!0}function Sh(k,F,Me){const Ae=1/Td,Oe=1/(1<<Me.canonical.z),Fe=(F.x*Ae+Me.canonical.x)*Oe+Me.wrap,je=(F.y*Ae+Me.canonical.y)*Oe;return{min:new Sa((k.x*Ae+Me.canonical.x)*Oe+Me.wrap,(k.y*Ae+Me.canonical.y)*Oe),max:new Sa(Fe,je)}}function Ih(k,F,Me){const Ae=1<<Me.canonical.z,Oe=((F.x-Me.wrap)*Ae-Me.canonical.x)*Td,Fe=(F.y*Ae-Me.canonical.y)*Td;return{min:new Sa(((k.x-Me.wrap)*Ae-Me.canonical.x)*Td,(k.y*Ae-Me.canonical.y)*Td),max:new Sa(Oe,Fe)}}function Ph(k,F,Me,Ae,Oe,Fe,je){const qe=k.indices,pt=k.vertices,vt=[];for(let Ut=Ae;Ut<Ae+Oe;Ut+=3){const Ae=F[Me[Ut+0]+Fe],Oe=F[Me[Ut+1]+Fe],xi=F[Me[Ut+2]+Fe],vi=Math.min(Ae.x,Oe.x,xi.x),bi=Math.max(Ae.x,Oe.x,xi.x),wi=Math.min(Ae.y,Oe.y,xi.y),Mi=Math.max(Ae.y,Oe.y,xi.y);vt.length=0,k.grid.query(new Sa(vi,wi),new Sa(bi,Mi),vt);for(let k=0;k<vt.length;k++){const F=vt[k];if(Yl(pt[qe[3*F+0]],pt[qe[3*F+1]],pt[qe[3*F+2]],Ae,Oe,xi,je))return!0}}return!1}function zh(k,F,Me,Ae){if(!k||!Me)return!1;let Oe=k.vertices;if(!F.canonical.equals(Ae.canonical)||F.wrap!==Ae.wrap){if(Me.vertices.length<k.vertices.length)return zh(Me,Ae,k,F);const Fe=F.canonical,je=Ae.canonical,qe=Math.pow(2,je.z-Fe.z);Oe=k.vertices.map((k=>new Sa((k.x+Fe.x*Td)*qe-je.x*Td,(k.y+Fe.y*Td)*qe-je.y*Td)))}return Ph(Me,Oe,k.indices,0,k.indices.length,0,0)}function Eh(k,F,Me,Ae){const Oe=Math.pow(2,Ae.z-Me.z);return new Sa((k+Me.x*Td)*Oe-Ae.x*Td,(F+Me.y*Td)*Oe-Ae.y*Td)}function kh(k,F){const Me=[];F.grid.queryPoint(k,Me);const Ae=F.indices,Oe=F.vertices;for(let F=0;F<Me.length;F++){const Fe=Me[F];if(jl([Oe[Ae[3*Fe+0]],Oe[Ae[3*Fe+1]],Oe[Ae[3*Fe+2]]],k))return!0}return!1}const R_=[new Sa(0,0),new Sa(Td,0),new Sa(Td,Td),new Sa(0,Td)];function Bh(k,F){const Me=[];let Ae=[];if(!F||k.length<2)return[k];if(2===k.length)return $l(k[0],k[1],R_)?[k]:[];for(let F=0;F<k.length+2;F++){const Oe=k[F%k.length],Fe=k[(F+1)%k.length],je=$l(0===F?k[k.length-1]:k[(F-1)%k.length],Oe,R_),qe=$l(Oe,Fe,R_),pt=je||qe;pt&&Ae.push(Oe),pt&&qe||Ae.length>0&&(Ae.length>1&&Me.push(Ae),Ae=[])}return Ae.length>1&&Me.push(Ae),Me}const L_=P_.VectorTileFeature.types,O_=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],k_=["fill-extrusion-flood-light-ground-radius"],F_=Math.pow(2,13),B_=Math.pow(2,15)-1,N_=new Sa(0,1),V_=2147483648;function Nh(k,F,Me,Ae,Oe,Fe,je,qe){k.emplaceBack((F<<1)+je,(Me<<1)+Fe,(Math.floor(Ae*F_)<<1)+Oe,Math.round(qe))}function Uh(k,F,Me){k.emplaceBack(F.x*Td,F.y*Td,Me?1:0)}function jh(k,F,Me,Ae,Oe,Fe){k.emplaceBack(F.x,F.y,(Me.x<<1)+Ae,(Me.y<<1)+Oe,Fe)}function qh(k,F,Me){const Ae=16384;k.emplaceBack(F.x,F.y,F.z,Me[0]*Ae,Me[1]*Ae,Me[2]*Ae)}class $h{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Gh{constructor(){this.centroidXY=new Sa(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Sa(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Sa(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new Sa(this.max.x-this.min.x,this.max.y-this.min.y)}}class Yh{constructor(){this.acc=new Sa(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(k,F){k.min.x===Number.MAX_VALUE&&(k.min.x=k.max.x=F.x,k.min.y=k.max.y=F.y)}appendEdge(k,F,Me){this.accCount++,this.acc._add(F);let Ae=!!this.borders;F.x<k.min.x?(k.min.x=F.x,Ae=!0):F.x>k.max.x&&(k.max.x=F.x,Ae=!0),F.y<k.min.y?(k.min.y=F.y,Ae=!0):F.y>k.max.y&&(k.max.y=F.y,Ae=!0),((0===F.x||F.x===Td)&&F.x===Me.x)!=((0===F.y||F.y===Td)&&F.y===Me.y)&&this.processBorderOverlap(F,Me),Ae&&this.checkBorderIntersection(F,Me)}checkBorderIntersection(k,F){F.x<0!=k.x<0&&this.addBorderIntersection(0,ze(F.y,k.y,(0-F.x)/(k.x-F.x))),F.x>Td!=k.x>Td&&this.addBorderIntersection(1,ze(F.y,k.y,(Td-F.x)/(k.x-F.x))),F.y<0!=k.y<0&&this.addBorderIntersection(2,ze(F.x,k.x,(0-F.y)/(k.y-F.y))),F.y>Td!=k.y>Td&&this.addBorderIntersection(3,ze(F.x,k.x,(Td-F.y)/(k.y-F.y)))}addBorderIntersection(k,F){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const Me=this.borders[k];F<Me[0]&&(Me[0]=F),F>Me[1]&&(Me[1]=F)}processBorderOverlap(k,F){if(k.x===F.x){if(k.y===F.y)return;const Me=0===k.x?0:1;this.addBorderIntersection(Me,F.y),this.addBorderIntersection(Me,k.y)}else{const Me=0===k.y?2:3;this.addBorderIntersection(Me,F.x),this.addBorderIntersection(Me,k.x)}}centroid(){return 0===this.accCount?new Sa(0,0):new Sa(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((k,F)=>k+ +(F[0]!==Number.MAX_VALUE)),0):0}}function Xh(k,F){const Me=k.add(F)._unit(),Ae=Q(k.x*Me.x+k.y*Me.y,-1,1);var Oe,Fe,je;return je=Math.acos(Ae),Math.min(4,Math.max(-4,Math.tan(je)))/4*B_*((Oe=k).x*(Fe=F).y-Oe.y*Fe.x<0?-1:1)}const U_=[k=>k.x<0,k=>k.x>Td,k=>k.y<0,k=>k.y>Td];function Hh(k,F,Me,Ae){const Oe=[4];if(0===Ae)return Oe;Me._mult(Ae);const Fe=k.sub(Me),je=F.sub(Me),qe=[k,F,Fe,je];for(let k=0;k<4;k++)for(const F of qe)if(U_[k](F)){Oe.push(k);break}return Oe}class Wh{constructor(k){this.vertexArray=new _s,this.indexArray=new Ls,this.programConfigurations=new No(k.layers,{zoom:k.zoom,lut:k.lut},(k=>k_.includes(k))),this._segments=new po,this.hiddenByLandmarkVertexArray=new Ws,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new po}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(k,F,Me,Ae=!1){const Oe=k.length;if(Oe>2){let Fe=Math.max(0,this._segments.get().length-1);const je=this._segments._prepareSegment(4*Oe,this.vertexArray.length,2*this._segmentToGroundQuads[Fe].length);let qe;Fe!==this._segments.get().length-1&&(Fe++,this._segmentToGroundQuads[Fe]=[],this._segmentToRegionTriCounts[Fe]=[0,0,0,0,0]);{const F=k[0],Me=k[1];qe=Xh(F.sub(k[Oe-1])._perp()._unit(),Me.sub(F)._perp()._unit())}for(let pt=0;pt<Oe;pt++){const vt=pt===Oe-1?0:pt+1,Ut=k[pt],xi=k[vt],vi=k[vt===Oe-1?0:vt+1],bi=xi.sub(Ut)._perp()._unit(),wi=Xh(bi,vi.sub(xi)._perp()._unit()),Mi=qe,pr=wi;if(ep(Ut,xi,F)||Ae&&rp(Ut,F)&&rp(xi,F)){qe=wi;continue}const Ur=je.vertexLength;jh(this.vertexArray,Ut,xi,1,1,Mi),jh(this.vertexArray,Ut,xi,1,0,Mi),jh(this.vertexArray,Ut,xi,0,1,pr),jh(this.vertexArray,Ut,xi,0,0,pr),je.vertexLength+=4;const Wr=Hh(Ut,xi,bi,Me);for(const k of Wr)this._segmentToGroundQuads[Fe].push({id:Ur,region:k}),this._segmentToRegionTriCounts[Fe][k]+=2,je.primitiveLength+=2;qe=wi}}}prepareBorderSegments(){if(!this.hasData())return;const k=this._segments.get(),F=k.length;for(let k=0;k<F;k++)this._segmentToGroundQuads[k].sort(((k,F)=>k.region-F.region));for(let Me=0;Me<F;Me++){const F=this._segmentToGroundQuads[Me],Ae=k[Me],Oe=this._segmentToRegionTriCounts[Me];Oe.reduce(((k,F)=>k+F),0);let Fe=0;for(let k=0;k<=4;k++){const F=Oe[k];if(0!==F){let Me=this.regionSegments[k];Me||(Me=this.regionSegments[k]=new po);const Oe={vertexOffset:Ae.vertexOffset,primitiveOffset:Ae.primitiveOffset+Fe,vertexLength:Ae.vertexLength,primitiveLength:F};Me.get().push(Oe)}Fe+=F}for(let k=0;k<F.length;k++){const Me=F[k].id;this.indexArray.emplaceBack(Me,Me+1,Me+3),this.indexArray.emplaceBack(Me,Me+3,Me+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(k,F,Me,Ae,Oe,Fe){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,k,F,Me,Ae,Oe,Fe)}upload(k){this.hasData()&&(this.vertexBuffer=k.createVertexBuffer(this.vertexArray,g_.members),this.indexBuffer=k.createIndexBuffer(this.indexArray))}uploadPaintProperties(k){this.hasData()&&this.programConfigurations.upload(k)}update(k,F,Me,Ae,Oe,Fe,je){this.hasData()&&this.programConfigurations.updatePaintArrays(k,F,Me,Ae,Oe,Fe,je)}updateHiddenByLandmark(k){if(!this.hasData())return;const F=k.groundVertexCount+k.groundVertexArrayOffset;if(0===k.groundVertexCount)return;const Me=k.flags&V_?1:0;for(let Ae=k.groundVertexArrayOffset;Ae<F;++Ae)this.hiddenByLandmarkVertexArray.emplace(Ae,Me);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(k){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=k.createVertexBuffer(this.hiddenByLandmarkVertexArray,v_.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let k=0;k<=4;k++){const F=this.regionSegments[k];F&&F.destroy()}}}}class Kh{constructor(k){this.zoom=k.zoom,this.canonical=k.canonical,this.overscaling=k.overscaling,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.index=k.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=k.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Ls,this.footprintVertices=new xs,this.footprintSegments=[],this.layoutVertexArray=new bs,this.centroidVertexArray=new oo,this.wallVertexArray=new uo,this.indexArray=new Ls,this.programConfigurations=new No(k.layers,{zoom:k.zoom,lut:k.lut},(k=>O_.includes(k))),this.segments=new po,this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.groundEffect=new Wh(k),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(k,F){}populate(k,F,Me,Ae){this.features=[],this.hasPattern=Oc("fill-extrusion",this.layers,F),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=vl(Me),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:Oe,id:Fe,index:je,sourceLayerIndex:qe}of k){const k=this.layers[0]._featureFilter.needGeometry,pt=El(Oe,k);if(!this.layers[0]._featureFilter.filter(new Va(this.zoom),pt,Me))continue;const vt={id:Fe,sourceLayerIndex:qe,index:je,geometry:k?pt.geometry:zl(Oe,Me,Ae),properties:Oe.properties,type:Oe.type,patterns:{}},Ut=this.layoutVertexArray.length,xi="Polygon"===L_[vt.type];if(this.hasPattern)this.features.push(Nc("fill-extrusion",this.layers,vt,this.zoom,F));else if(this.wallMode)for(const k of vt.geometry)for(const Oe of Bh(k,xi))this.addFeature(vt,[Oe],je,Me,{},F.availableImages,Ae,F.brightness);else this.addFeature(vt,vt.geometry,je,Me,{},F.availableImages,Ae,F.brightness);F.featureIndex.insert(Oe,vt.geometry,je,qe,this.index,Ut)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(k,F,Me,Ae,Oe,Fe){for(const k of this.features){const je="Polygon"===L_[k.type],{geometry:qe}=k;if(this.wallMode)for(const pt of qe)for(const qe of Bh(pt,je))this.addFeature(k,[qe],k.index,F,Me,Ae,Oe,Fe);else this.addFeature(k,qe,k.index,F,Me,Ae,Oe,Fe)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(k,F,Me,Ae,Oe,Fe,je){this.programConfigurations.updatePaintArrays(k,F,Oe,Me,Ae,Fe,je),this.groundEffect.update(k,F,Oe,Me,Ae,Fe,je)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(k){this.uploaded||(this.layoutVertexBuffer=k.createVertexBuffer(this.layoutVertexArray,w_),this.indexBuffer=k.createIndexBuffer(this.indexArray),this.wallVertexBuffer=k.createVertexBuffer(this.wallVertexArray,x_.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=k.createVertexBuffer(this.layoutVertexExtArray,b_.members,!0)),this.groundEffect.upload(k)),this.groundEffect.uploadPaintProperties(k),this.programConfigurations.upload(k),this.uploaded=!0}uploadCentroid(k){this.groundEffect.uploadHiddenByLandmark(k),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=k.createVertexBuffer(this.centroidVertexArray,y_.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(k,F,Me,Ae,Oe,Fe,je,qe){const pt=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(k,{})/this.tileToMeter,vt=[new Sa(0,0),new Sa(Td,Td)],Ut=je.projection,xi="globe"===Ut.name,vi=this.wallMode||"Polygon"===L_[k.type],bi=new Yh;bi.centroidDataIndex=this.centroidData.length;const wi=new Gh,Mi=this.layers[0].paint.get("fill-extrusion-base").evaluate(k,{},Ae)<=0,pr=this.layers[0].paint.get("fill-extrusion-height").evaluate(k,{},Ae);let Ur;if(wi.height=pr,wi.vertexArrayOffset=this.layoutVertexArray.length,wi.groundVertexArrayOffset=this.groundEffect.vertexArray.length,xi&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ps),this.wallMode){if(xi)return void ft("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==F.length)return;Ur=function(k){const F=k[0].x===k[k.length-1].x&&k[0].y===k[k.length-1].y,Me=function(k){let F=0;const Me=k.length;for(let Ae=0;Ae<Me;Ae++)F+=(k[(Ae+1)%Me].x-k[Ae].x)*(k[(Ae+1)%Me].y+k[Ae].y);return F>=0}(k);Me||(k=k.reverse());const Ae={geometry:[],joinNormals:[],indices:[]},Oe=[],Fe=[],je=[];let qe=k.length;for(;qe>=2&&k[qe-1].equals(k[qe-2]);)qe--;if(qe<(F?3:2))return Ae;let pt,vt,Ut,xi,vi,bi=0;for(;bi<qe-1&&k[bi].equals(k[bi+1]);)bi++;F&&(pt=k[qe-2],vi=k[bi].sub(pt)._unit()._perp());for(let Me=bi;Me<qe;Me++){if(Ut=Me===qe-1?F?k[bi+1]:void 0:k[Me+1],Ut&&k[Me].equals(Ut))continue;vi&&(xi=vi),pt&&(vt=pt),pt=k[Me],vi=Ut?Ut.sub(pt)._unit()._perp():xi,xi=xi||vi;let Ae=xi.add(vi);0===Ae.x&&0===Ae.y||Ae._unit();const wi=Ae.x*vi.x+Ae.y*vi.y,Mi=0!==wi?1/wi:1/0,pr=xi.x*vi.y-xi.y*vi.x>0;let Ur="miter";const Wr=2;"miter"===Ur&&Mi>Wr&&(Ur="bevel"),"bevel"===Ur&&(Mi>100&&(Ur="flipbevel"),Mi<Wr&&(Ur="miter"));const v=(k,F,Me,Ae)=>{const qe=new Sa(k.x,k.y),pt=new Sa(k.x,k.y);qe.x+=F.x*Ae,qe.y+=F.y*Ae,pt.x-=F.x*Math.max(Me,1),pt.y-=F.y*Math.max(Me,1),je.push(F),Oe.push(qe),Fe.push(pt)};if("miter"===Ur)Ae._mult(Mi),v(pt,Ae,0,0);else if("flipbevel"===Ur)Ae=vi.mult(-1),v(pt,Ae,0,0),v(pt,Ae.mult(-1),0,0);else{const k=-Math.sqrt(Mi*Mi-1),F=pr?k:0,Me=pr?0:k;vt&&v(pt,xi,F,Me),Ut&&v(pt,vi,F,Me)}}Ae.geometry=[...Oe,...Fe.reverse(),Oe[0]],Ae.joinNormals=[...je,...je.reverse(),je[je.length-1]];const wi=Ae.geometry.length-1;for(let k=0;k<wi/2;k++)if(k+1<wi/2){let F=k,Me=k+1,Oe=wi-1-k,Fe=wi-2-k;F=0===F?wi-1:F-1,Me=0===Me?wi-1:Me-1,Oe=0===Oe?wi-1:Oe-1,Fe=0===Fe?wi-1:Fe-1,Ae.indices.push(Oe),Ae.indices.push(Me),Ae.indices.push(F),Ae.indices.push(Oe),Ae.indices.push(Fe),Ae.indices.push(Me)}return Ae}(F[0]),F=[Ur.geometry]}const x=(k,F)=>k<(F.length-1)/2||k===F.length-1,Wr=this.wallMode?[F]:Lc(F,500);for(let k=Wr.length-1;k>=0;k--){const F=Wr[k];(0===F.length||(Jr=F[0]).every((k=>k.x<=0))||Jr.every((k=>k.x>=Td))||Jr.every((k=>k.y<=0))||Jr.every((k=>k.y>=Td)))&&Wr.splice(k,1)}var Jr;let Qr;if(xi)Qr=sp(Wr,vt,Ae);else{Qr=[];for(const k of Wr)Qr.push({polygon:k,bounds:vt})}const co=vi?this.edgeRadius:0,mo=co>0&&this.zoom<17,A=(k,F)=>{if(0===k.length)return!1;const Me=k[k.length-1];return F.x===Me.x&&F.y===Me.y};for(const{polygon:k,bounds:F}of Qr){let Me=0,Oe=0;for(const F of k)vi&&!F[0].equals(F[F.length-1])&&F.push(F[0]),Oe+=vi?F.length-1:F.length;const Fe=this.segments.prepareSegment((vi?5:4)*Oe,this.layoutVertexArray,this.indexArray);wi.footprintSegIdx<0&&(wi.footprintSegIdx=this.footprintSegments.length),wi.polygonSegIdx<0&&(wi.polygonSegIdx=this.polygonSegments.length);const je={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},qe=new $h;if(qe.vertexOffset=this.footprintVertices.length,qe.indexOffset=3*this.footprintIndices.length,qe.ringIndices=[],vi){const Oe=[],je=[];Me=Fe.vertexLength;for(let Me=0;Me<k.length;Me++){const vt=k[Me];vt.length&&0!==Me&&je.push(Oe.length/2);const vi=[];let bi,wi;bi=vt[1].sub(vt[0])._perp()._unit(),qe.ringIndices.push(vt.length-1);for(let k=1;k<vt.length;k++){const F=vt[k],Me=vt[k===vt.length-1?1:k+1],je=F.clone();if(co){wi=Me.sub(F)._perp()._unit();const k=bi.add(wi)._unit(),Ae=co*Math.min(4,1/(bi.x*k.x+bi.y*k.y));je.x+=Ae*k.x,je.y+=Ae*k.y,je.x=Math.round(je.x),je.y=Math.round(je.y),bi=wi}if(!Mi||0!==co&&!mo||A(vi,je)||vi.push(je),Nh(this.layoutVertexArray,je.x,je.y,0,0,1,1,0),this.wallMode){const F=x(k,vt);Uh(this.wallVertexArray,Ur.joinNormals[k],!F)}Fe.vertexLength++,this.footprintVertices.emplaceBack(F.x,F.y),Oe.push(F.x,F.y),xi&&qh(this.layoutVertexExtArray,Ut.projectTilePoint(je.x,je.y,Ae),Ut.upVector(Ae,je.x,je.y))}Mi&&(0===co||mo)&&(0!==vi.length&&A(vi,vi[0])&&vi.pop(),this.groundEffect.addData(vi,F,pt))}const vt=this.wallMode?Ur.indices:hc(Oe,je);for(let k=0;k<vt.length;k+=3)this.footprintIndices.emplaceBack(qe.vertexOffset+vt[k+0],qe.vertexOffset+vt[k+1],qe.vertexOffset+vt[k+2]),this.indexArray.emplaceBack(Me+vt[k],Me+vt[k+2],Me+vt[k+1]),Fe.primitiveLength++;qe.indexCount+=vt.length,qe.vertexCount+=this.footprintVertices.length-qe.vertexOffset}for(let Oe=0;Oe<k.length;Oe++){const je=k[Oe];bi.startRing(wi,je[0]);let qe=je.length>4&&np(je[je.length-2],je[0],je[1]),vt=co?Qh(je[je.length-2],je[0],je[1],co):0;const pr=[];let Wr,Jr,Qr;Jr=je[1].sub(je[0])._perp()._unit();let mo=!0;for(let k=1,Oe=0;k<je.length;k++){let pt=je[k-1],vi=je[k];const yo=je[k===je.length-1?1:k+1];if(bi.appendEdge(wi,vi,pt),ep(vi,pt,F)){co&&(Jr=yo.sub(vi)._perp()._unit(),mo=!mo);continue}const To=vi.sub(pt)._perp(),zo=To.x/(Math.abs(To.x)+Math.abs(To.y)),ko=To.y>0?1:0,na=pt.dist(vi);if(Oe+na>32768&&(Oe=0),co){Qr=yo.sub(vi)._perp()._unit();let k=tp(pt,vi,yo,Jh(Jr,Qr),co);isNaN(k)&&(k=0);const F=vi.sub(pt)._unit();pt=pt.add(F.mult(vt))._round(),vi=vi.add(F.mult(-k))._round(),vt=k,Jr=Qr,Mi&&this.zoom>=17&&(A(pr,pt)||pr.push(pt),A(pr,vi)||pr.push(vi))}const aa=Fe.vertexLength,_a=je.length>4&&np(pt,vi,yo);let wa=ip(Oe,qe,mo);if(Nh(this.layoutVertexArray,pt.x,pt.y,zo,ko,0,0,wa),Nh(this.layoutVertexArray,pt.x,pt.y,zo,ko,0,1,wa),this.wallMode){const F=x(k-1,je),Me=Ur.joinNormals[k-1];Uh(this.wallVertexArray,Me,F),Uh(this.wallVertexArray,Me,F)}if(Oe+=na,wa=ip(Oe,_a,!mo),qe=_a,Nh(this.layoutVertexArray,vi.x,vi.y,zo,ko,0,0,wa),Nh(this.layoutVertexArray,vi.x,vi.y,zo,ko,0,1,wa),this.wallMode){const F=x(k,je),Me=Ur.joinNormals[k];Uh(this.wallVertexArray,Me,F),Uh(this.wallVertexArray,Me,F)}if(Fe.vertexLength+=4,this.indexArray.emplaceBack(aa+0,aa+1,aa+2),this.indexArray.emplaceBack(aa+1,aa+3,aa+2),Fe.primitiveLength+=2,co){const Ae=Me+(1===k?je.length-2:k-2),Oe=1===k?Me:Ae+1;if(this.indexArray.emplaceBack(aa+1,Ae,aa+3),this.indexArray.emplaceBack(Ae,Oe,aa+3),Fe.primitiveLength+=2,void 0===Wr&&(Wr=aa),!ep(yo,je[k],F)){const F=k===je.length-1?Wr:Fe.vertexLength;this.indexArray.emplaceBack(aa+2,aa+3,F),this.indexArray.emplaceBack(aa+3,F+1,F),this.indexArray.emplaceBack(aa+3,Oe,F+1),Fe.primitiveLength+=3}mo=!mo}if(xi){const k=this.layoutVertexExtArray,F=Ut.projectTilePoint(pt.x,pt.y,Ae),Me=Ut.projectTilePoint(vi.x,vi.y,Ae),Oe=Ut.upVector(Ae,pt.x,pt.y),Fe=Ut.upVector(Ae,vi.x,vi.y);qh(k,F,Oe),qh(k,F,Oe),qh(k,Me,Fe),qh(k,Me,Fe)}}vi&&(Me+=je.length-1),Mi&&co&&this.zoom>=17&&(0!==pr.length&&A(pr,pr[0])&&pr.pop(),this.groundEffect.addData(pr,F,pt,co>0))}this.footprintSegments.push(qe),je.triangleCount=this.indexArray.length-je.triangleArrayOffset,this.polygonSegments.push(je),++wi.footprintSegLen,++wi.polygonSegLen}if(wi.vertexCount=this.layoutVertexArray.length-wi.vertexArrayOffset,wi.groundVertexCount=this.groundEffect.vertexArray.length-wi.groundVertexArrayOffset,0!==wi.vertexCount){if(wi.centroidXY=bi.borders?N_:this.encodeCentroid(bi,wi),this.centroidData.push(wi),bi.borders){this.featuresOnBorder.push(bi);const k=this.featuresOnBorder.length-1;for(let F=0;F<bi.borders.length;F++)bi.borders[F][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[F].push(k)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,k,Me,Oe,Fe,Ae,qe),this.groundEffect.addPaintPropertiesData(k,Me,Oe,Fe,Ae,qe),this.maxHeight=Math.max(this.maxHeight,pr)}}sortBorders(){for(let k=0;k<this.borderFeatureIndices.length;k++)this.borderFeatureIndices[k].sort(((F,Me)=>this.featuresOnBorder[F].borders[k][0]-this.featuresOnBorder[Me].borders[k][0]))}splitToSubtiles(){const k=[];for(let F=0;F<this.centroidData.length;F++){const Me=this.centroidData[F],Ae=+(Me.min.y+Me.max.y>Td),Oe=2*Ae+(+(Me.min.x+Me.max.x>Td)^Ae);for(let Ae=0;Ae<Me.polygonSegLen;Ae++){const Fe=Me.polygonSegIdx+Ae;k.push({centroidIdx:F,subtile:Oe,polygonSegmentIdx:Fe,triangleSegmentIdx:this.polygonSegments[Fe].triangleSegIdx})}}const F=new Ls;k.sort(((k,F)=>k.triangleSegmentIdx===F.triangleSegmentIdx?k.subtile-F.subtile:k.triangleSegmentIdx-F.triangleSegmentIdx));let Me=0,Ae=0,Oe=0;for(const F of k){if(F.triangleSegmentIdx!==Me)break;Oe++}const Fe=k.length;for(;Ae!==k.length;){Me=k[Ae].triangleSegmentIdx;let je=0,qe=Ae,pt=Ae;for(let F=qe;F<Oe&&k[F].subtile===je;F++)pt++;for(;qe!==Oe;){const Ae=k[qe];je=Ae.subtile;const Fe=this.centroidData[Ae.centroidIdx].min.clone(),vt=this.centroidData[Ae.centroidIdx].max.clone(),Ut={vertexOffset:this.segments.segments[Me].vertexOffset,primitiveOffset:F.length,vertexLength:this.segments.segments[Me].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let Me=qe;Me<pt;Me++){const Ae=k[Me],Oe=this.polygonSegments[Ae.polygonSegmentIdx],je=this.centroidData[Ae.centroidIdx].min,qe=this.centroidData[Ae.centroidIdx].max,pt=this.indexArray.uint16;for(let k=Oe.triangleArrayOffset;k<Oe.triangleArrayOffset+Oe.triangleCount;k++)F.emplaceBack(pt[3*k],pt[3*k+1],pt[3*k+2]);Ut.primitiveLength+=Oe.triangleCount,Fe.x=Math.min(Fe.x,je.x),Fe.y=Math.min(Fe.y,je.y),vt.x=Math.max(vt.x,qe.x),vt.y=Math.max(vt.y,qe.y)}Ut.primitiveLength>0&&this.triangleSubSegments.push({segment:Ut,min:Fe,max:vt}),qe=pt;for(let F=qe;F<Oe&&k[F].subtile===k[qe].subtile;F++)pt++}Ae=Oe;for(let F=Ae;F<Fe&&k[F].triangleSegmentIdx===k[Ae].triangleSegmentIdx;F++)Oe++}F._trim(),this.indexArray=F}getVisibleSegments(k,F,Me){const Ae=new po;if(this.wallMode){for(const k of this.triangleSubSegments)Ae.segments.push(k.segment);return Ae}let Oe=0,Fe=0;const je=1<<k.canonical.z;if(F){const Me=F.getMinMaxForTile(k);Me&&(Oe=Me.min,Fe=Me.max)}Fe+=this.maxHeight;const qe=k.toUnwrapped();let pt;const vt=[qe.canonical.x/je+qe.wrap,qe.canonical.y/je],Ut=[(qe.canonical.x+1)/je+qe.wrap,(qe.canonical.y+1)/je],h=(k,F,Me)=>[k[0]*(1-Me[0])+F[0]*Me[0],k[1]*(1-Me[1])+F[1]*Me[1]],xi=[],vi=[];for(const k of this.triangleSubSegments){xi[0]=k.min.x/Td,xi[1]=k.min.y/Td,vi[0]=k.max.x/Td,vi[1]=k.max.y/Td;const F=h(vt,Ut,xi),je=h(vt,Ut,vi);if(0===new xu([F[0],F[1],Oe],[je[0],je[1],Fe]).intersectsPrecise(Me)){pt&&(Ae.segments.push(pt),pt=void 0);continue}const qe=k.segment;pt&&pt.vertexOffset!==qe.vertexOffset&&(Ae.segments.push(pt),pt=void 0),pt?(pt.vertexLength+=qe.vertexLength,pt.primitiveLength+=qe.primitiveLength):pt={vertexOffset:qe.vertexOffset,primitiveLength:qe.primitiveLength,vertexLength:qe.vertexLength,primitiveOffset:qe.primitiveOffset,sortKey:void 0,vaos:{}}}return pt&&Ae.segments.push(pt),Ae}encodeCentroid(k,F){const Me=k.centroid(),Ae=F.span(),Oe=Math.min(7,Math.round(Ae.x*this.tileToMeter/10)),Fe=Math.min(7,Math.round(Ae.y*this.tileToMeter/10));return new Sa(Q(Me.x,1,Td-1)<<3|Oe,Q(Me.y,1,Td-1)<<3|Fe)}encodeBorderCentroid(k){if(!k.borders)return new Sa(0,0);const F=k.borders,Me=Number.MAX_VALUE;if(F[0][0]!==Me||F[1][0]!==Me){const k=F[0][0]!==Me?0:1;return new Sa(6|(F[0][0]!==Me?0:65528),(F[k][0]+F[k][1])/2<<3|6)}{const k=F[2][0]!==Me?2:3;return new Sa((F[k][0]+F[k][1])/2<<3|6,6|(F[2][0]!==Me?0:65528))}}showCentroid(k){const F=this.centroidData[k.centroidDataIndex];F.flags&=V_,F.centroidXY.x=0,F.centroidXY.y=0,this.writeCentroidToBuffer(F)}writeCentroidToBuffer(k){this.groundEffect.updateHiddenByLandmark(k);const F=k.vertexArrayOffset,Me=k.vertexCount+k.vertexArrayOffset,Ae=k.flags&V_?N_:k.centroidXY,Oe=this.centroidVertexArray.geta_centroid_pos0(F);if(this.centroidVertexArray.geta_centroid_pos1(F)!==Ae.y||Oe!==Ae.x){for(let k=F;k<Me;++k)this.centroidVertexArray.emplace(k,Ae.x,Ae.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const k of this.centroidData)this.writeCentroidToBuffer(k)}updateReplacement(k,F,Me){if(F.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=F.updateTime;const Ae=F.getReplacementRegionsForTile(k.toUnwrapped());if(Ah(this.activeReplacements,Ae))return;if(this.activeReplacements=Ae,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const k of this.centroidData)k.flags&=2147483647;const Oe=[];for(const F of this.activeReplacements){if(F.order<Me)continue;const Ae=Math.max(1,Math.pow(2,F.footprintTileId.canonical.z-k.canonical.z));for(const Me of this.centroidData)if(!(Me.flags&V_||F.min.x>Me.max.x||Me.min.x>F.max.x||F.min.y>Me.max.y||Me.min.y>F.max.y))for(let Fe=0;Fe<Me.footprintSegLen;Fe++){const je=this.footprintSegments[Me.footprintSegIdx+Fe];if(Oe.length=0,op(this.footprintVertices,je.vertexOffset,je.vertexCount,F.footprintTileId.canonical,k.canonical,Oe),Ph(F.footprint,Oe,this.footprintIndices.uint16,je.indexOffset,je.indexCount,-je.vertexOffset,-Ae)){Me.flags|=V_;break}}}for(const k of this.centroidData)this.writeCentroidToBuffer(k);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(k,F,Me){let Ae=!1;for(let Oe=0;Oe<Me.footprintSegLen;Oe++){const Fe=this.footprintSegments[Me.footprintSegIdx+Oe];let je=0;for(const Me of Fe.ringIndices){for(let Oe=je,qe=Me+je-1;Oe<Me+je;qe=Oe++){const Me=this.footprintVertices.int16[2*(Oe+Fe.vertexOffset)+0],je=this.footprintVertices.int16[2*(Oe+Fe.vertexOffset)+1],pt=this.footprintVertices.int16[2*(qe+Fe.vertexOffset)+1];je>F!=pt>F&&k<(this.footprintVertices.int16[2*(qe+Fe.vertexOffset)+0]-Me)*(F-je)/(pt-je)+Me&&(Ae=!Ae)}je=Me}}return Ae}getHeightAtTileCoord(k,F){let Me=Number.NEGATIVE_INFINITY,Ae=!0;const Oe=4*(k+Td)*Td+(F+Td);if(this.partLookup.hasOwnProperty(Oe)){const k=this.partLookup[Oe];return k?{height:k.height,hidden:!!(k.flags&V_)}:void 0}for(const Fe of this.centroidData)k>Fe.max.x||Fe.min.x>k||F>Fe.max.y||Fe.min.y>F||this.footprintContainsPoint(k,F,Fe)&&Fe&&Fe.height>Me&&(Me=Fe.height,this.partLookup[Oe]=Fe,Ae=!!(Fe.flags&V_));if(Me!==Number.NEGATIVE_INFINITY)return{height:Me,hidden:Ae};this.partLookup[Oe]=void 0}}function Jh(k,F){const Me=k.add(F)._unit();return k.x*Me.x+k.y*Me.y}function Qh(k,F,Me,Ae){const Oe=F.sub(k)._perp()._unit(),Fe=Me.sub(F)._perp()._unit();return tp(k,F,Me,Jh(Oe,Fe),Ae)}function tp(k,F,Me,Ae,Oe){const Fe=Math.sqrt(1-Ae*Ae);return Math.min(k.dist(F)/3,F.dist(Me)/3,Oe*Fe/Ae)}function ep(k,F,Me){return k.x<Me[0].x&&F.x<Me[0].x||k.x>Me[1].x&&F.x>Me[1].x||k.y<Me[0].y&&F.y<Me[0].y||k.y>Me[1].y&&F.y>Me[1].y}function rp(k,F){return k.x<F[0].x||k.x>F[1].x||k.y<F[0].y||k.y>F[1].y}function np(k,F,Me){if(k.x<0||k.x>=Td||F.x<0||F.x>=Td||Me.x<0||Me.x>=Td)return!1;const Ae=Me.sub(F),Oe=Ae.perp(),Fe=k.sub(F);return(Ae.x*Fe.x+Ae.y*Fe.y)/Math.sqrt((Ae.x*Ae.x+Ae.y*Ae.y)*(Fe.x*Fe.x+Fe.y*Fe.y))>-.866&&Oe.x*Fe.x+Oe.y*Fe.y<0}function ip(k,F,Me){const Ae=F?2|k:-3&k;return Me?1|Ae:-2&Ae}function ap(){const k=Math.PI/32,F=Math.tan(k),Me=cm;return Me*Math.sqrt(1+2*F*F)-Me}function sp(k,F,Me){const Ae=1<<Me.z,Oe=pl(Me.x/Ae),Fe=pl((Me.x+1)/Ae),je=fl(Me.y/Ae),qe=fl((Me.y+1)/Ae);return function(k,F,Me,Ae,Oe=0,Fe){const je=[];if(!k.length||!Me||!Ae)return je;const o=(k,F)=>{for(const Me of k)je.push({polygon:Me,bounds:F})},qe=Math.ceil(Math.log2(Me)),pt=Math.ceil(Math.log2(Ae)),vt=qe-pt,Ut=[];for(let k=0;k<Math.abs(vt);k++)Ut.push(vt>0?0:1);for(let k=0;k<Math.min(qe,pt);k++)Ut.push(0),Ut.push(1);let xi=k;if(xi=yh(xi,F[0].y-Oe,F[1].y+Oe,1),xi=yh(xi,F[0].x-Oe,F[1].x+Oe,0),!xi.length)return je;const vi=[];for(Ut.length?vi.push({polygons:xi,bounds:F,depth:0}):o(xi,F);vi.length;){const k=vi.pop(),F=k.depth,Me=Ut[F],Ae=k.bounds[0],je=k.bounds[1],qe=0===Me?Ae.x:Ae.y,pt=0===Me?je.x:je.y,vt=Fe?Fe(Me,qe,pt):.5*(qe+pt),xi=yh(k.polygons,qe-Oe,vt+Oe,Me),bi=yh(k.polygons,vt-Oe,pt+Oe,Me);if(xi.length){const k=[Ae,new Sa(0===Me?vt:je.x,1===Me?vt:je.y)];Ut.length>F+1?vi.push({polygons:xi,bounds:k,depth:F+1}):o(xi,k)}if(bi.length){const k=[new Sa(0===Me?vt:Ae.x,1===Me?vt:Ae.y),je];Ut.length>F+1?vi.push({polygons:bi,bounds:k,depth:F+1}):o(bi,k)}}return je}(k,F,Math.ceil((Fe-Oe)/11.25),Math.ceil((je-qe)/11.25),1,((k,F,Oe)=>{if(0===k)return.5*(F+Oe);{const k=fl((Me.y+F/Td)/Ae);return(cl(.5*(fl((Me.y+Oe/Td)/Ae)+k))*Ae-Me.y)*Td}}))}function op(k,F,Me,Ae,Oe,Fe){const je=Math.pow(2,Ae.z-Oe.z);for(let qe=0;qe<Me;qe++){let Me=k.int16[2*(qe+F)+0],pt=k.int16[2*(qe+F)+1];Me=(Me+Oe.x*Td)*je-Ae.x*Td,pt=(pt+Oe.y*Td)*je-Ae.y*Td,Fe.push(new Sa(Me,pt))}}let j_,G_;function cp(k,F){return k.x*F.x+k.y*F.y}function hp(k,F){if(1===k.length){let Me=0;const Ae=F[Me++];let Oe;for(;!Oe||Ae.equals(Oe);)if(Oe=F[Me++],!Oe)return 1/0;for(;Me<F.length;Me++){const Fe=F[Me],je=k[0],qe=Oe.sub(Ae),pt=Fe.sub(Ae),vt=je.sub(Ae),Ut=cp(qe,qe),xi=cp(qe,pt),vi=cp(pt,pt),bi=cp(vt,qe),wi=cp(vt,pt),Mi=Ut*vi-xi*xi,pr=(vi*bi-xi*wi)/Mi,Ur=(Ut*wi-xi*bi)/Mi,Wr=Ae.z*(1-pr-Ur)+Oe.z*pr+Fe.z*Ur;if(isFinite(Wr))return Wr}return 1/0}{let k=1/0;for(const Me of F)k=Math.min(k,Me.z);return k}}function pp(k,F,Me,Ae,Oe,Fe,je,qe){const pt=je*Oe.getElevationAt(k,F,!0,!0),vt=0!==Fe[0],Ut=vt?0===Fe[1]?je*(Fe[0]/7-450):je*function(k,F,Me){const Ae=Math.floor(F[0]/8),Oe=Math.floor(F[1]/8),Fe=10*(F[0]-8*Ae),je=10*(F[1]-8*Oe),qe=k.getElevationAt(Ae,Oe,!0,!0),pt=k.getMeterToDEM(Me),vt=Math.floor(.5*(Fe*pt-1)),Ut=Math.floor(.5*(je*pt-1)),xi=k.tileCoordToPixel(Ae,Oe),vi=2*vt+1,bi=2*Ut+1,wi=function(k,F,Me,Ae,Oe){return[k.getElevationAtPixel(F,Me,!0),k.getElevationAtPixel(F+Oe,Me,!0),k.getElevationAtPixel(F,Me+Oe,!0),k.getElevationAtPixel(F+Ae,Me+Oe,!0)]}(k,xi.x-vt,xi.y-Ut,vi,bi),Mi=Math.abs(wi[0]-wi[1]),pr=Math.abs(wi[2]-wi[3]),Ur=Math.abs(wi[0]-wi[2])+Math.abs(wi[1]-wi[3]),Wr=Math.min(.25,.5*pt*(Mi+pr)/vi),Jr=Math.min(.25,.5*pt*Ur/bi);return qe+Math.max(Wr*Fe,Jr*je)}(Oe,Fe,qe):pt;return{base:pt+(0===Me?-1:Me),top:vt?Math.max(Ut+Ae,pt+Me+2):pt+Ae}}oa(Kh,"FillExtrusionBucket",{omit:["layers","features"]}),oa(Gh,"PartData"),oa($h,"FootprintSegment"),oa(Yh,"BorderCentroidData"),oa(Wh,"GroundEffect");const q_=ys([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Z_=ys([{name:"a_z_offset_width",components:2,type:"Float32"}],4),{members:H_}=q_,$_=ys([{name:"a_packed",components:4,type:"Float32"}]),{members:W_}=$_,X_=ys([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Y_}=X_;class bp{constructor(k,F){this.width=k,this.height=F,this.nextRow=0,this.image=new ac({width:k,height:F}),this.positions={},this.uploaded=!1}getDash(k,F){const Me=this.getKey(k,F);return this.positions[Me]}trim(){const k=this.width,F=this.height=st(this.nextRow);this.image.resize({width:k,height:F})}getKey(k,F){return k.join(",")+F}getDashRanges(k,F,Me){const Ae=[];let Oe=k.length%2==1?-k[k.length-1]*Me:0,Fe=k[0]*Me,je=!0;Ae.push({left:Oe,right:Fe,isDash:je,zeroLength:0===k[0]});let qe=k[0];for(let F=1;F<k.length;F++){je=!je;const pt=k[F];Oe=qe*Me,qe+=pt,Fe=qe*Me,Ae.push({left:Oe,right:Fe,isDash:je,zeroLength:0===pt})}return Ae}addRoundDash(k,F,Me){const Ae=F/2;for(let F=-Me;F<=Me;F++){const Oe=this.width*(this.nextRow+Me+F);let Fe=0,je=k[Fe];for(let qe=0;qe<this.width;qe++){qe/je.right>1&&(je=k[++Fe]);const pt=Math.abs(qe-je.left),vt=Math.abs(qe-je.right),Ut=Math.min(pt,vt);let xi;const vi=F/Me*(Ae+1);if(je.isDash){const k=Ae-Math.abs(vi);xi=Math.sqrt(Ut*Ut+k*k)}else xi=Ae-Math.sqrt(Ut*Ut+vi*vi);this.image.data[Oe+qe]=Math.max(0,Math.min(255,xi+128))}}}addRegularDash(k,F){for(let F=k.length-1;F>=0;--F){const Me=k[F],Ae=k[F+1];Me.zeroLength?k.splice(F,1):Ae&&Ae.isDash===Me.isDash&&(Ae.left=Me.left,k.splice(F,1))}const Me=k[0],Ae=k[k.length-1];Me.isDash===Ae.isDash&&(Me.left=Ae.left-this.width,Ae.right=Me.right+this.width);const Oe=this.width*this.nextRow;let Fe=0,je=k[Fe];for(let Me=0;Me<this.width;Me++){Me/je.right>1&&(je=k[++Fe]);const Ae=Math.abs(Me-je.left),qe=Math.abs(Me-je.right),pt=Math.min(Ae,qe);this.image.data[Oe+Me]=Math.max(0,Math.min(255,(je.isDash?pt:-pt)+F+128))}}addDash(k,F){const Me=this.getKey(k,F);if(this.positions[Me])return this.positions[Me];const Ae="round"===F,Oe=Ae?7:0,Fe=2*Oe+1;if(this.nextRow+Fe>this.height)return ft("LineAtlas out of space"),null;0===k.length&&k.push(1);let je=0;for(let F=0;F<k.length;F++)k[F]<0&&(ft("Negative value is found in line dasharray, replacing values with 0"),k[F]=0),je+=k[F];if(0!==je){const Me=this.width/je,Fe=this.getDashRanges(k,this.width,Me);Ae?this.addRoundDash(Fe,Me,Oe):this.addRegularDash(Fe,"square"===F?.5*Me:0)}const qe=this.nextRow+Oe;this.nextRow+=Fe;const pt={tl:[qe,Oe],br:[je,0]};return this.positions[Me]=pt,pt}}oa(bp,"LineAtlas");const K_=P_.VectorTileFeature.types,J_=Math.cos(Math.PI/180*37.5),Q_=Math.cos(Math.PI/180*5);class Ap{constructor(k){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=k.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=k.overscaling,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.index=k.index,this.projection=k.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((k=>{this.gradients[k.id]={}})),this.layoutVertexArray=new ws,this.layoutVertexArray2=new Ms,this.patternVertexArray=new As,this.indexArray=new Ls,this.programConfigurations=new No(k.layers,{zoom:k.zoom,lut:k.lut}),this.segments=new po,this.maxLineLength=0,this.zOffsetVertexArray=new $s,this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.tessellationStep=k.tessellationStep?k.tessellationStep:Td/64}updateFootprints(k,F){}populate(k,F,Me,Ae){this.hasPattern=Oc("line",this.layers,F);const Oe=this.layers[0].layout.get("line-sort-key");this.tileToMeter=vl(Me),this.hasZOffset=!this.layers[0].isDraped();const Fe=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset&&"none"===Fe&&ft(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const je=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&void 0!==je;const qe=[];for(const{feature:F,id:Fe,index:je,sourceLayerIndex:pt}of k){const k=this.layers[0]._featureFilter.needGeometry,vt=El(F,k);if(!this.layers[0]._featureFilter.filter(new Va(this.zoom),vt,Me))continue;const Ut=Oe?Oe.evaluate(vt,{},Me):void 0,xi={id:Fe,properties:F.properties,type:F.type,sourceLayerIndex:pt,index:je,geometry:k?vt.geometry:zl(F,Me,Ae),patterns:{},sortKey:Ut};qe.push(xi)}Oe&&qe.sort(((k,F)=>k.sortKey-F.sortKey));const{lineAtlas:pt,featureIndex:vt}=F,Ut=this.addConstantDashes(pt);for(const Ae of qe){const{geometry:Oe,index:Fe,sourceLayerIndex:je}=Ae;if(Ut&&this.addFeatureDashes(Ae,pt),this.hasPattern){const k=Nc("line",this.layers,Ae,this.zoom,F);this.patternFeatures.push(k)}else this.addFeature(Ae,Oe,Fe,Me,pt.positions,F.availableImages,F.brightness);vt.insert(k[Fe].feature,Oe,Fe,je,this.index)}}addConstantDashes(k){let F=!1;for(const Me of this.layers){const Ae=Me.paint.get("line-dasharray").value,Oe=Me.layout.get("line-cap").value;if("constant"!==Ae.kind||"constant"!==Oe.kind)F=!0;else{const F=Oe.value,Me=Ae.value;if(!Me)continue;k.addDash(Me,F)}}return F}addFeatureDashes(k,F){const Me=this.zoom;for(const Ae of this.layers){const Oe=Ae.paint.get("line-dasharray").value,Fe=Ae.layout.get("line-cap").value;if("constant"===Oe.kind&&"constant"===Fe.kind)continue;let je,qe;if("constant"===Oe.kind){if(je=Oe.value,!je)continue}else je=Oe.evaluate({zoom:Me},k);qe="constant"===Fe.kind?Fe.value:Fe.evaluate({zoom:Me},k),F.addDash(je,qe),k.patterns[Ae.id]=F.getKey(je,qe)}}update(k,F,Me,Ae,Oe,Fe,je){this.programConfigurations.updatePaintArrays(k,F,Oe,Me,Ae,Fe,je)}addFeatures(k,F,Me,Ae,Oe,Fe){for(const k of this.patternFeatures)this.addFeature(k,k.geometry,k.index,F,Me,Ae,Fe)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(k){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=k.createVertexBuffer(this.layoutVertexArray2,W_)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=k.createVertexBuffer(this.patternVertexArray,Y_)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=k.createVertexBuffer(this.zOffsetVertexArray,Z_.members,!0)),this.layoutVertexBuffer=k.createVertexBuffer(this.layoutVertexArray,H_),this.indexBuffer=k.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(k),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(k){if(k.properties&&k.properties.hasOwnProperty("mapbox_clip_start")&&k.properties.hasOwnProperty("mapbox_clip_end"))return{start:+k.properties.mapbox_clip_start,end:+k.properties.mapbox_clip_end}}addFeature(k,F,Me,Ae,Oe,Fe,je){const qe=this.layers[0].layout,pt=qe.get("line-join").evaluate(k,{}),vt=qe.get("line-cap").evaluate(k,{}),Ut=qe.get("line-miter-limit"),xi=qe.get("line-round-limit");this.lineClips=this.lineFeatureClips(k),this.lineFeature=k,this.zOffsetValue=qe.get("line-z-offset").value;const vi=this.layers[0].paint.get("line-width").value;"constant"!==vi.kind&&!1===vi.isLineProgressConstant&&(this.variableWidthValue=vi);for(const Me of F)this.addLine(Me,k,Ae,pt,vt,Ut,xi);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,k,Me,Oe,Fe,Ae,je)}addLine(k,F,Me,Ae,Oe,Fe,je){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const qe="none"===Ae;if(this.patternJoinNone=this.hasPattern&&qe,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let F=0;F<k.length-1;F++)this.totalDistance+=k[F].dist(k[F+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const pt="Polygon"===K_[F.type];let vt=k.length;for(;vt>=2&&k[vt-1].equals(k[vt-2]);)vt--;let Ut=0;for(;Ut<vt-1&&k[Ut].equals(k[Ut+1]);)Ut++;if(vt<(pt?3:2))return;"bevel"===Ae&&(Fe=1.05);const xi=this.segments.prepareSegment(10*vt,this.layoutVertexArray,this.indexArray);let vi,bi,wi,Mi,pr,Ur;this.e1=this.e2=-1,pt&&(vi=k[vt-2],pr=k[Ut].sub(vi)._unit()._perp());for(let F=Ut;F<vt;F++){if(wi=F===vt-1?pt?k[Ut+1]:void 0:k[F+1],wi&&k[F].equals(wi))continue;pr&&(Mi=pr),vi&&(bi=vi),vi=k[F],Ur=this.evaluateLineProgressFeatures(bi?bi.dist(vi):0),pr=wi?wi.sub(vi)._unit()._perp():Mi,Mi=Mi||pr;const Me=bi&&wi;let Wr=Me?Ae:pt||qe?"butt":Oe;const Jr=Mi.x*pr.x+Mi.y*pr.y;if(qe){const t=function(k){if(k.patternJoinNone){const F=k.segmentPoints.length/2,Me=k.lineSoFar-k.segmentStart;for(let Ae=0;Ae<F;++Ae){const F=k.segmentPoints[2*Ae+1],Oe=Math.round(k.segmentPoints[2*Ae])+.5+.25*F;k.patternVertexArray.emplaceBack(Oe,Me,k.segmentStart),k.patternVertexArray.emplaceBack(Oe,Me,k.segmentStart)}k.segmentPoints.length=0}k.e1=k.e2=-1};if(Me&&Jr<Q_){this.updateDistance(bi,vi),this.addCurrentVertex(vi,Mi,1,1,xi,Ur),t(this),this.addCurrentVertex(vi,pr,-1,-1,xi,Ur);continue}if(bi){if(!wi){this.updateDistance(bi,vi),this.addCurrentVertex(vi,Mi,1,1,xi,Ur),t(this);continue}Wr="miter"}}let Qr=Mi.add(pr);0===Qr.x&&0===Qr.y||Qr._unit();const co=Qr.x*pr.x+Qr.y*pr.y,mo=0!==co?1/co:1/0,yo=2*Math.sqrt(2-2*co),To=co<J_&&bi&&wi,zo=Mi.x*pr.y-Mi.y*pr.x>0,ko=this.overscaling<=16?15*Td/(512*this.overscaling):0;if(Me&&"round"===Wr)if(mo<je)Wr="miter";else if(mo<=2){const k=Sp(vi,-10,Td+10);Wr=this.hasZOffset&&(k||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===Wr&&mo>Fe&&(Wr="bevel"),"bevel"===Wr&&(mo>2&&(Wr="flipbevel"),mo<Fe&&(Wr="miter")),bi&&!("miter"===Wr&&To)&&this.updateDistance(bi,vi),"miter"===Wr)if(To){const k=vi.dist(bi);if(k>2*ko){const F=vi.sub(vi.sub(bi)._mult(ko/k)._round());this.updateDistance(bi,F),this.addCurrentVertex(F,Mi,0,0,xi,Ur),bi=F}this.updateDistance(bi,vi),Qr._mult(mo),this.addCurrentVertex(vi,Qr,0,0,xi,Ur);const F=vi.dist(wi);if(F>2*ko){const k=vi.add(wi.sub(vi)._mult(ko/F)._round());this.updateDistance(vi,k),this.addCurrentVertex(k,pr,0,0,xi,Ur),vi=k}}else Qr._mult(mo),this.addCurrentVertex(vi,Qr,0,0,xi,Ur);else if("flipbevel"===Wr){if(mo>100)Qr=pr.mult(-1);else{const k=mo*Mi.add(pr).mag()/Mi.sub(pr).mag();Qr._perp()._mult(k*(zo?-1:1))}this.addCurrentVertex(vi,Qr,0,0,xi,Ur),this.addCurrentVertex(vi,Qr.mult(-1),0,0,xi,Ur)}else if("bevel"===Wr||"fakeround"===Wr){null!=Ur&&bi&&this.addCurrentVertex(vi,Mi,-1,-1,xi,Ur);const k=vi.dist(bi)<=2*ko&&"bevel"!==Wr,F=Qr.mult(zo?1:-1);F._mult(mo);const Me=pr.mult(zo?-1:1),Ae=Mi.mult(zo?-1:1),Oe=this.evaluateLineProgressFeatures(this.distance);if(null==Ur&&(this.addHalfVertex(vi,F.x,F.y,!1,!zo,0,xi,Oe),k||this.addHalfVertex(vi,F.x+2*Ae.x,F.y+2*Ae.y,!1,zo,0,xi,Oe)),"fakeround"===Wr){const k=Math.round(180*yo/Math.PI/20);this.addHalfVertex(vi,Ae.x,Ae.y,!1,zo,0,xi,Oe);for(let F=0;F<k;F++){let Fe=F/k;if(.5!==Fe){const k=Fe-.5;Fe+=Fe*k*(Fe-1)*((1.0904+Jr*(Jr*(3.55645-1.43519*Jr)-3.2452))*k*k+(.848013+Jr*(.215638*Jr-1.06021)))}const je=Me.sub(Ae)._mult(Fe)._add(Ae)._unit();this.addHalfVertex(vi,je.x,je.y,!1,zo,0,xi,Oe)}this.addHalfVertex(vi,Me.x,Me.y,!1,zo,0,xi,Oe)}k||null!=Ur||this.addHalfVertex(vi,F.x+2*Me.x,F.y+2*Me.y,!1,zo,0,xi,Oe),null!=Ur&&wi&&this.addCurrentVertex(vi,pr,1,1,xi,Ur)}else"butt"===Wr?this.addCurrentVertex(vi,Qr,0,0,xi,Ur):"square"===Wr?(bi||this.addCurrentVertex(vi,Qr,-1,-1,xi,Ur),this.addCurrentVertex(vi,Qr,0,0,xi,Ur),bi&&this.addCurrentVertex(vi,Qr,1,1,xi,Ur)):"round"===Wr&&(bi&&(this.addCurrentVertex(vi,Mi,0,0,xi,Ur),this.addCurrentVertex(vi,Mi,1,1,xi,Ur,!0)),wi&&(this.addCurrentVertex(vi,pr,-1,-1,xi,Ur,!0),this.addCurrentVertex(vi,pr,0,0,xi,Ur)))}}addVerticesTo(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt){const Ut=(F.w-k.w)/this.tessellationStep|0;let xi=0;const vi=this.scaledDistance;if(Ut>1){this.lineSoFar=k.w;const vi=(F.x-k.x)/Ut,bi=(F.y-k.y)/Ut,wi=(F.z-k.z)/Ut,Mi=(F.w-k.w)/Ut;for(let F=1;F<Ut;++F){k.x+=vi,k.y+=bi,k.z+=wi,this.lineSoFar+=Mi,xi+=Mi;const F=this.evaluateLineProgressFeatures(this.prevDistance+xi);this.scaledDistance=(this.prevDistance+xi)/this.totalDistance,this.addHalfVertex(k,Me,Ae,vt,!1,je,pt,F),this.addHalfVertex(k,Oe,Fe,vt,!0,-qe,pt,F)}}this.lineSoFar=F.w,this.scaledDistance=vi;const bi=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(F,Me,Ae,vt,!1,je,pt,bi),this.addHalfVertex(F,Oe,Fe,vt,!0,-qe,pt,bi)}evaluateLineProgressFeatures(k){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+k)/this.totalFeatureLength):ft(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let F=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(F=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:F}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:F}:{zOffset:0,variableWidth:F}}addCurrentVertex(k,F,Me,Ae,Oe,Fe,je=!1){const qe=F.x+F.y*Me,pt=F.y-F.x*Me,vt=F.y*Ae-F.x,Ut=-F.y-F.x*Ae;if(null!=Fe){const F=this.hasZOffset,xi=-10,vi=Td+10,bi=Fe.zOffset,wi=new mh(k.x,k.y,bi,this.lineSoFar),Mi=!!F&&Sp(k,xi,vi),pr=this.lineSoFar,Ur=this.distance;if(this.currentVertex)if(Mi){const F=this.currentVertexIsOutside,Fe=this.currentVertex,Mi=new mh(k.x,k.y,bi,this.lineSoFar);if(xh(Fe,Mi,xi,vi),!Sp(Mi,xi,vi)){if(F){this.e1=this.e2=-1,this.distance-=Fe.dist(wi),this.lineSoFar=Fe.w;const k=this.evaluateLineProgressFeatures(Fe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(Fe,qe,pt,je,!1,Me,Oe,k),this.addHalfVertex(Fe,vt,Ut,je,!0,-Ae,Oe,k),this.prevDistance=this.distance}this.distance=this.prevDistance+Fe.dist(Mi),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(Fe,Mi,qe,pt,vt,Ut,Me,Ae,Oe,je),this.distance=Ur,this.scaledDistance=this.distance/this.totalDistance}}else{const k=this.currentVertex;if(this.currentVertexIsOutside){xh(k,wi,xi,vi),this.e1=this.e2=-1,this.distance-=k.dist(wi),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=k.w;const F=this.evaluateLineProgressFeatures(k.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(k,qe,pt,je,!1,Me,Oe,F),this.addHalfVertex(k,vt,Ut,je,!0,-Ae,Oe,F),this.prevDistance=this.distance,this.distance=Ur,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(k,wi,qe,pt,vt,Ut,Me,Ae,Oe,je)}else Mi||(this.addHalfVertex(k,qe,pt,je,!1,Me,Oe,Fe),this.addHalfVertex(k,vt,Ut,je,!0,-Ae,Oe,Fe));this.currentVertex=wi,this.currentVertexIsOutside=Mi,this.lineSoFar=pr}else this.addHalfVertex(k,qe,pt,je,!1,Me,Oe,Fe),this.addHalfVertex(k,vt,Ut,je,!0,-Ae,Oe,Fe)}addHalfVertex({x:k,y:F},Me,Ae,Oe,Fe,je,qe,pt){this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),Fe||this.segmentPoints.push(this.lineSoFar-this.segmentStart,je)),this.layoutVertexArray.emplaceBack((k<<1)+(Oe?1:0),(F<<1)+(Fe?1:0),Math.round(63*Me)+128,Math.round(63*Ae)+128,1+(0===je?0:je<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const vt=qe.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,vt),qe.primitiveLength++),Fe?this.e2=vt:this.e1=vt,null!=pt&&this.zOffsetVertexArray.emplaceBack(pt.zOffset,pt.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(k,F){this.prevDistance=this.distance,this.distance+=k.dist(F),this.updateScaledDistance()}}function Sp(k,F,Me){return k.x<F||k.x>Me||k.y<F||k.y>Me}let Tg,Zg;function zp(k,F,Me){return F*(Td/(k.tileSize*Math.pow(2,Me-k.tileID.overscaledZ)))}oa(Ap,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Ep=(k,F,Me)=>(1-Me)*k+Me*F;function kp(k,F){return 1/zp(k,1,F.tileZoom)}function Tp(k,F,Me,Ae){return k.translatePosMatrix(Ae||F.tileID.projMatrix,F,Me.paint.get("line-translate"),Me.paint.get("line-translate-anchor"))}const Bp=k=>{const F=[];Vp(k)&&F.push("RENDER_LINE_DASH"),k.paint.get("line-gradient")&&F.push("RENDER_LINE_GRADIENT");const Me=k.paint.get("line-trim-offset");0===Me[0]&&0===Me[1]||F.push("RENDER_LINE_TRIM_OFFSET"),0!==k.paint.get("line-border-width").constantOr(1)&&F.push("RENDER_LINE_BORDER");const Ae="none"===k.layout.get("line-join").constantOr("miter"),Oe=!!k.paint.get("line-pattern").constantOr(1);return Ae&&Oe&&F.push("LINE_JOIN_NONE"),F};function Vp(k){const F=k.paint.get("line-dasharray").value;return F.value||"constant"!==F.kind}let Hg;const Dp=()=>Hg||(Hg={layout:Tg||(Tg=new Ga({"line-cap":new qa(Xp.layout_line["line-cap"]),"line-join":new qa(Xp.layout_line["line-join"]),"line-miter-limit":new ja(Xp.layout_line["line-miter-limit"]),"line-round-limit":new ja(Xp.layout_line["line-round-limit"]),"line-sort-key":new qa(Xp.layout_line["line-sort-key"]),"line-z-offset":new qa(Xp.layout_line["line-z-offset"]),"line-elevation-reference":new ja(Xp.layout_line["line-elevation-reference"]),"line-cross-slope":new ja(Xp.layout_line["line-cross-slope"]),visibility:new ja(Xp.layout_line.visibility),"line-width-unit":new ja(Xp.layout_line["line-width-unit"])})),paint:Zg||(Zg=new Ga({"line-opacity":new qa(Xp.paint_line["line-opacity"]),"line-color":new qa(Xp.paint_line["line-color"]),"line-translate":new ja(Xp.paint_line["line-translate"]),"line-translate-anchor":new ja(Xp.paint_line["line-translate-anchor"]),"line-width":new qa(Xp.paint_line["line-width"]),"line-gap-width":new qa(Xp.paint_line["line-gap-width"]),"line-offset":new qa(Xp.paint_line["line-offset"]),"line-blur":new qa(Xp.paint_line["line-blur"]),"line-dasharray":new qa(Xp.paint_line["line-dasharray"]),"line-pattern":new qa(Xp.paint_line["line-pattern"]),"line-gradient":new $a(Xp.paint_line["line-gradient"]),"line-trim-offset":new ja(Xp.paint_line["line-trim-offset"]),"line-trim-fade-range":new ja(Xp.paint_line["line-trim-fade-range"]),"line-trim-color":new ja(Xp.paint_line["line-trim-color"]),"line-emissive-strength":new ja(Xp.paint_line["line-emissive-strength"]),"line-border-width":new qa(Xp.paint_line["line-border-width"]),"line-border-color":new qa(Xp.paint_line["line-border-color"]),"line-occlusion-opacity":new ja(Xp.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Hg);class Lp extends qa{possiblyEvaluate(k,F){return F=new Va(Math.floor(F.zoom),{now:F.now,fadeDuration:F.fadeDuration,transition:F.transition}),super.possiblyEvaluate(k,F)}evaluate(k,F,Me,Ae){return F=nt({},F,{zoom:Math.floor(F.zoom)}),super.evaluate(k,F,Me,Ae)}}let Wg;function Fp(k,F){return F>0?F+2*k:k}const Xg=ys([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Yg=ys([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Kg=ys([{name:"a_projected_pos",components:4,type:"Float32"}],4);ys([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Qg=ys([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),ey=ys([{name:"a_texb",components:2,type:"Uint16"}]),ty=ys([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),ry=ys([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);ys([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const cy=ys([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),hy=ys([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ys([{name:"triangle",components:3,type:"Uint16"}]),ys([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ys([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),ys([{type:"Float32",name:"offsetX"}]),ys([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var dy=24;const _y=128;function Wp(k,F,Me,Ae,Oe){if("camera"===k.kind)return k.maxSize;if("composite"===k.kind){const Ae=F.possiblyEvaluate(new Va(k.maxZoom),Me).evaluate(Oe,{},Me),Fe=F.possiblyEvaluate(new Va(k.minZoom),Me).evaluate(Oe,{},Me);return Math.max(Ae,Fe)}return F.possiblyEvaluate(new Va(Ae)).evaluate(Oe,{},Me)}function Kp(k,F){const{expression:Me}=F;if("constant"===Me.kind)return{kind:"constant",layoutSize:Me.evaluate(new Va(k+1))};if("source"===Me.kind)return{kind:"source"};{const{zoomStops:F,interpolationType:Ae}=Me;let Oe=0;for(;Oe<F.length&&F[Oe]<=k;)Oe++;Oe=Math.max(0,Oe-1);let Fe=Oe;for(;Fe<F.length&&F[Fe]<k+1;)Fe++;Fe=Math.min(F.length-1,Fe);const je=F[Oe],qe=F[Fe];return"composite"===Me.kind?{kind:"composite",minZoom:je,maxZoom:qe,interpolationType:Ae}:{kind:"camera",minZoom:je,maxZoom:qe,minSize:Me.evaluate(new Va(je)),maxSize:Me.evaluate(new Va(qe)),interpolationType:Ae}}}function Jp(k,{uSize:F,uSizeT:Me},{lowerSize:Ae,upperSize:Oe}){return"source"===k.kind?Ae/_y:"composite"===k.kind?ze(Ae/_y,Oe/_y,Me):F}function Qp(k,F,Me=1){let Ae=0,Oe=0;if("constant"===k.kind)Oe=k.layoutSize*Me;else if("source"!==k.kind){const{interpolationType:Fe,minZoom:je,maxZoom:qe}=k,pt=Fe?Q(ai.interpolationFactor(Fe,F,je,qe),0,1):0;"camera"===k.kind?Oe=ze(k.minSize,k.maxSize,pt)*Me:Ae=pt*Me}return{uSizeT:Ae,uSize:Oe}}var Sy=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:_y,evaluateSizeForFeature:Jp,evaluateSizeForZoom:Qp,getRasterizedIconSize:Wp,getSizeData:Kp});function ef(k,F,Me){return k.sections.forEach((k=>{k.text=function(k,F,Me){const Ae=F.layout.get("text-transform").evaluate(Me,{});return"uppercase"===Ae?k=k.toLocaleUpperCase():"lowercase"===Ae&&(k=k.toLocaleLowerCase()),$p.applyArabicShaping&&(k=$p.applyArabicShaping(k)),k}(k.text,F,Me)})),k}const Ey={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function nf(k){return"︶"===k||"﹈"===k||"︸"===k||"﹄"===k||"﹂"===k||"︾"===k||"︼"===k||"︺"===k||"︘"===k||"﹀"===k||"︐"===k||"︓"===k||"︔"===k||"｀"===k||"￣"===k||"︑"===k||"︒"===k}function af(k){return"︵"===k||"﹇"===k||"︷"===k||"﹃"===k||"﹁"===k||"︽"===k||"︻"===k||"︹"===k||"︗"===k||"︿"===k}var Iy,Cy,Dy,Ry={};function cf(){return Iy||(Iy=1,Ry.read=function(k,F,Me,Ae,Oe){var Fe,je,qe=8*Oe-Ae-1,pt=(1<<qe)-1,vt=pt>>1,Ut=-7,xi=Me?Oe-1:0,vi=Me?-1:1,bi=k[F+xi];for(xi+=vi,Fe=bi&(1<<-Ut)-1,bi>>=-Ut,Ut+=qe;Ut>0;Fe=256*Fe+k[F+xi],xi+=vi,Ut-=8);for(je=Fe&(1<<-Ut)-1,Fe>>=-Ut,Ut+=Ae;Ut>0;je=256*je+k[F+xi],xi+=vi,Ut-=8);if(0===Fe)Fe=1-vt;else{if(Fe===pt)return je?NaN:1/0*(bi?-1:1);je+=Math.pow(2,Ae),Fe-=vt}return(bi?-1:1)*je*Math.pow(2,Fe-Ae)},Ry.write=function(k,F,Me,Ae,Oe,Fe){var je,qe,pt,vt=8*Fe-Oe-1,Ut=(1<<vt)-1,xi=Ut>>1,vi=23===Oe?Math.pow(2,-24)-Math.pow(2,-77):0,bi=Ae?0:Fe-1,wi=Ae?1:-1,Mi=F<0||0===F&&1/F<0?1:0;for(F=Math.abs(F),isNaN(F)||F===1/0?(qe=isNaN(F)?1:0,je=Ut):(je=Math.floor(Math.log(F)/Math.LN2),F*(pt=Math.pow(2,-je))<1&&(je--,pt*=2),(F+=je+xi>=1?vi/pt:vi*Math.pow(2,1-xi))*pt>=2&&(je++,pt/=2),je+xi>=Ut?(qe=0,je=Ut):je+xi>=1?(qe=(F*pt-1)*Math.pow(2,Oe),je+=xi):(qe=F*Math.pow(2,xi-1)*Math.pow(2,Oe),je=0));Oe>=8;k[Me+bi]=255&qe,bi+=wi,qe/=256,Oe-=8);for(je=je<<Oe|qe,vt+=Oe;vt>0;k[Me+bi]=255&je,bi+=wi,je/=256,vt-=8);k[Me+bi-wi]|=128*Mi}),Ry}function hf(){if(Dy)return Cy;Dy=1,Cy=e;var F=cf();function e(F){(this||k).buf=ArrayBuffer.isView&&ArrayBuffer.isView(F)?F:new Uint8Array(F||0),(this||k).pos=0,(this||k).type=0,(this||k).length=(this||k).buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var Me=4294967296,Ae=1/Me,Oe="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function a(k){return k.type===e.Bytes?k.readVarint()+k.pos:k.pos+1}function s(k,F,Me){return Me?4294967296*F+(k>>>0):4294967296*(F>>>0)+(k>>>0)}function o(k,F,Me){var Ae=F<=16383?1:F<=2097151?2:F<=268435455?3:Math.floor(Math.log(F)/(7*Math.LN2));Me.realloc(Ae);for(var Oe=Me.pos-1;Oe>=k;Oe--)Me.buf[Oe+Ae]=Me.buf[Oe]}function l(k,F){for(var Me=0;Me<k.length;Me++)F.writeVarint(k[Me])}function u(k,F){for(var Me=0;Me<k.length;Me++)F.writeSVarint(k[Me])}function c(k,F){for(var Me=0;Me<k.length;Me++)F.writeFloat(k[Me])}function h(k,F){for(var Me=0;Me<k.length;Me++)F.writeDouble(k[Me])}function p(k,F){for(var Me=0;Me<k.length;Me++)F.writeBoolean(k[Me])}function f(k,F){for(var Me=0;Me<k.length;Me++)F.writeFixed32(k[Me])}function d(k,F){for(var Me=0;Me<k.length;Me++)F.writeSFixed32(k[Me])}function m(k,F){for(var Me=0;Me<k.length;Me++)F.writeFixed64(k[Me])}function y(k,F){for(var Me=0;Me<k.length;Me++)F.writeSFixed64(k[Me])}function g(k,F){return(k[F]|k[F+1]<<8|k[F+2]<<16)+16777216*k[F+3]}function x(k,F,Me){k[Me]=F,k[Me+1]=F>>>8,k[Me+2]=F>>>16,k[Me+3]=F>>>24}function v(k,F){return(k[F]|k[F+1]<<8|k[F+2]<<16)+(k[F+3]<<24)}return e.prototype={destroy:function(){(this||k).buf=null},readFields:function(F,Me,Ae){for(Ae=Ae||(this||k).length;(this||k).pos<Ae;){var Oe=this.readVarint(),Fe=Oe>>3,je=(this||k).pos;(this||k).type=7&Oe,F(Fe,Me,this||k),(this||k).pos===je&&this.skip(Oe)}return Me},readMessage:function(F,Me){return this.readFields(F,Me,this.readVarint()+(this||k).pos)},readFixed32:function(){var F=g((this||k).buf,(this||k).pos);return(this||k).pos+=4,F},readSFixed32:function(){var F=v((this||k).buf,(this||k).pos);return(this||k).pos+=4,F},readFixed64:function(){var F=g((this||k).buf,(this||k).pos)+g((this||k).buf,(this||k).pos+4)*Me;return(this||k).pos+=8,F},readSFixed64:function(){var F=g((this||k).buf,(this||k).pos)+v((this||k).buf,(this||k).pos+4)*Me;return(this||k).pos+=8,F},readFloat:function(){var Me=F.read((this||k).buf,(this||k).pos,!0,23,4);return(this||k).pos+=4,Me},readDouble:function(){var Me=F.read((this||k).buf,(this||k).pos,!0,52,8);return(this||k).pos+=8,Me},readVarint:function(F){var Me,Ae,Oe=(this||k).buf;return Me=127&(Ae=Oe[(this||k).pos++]),Ae<128?Me:(Me|=(127&(Ae=Oe[(this||k).pos++]))<<7,Ae<128?Me:(Me|=(127&(Ae=Oe[(this||k).pos++]))<<14,Ae<128?Me:(Me|=(127&(Ae=Oe[(this||k).pos++]))<<21,Ae<128?Me:function(k,F,Me){var Ae,Oe,Fe=Me.buf;if(Ae=(112&(Oe=Fe[Me.pos++]))>>4,Oe<128)return s(k,Ae,F);if(Ae|=(127&(Oe=Fe[Me.pos++]))<<3,Oe<128)return s(k,Ae,F);if(Ae|=(127&(Oe=Fe[Me.pos++]))<<10,Oe<128)return s(k,Ae,F);if(Ae|=(127&(Oe=Fe[Me.pos++]))<<17,Oe<128)return s(k,Ae,F);if(Ae|=(127&(Oe=Fe[Me.pos++]))<<24,Oe<128)return s(k,Ae,F);if(Ae|=(1&(Oe=Fe[Me.pos++]))<<31,Oe<128)return s(k,Ae,F);throw new Error("Expected varint not more than 10 bytes")}(Me|=(15&(Ae=Oe[(this||k).pos]))<<28,F,this||k))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var k=this.readVarint();return k%2==1?(k+1)/-2:k/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var F=this.readVarint()+(this||k).pos,Me=(this||k).pos;return(this||k).pos=F,F-Me>=12&&Oe?function(k,F,Me){return Oe.decode(k.subarray(F,Me))}((this||k).buf,Me,F):function(k,F,Me){for(var Ae="",Oe=F;Oe<Me;){var Fe,je,qe,pt=k[Oe],vt=null,Ut=pt>239?4:pt>223?3:pt>191?2:1;if(Oe+Ut>Me)break;1===Ut?pt<128&&(vt=pt):2===Ut?128==(192&(Fe=k[Oe+1]))&&(vt=(31&pt)<<6|63&Fe)<=127&&(vt=null):3===Ut?(je=k[Oe+2],128==(192&(Fe=k[Oe+1]))&&128==(192&je)&&((vt=(15&pt)<<12|(63&Fe)<<6|63&je)<=2047||vt>=55296&&vt<=57343)&&(vt=null)):4===Ut&&(je=k[Oe+2],qe=k[Oe+3],128==(192&(Fe=k[Oe+1]))&&128==(192&je)&&128==(192&qe)&&((vt=(15&pt)<<18|(63&Fe)<<12|(63&je)<<6|63&qe)<=65535||vt>=1114112)&&(vt=null)),null===vt?(vt=65533,Ut=1):vt>65535&&(vt-=65536,Ae+=String.fromCharCode(vt>>>10&1023|55296),vt=56320|1023&vt),Ae+=String.fromCharCode(vt),Oe+=Ut}return Ae}((this||k).buf,Me,F)},readBytes:function(){var F=this.readVarint()+(this||k).pos,Me=(this||k).buf.subarray((this||k).pos,F);return(this||k).pos=F,Me},readPackedVarint:function(F,Me){if((this||k).type!==e.Bytes)return F.push(this.readVarint(Me));var Ae=a(this||k);for(F=F||[];(this||k).pos<Ae;)F.push(this.readVarint(Me));return F},readPackedSVarint:function(F){if((this||k).type!==e.Bytes)return F.push(this.readSVarint());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readSVarint());return F},readPackedBoolean:function(F){if((this||k).type!==e.Bytes)return F.push(this.readBoolean());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readBoolean());return F},readPackedFloat:function(F){if((this||k).type!==e.Bytes)return F.push(this.readFloat());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readFloat());return F},readPackedDouble:function(F){if((this||k).type!==e.Bytes)return F.push(this.readDouble());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readDouble());return F},readPackedFixed32:function(F){if((this||k).type!==e.Bytes)return F.push(this.readFixed32());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readFixed32());return F},readPackedSFixed32:function(F){if((this||k).type!==e.Bytes)return F.push(this.readSFixed32());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readSFixed32());return F},readPackedFixed64:function(F){if((this||k).type!==e.Bytes)return F.push(this.readFixed64());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readFixed64());return F},readPackedSFixed64:function(F){if((this||k).type!==e.Bytes)return F.push(this.readSFixed64());var Me=a(this||k);for(F=F||[];(this||k).pos<Me;)F.push(this.readSFixed64());return F},skip:function(F){var Me=7&F;if(Me===e.Varint)for(;(this||k).buf[(this||k).pos++]>127;);else if(Me===e.Bytes)(this||k).pos=this.readVarint()+(this||k).pos;else if(Me===e.Fixed32)(this||k).pos+=4;else{if(Me!==e.Fixed64)throw new Error("Unimplemented type: "+Me);(this||k).pos+=8}},writeTag:function(k,F){this.writeVarint(k<<3|F)},realloc:function(F){for(var Me=(this||k).length||16;Me<(this||k).pos+F;)Me*=2;if(Me!==(this||k).length){var Ae=new Uint8Array(Me);Ae.set((this||k).buf),(this||k).buf=Ae,(this||k).length=Me}},finish:function(){return(this||k).length=(this||k).pos,(this||k).pos=0,(this||k).buf.subarray(0,(this||k).length)},writeFixed32:function(F){this.realloc(4),x((this||k).buf,F,(this||k).pos),(this||k).pos+=4},writeSFixed32:function(F){this.realloc(4),x((this||k).buf,F,(this||k).pos),(this||k).pos+=4},writeFixed64:function(F){this.realloc(8),x((this||k).buf,-1&F,(this||k).pos),x((this||k).buf,Math.floor(F*Ae),(this||k).pos+4),(this||k).pos+=8},writeSFixed64:function(F){this.realloc(8),x((this||k).buf,-1&F,(this||k).pos),x((this||k).buf,Math.floor(F*Ae),(this||k).pos+4),(this||k).pos+=8},writeVarint:function(F){(F=+F||0)>268435455||F<0?function(k,F){var Me,Ae;if(k>=0?(Me=k%4294967296|0,Ae=k/4294967296|0):(Ae=~(-k/4294967296),4294967295^(Me=~(-k%4294967296))?Me=Me+1|0:(Me=0,Ae=Ae+1|0)),k>=0x10000000000000000||k<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");F.realloc(10),function(k,F,Me){Me.buf[Me.pos++]=127&k|128,k>>>=7,Me.buf[Me.pos++]=127&k|128,k>>>=7,Me.buf[Me.pos++]=127&k|128,k>>>=7,Me.buf[Me.pos++]=127&k|128,Me.buf[Me.pos]=127&(k>>>=7)}(Me,0,F),function(k,F){var Me=(7&k)<<4;F.buf[F.pos++]|=Me|((k>>>=3)?128:0),k&&(F.buf[F.pos++]=127&k|((k>>>=7)?128:0),k&&(F.buf[F.pos++]=127&k|((k>>>=7)?128:0),k&&(F.buf[F.pos++]=127&k|((k>>>=7)?128:0),k&&(F.buf[F.pos++]=127&k|((k>>>=7)?128:0),k&&(F.buf[F.pos++]=127&k)))))}(Ae,F)}(F,this||k):(this.realloc(4),(this||k).buf[(this||k).pos++]=127&F|(F>127?128:0),F<=127||((this||k).buf[(this||k).pos++]=127&(F>>>=7)|(F>127?128:0),F<=127||((this||k).buf[(this||k).pos++]=127&(F>>>=7)|(F>127?128:0),F<=127||((this||k).buf[(this||k).pos++]=F>>>7&127))))},writeSVarint:function(k){this.writeVarint(k<0?2*-k-1:2*k)},writeBoolean:function(k){this.writeVarint(Boolean(k))},writeString:function(F){F=String(F),this.realloc(4*F.length),(this||k).pos++;var Me=(this||k).pos;(this||k).pos=function(k,F,Me){for(var Ae,Oe,Fe=0;Fe<F.length;Fe++){if((Ae=F.charCodeAt(Fe))>55295&&Ae<57344){if(!Oe){Ae>56319||Fe+1===F.length?(k[Me++]=239,k[Me++]=191,k[Me++]=189):Oe=Ae;continue}if(Ae<56320){k[Me++]=239,k[Me++]=191,k[Me++]=189,Oe=Ae;continue}Ae=Oe-55296<<10|Ae-56320|65536,Oe=null}else Oe&&(k[Me++]=239,k[Me++]=191,k[Me++]=189,Oe=null);Ae<128?k[Me++]=Ae:(Ae<2048?k[Me++]=Ae>>6|192:(Ae<65536?k[Me++]=Ae>>12|224:(k[Me++]=Ae>>18|240,k[Me++]=Ae>>12&63|128),k[Me++]=Ae>>6&63|128),k[Me++]=63&Ae|128)}return Me}((this||k).buf,F,(this||k).pos);var Ae=(this||k).pos-Me;Ae>=128&&o(Me,Ae,this||k),(this||k).pos=Me-1,this.writeVarint(Ae),(this||k).pos+=Ae},writeFloat:function(Me){this.realloc(4),F.write((this||k).buf,Me,(this||k).pos,!0,23,4),(this||k).pos+=4},writeDouble:function(Me){this.realloc(8),F.write((this||k).buf,Me,(this||k).pos,!0,52,8),(this||k).pos+=8},writeBytes:function(F){var Me=F.length;this.writeVarint(Me),this.realloc(Me);for(var Ae=0;Ae<Me;Ae++)(this||k).buf[(this||k).pos++]=F[Ae]},writeRawMessage:function(F,Me){(this||k).pos++;var Ae=(this||k).pos;F(Me,this||k);var Oe=(this||k).pos-Ae;Oe>=128&&o(Ae,Oe,this||k),(this||k).pos=Ae-1,this.writeVarint(Oe),(this||k).pos+=Oe},writeMessage:function(k,F,Me){this.writeTag(k,e.Bytes),this.writeRawMessage(F,Me)},writePackedVarint:function(k,F){F.length&&this.writeMessage(k,l,F)},writePackedSVarint:function(k,F){F.length&&this.writeMessage(k,u,F)},writePackedBoolean:function(k,F){F.length&&this.writeMessage(k,p,F)},writePackedFloat:function(k,F){F.length&&this.writeMessage(k,c,F)},writePackedDouble:function(k,F){F.length&&this.writeMessage(k,h,F)},writePackedFixed32:function(k,F){F.length&&this.writeMessage(k,f,F)},writePackedSFixed32:function(k,F){F.length&&this.writeMessage(k,d,F)},writePackedFixed64:function(k,F){F.length&&this.writeMessage(k,m,F)},writePackedSFixed64:function(k,F){F.length&&this.writeMessage(k,y,F)},writeBytesField:function(k,F){this.writeTag(k,e.Bytes),this.writeBytes(F)},writeFixed32Field:function(k,F){this.writeTag(k,e.Fixed32),this.writeFixed32(F)},writeSFixed32Field:function(k,F){this.writeTag(k,e.Fixed32),this.writeSFixed32(F)},writeFixed64Field:function(k,F){this.writeTag(k,e.Fixed64),this.writeFixed64(F)},writeSFixed64Field:function(k,F){this.writeTag(k,e.Fixed64),this.writeSFixed64(F)},writeVarintField:function(k,F){this.writeTag(k,e.Varint),this.writeVarint(F)},writeSVarintField:function(k,F){this.writeTag(k,e.Varint),this.writeSVarint(F)},writeStringField:function(k,F){this.writeTag(k,e.Bytes),this.writeString(F)},writeFloatField:function(k,F){this.writeTag(k,e.Fixed32),this.writeFloat(F)},writeDoubleField:function(k,F){this.writeTag(k,e.Fixed64),this.writeDouble(F)},writeBooleanField:function(k,F){this.writeVarintField(k,Boolean(F))}},Cy}var Ly=e(hf());const ky=3;function df(k,F,Me){F.glyphs=[],1===k&&Me.readMessage(mf,F)}function mf(k,F,Me){if(3===k){const{id:k,bitmap:Ae,width:Oe,height:Fe,left:je,top:qe,advance:pt}=Me.readMessage(yf,{});F.glyphs.push({id:k,bitmap:new ac({width:Oe+2*ky,height:Fe+2*ky},Ae),metrics:{width:Oe,height:Fe,left:je,top:qe,advance:pt}})}else 4===k?F.ascender=Me.readSVarint():5===k&&(F.descender=Me.readSVarint())}function yf(k,F,Me){1===k?F.id=Me.readVarint():2===k?F.bitmap=Me.readBytes():3===k?F.width=Me.readVarint():4===k?F.height=Me.readVarint():5===k?F.left=Me.readSVarint():6===k?F.top=Me.readSVarint():7===k&&(F.advance=Me.readVarint())}const Fy=ky,By={horizontal:1,vertical:2,horizontalOnly:3};class vf{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(k,F){const Me=new vf;return Me.scale=k||1,Me.fontStack=F,Me}static forImage(k){const F=new vf;return F.image=k,F}}class bf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(k,F){const Me=new bf;for(let Ae=0;Ae<k.sections.length;Ae++){const Oe=k.sections[Ae];Oe.image?Me.addImageSection(Oe):Me.addTextSection(Oe,F)}return Me}length(){return this.text.length}getSection(k){return this.sections[this.sectionIndex[k]]}getSections(){return this.sections}getSectionIndex(k){return this.sectionIndex[k]}getCodePoint(k){return this.text.codePointAt(k)}verticalizePunctuation(k){this.text=function(k,F){let Me="";for(let Ae=0;Ae<k.length;Ae++){const Oe=k.charCodeAt(Ae+1)||null,Fe=k.charCodeAt(Ae-1)||null;Me+=!F&&(Oe&&ga(Oe)&&!Ey[k[Ae+1]]||Fe&&ga(Fe)&&!Ey[k[Ae-1]])||!Ey[k[Ae]]?k[Ae]:Ey[k[Ae]]}return Me}(this.text,k)}trim(){let k=0;for(let F=0;F<this.text.length&&Vy[this.text.charCodeAt(F)];F++)k++;let F=this.text.length;for(let Me=this.text.length-1;Me>=0&&Me>=k&&Vy[this.text.charCodeAt(Me)];Me--)F--;this.text=this.text.substring(k,F),this.sectionIndex=this.sectionIndex.slice(k,F)}substring(k,F){const Me=new bf;return Me.text=this.text.substring(k,F),Me.sectionIndex=this.sectionIndex.slice(k,F),Me.sections=this.sections,Me}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((k,F)=>Math.max(k,this.sections[F].scale)),0)}addTextSection(k,F){this.text+=k.text,this.sections.push(vf.forText(k.scale,k.fontStack||F));const Me=this.sections.length-1;for(let F=0;F<k.text.length;++F)this.sectionIndex.push(Me)}addImageSection(k){const F=k.image&&k.image.namePrimary?k.image.getPrimary():null;if(!F)return void ft("Can't add FormattedSection with an empty image.");const Me=this.getNextImageSectionCharCode();Me?(this.text+=String.fromCodePoint(Me),this.sections.push(vf.forImage(F)),this.sectionIndex.push(this.sections.length-1)):ft("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function _f(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi){const Mi=bf.fromFeature(k,Oe);xi===By.vertical&&Mi.verticalizePunctuation(vi);let pr=[];const Ur=function(k,F,Me,Ae,Oe,Fe){if(!k)return[];const je=[],qe=function(k,F,Me,Ae,Oe,Fe){let je=0;for(let Me=0;Me<k.length();Me++){const qe=k.getSection(Me);je+=Af(k.getCodePoint(Me),qe,Ae,Oe,F,Fe)}return je/Math.max(1,Math.ceil(je/Me))}(k,F,Me,Ae,Oe,Fe),pt=k.text.indexOf("​")>=0;let vt=0;for(let Me=0;Me<k.length();Me++){const xi=k.getSection(Me),vi=k.getCodePoint(Me);if(Vy[vi]||(vt+=Af(vi,xi,Ae,Oe,F,Fe)),Me<k.length()-1){const F=!((Ut=vi)<11904||!(Op["Bopomofo Extended"](Ut)||Op.Bopomofo(Ut)||Op["CJK Compatibility Forms"](Ut)||Op["CJK Compatibility Ideographs"](Ut)||Op["CJK Compatibility"](Ut)||Op["CJK Radicals Supplement"](Ut)||Op["CJK Strokes"](Ut)||Op["CJK Symbols and Punctuation"](Ut)||Op["CJK Unified Ideographs Extension A"](Ut)||Op["CJK Unified Ideographs"](Ut)||Op["Enclosed CJK Letters and Months"](Ut)||Op["Halfwidth and Fullwidth Forms"](Ut)||Op.Hiragana(Ut)||Op["Ideographic Description Characters"](Ut)||Op["Kangxi Radicals"](Ut)||Op["Katakana Phonetic Extensions"](Ut)||Op.Katakana(Ut)||Op["Vertical Forms"](Ut)||Op["Yi Radicals"](Ut)||Op["Yi Syllables"](Ut)));(ex[vi]||F||xi.image)&&je.push(Pf(Me+1,vt,qe,je,If(vi,k.getCodePoint(Me+1),F&&pt),!1))}}var Ut;return zf(Pf(k.length(),vt,qe,je,0,!0))}(Mi,vt,Fe,F,Ae,bi),{processBidirectionalText:Wr,processStyledBidirectionalText:Jr}=$p;if(Wr&&1===Mi.sections.length){const k=Wr(Mi.toString(),Ur);for(const F of k){const k=new bf;k.text=F,k.sections=Mi.sections;for(let Me=0;Me<F.length;Me++)k.sectionIndex.push(0);pr.push(k)}}else if(Jr){const k=Jr(Mi.text,Mi.sectionIndex,Ur);for(const F of k){const k=new bf;k.text=F[0],k.sectionIndex=F[1],k.sections=Mi.sections,pr.push(k)}}else pr=function(k,F){const Me=[],Ae=k.text;let Oe=0;for(const Ae of F)Me.push(k.substring(Oe,Ae)),Oe=Ae;return Oe<Ae.length&&Me.push(k.substring(Oe,Ae.length)),Me}(Mi,Ur);const Qr=[],co={positionedLines:Qr,text:Mi.toString(),top:Ut[1],bottom:Ut[1],left:Ut[0],right:Ut[0],writingMode:xi,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi){let vi=0,bi=0,wi=0;const Mi="right"===qe?1:"left"===qe?0:.5;let pr=!1;for(const k of Oe){const Me=k.getSections();for(const k of Me){if(k.image)continue;const Me=F[k.fontStack];if(Me&&(pr=void 0!==Me.ascender&&void 0!==Me.descender,!pr))break}if(!pr)break}let Ur=0;for(const je of Oe){je.trim();const Oe=je.getMaxScale(),qe=(Oe-1)*dy,Jr={positionedGlyphs:[],lineOffset:0};k.positionedLines[Ur]=Jr;const Qr=Jr.positionedGlyphs;let co=0;if(!je.length()){bi+=Fe,++Ur;continue}let mo=0,yo=0;for(let Fe=0;Fe<je.length();Fe++){const qe=je.getSection(Fe),wi=je.getSectionIndex(Fe),Mi=je.getCodePoint(Fe);let Ur=qe.scale,Jr=null,To=null,zo=null,ko=dy,na=0;const aa=!(pt===By.horizontal||!Ut&&!ya(Mi)||Ut&&(Vy[Mi]||(Wr=Mi,Op.Arabic(Wr)||Op["Arabic Supplement"](Wr)||Op["Arabic Extended-A"](Wr)||Op["Arabic Presentation Forms-A"](Wr)||Op["Arabic Presentation Forms-B"](Wr))));if(qe.image){const F=Ae[qe.image.serialize()];if(!F)continue;zo=qe.image.id,k.iconsInText=k.iconsInText||!0,To=F.paddedRect;const Me=F.displaySize;Ur=Ur*dy/xi,Jr={width:Me[0],height:Me[1],left:0,top:-Fy,advance:aa?Me[1]:Me[0],localGlyph:!1},na=pr?-Jr.height*Ur:Oe*dy-17-Me[1]*Ur,ko=Jr.advance;const Fe=(aa?Me[0]:Me[1])*Ur-dy*Oe;Fe>0&&Fe>co&&(co=Fe)}else{const k=Me[qe.fontStack];if(!k)continue;k[Mi]&&(To=k[Mi]);const Ae=F[qe.fontStack];if(!Ae)continue;const Fe=Ae.glyphs[Mi];if(!Fe)continue;if(Jr=Fe.metrics,ko=8203!==Mi?dy:0,pr){const k=void 0!==Ae.ascender?Math.abs(Ae.ascender):0,F=void 0!==Ae.descender?Math.abs(Ae.descender):0,Me=(k+F)*Ur;mo<Me&&(mo=Me,yo=(k-F)/2*Ur),na=-k*Ur}else na=(Oe-Ur)*dy-17}aa?(k.verticalizable=!0,Qr.push({glyph:Mi,imageName:zo,x:vi,y:bi+na,vertical:aa,scale:Ur,localGlyph:Jr.localGlyph,fontStack:qe.fontStack,sectionIndex:wi,metrics:Jr,rect:To}),vi+=ko*Ur+vt):(Qr.push({glyph:Mi,imageName:zo,x:vi,y:bi+na,vertical:aa,scale:Ur,localGlyph:Jr.localGlyph,fontStack:qe.fontStack,sectionIndex:wi,metrics:Jr,rect:To}),vi+=Jr.advance*Ur+vt)}0!==Qr.length&&(wi=Math.max(vi-vt,wi),pr?kf(Qr,Mi,co,yo,Fe*Oe/2):kf(Qr,Mi,co,0,Fe/2)),vi=0;const To=Fe*Oe+co;Jr.lineOffset=Math.max(co,qe),bi+=To,++Ur}var Wr;const Jr=bi,{horizontalAlign:Qr,verticalAlign:co}=Ef(je);(function(k,F,Me,Ae,Oe,Fe){const je=(F-Me)*Oe,qe=-Fe*Ae;for(const F of k)for(const k of F.positionedGlyphs)k.x+=je,k.y+=qe})(k.positionedLines,Mi,Qr,co,wi,Jr),k.top+=-co*Jr,k.bottom=k.top+Jr,k.left+=-Qr*wi,k.right=k.left+wi,k.hasBaseline=pr}(co,F,Me,Ae,pr,je,qe,pt,xi,vt,vi,wi),!function(k){for(const F of k)if(0!==F.positionedGlyphs.length)return!1;return!0}(Qr)&&co}const Vy={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ex={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Af(k,F,Me,Ae,Oe,Fe){if(F.image){const k=Ae[F.image.serialize()];return k?k.displaySize[0]*F.scale*dy/Fe+Oe:0}{const Ae=Me[F.fontStack],Fe=Ae&&Ae.glyphs[k];return Fe?Fe.metrics.advance*F.scale+Oe:0}}function Sf(k,F,Me,Ae){const Oe=Math.pow(k-F,2);return Ae?k<F?Oe/2:2*Oe:Oe+Math.abs(Me)*Me}function If(k,F,Me){let Ae=0;return 10===k&&(Ae-=1e4),Me&&(Ae+=150),40!==k&&65288!==k||(Ae+=50),41!==F&&65289!==F||(Ae+=50),Ae}function Pf(k,F,Me,Ae,Oe,Fe){let je=null,qe=Sf(F,Me,Oe,Fe);for(const k of Ae){const Ae=Sf(F-k.x,Me,Oe,Fe)+k.badness;Ae<=qe&&(je=k,qe=Ae)}return{index:k,x:F,priorBreak:je,badness:qe}}function zf(k){return k?zf(k.priorBreak).concat(k.index):[]}function Ef(k){let F=.5,Me=.5;switch(k){case"right":case"top-right":case"bottom-right":F=1;break;case"left":case"top-left":case"bottom-left":F=0}switch(k){case"bottom":case"bottom-right":case"bottom-left":Me=1;break;case"top":case"top-right":case"top-left":Me=0}return{horizontalAlign:F,verticalAlign:Me}}function kf(k,F,Me,Ae,Oe){if(!(F||Me||Ae||Oe))return;const Fe=k.length-1,je=k[Fe],qe=(je.x+je.metrics.advance*je.scale)*F;for(let F=0;F<=Fe;F++)k[F].x-=qe,k[F].y+=Me+Ae+Oe}function Tf(k,F,Me,Ae){const{horizontalAlign:Oe,verticalAlign:Fe}=Ef(Ae),je=Me[0]-k.displaySize[0]*Oe,qe=Me[1]-k.displaySize[1]*Fe;return{imagePrimary:k,imageSecondary:F,top:qe,bottom:qe+k.displaySize[1],left:je,right:je+k.displaySize[0]}}function Bf(k,F,Me,Ae,Oe,Fe){const je=k.imagePrimary;let qe;if(je.content){const k=je.content,F=je.pixelRatio||1;qe=[k[0]/F,k[1]/F,je.displaySize[0]-k[2]/F,je.displaySize[1]-k[3]/F]}const pt=F.left*Fe,vt=F.right*Fe;let Ut,xi,vi,bi;"width"===Me||"both"===Me?(bi=Oe[0]+pt-Ae[3],xi=Oe[0]+vt+Ae[1]):(bi=Oe[0]+(pt+vt-je.displaySize[0])/2,xi=bi+je.displaySize[0]);const wi=F.top*Fe,Mi=F.bottom*Fe;return"height"===Me||"both"===Me?(Ut=Oe[1]+wi-Ae[0],vi=Oe[1]+Mi+Ae[2]):(Ut=Oe[1]+(wi+Mi-je.displaySize[1])/2,vi=Ut+je.displaySize[1]),{imagePrimary:je,imageSecondary:void 0,top:Ut,right:xi,bottom:vi,left:bi,collisionPadding:qe}}class Vf extends Sa{constructor(k,F,Me,Ae,Oe){super(k,F),this.angle=Ae,this.z=Me,void 0!==Oe&&(this.segment=Oe)}clone(){return new Vf(this.x,this.y,this.z,this.angle,this.segment)}}function Cf(k,F,Me,Ae,Oe){if(void 0===F.segment)return!0;let Fe=F,je=F.segment+1,qe=0;for(;qe>-Me/2;){if(je--,je<0)return!1;qe-=k[je].dist(Fe),Fe=k[je]}qe+=k[je].dist(k[je+1]),je++;const pt=[];let vt=0;for(;qe<Me/2;){const F=k[je],Me=k[je+1];if(!Me)return!1;let Fe=k[je-1].angleTo(F)-F.angleTo(Me);for(Fe=Math.abs((Fe+3*Math.PI)%(2*Math.PI)-Math.PI),pt.push({distance:qe,angleDelta:Fe}),vt+=Fe;qe-pt[0].distance>Ae;)vt-=pt.shift().angleDelta;if(vt>Oe)return!1;je++,qe+=F.dist(Me)}return!0}function Df(k){let F=0;for(let Me=0;Me<k.length-1;Me++)F+=k[Me].dist(k[Me+1]);return F}function Lf(k,F,Me){return k?.6*F*Me:0}function Rf(k,F){return Math.max(k?k.right-k.left:0,F?F.right-F.left:0)}function Ff(k,F,Me,Ae,Oe,Fe){const je=Lf(Me,Oe,Fe),qe=Rf(Me,Ae)*Fe;let pt=0;const vt=Df(k)/2;for(let Me=0;Me<k.length-1;Me++){const Ae=k[Me],Oe=k[Me+1],Fe=Ae.dist(Oe);if(pt+Fe>vt){const Ut=(vt-pt)/Fe,xi=ze(Ae.x,Oe.x,Ut),vi=ze(Ae.y,Oe.y,Ut),bi=new Vf(xi,vi,0,Oe.angleTo(Ae),Me);return!je||Cf(k,bi,qe,je,F)?bi:void 0}pt+=Fe}}function Of(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=Lf(Ae,Fe,je),Ut=Rf(Ae,Oe),xi=Ut*je,vi=0===k[0].x||k[0].x===pt||0===k[0].y||k[0].y===pt;return F-xi<F/4&&(F=xi+F/4),Nf(k,vi?F/2*qe%F:(Ut/2+2*Fe)*je*qe%F,F,vt,Me,xi,vi,!1,pt)}function Nf(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=Fe/2,Ut=Df(k);let xi=0,vi=F-Me,bi=[];for(let F=0;F<k.length-1;F++){const je=k[F],qe=k[F+1],wi=je.dist(qe),Mi=qe.angleTo(je);for(;vi+Me<xi+wi;){vi+=Me;const pr=(vi-xi)/wi,Ur=ze(je.x,qe.x,pr),Wr=ze(je.y,qe.y,pr);if(Ur>=0&&Ur<pt&&Wr>=0&&Wr<pt&&vi-vt>=0&&vi+vt<=Ut){const Me=new Vf(Ur,Wr,0,Mi,F);Ae&&!Cf(k,Me,Fe,Ae,Oe)||bi.push(Me)}}xi+=wi}return qe||bi.length||je||(bi=Nf(k,xi/2,Me,Ae,Oe,Fe,je,!0,pt)),bi}function Uf(k,F,Me,Ae,Oe){const Fe=[];for(let je=0;je<k.length;je++){const qe=k[je];let pt;for(let k=0;k<qe.length-1;k++){let je=qe[k],vt=qe[k+1];je.x<F&&vt.x<F||(je.x<F?je=new Sa(F,je.y+(F-je.x)/(vt.x-je.x)*(vt.y-je.y))._round():vt.x<F&&(vt=new Sa(F,je.y+(F-je.x)/(vt.x-je.x)*(vt.y-je.y))._round()),je.y<Me&&vt.y<Me||(je.y<Me?je=new Sa(je.x+(Me-je.y)/(vt.y-je.y)*(vt.x-je.x),Me)._round():vt.y<Me&&(vt=new Sa(je.x+(Me-je.y)/(vt.y-je.y)*(vt.x-je.x),Me)._round()),je.x>=Ae&&vt.x>=Ae||(je.x>=Ae?je=new Sa(Ae,je.y+(Ae-je.x)/(vt.x-je.x)*(vt.y-je.y))._round():vt.x>=Ae&&(vt=new Sa(Ae,je.y+(Ae-je.x)/(vt.x-je.x)*(vt.y-je.y))._round()),je.y>=Oe&&vt.y>=Oe||(je.y>=Oe?je=new Sa(je.x+(Oe-je.y)/(vt.y-je.y)*(vt.x-je.x),Oe)._round():vt.y>=Oe&&(vt=new Sa(je.x+(Oe-je.y)/(vt.y-je.y)*(vt.x-je.x),Oe)._round()),pt&&je.equals(pt[pt.length-1])||(pt=[je],Fe.push(pt)),pt.push(vt)))))}}return Fe}function jf(k){let F=0,Me=0;for(const Ae of k)F+=Ae.w*Ae.h,Me=Math.max(Me,Ae.w);k.sort(((k,F)=>F.h-k.h));const Ae=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(F/.95)),Me),h:1/0}];let Oe=0,Fe=0;for(const F of k)for(let k=Ae.length-1;k>=0;k--){const Me=Ae[k];if(!(F.w>Me.w||F.h>Me.h)){if(F.x=Me.x,F.y=Me.y,Fe=Math.max(Fe,F.y+F.h),Oe=Math.max(Oe,F.x+F.w),F.w===Me.w&&F.h===Me.h){const F=Ae.pop();k<Ae.length&&(Ae[k]=F)}else F.h===Me.h?(Me.x+=F.w,Me.w-=F.w):F.w===Me.w?(Me.y+=F.h,Me.h-=F.h):(Ae.push({x:Me.x+F.w,y:Me.y,w:Me.w-F.w,h:F.h}),Me.y+=F.h,Me.h-=F.h);break}}return{w:Oe,h:Fe,fill:F/(Oe*Fe)||0}}oa(Vf,"Anchor");const tx=1;class $f{constructor(k,{pixelRatio:F,version:Me,stretchX:Ae,stretchY:Oe,content:Fe},je){this.paddedRect=k,this.pixelRatio=F,this.stretchX=Ae,this.stretchY=Oe,this.content=Fe,this.version=Me,this.padding=je}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class Gf{constructor(k,F,Me){const Ae={},Oe={};this.haveRenderCallbacks=[];const Fe=[];this.addImages(k,Ae,tx,Fe),this.addImages(F,Oe,2,Fe);const{w:je,h:qe}=jf(Fe),pt=new sc({width:je||1,height:qe||1});for(const F in k){const Oe=k[F],Fe=Ae[F].paddedRect;sc.copy(Oe.data,pt,{x:0,y:0},{x:Fe.x+tx,y:Fe.y+tx},Oe.data,Me,Oe.sdf)}for(const k in F){const Ae=F[k],Fe=Oe[k].paddedRect;let je=Oe[k].padding;const qe=Fe.x+je,vt=Fe.y+je,Ut=Ae.data.width,xi=Ae.data.height;je=je>1?je-1:je,sc.copy(Ae.data,pt,{x:0,y:0},{x:qe,y:vt},Ae.data,Me),sc.copy(Ae.data,pt,{x:0,y:xi-je},{x:qe,y:vt-je},{width:Ut,height:je},Me),sc.copy(Ae.data,pt,{x:0,y:0},{x:qe,y:vt+xi},{width:Ut,height:je},Me),sc.copy(Ae.data,pt,{x:Ut-je,y:0},{x:qe-je,y:vt},{width:je,height:xi},Me),sc.copy(Ae.data,pt,{x:0,y:0},{x:qe+Ut,y:vt},{width:je,height:xi},Me),sc.copy(Ae.data,pt,{x:Ut-je,y:xi-je},{x:qe-je,y:vt-je},{width:je,height:je},Me),sc.copy(Ae.data,pt,{x:0,y:xi-je},{x:qe+Ut,y:vt-je},{width:je,height:je},Me),sc.copy(Ae.data,pt,{x:0,y:0},{x:qe+Ut,y:vt+xi},{width:je,height:je},Me),sc.copy(Ae.data,pt,{x:Ut-je,y:0},{x:qe-je,y:vt+xi},{width:je,height:je},Me)}this.image=pt,this.iconPositions=Ae,this.patternPositions=Oe}addImages(k,F,Me,Ae){for(const Oe in k){const Fe=k[Oe],je={x:0,y:0,w:Fe.data.width+2*Me,h:Fe.data.height+2*Me};Ae.push(je),F[Oe]=new $f(je,Fe,Me),Fe.hasRenderCallback&&this.haveRenderCallbacks.push(Qe.deserializeId(Oe))}}patchUpdatedImages(k,F,Me){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((F=>k.hasImage(F,Me))),k.dispatchRenderCallbacks(this.haveRenderCallbacks,Me);for(const Ae in k.getUpdatedImages(Me)){for(const Oe of Object.keys(this.iconPositions))Qe.deserializeId(Oe)===Ae&&this.patchUpdatedImage(this.iconPositions[Oe],k.getImage(Ae,Me),F);for(const Oe of Object.keys(this.patternPositions))Qe.deserializeId(Oe)===Ae&&this.patchUpdatedImage(this.patternPositions[Oe],k.getImage(Ae,Me),F)}}patchUpdatedImage(k,F,Me){if(!k||!F)return;if(k.version===F.version)return;k.version=F.version;const[Ae,Oe]=k.tl;Me.update(F.data,{position:{x:Ae,y:Oe}})}}oa($f,"ImagePosition"),oa(Gf,"ImageAtlas");const ix=1e20;function Xf(k,F,Me,Ae,Oe,Fe,je,qe,pt){for(let vt=F;vt<F+Ae;vt++)Zf(k,Me*Fe+vt,Fe,Oe,je,qe,pt);for(let vt=Me;vt<Me+Oe;vt++)Zf(k,vt*Fe+F,1,Ae,je,qe,pt)}function Zf(k,F,Me,Ae,Oe,Fe,je){Fe[0]=0,je[0]=-ix,je[1]=ix,Oe[0]=k[F];for(let qe=1,pt=0,vt=0;qe<Ae;qe++){Oe[qe]=k[F+qe*Me];const Ae=qe*qe;do{const k=Fe[pt];vt=(Oe[qe]-Oe[k]+Ae-k*k)/(qe-k)/2}while(vt<=je[pt]&&--pt>-1);pt++,Fe[pt]=qe,je[pt]=vt,je[pt+1]=ix}for(let qe=0,pt=0;qe<Ae;qe++){for(;je[pt+1]<qe;)pt++;const Ae=Fe[pt],vt=qe-Ae;k[F+qe*Me]=Oe[Ae]+vt*vt}}const rx=2,nx={none:0,ideographs:1,all:2};class Kf{constructor(k,F,Me){this.requestManager=k,this.localGlyphMode=F,this.localFontFamily=Me,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(k,F){this.urls[F]=k}getGlyphs(k,F,Me){const Ae=[],Oe=this.urls[F]||Jl.GLYPHS_URL;for(const F in k)for(const Me of k[F])Ae.push({stack:F,id:Me});rt(Ae,(({stack:k,id:F},Me)=>{let Ae=this.entries[k];Ae||(Ae=this.entries[k]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let Fe=Ae.glyphs[F];if(void 0!==Fe)return void Me(null,{stack:k,id:F,glyph:Fe});if(Fe=this._tinySDF(Ae,k,F),Fe)return Ae.glyphs[F]=Fe,void Me(null,{stack:k,id:F,glyph:Fe});const je=Math.floor(F/256);if(256*je>65535)return ft("glyphs > 65535 not supported"),void Me(null,{stack:k,id:F,glyph:Fe});if(Ae.ranges[je])return void Me(null,{stack:k,id:F,glyph:Fe});let qe=Ae.requests[je];qe||(qe=Ae.requests[je]=[],Kf.loadGlyphRange(k,je,Oe,this.requestManager,((k,F)=>{if(F){Ae.ascender=F.ascender,Ae.descender=F.descender;for(const k in F.glyphs)this._doesCharSupportLocalGlyph(+k)||(Ae.glyphs[+k]=F.glyphs[+k]);Ae.ranges[je]=!0}for(const Me of qe)Me(k,F);delete Ae.requests[je]}))),qe.push(((Ae,Oe)=>{Ae?Me(Ae):Oe&&Me(null,{stack:k,id:F,glyph:Oe.glyphs[F]||null})}))}),((k,F)=>{if(k)Me(k);else if(F){const k={};for(const{stack:Me,id:Ae,glyph:Oe}of F)void 0===k[Me]&&(k[Me]={}),void 0===k[Me].glyphs&&(k[Me].glyphs={}),k[Me].glyphs[Ae]=Oe&&{id:Oe.id,bitmap:Oe.bitmap.clone(),metrics:Oe.metrics},k[Me].ascender=this.entries[Me].ascender,k[Me].descender=this.entries[Me].descender;Me(null,k)}}))}_doesCharSupportLocalGlyph(k){return this.localGlyphMode!==nx.none&&(this.localGlyphMode===nx.all?!!this.localFontFamily:!!this.localFontFamily&&(Op["CJK Unified Ideographs"](k)||Op["Hangul Syllables"](k)||Op.Hiragana(k)||Op.Katakana(k)||Op["CJK Symbols and Punctuation"](k)||Op["CJK Unified Ideographs Extension A"](k)||Op["CJK Unified Ideographs Extension B"](k)||Op.Osage(k)))}_tinySDF(k,F,Me){const Ae=this.localFontFamily;if(!Ae||!this._doesCharSupportLocalGlyph(Me))return;let Oe=k.tinySDF;if(!Oe){let Me="400";/bold/i.test(F)?Me="900":/medium/i.test(F)?Me="500":/light/i.test(F)&&(Me="200"),Oe=k.tinySDF=new Kf.TinySDF({fontFamily:Ae,fontWeight:Me,fontSize:24*rx,buffer:3*rx,radius:8*rx}),Oe.fontWeight=Me}if(this.localGlyphs[Oe.fontWeight][Me])return this.localGlyphs[Oe.fontWeight][Me];const Fe=String.fromCodePoint(Me),{data:je,width:qe,height:pt,glyphWidth:vt,glyphHeight:Ut,glyphLeft:xi,glyphTop:vi,glyphAdvance:bi}=Oe.draw(Fe);return this.localGlyphs[Oe.fontWeight][Me]={id:Me,bitmap:new ac({width:qe,height:pt},je),metrics:{width:vt/rx,height:Ut/rx,left:xi/rx,top:vi/rx-27,advance:bi/rx,localGlyph:!0}}}}Kf.loadGlyphRange=function(k,F,Me,Ae,Oe){const Fe=256*F,je=Fe+255,qe=Ae.transformRequest(Ae.normalizeGlyphsURL(Me).replace("{fontstack}",k).replace("{range}",`${Fe}-${je}`),sh.Glyphs);ie(qe,((k,F)=>{if(k)Oe(k);else if(F){const k={},Me=function(k){return new Ly(k).readFields(df,{})}(F);for(const F of Me.glyphs)k[F.id]=F;Oe(null,{glyphs:k,ascender:Me.ascender,descender:Me.descender})}}))},Kf.TinySDF=class{constructor({fontSize:k=24,buffer:F=3,radius:Me=8,cutoff:Ae=.25,fontFamily:Oe="sans-serif",fontWeight:Fe="normal",fontStyle:je="normal"}={}){this.buffer=F,this.cutoff=Ae,this.radius=Me;const qe=this.size=k+4*F,pt=this._createCanvas(qe),vt=this.ctx=pt.getContext("2d",{willReadFrequently:!0});vt.font=`${je} ${Fe} ${k}px ${Oe}`,vt.textBaseline="alphabetic",vt.textAlign="left",vt.fillStyle="black",this.gridOuter=new Float64Array(qe*qe),this.gridInner=new Float64Array(qe*qe),this.f=new Float64Array(qe),this.z=new Float64Array(qe+1),this.v=new Uint16Array(qe)}_createCanvas(k){const F=document.createElement("canvas");return F.width=F.height=k,F}draw(k){const{width:F,actualBoundingBoxAscent:Me,actualBoundingBoxDescent:Ae,actualBoundingBoxLeft:Oe,actualBoundingBoxRight:Fe}=this.ctx.measureText(k),je=Math.ceil(Me),qe=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(Fe-Oe))),pt=Math.min(this.size-this.buffer,je+Math.ceil(Ae)),vt=qe+2*this.buffer,Ut=pt+2*this.buffer,xi=Math.max(vt*Ut,0),vi=new Uint8ClampedArray(xi),bi={data:vi,width:vt,height:Ut,glyphWidth:qe,glyphHeight:pt,glyphTop:je,glyphLeft:0,glyphAdvance:F};if(0===qe||0===pt)return bi;const{ctx:wi,buffer:Mi,gridInner:pr,gridOuter:Ur}=this;wi.clearRect(Mi,Mi,qe,pt),wi.fillText(k,Mi,Mi+je);const Wr=wi.getImageData(Mi,Mi,qe,pt);Ur.fill(ix,0,xi),pr.fill(0,0,xi);for(let k=0;k<pt;k++)for(let F=0;F<qe;F++){const Me=Wr.data[4*(k*qe+F)+3]/255;if(0===Me)continue;const Ae=(k+Mi)*vt+F+Mi;if(1===Me)Ur[Ae]=0,pr[Ae]=ix;else{const k=.5-Me;Ur[Ae]=k>0?k*k:0,pr[Ae]=k<0?k*k:0}}Xf(Ur,0,0,vt,Ut,vt,this.f,this.v,this.z),Xf(pr,Mi,Mi,qe,pt,vt,this.f,this.v,this.z);for(let k=0;k<xi;k++){const F=Math.sqrt(Ur[k])-Math.sqrt(pr[k]);vi[k]=Math.round(255-255*(F/this.radius+this.cutoff))}return bi}};const ox=tx;function Qf(k,F){return k+F[1]-F[0]}function td(k,F,Me,Ae,Oe=1){const Fe=[],je=k.imagePrimary,qe=je.pixelRatio,pt=je.paddedRect.w-2*ox,vt=je.paddedRect.h-2*ox,Ut=(k.right-k.left)*Oe,xi=(k.bottom-k.top)*Oe,vi=je.stretchX||[[0,pt]],bi=je.stretchY||[[0,vt]],wi=vi.reduce(Qf,0),Mi=bi.reduce(Qf,0),pr=pt-wi,Ur=vt-Mi;let Wr=0,Jr=wi,Qr=0,co=Mi,mo=0,yo=pr,To=0,zo=Ur;if(je.content&&Ae){const k=je.content;Wr=ed(vi,0,k[0]),Qr=ed(bi,0,k[1]),Jr=ed(vi,k[0],k[2]),co=ed(bi,k[1],k[3]),mo=k[0]-Wr,To=k[1]-Qr,yo=k[2]-k[0]-Jr,zo=k[3]-k[1]-co}const I=(Ae,Fe,pt,vt)=>{const vi=nd(Ae.stretch-Wr,Jr,Ut,k.left*Oe),bi=id(Ae.fixed-mo,yo,Ae.stretch,wi),pr=nd(Fe.stretch-Qr,co,xi,k.top*Oe),Ur=id(Fe.fixed-To,zo,Fe.stretch,Mi),ko=nd(pt.stretch-Wr,Jr,Ut,k.left*Oe),na=id(pt.fixed-mo,yo,pt.stretch,wi),aa=nd(vt.stretch-Qr,co,xi,k.top*Oe),_a=id(vt.fixed-To,zo,vt.stretch,Mi),wa=new Sa(vi,pr),Ya=new Sa(ko,pr),rl=new Sa(ko,aa),sl=new Sa(vi,aa),ml=new Sa(bi/qe,Ur/qe),Sl=new Sa(na/qe,_a/qe),Il=F*Math.PI/180;if(Il){const k=Math.sin(Il),F=Math.cos(Il),Me=[F,-k,k,F];wa._matMult(Me),Ya._matMult(Me),sl._matMult(Me),rl._matMult(Me)}const Kl=Ae.stretch+Ae.fixed,Jl=pt.stretch+pt.fixed,Ql=Fe.stretch+Fe.fixed,ec=vt.stretch+vt.fixed,tc=k.imageSecondary;return{tl:wa,tr:Ya,bl:sl,br:rl,texPrimary:{x:je.paddedRect.x+ox+Kl,y:je.paddedRect.y+ox+Ql,w:Jl-Kl,h:ec-Ql},texSecondary:tc?{x:tc.paddedRect.x+ox+Kl,y:tc.paddedRect.y+ox+Ql,w:Jl-Kl,h:ec-Ql}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ml,pixelOffsetBR:Sl,minFontScaleX:yo/qe/Ut,minFontScaleY:zo/qe/xi,isSDF:Me}};if(Ae&&(je.stretchX||je.stretchY)){const k=rd(vi,pr,wi),F=rd(bi,Ur,Mi);for(let Me=0;Me<k.length-1;Me++){const Ae=k[Me],Oe=k[Me+1];for(let k=0;k<F.length-1;k++)Fe.push(I(Ae,F[k],Oe,F[k+1]))}}else Fe.push(I({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:pt+1},{fixed:0,stretch:vt+1}));return Fe}function ed(k,F,Me){let Ae=0;for(const Oe of k)Ae+=Math.max(F,Math.min(Me,Oe[1]))-Math.max(F,Math.min(Me,Oe[0]));return Ae}function rd(k,F,Me){const Ae=[{fixed:-ox,stretch:0}];for(const[F,Me]of k){const k=Ae[Ae.length-1];Ae.push({fixed:F-k.stretch,stretch:k.stretch}),Ae.push({fixed:F-k.stretch,stretch:k.stretch+(Me-F)})}return Ae.push({fixed:F+ox,stretch:Me}),Ae}function nd(k,F,Me,Ae){return k/F*Me+Ae}function id(k,F,Me,Ae){return k-F*Me/Ae}function ad(k,F,Me,Ae){const Oe=F+k.positionedLines[Ae].lineOffset;return 0===Ae?Me+Oe/2:Me+(Oe+(F+k.positionedLines[Ae-1].lineOffset))/2}function sd(k,F=1,Me=!1){let Ae=1/0,Oe=1/0,Fe=-1/0,je=-1/0;const qe=k[0];for(let k=0;k<qe.length;k++){const F=qe[k];(!k||F.x<Ae)&&(Ae=F.x),(!k||F.y<Oe)&&(Oe=F.y),(!k||F.x>Fe)&&(Fe=F.x),(!k||F.y>je)&&(je=F.y)}const pt=Math.min(Fe-Ae,je-Oe);let vt=pt/2;const Ut=new Hr([],od);if(0===pt)return new Sa(Ae,Oe);for(let F=Ae;F<Fe;F+=pt)for(let Me=Oe;Me<je;Me+=pt)Ut.push(new ld(F+vt,Me+vt,vt,k));let xi=function(k){let F=0,Me=0,Ae=0;const Oe=k[0];for(let k=0,Fe=Oe.length,je=Fe-1;k<Fe;je=k++){const Fe=Oe[k],qe=Oe[je],pt=Fe.x*qe.y-qe.x*Fe.y;Me+=(Fe.x+qe.x)*pt,Ae+=(Fe.y+qe.y)*pt,F+=3*pt}return new ld(Me/F,Ae/F,0,k)}(k),vi=Ut.length;for(;Ut.length;){const Ae=Ut.pop();(Ae.d>xi.d||!xi.d)&&(xi=Ae,Me&&console.log("found best %d after %d probes",Math.round(1e4*Ae.d)/1e4,vi)),Ae.max-xi.d<=F||(vt=Ae.h/2,Ut.push(new ld(Ae.p.x-vt,Ae.p.y-vt,vt,k)),Ut.push(new ld(Ae.p.x+vt,Ae.p.y-vt,vt,k)),Ut.push(new ld(Ae.p.x-vt,Ae.p.y+vt,vt,k)),Ut.push(new ld(Ae.p.x+vt,Ae.p.y+vt,vt,k)),vi+=4)}return Me&&(console.log(`num probes: ${vi}`),console.log(`best distance: ${xi.d}`)),xi.p}function od(k,F){return F.max-k.max}class ld{constructor(k,F,Me,Ae){this.p=new Sa(k,F),this.h=Me,this.d=function(k,F){let Me=!1,Ae=1/0;for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe];for(let F=0,Oe=Fe.length,je=Oe-1;F<Oe;je=F++){const Oe=Fe[F],qe=Fe[je];Oe.y>k.y!=qe.y>k.y&&k.x<(qe.x-Oe.x)*(k.y-Oe.y)/(qe.y-Oe.y)+Oe.x&&(Me=!Me),Ae=Math.min(Ae,Nl(k,Oe,qe))}}return(Me?1:-1)*Math.sqrt(Ae)}(this.p,Ae),this.max=this.d+this.h*Math.SQRT2}}const ax=Number.POSITIVE_INFINITY,lx=Math.sqrt(2);function hd(k,[F,Me]){let Ae=0,Oe=0;if(Me===ax){F<0&&(F=0);const Me=F/lx;switch(k){case"top-right":case"top-left":Oe=Me-7;break;case"bottom-right":case"bottom-left":Oe=7-Me;break;case"bottom":Oe=7-F;break;case"top":Oe=F-7}switch(k){case"top-right":case"bottom-right":Ae=-Me;break;case"top-left":case"bottom-left":Ae=Me;break;case"left":Ae=F;break;case"right":Ae=-F}}else{switch(F=Math.abs(F),Me=Math.abs(Me),k){case"top-right":case"top-left":case"top":Oe=Me-7;break;case"bottom-right":case"bottom-left":case"bottom":Oe=7-Me}switch(k){case"top-right":case"bottom-right":case"right":Ae=-F;break;case"top-left":case"bottom-left":case"left":Ae=F}}return[Ae,Oe]}function pd(k){switch(k){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function fd(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi){let pr=Fe.textMaxSize.evaluate(F,{},vi);void 0===pr?pr=je*Fe.textScaleFactor:pr*=Fe.textScaleFactor;const Ur=k.layers[0].layout,Wr=Ur.get("icon-offset").evaluate(F,{},vi),Jr=gd(Me.horizontal)||Me.vertical,Qr="globe"===bi.name,co=dy,mo=je*Fe.textScaleFactor/co,yo=k.tilePixelRatio*pr/co,To=(Ya=k.overscaling,k.zoom>18&&Ya>2&&(Ya>>=1),Math.max(Td/(512*Ya),1)*Ur.get("symbol-spacing")),zo=Ur.get("text-padding")*k.tilePixelRatio,ko=Ur.get("icon-padding")*k.tilePixelRatio,na=X(Ur.get("text-max-angle")),aa="map"===Ur.get("text-rotation-alignment")&&"point"!==Ur.get("symbol-placement"),_a="map"===Ur.get("icon-rotation-alignment")&&"point"!==Ur.get("symbol-placement"),wa=Ur.get("symbol-placement"),Sa=To/2;var Ya;const rl=Ur.get("icon-text-fit").evaluate(F,{},vi),sl=Ur.get("icon-text-fit-padding").evaluate(F,{},vi),ml="none"!==rl;let Sl;!1===k.hasAnyIconTextFit&&ml&&(k.hasAnyIconTextFit=!0),Ae&&ml&&(k.allowVerticalPlacement&&Me.vertical&&(Sl=Bf(Ae,Me.vertical,rl,sl,Wr,mo)),Jr&&(Ae=Bf(Ae,Jr,rl,sl,Wr,mo)));const R=(je,qe,pr)=>{if(qe.x<0||qe.x>=Td||qe.y<0||qe.y>=Td)return;let Ur=null;if(Qr){const{x:k,y:F,z:Me}=bi.projectTilePoint(qe.x,qe.y,pr);Ur={anchor:new Vf(k,F,Me,0,void 0),up:bi.upVector(pr,qe.x,qe.y)}}!function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co,mo,yo,To,zo,ko,na){const aa=k.addToLineVertexArray(F,Ae);let _a,wa,Sa,Ya,rl,sl,ml,Sl=0,Il=0,Kl=0,Jl=0,Ql=-1,ec=-1;const tc={};let cc=Fh("");const uc=Me?Me.anchor:F,jc="none"!==pt.layout.get("icon-text-fit").evaluate(Qr,{},zo);let Gc=0,qc=0;if(void 0===pt._unevaluatedLayout.getValue("text-radial-offset")?[Gc,qc]=pt.layout.get("text-offset").evaluate(Qr,{},zo).map((k=>k*dy)):(Gc=pt.layout.get("text-radial-offset").evaluate(Qr,{},zo)*dy,qc=ax),k.allowVerticalPlacement&&Oe.vertical){const k=Oe.vertical;if(wi)sl=vd(k),qe&&(ml=vd(qe));else{const Me=pt.layout.get("text-rotate").evaluate(Qr,{},zo)+90;Sa=xd(vt,uc,F,Ut,xi,vi,k,bi,Me,Mi),qe&&(Ya=xd(vt,uc,F,Ut,xi,vi,qe,Ur,Me))}}if(Fe){const Ae=k.iconSizeData,Oe=yo?Wp(k.iconSizeData,k.layers[0]._unevaluatedLayout._values["icon-size"],zo,k.zoom,Qr):1,je=pt.layout.get("icon-rotate").evaluate(Qr,{},zo),bi=td(Fe,je,mo,jc,yo?1/Oe:co.iconScaleFactor),wi=qe?td(qe,je,mo,jc,co.iconScaleFactor):void 0;wa=xd(vt,uc,F,Ut,xi,vi,Fe,Ur,je,null,yo?co.iconScaleFactor*Oe:1),Sl=4*bi.length;let Mi=null;"source"===Ae.kind?(Mi=[_y*pt.layout.get("icon-size").evaluate(Qr,{},zo)*co.iconScaleFactor],Mi[0]>ux&&ft(`${k.layerIds[0]}: Value for "icon-size" is >= ${cx}. Reduce your "icon-size".`)):"composite"===Ae.kind&&(Mi=[_y*co.compositeIconSizes[0].evaluate(Qr,{},zo)*co.iconScaleFactor,_y*co.compositeIconSizes[1].evaluate(Qr,{},zo)*co.iconScaleFactor],(Mi[0]>ux||Mi[1]>ux)&&ft(`${k.layerIds[0]}: Value for "icon-size" is >= ${cx}. Reduce your "icon-size".`)),k.addSymbols(k.icon,bi,Mi,Jr,Wr,Qr,!1,Me,F,aa.lineStartIndex,aa.lineLength,-1,To,zo,ko,na),Ql=k.icon.placedSymbolArray.length-1,wi&&(Il=4*wi.length,k.addSymbols(k.icon,wi,Mi,Jr,Wr,Qr,By.vertical,Me,F,aa.lineStartIndex,aa.lineLength,-1,To,zo,ko,na),ec=k.icon.placedSymbolArray.length-1)}for(const Ae in Oe.horizontal){const Fe=Oe.horizontal[Ae];_a||(cc=Fh(Fe.text),wi?rl=vd(Fe):_a=xd(vt,uc,F,Ut,xi,vi,Fe,bi,pt.layout.get("text-rotate").evaluate(Qr,{},zo),Mi));const qe=1===Fe.positionedLines.length;if(Kl+=yd(k,Me,F,Fe,je,pt,wi,Qr,Mi,aa,Oe.vertical?By.horizontal:By.horizontalOnly,qe?Object.keys(Oe.horizontal):[Ae],tc,Ql,co,To,zo,ko),qe)break}Oe.vertical&&(Jl+=yd(k,Me,F,Oe.vertical,je,pt,wi,Qr,Mi,aa,By.vertical,["vertical"],tc,ec,co,To,zo,ko));let Hc=-1;const H=(k,F)=>k?Math.max(k,F):F;Hc=H(rl,Hc),Hc=H(sl,Hc),Hc=H(ml,Hc);const $c=Hc>-1?1:0;k.glyphOffsetArray.length>=65535&&ft("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Qr.sortKey&&k.addToSortKeyRanges(k.symbolInstances.length,Qr.sortKey),k.symbolInstances.emplaceBack(F.x,F.y,uc.x,uc.y,uc.z,tc.right>=0?tc.right:-1,tc.center>=0?tc.center:-1,tc.left>=0?tc.left:-1,tc.vertical>=0?tc.vertical:-1,Ql,ec,cc,void 0!==_a?_a:k.collisionBoxArray.length,void 0!==_a?_a+1:k.collisionBoxArray.length,void 0!==Sa?Sa:k.collisionBoxArray.length,void 0!==Sa?Sa+1:k.collisionBoxArray.length,void 0!==wa?wa:k.collisionBoxArray.length,void 0!==wa?wa+1:k.collisionBoxArray.length,Ya||k.collisionBoxArray.length,Ya?Ya+1:k.collisionBoxArray.length,Ut,Kl,Jl,Sl,Il,$c,0,Gc,qc,Hc,0,jc?1:0)}(k,qe,Ur,je,Me,Ae,Oe,Sl,k.layers[0],k.collisionBoxArray,F.index,F.sourceLayerIndex,k.index,zo,aa,pt,0,ko,_a,Wr,F,Fe,vt,Ut,xi,vi,wi,Mi)};if("line"===wa)for(const Oe of Uf(F.geometry,0,0,Td,Td)){const F=Of(Oe,To,na,Me.vertical||Jr,Ae,co,yo,k.overscaling,Td);for(const Me of F)Jr&&bd(k,Jr.text,Sa,Me)||R(Oe,Me,vi)}else if("line-center"===wa){for(const k of F.geometry)if(k.length>1){const F=Ff(k,na,Me.vertical||Jr,Ae,co,yo);F&&R(k,F,vi)}}else if("Polygon"===F.type)for(const k of Lc(F.geometry,0)){const F=sd(k,16);R(k[0],new Vf(F.x,F.y,0,0,void 0),vi)}else if("LineString"===F.type)for(const k of F.geometry)R(k,new Vf(k[0].x,k[0].y,0,0,void 0),vi);else if("Point"===F.type)for(const k of F.geometry)for(const F of k)R([F],new Vf(F.x,F.y,0,0,void 0),vi)}const cx=255,ux=cx*_y;function yd(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur){const Wr=function(k,F,Me,Ae,Oe,Fe,je,qe){const pt=[];if(0===F.positionedLines.length)return pt;const vt=Ae.layout.get("text-rotate").evaluate(Fe,{})*Math.PI/180,Ut=function(k){const F=k[0],Me=k[1],Ae=F*Me;return Ae>0?[F,-Me]:Ae<0?[-F,Me]:0===F?[Me,F]:[Me,-F]}(Me);let xi=Math.abs(F.top-F.bottom);for(const k of F.positionedLines)xi-=k.lineOffset;const vi=F.positionedLines.length,bi=xi/vi;let wi=F.top-Me[1];for(let k=0;k<vi;++k){const Ae=F.positionedLines[k];wi=ad(F,bi,wi,k);for(const k of Ae.positionedGlyphs){if(!k.rect)continue;const Ae=k.rect||{};let Fe=Fy+1,xi=!0,vi=1,bi=0;if(k.imageName){const F=je[tr.build(k.imageName).getSerializedPrimary()];if(!F)continue;if(F.sdf){ft("SDF images are not supported in formatted text and will be ignored.");continue}xi=!1,vi=F.pixelRatio,Fe=tx/vi}const Mi=(Oe||qe)&&k.vertical,pr=k.metrics.advance*k.scale/2,Ur=k.metrics,Wr=k.rect;if(null===Wr)continue;qe&&F.verticalizable&&(bi=k.imageName?pr-k.metrics.width*k.scale/2:0);const Jr=Oe?[k.x+pr,k.y]:[0,0];let Qr=[0,0],co=[0,0],mo=!1;Oe||(Mi?(co=[k.x+pr+Ut[0],k.y+Ut[1]-bi],mo=!0):Qr=[k.x+pr+Me[0],k.y+Me[1]-bi]);const yo=Wr.w*k.scale/(vi*(k.localGlyph?rx:1)),To=Wr.h*k.scale/(vi*(k.localGlyph?rx:1));let zo,ko,na,aa;if(Mi){const F=k.y-wi,Me=new Sa(-pr,pr-F),Ae=-Math.PI/2,Oe=new Sa(...co);zo=new Sa(-pr+Qr[0],Qr[1]),zo._rotateAround(Ae,Me)._add(Oe),zo.x+=-F+pr,zo.y-=(Ur.left-Fe)*k.scale;const je=k.imageName?Ur.advance*k.scale:dy*k.scale,qe=String.fromCodePoint(k.glyph);nf(qe)?zo.x+=(1-Fe)*k.scale:af(qe)?zo.x+=je-Ur.height*k.scale+(-Fe-1)*k.scale:zo.x+=k.imageName||Ur.width+2*Fe===Wr.w&&Ur.height+2*Fe===Wr.h?(je-To)/2:(je-(Ur.height+2*Fe)*k.scale)/2,ko=new Sa(zo.x,zo.y-yo),na=new Sa(zo.x+To,zo.y),aa=new Sa(zo.x+To,zo.y-yo)}else{const F=(Ur.left-Fe)*k.scale-pr+Qr[0],Me=(-Ur.top-Fe)*k.scale+Qr[1],Ae=F+yo,Oe=Me+To;zo=new Sa(F,Me),ko=new Sa(Ae,Me),na=new Sa(F,Oe),aa=new Sa(Ae,Oe)}if(vt){let k;k=Oe?new Sa(0,0):mo?new Sa(Ut[0],Ut[1]):new Sa(Me[0],Me[1]),zo._rotateAround(vt,k),ko._rotateAround(vt,k),na._rotateAround(vt,k),aa._rotateAround(vt,k)}const _a=new Sa(0,0),wa=new Sa(0,0);pt.push({tl:zo,tr:ko,bl:na,br:aa,texPrimary:Ae,texSecondary:void 0,writingMode:F.writingMode,glyphOffset:Jr,sectionIndex:k.sectionIndex,isSDF:xi,pixelOffsetTL:_a,pixelOffsetBR:wa,minFontScaleX:0,minFontScaleY:0})}}return pt}(0,Ae,pt,Fe,je,qe,Oe,k.allowVerticalPlacement),Jr=k.textSizeData;let Qr=null;"source"===Jr.kind?(Qr=[_y*Fe.layout.get("text-size").evaluate(qe,{},pr)*wi.textScaleFactor],Qr[0]>ux&&ft(`${k.layerIds[0]}: Value for "text-size" is >= ${cx}. Reduce your "text-size".`)):"composite"===Jr.kind&&(Qr=[_y*wi.compositeTextSizes[0].evaluate(qe,{},pr)*wi.textScaleFactor,_y*wi.compositeTextSizes[1].evaluate(qe,{},pr)*wi.textScaleFactor],(Qr[0]>ux||Qr[1]>ux)&&ft(`${k.layerIds[0]}: Value for "text-size" is >= ${cx}. Reduce your "text-size".`)),k.addSymbols(k.text,Wr,Qr,pt,je,qe,Ut,F,Me,vt.lineStartIndex,vt.lineLength,bi,Mi,pr,Ur,!1);for(const F of xi)vi[F]=k.text.placedSymbolArray.length-1;return 4*Wr.length}function gd(k){for(const F in k)return k[F];return null}function xd(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut=1){let xi=je.top/Ut,vi=je.bottom/Ut,bi=je.left/Ut,wi=je.right/Ut;const Mi=je.collisionPadding;if(Mi&&(bi-=Mi[0],xi-=Mi[1],wi+=Mi[2],vi+=Mi[3]),pt){const k=new Sa(bi,xi),F=new Sa(wi,xi),Me=new Sa(bi,vi),Ae=new Sa(wi,vi),Oe=X(pt);let Fe=new Sa(0,0);vt&&(Fe=new Sa(vt[0],vt[1])),k._rotateAround(Oe,Fe),F._rotateAround(Oe,Fe),Me._rotateAround(Oe,Fe),Ae._rotateAround(Oe,Fe),bi=Math.min(k.x,F.x,Me.x,Ae.x),wi=Math.max(k.x,F.x,Me.x,Ae.x),xi=Math.min(k.y,F.y,Me.y,Ae.y),vi=Math.max(k.y,F.y,Me.y,Ae.y)}return k.emplaceBack(F.x,F.y,F.z,Me.x,Me.y,bi,xi,wi,vi,qe,Ae,Oe,Fe),k.length-1}function vd(k){k.collisionPadding&&(k.top-=k.collisionPadding[1],k.bottom+=k.collisionPadding[3]);const F=k.bottom-k.top;return F>0?Math.max(10,F):null}function bd(k,F,Me,Ae){const Oe=k.compareText;if(F in Oe){const k=Oe[F];for(let F=k.length-1;F>=0;F--)if(Ae.dist(k[F])<Me)return!0}else Oe[F]=[];return Oe[F].push(Ae),!1}function _d(k,F){const Me=k.fovAboveCenter,Ae=k.elevation?k.elevation.getMinElevationBelowMSL()*F:0,Oe=(k._camera.position[2]*k.worldSize-Ae)/Math.cos(k._pitch),Fe=Math.sin(Me)*Oe/Math.sin(Math.max(Math.PI/2-k._pitch-Me,.01));let je=Math.sin(k._pitch)*Fe+Oe;const qe=Oe*(1/k._horizonShift);return k.elevation&&0!==k.elevation.exaggeration()||(je*=1+Math.max(k.zoom-17,0)),Math.min(1.01*je,qe)}function wd(k,F){if(!F.isReprojectedInTileSpace)return{scale:1<<k.z,x:k.x,y:k.y,x2:k.x+1,y2:k.y+1,projection:F};const Me=Math.pow(2,-k.z),Ae=k.x*Me,Oe=(k.x+1)*Me,Fe=k.y*Me,je=(k.y+1)*Me,qe=pl(Ae),pt=pl(Oe),vt=fl(Fe),Ut=fl(je),xi=F.project(qe,vt),vi=F.project(pt,vt),bi=F.project(pt,Ut),wi=F.project(qe,Ut);let Mi=Math.min(xi.x,vi.x,bi.x,wi.x),pr=Math.min(xi.y,vi.y,bi.y,wi.y),Ur=Math.max(xi.x,vi.x,bi.x,wi.x),Wr=Math.max(xi.y,vi.y,bi.y,wi.y);const Jr=Me/16;function b(k,Me,Ae,Oe,Fe,je){const qe=(Ae+Fe)/2,pt=(Oe+je)/2,vt=F.project(pl(qe),fl(pt)),Ut=Math.max(0,Mi-vt.x,pr-vt.y,vt.x-Ur,vt.y-Wr);Mi=Math.min(Mi,vt.x),Ur=Math.max(Ur,vt.x),pr=Math.min(pr,vt.y),Wr=Math.max(Wr,vt.y),Ut>Jr&&(b(k,vt,Ae,Oe,qe,pt),b(vt,Me,qe,pt,Fe,je))}b(xi,vi,Ae,Fe,Oe,Fe),b(vi,bi,Oe,Fe,Oe,je),b(bi,wi,Oe,je,Ae,je),b(wi,xi,Ae,je,Ae,Fe),Mi-=Jr,pr-=Jr,Ur+=Jr,Wr+=Jr;const Qr=1/Math.max(Ur-Mi,Wr-pr);return{scale:Qr,x:Mi*Qr,y:pr*Qr,x2:Ur*Qr,y2:Wr*Qr,projection:F}}function Md(k,{x:F,y:Me},Ae=0){return new Sa(((F-Ae)*k.scale-k.x)*Td,(Me*k.scale-k.y)*Td)}const dx=aa.mat4.identity(new Float32Array(16));class Sd{constructor(k){this.spec=k,this.name=k.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(k,F){return{x:0,y:0,z:0}}unproject(k,F){return new il(0,0)}projectTilePoint(k,F,Me){return{x:k,y:F,z:0}}locationPoint(k,F,Me=!0){return k._coordinatePoint(k.locationCoordinate(F),Me)}pixelsPerMeter(k,F){return hl(1,k)*F}pixelSpaceConversion(k,F,Me){return 1}farthestPixelDistance(k){return _d(k,k.pixelsPerMeter)}pointCoordinate(k,F,Me,Ae){const Oe=k.horizonLineFromTop(!1),Fe=new Sa(F,Math.max(Oe,Me));return k.rayIntersectionCoordinate(k.pointRayIntersection(Fe,Ae))}pointCoordinate3D(k,F,Me){const Ae=new Sa(F,Me);if(k.elevation)return k.elevation.pointCoordinate(Ae);{const F=this.pointCoordinate(k,Ae.x,Ae.y,0);return[F.x,F.y,F.z]}}isPointAboveHorizon(k,F){if(k.elevation&&k.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(k,F.x,F.y);const Me=k.horizonLineFromTop();return F.y<Me}createInversionMatrix(k,F){return dx}createTileMatrix(k,F,Me){let Ae,Oe,Fe;const je=Me.canonical,qe=aa.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const pt=wd(je,this);Ae=1,Oe=pt.x+Me.wrap*pt.scale,Fe=pt.y,aa.mat4.scale(qe,qe,[Ae/pt.scale,Ae/pt.scale,k.pixelsPerMeter/F])}else Ae=F/k.zoomScale(je.z),Oe=(je.x+Math.pow(2,je.z)*Me.wrap)*Ae,Fe=je.y*Ae;return aa.mat4.translate(qe,qe,[Oe,Fe,0]),aa.mat4.scale(qe,qe,[Ae/Td,Ae/Td,1]),qe}upVector(k,F,Me){return[0,0,1]}upVectorScale(k,F,Me){return{metersToTile:1}}}class Id extends Sd{constructor(k){super(k),this.range=[4,7],this.center=k.center||[-96,37.5];const[F,Me]=this.parallels=k.parallels||[29.5,45.5],Ae=Math.sin(X(F));this.n=(Ae+Math.sin(X(Me)))/2,this.c=1+Ae*(2*this.n-Ae),this.r0=Math.sqrt(this.c)/this.n}project(k,F){const{n:Me,c:Ae,r0:Oe}=this,Fe=X(k-this.center[0]),je=X(F),qe=Math.sqrt(Ae-2*Me*Math.sin(je))/Me;return{x:qe*Math.sin(Fe*Me),y:qe*Math.cos(Fe*Me)-Oe,z:0}}unproject(k,F){const{n:Me,c:Ae,r0:Oe}=this,Fe=Oe+F;let je=Math.atan2(k,Math.abs(Fe))*Math.sign(Fe);Fe*Me<0&&(je-=Math.PI*Math.sign(k)*Math.sign(Fe));const qe=X(this.center[0])*Me;je=et(je,-Math.PI-qe,Math.PI-qe);const pt=Q(Z(je/Me)+this.center[0],-180,180),vt=Math.asin(Q((Ae-(k*k+Fe*Fe)*Me*Me)/(2*Me),-1,1)),Ut=Q(Z(vt),-wm,wm);return new il(pt,Ut)}}const _x=1.340264,gx=-.081106,yx=893e-6,xx=.003796,bx=Math.sqrt(3)/2;class Bd extends Sd{project(k,F){F=F/180*Math.PI,k=k/180*Math.PI;const Me=Math.asin(bx*Math.sin(F)),Ae=Me*Me,Oe=Ae*Ae*Ae;return{x:.5*(k*Math.cos(Me)/(bx*(_x+3*gx*Ae+Oe*(7*yx+9*xx*Ae)))/Math.PI+.5),y:1-.5*(Me*(_x+gx*Ae+Oe*(yx+xx*Ae))/Math.PI+1),z:0}}unproject(k,F){k=(2*k-.5)*Math.PI;let Me=F=(2*(1-F)-1)*Math.PI,Ae=Me*Me,Oe=Ae*Ae*Ae;for(let k,Fe,je,qe=0;qe<12&&(Fe=Me*(_x+gx*Ae+Oe*(yx+xx*Ae))-F,je=_x+3*gx*Ae+Oe*(7*yx+9*xx*Ae),k=Fe/je,Me=Q(Me-k,-Math.PI/3,Math.PI/3),Ae=Me*Me,Oe=Ae*Ae*Ae,!(Math.abs(k)<1e-12));++qe);const Fe=bx*k*(_x+3*gx*Ae+Oe*(7*yx+9*xx*Ae))/Math.cos(Me),je=Math.asin(Math.sin(Me)/bx),qe=Q(180*Fe/Math.PI,-180,180),pt=Q(180*je/Math.PI,-wm,wm);return new il(qe,pt)}}class Vd extends Sd{constructor(k){super(k),this.wrap=!0,this.supportsWorldCopies=!0}project(k,F){return{x:.5+k/360,y:.5-F/360,z:0}}unproject(k,F){const Me=360*(k-.5),Ae=Q(360*(.5-F),-wm,wm);return new il(Me,Ae)}}const wx=Math.PI/2;function Dd(k){return Math.tan((wx+k)/2)}class Ld extends Sd{constructor(k){super(k),this.center=k.center||[0,30];const[F,Me]=this.parallels=k.parallels||[30,30];let Ae=X(F),Oe=X(Me);this.southernCenter=Ae+Oe<0,this.southernCenter&&(Ae=-Ae,Oe=-Oe);const Fe=Math.cos(Ae),je=Dd(Ae);this.n=Ae===Oe?Math.sin(Ae):Math.log(Fe/Math.cos(Oe))/Math.log(Dd(Oe)/je),this.f=Fe*Math.pow(Dd(Ae),this.n)/this.n}project(k,F){F=X(F),this.southernCenter&&(F=-F),k=X(k-this.center[0]);const Me=1e-6,{n:Ae,f:Oe}=this;Oe>0?F<-wx+Me&&(F=-wx+Me):F>wx-Me&&(F=wx-Me);const Fe=Oe/Math.pow(Dd(F),Ae);let je=Fe*Math.sin(Ae*k),qe=Oe-Fe*Math.cos(Ae*k);return je=.5*(je/Math.PI+.5),qe=.5*(qe/Math.PI+.5),{x:je,y:this.southernCenter?qe:1-qe,z:0}}unproject(k,F){k=(2*k-.5)*Math.PI,this.southernCenter&&(F=1-F),F=(2*(1-F)-.5)*Math.PI;const{n:Me,f:Ae}=this,Oe=Ae-F,Fe=Math.sign(Oe),je=Math.sign(Me)*Math.sqrt(k*k+Oe*Oe);let qe=Math.atan2(k,Math.abs(Oe))*Fe;Oe*Me<0&&(qe-=Math.PI*Math.sign(k)*Fe);const pt=Q(Z(qe/Me)+this.center[0],-180,180),vt=Q(Z(2*Math.atan(Math.pow(Ae/je,1/Me))-wx),-wm,wm);return new il(pt,this.southernCenter?-vt:vt)}}class Rd extends Sd{constructor(k){super(k),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(k,F){return{x:ul(k),y:cl(F),z:0}}unproject(k,F){const Me=pl(k),Ae=fl(F);return new il(Me,Ae)}}const Tx=X(wm);class Od extends Sd{project(k,F){const Me=(F=X(F))*F,Ae=Me*Me;return{x:.5*((k=X(k))*(.8707-.131979*Me+Ae*(Ae*(.003971*Me-.001529*Ae)-.013791))/Math.PI+.5),y:1-.5*(F*(1.007226+Me*(.015085+Ae*(.028874*Me-.044475-.005916*Ae)))/Math.PI+1),z:0}}unproject(k,F){k=(2*k-.5)*Math.PI;let Me=F=(2*(1-F)-1)*Math.PI,Ae=25,Oe=0,Fe=Me*Me;do{Fe=Me*Me;const k=Fe*Fe;Oe=(Me*(1.007226+Fe*(.015085+k*(.028874*Fe-.044475-.005916*k)))-F)/(1.007226+Fe*(.045255+k*(.259866*Fe-.311325-.005916*11*k))),Me=Q(Me-Oe,-Tx,Tx)}while(Math.abs(Oe)>1e-6&&--Ae>0);Fe=Me*Me;const je=Q(Z(k/(.8707+Fe*(Fe*(Fe*Fe*Fe*(.003971-.001529*Fe)-.013791)-.131979))),-180,180),qe=Z(Me);return new il(je,qe)}}const Mx=X(wm);class Ud extends Sd{project(k,F){F=X(F),k=X(k);const Me=Math.cos(F),Ae=2/Math.PI,Oe=Math.acos(Me*Math.cos(k/2)),Fe=Math.sin(Oe)/Oe,je=.5*(k*Ae+2*Me*Math.sin(k/2)/Fe)||0,qe=.5*(F+Math.sin(F)/Fe)||0;return{x:.5*(je/Math.PI+.5),y:1-.5*(qe/Math.PI+1),z:0}}unproject(k,F){let Me=k=(2*k-.5)*Math.PI,Ae=F=(2*(1-F)-1)*Math.PI,Oe=25;const Fe=1e-6;let je=0,qe=0;do{const Oe=Math.cos(Ae),Fe=Math.sin(Ae),pt=2*Fe*Oe,vt=Fe*Fe,Ut=Oe*Oe,xi=Math.cos(Me/2),vi=Math.sin(Me/2),bi=2*xi*vi,wi=vi*vi,Mi=1-Ut*xi*xi,pr=Mi?1/Mi:0,Ur=Mi?Math.acos(Oe*xi)*Math.sqrt(1/Mi):0,Wr=.5*(2*Ur*Oe*vi+2*Me/Math.PI)-k,Jr=.5*(Ur*Fe+Ae)-F,Qr=.5*pr*(Ut*wi+Ur*Oe*xi*vt)+1/Math.PI,co=pr*(bi*pt/4-Ur*Fe*vi),mo=.125*pr*(pt*vi-Ur*Fe*Ut*bi),yo=.5*pr*(vt*xi+Ur*wi*Oe)+.5,To=co*mo-yo*Qr;je=(Jr*co-Wr*yo)/To,qe=(Wr*mo-Jr*Qr)/To,Me=Q(Me-je,-Math.PI,Math.PI),Ae=Q(Ae-qe,-Mx,Mx)}while((Math.abs(je)>Fe||Math.abs(qe)>Fe)&&--Oe>0);return new il(Z(Me),Z(Ae))}}class jd extends Sd{constructor(k){super(k),this.center=k.center||[0,0],this.parallels=k.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(X(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(k,F){const{scale:Me,cosPhi:Ae}=this;return{x:X(k)*Ae*Me+.5,y:-Math.sin(X(F))/Ae*Me+.5,z:0}}unproject(k,F){const{scale:Me,cosPhi:Ae}=this,Oe=-(F-.5)/Me,Fe=Q(Z((k-.5)/Me)/Ae,-180,180),je=Math.asin(Q(Oe*Ae,-1,1)),qe=Q(Z(je),-wm,wm);return new il(Fe,qe)}}class qd extends Rd{constructor(k){super(k),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(k,F,Me){const Ae=ku(k,F,Me),Oe=Vu(Au(Me));return aa.vec3.transformMat4(Ae,Ae,Oe),{x:Ae[0],y:Ae[1],z:Ae[2]}}locationPoint(k,F){const Me=el(F.lat,F.lng),Ae=aa.vec3.normalize([],Me),Oe=k.elevation?k.elevation.getAtPointOrZero(k.locationCoordinate(F),k._centerAltitude):k._centerAltitude,Fe=hl(1,0)*Td*Oe;aa.vec3.scaleAndAdd(Me,Me,Ae,Fe);const je=aa.mat4.identity(new Float64Array(16));return aa.mat4.multiply(je,k.pixelMatrix,k.globeMatrix),aa.vec3.transformMat4(Me,Me,je),new Sa(Me[0],Me[1])}pixelsPerMeter(k,F){return hl(1,0)*F}pixelSpaceConversion(k,F,Me){const Ae=hl(1,k)*F,Oe=ze(hl(1,45)*F,Ae,Me);return this.pixelsPerMeter(k,F)/Oe}createTileMatrix(k,F,Me){const Ae=Cu(Au(Me.canonical));return aa.mat4.multiply(new Float64Array(16),k.globeMatrix,Ae)}createInversionMatrix(k,F){const{center:Me}=k,Ae=Vu(Au(F));return aa.mat4.rotateY(Ae,Ae,X(Me.lng)),aa.mat4.rotateX(Ae,Ae,X(Me.lat)),aa.mat4.scale(Ae,Ae,[k._pixelsPerMercatorPixel,k._pixelsPerMercatorPixel,1]),Float32Array.from(Ae)}pointCoordinate(k,F,Me,Ae){return _u(k,F,Me,!0)||new bl(0,0)}pointCoordinate3D(k,F,Me){const Ae=this.pointCoordinate(k,F,Me,0);return[Ae.x,Ae.y,Ae.z]}isPointAboveHorizon(k,F){return!_u(k,F.x,F.y,!1)}farthestPixelDistance(k){const F=function(k,F){const Me=k.cameraToCenterDistance,Ae=k._centerAltitude*F,Oe=k._camera,Fe=k._camera.forward(),je=aa.vec3.add([],aa.vec3.scale([],Fe,-Me),[0,0,Ae]),qe=k.worldSize/(2*Math.PI),pt=[0,0,-qe],vt=k.width/k.height,Ut=Math.tan(k.fovAboveCenter),xi=aa.vec3.scale([],Oe.up(),Ut),vi=aa.vec3.scale([],Oe.right(),Ut*vt),bi=aa.vec3.normalize([],aa.vec3.add([],aa.vec3.add([],Fe,xi),vi)),wi=[];let Mi;if(new hu(je,bi).closestPointOnSphere(pt,qe,wi)){const F=aa.vec3.add([],wi,pt),Me=aa.vec3.sub([],F,je);Mi=Math.cos(k.fovAboveCenter)*aa.vec3.length(Me)}else{const k=aa.vec3.sub([],je,pt),F=aa.vec3.sub([],pt,je);aa.vec3.normalize(F,F);const Me=aa.vec3.length(k)-qe;Mi=Math.sqrt(Me*(Me+2*qe));const Ae=Math.acos(Mi/(qe+Me))-Math.acos(aa.vec3.dot(Fe,F));Mi*=Math.cos(Ae)}return 1.01*Mi}(k,this.pixelsPerMeter(k.center.lat,k.worldSize)),Me=Fu(k.zoom);if(Me>0){const Ae=_d(k,hl(1,k.center.lat)*k.worldSize),Oe=k.worldSize/(2*Math.PI),Fe=Math.max(k.width,k.height)/k.worldSize*Math.PI;return ze(F,Ae+Oe*(1-Math.cos(Fe)),Math.pow(Me,10))}return F}upVector(k,F,Me){return ku(F,Me,k,1)}upVectorScale(k){return{metersToTile:vu(Tu(Au(k)))}}}function $d(k){const F=k.parallels,Me=!!F&&Math.abs(F[0]+F[1])<.01;switch(k.name){case"mercator":return new Rd(k);case"equirectangular":return new Vd(k);case"naturalEarth":return new Od(k);case"equalEarth":return new Bd(k);case"winkelTripel":return new Ud(k);case"albers":return Me?new jd(k):new Id(k);case"lambertConformalConic":return Me?new jd(k):new Ld(k);case"globe":return new qd(k)}throw new Error(`Invalid projection name: ${k.name}`)}const Ex=P_.VectorTileFeature.types,zx=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Xd(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi){const bi=qe?Math.min(ux,Math.round(qe[0])):0,wi=qe?Math.min(ux,Math.round(qe[1])):0;k.emplaceBack(F,Me,Math.round(32*Ae),Math.round(32*Oe),Fe,je,(bi<<1)+(pt?1:0),wi,16*vt,16*Ut,256*xi,256*vi)}function Zd(k,F,Me){k.emplaceBack(F,Me)}function Hd(k,F,Me,Ae,Oe,Fe,je){k.emplaceBack(F,Me,Ae,Oe,Fe,je)}function Wd(k,F,Me,Ae,Oe){k.emplaceBack(F,Me,Ae,Oe),k.emplaceBack(F,Me,Ae,Oe),k.emplaceBack(F,Me,Ae,Oe),k.emplaceBack(F,Me,Ae,Oe)}function Kd(k){for(const F of k.sections)if(ba(F.text))return!0;return!1}class Jd{constructor(k){this.layoutVertexArray=new zs,this.indexArray=new Ls,this.programConfigurations=k,this.segments=new po,this.dynamicLayoutVertexArray=new Ms,this.opacityVertexArray=new ks,this.placedSymbolArray=new to,this.iconTransitioningVertexArray=new Ts,this.globeExtVertexArray=new Es,this.zOffsetVertexArray=new Os}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(k,F,Me,Ae,Oe){this.isEmpty()||(Me&&(this.layoutVertexBuffer=k.createVertexBuffer(this.layoutVertexArray,Xg.members),this.indexBuffer=k.createIndexBuffer(this.indexArray,F),this.dynamicLayoutVertexBuffer=k.createVertexBuffer(this.dynamicLayoutVertexArray,Kg.members,!0),this.opacityVertexBuffer=k.createVertexBuffer(this.opacityVertexArray,zx,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=k.createVertexBuffer(this.iconTransitioningVertexArray,ey.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=k.createVertexBuffer(this.globeExtVertexArray,Yg.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||Oe)&&(this.zOffsetVertexBuffer=k.createVertexBuffer(this.zOffsetVertexArray,Qg.members,!0)),this.opacityVertexBuffer.itemSize=1),(Me||Ae)&&this.programConfigurations.upload(k))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}oa(Jd,"SymbolBuffers");class Qd{constructor(k,F,Me){this.layoutVertexArray=new k,this.layoutAttributes=F,this.indexArray=new Me,this.segments=new po,this.collisionVertexArray=new Ds,this.collisionVertexArrayExt=new Ms}upload(k){this.layoutVertexBuffer=k.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=k.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=k.createVertexBuffer(this.collisionVertexArray,ty.members,!0),this.collisionVertexBufferExt=k.createVertexBuffer(this.collisionVertexArrayExt,ry.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}oa(Qd,"CollisionBuffers");class tm{constructor(k){this.collisionBoxArray=k.collisionBoxArray,this.zoom=k.zoom,this.lut=k.lut,this.overscaling=k.overscaling,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.index=k.index,this.pixelRatio=k.pixelRatio,this.sourceLayerIndex=k.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=aa.mat4.identity([]),this.placementViewportMatrix=aa.mat4.identity([]);const F=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Kp(this.zoom,F["text-size"]),this.iconSizeData=Kp(this.zoom,F["icon-size"]);const Me=this.layers[0].layout,Ae=Me.get("symbol-sort-key"),Oe=Me.get("symbol-z-order");this.canOverlap=Me.get("text-allow-overlap")||Me.get("icon-allow-overlap")||Me.get("text-ignore-placement")||Me.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==Oe&&void 0!==Ae.constantOr(1),this.sortFeaturesByY=("viewport-y"===Oe||"auto"===Oe&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=Me.get("text-writing-mode").map((k=>By[k])),this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.sourceID=k.sourceID,this.projection=k.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=Me.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new Jd(new No(this.layers,{zoom:this.zoom,lut:this.lut},(k=>k.startsWith("text")||k.startsWith("symbol")))),this.icon=new Jd(new No(this.layers,{zoom:this.zoom,lut:this.lut},(k=>k.startsWith("icon")||k.startsWith("symbol")))),this.glyphOffsetArray=new no,this.lineVertexArray=new io,this.symbolInstances=new ro}calculateGlyphDependencies(k,F,Me,Ae,Oe){for(const Me of k){const k=Me.codePointAt(0);if(void 0===k)break;if(F[k]=!0,Ae&&Oe&&k<=65535){const k=Ey[Me];k&&(F[k.charCodeAt(0)]=!0)}}}updateFootprints(k,F){}updateReplacement(k,F){if(F.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=F.updateTime;const Me=F.getReplacementRegionsForTile(k.toUnwrapped(),!0);return!Ah(this.activeReplacements,Me)&&(this.activeReplacements=Me,!0)}populate(k,F,Me,Ae){const Oe=this.layers[0],Fe=Oe.layout,je="globe"===this.projection.name,qe=Fe.get("text-font"),pt=Fe.get("text-field"),vt=Fe.get("icon-image"),[Ut,xi]=Fe.get("icon-size-scale-range"),vi=Q(F.scaleFactor||1,Ut,xi),bi=("constant"!==pt.value.kind||pt.value.value instanceof Je&&!pt.value.value.isEmpty()||pt.value.value.toString().length>0)&&("constant"!==qe.value.kind||qe.value.value.length>0),wi="constant"!==vt.value.kind||!!vt.value.value||Object.keys(vt.parameters).length>0,Mi=Fe.get("symbol-sort-key");if(this.features=[],!bi&&!wi)return;const pr=F.iconDependencies,Ur=F.glyphDependencies,Wr=F.availableImages,Jr=new Va(this.zoom);for(const{feature:F,id:pt,index:vt,sourceLayerIndex:Ut}of k){const k=Oe._featureFilter.needGeometry,xi=El(F,k);if(!Oe._featureFilter.filter(Jr,xi,Me))continue;if(k||(xi.geometry=zl(F,Me,Ae)),je&&1!==F.type&&Me.z<=5){const k=xi.geometry,F=.98078528056,n=(k,Ae)=>{const Oe=ku(k.x,k.y,Me,1),Fe=ku(Ae.x,Ae.y,Me,1);return aa.vec3.dot(Oe,Fe)<F};for(let F=0;F<k.length;F++)k[F]=Al(k[F],n)}let Qr,co;if(bi){const k=Oe.getValueAndResolveTokens("text-field",xi,Me,Wr),F=Je.factory(k);Kd(F)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===ka()||this.hasRTLText&&$p.isParsed())&&(Qr=ef(F,Oe,xi))}if(wi){const k=Oe.getValueAndResolveTokens("icon-image",xi,Me,Wr);co=k instanceof tr?k:tr.build(k)}if(!Qr&&!co)continue;const mo=this.sortFeaturesByKey?Mi.evaluate(xi,{},Me):void 0,yo={id:pt,text:Qr,icon:co,index:vt,sourceLayerIndex:Ut,geometry:xi.geometry,properties:F.properties,type:Ex[F.type],sortKey:mo};if(this.features.push(yo),co){const k=Wp(this.iconSizeData,this.layers[0]._unevaluatedLayout._values["icon-size"],Me,this.zoom,yo)*vi*this.pixelRatio,F=co.getPrimary().scaleSelf(k);if(pr[F.id]=pr[F.id]||[],pr[F.id].push(F),co.nameSecondary){const F=co.getSecondary().scaleSelf(k);pr[F.id]=pr[F.id]||[],pr[F.id].push(F)}}if(Qr){const k=qe.evaluate(xi,{},Me).join(","),F="map"===Fe.get("text-rotation-alignment")&&"point"!==Fe.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(By.vertical)>=0;for(const Me of Qr.sections)if(Me.image){const k=Me.image.getPrimary().scaleSelf(this.pixelRatio);pr[k.id]=pr[k.id]||[],pr[k.id].push(k)}else{const Ae=fa(Qr.toString()),Oe=Me.fontStack||k,Fe=Ur[Oe]=Ur[Oe]||{};this.calculateGlyphDependencies(Me.text,Fe,F,this.allowVerticalPlacement,Ae)}}}"line"===Fe.get("symbol-placement")&&(this.features=function(k){const F={},Me={},Ae=[];let Oe=0;function a(F){Ae.push(k[F]),Oe++}function s(k,F,Oe){const Fe=Me[k];return delete Me[k],Me[F]=Fe,Ae[Fe].geometry[0].pop(),Ae[Fe].geometry[0]=Ae[Fe].geometry[0].concat(Oe[0]),Fe}function o(k,Me,Oe){const Fe=F[Me];return delete F[Me],F[k]=Fe,Ae[Fe].geometry[0].shift(),Ae[Fe].geometry[0]=Oe[0].concat(Ae[Fe].geometry[0]),Fe}function l(k,F,Me){const Ae=Me?F[0][F[0].length-1]:F[0][0];return`${k}:${Ae.x}:${Ae.y}`}for(let Fe=0;Fe<k.length;Fe++){const je=k[Fe],qe=je.geometry,pt=je.text?je.text.toString():null;if(!pt){a(Fe);continue}const vt=l(pt,qe),Ut=l(pt,qe,!0);if(vt in Me&&Ut in F&&Me[vt]!==F[Ut]){const k=o(vt,Ut,qe),Oe=s(vt,Ut,Ae[k].geometry);delete F[vt],delete Me[Ut],Me[l(pt,Ae[Oe].geometry,!0)]=Oe,Ae[k].geometry=null}else vt in Me?s(vt,Ut,qe):Ut in F?o(vt,Ut,qe):(a(Fe),F[vt]=Oe-1,Me[Ut]=Oe-1)}return Ae.filter((k=>k.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((k,F)=>k.sortKey-F.sortKey))}update(k,F,Me,Ae,Oe,Fe,je){this.text.programConfigurations.updatePaintArrays(k,F,Oe,Me,Ae,Fe,je),this.icon.programConfigurations.updatePaintArrays(k,F,Oe,Me,Ae,Fe,je)}updateZOffset(){const t=(F,Me,Ae)=>{k+=Me,k>F.length&&F.resize(k);for(let Oe=-Me;Oe<0;Oe++)F.emplace(Oe+k,Ae)},e=(k,Me,Ae)=>{F+=Me,F>k.length&&k.resize(F);for(let Oe=-Me;Oe<0;Oe++)k.emplace(Oe+F,Ae)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let k=0,F=0;for(let k=0;k<this.symbolInstances.length;k++){const F=this.symbolInstances.get(k),{numHorizontalGlyphVertices:Me,numVerticalGlyphVertices:Ae,numIconVertices:Oe}=F,Fe=F.zOffset,je=Oe>0;if((Me>0||Ae>0)&&(t(this.text.zOffsetVertexArray,Me,Fe),t(this.text.zOffsetVertexArray,Ae,Fe)),je){const{placedIconSymbolIndex:k,verticalPlacedIconSymbolIndex:Me}=F;k>=0&&e(this.icon.zOffsetVertexArray,Oe,Fe),Me>=0&&e(this.icon.zOffsetVertexArray,F.numVerticalIconVertices,Fe)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(k){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(k),this.iconCollisionBox.upload(k)),this.text.upload(k,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(k,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=$d(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(k,F){const Me=this.lineVertexArray.length;if(void 0!==k.segment)for(const{x:k,y:Me}of F)this.lineVertexArray.emplaceBack(k,Me);return{lineStartIndex:Me,lineLength:this.lineVertexArray.length-Me}}addSymbols(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi){const pr=k.indexArray,Ur=k.layoutVertexArray,Wr=k.globeExtVertexArray,Jr=k.segments.prepareSegment(4*F.length,Ur,pr,this.canOverlap?Fe.sortKey:void 0),Qr=this.glyphOffsetArray.length,co=Jr.vertexLength,mo=this.allowVerticalPlacement&&je===By.vertical?Math.PI/2:0,yo=Fe.text&&Fe.text.sections;for(let Ae=0;Ae<F.length;Ae++){const{tl:Oe,tr:je,bl:vt,br:Ut,texPrimary:xi,texSecondary:Qr,pixelOffsetTL:co,pixelOffsetBR:To,minFontScaleX:zo,minFontScaleY:ko,glyphOffset:na,isSDF:aa,sectionIndex:_a}=F[Ae],wa=Jr.vertexLength,Sa=na[1];if(Xd(Ur,pt.x,pt.y,Oe.x,Sa+Oe.y,xi.x,xi.y,Me,aa,co.x,co.y,zo,ko),Xd(Ur,pt.x,pt.y,je.x,Sa+je.y,xi.x+xi.w,xi.y,Me,aa,To.x,co.y,zo,ko),Xd(Ur,pt.x,pt.y,vt.x,Sa+vt.y,xi.x,xi.y+xi.h,Me,aa,co.x,To.y,zo,ko),Xd(Ur,pt.x,pt.y,Ut.x,Sa+Ut.y,xi.x+xi.w,xi.y+xi.h,Me,aa,To.x,To.y,zo,ko),qe){const{x:F,y:Me,z:Ae}=qe.anchor,[Oe,Fe,je]=qe.up;Hd(Wr,F,Me,Ae,Oe,Fe,je),Hd(Wr,F,Me,Ae,Oe,Fe,je),Hd(Wr,F,Me,Ae,Oe,Fe,je),Hd(Wr,F,Me,Ae,Oe,Fe,je),Wd(k.dynamicLayoutVertexArray,F,Me,Ae,mo)}else Wd(k.dynamicLayoutVertexArray,pt.x,pt.y,pt.z,mo);if(Mi){const F=Qr||xi;Zd(k.iconTransitioningVertexArray,F.x,F.y),Zd(k.iconTransitioningVertexArray,F.x+F.w,F.y),Zd(k.iconTransitioningVertexArray,F.x,F.y+F.h),Zd(k.iconTransitioningVertexArray,F.x+F.w,F.y+F.h)}pr.emplaceBack(wa,wa+1,wa+2),pr.emplaceBack(wa+1,wa+2,wa+3),Jr.vertexLength+=4,Jr.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(na[0]),Ae!==F.length-1&&_a===F[Ae+1].sectionIndex||k.programConfigurations.populatePaintArrays(Ur.length,Fe,Fe.index,{},vi,bi,wi,yo&&yo[_a])}const To=qe?qe.anchor:pt;k.placedSymbolArray.emplaceBack(To.x,To.y,To.z,pt.x,pt.y,Qr,this.glyphOffsetArray.length-Qr,co,vt,Ut,pt.segment,Me?Me[0]:0,Me?Me[1]:0,Ae[0],Ae[1],je,0,!1,0,xi,0)}_commitLayoutVertex(k,F,Me,Ae,Oe,Fe,je){k.emplaceBack(F,Me,Ae,Oe,Fe,Math.round(je.x),Math.round(je.y))}_addCollisionDebugVertices(k,F,Me,Ae,Oe,Fe,je){const qe=Me.segments.prepareSegment(4,Me.layoutVertexArray,Me.indexArray),pt=qe.vertexLength,vt=je.tileAnchorX,Ut=je.tileAnchorY;for(let k=0;k<4;k++)Me.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(Me.collisionVertexArrayExt,F,k.padding,je.zOffset),this._commitLayoutVertex(Me.layoutVertexArray,Ae,Oe,Fe,vt,Ut,new Sa(k.x1,k.y1)),this._commitLayoutVertex(Me.layoutVertexArray,Ae,Oe,Fe,vt,Ut,new Sa(k.x2,k.y1)),this._commitLayoutVertex(Me.layoutVertexArray,Ae,Oe,Fe,vt,Ut,new Sa(k.x2,k.y2)),this._commitLayoutVertex(Me.layoutVertexArray,Ae,Oe,Fe,vt,Ut,new Sa(k.x1,k.y2)),qe.vertexLength+=4;const xi=Me.indexArray;xi.emplaceBack(pt,pt+1),xi.emplaceBack(pt+1,pt+2),xi.emplaceBack(pt+2,pt+3),xi.emplaceBack(pt+3,pt),qe.primitiveLength+=4}_addTextDebugCollisionBoxes(k,F,Me,Ae,Oe,Fe){for(let je=Ae;je<Oe;je++){const Ae=Me.get(je),Oe=this.getSymbolInstanceTextSize(k,Fe,F,je);this._addCollisionDebugVertices(Ae,Oe,this.textCollisionBox,Ae.projectedAnchorX,Ae.projectedAnchorY,Ae.projectedAnchorZ,Fe)}}_addIconDebugCollisionBoxes(k,F,Me,Ae,Oe,Fe){for(let je=Ae;je<Oe;je++){const Ae=Me.get(je),Oe=this.getSymbolInstanceIconSize(k,F,Fe.placedIconSymbolIndex);this._addCollisionDebugVertices(Ae,Oe,this.iconCollisionBox,Ae.projectedAnchorX,Ae.projectedAnchorY,Ae.projectedAnchorZ,Fe)}}generateCollisionDebugBuffers(k,F,Me){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Qd(Vs,cy.members,Ts),this.iconCollisionBox=new Qd(Vs,cy.members,Ts);const Ae=Qp(this.iconSizeData,k),Oe=Qp(this.textSizeData,k,Me);for(let Me=0;Me<this.symbolInstances.length;Me++){const Fe=this.symbolInstances.get(Me);this._addTextDebugCollisionBoxes(Oe,k,F,Fe.textBoxStartIndex,Fe.textBoxEndIndex,Fe),this._addTextDebugCollisionBoxes(Oe,k,F,Fe.verticalTextBoxStartIndex,Fe.verticalTextBoxEndIndex,Fe),this._addIconDebugCollisionBoxes(Ae,k,F,Fe.iconBoxStartIndex,Fe.iconBoxEndIndex,Fe),this._addIconDebugCollisionBoxes(Ae,k,F,Fe.verticalIconBoxStartIndex,Fe.verticalIconBoxEndIndex,Fe)}}getSymbolInstanceTextSize(k,F,Me,Ae){const Oe=this.text.placedSymbolArray.get(F.rightJustifiedTextSymbolIndex>=0?F.rightJustifiedTextSymbolIndex:F.centerJustifiedTextSymbolIndex>=0?F.centerJustifiedTextSymbolIndex:F.leftJustifiedTextSymbolIndex>=0?F.leftJustifiedTextSymbolIndex:F.verticalPlacedTextSymbolIndex>=0?F.verticalPlacedTextSymbolIndex:Ae),Fe=Jp(this.textSizeData,k,Oe)/dy;return this.tilePixelRatio*Fe}getSymbolInstanceIconSize(k,F,Me){const Ae=this.icon.placedSymbolArray.get(Me),Oe=Jp(this.iconSizeData,k,Ae);return this.tilePixelRatio*Oe}_commitDebugCollisionVertexUpdate(k,F,Me,Ae){k.emplaceBack(F,-Me,-Me,Ae),k.emplaceBack(F,Me,-Me,Ae),k.emplaceBack(F,Me,Me,Ae),k.emplaceBack(F,-Me,Me,Ae)}_updateTextDebugCollisionBoxes(k,F,Me,Ae,Oe,Fe,je){for(let je=Ae;je<Oe;je++){const Ae=Me.get(je),Oe=this.getSymbolInstanceTextSize(k,Fe,F,je);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,Oe,Ae.padding,Fe.zOffset)}}_updateIconDebugCollisionBoxes(k,F,Me,Ae,Oe,Fe,je){for(let je=Ae;je<Oe;je++){const Ae=Me.get(je),Oe=this.getSymbolInstanceIconSize(k,F,Fe.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,Oe,Ae.padding,Fe.zOffset)}}updateCollisionDebugBuffers(k,F,Me,Ae){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const Oe=Qp(this.iconSizeData,k,Ae),Fe=Qp(this.textSizeData,k,Me);for(let je=0;je<this.symbolInstances.length;je++){const qe=this.symbolInstances.get(je);this._updateTextDebugCollisionBoxes(Fe,k,F,qe.textBoxStartIndex,qe.textBoxEndIndex,qe,Me),this._updateTextDebugCollisionBoxes(Fe,k,F,qe.verticalTextBoxStartIndex,qe.verticalTextBoxEndIndex,qe,Me),this._updateIconDebugCollisionBoxes(Oe,k,F,qe.iconBoxStartIndex,qe.iconBoxEndIndex,qe,Ae),this._updateIconDebugCollisionBoxes(Oe,k,F,qe.verticalIconBoxStartIndex,qe.verticalIconBoxEndIndex,qe,Ae)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt={};if(F<Me){const{x1:Me,y1:Ae,x2:Oe,y2:Fe,padding:je,projectedAnchorX:qe,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi,featureIndex:bi}=k.get(F);vt.textBox={x1:Me,y1:Ae,x2:Oe,y2:Fe,padding:je,projectedAnchorX:qe,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi},vt.textFeatureIndex=bi}if(Ae<Oe){const{x1:F,y1:Me,x2:Oe,y2:Fe,padding:je,projectedAnchorX:qe,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi,featureIndex:bi}=k.get(Ae);vt.verticalTextBox={x1:F,y1:Me,x2:Oe,y2:Fe,padding:je,projectedAnchorX:qe,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi},vt.verticalTextFeatureIndex=bi}if(Fe<je){const{x1:F,y1:Me,x2:Ae,y2:Oe,padding:je,projectedAnchorX:qe,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi,featureIndex:bi}=k.get(Fe);vt.iconBox={x1:F,y1:Me,x2:Ae,y2:Oe,padding:je,projectedAnchorX:qe,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi},vt.iconFeatureIndex=bi}if(qe<pt){const{x1:F,y1:Me,x2:Ae,y2:Oe,padding:Fe,projectedAnchorX:je,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi,featureIndex:bi}=k.get(qe);vt.verticalIconBox={x1:F,y1:Me,x2:Ae,y2:Oe,padding:Fe,projectedAnchorX:je,projectedAnchorY:pt,projectedAnchorZ:Ut,tileAnchorX:xi,tileAnchorY:vi},vt.verticalIconFeatureIndex=bi}return vt}deserializeCollisionBoxes(k){this.collisionArrays=[];for(let F=0;F<this.symbolInstances.length;F++){const Me=this.symbolInstances.get(F);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(k,Me.textBoxStartIndex,Me.textBoxEndIndex,Me.verticalTextBoxStartIndex,Me.verticalTextBoxEndIndex,Me.iconBoxStartIndex,Me.iconBoxEndIndex,Me.verticalIconBoxStartIndex,Me.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(k,F){const Me=k.placedSymbolArray.get(F),Ae=Me.vertexStartIndex+4*Me.numGlyphs;for(let F=Me.vertexStartIndex;F<Ae;F+=4)k.indexArray.emplaceBack(F,F+1,F+2),k.indexArray.emplaceBack(F+1,F+2,F+3)}getSortedSymbolIndexes(k){if(this.sortedAngle===k&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const F=Math.sin(k),Me=Math.cos(k),Ae=[],Oe=[],Fe=[];for(let k=0;k<this.symbolInstances.length;++k){Fe.push(k);const je=this.symbolInstances.get(k);Ae.push(0|Math.round(F*je.tileAnchorX+Me*je.tileAnchorY)),Oe.push(je.featureIndex)}return Fe.sort(((k,F)=>Ae[k]-Ae[F]||Oe[F]-Oe[k])),Fe}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let k=0;k<this.symbolInstances.length;++k)this.symbolInstanceIndexesSortedZOffset.push(k)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((k,F)=>this.symbolInstances.get(F).zOffset-this.symbolInstances.get(k).zOffset))}addToSortKeyRanges(k,F){const Me=this.sortKeyRanges[this.sortKeyRanges.length-1];Me&&Me.sortKey===F?Me.symbolInstanceEnd=k+1:this.sortKeyRanges.push({sortKey:F,symbolInstanceStart:k,symbolInstanceEnd:k+1})}sortFeatures(k){if(this.sortFeaturesByY&&this.sortedAngle!==k&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(k),this.sortedAngle=k,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const k of this.symbolInstanceIndexes){const F=this.symbolInstances.get(k);this.featureSortOrder.push(F.featureIndex);const{rightJustifiedTextSymbolIndex:Me,centerJustifiedTextSymbolIndex:Ae,leftJustifiedTextSymbolIndex:Oe,verticalPlacedTextSymbolIndex:Fe,placedIconSymbolIndex:je,verticalPlacedIconSymbolIndex:qe}=F;Me>=0&&this.addIndicesForPlacedSymbol(this.text,Me),Ae>=0&&Ae!==Me&&this.addIndicesForPlacedSymbol(this.text,Ae),Oe>=0&&Oe!==Ae&&Oe!==Me&&this.addIndicesForPlacedSymbol(this.text,Oe),Fe>=0&&this.addIndicesForPlacedSymbol(this.text,Fe),je>=0&&this.addIndicesForPlacedSymbol(this.icon,je),qe>=0&&this.addIndicesForPlacedSymbol(this.icon,qe)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Px,Dx,Rx;oa(tm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),tm.addDynamicAttributes=Wd;class im{constructor(k){this.type=k.property.overrides?k.property.overrides.runtimeType:ou,this.defaultValue=k}evaluate(k){if(k.formattedSection){const F=this.defaultValue.property.overrides;if(F&&F.hasOverride(k.formattedSection))return F.getOverride(k.formattedSection)}return k.feature&&k.featureState?this.defaultValue.evaluate(k.feature,k.featureState):this.defaultValue.property.specification.default}eachChild(k){this.defaultValue.isConstant()||k(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}oa(im,"FormatSectionOverride",{omit:["defaultValue"]});const am=()=>Rx||(Rx={layout:Px||(Px=new Ga({"symbol-placement":new ja(Xp.layout_symbol["symbol-placement"]),"symbol-spacing":new ja(Xp.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ja(Xp.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new qa(Xp.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ja(Xp.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ja(Xp.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ja(Xp.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ja(Xp.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ja(Xp.layout_symbol["icon-ignore-placement"]),"icon-optional":new ja(Xp.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ja(Xp.layout_symbol["icon-rotation-alignment"]),"icon-size":new qa(Xp.layout_symbol["icon-size"]),"icon-size-scale-range":new ja(Xp.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new qa(Xp.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new qa(Xp.layout_symbol["icon-text-fit-padding"]),"icon-image":new qa(Xp.layout_symbol["icon-image"]),"icon-rotate":new qa(Xp.layout_symbol["icon-rotate"]),"icon-padding":new ja(Xp.layout_symbol["icon-padding"]),"icon-keep-upright":new ja(Xp.layout_symbol["icon-keep-upright"]),"icon-offset":new qa(Xp.layout_symbol["icon-offset"]),"icon-anchor":new qa(Xp.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ja(Xp.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ja(Xp.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ja(Xp.layout_symbol["text-rotation-alignment"]),"text-field":new qa(Xp.layout_symbol["text-field"]),"text-font":new qa(Xp.layout_symbol["text-font"]),"text-size":new qa(Xp.layout_symbol["text-size"]),"text-size-scale-range":new ja(Xp.layout_symbol["text-size-scale-range"]),"text-max-width":new qa(Xp.layout_symbol["text-max-width"]),"text-line-height":new qa(Xp.layout_symbol["text-line-height"]),"text-letter-spacing":new qa(Xp.layout_symbol["text-letter-spacing"]),"text-justify":new qa(Xp.layout_symbol["text-justify"]),"text-radial-offset":new qa(Xp.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ja(Xp.layout_symbol["text-variable-anchor"]),"text-anchor":new qa(Xp.layout_symbol["text-anchor"]),"text-max-angle":new ja(Xp.layout_symbol["text-max-angle"]),"text-writing-mode":new ja(Xp.layout_symbol["text-writing-mode"]),"text-rotate":new qa(Xp.layout_symbol["text-rotate"]),"text-padding":new ja(Xp.layout_symbol["text-padding"]),"text-keep-upright":new ja(Xp.layout_symbol["text-keep-upright"]),"text-transform":new qa(Xp.layout_symbol["text-transform"]),"text-offset":new qa(Xp.layout_symbol["text-offset"]),"text-allow-overlap":new ja(Xp.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ja(Xp.layout_symbol["text-ignore-placement"]),"text-optional":new ja(Xp.layout_symbol["text-optional"]),visibility:new ja(Xp.layout_symbol.visibility)})),paint:Dx||(Dx=new Ga({"icon-opacity":new qa(Xp.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new qa(Xp.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new qa(Xp.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new qa(Xp.paint_symbol["text-emissive-strength"]),"icon-color":new qa(Xp.paint_symbol["icon-color"]),"icon-halo-color":new qa(Xp.paint_symbol["icon-halo-color"]),"icon-halo-width":new qa(Xp.paint_symbol["icon-halo-width"]),"icon-halo-blur":new qa(Xp.paint_symbol["icon-halo-blur"]),"icon-translate":new ja(Xp.paint_symbol["icon-translate"]),"icon-translate-anchor":new ja(Xp.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new qa(Xp.paint_symbol["icon-image-cross-fade"]),"text-opacity":new qa(Xp.paint_symbol["text-opacity"]),"text-occlusion-opacity":new qa(Xp.paint_symbol["text-occlusion-opacity"]),"text-color":new qa(Xp.paint_symbol["text-color"],{runtimeType:uu,getOverride:k=>k.textColor,hasOverride:k=>!!k.textColor}),"text-halo-color":new qa(Xp.paint_symbol["text-halo-color"]),"text-halo-width":new qa(Xp.paint_symbol["text-halo-width"]),"text-halo-blur":new qa(Xp.paint_symbol["text-halo-blur"]),"text-translate":new ja(Xp.paint_symbol["text-translate"]),"text-translate-anchor":new ja(Xp.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ja(Xp.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ja(Xp.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ja(Xp.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ja(Xp.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new qa(Xp.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Rx);class sm extends ps{constructor(k,F,Me,Ae){super(k,am(),F,Me,Ae),this._colorAdjustmentMatrix=aa.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==k.paint&&("icon-occlusion-opacity"in k.paint||"text-occlusion-opacity"in k.paint)}recalculate(k,F){super.recalculate(k,F),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const Me=this.layout.get("text-writing-mode");if(Me){const k=[];for(const F of Me)k.indexOf(F)<0&&k.push(F);this.layout._values["text-writing-mode"]=k}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(k,F,Me,Ae){return this._saturation===k&&this._contrast===F&&this._brightnessMin===Me&&this._brightnessMax===Ae||(this._colorAdjustmentMatrix=function(k,F,Me,Ae){k=At(k),F=Mt(F);const Oe=aa.mat4.create(),Fe=k/3,je=1-2*Fe,qe=[je,Fe,Fe,0,Fe,je,Fe,0,Fe,Fe,je,0,0,0,0,1],pt=.5-.5*F,vt=Ae-Me;return aa.mat4.multiply(Oe,[vt,0,0,0,0,vt,0,0,0,0,vt,0,Me,Me,Me,1],[F,0,0,0,0,F,0,0,0,0,F,0,pt,pt,pt,1]),aa.mat4.multiply(Oe,Oe,qe),Oe}(k,F,Me,Ae),this._saturation=k,this._contrast=F,this._brightnessMin=Me,this._brightnessMax=Ae),this._colorAdjustmentMatrix}getValueAndResolveTokens(k,F,Me,Ae){const Oe=this.layout.get(k).evaluate(F,{},Me,Ae),Fe=this._unevaluatedLayout._values[k];return Fe.isDataDriven()||Hi(Fe.value)||!Oe?Oe:function(k,F){return F.replace(/{([^{}]+)}/g,((F,Me)=>Me in k?String(k[Me]):""))}(F.properties,Oe)}createBucket(k){return new tm(k)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const k of am().paint.overridableProperties){if(!sm.hasPaintOverride(this.layout,k))continue;const F=this.paint.get(k),Me=new im(F),Ae=new Zi(Me,F.property.specification,this.scope,this.options);let Oe=null;Oe="constant"===F.value.kind||"source"===F.value.kind?new Ki("source",Ae):new Ji("composite",Ae,F.value.zoomStops,F.value._interpolationType),this.paint._values[k]=new Na(F.property,Oe,F.parameters)}}_handleOverridablePaintPropertyUpdate(k,F,Me){return!(!this.layout||F.isDataDriven()||Me.isDataDriven())&&sm.hasPaintOverride(this.layout,k)}static hasPaintOverride(k,F){const Me=k.get("text-field"),Ae=am().paint.properties[F];let Oe=!1;const a=k=>{for(const F of k)if(Ae.overrides&&Ae.overrides.hasOverride(F))return void(Oe=!0)};if("constant"===Me.value.kind&&Me.value.value instanceof Je)a(Me.value.value.sections);else if("source"===Me.value.kind){const t=k=>{Oe||(k instanceof ar&&nr(k.value)===ju?a(k.value.sections):k instanceof ur?a(k.sections):k.eachChild(t))},k=Me.value;k._styleExpression&&t(k._styleExpression.expression)}return Oe}getProgramIds(){return["symbol"]}getDefaultProgramParams(k,F,Me){return{config:new Oo(this,{zoom:F,lut:Me}),overrideFog:!1}}}let Lx,Ox,kx,Bx;var Ux=ys([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function pm(k){switch(k){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function fm(k){switch(k){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class dm{constructor(k,F,Me,Ae){this.context=k,this.format=Me,this.useMipmap=Ae&&Ae.useMipmap,this.texture=k.gl.createTexture(),this.update(F,{premultiply:Ae&&Ae.premultiply})}update(k,F){const Me=k&&k instanceof HTMLVideoElement&&0===k.width?k.videoWidth:k.width,Ae=k&&k instanceof HTMLVideoElement&&0===k.height?k.videoHeight:k.height,{context:Oe}=this,{gl:Fe}=Oe,{x:je,y:qe}=F&&F.position?F.position:{x:0,y:0},pt=je+Me,vt=qe+Ae;!this.size||this.size[0]===pt&&this.size[1]===vt||(Fe.bindTexture(Fe.TEXTURE_2D,null),Fe.deleteTexture(this.texture),this.texture=Fe.createTexture(),this.size=null),Fe.bindTexture(Fe.TEXTURE_2D,this.texture),Oe.pixelStoreUnpackFlipY.set(!1),Oe.pixelStoreUnpack.set(1),Oe.pixelStoreUnpackPremultiplyAlpha.set(this.format===Fe.RGBA8&&(!F||!1!==F.premultiply));const Ut=k instanceof HTMLImageElement||k instanceof HTMLCanvasElement||k instanceof HTMLVideoElement||k instanceof ImageData||ImageBitmap&&k instanceof ImageBitmap;if(!this.size&&pt>0&&vt>0){const k=this.useMipmap?Math.floor(Math.log2(Math.max(pt,vt)))+1:1;Fe.texStorage2D(Fe.TEXTURE_2D,k,this.format,pt,vt),this.size=[pt,vt]}if(this.size)if(Ut)Fe.texSubImage2D(Fe.TEXTURE_2D,0,je,qe,pm(this.format),fm(this.format),k);else{const F=k.data;F&&Fe.texSubImage2D(Fe.TEXTURE_2D,0,je,qe,Me,Ae,pm(this.format),fm(this.format),F)}this.useMipmap&&Fe.generateMipmap(Fe.TEXTURE_2D)}bind(k,F,Me=!1){const{context:Ae}=this,{gl:Oe}=Ae;Oe.bindTexture(Oe.TEXTURE_2D,this.texture),k!==this.minFilter&&(Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_MAG_FILTER,k),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_MIN_FILTER,this.useMipmap&&!Me?k===Oe.NEAREST?Oe.NEAREST_MIPMAP_NEAREST:Oe.LINEAR_MIPMAP_LINEAR:k),this.minFilter=k),F!==this.wrapS&&(Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_WRAP_S,F),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_WRAP_T,F),this.wrapS=F)}bindExtraParam(k,F,Me,Ae){const{context:Oe}=this,{gl:Fe}=Oe;Fe.bindTexture(Fe.TEXTURE_2D,this.texture),F!==this.magFilter&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MAG_FILTER,F),this.magFilter=F),k!==this.minFilter&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MIN_FILTER,this.useMipmap?k===Fe.NEAREST?Fe.NEAREST_MIPMAP_NEAREST:Fe.LINEAR_MIPMAP_LINEAR:k),this.minFilter=k),Me!==this.wrapS&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_S,Me),this.wrapS=Me),Ae!==this.wrapT&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_T,Ae),this.wrapT=Ae)}destroy(){const{gl:k}=this.context;k.deleteTexture(this.texture),this.texture=null}}class mm{constructor(k,F){this.context=k,this.texture=F}bind(k,F){const{context:Me}=this,{gl:Ae}=Me;Ae.bindTexture(Ae.TEXTURE_2D,this.texture),k!==this.minFilter&&(Ae.texParameteri(Ae.TEXTURE_2D,Ae.TEXTURE_MAG_FILTER,k),Ae.texParameteri(Ae.TEXTURE_2D,Ae.TEXTURE_MIN_FILTER,k),this.minFilter=k),F!==this.wrapS&&(Ae.texParameteri(Ae.TEXTURE_2D,Ae.TEXTURE_WRAP_S,F),Ae.texParameteri(Ae.TEXTURE_2D,Ae.TEXTURE_WRAP_T,F),this.wrapS=F)}}function ym(k,F,Me,Ae,Oe,Fe,je,qe){const pt=[k,F,1,Me,Ae,1,Oe,Fe,1],vt=[je,qe,1],Ut=aa.mat3.adjoint([],pt),[xi,vi,bi]=aa.vec3.transformMat3(vt,vt,Ut);return aa.mat3.multiply(pt,pt,[xi,0,0,0,vi,0,0,0,bi])}function gm(k,F,Me,Ae,Oe,Fe,je,qe){const pt=function(k,F,Me,Ae,Oe,Fe,je,qe){const pt=ym(0,0,1,0,1,1,0,1),vt=ym(k,F,Me,Ae,Oe,Fe,je,qe),Ut=aa.mat3.adjoint([],pt);return aa.mat3.multiply(vt,vt,Ut)}(k,F,Me,Ae,Oe,Fe,je,qe);return[pt[2]/pt[8]/Td,pt[5]/pt[8]/Td]}function xm(k){return[k[0],Math.min(Math.max(k[1],-wm),wm)]}class vm extends we{constructor(k,F,Me,Ae){super(),this.id=k,this.dispatcher=Me,this.coordinates=F.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(Ae),this.options=F,this._dirty=!1}load(k,F){if(this._loaded=F||!1,this.fire(new xe("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return k&&(this.coordinates=k),this._loaded=!0,void this._finishLoading();this._imageRequest=ue(this.map._requestManager.transformRequest(this.url,sh.Image),((F,Me)=>{this._imageRequest=null,this._loaded=!0,F?this.fire(new ve(F)):Me&&(this.image=Me instanceof HTMLImageElement?Gc.getImageData(Me):Me,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,k&&(this.coordinates=k),this._finishLoading())}))}loaded(){return this._loaded}updateImage(k){return k.url?(this._imageRequest&&k.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=k.url,this.load(k.coordinates,this._loaded),this):this}setTexture(k){if(!(k.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new mm(this.map.painter.context,k.handle),this.width=k.dimensions[0],this.height=k.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new xe("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(k){this.map=k,this.load()}onRemove(k){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof mm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(k){if(this.coordinates=k,this._boundsArray=void 0,this._unsupportedCoords=!1,!k.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let F=k[0][1],Me=k[0][1];for(const Ae of k)Ae[1]>Me&&(Me=Ae[1]),Ae[1]<F&&(F=Ae[1]);const Ae=(Me+F)/2;if(Ae>wm?this.onNorthPole=!0:Ae<-wm&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const F=k.map(bl.fromLngLat);this.tileID=function(k){let F=1/0,Me=1/0,Ae=-1/0,Oe=-1/0;for(const Fe of k)F=Math.min(F,Fe.x),Me=Math.min(Me,Fe.y),Ae=Math.max(Ae,Fe.x),Oe=Math.max(Oe,Fe.y);const Fe=Math.max(Ae-F,Oe-Me),je=Math.max(0,Math.floor(-Math.log(Fe)/Math.LN2)),qe=Math.pow(2,je);let pt=Math.floor((F+Ae)/2*qe);return pt>1&&(pt-=1),new ru(je,pt,Math.floor((Me+Oe)/2*qe))}(F),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new xe("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(k){for(const k in this.tiles){const F=this.tiles[k];"loaded"!==F.state&&(F.state="loaded",F.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const F=wd(new ru(0,0,0),this.map.transform.projection),Me=[F.projection.project(this.coordinates[0][0],this.coordinates[0][1]),F.projection.project(this.coordinates[1][0],this.coordinates[1][1]),F.projection.project(this.coordinates[2][0],this.coordinates[2][1]),F.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(k){const F=k[1].x-k[0].x,Me=k[1].y-k[0].y,Ae=k[2].x-k[1].x,Oe=k[2].y-k[1].y,Fe=k[3].x-k[2].x,je=k[3].y-k[2].y,qe=k[0].x-k[3].x,pt=k[0].y-k[3].y,vt=F*Oe-Ae*Me,Ut=Ae*je-Fe*Oe,xi=Fe*pt-qe*je,vi=qe*Me-F*pt;return vt>0&&Ut>0&&xi>0&&vi>0||vt<0&&Ut<0&&xi<0&&vi<0}(Me))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const Ae=wd(this.tileID,this.map.transform.projection),[Oe,Fe,je,qe]=this.coordinates.map((k=>{const F=Ae.projection.project(k[0],k[1]);return Md(Ae,F)._round()}));this.perspectiveTransform=gm(Oe.x,Oe.y,Fe.x,Fe.y,je.x,je.y,qe.x,qe.y);const pt=this._boundsArray=new bs;pt.emplaceBack(Oe.x,Oe.y,0,0),pt.emplaceBack(Fe.x,Fe.y,Td,0),pt.emplaceBack(qe.x,qe.y,0,Td),pt.emplaceBack(je.x,je.y,Td,Td),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=k.createVertexBuffer(pt,Ux.members),this.boundsSegments=po.simpleSegment(0,0,4,2);const vt=[],Ut=[xm((xi=this.coordinates)[0]),xm(xi[1]),xm(xi[2]),xm(xi[3])];var xi;const[vi,bi,wi,Mi]=function(k){let F=k[0][0],Me=F,Ae=k[0][1],Oe=Ae;for(let Fe=1;Fe<k.length;Fe++)k[Fe][0]<F?F=k[Fe][0]:k[Fe][0]>Me&&(Me=k[Fe][0]),k[Fe][1]<Ae?Ae=k[Fe][1]:k[Fe][1]>Oe&&(Oe=k[Fe][1]);return[F,Ae,Me-F,Oe-Ae]}(Ut);{const Ae=new bs,[Oe,Fe,je,qe]=function(k){let F=k[0].x,Me=F,Ae=k[0].y,Oe=Ae;for(let Fe=1;Fe<k.length;Fe++)k[Fe].x<F?F=k[Fe].x:k[Fe].x>Me&&(Me=k[Fe].x),k[Fe].y<Ae?Ae=k[Fe].y:k[Fe].y>Oe&&(Oe=k[Fe].y);return[F,Ae,Me-F,Oe-Ae]}(Me),l=k=>[(k.x-Oe)/je,(k.y-Fe)/qe],[pt,Ut,xi,pr]=Me.map(l),Ur=function(k,F,Me,Ae,Oe,Fe,je,qe){const pt=ym(0,0,1,0,1,1,0,1),vt=ym(k,F,Me,Ae,Oe,Fe,je,qe),Ut=aa.mat3.adjoint([],vt);return aa.mat3.multiply(pt,pt,Ut)}(pt[0],pt[1],Ut[0],Ut[1],xi[0],xi[1],pr[0],pr[1]);this.elevatedGlobePerspectiveTransform=gm(pt[0],pt[1],Ut[0],Ut[1],xi[0],xi[1],pr[0],pr[1]);const v=(k,F)=>{vt.push(k.lng);const Me=Math.round((k.lng-vi)/wi*Td),Oe=Math.round((k.lat-bi)/Mi*Td),Fe=l(F),je=aa.vec3.transformMat3([],[Fe[0],Fe[1],1],Ur),qe=Math.round(je[0]/je[2]*Td),pt=Math.round(je[1]/je[2]*Td);Ae.emplaceBack(Me,Oe,qe,pt)},Wr=Me[3].x-Me[0].x,Jr=Me[3].y-Me[0].y,Qr=Me[2].x-Me[1].x,co=Me[2].y-Me[1].y;for(let k=0;k<65;k++){const Ae=k/64,Oe=[Me[0].x+Ae*Wr,Me[0].y+Ae*Jr],Fe=[Me[1].x+Ae*Qr,Me[1].y+Ae*co],je=Fe[0]-Oe[0],qe=Fe[1]-Oe[1];for(let k=0;k<65;k++){const Me=k/64,Ae={x:Oe[0]+je*Me,y:Oe[1]+qe*Me,z:0};v(F.projection.unproject(Ae.x,Ae.y),Ae)}}this.elevatedGlobeVertexBuffer=k.createVertexBuffer(Ae,Ux.members)}{this.maxLongitudeTriangleSize=0;let F=[],Me=new Ls;const n=(k,Ae,Oe)=>{Me.emplaceBack(k,Ae,Oe);const Fe=vt[k],je=vt[Ae],qe=vt[Oe],pt=Math.min(Math.min(Fe,je),qe),Ut=Math.max(Math.max(Fe,je),qe)-pt;Ut>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ut),F.push(pt+Ut/2)};for(let k=0;k<64;k++)for(let F=0;F<64;F++){const Me=65*k+F,Ae=Me+1,Oe=Me+65,Fe=Oe+1;n(Me,Oe,Ae),n(Ae,Oe,Fe)}[F,Me]=function(k,F){const Me=Array.from({length:k.length},((k,F)=>F));Me.sort(((F,Me)=>k[F]-k[Me]));const Ae=[],Oe=new Ls;for(let Fe=0;Fe<Me.length;Fe++){const je=Me[Fe];Ae.push(k[je]);const qe=3*je,pt=qe+1;Oe.emplaceBack(F.uint16[qe],F.uint16[pt],F.uint16[pt+1])}return[Ae,Oe]}(F,Me),this.elevatedGlobeTrianglesCenterLongitudes=F,this.elevatedGlobeIndexBuffer=k.createIndexBuffer(Me)}this.elevatedGlobeSegments=po.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,wi/Td,0,Mi/Td,0,0,bi,vi,0])}prepare(){const k=0!==Object.keys(this.tiles).length;if(this.tileID&&!k)return;const F=this.map.painter.context,Me=F.gl;!this._dirty||this.texture instanceof mm||(this.texture?this.texture.update(this.image):(this.texture=new dm(F,this.image,Me.RGBA8),this.texture.bind(Me.LINEAR,Me.CLAMP_TO_EDGE)),this._dirty=!1),k&&this._prepareData(F)}loadTile(k,F){this.tileID&&this.tileID.equals(k.tileID.canonical)?(this.tiles[String(k.tileID.wrap)]=k,k.buckets={},F(null)):(k.state="errored",F(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(k){const F=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!F)return null;const Me=this.elevatedGlobeTrianglesCenterLongitudes;let Ae=(Oe=k+180)+360*Math.round((Me[0]-Oe)/360);var Oe;const Fe=new po,s=(k,Me)=>{Fe.segments.push({vertexOffset:0,primitiveOffset:k,vertexLength:F.segments[0].vertexLength,primitiveLength:Me,sortKey:void 0,vaos:{}})},je=.51*this.maxLongitudeTriangleSize;if(Math.abs(Me[0]-Ae)<=je){const k=wt(Me,0,Me.length,Ae+je);return k===Me.length||s(k,_t(Me,k+1,Me.length,Ae+360-je)-k),Fe}Ae<Me[0]&&(Ae+=360);const qe=_t(Me,0,Me.length,Ae-je);if(qe===Me.length)return s(0,Me.length),Fe;s(0,qe-0);const pt=wt(Me,qe+1,Me.length,Ae+je);return pt!==Me.length&&s(pt,Me.length-pt),Fe}}const qx=(Math.pow(256,2)-1)/16907520;class _m extends ps{constructor(k,F,Me,Ae){super(k,{layout:kx||(kx=new Ga({visibility:new ja(Xp.layout_raster.visibility)})),paint:Bx||(Bx=new Ga({"raster-opacity":new ja(Xp.paint_raster["raster-opacity"]),"raster-color":new $a(Xp.paint_raster["raster-color"]),"raster-color-mix":new ja(Xp.paint_raster["raster-color-mix"]),"raster-color-range":new ja(Xp.paint_raster["raster-color-range"]),"raster-hue-rotate":new ja(Xp.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ja(Xp.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ja(Xp.paint_raster["raster-brightness-max"]),"raster-saturation":new ja(Xp.paint_raster["raster-saturation"]),"raster-contrast":new ja(Xp.paint_raster["raster-contrast"]),"raster-resampling":new ja(Xp.paint_raster["raster-resampling"]),"raster-fade-duration":new ja(Xp.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ja(Xp.paint_raster["raster-emissive-strength"]),"raster-array-band":new ja(Xp.paint_raster["raster-array-band"]),"raster-elevation":new ja(Xp.paint_raster["raster-elevation"]),"raster-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(k){return!(k&&k._source instanceof vm&&(k._source.onNorthPole||k._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(k){"raster-color"!==k&&"raster-color-range"!==k||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(k){if(!this.hasColorMap())return;if(!this._curRampRange)return;const F=this._transitionablePaint._values["raster-color"].value.expression,[Me,Ae]=k||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(Me)&&isNaN(Ae)||Me===this._curRampRange[0]&&Ae===this._curRampRange[1]||(this.colorRamp=lc({expression:F,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:Me,end:Ae}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[Me,Ae])}}let $x,ov,pv,_v,vv;class Pm extends ps{constructor(k,F,Me,Ae){super(k,{layout:$x||($x=new Ga({visibility:new ja(Xp["layout_raster-particle"].visibility)})),paint:ov||(ov=new Ga({"raster-particle-array-band":new ja(Xp["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ja(Xp["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new $a(Xp["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ja(Xp["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ja(Xp["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ja(Xp["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ja(Xp["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ja(Xp["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae),this._updateColorRamp(),this.lastInvalidatedAt=Gc.now()}onRemove(k){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(k){return!1}_handleSpecialPaintPropertyUpdate(k){"raster-particle-color"!==k&&"raster-particle-max-speed"!==k||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===k&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const k=this._transitionablePaint._values["raster-particle-color"].value.expression,F=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=lc({expression:k,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:F}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Gc.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class zm extends ps{constructor(k,F){super(k,{},F,null),this.implementation=k,k.slot&&(this.slot=k.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(k){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(k){this.implementation.onAdd&&this.implementation.onAdd(k,k.painter.context.gl)}onRemove(k){this.implementation.onRemove&&this.implementation.onRemove(k,k.painter.context.gl)}}function Em(k,F,Me){const Ae=[0,0,1],Oe=aa.quat.identity([]);return aa.quat.rotateY(Oe,Oe,Me?-X(k)+Math.PI:X(k)),aa.quat.rotateX(Oe,Oe,-X(F)),aa.vec3.transformQuat(Ae,Ae,Oe),aa.vec3.normalize(Ae,Ae)}function km(k,F){const Me=Bm(k.projection,k.zoom,k.width,k.height),Ae=function(k,F,Me,Ae,Oe){const Fe=new il(Me.lng-180*bv,Me.lat),je=new il(Me.lng+180*bv,Me.lat),qe=k.project(Fe.lng,Fe.lat),pt=k.project(je.lng,je.lat),vt=-Math.atan2(pt.y-qe.y,pt.x-qe.x),Ut=bl.fromLngLat(Me);Ut.y=Q(Ut.y,-1+bv,1-bv);const xi=Ut.toLngLat(),vi=k.project(xi.lng,xi.lat),bi=bl.fromLngLat(xi);bi.x+=bv;const wi=bi.toLngLat(),Mi=k.project(wi.lng,wi.lat),pr=Dm(Mi.x-vi.x,Mi.y-vi.y,vt),Ur=bl.fromLngLat(xi);Ur.y+=bv;const Wr=Ur.toLngLat(),Jr=k.project(Wr.lng,Wr.lat),Qr=Dm(Jr.x-vi.x,Jr.y-vi.y,vt),co=Math.abs(pr.x)/Math.abs(Qr.y),mo=aa.mat4.identity([]);aa.mat4.rotateZ(mo,mo,-vt*(1-(Oe?0:Ae)));const yo=aa.mat4.identity([]);return aa.mat4.scale(yo,yo,[1,1-(1-co)*Ae,1]),yo[4]=-Qr.x/Qr.y*Ae,aa.mat4.rotateZ(yo,yo,vt),aa.mat4.multiply(yo,mo,yo),yo}(k.projection,0,k.center,Me,F),Oe=Tm(k);return aa.mat4.scale(Ae,Ae,[Oe,Oe,1]),Ae}function Tm(k){const F=k.projection,Me=Bm(k.projection,k.zoom,k.width,k.height),Ae=Cm(F,k.center),Oe=Cm(F,il.convert(F.center));return Math.pow(2,Ae*Me+(1-Me)*Oe)}function Bm(k,F,Me,Ae,Oe=1/0){const Fe=k.range;if(!Fe)return 0;const je=Math.min(Oe,Math.max(Me,Ae)),qe=Math.log(je/1024)/Math.LN2;return tt(Fe[0]+qe,Fe[1]+qe,F)}const bv=1/4e4;function Cm(k,F){const Me=Q(F.lat,-wm,wm),Ae=new il(F.lng-180*bv,Me),Oe=new il(F.lng+180*bv,Me),Fe=k.project(Ae.lng,Me),je=k.project(Oe.lng,Me),qe=bl.fromLngLat(Ae),pt=bl.fromLngLat(Oe),vt=je.x-Fe.x,Ut=je.y-Fe.y,xi=pt.x-qe.x,vi=pt.y-qe.y,bi=Math.sqrt((xi*xi+vi*vi)/(vt*vt+Ut*Ut));return Math.log(bi)/Math.LN2}function Dm(k,F,Me){const Ae=Math.cos(Me),Oe=Math.sin(Me);return{x:k*Ae-F*Oe,y:k*Oe+F*Ae}}function Lm(k,F,Me){aa.mat4.identity(k),aa.mat4.rotateZ(k,k,X(F[2])),aa.mat4.rotateX(k,k,X(F[0])),aa.mat4.rotateY(k,k,X(F[1])),aa.mat4.scale(k,k,Me),aa.mat4.multiply(k,k,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Rm(k,F,Me,Ae,Oe,Fe,je,qe){const pt=[Me[0]-F[0],Me[1]-F[1],0],vt=[Ae[0]-F[0],Ae[1]-F[1],0];if(aa.vec3.length(pt)<1e-12||aa.vec3.length(vt)<1e-12)return aa.quat.identity(k);const Ut=aa.vec3.cross([],pt,vt);aa.vec3.normalize(Ut,Ut),aa.vec3.subtract(vt,Ae,F),pt[2]=(Fe-Oe)*qe,vt[2]=(je-Oe)*qe;const xi=pt;return aa.vec3.cross(xi,pt,vt),aa.vec3.normalize(xi,xi),aa.quat.rotationTo(k,Ut,xi)}function Fm(k,F,Me=!1){const Ae=Fu(F.zoom),Oe=function(k,F,Me){const Ae=F.worldSize,Oe=[k[12],k[13],k[14]],Fe=fl(Oe[1]/Ae),je=pl(Oe[0]/Ae),qe=aa.mat4.identity([]),pt=hl(1,Fe)*Ae,vt=hl(1,0)*Ae*gl(Fe,F.zoom),Ut=1/Du(Ae);let xi=vt*Ut;if(Me){const k=Bm(F.projection,F.zoom,F.width,F.height,1024);xi=Ut*F.projection.pixelSpaceConversion(F.center.lat,Ae,k)}const vi=el(Fe,je);aa.vec3.add(vi,vi,aa.vec3.scale([],aa.vec3.normalize([],vi),pt*xi*Oe[2]));const bi=function(k){const F=[k[0],k[1],k[2]];let Me=[0,1,0];const Ae=aa.vec3.cross([],Me,F);return aa.vec3.cross(Me,F,Ae),0===aa.vec3.squaredLength(Me)&&(Me=[0,1,0],aa.vec3.cross(Ae,F,Me)),aa.vec3.normalize(Ae,Ae),aa.vec3.normalize(Me,Me),aa.vec3.normalize(F,F),[Ae[0],Ae[1],Ae[2],0,Me[0],Me[1],Me[2],0,F[0],F[1],F[2],0,k[0],k[1],k[2],1]}(vi);aa.mat4.scale(qe,qe,[xi,xi,xi*pt]),aa.mat4.translate(qe,qe,[-Oe[0],-Oe[1],-Oe[2]]);const wi=aa.mat4.multiply([],F.globeMatrix,bi);return aa.mat4.multiply(wi,wi,qe),aa.mat4.multiply(wi,wi,k),wi}(k,F,Me);if(Ae>0){const Me=function(k,F){const Me=F.worldSize,Ae=hl(1,0)*Me*gl(F.center.lat,F.zoom)/Du(Me),Oe=hl(1,F.center.lat)*Me,Fe=aa.mat4.identity([]);return aa.mat4.rotateY(Fe,Fe,X(F.center.lng)),aa.mat4.rotateX(Fe,Fe,X(F.center.lat)),aa.mat4.translate(Fe,Fe,[0,0,Wf]),aa.mat4.scale(Fe,Fe,[Ae,Ae,Ae*Oe]),aa.mat4.translate(Fe,Fe,[F.point.x-.5*Me,F.point.y-.5*Me,0]),aa.mat4.multiply(Fe,Fe,k),aa.mat4.multiply(Fe,F.globeMatrix,Fe)}(k,F);return function(k,F,Me){const n=(k,F,Me)=>{const Ae=aa.vec3.length(k),Oe=aa.vec3.length(F),Fe=Su(k,F,Me);return aa.vec3.scale(Fe,Fe,1/aa.vec3.length(Fe)*ze(Ae,Oe,Me))},Ae=n([k[0],k[1],k[2]],[F[0],F[1],F[2]],Me),Oe=n([k[4],k[5],k[6]],[F[4],F[5],F[6]],Me),Fe=n([k[8],k[9],k[10]],[F[8],F[9],F[10]],Me),je=Su([k[12],k[13],k[14]],[F[12],F[13],F[14]],Me);return[Ae[0],Ae[1],Ae[2],0,Oe[0],Oe[1],Oe[2],0,Fe[0],Fe[1],Fe[2],0,je[0],je[1],je[2],1]}(Oe,Me,Ae)}return Oe}function Om(k,F,Me,Ae){const Oe=xu.projectAabbCorners(Ae,Me);let Fe=Number.MAX_VALUE,je=-1;for(let k=0;k<Oe.length;++k){const Me=Oe[k];Me[0]=(.5*Me[0]+.5)*F.width,Me[1]=(.5-.5*Me[1])*F.height,Me[2]<Fe&&(je=k,Fe=Me[2])}const o=k=>new Sa(Oe[k][0],Oe[k][1]);let qe;switch(je){case 0:case 6:qe=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:qe=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:qe=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:qe=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Vl(k,qe))return Fe}const wv=ys([{name:"a_pos_3f",components:3,type:"Float32"}]),Tv=ys([{name:"a_color_3f",components:3,type:"Float32"}]),Sv=ys([{name:"a_color_4f",components:4,type:"Float32"}]),Mv=ys([{name:"a_uv_2f",components:2,type:"Float32"}]),Ev=ys([{name:"a_normal_3f",components:3,type:"Float32"}]),Iv=ys([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Av=ys([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),Cv={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class Zm{constructor(k,F,Me,Ae){this.message=(k?`${k}: `:"")+Me,Ae&&(this.identifier=Ae),null!=F&&F.__line__&&(this.line=F.__line__)}}function Hm(k,F){const Me=-1===k.indexOf("://");try{return new URL(k,Me&&F?"http://example.com":void 0),!0}catch(k){return!1}}class Wm{constructor(k,F){this.feature=k,this.instancedDataOffset=F,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Km{constructor(){this.instancedDataArray=new Xs,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Jm{constructor(k){this.zoom=k.zoom,this.canonical=k.canonical,this.layers=k.layers,this.layerIds=this.layers.map((k=>k.fqid)),this.projection=k.projection,this.index=k.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(k,F){}populate(k,F,Me,Ae){this.tileToMeter=vl(Me);const Oe=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:Fe,id:je,index:qe,sourceLayerIndex:pt}of k){const k=null!=je?je:Fe.properties&&Fe.properties.hasOwnProperty("id")?Fe.properties.id:void 0,vt=El(Fe,Oe);if(!this.layers[0]._featureFilter.filter(new Va(this.zoom),vt,Me))continue;const Ut={id:k,sourceLayerIndex:pt,index:qe,geometry:Oe?vt.geometry:zl(Fe,Me,Ae),properties:Fe.properties,type:Fe.type,patterns:{}},xi=this.addFeature(Ut,Ut.geometry,vt);xi&&F.featureIndex.insert(Fe,Ut.geometry,qe,pt,this.index,this.instancesPerModel[xi].instancedDataArray.length,Td/32)}this.lookup=null}update(k,F,Me,Ae){for(const F in this.instancesPerModel){const Me=this.instancesPerModel[F];for(const F in k)Me.idToFeaturesIndex.hasOwnProperty(F)&&(this.evaluate(Me.features[Me.idToFeaturesIndex[F]],k[F],Me,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let k=!1;for(const F in this.instancesPerModel){const Me=this.instancesPerModel[F];for(const F of Me.features){const Ae=this.layers[0],Oe=F.feature,Fe=this.canonical,je=Ae.paint.get("model-rotation").evaluate(Oe,{},Fe),qe=Ae.paint.get("model-scale").evaluate(Oe,{},Fe),pt=Ae.paint.get("model-translation").evaluate(Oe,{},Fe);aa.vec3.exactEquals(F.rotation,je)&&aa.vec3.exactEquals(F.scale,qe)&&aa.vec3.exactEquals(F.translation,pt)||(this.evaluate(F,F.featureStates,Me,!0),k=!0)}}return k}updateReplacement(k,F,Me,Ae){if(F.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=F.updateTime;const Oe=F.getReplacementRegionsForTile(k.toUnwrapped(),!0);if(Ah(this.activeReplacements,Oe))return!1;this.activeReplacements=Oe;let Fe=!1;for(const F in this.instancesPerModel){const Oe=this.instancesPerModel[F],je=Oe.instancedDataArray;for(const F of Oe.features){const Oe=F.instancedDataOffset,qe=F.instancedDataCount;for(let F=0;F<qe;F++){const qe=16*(F+Oe);let pt=je.float32[qe+0];const vt=pt>Td;pt=vt?pt-Td:pt;const Ut=Math.floor(pt),xi=je.float32[qe+1];let vi=!1;for(const F of this.activeReplacements)if(!bh(F,Me,Cv.Model,Ae)&&!(F.min.x>Ut||Ut>F.max.x||F.min.y>xi||xi>F.max.y)&&(vi=kh(Eh(Ut,xi,k.canonical,F.footprintTileId.canonical),F.footprint),vi))break;je.float32[qe]=vi?pt+Td:pt,Fe=Fe||vi!==vt}}}return Fe}isEmpty(){for(const k in this.instancesPerModel)if(0!==this.instancesPerModel[k].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(k){if(!this.uploaded)for(const F in this.instancesPerModel){const Me=this.instancesPerModel[F];Me.instancedDataArray.length<0||0===Me.instancedDataArray.length||(Me.instancedDataBuffer?Me.instancedDataBuffer.updateData(Me.instancedDataArray):Me.instancedDataBuffer=k.createVertexBuffer(Me.instancedDataArray,Iv.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const k in this.instancesPerModel){const F=this.instancesPerModel[k];0!==F.instancedDataArray.length&&F.instancedDataBuffer&&F.instancedDataBuffer.destroy()}const k=this.layers[0].modelManager;if(k&&this.modelUris)for(const F of this.modelUris)k.removeModel(F,"")}addFeature(k,F,Me){const Ae=this.layers[0],Oe=Ae.layout.get("model-id").evaluate(Me,{},this.canonical);if(!Oe)return ft(`modelId is not evaluated for layer ${Ae.id} and it is not going to get rendered.`),Oe;Hm(Oe,!1)&&(this.modelUris.includes(Oe)||this.modelUris.push(Oe)),this.instancesPerModel[Oe]||(this.instancesPerModel[Oe]=new Km);const Fe=this.instancesPerModel[Oe],je=Fe.instancedDataArray,qe=new Wm(Me,je.length);for(const k of F)for(const F of k){if(F.x<0||F.x>=Td||F.y<0||F.y>=Td)continue;const k=(this.lookupDim-1)/Td,Me=this.lookupDim*(F.y*k|0)+F.x*k|0;if(this.lookup){if(0!==this.lookup[Me])continue;this.lookup[Me]=1}this.instanceCount++;const Ae=je.length;je.resize(Ae+1),Fe.instancesEvaluatedElevation.push(0),je.float32[16*Ae]=F.x,je.float32[16*Ae+1]=F.y}return qe.instancedDataCount=Fe.instancedDataArray.length-qe.instancedDataOffset,qe.instancedDataCount>0&&(k.id&&(Fe.idToFeaturesIndex[k.id]=Fe.features.length),Fe.features.push(qe),this.evaluate(qe,{},Fe,!1)),Oe}getModelUris(){return this.modelUris}evaluate(k,F,Me,Ae){const Oe=this.layers[0],Fe=k.feature,je=this.canonical,qe=k.rotation=Oe.paint.get("model-rotation").evaluate(Fe,F,je),pt=k.scale=Oe.paint.get("model-scale").evaluate(Fe,F,je),vt=k.translation=Oe.paint.get("model-translation").evaluate(Fe,F,je),Ut=Oe.paint.get("model-color").evaluate(Fe,F,je);Ut.a=Oe.paint.get("model-color-mix-intensity").evaluate(Fe,F,je);const xi=[];this.maxVerticalOffset<vt[2]&&(this.maxVerticalOffset=vt[2]),this.maxScale=Math.max(Math.max(this.maxScale,pt[0]),Math.max(pt[1],pt[2])),Lm(xi,qe,pt);const vi=Math.round(100*Ut.a)+Ut.b/1.05;for(let F=0;F<k.instancedDataCount;++F){const Oe=k.instancedDataOffset+F,Fe=16*Oe,qe=Me.instancedDataArray.float32;let pt=0;Ae&&(pt=qe[Fe+6]-Me.instancesEvaluatedElevation[Oe]);const bi=0|qe[Fe+1];qe[Fe]=(0|qe[Fe])+Ut.r/1.05,qe[Fe+1]=bi+Ut.g/1.05,qe[Fe+2]=vi,qe[Fe+3]=1/(je.z>10?this.tileToMeter:vl(je,bi)),qe[Fe+4]=vt[0],qe[Fe+5]=vt[1],qe[Fe+6]=vt[2]+pt,qe[Fe+7]=xi[0],qe[Fe+8]=xi[1],qe[Fe+9]=xi[2],qe[Fe+10]=xi[4],qe[Fe+11]=xi[5],qe[Fe+12]=xi[6],qe[Fe+13]=xi[8],qe[Fe+14]=xi[9],qe[Fe+15]=xi[10],Me.instancesEvaluatedElevation[Oe]=vt[2]}}}let zv,Pv;oa(Jm,"ModelBucket",{omit:["layers"]}),oa(Km,"PerModelAttributes"),oa(Wm,"ModelFeature");const Dv=64,Rv={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function ny(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt=!1){const Ut=Me.zoom,xi=Me.project(Ae),vi=gl(Ae.lat,Ut),bi=1/vi;aa.mat4.identity(k),aa.mat4.translate(k,k,[xi.x+je[0]*bi,xi.y+je[1]*bi,je[2]]);let wi=1,Mi=1;const pr=Me.worldSize;if(vt){if("mercator"===Me.projection.name){let k=0;Me.elevation&&(k=Me.elevation.getAtPointOrZero(new bl(xi.x/pr,xi.y/pr),0));const F=aa.vec4.transformMat4([],[xi.x,xi.y,k,1],Me.projMatrix)[3]/Me.cameraToCenterDistance;wi=F,Mi=F*gl(Me.center.lat,Ut)}else if("globe"===Me.projection.name){const F=Fm(k,Me),Oe=aa.mat4.multiply([],Me.projMatrix,F),Fe=[0,0,0,1];aa.vec4.transformMat4(Fe,Fe,Oe);const je=Fe[3]/Me.cameraToCenterDistance,qe=Fu(Ut),pt=Me.projection.pixelsPerMeter(Ae.lat,pr)*gl(Ae.lat,Ut),vt=Me.projection.pixelsPerMeter(Me.center.lat,pr)*gl(Me.center.lat,Ut);wi=je/ze(pt,yl(Me.center.lat),qe),Mi=je*vi/pt,wi*=vt,Mi*=vt}}else wi=bi;aa.mat4.scale(k,k,[wi,wi,Mi]);const Ur=[...k],Wr=F.orientation,Jr=[];if(Lm(Jr,[Wr[0]+Oe[0],Wr[1]+Oe[1],Wr[2]+Oe[2]],Fe),aa.mat4.multiply(k,Ur,Jr),qe&&Me.elevation){let Oe=0;const Fe=[];if(pt&&Me.elevation){Oe=function(k,F,Me,Ae,Oe){const Fe=F.elevation;if(!Fe)return 0;const je=xu.projectAabbCorners(Me,Ae),qe=hl(1,Oe.lat)*F.worldSize,pt=function(k,F){const Me=[0,0,1],Ae=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Oe of Ae){const Ae=k[Oe.corners[0]],Fe=k[Oe.corners[1]],je=k[Oe.corners[2]],qe=[Fe[0]-Ae[0],Fe[1]-Ae[1],F*(Fe[2]-Ae[2])],pt=aa.vec3.cross(qe,qe,[je[0]-Ae[0],je[1]-Ae[1],F*(je[2]-Ae[2])]);aa.vec3.normalize(pt,pt),Oe.dotProductWithUp=aa.vec3.dot(pt,Me)}return Ae.sort(((k,F)=>k.dotProductWithUp-F.dotProductWithUp)),Ae[0].corners}(je,qe),vt=je[pt[0]],Ut=je[pt[1]],xi=je[pt[2]],vi=je[pt[3]],bi=Fe.getAtPointOrZero(new bl(vt[0]/F.worldSize,vt[1]/F.worldSize),0),wi=Fe.getAtPointOrZero(new bl(Ut[0]/F.worldSize,Ut[1]/F.worldSize),0),Mi=Fe.getAtPointOrZero(new bl(xi[0]/F.worldSize,xi[1]/F.worldSize),0),pr=Fe.getAtPointOrZero(new bl(vi[0]/F.worldSize,vi[1]/F.worldSize),0),Ur=(bi+pr)/2,Wr=(wi+Mi)/2;return Ur>Wr?wi<Mi?Rm(k,Ut,vi,vt,wi,pr,bi,qe):Rm(k,xi,vt,vi,Mi,bi,pr,qe):bi<pr?Rm(k,vt,Ut,xi,bi,wi,Mi,qe):Rm(k,vi,xi,Ut,pr,Mi,wi,qe),Math.max(Ur,Wr)}(Fe,Me,F.aabb,k,Ae);const je=aa.mat4.fromQuat([],Fe),qe=aa.mat4.multiply([],je,Jr);aa.mat4.multiply(k,Ur,qe)}else Oe=Me.elevation.getAtPointOrZero(new bl(xi.x/pr,xi.y/pr),0);0!==Oe&&(k[14]+=Oe)}}function iy(k,F,Me=!1){k.uploaded||(k.gfxTexture=new dm(F,k.image,Me?F.gl.R8:F.gl.RGBA8,{useMipmap:k.sampler.minFilter>=F.gl.NEAREST_MIPMAP_NEAREST}),k.uploaded=!0,k.image=null)}function ay(k,F,Me){k.indexBuffer=F.createIndexBuffer(k.indexArray,!1,!0),k.vertexBuffer=F.createVertexBuffer(k.vertexArray,wv.members,!1,!0),k.normalArray&&(k.normalBuffer=F.createVertexBuffer(k.normalArray,Ev.members,!1,!0)),k.texcoordArray&&(k.texcoordBuffer=F.createVertexBuffer(k.texcoordArray,Mv.members,!1,!0)),k.colorArray&&(k.colorBuffer=F.createVertexBuffer(k.colorArray,(12===k.colorArray.bytesPerElement?Tv:Sv).members,!1,!0)),k.featureArray&&(k.pbrBuffer=F.createVertexBuffer(k.featureArray,Av.members,!0)),k.segments=po.simpleSegment(0,0,k.vertexArray.length,k.indexArray.length);const Ae=k.material;Ae.pbrMetallicRoughness.baseColorTexture&&iy(Ae.pbrMetallicRoughness.baseColorTexture,F),Ae.pbrMetallicRoughness.metallicRoughnessTexture&&iy(Ae.pbrMetallicRoughness.metallicRoughnessTexture,F),Ae.normalTexture&&iy(Ae.normalTexture,F),Ae.occlusionTexture&&iy(Ae.occlusionTexture,F,Me),Ae.emissionTexture&&iy(Ae.emissionTexture,F)}function sy(k,F,Me){if(k.meshes)for(const Ae of k.meshes)ay(Ae,F,Me);if(k.children)for(const Ae of k.children)sy(Ae,F,Me)}function oy(k){if(k.meshes)for(const F of k.meshes)F.indexArray.destroy(),F.vertexArray.destroy(),F.colorArray&&F.colorArray.destroy(),F.normalArray&&F.normalArray.destroy(),F.texcoordArray&&F.texcoordArray.destroy(),F.featureArray&&F.featureArray.destroy();if(k.children)for(const F of k.children)oy(F)}function ly(k){if(k.meshes)for(const Me of k.meshes)Me.vertexBuffer&&(Me.vertexBuffer.destroy(),Me.indexBuffer.destroy(),Me.normalBuffer&&Me.normalBuffer.destroy(),Me.texcoordBuffer&&Me.texcoordBuffer.destroy(),Me.colorBuffer&&Me.colorBuffer.destroy(),Me.pbrBuffer&&Me.pbrBuffer.destroy(),Me.segments.destroy(),Me.material&&((F=Me.material).pbrMetallicRoughness.baseColorTexture&&F.pbrMetallicRoughness.baseColorTexture.gfxTexture&&F.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),F.pbrMetallicRoughness.metallicRoughnessTexture&&F.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&F.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),F.normalTexture&&F.normalTexture.gfxTexture&&F.normalTexture.gfxTexture.destroy(),F.emissionTexture&&F.emissionTexture.gfxTexture&&F.emissionTexture.gfxTexture.destroy(),F.occlusionTexture&&F.occlusionTexture.gfxTexture&&F.occlusionTexture.gfxTexture.destroy()));var F;if(k.children)for(const F of k.children)ly(F)}class uy{constructor(k,F,Me){this._demTile=k,this._dem=this._demTile.dem,this._scale=F,this._offset=Me}static create(k,F,Me){const Ae=Me||k.findDEMTileFor(F);if(!Ae||!Ae.dem)return;const Oe=Ae.dem,Fe=Ae.tileID,je=1<<F.canonical.z-Fe.canonical.z;return new uy(Ae,Oe.dim/Td/je,[(F.canonical.x/je-Fe.canonical.x)*Oe.dim,(F.canonical.y/je-Fe.canonical.y)*Oe.dim])}tileCoordToPixel(k,F){const Me=F*this._scale+this._offset[1],Ae=Math.floor(k*this._scale+this._offset[0]),Oe=Math.floor(Me);return new Sa(Ae,Oe)}getElevationAt(k,F,Me,Ae){const Oe=k*this._scale+this._offset[0],Fe=F*this._scale+this._offset[1],je=Math.floor(Oe),qe=Math.floor(Fe),pt=this._dem;return Ae=!!Ae,Me?ze(ze(pt.get(je,qe,Ae),pt.get(je,qe+1,Ae),Fe-qe),ze(pt.get(je+1,qe,Ae),pt.get(je+1,qe+1,Ae),Fe-qe),Oe-je):pt.get(je,qe,Ae)}getElevationAtPixel(k,F,Me){return this._dem.get(k,F,!!Me)}getMeterToDEM(k){return(1<<this._demTile.tileID.canonical.z)*hl(1,k)*this._dem.stride}}const Lv=new Float32Array(262144),Ov=new Uint8Array(262144);function py(k){let F=0;if(k.meshes)for(const Me of k.meshes)F=Math.max(F,Me.aabb.max[2]);if(k.children)for(const Me of k.children)F=Math.max(F,py(Me));return F}function fy(k,F,Me){if(k.meshes)for(const Ae of k.meshes){if(Ae.aabb.min[0]===1/0)continue;const Oe=xu.applyTransform(Ae.aabb,k.matrix);Me.insert(F,Oe.min[0],Oe.min[1],Oe.max[0],Oe.max[1])}if(k.children)for(const Ae of k.children)fy(Ae,F,Me)}const kv=["","wall","door","roof","window","lamp","logo"];class my{constructor(k){this.node=k,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:k.id,geometry:[],properties:{height:py(k)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let k=0;const F=new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const Me of this.node.meshes)this.node.lightMeshIndex!==k&&(Me.transformedAabb=xu.applyTransformFast(Me.aabb,this.node.matrix),F.encapsulate(Me.transformedAabb)),k++;this.aabb=F}return this.aabb}}class yy{constructor(k,F,Me,Ae,Oe,Fe,je){this.id=Me,this.layers=k,this.layerIds=this.layers.map((k=>k.fqid)),this.stateDependentLayerIds=this.layers.filter((k=>k.isStateDependent())).map((k=>k.id)),this.modelTraits|=Rv.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,Ae&&(this.modelTraits|=Rv.HasMapboxMeshFeatures),Oe&&(this.modelTraits|=Rv.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=Fe,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const k of F)this.nodesInfo.push(new my(k)),fy(k,je.featureIndexArray.length,je.grid),je.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,je.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(k,F){for(const Me of this.getNodesInfo()){const Ae=Me.node;Ae.footprint&&F.push({footprint:Ae.footprint,id:k})}}update(k){const F=0!==Object.keys(k).length;if(F&&!this.stateDependentLayers.length)return;const Me=F?this.stateDependentLayers:this.layers;if(!$(k,this.states))for(const F of Me)this.evaluate(F,k);this.states=structuredClone(k)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(k){if(!this.needsUpload)return;const F=this.getNodesInfo();for(const Me of F){const F=Me.node;this.uploaded?this.updatePbrBuffer(F):sy(F,k,!0)}for(const k of F)oy(k.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(k){let F=!1;if(!k.meshes)return F;for(const Me of k.meshes)Me.pbrBuffer&&(Me.pbrBuffer.updateData(Me.featureArray),F=!0);return F}needsReEvaluation(k,F,Me){const Ae=k.transform.projectionOptions,Oe=k.style.getBrightness(),Fe=this.brightness!==Oe;if(!this.uploaded||this.dirty||Ae.name!==this.projection.name||gy(Me.paint.get("model-color").value,Fe)||gy(Me.paint.get("model-color-mix-intensity").value,Fe)||gy(Me.paint.get("model-roughness").value,Fe)||gy(Me.paint.get("model-emissive-strength").value,Fe)||gy(Me.paint.get("model-height-based-emissive-strength-multiplier").value,Fe)){this.projection=Ae,this.brightness=Oe;const k=this.getNodesInfo();for(const F of k)F.state=null;return!0}return!1}evaluateScale(k,F){if(k.transform.zoom===this.zoom)return;this.zoom=k.transform.zoom;const Me=this.getNodesInfo(),Ae=this.id.canonical;for(const k of Me){const Me=k.feature;k.evaluatedScale=F.paint.get("model-scale").evaluate(Me,{},Ae)}}evaluate(k,F){const Me=this.getNodesInfo();for(const Ae of Me){if(!Ae.node.meshes)continue;const Me=Ae.feature,Oe=F&&F[Me.id];if($(Oe,Ae.state))continue;Ae.state=structuredClone(Oe);const Fe=Ae.node.meshes&&Ae.node.meshes[0].featureData,je=Ae.evaluatedColor[2],qe=Ae.evaluatedRMEA[2],pt=this.id.canonical;if(Ae.hasTranslucentParts=!1,Fe){for(let F=0;F<kv.length;F++){const Fe=kv[F];Fe.length&&(Me.properties.part=Fe);const je=k.paint.get("model-color").evaluate(Me,Oe,pt).toRenderColor(null),qe=k.paint.get("model-color-mix-intensity").evaluate(Me,Oe,pt);Ae.evaluatedColor[F]=[je.r,je.g,je.b,qe],Ae.evaluatedRMEA[F][0]=k.paint.get("model-roughness").evaluate(Me,Oe,pt),Ae.evaluatedRMEA[F][2]=k.paint.get("model-emissive-strength").evaluate(Me,Oe,pt),Ae.evaluatedRMEA[F][3]=je.a,Ae.emissionHeightBasedParams[F]=k.paint.get("model-height-based-emissive-strength-multiplier").evaluate(Me,Oe,pt),!Ae.hasTranslucentParts&&je.a<1&&(Ae.hasTranslucentParts=!0)}delete Me.properties.part,vy(Ae,je!==Ae.evaluatedColor[2]||qe!==Ae.evaluatedRMEA[2],this.modelTraits)}else Ae.evaluatedRMEA[0][2]=k.paint.get("model-emissive-strength").evaluate(Me,Oe,pt);Ae.evaluatedScale=k.paint.get("model-scale").evaluate(Me,Oe,pt),this.updatePbrBuffer(Ae.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(k,F,Me,Ae){const Oe=k.findDEMTileFor(Me);if(Oe&&(Oe.tileID.canonical!==this.terrainTile||F!==this.terrainExaggeration)){if(Oe.dem&&Oe.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=Oe.tileID.overscaledZ;const F=uy.create(k,Me,Oe);if(!F)return;this.modelTraits&Rv.HasMapboxMeshFeatures&&this.updateDEM(k,F,Me,Ae);for(const k of this.getNodesInfo()){const Me=k.node;if(!Me.footprint||!Me.footprint.vertices||!Me.footprint.vertices.length)continue;const Ae=Me.footprint.vertices;let Oe=F.getElevationAt(Ae[0].x,Ae[0].y,!0,!0);for(let k=1;k<Ae.length;k++)Oe=Math.min(Oe,F.getElevationAt(Ae[k].x,Ae[k].y,!0,!0));Me.elevation=Oe}}this.terrainTile=Oe.tileID.canonical,this.terrainExaggeration=F}}updateDEM(k,F,Me,Ae){let Oe=F._dem._modifiedForSources[Ae];if(void 0===Oe&&(F._dem._modifiedForSources[Ae]=[],Oe=F._dem._modifiedForSources[Ae]),Oe.includes(Me.canonical))return;const Fe=F._dem.dim;Oe.push(Me.canonical);let je=!1;for(const k of this.getNodesInfo()){const Me=k.node;if(!Me.footprint||!Me.footprint.grid)continue;const Ae=Me.footprint.grid,Oe=F.tileCoordToPixel(Ae.min.x,Ae.min.y),qe=F.tileCoordToPixel(Ae.max.x,Ae.max.y),pt=Math.min(Math.min(Fe-qe.y,Oe.x),Math.min(Oe.y,Fe-qe.x));if(pt<0)continue;const vt=Q(pt,2,5);let Ut=Math.max(0,Oe.x-vt),xi=Math.max(0,Oe.y-vt),vi=Math.min(qe.x+vt,Fe-1),bi=Math.min(qe.y+vt,Fe-1);for(let k=xi;k<=bi;++k)for(let F=Ut;F<=vi;++F)Ov[k*Fe+F]=255;let wi=0,Mi=0;for(let k=0;k<Ae.cellsY;++k)for(let Me=0;Me<Ae.cellsX;++Me){if(!Ae.cells[k*Ae.cellsX+Me])continue;const Oe=F.tileCoordToPixel(Ae.min.x+Me/Ae.xScale,Ae.min.y+k/Ae.yScale),je=F.tileCoordToPixel(Ae.min.x+(Me+1)/Ae.xScale,Ae.min.y+(k+1)/Ae.yScale);for(let k=Oe.y;k<=Math.min(je.y+1,Fe-1);++k)for(let Me=Oe.x;Me<=Math.min(je.x+1,Fe-1);++Me)255===Ov[k*Fe+Me]&&(Ov[k*Fe+Me]=0,wi+=F.getElevationAtPixel(Me,k),Mi++)}const pr=wi/Mi;Ut=Math.max(1,Oe.x-vt),xi=Math.max(1,Oe.y-vt),vi=Math.min(qe.x+vt,Fe-2),bi=Math.min(qe.y+vt,Fe-2),je=!0;for(let k=xi;k<=bi;++k)for(let Me=Ut;Me<=vi;++Me)0===Ov[k*Fe+Me]&&(Lv[k*Fe+Me]=F._dem.set(Me,k,pr));for(let k=1;k<vt;++k){Ut=Math.max(1,Oe.x-k),xi=Math.max(1,Oe.y-k),vi=Math.min(qe.x+k,Fe-2),bi=Math.min(qe.y+k,Fe-2);for(let Me=xi;Me<=bi;++Me)for(let Ae=Ut;Ae<=vi;++Ae){const Oe=Me*Fe+Ae;if(255===Ov[Oe]){let je=0,qe=0,pt=-1,Ut=-1;for(let F=-1;F<=1;++F)for(let Oe=-1;Oe<=1;++Oe){const vt=(Me+F)*Fe+Ae+Oe;if(Ov[vt]>=k)continue;const xi=Lv[vt],vi=Math.abs(xi);vi>qe&&(je=xi,qe=vi,pt=Oe,Ut=F)}if(qe>.1){const Fe=1-(k+.5*Math.abs(pt*Ut))/vt;let qe=F._dem.get(Ae,Me)+je*Fe;const xi=F._dem.get(Ae+pt,Me+Ut),vi=F._dem.get(Ae-pt,Me-Ut,!0);(qe-xi)*(qe-vi)>0&&(qe=(xi+vi)/2),Lv[Oe]=F._dem.set(Ae,Me,qe),Ov[Oe]=k}}}}}je&&(F._demTile.needsDEMTextureUpload=!0,F._dem._timestamp=Gc.now())}getNodesInfo(){return this.nodesInfo}destroy(){const k=this.getNodesInfo();for(const F of k)oy(F.node),ly(F.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(k,F){if(F.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=F.updateTime;const Me=F.getReplacementRegionsForTile(k.toUnwrapped()),Ae=this.getNodesInfo();for(let k=0;k<this.nodesInfo.length;k++){const F=Ae[k].node;Ae[k].hiddenByReplacement=!!F.footprint&&!Me.find((k=>k.footprint===F.footprint))}}getHeightAtTileCoord(k,F){const Me=this.getNodesInfo(),Ae=[],Oe=[0,0,0],Fe=aa.mat4.identity([]);for(let je=0;je<this.nodesInfo.length;je++){const qe=Me[je],pt=qe.node.meshes[0],vt=pt.transformedAabb;if(k<vt.min[0]||F<vt.min[1]||k>vt.max[0]||F>vt.max[1])continue;if(!0===qe.node.hidden)return{height:1/0,maxHeight:qe.feature.properties.height,hidden:!1,verticalScale:qe.evaluatedScale[2]};aa.mat4.invert(Fe,qe.node.matrix),Oe[0]=k,Oe[1]=F,aa.vec3.transformMat4(Oe,Oe,Fe);const Ut=(Oe[0]-pt.aabb.min[0])/(pt.aabb.max[0]-pt.aabb.min[0])*Dv|0,xi=Math.min(63,(Oe[1]-pt.aabb.min[1])/(pt.aabb.max[1]-pt.aabb.min[1])*Dv|0)*Dv+Math.min(63,Ut),vi=pt.heightmap[xi];if(!(vi<0&&qe.node.footprint)){if(qe.hiddenByReplacement)return;return{height:vi,maxHeight:qe.feature.properties.height,hidden:!1,verticalScale:qe.evaluatedScale[2]}}if(qe.node.footprint.grid.query(new Sa(k,F),new Sa(k,F),Ae),Ae.length>0)return{height:void 0,maxHeight:qe.feature.properties.height,hidden:qe.hiddenByReplacement,verticalScale:qe.evaluatedScale[2]}}}}function gy(k,F){return!k.isLightConstant&&F}function xy(k,F,Me,Ae,Oe,Fe,je,qe){let pt=(61440&F|(61440&F)>>4)>>8,vt=(3840&F|(3840&F)>>4)>>4,Ut=240&F|(240&F)>>4;Me[3]>0&&(pt=ze(pt,255*Me[0],Me[3]),vt=ze(vt,255*Me[1],Me[3]),Ut=ze(Ut,255*Me[2],Me[3]));const xi=pt<<8|vt,vi=Ut<<8|Math.floor(255*Ae[3]),bi=function(k){const F=Q(k,0,2);return Math.min(Math.round(.5*F*255),255)}(Ae[2])<<8|15*Ae[0]<<4|15*Ae[1],wi=Q(Oe[0],0,1),Mi=Q(Oe[1],0,1),pr=Q(Oe[2],0,1),Ur=Q(Oe[3],0,1);let Wr,Jr,Qr,co;if(wi!==Mi&&je!==Fe&&Mi!==wi){const k=je-Fe;Jr=1/(k*(Mi-wi)),Qr=-(Fe+k*wi)/(k*(Mi-wi));const F=Q(Oe[4],-1,1);co=Math.pow(10,F),Wr=255*pr<<8|255*Ur}else Wr=65535,Jr=0,Qr=1,co=1;if(k.emplaceBack(xi,vi,bi,Wr,Jr,Qr,co),qe){const k=qe.length;qe.clear();for(let F=0;F<k;F++)qe.emplaceBack(xi,vi,bi,Wr,Jr,Qr,co)}}function vy(k,F,Me){const Ae=k.node;let Oe=0;const Fe=Me&Rv.HasMeshoptCompression;for(const Me of Ae.meshes){if(Ae.lights&&Ae.lightMeshIndex===Oe)continue;if(!Me.featureData)continue;Me.featureArray=new Zs,Me.featureArray.reserve(Me.featureData.length);let je=F;for(const F of Me.featureData){const Oe=Fe?65535&F:F>>16&65535,qe=Fe?F>>16&65535:65535&F,pt=(15&qe)<8?15&qe:0,vt=k.evaluatedRMEA[pt],Ut=k.evaluatedColor[pt],xi=k.emissionHeightBasedParams[pt];let vi;if(je&&2===pt&&Ae.lights&&(vi=new Zs,vi.resize(10*Ae.lights.length)),xy(Me.featureArray,Oe,Ut,vt,xi,Me.aabb.min[2],Me.aabb.max[2],vi),vi&&je){je=!1;const k=Ae.meshes[Ae.lightMeshIndex];k.featureArray=vi,k.featureArray._trim()}}Me.featureArray._trim(),Oe++}}function by(k,F,Me,Ae){const Oe=1<<k.z;F.lat=fl((Ae/Td+k.y)/Oe),F.lng=pl((Me/Td+k.x)/Oe)}oa(yy,"Tiled3dModelBucket",{omit:["layers"]}),oa(my,"Tiled3dModelFeature");const Fv={circle:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:Im||(Im=new Ga({"circle-sort-key":new qa(Xp.layout_circle["circle-sort-key"]),visibility:new ja(Xp.layout_circle.visibility)})),paint:Am||(Am=new Ga({"circle-radius":new qa(Xp.paint_circle["circle-radius"]),"circle-color":new qa(Xp.paint_circle["circle-color"]),"circle-blur":new qa(Xp.paint_circle["circle-blur"]),"circle-opacity":new qa(Xp.paint_circle["circle-opacity"]),"circle-translate":new ja(Xp.paint_circle["circle-translate"]),"circle-translate-anchor":new ja(Xp.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ja(Xp.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ja(Xp.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new qa(Xp.paint_circle["circle-stroke-width"]),"circle-stroke-color":new qa(Xp.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new qa(Xp.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ja(Xp.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae)}createBucket(k){return new Bl(k)}queryRadius(k){const F=k;return Xl("circle-radius",this,F)+Xl("circle-stroke-width",this,F)+Zl(this.paint.get("circle-translate"))}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe,je,qe){const pt=Wl(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),Fe.angle,k.pixelToTileUnitsFactor),vt=this.paint.get("circle-radius").evaluate(F,Me)+this.paint.get("circle-stroke-width").evaluate(F,Me);return Yu(k,Ae,Fe,je,qe,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),pt,vt)}getProgramIds(){return["circle"]}getDefaultProgramParams(k,F,Me){const Ae=Gu(this);return{config:new Oo(this,{zoom:F,lut:Me}),defines:Ae,overrideFog:!1}}},heatmap:class extends ps{createBucket(k){return new Ku(k)}constructor(k,F,Me,Ae){super(k,{layout:s_||(s_=new Ga({visibility:new ja(Xp.layout_heatmap.visibility)})),paint:a_||(a_=new Ga({"heatmap-radius":new qa(Xp.paint_heatmap["heatmap-radius"]),"heatmap-weight":new qa(Xp.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ja(Xp.paint_heatmap["heatmap-intensity"]),"heatmap-color":new $a(Xp.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ja(Xp.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(k){"heatmap-color"===k&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=lc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(k){return Xl("heatmap-radius",this,k)}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe,je,qe){const pt=this.paint.get("heatmap-radius").evaluate(F,Me);return Yu(k,Ae,Fe,je,qe,!0,!0,new Sa(0,0),pt)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(k,F,Me){return"heatmap"===k?{config:new Oo(this,{zoom:F,lut:Me}),overrideFog:!1}:{}}},hillshade:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:l_||(l_=new Ga({visibility:new ja(Xp.layout_hillshade.visibility)})),paint:c_||(c_=new Ga({"hillshade-illumination-direction":new ja(Xp.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ja(Xp.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ja(Xp.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ja(Xp.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ja(Xp.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ja(Xp.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ja(Xp.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(k,F,Me){return{overrideFog:!1}}},fill:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:d_||(d_=new Ga({"fill-sort-key":new qa(Xp.layout_fill["fill-sort-key"]),visibility:new ja(Xp.layout_fill.visibility),"fill-elevation-reference":new ja(Xp.layout_fill["fill-elevation-reference"])})),paint:p_||(p_=new Ga({"fill-antialias":new ja(Xp.paint_fill["fill-antialias"]),"fill-opacity":new qa(Xp.paint_fill["fill-opacity"]),"fill-color":new qa(Xp.paint_fill["fill-color"]),"fill-outline-color":new qa(Xp.paint_fill["fill-outline-color"]),"fill-translate":new ja(Xp.paint_fill["fill-translate"]),"fill-translate-anchor":new ja(Xp.paint_fill["fill-translate-anchor"]),"fill-pattern":new qa(Xp.paint_fill["fill-pattern"]),"fill-emissive-strength":new ja(Xp.paint_fill["fill-emissive-strength"]),"fill-z-offset":new qa(Xp.paint_fill["fill-z-offset"]),"fill-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae)}getProgramIds(){const k=this.paint.get("fill-pattern"),F=k&&k.constantOr(1),Me=[F?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&Me.push(F&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),Me}getDefaultProgramParams(k,F,Me){return{config:new Oo(this,{zoom:F,lut:Me}),overrideFog:!1}}recalculate(k,F){super.recalculate(k,F);const Me=this.paint._values["fill-outline-color"];"constant"===Me.value.kind&&void 0===Me.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(k){return new Uc(k)}queryRadius(){return Zl(this.paint.get("fill-translate"))}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe){return!k.queryGeometry.isAboveHorizon&&Dl(Hl(k.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),Fe.angle,k.pixelToTileUnitsFactor),Ae)}isTileClipped(){return!0}is3D(){return 0!==this.paint.get("fill-z-offset").constantOr(1)}},"fill-extrusion":class extends ps{constructor(k,F,Me,Ae){super(k,{layout:j_||(j_=new Ga({visibility:new ja(Xp["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ja(Xp["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:G_||(G_=new Ga({"fill-extrusion-opacity":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new qa(Xp["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ja(Xp["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(k){return new Kh(k)}queryRadius(){return Zl(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=Wl(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),Fe.angle,k.pixelToTileUnitsFactor),Ut=this.paint.get("fill-extrusion-height").evaluate(F,Me),xi=this.paint.get("fill-extrusion-base").evaluate(F,Me),vi=[0,0],bi=qe&&Fe.elevation,wi=Fe.elevation?Fe.elevation.exaggeration():1,Mi=k.tile.getBucket(this);if(bi&&Mi instanceof Kh){const k=Mi.centroidVertexArray,F=pt+1;F<k.length&&(vi[0]=k.geta_centroid_pos0(F),vi[1]=k.geta_centroid_pos1(F))}if(0===vi[0]&&1===vi[1])return!1;"globe"===Fe.projection.name&&(Ae=sp([Ae],[new Sa(0,0),new Sa(Td,Td)],k.tileID.canonical).map((k=>k.polygon)).flat());const pr=bi?qe:null,[Ur,Wr]=function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut){return"globe"===k.projection.name?function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut){const xi=[],vi=[],bi=k.projection.upVectorScale(Ut,k.center.lat,k.worldSize).metersToTile,wi=[0,0,0,1],Mi=[0,0,0,1],y=(k,F,Me,Ae)=>{k[0]=F,k[1]=Me,k[2]=Ae,k[3]=1},pr=ap();Me>0&&(Me+=pr),Ae+=pr;for(const pr of F){const F=[],Ur=[];for(const xi of pr){const vi=xi.x+Oe.x,pr=xi.y+Oe.y,Wr=k.projection.projectTilePoint(vi,pr,Ut),Jr=k.projection.upVector(Ut,xi.x,xi.y);let Qr=Me,co=Ae;if(je){const k=pp(vi,pr,Me,Ae,je,qe,pt,vt);Qr+=k.base,co+=k.top}0!==Me?y(wi,Wr.x+Jr[0]*bi*Qr,Wr.y+Jr[1]*bi*Qr,Wr.z+Jr[2]*bi*Qr):y(wi,Wr.x,Wr.y,Wr.z),y(Mi,Wr.x+Jr[0]*bi*co,Wr.y+Jr[1]*bi*co,Wr.z+Jr[2]*bi*co),aa.vec3.transformMat4(wi,wi,Fe),aa.vec3.transformMat4(Mi,Mi,Fe),F.push(new dh(wi[0],wi[1],wi[2])),Ur.push(new dh(Mi[0],Mi[1],Mi[2]))}xi.push(F),vi.push(Ur)}return[xi,vi]}(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut):je?function(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=[],Ut=[],xi=[0,0,0,1];for(const vi of k){const k=[],bi=[];for(const vt of vi){const Ut=vt.x+Ae.x,vi=vt.y+Ae.y,wi=pp(Ut,vi,F,Me,Fe,je,qe,pt);xi[0]=Ut,xi[1]=vi,xi[2]=wi.base,xi[3]=1,aa.vec4.transformMat4(xi,xi,Oe),xi[3]=Math.max(xi[3],1e-5);const Mi=new dh(xi[0]/xi[3],xi[1]/xi[3],xi[2]/xi[3]);xi[0]=Ut,xi[1]=vi,xi[2]=wi.top,xi[3]=1,aa.vec4.transformMat4(xi,xi,Oe),xi[3]=Math.max(xi[3],1e-5);const pr=new dh(xi[0]/xi[3],xi[1]/xi[3],xi[2]/xi[3]);k.push(Mi),bi.push(pr)}vt.push(k),Ut.push(bi)}return[vt,Ut]}(F,Me,Ae,Oe,Fe,je,qe,pt,vt):function(k,F,Me,Ae,Oe){const Fe=[],je=[],qe=Oe[8]*F,pt=Oe[9]*F,vt=Oe[10]*F,Ut=Oe[11]*F,xi=Oe[8]*Me,vi=Oe[9]*Me,bi=Oe[10]*Me,wi=Oe[11]*Me;for(const F of k){const k=[],Me=[];for(const Fe of F){const F=Fe.x+Ae.x,je=Fe.y+Ae.y,Mi=Oe[0]*F+Oe[4]*je+Oe[12],pr=Oe[1]*F+Oe[5]*je+Oe[13],Ur=Oe[2]*F+Oe[6]*je+Oe[14],Wr=Oe[3]*F+Oe[7]*je+Oe[15],Jr=Mi+qe,Qr=pr+pt,co=Ur+vt,mo=Math.max(Wr+Ut,1e-5),yo=Mi+xi,To=pr+vi,zo=Ur+bi,ko=Math.max(Wr+wi,1e-5);k.push(new dh(Jr/mo,Qr/mo,co/mo)),Me.push(new dh(yo/ko,To/ko,zo/ko))}Fe.push(k),je.push(Me)}return[Fe,je]}(F,Me,Ae,Oe,Fe)}(Fe,Ae,xi,Ut,vt,je,pr,vi,wi,Fe.center.lat,k.tileID.canonical),Jr=k.queryGeometry;return function(k,F,Me){let Ae=1/0;Dl(Me,F)&&(Ae=hp(Me,F[0]));for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe],je=k[Oe];for(let k=0;k<Fe.length-1;k++){const F=Fe[k],Oe=[F,Fe[k+1],je[k+1],je[k],F];Vl(Me,Oe)&&(Ae=Math.min(Ae,hp(Me,Oe)))}}return Ae!==1/0&&Ae}(Ur,Wr,Jr.isPointQuery()?Jr.screenBounds:Jr.screenGeometry)}},line:class extends ps{constructor(k,F,Me,Ae){const Oe=Dp();super(k,Oe,F,Me,Ae),Oe.layout&&(this.layout=new Ua(Oe.layout)),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(k){if("line-gradient"===k){const k=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=k._styleExpression&&k._styleExpression.expression instanceof Nn,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(k,F){super.recalculate(k,F),this.paint._values["line-floorwidth"]=(()=>{if(Wg)return Wg;const k=Dp();return Wg=new Lp(k.paint.properties["line-width"].specification),Wg.useIntegerZoom=!0,Wg})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,k)}createBucket(k){return new Ap(k)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(k,F,Me){const Ae=Bp(this);return{config:new Oo(this,{zoom:F,lut:Me}),defines:Ae,overrideFog:!1}}queryRadius(k){const F=k,Me=Fp(Xl("line-width",this,F),Xl("line-gap-width",this,F)),Ae=Xl("line-offset",this,F);return Me/2+Math.abs(Ae)+Zl(this.paint.get("line-translate"))}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe){if(k.queryGeometry.isAboveHorizon)return!1;const je=Hl(k.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),Fe.angle,k.pixelToTileUnitsFactor),qe=k.pixelToTileUnitsFactor/2*Fp(this.paint.get("line-width").evaluate(F,Me),this.paint.get("line-gap-width").evaluate(F,Me)),pt=this.paint.get("line-offset").evaluate(F,Me);return pt&&(Ae=function(k,F){const Me=[],Ae=new Sa(0,0);for(let Oe=0;Oe<k.length;Oe++){const Fe=k[Oe],je=[];for(let k=0;k<Fe.length;k++){const Me=Fe[k],Oe=Fe[k+1],qe=0===k?Ae:Me.sub(Fe[k-1])._unit()._perp(),pt=k===Fe.length-1?Ae:Oe.sub(Me)._unit()._perp(),vt=qe._add(pt)._unit();vt._mult(1/(vt.x*pt.x+vt.y*pt.y)),je.push(vt._mult(F)._add(Me))}Me.push(je)}return Me}(Ae,pt*k.pixelToTileUnitsFactor)),function(k,F,Me){for(let Ae=0;Ae<F.length;Ae++){const Oe=F[Ae];if(k.length>=3)for(let F=0;F<Oe.length;F++)if(jl(k,Oe[F]))return!0;if(Ll(k,Oe,Me))return!0}return!1}(je,Ae,qe)}isTileClipped(){return!0}isDraped(k){const F=this.layout.get("line-z-offset"),Me=F.isConstant()&&!F.constantOr(0),Ae=this.layout.get("line-elevation-reference");return!("sea"===Ae||"ground"===Ae)&&(Me||"none"!==Ae)}},symbol:sm,background:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:Lx||(Lx=new Ga({visibility:new ja(Xp.layout_background.visibility)})),paint:Ox||(Ox=new Ga({"background-pitch-alignment":new ja(Xp.paint_background["background-pitch-alignment"]),"background-color":new ja(Xp.paint_background["background-color"]),"background-pattern":new ja(Xp.paint_background["background-pattern"]),"background-opacity":new ja(Xp.paint_background["background-opacity"]),"background-emissive-strength":new ja(Xp.paint_background["background-emissive-strength"]),"background-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(k,F,Me){return{overrideFog:!1}}is3D(){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:_m,"raster-particle":Pm,sky:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:pv||(pv=new Ga({visibility:new ja(Xp.layout_sky.visibility)})),paint:_v||(_v=new Ga({"sky-type":new ja(Xp.paint_sky["sky-type"]),"sky-atmosphere-sun":new ja(Xp.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ja(Xp.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ja(Xp.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ja(Xp.paint_sky["sky-gradient-radius"]),"sky-gradient":new $a(Xp.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ja(Xp.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ja(Xp.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ja(Xp.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(k){"sky-gradient"===k?this._updateColorRamp():"sky-atmosphere-sun"!==k&&"sky-atmosphere-halo-color"!==k&&"sky-atmosphere-color"!==k&&"sky-atmosphere-sun-intensity"!==k||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=lc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(k){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const F=k.style.light.properties.get("position");return this._lightPosition.azimuthal!==F.azimuthal||this._lightPosition.polar!==F.polar}return!1}getCenter(k,F){if("atmosphere"===this.paint.get("sky-type")){const Me=this.paint.get("sky-atmosphere-sun"),Ae=!Me,Oe=k.style.light,Fe=Oe.properties.get("position");return Ae&&"viewport"===Oe.properties.get("anchor")&&ft("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),Ae?Em(Fe.azimuthal,90-Fe.polar,F):Em(Me[0],90-Me[1],F)}const Me=this.paint.get("sky-gradient-center");return Em(Me[0],90-Me[1],F)}isSky(){return!0}markSkyboxValid(k){this._skyboxInvalidated=!1,this._lightPosition=k.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const k=this.paint.get("sky-type");return"atmosphere"===k?["skyboxCapture","skybox"]:"gradient"===k?["skyboxGradient"]:null}},slot:class extends ps{constructor(k,F,Me,Ae){super(k,{paint:vv||(vv=new Ga({}))},F,null)}},model:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:zv||(zv=new Ga({visibility:new ja(Xp.layout_model.visibility),"model-id":new qa(Xp.layout_model["model-id"])})),paint:Pv||(Pv=new Ga({"model-opacity":new qa(Xp.paint_model["model-opacity"]),"model-rotation":new qa(Xp.paint_model["model-rotation"]),"model-scale":new qa(Xp.paint_model["model-scale"]),"model-translation":new qa(Xp.paint_model["model-translation"]),"model-color":new qa(Xp.paint_model["model-color"]),"model-color-mix-intensity":new qa(Xp.paint_model["model-color-mix-intensity"]),"model-type":new ja(Xp.paint_model["model-type"]),"model-cast-shadows":new ja(Xp.paint_model["model-cast-shadows"]),"model-receive-shadows":new ja(Xp.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ja(Xp.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new qa(Xp.paint_model["model-emissive-strength"]),"model-roughness":new qa(Xp.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new qa(Xp.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ja(Xp.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ja(Xp.paint_model["model-front-cutoff"]),"model-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},F,Me,Ae),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(k){return new Jm(k)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(k){return k instanceof yy?Td-1:0}queryIntersectsFeature(k,F,Me,Ae,Oe,Fe){if(!this.modelManager)return!1;const je=this.modelManager,qe=k.tile.getBucket(this);if(!(qe&&qe instanceof Jm))return!1;for(const Me in qe.instancesPerModel){const Ae=qe.instancesPerModel[Me],Oe=void 0!==F.id?F.id:F.properties&&F.properties.hasOwnProperty("id")?F.properties.id:void 0;if(Ae.idToFeaturesIndex.hasOwnProperty(Oe)){const F=Ae.features[Ae.idToFeaturesIndex[Oe]],pt=je.getModel(Me,this.scope);if(!pt)return!1;let vt=aa.mat4.create();const Ut=new il(0,0),xi=qe.canonical;let vi=Number.MAX_VALUE;for(let Me=0;Me<F.instancedDataCount;++Me){const Oe=16*(F.instancedDataOffset+Me),je=Ae.instancedDataArray.float32,qe=[je[Oe+4],je[Oe+5],je[Oe+6]];by(xi,Ut,je[Oe],0|je[Oe+1]),ny(vt,pt,Fe,Ut,F.rotation,F.scale,qe,!1,!1,!1),"globe"===Fe.projection.name&&(vt=Fm(vt,Fe));const bi=aa.mat4.multiply([],Fe.projMatrix,vt),wi=k.queryGeometry,Mi=Om(wi.isPointQuery()?wi.screenBounds:wi.screenGeometry,Fe,bi,pt.aabb);null!=Mi&&(vi=Math.min(Mi,vi))}return vi!==Number.MAX_VALUE&&vi}}return!1}_handleOverridablePaintPropertyUpdate(k,F,Me){return!(!this.layout||F.isDataDriven()||Me.isDataDriven()||"model-color"!==k&&"model-color-mix-intensity"!==k&&"model-rotation"!==k&&"model-scale"!==k&&"model-translation"!==k&&"model-emissive-strength"!==k)}_isPropertyZoomDependent(k){const F=this._transitionablePaint._values[k];return null!=F&&null!=F.value&&null!=F.value.expression&&F.value.expression instanceof Ji}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ps{constructor(k,F,Me,Ae){super(k,{layout:f_||(f_=new Ga({"clip-layer-types":new ja(Xp.layout_clip["clip-layer-types"]),"clip-layer-scope":new ja(Xp.layout_clip["clip-layer-scope"])})),paint:m_||(m_=new Ga({}))},F,Me,Ae)}recalculate(k,F){super.recalculate(k,F)}createBucket(k){return new Zc(k)}isTileClipped(){return!0}is3D(){return!0}}};class wy{constructor(k){this._callback=k,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class My{constructor(){this.tasks={},this.taskQueue=[],ot(["process"],this),this.invoker=new wy(this.process),this.nextId=0}add(k,F){const Me=this.nextId++,Ae=function({type:k,isSymbolTile:F,zoom:Me}){return Me=Me||0,"message"===k?0:"maybePrepare"!==k||F?"parseTile"!==k||F?"parseTile"===k&&F?300-Me:"maybePrepare"===k&&F?400-Me:500:200-Me:100-Me}(F);if(0===Ae){try{k()}finally{}return null}return this.tasks[Me]={fn:k,metadata:F,priority:Ae,id:Me},this.taskQueue.push(Me),this.invoker.trigger(),{cancel:()=>{delete this.tasks[Me]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((k=>!!this.tasks[k])),!this.taskQueue.length)return;const k=this.pick();if(null===k)return;const F=this.tasks[k];if(delete this.tasks[k],this.taskQueue.length&&this.invoker.trigger(),!F)return;F.fn()}finally{}}pick(){let k=null,F=1/0;for(let Me=0;Me<this.taskQueue.length;Me++){const Ae=this.tasks[this.taskQueue[Me]];Ae.priority<F&&(F=Ae.priority,k=Me)}if(null===k)return null;const Me=this.taskQueue[k];return this.taskQueue.splice(k,1),Me}remove(){this.invoker.remove()}}class Ay{constructor(k,F,Me){this.target=k,this.parent=F,this.mapId=Me,this.callbacks={},this.cancelCallbacks={},ot(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new My}send(k,F,Me,Ae,Oe=!1,Fe){const je=Math.round(1e18*Math.random()).toString(36).substring(0,10);Me&&(Me.metadata=Fe,this.callbacks[je]=Me);const qe=new Set;return this.target.postMessage({id:je,type:k,hasCallback:!!Me,targetMapId:Ae,mustQueue:Oe,sourceMapId:this.mapId,data:ca(F,qe)},qe),{cancel:()=>{Me&&delete this.callbacks[je],this.target.postMessage({id:je,type:"<cancel>",targetMapId:Ae,sourceMapId:this.mapId})}}}receive(k){const F=k.data,Me=F.id;if(Me&&(!F.targetMapId||this.mapId===F.targetMapId))if("<cancel>"===F.type){const k=this.cancelCallbacks[Me];delete this.cancelCallbacks[Me],k&&k.cancel()}else if(F.mustQueue||gt()){const k=this.callbacks[Me],Ae=this.scheduler.add((()=>this.processTask(Me,F)),k&&k.metadata||{type:"message"});Ae&&(this.cancelCallbacks[Me]=Ae)}else this.processTask(Me,F)}processTask(k,F){if(delete this.cancelCallbacks[k],"<response>"===F.type){const Me=this.callbacks[k];delete this.callbacks[k],Me&&(F.error?Me(ha(F.error)):Me(null,ha(F.data)))}else{const Me=new Set,Ae=F.hasCallback?(F,Ae)=>{this.target.postMessage({id:k,type:"<response>",sourceMapId:this.mapId,error:F?ca(F):null,data:ca(Ae,Me)},Me)}:()=>{},Oe=ha(F.data);if(this.parent[F.type])this.parent[F.type](F.sourceMapId,Oe,Ae);else if(this.parent.getWorkerSource){const k=F.type.split(".");this.parent.getWorkerSource(F.sourceMapId,k[0],Oe.source,Oe.scope)[k[1]](Oe,Ae)}else Ae(new Error(`Could not find function ${F.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Bv={workerUrl:"",workerClass:null,workerParams:void 0};const Nv="mapboxgl_preloaded_worker_pool";class Py{constructor(){this.active={}}acquire(k,F=Py.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<F;)this.workers.push(null!=Bv.workerClass?new Bv.workerClass:new self.Worker(Bv.workerUrl,Bv.workerParams));return this.active[k]=!0,this.workers.slice()}release(k){delete this.active[k],this.workers&&0===this.numActive()&&(this.workers.forEach((k=>{k.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Nv]}numActive(){return Object.keys(this.active).length}}Py.workerCount=2;class zy{constructor(k,F,Me="Worker",Ae=Py.workerCount){this.workerPool=k,this.actors=[],this.currentActor=0,this.id=at();const Oe=this.workerPool.acquire(this.id,Ae);for(let k=0;k<Oe.length;k++){const Ae=new zy.Actor(Oe[k],F,this.id);Ae.name=`${Me} ${k}`,this.actors.push(Ae)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(k,F,Me){rt(this.actors,((Me,Ae)=>{Me.send(k,F,Ae)}),Me=Me||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((k=>{k.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Vv,Uv;function Ty(){return Vv||(Vv=new Py),Vv}zy.Actor=Ay;const jv=new Ie(0,0,0);var Gv=(k=>(k[k.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",k[k.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",k[k.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",k))(Gv||{}),qv=(k=>(k[k.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",k[k.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",k[k.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",k[k.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",k))(qv||{}),Zv=(k=>(k[k.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",k[k.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",k[k.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",k[k.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",k[k.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",k))(Zv||{}),Hv=(k=>(k[k.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",k[k.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",k[k.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",k))(Hv||{}),$v=(k=>(k[k.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",k[k.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",k[k.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",k[k.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",k[k.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",k[k.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",k))($v||{}),Wv=(k=>(k[k.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",k[k.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",k[k.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",k))(Wv||{});function Oy(k,F,Me){1===k&&F.icons.push(function(k,F){return function(k){if(k.usvg_tree.height||(k.usvg_tree.height=k.usvg_tree.width),!k.metadata)return k;const{metadata:F}=k;if(F.content_area){const{content_area:Me}=F;null==Me.top&&(Me.top=Me.left),null==Me.width&&(Me.width=k.usvg_tree.width),null==Me.height&&(Me.height=Me.width)}return F.stretch_x&&F.stretch_x.length&&Ny(F,"x"),F.stretch_y&&F.stretch_y.length&&Ny(F,"y"),k}(k.readFields(Uy,{name:void 0},F))}(Me,Me.readVarint()+Me.pos))}function Ny(k,F){const Me=[],Ae=k[`stretch_${F}`];let Oe=null;for(let k=0;k<Ae.length;k++)null===Oe?Oe=0===Me.length?Ae[0]:Me[Me.length-1][1]+Ae[k]:(Me.push([Oe,Oe+Ae[k]]),Oe=null);k[`stretch_${F}_areas`]=Me}function Uy(k,F,Me){1===k?F.name=Me.readString():2===k?F.metadata=function(k,F){return k.readFields(jy,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},F)}(Me,Me.readVarint()+Me.pos):3===k&&(F.usvg_tree=function(k,F){return k.readFields(Gy,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},F)}(Me,Me.readVarint()+Me.pos),F.data="usvg_tree")}function jy(k,F,Me){1===k?F.stretch_x=Me.readPackedVarint():2===k?F.stretch_y=Me.readPackedVarint():3===k?F.content_area=function(k,F){return k.readFields(qy,{left:0},F)}(Me,Me.readVarint()+Me.pos):4===k&&F.variables.push(function(k,F){return k.readFields($y,{name:void 0},F)}(Me,Me.readVarint()+Me.pos))}function qy(k,F,Me){1===k?F.left=Me.readVarint():2===k?F.width=Me.readVarint():3===k?F.top=Me.readVarint():4===k&&(F.height=Me.readVarint())}function $y(k,F,Me){1===k?F.name=Me.readString():2===k&&(F.rgb_color=Qy(Me.readVarint()),F.value="rgb_color")}function Gy(k,F,Me){1===k?F.width=F.height=Me.readVarint():2===k?F.height=Me.readVarint():3===k?F.children.push(Yy(Me,Me.readVarint()+Me.pos)):4===k?F.linear_gradients.push(function(k,F){return k.readFields(eg,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},F)}(Me,Me.readVarint()+Me.pos)):5===k?F.radial_gradients.push(function(k,F){return k.readFields(ig,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},F)}(Me,Me.readVarint()+Me.pos)):7===k?F.clip_paths.push(function(k,F){return k.readFields(ag,{children:[]},F)}(Me,Me.readVarint()+Me.pos)):8===k&&F.masks.push(function(k,F){const Me=k.readFields(sg,{left:0,width:20,mask_type:1,children:[]},F);return null==Me.height&&(Me.height=Me.width),null==Me.top&&(Me.top=Me.left),Me}(Me,Me.readVarint()+Me.pos))}function Yy(k,F){return k.readFields(Xy,{},F)}function Xy(k,F,Me){1===k?(F.group=function(k,F){return k.readFields(Zy,{opacity:255,children:[]},F)}(Me,Me.readVarint()+Me.pos),F.node="group"):2===k&&(F.path=function(k,F){return k.readFields(Ky,{paint_order:1,commands:[],step:1,diffs:[],rule:1},F)}(Me,Me.readVarint()+Me.pos),F.node="path")}function Zy(k,F,Me){1===k?F.transform=Hy(Me,Me.readVarint()+Me.pos):2===k?F.opacity=Me.readVarint():5===k?F.clip_path_idx=Me.readVarint():6===k?F.mask_idx=Me.readVarint():7===k&&F.children.push(Yy(Me,Me.readVarint()+Me.pos))}function Hy(k,F){return k.readFields(Wy,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},F)}function Wy(k,F,Me){1===k?F.sx=Me.readFloat():2===k?F.ky=Me.readFloat():3===k?F.kx=Me.readFloat():4===k?F.sy=Me.readFloat():5===k?F.tx=Me.readFloat():6===k&&(F.ty=Me.readFloat())}function Ky(k,F,Me){1===k?F.fill=function(k,F){return k.readFields(Jy,{rgb_color:jv,paint:"rgb_color",opacity:255},F)}(Me,Me.readVarint()+Me.pos):2===k?F.stroke=function(k,F){return k.readFields(tg,{rgb_color:jv,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},F)}(Me,Me.readVarint()+Me.pos):3===k?F.paint_order=Me.readVarint():5===k?Me.readPackedVarint(F.commands):6===k?F.step=Me.readFloat():7===k?Me.readPackedSVarint(F.diffs):8===k&&(F.rule=Me.readVarint())}function Jy(k,F,Me){1===k?(F.rgb_color=Qy(Me.readVarint()),F.paint="rgb_color"):2===k?(F.linear_gradient_idx=Me.readVarint(),F.paint="linear_gradient_idx"):3===k?(F.radial_gradient_idx=Me.readVarint(),F.paint="radial_gradient_idx"):5===k&&(F.opacity=Me.readVarint())}function Qy(k){return new Ie((k>>16&255)/255,(k>>8&255)/255,(255&k)/255,1)}function tg(k,F,Me){1===k?(F.rgb_color=Qy(Me.readVarint()),F.paint="rgb_color"):2===k?(F.linear_gradient_idx=Me.readVarint(),F.paint="linear_gradient_idx"):3===k?(F.radial_gradient_idx=Me.readVarint(),F.paint="radial_gradient_idx"):5===k?Me.readPackedFloat(F.dasharray):6===k?F.dashoffset=Me.readFloat():7===k?F.miterlimit=Me.readFloat():8===k?F.opacity=Me.readVarint():9===k?F.width=Me.readFloat():10===k?F.linecap=Me.readVarint():11===k&&(F.linejoin=Me.readVarint())}function eg(k,F,Me){1===k?F.transform=Hy(Me,Me.readVarint()+Me.pos):2===k?F.spread_method=Me.readVarint():3===k?F.stops.push(rg(Me,Me.readVarint()+Me.pos)):4===k?F.x1=Me.readFloat():5===k?F.y1=Me.readFloat():6===k?F.x2=Me.readFloat():7===k&&(F.y2=Me.readFloat())}function rg(k,F){return k.readFields(ng,{offset:0,opacity:255,rgb_color:jv},F)}function ng(k,F,Me){1===k?F.offset=Me.readFloat():2===k?F.opacity=Me.readVarint():3===k&&(F.rgb_color=Qy(Me.readVarint()))}function ig(k,F,Me){1===k?F.transform=Hy(Me,Me.readVarint()+Me.pos):2===k?F.spread_method=Me.readVarint():3===k?F.stops.push(rg(Me,Me.readVarint()+Me.pos)):4===k?F.cx=Me.readFloat():5===k?F.cy=Me.readFloat():6===k?F.r=Me.readFloat():7===k?F.fx=Me.readFloat():8===k?F.fy=Me.readFloat():9===k&&(F.fr=Me.readFloat())}function ag(k,F,Me){1===k?F.transform=Hy(Me,Me.readVarint()+Me.pos):2===k?F.clip_path_idx=Me.readVarint():3===k&&F.children.push(Yy(Me,Me.readVarint()+Me.pos))}function sg(k,F,Me){1===k?F.left=F.top=Me.readFloat():2===k?F.width=F.height=Me.readFloat():3===k?F.top=Me.readFloat():4===k?F.height=Me.readFloat():5===k?F.mask_type=Me.readVarint():6===k?F.mask_idx=Me.readVarint():7===k&&F.children.push(Yy(Me,Me.readVarint()+Me.pos))}class og{static calculate(k,F){const Me=new Map,Ae=new Map;if(0===Object.keys(k).length)return Me;F.forEach((k=>{Ae.set(k.name,k.rgb_color||new Ie(0,0,0))}));for(const[F,Oe]of Object.entries(k))Ae.has(F)?Me.set(Ae.get(F).toStringPremultipliedAlpha(),Oe):console.warn(`Ignoring unknown image variable "${F}"`);return Me}}function lg(k,F=255,Me){const Ae=F/255,Oe=k.toStringPremultipliedAlpha(),Fe=Me.has(Oe)?Me.get(Oe).clone():k.clone();return Fe.a=Ae,Fe.toString()}function ug(k,F){if(!Ct()){const Me=document.createElement("canvas");return Me.width=k,Me.height=F,Me}return new OffscreenCanvas(k,F)}function cg(k,F){const Me=og.calculate(F.params,k.metadata?k.metadata.variables:[]),Ae=k.usvg_tree,Oe=Ae.width,Fe=Ae.height,je=F.transform?F.transform:new DOMMatrix,qe=Math.max(1,Math.round(Oe*je.a)),pt=Math.max(1,Math.round(Fe*je.d)),vt=new DOMMatrix([qe/Oe,0,0,pt/Fe,0,0]),Ut=ug(qe,pt).getContext("2d");return hg(Ut,vt,Ae,Ae,Me),Ut.getImageData(0,0,qe,pt)}function hg(k,F,Me,Ae,Oe){for(const Fe of Ae.children)pg(k,F,Me,Fe,Oe)}function pg(k,F,Me,Ae,Oe){Ae.group?(k.save(),function(k,F,Me,Ae,Oe){const Fe=null!=Ae.mask_idx?Me.masks[Ae.mask_idx]:null,je=null!=Ae.clip_path_idx?Me.clip_paths[Ae.clip_path_idx]:null;if(Ae.transform&&(F=vg(Ae.transform).preMultiplySelf(F)),!function(k,F,Me){return 255!==k.opacity||F||Me}(Ae,null!=je,null!=Fe))return void hg(k,F,Me,Ae,Oe);const qe=ug(k.canvas.width,k.canvas.height),pt=qe.getContext("2d");je&&gg(pt,F,Me,je),hg(pt,F,Me,Ae,Oe),Fe&&xg(pt,F,Me,Fe,Oe),k.globalAlpha=Ae.opacity/255,k.drawImage(qe,0,0)}(k,F,Me,Ae.group,Oe),k.restore()):Ae.path&&(k.save(),function(k,F,Me,Ae,Oe){const Fe=bg(Ae);k.setTransform(F),Ae.paint_order===Hv.PAINT_ORDER_FILL_AND_STROKE?(fg(k,Me,Ae,Fe,Oe),dg(k,Me,Ae,Fe,Oe)):(dg(k,Me,Ae,Fe,Oe),fg(k,Me,Ae,Fe,Oe))}(k,F,Me,Ae.path,Oe),k.restore())}function fg(k,F,Me,Ae,Oe){const Fe=Me.fill;if(!Fe)return;const je=Fe.opacity/255;switch(Fe.paint){case"rgb_color":k.fillStyle=lg(Fe.rgb_color,Fe.opacity,Oe);break;case"linear_gradient_idx":k.fillStyle=mg(k,F.linear_gradients[Fe.linear_gradient_idx],je,Oe);break;case"radial_gradient_idx":k.fillStyle=yg(k,F.radial_gradients[Fe.radial_gradient_idx],je,Oe)}let qe;switch(Me.rule){case Gv.PATH_RULE_NON_ZERO:qe="nonzero";break;case Gv.PATH_RULE_EVEN_ODD:qe="evenodd"}k.fill(Ae,qe)}function dg(k,F,Me,Ae,Oe){const Fe=Me.stroke;if(!Fe)return;k.lineWidth=Fe.width,k.miterLimit=Fe.miterlimit,k.setLineDash(Fe.dasharray),k.lineDashOffset=Fe.dashoffset;const je=Fe.opacity/255;switch(Fe.paint){case"rgb_color":k.strokeStyle=lg(Fe.rgb_color,Fe.opacity,Oe);break;case"linear_gradient_idx":k.strokeStyle=mg(k,F.linear_gradients[Fe.linear_gradient_idx],je,Oe);break;case"radial_gradient_idx":k.strokeStyle=yg(k,F.radial_gradients[Fe.radial_gradient_idx],je,Oe)}switch(Fe.linejoin){case Zv.LINE_JOIN_MITER_CLIP:case Zv.LINE_JOIN_MITER:k.lineJoin="miter";break;case Zv.LINE_JOIN_ROUND:k.lineJoin="round";break;case Zv.LINE_JOIN_BEVEL:k.lineJoin="bevel"}switch(Fe.linecap){case qv.LINE_CAP_BUTT:k.lineCap="butt";break;case qv.LINE_CAP_ROUND:k.lineCap="round";break;case qv.LINE_CAP_SQUARE:k.lineCap="square"}k.stroke(Ae)}function mg(k,F,Me,Ae){if(1===F.stops.length){const k=F.stops[0];return lg(k.rgb_color,k.opacity*Me,Ae)}const Oe=vg(F.transform),{x1:Fe,y1:je,x2:qe,y2:pt}=F,vt=Oe.transformPoint(new DOMPoint(Fe,je)),Ut=Oe.transformPoint(new DOMPoint(qe,pt)),xi=k.createLinearGradient(vt.x,vt.y,Ut.x,Ut.y);for(const k of F.stops)xi.addColorStop(k.offset,lg(k.rgb_color,k.opacity*Me,Ae));return xi}function yg(k,F,Me,Ae){if(1===F.stops.length){const k=F.stops[0];return lg(k.rgb_color,k.opacity*Me,Ae)}const Oe=vg(F.transform),{fx:Fe,fy:je,cx:qe,cy:pt}=F,vt=Oe.transformPoint(new DOMPoint(Fe,je)),Ut=Oe.transformPoint(new DOMPoint(qe,pt)),xi=k.createRadialGradient(vt.x,vt.y,0,Ut.x,Ut.y,F.r*((Oe.a+Oe.d)/2));for(const k of F.stops)xi.addColorStop(k.offset,lg(k.rgb_color,k.opacity*Me,Ae));return xi}function gg(k,F,Me,Ae){const Oe=vg(Ae.transform).preMultiplySelf(F),Fe=null!=Ae.clip_path_idx?Me.clip_paths[Ae.clip_path_idx]:null;Fe&&gg(k,Oe,Me,Fe);const je=new Path2D;let qe;function l(k,F){if(k.path){const Me=k.path;je.addPath(bg(Me),F),Me.rule===Gv.PATH_RULE_EVEN_ODD&&(qe="evenodd")}else if(k.group){const Me=k.group.transform?vg(k.group.transform).preMultiplySelf(F):F;for(const F of k.group.children)l(F,Me)}}for(const k of Ae.children)l(k,Oe);k.clip(je,qe)}function xg(k,F,Me,Ae,Oe){if(0===Ae.children.length)return;const Fe=null!=Ae.mask_idx?Me.masks[Ae.mask_idx]:null;Fe&&xg(k,F,Me,Fe,Oe);const je=k.canvas.width,qe=k.canvas.height,pt=ug(je,qe),vt=pt.getContext("2d"),Ut=Ae.width,xi=Ae.height,vi=Ae.left,bi=Ae.top,wi=new Path2D,Mi=new Path2D;Mi.rect(vi,bi,Ut,xi),wi.addPath(Mi,F),vt.clip(wi);for(const k of Ae.children)pg(vt,F,Me,k,Oe);const pr=vt.getImageData(0,0,je,qe),Ur=pr.data;if(Ae.mask_type===Wv.MASK_TYPE_LUMINANCE)for(let k=0;k<Ur.length;k+=4)Ur[k+3]=Ur[k+3]/255*(.2126*Ur[k]+.7152*Ur[k+1]+.0722*Ur[k+2]);vt.putImageData(pr,0,0),k.globalCompositeOperation="destination-in",k.drawImage(pt,0,0)}function vg(k){return k?new DOMMatrix([k.sx,k.ky,k.kx,k.sy,k.tx,k.ty]):new DOMMatrix}function bg(k){const F=new Path2D,Me=k.step;let Ae=k.diffs[0]*Me,Oe=k.diffs[1]*Me;F.moveTo(Ae,Oe);for(let Fe=0,je=2;Fe<k.commands.length;Fe++)switch(k.commands[Fe]){case $v.PATH_COMMAND_MOVE:Ae+=k.diffs[je++]*Me,Oe+=k.diffs[je++]*Me,F.moveTo(Ae,Oe);break;case $v.PATH_COMMAND_LINE:Ae+=k.diffs[je++]*Me,Oe+=k.diffs[je++]*Me,F.lineTo(Ae,Oe);break;case $v.PATH_COMMAND_QUAD:{const Fe=Ae+k.diffs[je++]*Me,qe=Oe+k.diffs[je++]*Me;Ae=Fe+k.diffs[je++]*Me,Oe=qe+k.diffs[je++]*Me,F.quadraticCurveTo(Fe,qe,Ae,Oe);break}case $v.PATH_COMMAND_CUBIC:{const Fe=Ae+k.diffs[je++]*Me,qe=Oe+k.diffs[je++]*Me,pt=Fe+k.diffs[je++]*Me,vt=qe+k.diffs[je++]*Me;Ae=pt+k.diffs[je++]*Me,Oe=vt+k.diffs[je++]*Me,F.bezierCurveTo(Fe,qe,pt,vt,Ae,Oe);break}case $v.PATH_COMMAND_CLOSE:F.closePath()}return F}class _g{constructor(k){this.capacity=k,this.cache=new Map}get(k){if(!this.cache.has(k))return;const F=this.cache.get(k);return this.cache.delete(k),this.cache.set(k,F),F}put(k,F){this.cache.has(k)?this.cache.delete(k):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(k,F)}delete(k){this.cache.delete(k)}}class wg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(k){return new sc(k,k.data)}getFromCache(k,F,Me){return this.cacheMap.has(Me)||this.cacheMap.set(Me,new _g(150)),this.cacheMap.get(Me).get(us(k.serialize(),F))}setInCache(k,F,Me,Ae){this.cacheDependenciesMap.has(Ae)||this.cacheDependenciesMap.set(Ae,new Map),this.cacheMap.has(Ae)||this.cacheMap.set(Ae,new _g(150));const Oe=this.cacheDependenciesMap.get(Ae);Oe.get(us(k.id,Me))||Oe.set(us(k.id,Me),new Set);const Fe=this.cacheMap.get(Ae),je=k.serialize();Oe.get(us(k.id,Me)).add(je),Fe.put(us(k.serialize(),Me),F)}removeImagesFromCacheByIds(k,F,Me=""){if(!this.cacheMap.has(Me)||!this.cacheDependenciesMap.has(Me))return;const Ae=this.cacheMap.get(Me),Oe=this.cacheDependenciesMap.get(Me);for(const Me of k)if(Oe.has(us(Me,F))){for(const k of Oe.get(us(Me,F)))Ae.delete(k);Oe.delete(us(Me,F))}}rasterize(k,F,Me,Ae,Oe=cg){const Fe=this.getFromCache(k,Me,Ae);if(Fe)return Fe.clone();const je=Oe(F.icon,k.options),qe=wg._getImage(je);return this.setInCache(k,qe,Me,Ae),qe.clone()}}class Mg{constructor(k){this.size=k,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(k,F){const Me=this.toIdx(k,F);return{min:this.minimums[Me],max:this.maximums[Me]}}isLeaf(k,F){return this.leaves[this.toIdx(k,F)]}toIdx(k,F){return F*this.size+k}}function Ag(k,F,Me,Ae){let Oe=0,Fe=Number.MAX_VALUE;for(let je=0;je<3;je++)if(Math.abs(Ae[je])<1e-15){if(Me[je]<k[je]||Me[je]>F[je])return null}else{const qe=1/Ae[je];let pt=(k[je]-Me[je])*qe,vt=(F[je]-Me[je])*qe;if(pt>vt){const k=pt;pt=vt,vt=k}if(pt>Oe&&(Oe=pt),vt<Fe&&(Fe=vt),Oe>Fe)return null}return Oe}function Sg(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut){const xi=Ae-k,vi=Oe-F,bi=Fe-Me,wi=je-k,Mi=qe-F,pr=pt-Me,Ur=Ut[1]*pr-Ut[2]*Mi,Wr=Ut[2]*wi-Ut[0]*pr,Jr=Ut[0]*Mi-Ut[1]*wi,Qr=xi*Ur+vi*Wr+bi*Jr;if(Math.abs(Qr)<1e-15)return null;const co=1/Qr,mo=vt[0]-k,yo=vt[1]-F,To=vt[2]-Me,zo=(mo*Ur+yo*Wr+To*Jr)*co;if(zo<0||zo>1)return null;const ko=yo*bi-To*vi,na=To*xi-mo*bi,aa=mo*vi-yo*xi,_a=(Ut[0]*ko+Ut[1]*na+Ut[2]*aa)*co;return _a<0||zo+_a>1?null:(wi*ko+Mi*na+pr*aa)*co}function Ig(k,F,Me){return(k-F)/(Me-F)}function Pg(k,F,Me,Ae,Oe,Fe,je,qe,pt){const vt=1<<Me,Ut=Fe-Ae,xi=je-Oe,vi=(k+1)/vt*Ut+Ae,bi=(F+0)/vt*xi+Oe,wi=(F+1)/vt*xi+Oe;qe[0]=(k+0)/vt*Ut+Ae,qe[1]=bi,pt[0]=vi,pt[1]=wi}class zg{constructor(k){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=k,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const F=function(k){const F=Math.ceil(Math.log2(k.dim/8)),Me=[];let Ae=Math.ceil(Math.pow(2,F));const Oe=1/Ae,a=(k,F,Me,Ae,Oe)=>{const Fe=Ae?1:0,je=(k+1)*Me-Fe,qe=F*Me,pt=(F+1)*Me-Fe;Oe[0]=k*Me,Oe[1]=qe,Oe[2]=je,Oe[3]=pt};let Fe=new Mg(Ae);const je=[];for(let F=0;F<Ae*Ae;F++){a(F%Ae,Math.floor(F/Ae),Oe,!1,je);const Me=kg(je[0],je[1],k),qe=kg(je[2],je[1],k),pt=kg(je[2],je[3],k),vt=kg(je[0],je[3],k);Fe.minimums.push(Math.min(Me,qe,pt,vt)),Fe.maximums.push(Math.max(Me,qe,pt,vt)),Fe.leaves.push(1)}for(Me.push(Fe),Ae/=2;Ae>=1;Ae/=2){const k=Me[Me.length-1];Fe=new Mg(Ae);for(let F=0;F<Ae*Ae;F++){a(F%Ae,Math.floor(F/Ae),2,!0,je);const Me=k.getElevation(je[0],je[1]),Oe=k.getElevation(je[2],je[1]),qe=k.getElevation(je[2],je[3]),pt=k.getElevation(je[0],je[3]),vt=k.isLeaf(je[0],je[1]),Ut=k.isLeaf(je[2],je[1]),xi=k.isLeaf(je[2],je[3]),vi=k.isLeaf(je[0],je[3]),bi=Math.min(Me.min,Oe.min,qe.min,pt.min),wi=Math.max(Me.max,Oe.max,qe.max,pt.max),Mi=vt&&Ut&&xi&&vi;Fe.maximums.push(wi),Fe.minimums.push(bi),Fe.leaves.push(wi-bi<=5&&Mi?1:0)}Me.push(Fe)}return Me}(this.dem),Me=F.length-1,Ae=F[Me];this._addNode(Ae.minimums[0],Ae.maximums[0],Ae.leaves[0]),this._construct(F,0,0,Me,0)}raycastRoot(k,F,Me,Ae,Oe,Fe,je=1){return Ag([k,F,-100],[Me,Ae,this.maximums[0]*je],Oe,Fe)}raycast(k,F,Me,Ae,Oe,Fe,je=1){if(!this.nodeCount)return null;const qe=this.raycastRoot(k,F,Me,Ae,Oe,Fe,je);if(null==qe)return null;const pt=[],vt=[],Ut=[],xi=[],vi=[{idx:0,t:qe,nodex:0,nodey:0,depth:0}];for(;vi.length>0;){const{idx:qe,t:bi,nodex:wi,nodey:Mi,depth:pr}=vi.pop();if(this.leaves[qe]){Pg(wi,Mi,pr,k,F,Me,Ae,Ut,xi);const qe=1<<pr,pt=(wi+0)/qe,vt=(wi+1)/qe,vi=(Mi+0)/qe,Ur=(Mi+1)/qe,Wr=kg(pt,vi,this.dem)*je,Jr=kg(vt,vi,this.dem)*je,Qr=kg(vt,Ur,this.dem)*je,co=kg(pt,Ur,this.dem)*je,mo=Sg(Ut[0],Ut[1],Wr,xi[0],Ut[1],Jr,xi[0],xi[1],Qr,Oe,Fe),yo=Sg(xi[0],xi[1],Qr,Ut[0],xi[1],co,Ut[0],Ut[1],Wr,Oe,Fe),To=Math.min(null!==mo?mo:Number.MAX_VALUE,null!==yo?yo:Number.MAX_VALUE);if(To!==Number.MAX_VALUE)return To;{const k=aa.vec3.scaleAndAdd([],Oe,Fe,bi);if(Eg(Wr,Jr,co,Qr,Ig(k[0],Ut[0],xi[0]),Ig(k[1],Ut[1],xi[1]))>=k[2])return bi}continue}let Ur=0;for(let vi=0;vi<this._siblingOffset.length;vi++){Pg((wi<<1)+this._siblingOffset[vi][0],(Mi<<1)+this._siblingOffset[vi][1],pr+1,k,F,Me,Ae,Ut,xi),Ut[2]=-100,xi[2]=this.maximums[this.childOffsets[qe]+vi]*je;const bi=Ag(Ut,xi,Oe,Fe);if(null!=bi){const k=bi;pt[vi]=k;let F=!1;for(let Me=0;Me<Ur&&!F;Me++)k>=pt[vt[Me]]&&(vt.splice(Me,0,vi),F=!0);F||(vt[Ur]=vi),Ur++}}for(let k=0;k<Ur;k++){const F=vt[k];vi.push({idx:this.childOffsets[qe]+F,t:pt[F],nodex:(wi<<1)+this._siblingOffset[F][0],nodey:(Mi<<1)+this._siblingOffset[F][1],depth:pr+1})}}return null}_addNode(k,F,Me){return this.minimums.push(k),this.maximums.push(F),this.leaves.push(Me),this.childOffsets.push(0),this.nodeCount++}_construct(k,F,Me,Ae,Oe){if(1===k[Ae].isLeaf(F,Me))return;this.childOffsets[Oe]||(this.childOffsets[Oe]=this.nodeCount);const Fe=Ae-1,je=k[Fe];let qe=0,pt=0;for(let k=0;k<this._siblingOffset.length;k++){const Ae=2*F+this._siblingOffset[k][0],Oe=2*Me+this._siblingOffset[k][1],Fe=je.getElevation(Ae,Oe),vt=je.isLeaf(Ae,Oe),Ut=this._addNode(Fe.min,Fe.max,vt);vt&&(qe|=1<<k),pt||(pt=Ut)}for(let Ae=0;Ae<this._siblingOffset.length;Ae++)qe&1<<Ae||this._construct(k,2*F+this._siblingOffset[Ae][0],2*Me+this._siblingOffset[Ae][1],Fe,pt+Ae)}}function Eg(k,F,Me,Ae,Oe,Fe){return ze(ze(k,Me,Fe),ze(F,Ae,Fe),Oe)}function kg(k,F,Me){const Ae=Me.dim,Oe=Q(k*Ae-.5,0,Ae-1),Fe=Q(F*Ae-.5,0,Ae-1),je=Math.floor(Oe),qe=Math.floor(Fe),pt=Math.min(je+1,Ae-1),vt=Math.min(qe+1,Ae-1);return Eg(Me.get(je,qe),Me.get(pt,qe),Me.get(je,vt),Me.get(pt,vt),Oe-je,Fe-qe)}const Xv={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Bg(k,F,Me){return(256*k*256+256*F+Me)/10-1e4}function Vg(k,F,Me){return 256*k+F+Me/256-32768}class Cg{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(k,F,Me,Ae=!1){if(this.uid=k,F.height!==F.width)throw new RangeError("DEM tiles must be square");if(Me&&"mapbox"!==Me&&"terrarium"!==Me)return void ft(`"${Me}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=F.height;const Oe=this.dim=F.height-2,Fe=new Uint32Array(F.data.buffer);if(this.pixels=new Uint8Array(F.data.buffer),this.floatView=new Float32Array(F.data.buffer),this.borderReady=Ae,this._modifiedForSources={},!Ae){for(let k=0;k<Oe;k++)Fe[this._idx(-1,k)]=Fe[this._idx(0,k)],Fe[this._idx(Oe,k)]=Fe[this._idx(Oe-1,k)],Fe[this._idx(k,-1)]=Fe[this._idx(k,0)],Fe[this._idx(k,Oe)]=Fe[this._idx(k,Oe-1)];Fe[this._idx(-1,-1)]=Fe[this._idx(0,0)],Fe[this._idx(Oe,-1)]=Fe[this._idx(Oe-1,0)],Fe[this._idx(-1,Oe)]=Fe[this._idx(0,Oe-1)],Fe[this._idx(Oe,Oe)]=Fe[this._idx(Oe-1,Oe-1)]}const je="terrarium"===Me?Vg:Bg;for(let k=0;k<Fe.length;++k){const F=4*k;this.floatView[k]=je(this.pixels[F],this.pixels[F+1],this.pixels[F+2])}this._timestamp=Gc.now()}_buildQuadTree(){this._tree=new zg(this)}get(k,F,Me=!1){Me&&(k=Q(k,-1,this.dim),F=Q(F,-1,this.dim));const Ae=this._idx(k,F);return this.floatView[Ae]}set(k,F,Me){const Ae=this._idx(k,F),Oe=this.floatView[Ae];return this.floatView[Ae]=Me,Me-Oe}static getUnpackVector(k){return Xv[k]}_idx(k,F){if(k<-1||k>=this.dim+1||F<-1||F>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(F+1)*this.stride+(k+1)}static pack(k,F){const Me=[0,0,0,0],Ae=Cg.getUnpackVector(F);let Oe=Math.floor((k+Ae[3])/Ae[2]);return Me[2]=Oe%256,Oe=Math.floor(Oe/256),Me[1]=Oe%256,Oe=Math.floor(Oe/256),Me[0]=Oe,Me}getPixels(){return new oc({width:this.stride,height:this.stride},this.pixels)}backfillBorder(k,F,Me){if(this.dim!==k.dim)throw new Error("dem dimension mismatch");let Ae=F*this.dim,Oe=F*this.dim+this.dim,Fe=Me*this.dim,je=Me*this.dim+this.dim;switch(F){case-1:Ae=Oe-1;break;case 1:Oe=Ae+1}switch(Me){case-1:Fe=je-1;break;case 1:je=Fe+1}const qe=-F*this.dim,pt=-Me*this.dim;for(let F=Fe;F<je;F++)for(let Me=Ae;Me<Oe;Me++){const Ae=4*this._idx(Me,F),Oe=4*this._idx(Me+qe,F+pt);this.pixels[Ae+0]=k.pixels[Oe+0],this.pixels[Ae+1]=k.pixels[Oe+1],this.pixels[Ae+2]=k.pixels[Oe+2],this.pixels[Ae+3]=k.pixels[Oe+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function Dg(k,F,Me){1===k?F.headerLength=Me.readFixed32():2===k?F.x=Me.readVarint():3===k?F.y=Me.readVarint():4===k?F.z=Me.readVarint():5===k&&F.layers.push(function(k,F){return k.readFields(Ng,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},F)}(Me,Me.readVarint()+Me.pos))}function Lg(k,F,Me){1===k?(F.delta_filter=function(k,F){return k.readFields(Rg,{blockSize:0},F)}(Me,Me.readVarint()+Me.pos),F.filter="delta_filter"):2===k?(Me.readVarint(),F.filter="zigzag_filter"):3===k?(Me.readVarint(),F.filter="bitshuffle_filter"):4===k&&(Me.readVarint(),F.filter="byteshuffle_filter")}function Rg(k,F,Me){1===k&&(F.blockSize=Me.readVarint())}function Fg(k,F,Me){1===k?(Me.readVarint(),F.codec="gzip_data"):2===k?(Me.readVarint(),F.codec="jpeg_image"):3===k?(Me.readVarint(),F.codec="webp_image"):4===k&&(Me.readVarint(),F.codec="png_image")}function Og(k,F,Me){let Ae=0,Oe=0;1===k?F.firstByte=Me.readFixed64():2===k?F.lastByte=Me.readFixed64():3===k?F.filters.push(function(k,F){return k.readFields(Lg,{},F)}(Me,Me.readVarint()+Me.pos)):4===k?F.codec=function(k,F){return k.readFields(Fg,{},F)}(Me,Me.readVarint()+Me.pos):5===k?Oe=Me.readFloat():6===k?Ae=Me.readFloat():7===k?F.bands.push(Me.readString()):8===k?F.offset=Me.readDouble():9===k&&(F.scale=Me.readDouble()),0===F.offset&&(F.offset=Oe),0===F.scale&&(F.scale=Ae)}function Ng(k,F,Me){1===k?F.version=Me.readVarint():2===k?F.name=Me.readString():3===k?F.units=Me.readString():4===k?F.tileSize=Me.readVarint():5===k?F.buffer=Me.readVarint():6===k?F.pixelFormat=Me.readVarint():7===k&&F.dataIndex.push(function(k,F){return k.readFields(Og,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},F)}(Me,Me.readVarint()+Me.pos))}function Ug(k,F,Me){if(2===k)!function(k,F,Me){k.readFields(jg,Me,F)}(Me,Me.readVarint()+Me.pos,F);else if(3===k)throw new Error("Not implemented")}function jg(k,F,Me){if(1===k){let k=0;const Ae=Me.readVarint()+Me.pos;for(;Me.pos<Ae;)F[k++]=Me.readVarint()}}function qg(k,F){if(4!==F.length)throw new Error(`Expected data of dimension 4 but got ${F.length}.`);let Me=F[3];for(let Ae=2;Ae>=1;Ae--){const Oe=1===Ae?1:0,Fe=2===Ae?1:0;for(let Ae=0;Ae<F[0];Ae++){const je=F[1]*Ae;for(let Ae=Oe;Ae<F[1];Ae++){const Oe=F[2]*(Ae+je);for(let Ae=Fe;Ae<F[2];Ae++){const Fe=F[3]*(Ae+Oe);for(let Ae=0;Ae<F[3];Ae++){const F=Fe+Ae;k[F]+=k[F-Me]}}}}Me*=F[Ae]}return k}function $g(k){for(let F=0,Me=k.length;F<Me;F++)k[F]=k[F]>>>1^-(1&k[F]);return k}function Gg(k,F){switch(F){case"uint32":return k;case"uint16":for(let F=0;F<k.length;F+=2){const Me=k[F],Ae=k[F+1];k[F]=(240&Me)>>4|(61440&Me)>>8|(240&Ae)<<4|61440&Ae,k[F+1]=15&Me|(3840&Me)>>4|(15&Ae)<<8|(3840&Ae)<<4}return k;case"uint8":for(let F=0;F<k.length;F+=4){const Me=k[F],Ae=k[F+1],Oe=k[F+2],Fe=k[F+3];k[F+0]=(192&Me)>>6|(192&Ae)>>4|(192&Oe)>>2|192&Fe,k[F+1]=(48&Me)>>4|(48&Ae)>>2|48&Oe|(48&Fe)<<2,k[F+2]=(12&Me)>>2|12&Ae|(12&Oe)<<2|(12&Fe)<<4,k[F+3]=3&Me|(3&Ae)<<2|(3&Oe)<<4|(3&Fe)<<6}return k;default:throw new Error(`Invalid pixel format, "${F}"`)}}oa(Cg,"DEMData"),oa(zg,"DemMinMaxQuadTree",{omit:["dem"]});var Yv=Uint8Array,Kv=Uint16Array,Jv=Int32Array,Qv=new Yv([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),eb=new Yv([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),tb=new Yv([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Jg=function(k,F){for(var Me=new Kv(31),Ae=0;Ae<31;++Ae)Me[Ae]=F+=1<<k[Ae-1];var Oe=new Jv(Me[30]);for(Ae=1;Ae<30;++Ae)for(var Fe=Me[Ae];Fe<Me[Ae+1];++Fe)Oe[Fe]=Fe-Me[Ae]<<5|Ae;return{b:Me,r:Oe}},ib=Jg(Qv,2),rb=ib.b,nb=ib.r;rb[28]=258,nb[258]=28;for(var ob=Jg(eb,0).b,sb=new Kv(32768),ab=0;ab<32768;++ab){var lb=(43690&ab)>>1|(21845&ab)<<1;sb[ab]=((65280&(lb=(61680&(lb=(52428&lb)>>2|(13107&lb)<<2))>>4|(3855&lb)<<4))>>8|(255&lb)<<8)>>1}var sx=function(k,F,Me){for(var Ae=k.length,Oe=0,Fe=new Kv(F);Oe<Ae;++Oe)k[Oe]&&++Fe[k[Oe]-1];var je,qe=new Kv(F);for(Oe=1;Oe<F;++Oe)qe[Oe]=qe[Oe-1]+Fe[Oe-1]<<1;je=new Kv(1<<F);var pt=15-F;for(Oe=0;Oe<Ae;++Oe)if(k[Oe])for(var vt=Oe<<4|k[Oe],Ut=F-k[Oe],xi=qe[k[Oe]-1]++<<Ut,vi=xi|(1<<Ut)-1;xi<=vi;++xi)je[sb[xi]>>pt]=vt;return je},cb=new Yv(288);for(ab=0;ab<144;++ab)cb[ab]=8;for(ab=144;ab<256;++ab)cb[ab]=9;for(ab=256;ab<280;++ab)cb[ab]=7;for(ab=280;ab<288;++ab)cb[ab]=8;var hb=new Yv(32);for(ab=0;ab<32;++ab)hb[ab]=5;var ub=sx(cb,9),db=sx(hb,5),hx=function(k){for(var F=k[0],Me=1;Me<k.length;++Me)k[Me]>F&&(F=k[Me]);return F},px=function(k,F,Me){var Ae=F/8|0;return(k[Ae]|k[Ae+1]<<8)>>(7&F)&Me},fx=function(k,F){var Me=F/8|0;return(k[Me]|k[Me+1]<<8|k[Me+2]<<16)>>(7&F)},pb=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],mx=function(k,F,Me){var Ae=new Error(F||pb[k]);if(Ae.code=k,Error.captureStackTrace&&Error.captureStackTrace(Ae,mx),!Me)throw Ae;return Ae},fb=new Yv(0),mb="undefined"!=typeof TextDecoder&&new TextDecoder;try{mb.decode(fb,{stream:!0})}catch(F){}const _b={gzip_data:"gzip"};class vx extends Error{constructor(k){super(k),this.name="MRTError"}}const gb={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},yb={uint32:1,uint16:2,uint8:4},xb={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let vb;class Ax{constructor(k=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=k}getLayer(k){const F=this.layers[k];if(!F)throw new vx(`Layer '${k}' not found`);return F}getHeaderLength(k){const F=new Uint8Array(k),Me=new DataView(k);if(13!==F[0])throw new vx("File is not a valid MRT.");return Me.getUint32(1,!0)}parseHeader(k){const F=new Uint8Array(k),Me=this.getHeaderLength(k);if(F.length<Me)throw new vx(`Expected header with length >= ${Me} but got buffer of length ${F.length}`);const Ae=function(k,F){return k.readFields(Dg,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new vb(F.subarray(0,Me)));if(!isNaN(this.x)&&(this.x!==Ae.x||this.y!==Ae.y||this.z!==Ae.z))throw new vx(`Invalid attempt to parse header ${Ae.z}/${Ae.x}/${Ae.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=Ae.x,this.y=Ae.y,this.z=Ae.z;for(const k of Ae.layers)this.layers[k.name]=new Sx(k,{cacheSize:this._cacheSize});return this}createDecodingTask(k){const F=[],Me=this.getLayer(k.layerName);for(let Ae of k.blockIndices){const Oe=Me.dataIndex[Ae],Fe=Oe.firstByte-k.firstByte,je=Oe.lastByte-k.firstByte;if(Me._blocksInProgress.has(Ae))continue;const qe={layerName:Me.name,firstByte:Fe,lastByte:je,pixelFormat:Me.pixelFormat,blockIndex:Ae,blockShape:[Oe.bands.length].concat(Me.bandShape),buffer:Me.buffer,codec:Oe.codec.codec,filters:Oe.filters.map((k=>k.filter))};Me._blocksInProgress.add(Ae),F.push(qe)}return new Ix(F,(()=>{F.forEach((k=>Me._blocksInProgress.delete(k.blockIndex)))}),((k,Ae)=>{if(F.forEach((k=>Me._blocksInProgress.delete(k.blockIndex))),k)throw k;Ae.forEach((k=>{this.getLayer(k.layerName).processDecodedData(k)}))}))}}class Sx{constructor({version:k,name:F,units:Me,tileSize:Ae,pixelFormat:Oe,buffer:Fe,dataIndex:je},qe){if(this.version=k,1!==this.version)throw new vx(`Cannot parse raster layer encoded with MRT version ${k}`);this.name=F,this.units=Me,this.tileSize=Ae,this.buffer=Fe,this.pixelFormat=gb[Oe],this.dataIndex=je,this.bandShape=[Ae+2*Fe,Ae+2*Fe,yb[this.pixelFormat]],this._decodedBlocks=new _g(qe?qe.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return yb[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:k})=>k)).flat()}processDecodedData(k){const F=k.blockIndex.toString();this._decodedBlocks.get(F)||this._decodedBlocks.put(F,k.data)}getBlockForBand(k){let F=0;switch(typeof k){case"string":for(const[Me,Ae]of this.dataIndex.entries()){for(const[Oe,Fe]of Ae.bands.entries())if(Fe===k)return{bandIndex:F+Oe,blockIndex:Me,blockBandIndex:Oe};F+=Ae.bands.length}break;case"number":for(const[Me,Ae]of this.dataIndex.entries()){if(k>=F&&k<F+Ae.bands.length)return{bandIndex:k,blockIndex:Me,blockBandIndex:k-F};F+=Ae.bands.length}break;default:throw new vx(`Invalid band \`${JSON.stringify(k)}\`. Expected string or integer.`)}throw new vx(`Band not found: ${JSON.stringify(k)}`)}getDataRange(k){let F=1/0,Me=-1/0;const Ae=[],Oe=new Set;for(const Fe of k){const{blockIndex:k}=this.getBlockForBand(Fe);if(k<0)throw new vx(`Invalid band: ${JSON.stringify(Fe)}`);const je=this.dataIndex[k];Ae.includes(k)||Ae.push(k),Oe.add(k),F=Math.min(F,je.firstByte),Me=Math.max(Me,je.lastByte)}if(Oe.size>this.cacheSize)throw new vx(`Number of blocks to decode (${Oe.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:F,lastByte:Me,blockIndices:Ae}}hasBand(k){const{blockIndex:F}=this.getBlockForBand(k);return F>=0}hasDataForBand(k){const{blockIndex:F}=this.getBlockForBand(k);return F>=0&&!!this._decodedBlocks.get(F.toString())}getBandView(k){const{blockIndex:F,blockBandIndex:Me}=this.getBlockForBand(k),Ae=this._decodedBlocks.get(F.toString());if(!Ae)throw new vx(`Data for band ${JSON.stringify(k)} of layer "${this.name}" not decoded.`);const Oe=this.dataIndex[F],Fe=this.bandShape.reduce(((k,F)=>k*F),1),je=Me*Fe,qe=Ae.subarray(je,je+Fe);return{data:qe,bytes:new Uint8Array(qe.buffer).subarray(qe.byteOffset,qe.byteOffset+qe.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:Oe.offset,scale:Oe.scale}}}Ax.setPbf=function(k){vb=k};class Ix{constructor(k,F,Me){this.tasks=k,this._onCancel=F,this._onComplete=Me,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(k,F){this._finalized||(this._onComplete(k,F),this._finalized=!0)}}Ax.performDecoding=function(k,F){const Me=new Uint8Array(k);return Promise.all(F.tasks.map((k=>{const{layerName:F,firstByte:Ae,lastByte:Oe,pixelFormat:Fe,blockShape:je,blockIndex:qe,filters:pt,codec:vt}=k,Ut=Me.subarray(Ae,Oe+1),xi=new Uint32Array(je[0]*je[1]*je[2]);let vi;if("gzip_data"!==vt)throw new vx(`Unhandled codec: ${vt}`);return vi=function(k,F){if(!globalThis.DecompressionStream&&"gzip_data"===F)return Promise.resolve(((Fe=function(k){31==k[0]&&139==k[1]&&8==k[2]||mx(6,"invalid gzip data");var F=k[3],Me=10;4&F&&(Me+=2+(k[10]|k[11]<<8));for(var Ae=(F>>3&1)+(F>>4&1);Ae>0;Ae-=!k[Me++]);return Me+(2&F)}(Oe=k))+8>Oe.length&&mx(6,"invalid gzip data"),function(k,F,Me,Ae){var Oe=k.length;if(!Oe||F.f&&!F.l)return Me||new Yv(0);var Fe=!Me,je=Fe||2!=F.i,qe=F.i;Fe&&(Me=new Yv(3*Oe));var pt,vt,c=function(k){var F=Me.length;if(k>F){var Ae=new Yv(Math.max(2*F,k));Ae.set(Me),Me=Ae}},Ut=F.f||0,xi=F.p||0,vi=F.b||0,bi=F.l,wi=F.d,Mi=F.m,pr=F.n,Ur=8*Oe;do{if(!bi){Ut=px(k,xi,1);var Wr=px(k,xi+1,3);if(xi+=3,!Wr){var Jr=k[(wa=4+((xi+7)/8|0))-4]|k[wa-3]<<8,Qr=wa+Jr;if(Qr>Oe){qe&&mx(0);break}je&&c(vi+Jr),Me.set(k.subarray(wa,Qr),vi),F.b=vi+=Jr,F.p=xi=8*Qr,F.f=Ut;continue}if(1==Wr)bi=ub,wi=db,Mi=9,pr=5;else if(2==Wr){var co=px(k,xi,31)+257,mo=px(k,xi+10,15)+4,yo=co+px(k,xi+5,31)+1;xi+=14;for(var To=new Yv(yo),zo=new Yv(19),ko=0;ko<mo;++ko)zo[tb[ko]]=px(k,xi+3*ko,7);xi+=3*mo;var na=hx(zo),aa=(1<<na)-1,_a=sx(zo,na);for(ko=0;ko<yo;){var wa,Sa=_a[px(k,xi,aa)];if(xi+=15&Sa,(wa=Sa>>4)<16)To[ko++]=wa;else{var Ya=0,rl=0;for(16==wa?(rl=3+px(k,xi,3),xi+=2,Ya=To[ko-1]):17==wa?(rl=3+px(k,xi,7),xi+=3):18==wa&&(rl=11+px(k,xi,127),xi+=7);rl--;)To[ko++]=Ya}}var sl=To.subarray(0,co),ml=To.subarray(co);Mi=hx(sl),pr=hx(ml),bi=sx(sl,Mi),wi=sx(ml,pr)}else mx(1);if(xi>Ur){qe&&mx(0);break}}je&&c(vi+131072);for(var Sl=(1<<Mi)-1,Il=(1<<pr)-1,Kl=xi;;Kl=xi){var Jl=(Ya=bi[fx(k,xi)&Sl])>>4;if((xi+=15&Ya)>Ur){qe&&mx(0);break}if(Ya||mx(2),Jl<256)Me[vi++]=Jl;else{if(256==Jl){Kl=xi,bi=null;break}var Ql=Jl-254;Jl>264&&(Ql=px(k,xi,(1<<(cc=Qv[ko=Jl-257]))-1)+rb[ko],xi+=cc);var ec=wi[fx(k,xi)&Il],tc=ec>>4;if(ec||mx(3),xi+=15&ec,ml=ob[tc],tc>3){var cc=eb[tc];ml+=fx(k,xi)&(1<<cc)-1,xi+=cc}if(xi>Ur){qe&&mx(0);break}je&&c(vi+131072);var uc=vi+Ql;if(vi<ml){var jc=0-ml,Gc=Math.min(ml,uc);for(jc+vi<0&&mx(3);vi<Gc;++vi)Me[vi]=(void 0)[jc+vi]}for(;vi<uc;++vi)Me[vi]=Me[vi-ml]}}F.l=bi,F.p=Kl,F.b=vi,F.f=Ut,bi&&(Ut=1,F.m=Mi,F.d=wi,F.n=pr)}while(!Ut);return vi!=Me.length&&Fe?(pt=Me,(null==(vt=vi)||vt>pt.length)&&(vt=pt.length),new Yv(pt.subarray(0,vt))):Me.subarray(0,vi)}(Oe.subarray(Fe,-8),{i:2},new Yv(((Me=Oe)[(Ae=Me.length)-4]|Me[Ae-3]<<8|Me[Ae-2]<<16|Me[Ae-1]<<24)>>>0))));var Me,Ae,Oe,Fe;const je=_b[F];if(!je)throw new Error(`Unhandled codec: ${F}`);const qe=new globalThis.DecompressionStream(je);return new Response(new Blob([k]).stream().pipeThrough(qe)).arrayBuffer().then((k=>new Uint8Array(k)))}(Ut,vt).then((k=>(function(k,F){k.readFields(Ug,F)}(new vb(k),xi),new(0,xb[Fe])(xi.buffer)))),vi.then((k=>{for(let F=pt.length-1;F>=0;F--)switch(pt[F]){case"delta_filter":qg(k,je);break;case"zigzag_filter":$g(k);break;case"bitshuffle_filter":Gg(k,Fe);break;default:throw new vx(`Unhandled filter "${pt[F]}"`)}return{layerName:F,blockIndex:qe,data:k}})).catch((k=>{throw k}))})))},oa(Ix,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});let bb,wb,Tb,Sb,Mb,Eb=null;function Vx(){return gt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:wb||Jl.DRACO_URL}function Cx(){if(gt()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Sb)return Sb;const k=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Sb=WebAssembly.validate(k)?Jl.MESHOPT_SIMD_URL:Jl.MESHOPT_URL,Sb}const Ib={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ab={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Cb={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Fx(k,F,Me){const Ae=Me.json.bufferViews.length,Oe=Me.buffers.length;F.bufferView=Ae,Me.json.bufferViews[Ae]={buffer:Oe,byteLength:k.byteLength},Me.buffers[Oe]=k}const zb="KHR_draco_mesh_compression";function Nx(k,F){const Me=k.extensions&&k.extensions[zb];if(!Me)return;const Ae=new Tb.Decoder,Oe=Xx(F,Me.bufferView),Fe=new Tb.Mesh;if(!Ae.DecodeArrayToMesh(Oe,Oe.byteLength,Fe))throw new Error("Failed to decode Draco mesh");const je=F.json.accessors[k.indices],qe=Ib[je.componentType],pt=je.count*qe.BYTES_PER_ELEMENT,vt=Tb._malloc(pt);qe===Uint16Array?Ae.GetTrianglesUInt16Array(Fe,pt,vt):Ae.GetTrianglesUInt32Array(Fe,pt,vt),Fx(Tb.memory.buffer.slice(vt,vt+pt),je,F),Tb._free(vt);for(const Oe of Object.keys(Me.attributes)){const je=Ae.GetAttributeByUniqueId(Fe,Me.attributes[Oe]),qe=F.json.accessors[k.attributes[Oe]],pt=Ab[qe.componentType],vt=qe.count*Cb[qe.type]*Ib[qe.componentType].BYTES_PER_ELEMENT,Ut=Tb._malloc(vt);Ae.GetAttributeDataArrayForAllPoints(Fe,je,Tb[pt],vt,Ut),Fx(Tb.memory.buffer.slice(Ut,Ut+vt),qe,F),Tb._free(Ut)}Ae.destroy(),Fe.destroy(),delete k.extensions[zb]}const Pb="EXT_meshopt_compression";function jx(k,F){if(!k.extensions||!k.extensions[Pb])return;const Me=k.extensions[Pb],Ae=new Uint8Array(F.buffers[Me.buffer],Me.byteOffset||0,Me.byteLength||0),Oe=new Uint8Array(Me.count*Me.byteStride);Mb.decodeGltfBuffer(Oe,Me.count,Me.byteStride,Ae,Me.mode,Me.filter),k.buffer=F.buffers.length,k.byteOffset=0,F.buffers[k.buffer]=Oe.buffer,delete k.extensions[Pb]}const Db=1179937895,Rb=new TextDecoder("utf8");function Gx(k,F){return new URL(k,F).href}function Yx(k,F,Me,Ae){return fetch(Gx(k.uri,Ae)).then((k=>k.arrayBuffer())).then((k=>{F.buffers[Me]=k}))}function Xx(k,F){const Me=k.json.bufferViews[F];return new Uint8Array(k.buffers[Me.buffer],Me.byteOffset||0,Me.byteLength)}function Zx(k,F,Me,Ae){if(k.uri){const Oe=Gx(k.uri,Ae);return fetch(Oe).then((k=>k.blob())).then((k=>createImageBitmap(k))).then((k=>{F.images[Me]=k}))}if(void 0!==k.bufferView){const Ae=Xx(F,k.bufferView),Oe=new Blob([Ae],{type:k.mimeType});return createImageBitmap(Oe).then((k=>{F.images[Me]=k}))}}function Hx(k,F=0,Me){const Ae={json:null,images:[],buffers:[]};if(new Uint32Array(k,F,1)[0]===Db){const Me=new Uint32Array(k,F);let Oe=2;const Fe=(Me[Oe++]>>2)-3,je=Me[Oe++]>>2;if(Oe++,Ae.json=JSON.parse(Rb.decode(Me.subarray(Oe,Oe+je))),Oe+=je,Oe<Fe){const Fe=Me[Oe++];Oe++;const je=F+(Oe<<2);Ae.buffers[0]=k.slice(je,je+Fe)}}else Ae.json=JSON.parse(Rb.decode(new Uint8Array(k,F)));const{buffers:Oe,images:Fe,meshes:je,extensionsUsed:qe,bufferViews:pt}=Ae.json;let vt=Promise.resolve();if(Oe){const k=[];for(let F=0;F<Oe.length;F++){const Fe=Oe[F];Fe.uri?k.push(Yx(Fe,Ae,F,Me)):Ae.buffers[F]||(Ae.buffers[F]=null)}vt=Promise.all(k)}return vt.then((()=>{const k=[],F=qe&&qe.includes(zb),Oe=qe&&qe.includes(Pb);if(F&&k.push(function(){if(!Tb)return null!=bb?bb:(bb=function(k){let F,Me=null;function n(){F=new Uint8Array(Me.buffer)}function i(){throw new Error("Unexpected Draco error.")}const Ae={a:{a:i,d:function(k,Me,Ae){return F.copyWithin(k,Me,Me+Ae)},c:function(k){const Ae=F.length,Oe=Math.max(k>>>0,Math.ceil(1.2*Ae)),Fe=Math.ceil((Oe-Ae)/65536);try{return Me.grow(Fe),n(),!0}catch(k){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(k,Ae):k.then((k=>k.arrayBuffer())).then((k=>WebAssembly.instantiate(k,Ae)))).then((k=>{const{Rb:Ae,Qb:Oe,P:Fe,T:je,X:qe,Ja:pt,La:vt,Qa:Ut,Va:xi,Wa:vi,eb:bi,jb:wi,f:Mi,e:pr,yb:Ur,zb:Wr,Ab:Jr,Bb:Qr,Db:co,Gb:mo}=k.instance.exports;Me=pr;const yo=(()=>{let k=0,Me=0,Fe=0,je=0;return qe=>{Fe&&(Ae(je),Ae(k),Me+=Fe,Fe=k=0),k||(Me+=128,k=Oe(Me));const pt=qe.length+7&-8;let vt=k;pt>=Me&&(Fe=pt,vt=je=Oe(pt));for(let k=0;k<qe.length;k++)F[vt+k]=qe[k];return vt}})();return n(),Mi(),{memory:pr,_free:Ae,_malloc:Oe,Mesh:class{constructor(){this.ptr=Fe()}destroy(){je(this.ptr)}},Decoder:class{constructor(){this.ptr=pt()}destroy(){wi(this.ptr)}DecodeArrayToMesh(k,F,Me){const Ae=yo(k),Oe=vt(this.ptr,Ae,F,Me.ptr);return!!qe(Oe)}GetAttributeByUniqueId(k,F){return{ptr:Ut(this.ptr,k.ptr,F)}}GetTrianglesUInt16Array(k,F,Me){xi(this.ptr,k.ptr,F,Me)}GetTrianglesUInt32Array(k,F,Me){vi(this.ptr,k.ptr,F,Me)}GetAttributeDataArrayForAllPoints(k,F,Me,Ae,Oe){bi(this.ptr,k.ptr,F.ptr,Me,Ae,Oe)}},DT_INT8:Ur(),DT_UINT8:Wr(),DT_INT16:Jr(),DT_UINT16:Qr(),DT_UINT32:co(),DT_FLOAT32:mo()}}))}(fetch(Vx())),bb.then((k=>{Tb=k,bb=void 0})))}()),Oe&&k.push(function(){if(Mb)return;const k=function(k){let F;const Me=WebAssembly.instantiateStreaming(k,{}).then((k=>{F=k.instance,F.exports.__wasm_call_ctors()})),Ae={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Oe={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:Me,supported:!0,decodeGltfBuffer(k,Me,Fe,je,qe,pt){!function(k,F,Me,Ae,Oe,Fe,je){const qe=k.exports.sbrk,pt=Ae+3&-4,vt=qe(pt*Oe),Ut=qe(Fe.length),xi=new Uint8Array(k.exports.memory.buffer);xi.set(Fe,Ut);const vi=F(vt,Ae,Oe,Ut,Fe.length);if(0===vi&&je&&je(vt,pt,Oe),Me.set(xi.subarray(vt,vt+Ae*Oe)),qe(vt-qe(0)),0!==vi)throw new Error(`Malformed buffer data: ${vi}`)}(F,F.exports[Oe[qe]],k,Me,Fe,je,F.exports[Ae[pt]])}}}(fetch(Cx()));return k.ready.then((()=>{Mb=k}))}()),Fe)for(let F=0;F<Fe.length;F++)k.push(Zx(Fe[F],Ae,F,Me));return(k.length?Promise.all(k):Promise.resolve()).then((()=>{if(F&&je)for(const{primitives:k}of je)for(const F of k)Nx(F,Ae);if(Oe&&je&&pt)for(const k of pt)jx(k,Ae);return Ae}))}))}function Wx(k,F){const Me=k.json.bufferViews[F.bufferView],Ae=Ib[F.componentType];return new Ae(k.buffers[Me.buffer],(F.byteOffset||0)+(Me.byteOffset||0),F.count*(Me.byteStride&&Me.byteStride!==Cb[F.type]*Ae.BYTES_PER_ELEMENT?Me.byteStride/Ae.BYTES_PER_ELEMENT:Cb[F.type]))}function Kx(k,F,Me,Ae){const Oe=Ib[F.componentType],Fe=function(k){switch(k){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(Oe),je=k.json.bufferViews[F.bufferView],qe=je.byteStride?je.byteStride/Oe.BYTES_PER_ELEMENT:Cb[F.type],pt=Me.float32,vt=pt.length/Me.capacity;for(let k=0,Me=0;k<F.count*qe;k+=qe,Me+=vt)for(let F=0;F<vt;F++)pt[Me+F]=Ae[k+F]*Fe;Me._trim()}function Jx(k,F,Me){const Ae=k.indices,Oe=k.attributes,Fe={};Fe.indexArray=new Ls;const je=F.json.accessors[Ae],qe=je.count/3;Fe.indexArray.reserve(qe);const pt=Wx(F,je);for(let k=0;k<qe;k++)Fe.indexArray.emplaceBack(pt[3*k],pt[3*k+1],pt[3*k+2]);Fe.indexArray._trim(),Fe.vertexArray=new As;const vt=F.json.accessors[Oe.POSITION];Fe.vertexArray.reserve(vt.count);const Ut=Wx(F,vt);for(let k=0;k<vt.count;k++)Fe.vertexArray.emplaceBack(Ut[3*k],Ut[3*k+1],Ut[3*k+2]);if(Fe.vertexArray._trim(),Fe.aabb=new xu(vt.min,vt.max),Fe.centroid=function(k,F){const Me=[0,0,0],Ae=k.length;if(Ae>0){for(let Oe=0;Oe<Ae;Oe++){const Ae=3*k[Oe];Me[0]+=F[Ae],Me[1]+=F[Ae+1],Me[2]+=F[Ae+2]}Me[0]/=Ae,Me[1]/=Ae,Me[2]/=Ae}return Me}(pt,Ut),void 0!==Oe.COLOR_0){const k=F.json.accessors[Oe.COLOR_0],Me=Cb[k.type],Ae=Wx(F,k);Fe.colorArray=3===Me?new As:new Ms,Fe.colorArray.resize(k.count),Kx(F,k,Fe.colorArray,Ae)}if(void 0!==Oe.NORMAL){Fe.normalArray=new As;const k=F.json.accessors[Oe.NORMAL];Fe.normalArray.resize(k.count);const Me=Wx(F,k);Kx(F,k,Fe.normalArray,Me)}if(void 0!==Oe.TEXCOORD_0&&Me.length>0){Fe.texcoordArray=new $s;const k=F.json.accessors[Oe.TEXCOORD_0];Fe.texcoordArray.resize(k.count);const Me=Wx(F,k);Kx(F,k,Fe.texcoordArray,Me)}if(void 0!==Oe._FEATURE_ID_RGBA4444){const k=F.json.accessors[Oe._FEATURE_ID_RGBA4444];F.json.extensionsUsed&&F.json.extensionsUsed.includes("EXT_meshopt_compression")&&(Fe.featureData=Wx(F,k))}void 0!==Oe._FEATURE_RGBA4444&&(Fe.featureData=new Uint32Array(Wx(F,F.json.accessors[Oe._FEATURE_RGBA4444]).buffer));const xi=k.material;return Fe.material=function(k,F){const{emissiveFactor:Me=[0,0,0],alphaMode:Ae="OPAQUE",alphaCutoff:Oe=.5,normalTexture:Fe,occlusionTexture:je,emissiveTexture:qe,doubleSided:pt}=k,{baseColorFactor:vt=[1,1,1,1],metallicFactor:Ut=1,roughnessFactor:xi=1,baseColorTexture:vi,metallicRoughnessTexture:bi}=k.pbrMetallicRoughness||{},wi=je?F[je.index]:void 0;if(je&&je.extensions&&je.extensions.KHR_texture_transform&&wi){const k=je.extensions.KHR_texture_transform;wi.offsetScale=[k.offset[0],k.offset[1],k.scale[0],k.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Ie(...vt),metallicFactor:Ut,roughnessFactor:xi,baseColorTexture:vi?F[vi.index]:void 0,metallicRoughnessTexture:bi?F[bi.index]:void 0},doubleSided:pt,emissiveFactor:Me,alphaMode:Ae,alphaCutoff:Oe,normalTexture:Fe?F[Fe.index]:void 0,occlusionTexture:wi,emissionTexture:qe?F[qe.index]:void 0,defined:void 0===k.defined}}(void 0!==xi?F.json.materials[xi]:{defined:!1},Me),Fe}function Qx(k,F,Me){const{matrix:Ae,rotation:Oe,translation:Fe,scale:je,mesh:qe,extras:pt,children:vt}=k,Ut={};if(Ut.matrix=Ae||aa.mat4.fromRotationTranslationScale([],Oe||[0,0,0,1],Fe||[0,0,0],je||[1,1,1]),void 0!==qe){Ut.meshes=Me[qe];const k=Ut.anchor=[0,0];for(const F of Ut.meshes){const{min:Me,max:Ae}=F.aabb;k[0]+=Me[0]+Ae[0],k[1]+=Me[1]+Ae[1]}k[0]=Math.floor(k[0]/Ut.meshes.length/2),k[1]=Math.floor(k[1]/Ut.meshes.length/2)}if(pt&&(pt.id&&(Ut.id=pt.id),pt.lights&&(Ut.lights=function(k){if(!k.length)return[];const F=function(k){const F=atob(k),Me=new Uint8Array(F.length);for(let k=0;k<F.length;k++)Me[k]=F.codePointAt(k);return Me}(k),Me=[],Ae=F.length/24,Oe=new Uint16Array(F.buffer),Fe=new Float32Array(F.buffer);for(let k=0;k<Ae;k++){const F=Oe[2*k*6]/30,Ae=Oe[2*k*6+1]/30,je=Oe[2*k*6+10]/100,qe=Fe[6*k+1],pt=Fe[6*k+2],vt=Fe[6*k+3],Ut=Fe[6*k+4],xi=vt-qe,vi=Ut-pt,bi=Math.hypot(xi,vi);Me.push({pos:[qe+.5*xi,pt+.5*vi,Ae],normal:[vi/bi,-xi/bi,0],width:bi,height:F,depth:je,points:[qe,pt,vt,Ut]})}return Me}(pt.lights))),vt){const k=[];for(const Ae of vt)k.push(Qx(F.json.nodes[Ae],F,Me));Ut.children=k}return Ut}function tv(k){if(0===k.vertices.length||0===k.indices.length)return null;const F=new Yc(k.vertices,k.indices,8,256),[Me,Ae]=[F.min.clone(),F.max.clone()];return{vertices:k.vertices,indices:k.indices,grid:F,min:Me,max:Ae}}function ev(k){if(!k.extras||!k.extras.ground)return null;const F=k.extras.ground;if(!F||!Array.isArray(F)||0===F.length)return null;const Me=F[0];if(!Me||!Array.isArray(Me)||0===Me.length)return null;const Ae=[];for(const k of Me){if(!Array.isArray(k)||2!==k.length)continue;const F=k[0],Me=k[1];"number"==typeof F&&"number"==typeof Me&&Ae.push(new Sa(F,Me))}if(Ae.length<3)return null;Ae.length>1&&Ae[Ae.length-1].equals(Ae[0])&&Ae.pop();let Oe=0;for(let k=0;k<Ae.length;k++){const F=Ae[k],Me=Ae[(k+1)%Ae.length],Fe=Ae[(k+2)%Ae.length];Oe+=(F.x-Me.x)*(Fe.y-Me.y)-(Fe.x-Me.x)*(F.y-Me.y)}Oe>0&&Ae.reverse();const Fe=hc(Ae.flatMap((k=>[k.x,k.y])),[]);return 0===Fe.length?null:{vertices:Ae,indices:Fe}}function rv(k,F){const Me=[],Ae=[];let Oe=0;const Fe=[];for(const je of k){Oe=Me.length;const k=je.vertexArray.float32,qe=je.indexArray.uint16;for(let Ae=0;Ae<je.vertexArray.length;Ae++)Fe[0]=k[3*Ae+0],Fe[1]=k[3*Ae+1],Fe[2]=k[3*Ae+2],aa.vec3.transformMat4(Fe,Fe,F),Me.push(new Sa(Fe[0],Fe[1]));for(let k=0;k<3*je.indexArray.length;k++)Ae.push(qe[k]+Oe)}if(Ae.length%3!=0)return null;for(let k=0;k<Ae.length;k+=3){const F=Me[Ae[k+0]],Oe=Me[Ae[k+1]],Fe=Me[Ae[k+2]];(F.x-Oe.x)*(Fe.y-Oe.y)-(Fe.x-Oe.x)*(F.y-Oe.y)>0&&([Ae[k+1],Ae[k+2]]=[Ae[k+2],Ae[k+1]])}return{vertices:Me,indices:Ae}}function nv(k){const F=function(k,F){const Me=[],Ae=WebGL2RenderingContext;if(k.json.textures)for(const Oe of k.json.textures){const Fe={magFilter:Ae.LINEAR,minFilter:Ae.NEAREST,wrapS:Ae.REPEAT,wrapT:Ae.REPEAT};void 0!==Oe.sampler&&Object.assign(Fe,k.json.samplers[Oe.sampler]),Me.push({image:F[Oe.source],sampler:Fe,uploaded:!1})}return Me}(k,k.images),Me=function(k,F){const Me=[];for(const Ae of k.json.meshes){const Oe=[];for(const Me of Ae.primitives)Oe.push(Jx(Me,k,F));Me.push(Oe)}return Me}(k,F),{scenes:Ae,scene:Oe,nodes:Fe}=k.json,je=Ae?Ae[Oe||0].nodes:Fe,qe=[];for(const F of je)qe.push(Qx(Fe[F],k,Me));return function(k,F,Me){const Ae={},Oe=new Set;for(let Fe=0;Fe<k.length;Fe++){const k=Me[F[Fe]];if(!k.extras)continue;const je=k.extras["mapbox:footprint:version"],qe=k.extras["mapbox:footprint:id"];(je||qe)&&Oe.add(Fe),"1.0.0"===je&&qe&&(Ae[qe]=Fe)}for(let Fe=0;Fe<k.length;Fe++){if(Oe.has(Fe))continue;const je=k[Fe],qe=Me[F[Fe]];if(!qe.extras)continue;let pt=null;je.id in Ae&&(pt=rv(k[Ae[je.id]].meshes,je.matrix)),pt||(pt=ev(qe)),pt&&(je.footprint=tv(pt))}if(Oe.size>0){const F=Array.from(Oe.values()).sort(((k,F)=>k-F));for(let Me=F.length-1;Me>=0;Me--)k.splice(F[Me],1)}}(qe,je,k.json.nodes),qe}function iv(k){k.heightmap=new Float32Array(4096),k.heightmap.fill(-1);const F=k.vertexArray.float32,Me=k.aabb.min[0]-1,Ae=k.aabb.min[1]-1,Oe=Dv/(k.aabb.max[0]-Me+2),Fe=Dv/(k.aabb.max[1]-Ae+2);for(let je=0;je<F.length;je+=3){const qe=F[je+2],pt=(F[je+0]-Me)*Oe|0,vt=(F[je+1]-Ae)*Fe|0;qe>k.heightmap[vt*Dv+pt]&&(k.heightmap[vt*Dv+pt]=qe)}}function av(k,F){const Me={};Me.indexArray=new Ls,Me.indexArray.reserve(4*k.length),Me.vertexArray=new As,Me.vertexArray.reserve(10*k.length),Me.colorArray=new Ms,Me.vertexArray.reserve(10*k.length);let Ae=0;for(const Oe of k){const k=Math.min(10,Math.max(4,1.3*Oe.height))*F,Fe=[-Oe.normal[1],Oe.normal[0],0],je=Math.min(.29,.1*Oe.width/Oe.depth),qe=Oe.width-2*Oe.depth*F*(je+.01),pt=aa.vec3.scaleAndAdd([],Oe.pos,Fe,qe/2),vt=aa.vec3.scaleAndAdd([],Oe.pos,Fe,-qe/2),Ut=[pt[0],pt[1],pt[2]+Oe.height],xi=[vt[0],vt[1],vt[2]+Oe.height],vi=aa.vec3.scaleAndAdd([],Oe.normal,Fe,je);aa.vec3.scale(vi,vi,k);const bi=aa.vec3.scaleAndAdd([],Oe.normal,Fe,-je);aa.vec3.scale(bi,bi,k),aa.vec3.add(vi,pt,vi),aa.vec3.add(bi,vt,bi),pt[2]+=.1,vt[2]+=.1,Me.vertexArray.emplaceBack(vi[0],vi[1],vi[2]),Me.vertexArray.emplaceBack(bi[0],bi[1],bi[2]),Me.vertexArray.emplaceBack(pt[0],pt[1],pt[2]),Me.vertexArray.emplaceBack(vt[0],vt[1],vt[2]),Me.vertexArray.emplaceBack(Ut[0],Ut[1],Ut[2]),Me.vertexArray.emplaceBack(xi[0],xi[1],xi[2]),Me.vertexArray.emplaceBack(pt[0],pt[1],pt[2]),Me.vertexArray.emplaceBack(vt[0],vt[1],vt[2]),Me.vertexArray.emplaceBack(vi[0],vi[1],vi[2]),Me.vertexArray.emplaceBack(bi[0],bi[1],bi[2]);const wi=qe/k/2;Me.colorArray.emplaceBack(-wi-je,-1,wi,.8),Me.colorArray.emplaceBack(wi+je,-1,wi,.8),Me.colorArray.emplaceBack(-wi,0,wi,1.3),Me.colorArray.emplaceBack(wi,0,wi,1.3),Me.colorArray.emplaceBack(wi+je,-.8,wi,.7),Me.colorArray.emplaceBack(wi+je,-.8,wi,.7),Me.colorArray.emplaceBack(0,0,wi,1.3),Me.colorArray.emplaceBack(0,0,wi,1.3),Me.colorArray.emplaceBack(wi+je,-1.2,wi,.8),Me.colorArray.emplaceBack(wi+je,-1.2,wi,.8),Me.indexArray.emplaceBack(6+Ae,4+Ae,8+Ae),Me.indexArray.emplaceBack(7+Ae,9+Ae,5+Ae),Me.indexArray.emplaceBack(0+Ae,1+Ae,2+Ae),Me.indexArray.emplaceBack(1+Ae,3+Ae,2+Ae),Ae+=10}const Oe={defined:!0,emissiveFactor:[0,0,0]},Fe={};return Fe.baseColorFactor=Ie.white,Oe.pbrMetallicRoughness=Fe,Me.material=Oe,Me.aabb=new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Me}class sv{constructor(k){this._stringToNumber={},this._numberToString=[];for(let F=0;F<k.length;F++){const Me=k[F];this._stringToNumber[Me]=F,this._numberToString[F]=Me}}encode(k){return this._stringToNumber[k]}decode(k){return this._numberToString[k]}}const Lb=["id","tile","layer","source","sourceLayer","state"];class lv{constructor(k,F,Me,Ae,Oe){this.type="Feature",this._vectorTileFeature=k,this._z=F,this._x=Me,this._y=Ae,this.properties=k.properties,this.id=Oe}clone(){const k=new lv(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(k.state={...this.state}),this.layer&&(k.layer={...this.layer}),this.source&&(k.source=this.source),this.sourceLayer&&(k.sourceLayer=this.sourceLayer),k}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(k){this._geometry=k}toJSON(){const k={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const F of Lb)void 0!==this[F]&&(k[F]=this[F]);return k}}class uv{constructor(k,F){this.tileID=k,this.x=k.canonical.x,this.y=k.canonical.y,this.z=k.canonical.z,this.grid=new Pp(Td,16,0),this.featureIndexArray=new so,this.promoteId=F,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(k,F,Me,Ae,Oe,Fe=0,je=0){const qe=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(Me,Ae,Oe,Fe);const pt=this.grid;for(let k=0;k<F.length;k++){const Me=F[k],Ae=[1/0,1/0,-1/0,-1/0];for(let k=0;k<Me.length;k++){const F=Me[k];Ae[0]=Math.min(Ae[0],F.x),Ae[1]=Math.min(Ae[1],F.y),Ae[2]=Math.max(Ae[2],F.x),Ae[3]=Math.max(Ae[3],F.y)}0!==je&&(Ae[0]-=je,Ae[1]-=je,Ae[2]+=je,Ae[3]+=je),Ae[0]<Td&&Ae[1]<Td&&Ae[2]>=0&&Ae[3]>=0&&pt.insert(qe,Ae[0],Ae[1],Ae[2],Ae[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new P_.VectorTile(new Ly(this.rawTileData)).layers,this.sourceLayerCoder=new sv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const k in this.vtLayers)this.vtFeatures[k]=[]}return this.vtLayers}query(k,F){const{tilespaceGeometry:Me,transform:Ae,tileTransform:Oe,pixelPosMatrix:Fe,availableImages:je}=F;this.loadVTLayers(),this.serializedLayersCache.clear();const qe=Me.bufferedTilespaceBounds,pt=this.grid.query(qe.min.x,qe.min.y,qe.max.x,qe.max.y,((k,F,Ae,Oe)=>ql(Me.bufferedTilespaceGeometry,k,F,Ae,Oe)));pt.sort(hv);let vt=null;Ae.elevation&&pt.length>0&&(vt=uy.create(Ae.elevation,this.tileID));const Ut={};let xi;for(let F=0;F<pt.length;F++){const qe=pt[F];if(qe===xi)continue;xi=qe;const vi=this.featureIndexArray.get(qe);let bi=null;this.is3DTile?this.loadMatchingModelFeature(Ut,vi,k,Me,Ae):this.loadMatchingFeature(Ut,vi,k,je,((k,F,je,qe=0)=>(bi||(bi=zl(k,this.tileID.canonical,Oe)),F.queryIntersectsFeature(Me,k,je,bi,this.z,Ae,Fe,vt,qe))))}return Ut}loadMatchingFeature(k,F,Me,Ae,Oe){const{featureIndex:Fe,bucketIndex:je,sourceLayerIndex:qe,layoutVertexArrayOffset:pt}=F,vt=this.bucketLayerIDs[je],Ut=Me.layers,xi=Object.keys(Ut);if(xi.length&&!function(k,F){for(let Me=0;Me<k.length;Me++)if(F.indexOf(k[Me])>=0)return!0;return!1}(xi,vt))return;const vi=Me.sourceCache,bi=this.sourceLayerCoder.decode(qe),wi=this.vtLayers[bi].feature(Fe),Mi=this.getId(wi,bi);for(let F=0;F<vt.length;F++){const Me=vt[F];if(!Ut[Me])continue;const{styleLayer:je,targets:qe}=Ut[Me];let xi={};void 0!==Mi&&(xi=vi.getFeatureState(je.sourceLayer,Mi));const bi=!Oe||Oe(wi,je,xi,pt);if(!bi)continue;const pr=new lv(wi,this.z,this.x,this.y,Mi);pr.tile=this.tileID.canonical,pr.state=xi;let Ur=this.serializedLayersCache.get(Me);Ur||(Ur=je.serialize(),Ur.id=Me,this.serializedLayersCache.set(Me,Ur)),pr.source=Ur.source,pr.sourceLayer=Ur["source-layer"],pr.layer=nt({},Ur),pr.layer.paint=cv(Ur.paint,je.paint,wi,xi,Ae),pr.layer.layout=cv(Ur.layout,je.layout,wi,xi,Ae);let Wr=!1;for(const k of qe){this.updateFeatureProperties(pr,k);const{filter:F}=k;if(F)if(wi.properties=pr.properties,F.needGeometry){const k=El(wi,!0);if(!F.filter(new Va(this.tileID.overscaledZ),k,this.tileID.canonical))continue}else if(!F.filter(new Va(this.tileID.overscaledZ),wi))continue;Wr=!0,k.targetId&&this.addFeatureVariant(pr,k)}Wr&&this.appendToResult(k,Me,Fe,pr,bi)}}loadMatchingModelFeature(k,F,Me,Ae,Oe){const Fe=this.bucketLayerIDs[0][0],je=Me.layers;if(!je[Fe])return;const{styleLayer:qe,targets:pt}=je[Fe];if("model"!==qe.type)return;const vt=Ae.tile,Ut=F.featureIndex,xi=vt.getBucket(qe);if(!(xi&&xi instanceof yy))return;const vi=function(k,F,Me,Ae){const Oe=k.getNodesInfo()[F];if(Oe.hiddenByReplacement||!Oe.node.meshes)return;let Fe=Number.MAX_VALUE;const je=Oe.node,qe=Me.tile,pt=Ae.calculatePosMatrix(qe.tileID.toUnwrapped(),Ae.worldSize),vt=Oe.evaluatedScale;let Ut=0;Ae.elevation&&je.elevation&&(Ut=je.elevation*Ae.elevation.exaggeration()),aa.mat4.translate(pt,pt,[(je.anchor?je.anchor[0]:0)*(vt[0]-1),(je.anchor?je.anchor[1]:0)*(vt[1]-1),Ut]),aa.mat4.scale(pt,pt,vt);const xi=Me.queryGeometry,vi=xi.isPointQuery()?xi.screenBounds:xi.screenGeometry,f=function(k){const F=aa.mat4.multiply([],pt,k.matrix);aa.mat4.multiply(F,Ae.expandedFarZProjMatrix,F);for(let Me=0;Me<k.meshes.length;++Me){const Oe=k.meshes[Me];if(Me===k.lightMeshIndex)continue;const je=Om(vi,Ae,F,Oe.aabb);null!=je&&(Fe=Math.min(je,Fe))}if(k.children)for(const F of k.children)f(F)};if(f(je),Fe===Number.MAX_VALUE)return;const bi=new il(0,0);return by(qe.tileID.canonical,bi,Oe.node.anchor[0],Oe.node.anchor[1]),{intersectionZ:Fe,position:bi,feature:Oe.feature}}(xi,Ut,Ae,Oe);if(!vi)return;const{z:bi,x:wi,y:Mi}=vt.tileID.canonical,{feature:pr,intersectionZ:Ur,position:Wr}=vi;let Jr={};void 0!==pr.id&&(Jr=Me.sourceCache.getFeatureState(qe.sourceLayer,pr.id));const Qr=new lv({},bi,wi,Mi,pr.id);Qr.tile=this.tileID.canonical,Qr.state=Jr,Qr.properties=pr.properties,Qr.geometry={type:"Point",coordinates:[Wr.lng,Wr.lat]};let co=this.serializedLayersCache.get(Fe);co||(co=qe.serialize(),co.id=Fe,this.serializedLayersCache.set(Fe,co)),Qr.source=co.source,Qr.sourceLayer=co["source-layer"],Qr.layer=nt({},co);let mo=!1;for(const k of pt){this.updateFeatureProperties(Qr,k);const{filter:F}=k;if(F)if(pr.properties=Qr.properties,F.needGeometry){if(!F.filter(new Va(this.tileID.overscaledZ),pr,this.tileID.canonical))continue}else if(!F.filter(new Va(this.tileID.overscaledZ),pr))continue;mo=!0,k.targetId&&this.addFeatureVariant(Qr,k)}mo&&this.appendToResult(k,Fe,Ut,Qr,Ur)}updateFeatureProperties(k,F,Me){if(F.properties){const Ae={};for(const Oe in F.properties){const Fe=F.properties[Oe].evaluate({zoom:this.z},k._vectorTileFeature,k.state,k.tile,Me);null!=Fe&&(Ae[Oe]=Fe)}k.properties=Ae}}addFeatureVariant(k,F,Me){const Ae={target:F.target,namespace:F.namespace};F.properties&&(Ae.properties=k.properties),k.variants=k.variants||{},k.variants[F.targetId]=k.variants[F.targetId]||[],k.variants[F.targetId].push(Ae)}appendToResult(k,F,Me,Ae,Oe){let Fe=k[F];void 0===Fe&&(Fe=k[F]=[]),Fe.push({featureIndex:Me,feature:Ae,intersectionZ:Oe})}lookupSymbolFeatures(k,F,Me,Ae,Oe){const Fe={};this.loadVTLayers();for(const je of k)this.loadMatchingFeature(Fe,{bucketIndex:F,sourceLayerIndex:Me,featureIndex:je,layoutVertexArrayOffset:0},Ae,Oe);return Fe}loadFeature(k){const{featureIndex:F,sourceLayerIndex:Me}=k;this.loadVTLayers();const Ae=this.sourceLayerCoder.decode(Me),Oe=this.vtFeatures[Ae];if(Oe[F])return Oe[F];const Fe=this.vtLayers[Ae].feature(F);return Oe[F]=Fe,Fe}hasLayer(k){for(const F of this.bucketLayerIDs)for(const Me of F)if(k===Me)return!0;return!1}getId(k,F){let Me=k.id;if(this.promoteId){const Ae="string"==typeof this.promoteId?this.promoteId:this.promoteId[F];null!=Ae&&(Me=k.properties[Ae]),"boolean"==typeof Me&&(Me=Number(Me))}return Me}}function cv(k,F,Me,Ae,Oe){return ut(k,((k,Fe)=>{const je=F instanceof Ua?F.get(Fe):null;return je&&je.evaluate?je.evaluate(Me,Ae,Oe):je}))}function hv(k,F){return F-k}oa(uv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const Ob=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class fv{static from(k){if(!(k instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[F,Me]=new Uint8Array(k,0,2);if(219!==F)throw new Error("Data does not appear to be in a KDBush format.");const Ae=Me>>4;if(1!==Ae)throw new Error(`Got v${Ae} data when expected v1.`);const Oe=Ob[15&Me];if(!Oe)throw new Error("Unrecognized array type.");const[Fe]=new Uint16Array(k,2,1),[je]=new Uint32Array(k,4,1);return new fv(je,Fe,Oe,k)}constructor(k,F=64,Me=Float64Array,Ae){if(isNaN(k)||k<0)throw new Error(`Unpexpected numItems value: ${k}.`);this.numItems=+k,this.nodeSize=Math.min(Math.max(+F,2),65535),this.ArrayType=Me,this.IndexArrayType=k<65536?Uint16Array:Uint32Array;const Oe=Ob.indexOf(this.ArrayType),Fe=2*k*this.ArrayType.BYTES_PER_ELEMENT,je=k*this.IndexArrayType.BYTES_PER_ELEMENT,qe=(8-je%8)%8;if(Oe<0)throw new Error(`Unexpected typed array class: ${Me}.`);Ae&&Ae instanceof ArrayBuffer?(this.data=Ae,this.ids=new this.IndexArrayType(this.data,8,k),this.coords=new this.ArrayType(this.data,8+je+qe,2*k),this._pos=2*k,this._finished=!0):(this.data=new ArrayBuffer(8+Fe+je+qe),this.ids=new this.IndexArrayType(this.data,8,k),this.coords=new this.ArrayType(this.data,8+je+qe,2*k),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+Oe]),new Uint16Array(this.data,2,1)[0]=F,new Uint32Array(this.data,4,1)[0]=k)}add(k,F){const Me=this._pos>>1;return this.ids[Me]=Me,this.coords[this._pos++]=k,this.coords[this._pos++]=F,Me}finish(){const k=this._pos>>1;if(k!==this.numItems)throw new Error(`Added ${k} items when expected ${this.numItems}.`);return dv(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(k,F,Me,Ae){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Oe,coords:Fe,nodeSize:je}=this,qe=[0,Oe.length-1,0],pt=[];for(;qe.length;){const vt=qe.pop()||0,Ut=qe.pop()||0,xi=qe.pop()||0;if(Ut-xi<=je){for(let je=xi;je<=Ut;je++){const qe=Fe[2*je],vt=Fe[2*je+1];qe>=k&&qe<=Me&&vt>=F&&vt<=Ae&&pt.push(Oe[je])}continue}const vi=xi+Ut>>1,bi=Fe[2*vi],wi=Fe[2*vi+1];bi>=k&&bi<=Me&&wi>=F&&wi<=Ae&&pt.push(Oe[vi]),(0===vt?k<=bi:F<=wi)&&(qe.push(xi),qe.push(vi-1),qe.push(1-vt)),(0===vt?Me>=bi:Ae>=wi)&&(qe.push(vi+1),qe.push(Ut),qe.push(1-vt))}return pt}within(k,F,Me){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Ae,coords:Oe,nodeSize:Fe}=this,je=[0,Ae.length-1,0],qe=[],pt=Me*Me;for(;je.length;){const vt=je.pop()||0,Ut=je.pop()||0,xi=je.pop()||0;if(Ut-xi<=Fe){for(let Me=xi;Me<=Ut;Me++)xv(Oe[2*Me],Oe[2*Me+1],k,F)<=pt&&qe.push(Ae[Me]);continue}const vi=xi+Ut>>1,bi=Oe[2*vi],wi=Oe[2*vi+1];xv(bi,wi,k,F)<=pt&&qe.push(Ae[vi]),(0===vt?k-Me<=bi:F-Me<=wi)&&(je.push(xi),je.push(vi-1),je.push(1-vt)),(0===vt?k+Me>=bi:F+Me>=wi)&&(je.push(vi+1),je.push(Ut),je.push(1-vt))}return qe}}function dv(k,F,Me,Ae,Oe,Fe){if(Oe-Ae<=Me)return;const je=Ae+Oe>>1;mv(k,F,je,Ae,Oe,Fe),dv(k,F,Me,Ae,je-1,1-Fe),dv(k,F,Me,je+1,Oe,1-Fe)}function mv(k,F,Me,Ae,Oe,Fe){for(;Oe>Ae;){if(Oe-Ae>600){const je=Oe-Ae+1,qe=Me-Ae+1,pt=Math.log(je),vt=.5*Math.exp(2*pt/3),Ut=.5*Math.sqrt(pt*vt*(je-vt)/je)*(qe-je/2<0?-1:1);mv(k,F,Me,Math.max(Ae,Math.floor(Me-qe*vt/je+Ut)),Math.min(Oe,Math.floor(Me+(je-qe)*vt/je+Ut)),Fe)}const je=F[2*Me+Fe];let qe=Ae,pt=Oe;for(yv(k,F,Ae,Me),F[2*Oe+Fe]>je&&yv(k,F,Ae,Oe);qe<pt;){for(yv(k,F,qe,pt),qe++,pt--;F[2*qe+Fe]<je;)qe++;for(;F[2*pt+Fe]>je;)pt--}F[2*Ae+Fe]===je?yv(k,F,Ae,pt):(pt++,yv(k,F,pt,Oe)),pt<=Me&&(Ae=pt+1),Me<=pt&&(Oe=pt-1)}}function yv(k,F,Me,Ae){gv(k,Me,Ae),gv(F,2*Me,2*Ae),gv(F,2*Me+1,2*Ae+1)}function gv(k,F,Me){const Ae=k[F];k[F]=k[Me],k[Me]=Ae}function xv(k,F,Me,Ae){const Oe=k-Me,Fe=F-Ae;return Oe*Oe+Fe*Fe}F.$=Ha,F.A=tr,F.B=2,F.C=jf,F.D=zy,F.E=we,F.F=$f,F.G=class extends Zm{},F.H=hr,F.I=wg,F.J=Te,F.K=Xa,F.L=Oi,F.M=Li,F.N=Fi,F.O=Hi,F.P=Sa,F.Q=Za,F.R=sh,F.S=Qi,F.T=dm,F.U=Wi,F.V=Zm,F.W=Bn,F.X=Cn,F.Y=Tn,F.Z=yr,F._=eu,F.a=function(k){return Jl.API_CDN_URL_REGEX.test(k)},F.a$=lv,F.a0=Ni,F.a1=Ri,F.a2=function(k){const F=k.value;let Me=[];if(!F)return Me;const Ae=hr(F);return"string"!==Ae?(Me=Me.concat([new Zm(k.key,F,`string expected, "${Ae}" found`)]),Me):(Hm(F,!0)||(Me=Me.concat([new Zm(k.key,F,`invalid url "${F}"`)])),Me)},F.a3=Xp,F.a4=La,F.a5=Ga,F.a6=ja,F.a7=class{constructor(k){this.specification=k}possiblyEvaluate(k,F){return yt(k.expression.evaluate(F))}interpolate(k,F,Me){return{x:ze(k.x,F.x,Me),y:ze(k.y,F.y,Me),z:ze(k.z,F.z,Me),azimuthal:ze(k.azimuthal,F.azimuthal,Me),polar:ze(k.polar,F.polar,Me)}}},F.a8=Va,F.a9=Ji,F.aA=cl,F.aB=class{constructor(k){this.entries={},this.scheduler=k}request(k,F,Me,Ae){const Oe=this.entries[k]=this.entries[k]||{callbacks:[]};if(Oe.result){const[k,Me]=Oe.result;return this.scheduler?this.scheduler.add((()=>{Ae(k,Me)}),F):Ae(k,Me),()=>{}}return Oe.callbacks.push(Ae),Oe.cancel||(Oe.cancel=Me(((Me,Ae)=>{Oe.result=[Me,Ae];for(const k of Oe.callbacks)this.scheduler?this.scheduler.add((()=>{k(Me,Ae)}),F):k(Me,Ae);setTimeout((()=>delete this.entries[k]),3e3)}))),()=>{Oe.result||(Oe.callbacks=Oe.callbacks.filter((k=>k!==Ae)),Oe.callbacks.length||(Oe.cancel(),delete this.entries[k]))}}},F.aC=us,F.aD=function(F,Me,Ae){const Oe=JSON.stringify(F.request);return F.data&&((this||k).deduped.entries[Oe]={result:[null,F.data]}),(this||k).deduped.request(Oe,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom},(k=>{const Me=ie(F.request,((F,Me,Oe,Fe)=>{F?k(F):Me&&k(null,{vectorTile:Ae?void 0:new P_.VectorTile(new Ly(Me)),rawData:Me,cacheControl:Oe,expires:Fe})}));return()=>{Me.cancel(),k()}}),Me)},F.aE=function(k){Qc++,Qc>$c&&(k.getActor().send("enforceCacheSizeLimit",Hc),Qc=0)},F.aF=function(k){return k<=1?1:Math.pow(2,Math.floor(Math.log(k)/Math.LN2))},F.aG=iu,F.aH=_m,F.aI=Pm,F.aJ=vm,F.aK=function(k,F){const Me=document.createElement("video");Me.muted=!0,Me.onloadstart=function(){F(null,Me)};for(let F=0;F<k.length;F++){const Ae=document.createElement("source");ae(k[F])||(Me.crossOrigin="Anonymous"),Ae.src=k[F],Me.appendChild(Ae)}return{cancel:()=>{}}},F.aL=mm,F.aM=function(k){return fetch(k).then((k=>k.arrayBuffer())).then((F=>Hx(F,0,k)))},F.aN=nv,F.aO=class{constructor(k,F,Me,Ae){this.id=k,this.position=null!=F?new il(F[0],F[1]):new il(0,0),this.orientation=null!=Me?Me:[0,0,0],this.nodes=Ae,this.uploaded=!1,this.aabb=new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(k,F){if(aa.mat4.multiply(k.matrix,F,k.matrix),k.meshes)for(const F of k.meshes){const Me=xu.applyTransformFast(F.aabb,k.matrix);this.aabb.encapsulate(Me)}if(k.children)for(const F of k.children)this._applyTransformations(F,k.matrix)}computeBoundsAndApplyParent(){const k=aa.mat4.identity([]);for(const F of this.nodes)this._applyTransformations(F,k)}computeModelMatrix(k,F,Me,Ae,Oe,Fe,je=!1){ny(this.matrix,this,k.transform,this.position,F,Me,Ae,Oe,Fe,je)}upload(k){if(!this.uploaded){for(const F of this.nodes)sy(F,k);for(const k of this.nodes)oy(k);this.uploaded=!0}}destroy(){for(const k of this.nodes)ly(k)}},F.aP=ot,F.aQ=wd,F.aR=pl,F.aS=fl,F.aT=bs,F.aU=Ls,F.aV=at,F.aW=Js,F.aX=tm,F.aY=function(){$p.isLoading()||$p.isLoaded()||"deferred"!==ka()||Ta()},F.aZ=Wa,F.a_=El,F.aa=bl,F.ab=aa,F.ac=tt,F.ad=Ua,F.ae=Fu,F.af=ze,F.ag=Td,F.ah=Ee,F.ai=X,F.aj=Ie,F.ak=class{constructor(k){this.specification=k}possiblyEvaluate(k,F){return function([k,F]){const Me=yt([1,k,F]);return{x:Me.x,y:Me.y,z:Me.z}}(k.expression.evaluate(F))}interpolate(k,F,Me){return{x:ze(k.x,F.x,Me),y:ze(k.y,F.y,Me),z:ze(k.z,F.z,Me)}}},F.al=function(k,F,Me=0,Ae=!0){const Oe=new Sa(Me,Me),Fe=k.sub(Oe),je=F.add(Oe),qe=[Fe,new Sa(je.x,Fe.y),je,new Sa(Fe.x,je.y)];return Ae&&qe.push(Fe.clone()),qe},F.am=function(k,F){const Me=[];for(let Ae=0;Ae<k.length;Ae++){const Oe=et(Ae-1,-1,k.length-1),Fe=et(Ae+1,-1,k.length-1),je=k[Ae],qe=k[Fe],pt=k[Oe].sub(je).unit(),vt=qe.sub(je).unit(),Ut=vt.angleWithSep(pt.x,pt.y),xi=pt.add(vt).unit().mult(-1*F/Math.sin(Ut/2));Me.push(je.add(xi))}return Me},F.an=Md,F.ao=ql,F.ap=function(k,F,Me=0){return aa.vec3.fromValues(((F.x-Me)*k.scale-k.x)*Td,(F.y*k.scale-k.y)*Td,dl(F.z,F.y))},F.aq=hu,F.ar=zp,F.as=function(k){let F=1/0,Me=1/0,Ae=-1/0,Oe=-1/0;for(const Fe of k)F=Math.min(F,Fe.x),Me=Math.min(Me,Fe.y),Ae=Math.max(Ae,Fe.x),Oe=Math.max(Oe,Fe.y);return{min:new Sa(F,Me),max:new Sa(Ae,Oe)}},F.at=ul,F.au=jl,F.av=wl,F.aw=Q,F.ax=Wf,F.ay=function(k,F){const Me={};for(let Ae=0;Ae<F.length;Ae++){const Oe=F[Ae];Oe in k&&(Me[Oe]=k[Oe])}return Me},F.az=al,F.b=function(k){return Jl.API_FONTS_REGEX.test(k)},F.b$=Bm,F.b0=xt,F.b1=Ap,F.b2=Uc,F.b3=zl,F.b4=xs,F.b5=Ys,F.b6=Xm,F.b7=po,F.b8=hc,F.b9=Ux,F.bA=kh,F.bB=pd,F.bC=hd,F.bD=Ef,F.bE=fv,F.bF=et,F.bG=bt,F.bH=hl,F.bI=function(k,F,Me){k[4*F+0]=Me[0],k[4*F+1]=Me[1],k[4*F+2]=Me[2],k[4*F+3]=Me[3]},F.bJ=Eo,F.bK=Ao,F.bL=So,F.bM=Mo,F.bN=wo,F.bO=il,F.bP=$d,F.bQ=nu,F.bR=gu,F.bS=Tm,F.bT=ru,F.bU=Pu,F.bV=function(k,F,Me,Ae,Oe,Fe,je,qe,pt){if("globe"===pt.name)return Pu(k,F,new ru(Me,Ae,Oe),!1);const vt=wd({z:Me,x:Ae,y:Oe},pt);return new xu([(Fe+vt.x/vt.scale)*F,F*(vt.y/vt.scale),je],[(Fe+vt.x2/vt.scale)*F,F*(vt.y2/vt.scale),qe])},F.bW=function(k,F,Me){let Ae=0;for(let Me=0;Me<2;++Me){const Oe=0;k[Me]>Oe&&(Ae+=(k[Me]-Oe)*(k[Me]-Oe)),F[Me]<Oe&&(Ae+=(Oe-F[Me])*(Oe-F[Me]))}return Ae},F.bX=wm,F.bY=Jf,F.bZ=function(k){const F=aa.mat4.identity(new Float64Array(16));aa.mat4.multiply(F,k.pixelMatrix,k.globeMatrix);const Me=[0,om,0],Ae=[0,lm,0];return aa.vec3.transformMat4(Me,Me,F),aa.vec3.transformMat4(Ae,Ae,F),[Me[0]>0&&Me[0]<=k.width&&Me[1]>0&&Me[1]<=k.height&&!Nu(k,new il(k.center.lat,90)),Ae[0]>0&&Ae[0]<=k.width&&Ae[1]>0&&Ae[1]<=k.height&&!Nu(k,new il(k.center.lat,-90))]},F.b_=function(k,F){const{scale:Me}=k.tileTransform,Ae=Me*Td/(k.tileSize*Math.pow(2,F.zoom-k.tileID.overscaledZ+k.tileID.canonical.z));return aa.mat2.scale(new Float32Array(4),F.inverseAdjustmentMatrix,[Ae,Ae])},F.ba=function(k,F){const Me=Fu(F.zoom);if(0===Me)return Au(k);const Ae=zu(k),Oe=Eu(Ae),Fe=ul(Ae.getWest())*F.worldSize,je=ul(Ae.getEast())*F.worldSize,qe=cl(Ae.getNorth())*F.worldSize,pt=cl(Ae.getSouth())*F.worldSize,vt=[Fe,qe,0],Ut=[je,qe,0],xi=[Fe,pt,0],vi=[je,pt,0],bi=aa.mat4.invert([],F.globeMatrix);return aa.vec3.transformMat4(vt,vt,bi),aa.vec3.transformMat4(Ut,Ut,bi),aa.vec3.transformMat4(xi,xi,bi),aa.vec3.transformMat4(vi,vi,bi),Oe[0]=Su(Oe[0],xi,Me),Oe[1]=Su(Oe[1],vi,Me),Oe[2]=Su(Oe[2],Ut,Me),Oe[3]=Su(Oe[3],vt,Me),xu.fromPoints(Oe)},F.bb=Vu,F.bc=ku,F.bd=Su,F.be=vs,F.bf=$m,F.bg=Ax,F.bh=Ly,F.bi=ie,F.bj=function(k){const F=[];for(const Me in k)F.push(k[Me]);return F},F.bk=function(k,F){const Me=[];for(const Ae in k)Ae in F||Me.push(Ae);return Me},F.bl=rt,F.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],F.bn=$,F.bo=function(k,F){const{x:Me,y:Ae}=k.point,Oe=Ru(Me,Ae,k.worldSize/k._pixelsPerMercatorPixel,0,0);return aa.mat4.multiply(Oe,Oe,Cu(Au(F)))},F.bp=Qp,F.bq=By,F.br=Jp,F.bs=function(k,F,Me,Ae,Oe){const Fe=5*F+2;k.float32[Fe+0]=Me,k.float32[Fe+1]=Ae,k.float32[Fe+2]=Oe},F.bt=Wd,F.bu=Uf,F.bv=Vl,F.bw=dy,F.bx=bh,F.by=Cv,F.bz=Eh,F.c=Pt,F.c$=(k,F,Me,Ae,Oe,Fe,je,qe)=>{const pt=k.transform,vt=pt.pitch<15?Ep(.07,.7,Q((14-pt.zoom)/5,0,1)):.07,Ut="none"===Me.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Tp(k,F,Me,Ae),u_texsize:F.imageAtlasTexture?F.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:pt.calculatePixelsToTileUnitsMatrix(F),u_device_pixel_ratio:Oe,u_width_scale:Fe,u_floor_width_scale:je,u_image:0,u_tile_units_to_pixels:kp(F,pt),u_units_to_pixels:[1/pt.pixelsToGLUnits[0],1/pt.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:qe,u_trim_fade_range:Me.paint.get("line-trim-fade-range"),u_trim_color:Me.paint.get("line-trim-color").toRenderColor(Ut?null:Me.lut).toArray01(),u_emissive_strength:Me.paint.get("line-emissive-strength"),u_zbias_factor:vt,u_tile_to_meter:vl(F.tileID.canonical,0)}},F.c0=km,F.c1=function(k){const F=km(k,!0);return aa.mat2.invert([],[F[0],F[1],F[4],F[5]])},F.c2=pu,F.c3=function(k){const{x:F,y:Me}=k.point,{lng:Ae,lat:Oe}=k._center;return Ru(F,Me,k.worldSize,Ae,Oe)},F.c4=Z,F.c5=au,F.c6=Yf,F.c7=function(k){const F=Math.round((k+45+360)%360/90)%4;return sl[F]},F.c8=45,F.c9=ll,F.cA=class extends _o{constructor(k){super(k),this.current=xf}set(k,F,Me){if(this.fetchUniformLocation(k,F))for(let k=0;k<9;k++)if(Me[k]!==this.current[k]){this.current=Me,this.gl.uniformMatrix3fv(this.location,!1,Me);break}}},F.cB=W,F.cC=function(k,F,Me){const Ae=Fu(Me.zoom),Oe=k.style.map._antialias,Fe=F.options.extStandardDerivativesForceOff||k.terrain&&k.terrain.exaggeration()>0;return 0===Ae&&!Oe&&!Fe},F.cD=function(k){const F=k.pixelsPerMeter,Me=F/hl(1,k.center.lat),Ae=aa.mat4.identity(new Float64Array(16));return aa.mat4.translate(Ae,Ae,[k.point.x,k.point.y,0]),aa.mat4.scale(Ae,Ae,[Me,Me,F]),Float32Array.from(Ae)},F.cE=zu,F.cF=function(k){const F=wm-5;k=Q(k,-F,F)/F*90;const Me=Math.pow(Math.abs(Math.sin(X(k))),3);return Math.round(Me*(nm.length-1))},F.cG=function(k,F,Me,Ae){const Oe=F.getNorth(),Fe=F.getSouth(),je=F.getWest(),qe=F.getEast(),pt=1<<k.z,vt=qe-je,Ut=Oe-Fe,xi=vt/rm,vi=-Ut/nm[Me],bi=[0,xi,0,vi,0,0,Oe,je,0];if(k.z>0){const k=180/Ae;aa.mat3.multiply(bi,bi,[k/vt+1,0,0,0,k/Ut+1,0,-.5*k/xi,.5*k/vi,1])}return bi[2]=pt,bi[5]=k.x,bi[8]=k.y,bi},F.cH=Au,F.cI=function(k,F,Me){const Ae=aa.mat4.identity(new Float64Array(16)),Oe=(F/(1<<k)-.5)*Math.PI*2;return aa.mat4.rotateY(Ae,Me.globeMatrix,Oe),Float32Array.from(Ae)},F.cJ=class{isDataAvailableAtPoint(k){const F=this._source();if(this.isUsingMockSource()||!F||k.y<0||k.y>1)return!1;const Me=F.getSource().maxzoom,Ae=1<<Me,Oe=Math.floor(k.x),Fe=Math.floor((k.x-Oe)*Ae),je=Math.floor(k.y*Ae),qe=this.findDEMTileFor(new iu(Me,Oe,Me,Fe,je));return!(!qe||!qe.dem)}getAtPointOrZero(k,F=0){return this.getAtPoint(k,F)||0}getAtPoint(k,F,Me=!0){if(this.isUsingMockSource())return null;null==F&&(F=null);const Ae=this._source();if(!Ae)return F;if(k.y<0||k.y>1)return F;const Oe=Ae.getSource().maxzoom,Fe=1<<Oe,je=Math.floor(k.x),qe=k.x-je,pt=new iu(Oe,je,Oe,Math.floor(qe*Fe),Math.floor(k.y*Fe)),vt=this.findDEMTileFor(pt);if(!vt||!vt.dem)return F;const Ut=vt.dem,xi=1<<vt.tileID.canonical.z,vi=(qe*xi-vt.tileID.canonical.x)*Ut.dim,bi=(k.y*xi-vt.tileID.canonical.y)*Ut.dim,wi=Math.floor(vi),Mi=Math.floor(bi);return(Me?this.exaggeration():1)*ze(ze(Ut.get(wi,Mi),Ut.get(wi,Mi+1),bi-Mi),ze(Ut.get(wi+1,Mi),Ut.get(wi+1,Mi+1),bi-Mi),vi-wi)}getAtTileOffset(k,F,Me){const Ae=1<<k.canonical.z;return this.getAtPointOrZero(new bl(k.wrap+(k.canonical.x+F/Td)/Ae,(k.canonical.y+Me/Td)/Ae))}getAtTileOffsetFunc(k,F,Me,Ae){return Oe=>{const Fe=this.getAtTileOffset(k,Oe.x,Oe.y),je=Ae.upVector(k.canonical,Oe.x,Oe.y),qe=Ae.upVectorScale(k.canonical,F,Me).metersToTile;return aa.vec3.scale(je,je,Fe*qe),je}}getForTilePoints(k,F,Me,Ae){if(this.isUsingMockSource())return!1;const Oe=uy.create(this,k,Ae);return!!Oe&&(F.forEach((k=>{k[2]=this.exaggeration()*Oe.getElevationAt(k[0],k[1],Me)})),!0)}getMinMaxForTile(k){if(this.isUsingMockSource())return null;const F=this.findDEMTileFor(k);if(!F||!F.dem)return null;const Me=F.dem.tree,Ae=F.tileID,Oe=1<<k.canonical.z-Ae.canonical.z;let Fe=k.canonical.x/Oe-Ae.canonical.x,je=k.canonical.y/Oe-Ae.canonical.y,qe=0;for(let F=0;F<k.canonical.z-Ae.canonical.z&&!Me.leaves[qe];F++){Fe*=2,je*=2;const k=2*Math.floor(je)+Math.floor(Fe);qe=Me.childOffsets[qe]+k,Fe%=1,je%=1}return{min:this.exaggeration()*Me.minimums[qe],max:this.exaggeration()*Me.maximums[qe]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(k,F,Me){throw new Error("Pure virtual method called.")}pointCoordinate(k){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(k){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const k=this.visibleDemTiles;if(0===k.length)return null;let F=!1,Me=Number.MAX_VALUE,Ae=Number.MIN_VALUE;for(const Oe of k){const k=this.getMinMaxForTile(Oe.tileID);k&&(Me=Math.min(Me,k.min),Ae=Math.max(Ae,k.max),F=!0)}return F?{min:Me,max:Ae}:null}},F.cK=oc,F.cL=vu,F.cM=function(k,F){return[Math.pow(k[0],2.2)*F,Math.pow(k[1],2.2)*F,Math.pow(k[2],2.2)*F]},F.cN=Lu,F.cO=At,F.cP=Mt,F.cQ=256,F.cR=function(k,F){const Me=[0,0,0],Ae=Vu(Au(F.canonical));return aa.vec3.transformMat4(Me,Me,Ae),aa.vec3.transformMat4(Me,Me,k),Me},F.cS=k=>({u_camera_to_center_distance:new Mo(k),u_extrude_scale:new Bo(k),u_device_pixel_ratio:new Mo(k),u_matrix:new Eo(k),u_inv_rot_matrix:new Eo(k),u_merc_center:new Ao(k),u_tile_id:new So(k),u_zoom_transition:new Mo(k),u_up_dir:new So(k),u_emissive_strength:new Mo(k)}),F.cT=k=>({u_matrix:new Eo(k),u_pixels_to_tile_units:new Bo(k),u_device_pixel_ratio:new Mo(k),u_width_scale:new Mo(k),u_floor_width_scale:new Mo(k),u_units_to_pixels:new Ao(k),u_dash_image:new wo(k),u_gradient_image:new wo(k),u_image_height:new Mo(k),u_texsize:new Ao(k),u_tile_units_to_pixels:new Mo(k),u_alpha_discard_threshold:new Mo(k),u_trim_offset:new Ao(k),u_trim_fade_range:new Ao(k),u_trim_color:new Io(k),u_emissive_strength:new Mo(k),u_zbias_factor:new Mo(k),u_tile_to_meter:new Mo(k)}),F.cU=k=>({u_matrix:new Eo(k),u_texsize:new Ao(k),u_pixels_to_tile_units:new Bo(k),u_device_pixel_ratio:new Mo(k),u_width_scale:new Mo(k),u_floor_width_scale:new Mo(k),u_image:new wo(k),u_units_to_pixels:new Ao(k),u_tile_units_to_pixels:new Mo(k),u_alpha_discard_threshold:new Mo(k),u_trim_offset:new Ao(k),u_trim_fade_range:new Ao(k),u_trim_color:new Io(k),u_emissive_strength:new Mo(k),u_zbias_factor:new Mo(k),u_tile_to_meter:new Mo(k)}),F.cV=Cs,F.cW=hy,F.cX=Sy,F.cY=Gu,F.cZ=(k,F,Me,Ae,Oe,Fe)=>{const je=k.transform,qe="globe"===je.projection.name;let pt;if("map"===Fe.paint.get("circle-pitch-alignment"))if(qe){const k=Lu(je.zoom,F.canonical)*je._pixelsPerMercatorPixel;pt=Float32Array.from([k,0,0,k])}else pt=je.calculatePixelsToTileUnitsMatrix(Me);else pt=new Float32Array([je.pixelsToGLUnits[0],0,0,je.pixelsToGLUnits[1]]);const vt={u_camera_to_center_distance:k.transform.getCameraToCenterDistance(je.projection),u_matrix:k.translatePosMatrix(F.projMatrix,Me,Fe.paint.get("circle-translate"),Fe.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Gc.devicePixelRatio,u_extrude_scale:pt,u_inv_rot_matrix:r_,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:Fe.paint.get("circle-emissive-strength")};if(qe){vt.u_inv_rot_matrix=Ae,vt.u_merc_center=Oe,vt.u_tile_id=[F.canonical.x,F.canonical.y,1<<F.canonical.z],vt.u_zoom_transition=Fu(je.zoom);const k=Oe[0]*Td,Me=Oe[1]*Td;vt.u_up_dir=je.projection.upVector(new ru(0,0,0),k,Me)}return vt},F.c_=Bp,F.ca=Io,F.cb=function(k,F,Me){const Ae=Math.sqrt(k*k+F*F+Me*Me),Oe=Ae>0?Math.acos(Me/Ae)*rl:0;let Fe=0!==k||0!==F?Math.atan2(-F,-k)*rl+90:0;return Fe<0&&(Fe+=360),[Ae,Fe,Oe]},F.cc=vl,F.cd=xu,F.ce=yt,F.cf=function(k){return[Math.pow(k[0],1/2.2),Math.pow(k[1],1/2.2),Math.pow(k[2],1/2.2)]},F.cg=function(k,F){return k.readFields(Oy,{icons:[]},F)},F.ch=function(k){return k({pluginStatus:qp,pluginURL:Zp}),Hp.on("pluginStateChange",k),k},F.ci=Ty,F.cj=Kf,F.ck=nx,F.cl=ah,F.cm=Pa,F.cn=Rt,F.co=Fh,F.cp=ht,F.cq=function(k){const F=k.indexOf(tf);return F>=0?k.slice(0,F):k},F.cr=function(k){return k.indexOf(tf)>=0},F.cs=function(k){const F=k.indexOf(tf);return F>=0?k.slice(F+1):""},F.ct=function(k){const F=[],Me=k.id;return void 0===Me&&F.push({message:`layers.${Me}: missing required property "id"`}),void 0===k.render&&F.push({message:`layers.${Me}: missing required method "render"`}),k.renderingMode&&"2d"!==k.renderingMode&&"3d"!==k.renderingMode&&F.push({message:`layers.${Me}: property "renderingMode" must be either "2d" or "3d"`}),F},F.cu=function(k,F,Me,Ae){return"custom"===k.type?new zm(k,F):new Fv[k.type](k,F,Me,Ae)},F.cv=ct,F.cw=class extends lv{constructor(k,F){super(k._vectorTileFeature,k._z,k._x,k._y,k.id),k.state&&(this.state={...k.state}),this.target=F.target,this.namespace=F.namespace,F.properties&&(this.properties=F.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=k.source,this.sourceLayer=k.sourceLayer,this.layer=k.layer)}toJSON(){const k=super.toJSON();return k.target=this.target,k.namespace=this.namespace,k}},F.cx=Hp,F.cy=ne,F.cz=Po,F.d=function(k){return Jl.API_TILEJSON_REGEX.test(k)},F.d$=ut,F.d0=(k,F,Me,Ae,Oe,Fe,je,qe,pt)=>{const vt=k.transform,Ut=vt.calculatePixelsToTileUnitsMatrix(F),xi="none"===Me.paint.get("line-trim-color-use-theme").constantOr("default"),vi=vt.pitch<15?Ep(.07,.7,Q((14-vt.zoom)/5,0,1)):.07;return{u_matrix:Tp(k,F,Me,Ae),u_pixels_to_tile_units:Ut,u_device_pixel_ratio:Fe,u_width_scale:je,u_floor_width_scale:qe,u_units_to_pixels:[1/vt.pixelsToGLUnits[0],1/vt.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:Oe,u_texsize:Vp(Me)&&F.lineAtlasTexture?F.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:kp(F,k.transform),u_alpha_discard_threshold:0,u_trim_offset:pt,u_trim_fade_range:Me.paint.get("line-trim-fade-range"),u_trim_color:Me.paint.get("line-trim-color").toRenderColor(xi?null:Me.lut).toArray01(),u_emissive_strength:Me.paint.get("line-emissive-strength"),u_zbias_factor:vi,u_tile_to_meter:vl(F.tileID.canonical,0)}},F.d1=st,F.d2=lc,F.d3=ap,F.d4=jm,F.d5=Kh,F.d6=V_,F.d7=450,F.d8=7,F.d9=qx,F.dA=ml,F.dB=xl,F.dC=el,F.dD=function([k,F,Me]){const Ae=Math.hypot(k,F,Me),Oe=Math.atan2(k,Me),Fe=.5*Math.PI-Math.acos(-F/Ae);return new il(Z(Oe),Z(Fe))},F.dE=Cm,F.dF=function(k){const F=k.navigator?k.navigator.userAgent:null;return!!function(k){if(null==Kl){const F=k.navigator?k.navigator.userAgent:null;Kl=!!k.safari||!(!F||!(/\b(iPad|iPhone|iPod)\b/.test(F)||F.match("Safari")&&!F.match("Chrome")))}return Kl}(k)&&F&&(F.match("Version/15.4")||F.match("Version/15.5")||F.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},F.dG=function(k,F){Hc=k,$c=F},F.dH=Nu,F.dI=Ou,F.dJ=function(k){const F=[0,0,0],Me=aa.mat4.identity(new Float64Array(16));return aa.mat4.multiply(Me,k.pixelMatrix,k.globeMatrix),aa.vec3.transformMat4(F,F,Me),new Sa(F[0],F[1])},F.dK=function(k,F,Me=!1){if(qp===Np||qp===Up||qp===jp)throw new Error("setRTLTextPlugin cannot be called multiple times.");Zp=Gc.resolveURL(k),qp=Np,Gp=F,za(),Me||Ta()},F.dL=ka,F.dM=function(){Ty().acquire(Nv)},F.dN=function(){const k=Vv;k&&(k.isPreloaded()&&1===k.numActive()?(k.release(Nv),Vv=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},F.dO=Py,F.dP=function(k){const F=$t();if(!F)return;const Me=F.delete(qc);k&&Me.catch(k).then((()=>k()))},F.dQ=Bv,F.dR=Vx,F.dS=function(k){wb=Gc.resolveURL(k),Eb||(Eb=new zy(Ty(),new we)),Eb.broadcast("setDracoUrl",wb)},F.dT=Cx,F.dU=function(k){Sb=Gc.resolveURL(k),Eb||(Eb=new zy(Ty(),new we)),Eb.broadcast("setMeshoptUrl",Sb)},F.dV=oa,F.dW=ac,F.dX=rx,F.dY=sv,F.dZ=uv,F.d_=bp,F.da=ys,F.db=Hs,F.dc=256,F.dd=Cu,F.de=As,F.df=Ns,F.dg=Us,F.dh=function(k,F,Me,Ae,Oe){return Q((k-F)/(Me-F)*(Oe-Ae)+Ae,Ae,Oe)},F.di=Ii,F.dj=gl,F.dk=class{constructor(k,F,Me,Ae){this.context=k,this.format=Ae,this.size=Me,this.texture=k.gl.createTexture();const[Oe,Fe,je]=this.size,{gl:qe}=k;qe.bindTexture(qe.TEXTURE_3D,this.texture),k.pixelStoreUnpackFlipY.set(!1),k.pixelStoreUnpack.set(1),k.pixelStoreUnpackPremultiplyAlpha.set(!1),qe.texImage3D(qe.TEXTURE_3D,0,this.format,Oe,Fe,je,0,pm(this.format),fm(this.format),F.data)}bind(k,F){const{context:Me}=this,{gl:Ae}=Me;Ae.bindTexture(Ae.TEXTURE_3D,this.texture),k!==this.minFilter&&(Ae.texParameteri(Ae.TEXTURE_3D,Ae.TEXTURE_MAG_FILTER,k),Ae.texParameteri(Ae.TEXTURE_3D,Ae.TEXTURE_MIN_FILTER,k),this.minFilter=k),F!==this.wrapS&&(Ae.texParameteri(Ae.TEXTURE_3D,Ae.TEXTURE_WRAP_S,F),Ae.texParameteri(Ae.TEXTURE_3D,Ae.TEXTURE_WRAP_T,F),this.wrapS=F)}destroy(){const{gl:k}=this.context;k.deleteTexture(this.texture),this.texture=null}},F.dl=Fm,F.dm=[1,1,1],F.dn=uy,F.dp=Rv,F.dq=Ts,F.dr=$s,F.ds=cm,F.dt=qs,F.du=js,F.dv=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Sa(1/0,1/0),max:new Sa(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(k,F=!1){const Me=Sh(new Sa(0,0),new Sa(Td,Td),k),Ae=[];if(F&&!Mh(Me,this._globalClipBounds))return Ae;for(const F of this._activeRegions){if(F.hiddenByOverlap)continue;if(!Mh(Me,F))continue;const Oe=Ih(F.min,F.max,k);Ae.push({min:Oe.min,max:Oe.max,sourceId:this._sourceIds[F.priority],footprint:F.footprint,footprintTileId:F.tileId,order:F.order,clipMask:F.clipMask,clipScope:F.clipScope})}return Ae}setSources(k){this._setSources(k.map((k=>({getSourceId:()=>k.cache.id,getFootprints:()=>{const F=[];for(const Me of k.cache.getVisibleCoordinates()){const Ae=k.cache.getTile(Me).buckets[k.layer];Ae&&Ae.updateFootprints(Me.toUnwrapped(),F)}return F},getOrder:()=>k.order,getClipMask:()=>k.clipMask,getClipScope:()=>k.clipScope}))))}_addSource(k){const F=k.getFootprints();if(0===F.length)return;const Me=k.getOrder(),Ae=k.getClipMask(),Oe=k.getClipScope();for(const k of F){if(!k.footprint)continue;const F=Sh(k.footprint.min,k.footprint.max,k.id);this._activeRegions.push({min:F.min,max:F.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:k.id,footprint:k.footprint,order:Me,clipMask:Ae,clipScope:Oe})}this._sourceIds.push(k.getSourceId())}_computeReplacement(){this._activeRegions.sort(((k,F)=>k.priority-F.priority||_h(k.min,F.min)||_h(k.max,F.max)||k.order-F.order||k.clipMask-F.clipMask||function(k,F){const r=(k,F)=>k+F;return k.length-F.length||k.reduce(r,"").localeCompare(F.reduce(r,""))}(k.clipScope,F.clipScope)));let k=this._activeRegions.length!==this._prevRegions.length;if(!k){let F=0;for(;!k&&F!==this._activeRegions.length;){const Me=this._activeRegions[F],Ae=this._prevRegions[F];k=Me.priority!==Ae.priority||!wh(Me,Ae)||Me.order!==Ae.order||Me.clipMask!==Ae.clipMask||!$(Me.clipScope,Ae.clipScope),++F}}if(k){++this._updateTime;for(const k of this._activeRegions)k.order!==D_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,k.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,k.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,k.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,k.max.y));const t=k=>{const F=this._activeRegions;if(k>=F.length)return k;const Me=F[k].priority;for(;k<F.length&&F[k].priority===Me;)++k;return k};if(this._sourceIds.length>1){let k=0,F=t(k);for(;k!==F;){let Me=k;const Ae=k;for(;Me!==F;){const k=this._activeRegions[Me];k.hiddenByOverlap=!1;for(let F=0;F<Ae;F++){const Me=this._activeRegions[F];if(!Me.hiddenByOverlap&&k.order===D_&&Mh(k,Me)&&(k.hiddenByOverlap=zh(k.footprint,k.tileId,Me.footprint,Me.tileId),k.hiddenByOverlap))break}++Me}k=F,F=t(k)}}}}_setSources(k){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let F=k.length-1;F>=0;F--)this._addSource(k[F]);this._computeReplacement()}},F.dw=class{constructor(k){this._createGrid(k),this._createPoles(k)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const k of this._poleSegments)k.destroy();for(const k of this._gridSegments)k.withSkirts.destroy(),k.withoutSkirts.destroy()}_fillGridMeshWithLods(k,F){const Me=new xs,Ae=new Ls,Oe=[],Fe=k+1+2,je=F[0]+1,qe=F[0]+1+(1+F.length),l=(k,F,Me)=>{let Ae=k===Fe-1?k-2:0===k?k:k-1;return Ae+=Me?24575:0,[Ae,F]};for(let k=0;k<Fe;++k)Me.emplaceBack(...l(k,0,!0));for(let k=0;k<je;++k)for(let F=0;F<Fe;++F)Me.emplaceBack(...l(F,k,(0===F||F===Fe-1)&&!0));for(let k=0;k<F.length;++k){const Ae=F[k];for(let k=0;k<Fe;++k)Me.emplaceBack(...l(k,Ae,!0))}for(let k=0;k<F.length;++k){const je=Ae.length,pt=F[k]+1+2,vt=new Ls;for(let Me=0;Me<pt-1;Me++){const Oe=Me===pt-2,je=Oe?Fe*(qe-F.length+k-Me):Fe;for(let k=0;k<Fe-1;k++){const F=Me*Fe+k;0===Me||Oe||0===k||k===Fe-2?(vt.emplaceBack(F+1,F,F+je),vt.emplaceBack(F+je,F+je+1,F+1)):(Ae.emplaceBack(F+1,F,F+je),Ae.emplaceBack(F+je,F+je+1,F+1))}}const Ut=po.simpleSegment(0,je,Me.length,Ae.length-je);for(let k=0;k<vt.uint16.length;k+=3)Ae.emplaceBack(vt.uint16[k],vt.uint16[k+1],vt.uint16[k+2]);const xi=po.simpleSegment(0,je,Me.length,Ae.length-je);Oe.push({withoutSkirts:Ut,withSkirts:xi})}return{vertices:Me,indices:Ae,segments:Oe}}_createGrid(k){const F=this._fillGridMeshWithLods(rm,nm);this._gridSegments=F.segments,this._gridBuffer=k.createVertexBuffer(F.vertices,Xm.members),this._gridIndexBuffer=k.createIndexBuffer(F.indices,!0)}_createPoles(k){const F=new Ls;for(let k=0;k<=rm;k++)F.emplaceBack(0,k+1,k+2);this._poleIndexBuffer=k.createIndexBuffer(F,!0);const Me=new Ns,Ae=new Ns,Oe=new Ns,Fe=new Ns;this._poleSegments=[];for(let k=0,F=0;k<Yf;k++){const je=360/(1<<k);Me.emplaceBack(0,-Wf,0,.5,0),Ae.emplaceBack(0,-Wf,0,.5,1),Oe.emplaceBack(0,-Wf,0,.5,.5),Fe.emplaceBack(0,-Wf,0,.5,.5);for(let k=0;k<=rm;k++){let F=k/rm,qe=0;const pt=ze(0,je,F),[vt,Ut,xi]=tl(t_,i_,pt,Wf);Me.emplaceBack(vt,Ut,xi,F,qe),Ae.emplaceBack(vt,Ut,xi,F,1-qe);const vi=X(pt);F=.5+.5*Math.sin(vi),qe=.5+.5*Math.cos(vi),Oe.emplaceBack(vt,Ut,xi,F,qe),Fe.emplaceBack(vt,Ut,xi,F,1-qe)}this._poleSegments.push(po.simpleSegment(F,0,66,64)),F+=66}this._poleNorthVertexBuffer=k.createVertexBuffer(Me,qm,!1),this._poleSouthVertexBuffer=k.createVertexBuffer(Ae,qm,!1),this._texturedPoleNorthVertexBuffer=k.createVertexBuffer(Oe,qm,!1),this._texturedPoleSouthVertexBuffer=k.createVertexBuffer(Fe,qm,!1)}getGridBuffers(k,F){return[this._gridBuffer,this._gridIndexBuffer,F?this._gridSegments[k].withSkirts:this._gridSegments[k].withoutSkirts]}getPoleBuffers(k,F){return[F?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,F?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[k]]}},F.dx=D_,F.dy=K,F.dz=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},F.e=Jl,F.e0=Qe,F.e1=Gf,F.e2=function(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut=1,xi,vi){k.createArrays(),k.tilePixelRatio=Td/(512*k.overscaling),k.compareText={},k.iconsNeedLinear=!1;const bi=k.layers[0].layout,wi=k.layers[0]._unevaluatedLayout._values,Mi={};Mi.scaleFactor=Ut,Mi.textSizeScaleRange=bi.get("text-size-scale-range"),Mi.iconSizeScaleRange=bi.get("icon-size-scale-range");const[pr,Ur]=Mi.textSizeScaleRange,[Wr,Jr]=Mi.iconSizeScaleRange;if(Mi.textScaleFactor=Q(Mi.scaleFactor,pr,Ur),Mi.iconScaleFactor=Q(Mi.scaleFactor,Wr,Jr),"composite"===k.textSizeData.kind){const{minZoom:F,maxZoom:Me}=k.textSizeData;Mi.compositeTextSizes=[wi["text-size"].possiblyEvaluate(new Va(F),qe),wi["text-size"].possiblyEvaluate(new Va(Me),qe)]}if("composite"===k.iconSizeData.kind){const{minZoom:F,maxZoom:Me}=k.iconSizeData;Mi.compositeIconSizes=[wi["icon-size"].possiblyEvaluate(new Va(F),qe),wi["icon-size"].possiblyEvaluate(new Va(Me),qe)]}Mi.layoutTextSize=wi["text-size"].possiblyEvaluate(new Va(pt+1),qe),Mi.layoutIconSize=wi["icon-size"].possiblyEvaluate(new Va(pt+1),qe),Mi.textMaxSize=wi["text-size"].possiblyEvaluate(new Va(18),qe);const Qr="map"===bi.get("text-rotation-alignment")&&"point"!==bi.get("symbol-placement"),co=bi.get("text-size");let mo=!1;for(const F of k.features)if(F.icon&&F.icon.nameSecondary){mo=!0;break}for(const Fe of k.features){const pt=bi.get("text-font").evaluate(Fe,{},qe).join(","),Ut=co.evaluate(Fe,{},qe)*Mi.textScaleFactor,pr=Mi.layoutTextSize.evaluate(Fe,{},qe)*Mi.textScaleFactor,Ur=(Mi.layoutIconSize.evaluate(Fe,{},qe),{horizontal:{},vertical:void 0}),Wr=Fe.text;let Jr,yo=[0,0];if(Wr){const Ae=Wr.toString(),je=bi.get("text-letter-spacing").evaluate(Fe,{},qe)*dy,vt=bi.get("text-line-height").evaluate(Fe,{},qe)*dy,xi=da(Ae)?je:0,vi=bi.get("text-anchor").evaluate(Fe,{},qe),wi=bi.get("text-variable-anchor");if(!wi){const k=bi.get("text-radial-offset").evaluate(Fe,{},qe);yo=k?hd(vi,[k*dy,ax]):bi.get("text-offset").evaluate(Fe,{},qe).map((k=>k*dy))}let Mi=Qr?"center":bi.get("text-justify").evaluate(Fe,{},qe);const Jr="point"===bi.get("symbol-placement"),co=Jr?bi.get("text-max-width").evaluate(Fe,{},qe)*dy:1/0,w=Fe=>{k.allowVerticalPlacement&&fa(Ae)&&(Ur.vertical=_f(Wr,F,Me,Oe,pt,co,vt,vi,Fe,xi,yo,By.vertical,!0,pr,Ut))};if(!Qr&&wi){const k="auto"===Mi?wi.map((k=>pd(k))):[Mi];let Ae=!1;for(let Fe=0;Fe<k.length;Fe++){const je=k[Fe];if(!Ur.horizontal[je])if(Ae)Ur.horizontal[je]=Ur.horizontal[0];else{const k=_f(Wr,F,Me,Oe,pt,co,vt,"center",je,xi,yo,By.horizontal,!1,pr,Ut);k&&(Ur.horizontal[je]=k,Ae=1===k.positionedLines.length)}}w("left")}else{if("auto"===Mi&&(Mi=pd(vi)),Jr||bi.get("text-writing-mode").indexOf("horizontal")>=0||!fa(Ae)){const k=_f(Wr,F,Me,Oe,pt,co,vt,vi,Mi,xi,yo,By.horizontal,!1,pr,Ut);k&&(Ur.horizontal[Mi]=k)}w(Jr?"left":Mi)}}let To=!1,zo=!1;if(Fe.icon&&Fe.icon.namePrimary){const F=Wp(k.iconSizeData,wi["icon-size"],qe,k.zoom,Fe)*Mi.iconScaleFactor*xi,Me=Fe.icon.getPrimary().scaleSelf(F).serialize(),je=Ae[Me];je&&(Jr=Tf(Oe[Me],Fe.icon.nameSecondary?Oe[Fe.icon.getSecondary().scaleSelf(F).serialize()]:void 0,bi.get("icon-offset").evaluate(Fe,{},qe),bi.get("icon-anchor").evaluate(Fe,{},qe)),To=je.sdf,zo=je.usvg,void 0===k.sdfIcons?k.sdfIcons=je.sdf:k.sdfIcons!==je.sdf&&ft("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(je.pixelRatio!==k.pixelRatio||0!==bi.get("icon-rotate").constantOr(1))&&(k.iconsNeedLinear=!0))}const ko=gd(Ur.horizontal)||Ur.vertical;k.iconsInText||(k.iconsInText=!!ko&&ko.iconsInText),(ko||Jr)&&fd(k,Fe,Ur,Jr,Ae,Mi,pr,0,yo,To,zo,je,qe,vt,vi,mo)}Fe&&k.generateCollisionDebugBuffers(pt,k.collisionBoxArray,Mi.textScaleFactor)},F.e3=P_,F.e4=Cg,F.e5=j,F.e6=ph,F.e7=hf,F.e8=e,F.e9=function(k){let F=0;if(new Uint32Array(k,0,1)[0]!==Db){const Me=new Uint32Array(k,0,7),[,,Ae,Oe,Fe,je]=Me;F=Me.byteLength+Oe+Fe+je+Fe,(Ae!==k.byteLength||F>=k.byteLength)&&ft("Invalid b3dm header information.")}return Hx(k,F)},F.ea=function(k,F){const Me=nv(k);for(const k of Me){for(const F of k.meshes)iv(F);k.lights&&(k.lightMeshIndex=k.meshes.length,k.meshes.push(av(k.lights,F)))}return Me},F.eb=yy,F.ec=Ay,F.ed=$p,F.ee=function(k){Gt(),null!=Kc&&Kc.then((F=>{F.keys().then((Me=>{for(let Ae=0;Ae<Me.length-k;Ae++)F.delete(Me[Ae])}))}))},F.f=function(k){return 0===k.indexOf("mapbox:")},F.g=function(k,F){return ne(nt(k,{method:"GET"}),F)},F.h=It,F.i=function(k){return Jl.API_STYLE_REGEX.test(k)&&!Pt(k)},F.j=function(k){return decodeURIComponent(atob(k).split("").map((k=>"%"+("00"+k.charCodeAt(0).toString(16)).slice(-2))).join(""))},F.k=function(k){return btoa(encodeURIComponent(k).replace(/%([0-9A-F]{2})/g,((k,F)=>String.fromCharCode(Number("0x"+F)))))},F.l=nt,F.m=eh,F.n=function(k,F){return ne(nt(k,{type:"json"}),F)},F.o=ue,F.p=function(k,F){return ne(nt(k,{method:"POST"}),F)},F.q=Gc,F.r=sc,F.s=function(k){try{const F=self[k];return F.setItem("_mapbox_test_",1),F.removeItem("_mapbox_test_"),!0}catch(k){return!1}},F.t=Ct,F.u=function(){return function t(k){return k?(k^Math.random()*(16>>k/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()},F.v=function(k){return!!k&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(k)},F.w=ft,F.x=function(){return Uv||(Uv=new Py),Uv},F.y=ve,F.z=xe}));define(["./shared"],(function(F){function t(k){const F=k?k.url.toString():void 0;return F?performance.getEntriesByName(F):[]}function s(k){if("number"==typeof k||"boolean"==typeof k||"string"==typeof k||null==k)return JSON.stringify(k);if(Array.isArray(k)){let F="[";for(const Me of k)F+=`${s(Me)},`;return`${F}]`}let F="{";for(const Me of Object.keys(k).sort())F+=`${Me}:${s(k[Me])},`;return`${F}}`}function i(k){let Me="";for(const Ae of F.bm)Me+=`/${s(k[Ae])}`;return Me}class o{constructor(k){this.keyCache={},this._layers={},this._layerConfigs={},k&&this.replace(k)}replace(k,F){this._layerConfigs={},this._layers={},this.update(k,[],F)}update(k,Me,Ae){this._options=Ae;for(const Me of k)this._layerConfigs[Me.id]=Me,(this._layers[Me.id]=F.cu(Me,this.scope,null,this._options)).compileFilter(Ae),this.keyCache[Me.id]&&delete this.keyCache[Me.id];for(const k of Me)delete this.keyCache[k],delete this._layerConfigs[k],delete this._layers[k];this.familiesBySource={};const Oe=function(k,F){const Me={};for(let Ae=0;Ae<k.length;Ae++){const Oe=k[Ae];let Fe=F&&F[Oe.id];!Fe&&(Fe=i(Oe),"line"===Oe.type&&Oe.paint)&&function e(k){return"string"==typeof k&&"line-progress"===k||(Array.isArray(k)?k.some(e):!(!k||"object"!=typeof k)&&Object.values(k).some(e))}(Oe.paint["line-width"])&&(Fe+=`/${s(Oe.paint["line-width"])}`),F&&(F[Oe.id]=Fe);let je=Me[Fe];je||(je=Me[Fe]=[]),je.push(Oe)}const Ae=[];for(const k in Me)Ae.push(Me[k]);return Ae}(F.bj(this._layerConfigs),this.keyCache);for(const k of Oe){const F=k.map((k=>this._layers[k.id])),Me=F[0];if("none"===Me.visibility)continue;const Ae=Me.source||"";let Oe=this.familiesBySource[Ae];Oe||(Oe=this.familiesBySource[Ae]={});const Fe=Me.sourceLayer||"_geojsonTileLayer";let je=Oe[Fe];je||(je=Oe[Fe]=[]),je.push(F)}}}const Me=1*F.dX;class r{constructor(k){const Ae={},Oe=[];for(const F in k){const Fe=k[F],je=Ae[F]={};for(const k in Fe.glyphs){const F=Fe.glyphs[+k];if(!F||0===F.bitmap.width||0===F.bitmap.height)continue;const Ae=F.metrics.localGlyph?Me:1,qe={x:0,y:0,w:F.bitmap.width+2*Ae,h:F.bitmap.height+2*Ae};Oe.push(qe),je[k]=qe}}const{w:Fe,h:je}=F.C(Oe),qe=new F.dW({width:Fe||1,height:je||1});for(const Oe in k){const Fe=k[Oe];for(const k in Fe.glyphs){const je=Fe.glyphs[+k];if(!je||0===je.bitmap.width||0===je.bitmap.height)continue;const pt=Ae[Oe][k],vt=je.metrics.localGlyph?Me:1;F.dW.copy(je.bitmap,qe,{x:0,y:0},{x:pt.x+vt,y:pt.y+vt},je.bitmap)}}this.image=qe,this.positions=Ae}}F.dV(r,"GlyphAtlas");class a{constructor(k){this.tileID=new F.aG(k.tileID.overscaledZ,k.tileID.wrap,k.tileID.canonical.z,k.tileID.canonical.x,k.tileID.canonical.y),this.tileZoom=k.tileZoom,this.uid=k.uid,this.zoom=k.zoom,this.lut=k.lut,this.canonical=k.tileID.canonical,this.pixelRatio=k.pixelRatio,this.tileSize=k.tileSize,this.source=k.source,this.scope=k.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=k.showCollisionBoxes,this.collectResourceTiming=!!k.request&&k.request.collectResourceTiming,this.promoteId=k.promoteId,this.isSymbolTile=k.isSymbolTile,this.tileTransform=F.aQ(k.tileID.canonical,k.projection),this.projection=k.projection,this.worldview=k.worldview,this.localizableLayerIds=k.localizableLayerIds,this.brightness=k.brightness,this.extraShadowCaster=!!k.extraShadowCaster,this.tessellationStep=k.tessellationStep,this.scaleFactor=k.scaleFactor}parse(k,Me,Ae,Oe,Fe){this.status="parsing",this.data=k,this.collisionBoxArray=new F.aW;const je=new F.dY(Object.keys(k.layers).sort()),qe=new F.dZ(this.tileID,this.promoteId);qe.bucketLayerIDs=[];const pt={},vt=new F.d_(256,256),Ut={featureIndex:qe,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:vt,availableImages:Ae,brightness:this.brightness,scaleFactor:this.scaleFactor},xi=Me.familiesBySource[this.source];for(const Me in xi){const Oe=k.layers[Me];if(!Oe)continue;let Fe=!1,vt=!1,vi=!1;for(const k of xi[Me])"symbol"===k[0].type?Fe=!0:vt=!0,k[0].is3D()&&"model"!==k[0].type&&(vi=!0);if(this.extraShadowCaster&&!vi)continue;if(!0===this.isSymbolTile&&!Fe)continue;if(!1===this.isSymbolTile&&!vt)continue;1===Oe.version&&F.w(`Vector tile source "${this.source}" layer "${Me}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const bi=je.encode(Me),wi=[];for(let k=0,F=0;k<Oe.length;k++){const Ae=Oe.feature(k),Fe=qe.getId(Ae,Me);if(this.localizableLayerIds&&this.localizableLayerIds.has(Me)){const k=Ae.properties?Ae.properties.worldview:null;if(this.worldview&&"string"==typeof k)if("all"===k)Ae.properties.$localized=!0;else{if(!k.split(",").includes(this.worldview))continue;Ae.properties.$localized=!0,Ae.properties.worldview=this.worldview}}wi.push({feature:Ae,id:Fe,index:F,sourceLayerIndex:bi}),F++}for(const k of xi[Me]){const Me=k[0];(!this.extraShadowCaster||Me.is3D()&&"model"!==Me.type)&&(void 0!==this.isSymbolTile&&"symbol"===Me.type!==this.isSymbolTile||Me.minzoom&&this.zoom<Math.floor(Me.minzoom)||Me.maxzoom&&this.zoom>=Me.maxzoom||"none"!==Me.visibility&&(l(k,this.zoom,Ut.brightness,Ae),(pt[Me.id]=Me.createBucket({index:qe.bucketLayerIDs.length,layers:k,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:bi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(wi,Ut,this.tileID.canonical,this.tileTransform),qe.bucketLayerIDs.push(k.map((k=>F.aC(k.id,k.scope))))))}}let vi,bi,wi,Mi;vt.trim();const pr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},w=()=>{if(vi)return this.status="done",Fe(vi);if(this.extraShadowCaster)this.status="done",Fe(null,{buckets:F.bj(pt).filter((k=>!k.isEmpty())),featureIndex:qe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Ut.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(bi&&wi&&Mi){const k=new r(bi),Me=new F.e1(wi,Mi,this.lut);for(const Oe in pt){const Fe=pt[Oe];Fe instanceof F.aX?(l(Fe.layers,this.zoom,Ut.brightness,Ae),F.e2(Fe,bi,k.positions,wi,Me.iconPositions,this.showCollisionBoxes,Ae,this.tileID.canonical,this.tileZoom,this.projection,this.scaleFactor,this.pixelRatio,this.brightness)):Fe.hasPattern&&(Fe instanceof F.b1||Fe instanceof F.b2||Fe instanceof F.d5)&&(l(Fe.layers,this.zoom,Ut.brightness,Ae),Fe.addFeatures(Ut,this.tileID.canonical,Me.patternPositions,Ae,this.tileTransform,this.brightness))}this.status="done",Fe(null,{buckets:F.bj(pt).filter((k=>!k.isEmpty())),featureIndex:qe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:k.image,lineAtlas:vt,imageAtlas:Me,brightness:Ut.brightness})}};if(!this.extraShadowCaster){const k=F.d$(Ut.glyphDependencies,(k=>Object.keys(k).map(Number)));Object.keys(k).length?Oe.send("getGlyphs",{uid:this.uid,stacks:k,scope:this.scope},((k,F)=>{vi||(vi=k,bi=F,w())}),void 0,!1,pr):bi={};const Me=Object.keys(Ut.iconDependencies);Me.length?Oe.send("getImages",{icons:Me,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((k,F)=>{if(vi)return;vi=k;const Me={};Object.values(F).some((k=>k.usvg))?this.rasterize(Oe,Me,F,Ut.iconDependencies,(()=>{wi=Me,w()})):(this.fillImageMap(Me,Ut.iconDependencies,F),wi=Me,w())}),void 0,!1,pr):wi={};const Ae=Object.keys(Ut.patternDependencies);Ae.length?Oe.send("getImages",{icons:Ae,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((k,F)=>{if(!vi){vi=k;const Me={};Object.values(F).some((k=>k.usvg))?this.rasterize(Oe,Me,F,Ut.patternDependencies,(()=>{Mi=Me,w()})):(this.fillImageMap(Me,Ut.patternDependencies,F),Mi=Me,w())}}),void 0,!1,pr):Mi={}}w()}fillImageMap(k,F,Me){for(const Ae in Me){const Oe=F[Ae]||[];for(const F of Oe)Me[F.id].usvg||(k[F.serialize()]=Me[F.id])}}getImageTaskQueue(k,F,Me){const Ae={};for(const Oe in F){const Fe=Me[Oe]||[];for(const Me of Fe){const Oe=Me.serialize();F[Me.id].usvg?Ae[Oe]||(Ae[Oe]=Me):k[Oe]=F[Me.id]}}return Ae}rasterize(k,Me,Ae,Oe,Fe){const je=this.getImageTaskQueue(Me,Ae,Oe);this.rasterizeTask=k.send("rasterizeImages",{scope:this.scope,imageTasks:je},((k,Oe)=>{if(!k)for(const k in Oe){const{id:Fe}=F.e0.deserializeFromString(k);Me[k]=Object.assign({},Ae[Fe],{data:Oe[k]})}Fe()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function l(k,Me,Ae,Oe){const Fe=new F.a8(Me,{brightness:Ae});for(const F of k)F.recalculate(Fe,Oe)}class c extends F.E{constructor(k,Me,Ae,Oe,Fe,je){super(),this.actor=k,this.layerIndex=Me,this.availableImages=Ae,this.loadVectorData=Fe||F.aD,this.loading={},this.loaded={},this.deduped=new F.aB(k.scheduler),this.isSpriteLoaded=Oe,this.scheduler=k.scheduler,this.brightness=je}loadTile(k,Me){const Ae=k.uid,Oe=k&&k.request,Fe=Oe&&Oe.collectResourceTiming,je=this.loading[Ae]=new a(k);je.abort=this.loadVectorData(k,((qe,pt)=>{const vt=!this.loading[Ae];if(delete this.loading[Ae],je.cancelRasterize(),vt||qe||!pt)return je.status="done",vt||(this.loaded[Ae]=je),Me(qe);const Ut=pt.rawData,xi={};pt.expires&&(xi.expires=pt.expires),pt.cacheControl&&(xi.cacheControl=pt.cacheControl),je.vectorTile=pt.vectorTile||new F.e3.VectorTile(new F.bh(Ut));const f=()=>{je.parse(je.vectorTile,this.layerIndex,this.availableImages,this.actor,((k,Ae)=>{if(k||!Ae)return Me(k);const je={};if(Fe){const k=t(Oe);k.length>0&&(je.resourceTiming=JSON.parse(JSON.stringify(k)))}Me(null,F.l({rawTileData:Ut.slice(0)},Ae,xi,je))}))};this.isSpriteLoaded?f():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(f,{type:"parseTile",isSymbolTile:k.isSymbolTile,zoom:k.tileZoom}):f()})),this.loaded=this.loaded||{},this.loaded[Ae]=je}))}reloadTile(k,Me){const Ae=this.loaded,Oe=k.uid;if(Ae&&Ae[Oe]){const Fe=Ae[Oe];Fe.scaleFactor=k.scaleFactor,Fe.showCollisionBoxes=k.showCollisionBoxes,Fe.projection=k.projection,Fe.brightness=k.brightness,Fe.tileTransform=F.aQ(k.tileID.canonical,k.projection),Fe.extraShadowCaster=k.extraShadowCaster,Fe.lut=k.lut;const r=(k,F)=>{const Ae=Fe.reloadCallback;Ae&&(delete Fe.reloadCallback,Fe.parse(Fe.vectorTile,this.layerIndex,this.availableImages,this.actor,Ae)),Me(k,F)};"parsing"===Fe.status?Fe.reloadCallback=r:"done"===Fe.status&&(Fe.vectorTile?Fe.parse(Fe.vectorTile,this.layerIndex,this.availableImages,this.actor,r):r())}else Me(null,void 0)}abortTile(k,F){const Me=k.uid,Ae=this.loading[Me];Ae&&(Ae.abort&&Ae.abort(),delete this.loading[Me]),F()}removeTile(k,F){const Me=this.loaded,Ae=k.uid;Me&&Me[Ae]&&delete Me[Ae],F()}}class h{loadTile(k,Me){const{uid:Ae,encoding:Oe,rawImageData:Fe,padding:je}=k,qe=ImageBitmap&&Fe instanceof ImageBitmap?this.getImageData(Fe,je):Fe;Me(null,new F.e4(Ae,qe,Oe,je<1))}getImageData(k,F){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(k.width,k.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=k.width,this.offscreenCanvas.height=k.height,this.offscreenCanvasContext.drawImage(k,0,0,k.width,k.height);const Me=this.offscreenCanvasContext.getImageData(-F,-F,k.width+2*F,k.height+2*F);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Me}}F.bg.setPbf(F.bh);class u{decodeRasterArray({task:k,buffer:Me},Ae){F.bg.performDecoding(Me,k).then((k=>{Ae(null,k)}),(k=>{Ae(k)}))}}const Ae=F.e3.VectorTileFeature.prototype.toGeoJSON;class f{constructor(k){this._feature=k,this.extent=F.ag,this.type=k.type,this.properties=k.tags,"id"in k&&!isNaN(k.id)&&(this.id=parseInt(k.id,10))}loadGeometry(){if(1===this._feature.type){const k=[];for(const Me of this._feature.geometry)k.push([new F.P(Me[0],Me[1])]);return k}{const k=[];for(const Me of this._feature.geometry){const Ae=[];for(const k of Me)Ae.push(new F.P(k[0],k[1]));k.push(Ae)}return k}}toGeoJSON(k,F,Me){return Ae.call(this,k,F,Me)}}class p{constructor(k){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=F.ag,this.length=k.length,this._features=k}feature(k){return new f(this._features[k])}}const Oe=64/4096,Fe=128;class y{constructor(){this.features=new Map}clear(){this.features.clear()}load(k=[],F){for(const Me of k){const k=Me.id;if(null==k)continue;let Ae=this.features.get(k);Ae&&this.updateCache(Ae,F),Me.geometry?(Ae=w(Me),this.updateCache(Ae,F),this.features.set(k,Ae)):this.features.delete(k),this.updateCache(Ae,F)}}updateCache(k,F){for(const{canonical:Me,uid:Ae}of Object.values(F)){const{z:Oe,x:Fe,y:je}=Me;x(k,Math.pow(2,Oe),Fe,je)&&delete F[Ae]}}getTile(k,F,Me){const Ae=Math.pow(2,k),Oe=[];for(const k of this.features.values())x(k,Ae,F,Me)&&Oe.push(I(k,Ae,F,Me));return{features:Oe}}getFeatures(){return[...this.features.values()]}}function x({minX:k,minY:F,maxX:Me,maxY:Ae},Fe,je,qe){return k<(je+1+Oe)/Fe&&F<(qe+1+Oe)/Fe&&Me>(je-Oe)/Fe&&Ae>(qe-Oe)/Fe}function w(k){const{id:F,geometry:Me,properties:Ae}=k;if(!Me)return;if("GeometryCollection"===Me.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Oe,coordinates:Fe}=Me,je={id:F,type:1,geometry:[],tags:Ae,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},qe=je.geometry;if("Point"===Oe)b(Fe,qe,je);else if("MultiPoint"===Oe)for(const k of Fe)b(k,qe,je);else if("LineString"===Oe)je.type=2,S(Fe,qe,je);else if("MultiLineString"===Oe)je.type=2,v(Fe,qe,je);else if("Polygon"===Oe)je.type=3,v(Fe,qe,je,!0);else{if("MultiPolygon"!==Oe)throw new Error("Input data is not a valid GeoJSON object.");je.type=3;for(const k of Fe)v(k,qe,je,!0)}return je}function b([k,Me],Ae,Oe){const Fe=F.at(k);let je=F.aA(Me);je=je<0?0:je>1?1:je,Ae.push(Fe,je),Oe.minX=Math.min(Oe.minX,Fe),Oe.minY=Math.min(Oe.minY,je),Oe.maxX=Math.max(Oe.maxX,Fe),Oe.maxY=Math.max(Oe.maxY,je)}function S(k,F,Me,Ae=!1,Oe=!1){const Fe=[];for(const F of k)b(F,Fe,Me);F.push(Fe),Ae&&function(k,F){let Me=0;for(let F=0,Ae=k.length,Oe=Ae-2;F<Ae;Oe=F,F+=2)Me+=(k[F]-k[Oe])*(k[F+1]+k[Oe+1]);if(Me>0===F)for(let F=0,Me=k.length;F<Me/2;F+=2){const Ae=k[F],Oe=k[F+1];k[F]=k[Me-2-F],k[F+1]=k[Me-1-F],k[Me-2-F]=Ae,k[Me-1-F]=Oe}}(Fe,Oe)}function v(k,F,Me,Ae=!1){for(let Oe=0;Oe<k.length;Oe++)S(k[Oe],F,Me,Ae,0===Oe)}function I(k,Me,Ae,Oe){const{id:Fe,type:je,geometry:qe,tags:pt}=k,vt=[];if(1===je)!function(k,Me,Ae,Oe,Fe){for(let je=0;je<k.length;je+=2){const qe=Math.round(F.ag*(k[je+0]*Me-Ae)),pt=Math.round(F.ag*(k[je+1]*Me-Oe));Fe.push([qe,pt])}}(qe,Me,Ae,Oe,vt);else for(const k of qe)M(k,Me,Ae,Oe,vt);return{id:Fe,type:je,geometry:vt,tags:pt}}function M(k,Me,Ae,Oe,je){const qe=-Fe,pt=F.ag+Fe;let vt;for(let Fe=0;Fe<k.length-2;Fe+=2){let Ut=Math.round(F.ag*(k[Fe+0]*Me-Ae)),xi=Math.round(F.ag*(k[Fe+1]*Me-Oe)),vi=Math.round(F.ag*(k[Fe+2]*Me-Ae)),bi=Math.round(F.ag*(k[Fe+3]*Me-Oe));const wi=vi-Ut,Mi=bi-xi;Ut<qe&&vi<qe||(Ut<qe?(xi+=Math.round(Mi*((qe-Ut)/wi)),Ut=qe):vi<qe&&(bi=xi+Math.round(Mi*((qe-Ut)/wi)),vi=qe),xi<qe&&bi<qe||(xi<qe?(Ut+=Math.round(wi*((qe-xi)/Mi)),xi=qe):bi<qe&&(vi=Ut+Math.round(wi*((qe-xi)/Mi)),bi=qe),Ut>=pt&&vi>=pt||(Ut>=pt?(xi+=Math.round(Mi*((pt-Ut)/wi)),Ut=pt):vi>=pt&&(bi=xi+Math.round(Mi*((pt-Ut)/wi)),vi=pt),xi>=pt&&bi>=pt||(xi>=pt?(Ut+=Math.round(wi*((pt-xi)/Mi)),xi=pt):bi>=pt&&(vi=Ut+Math.round(wi*((pt-xi)/Mi)),bi=pt),vt&&Ut===vt[vt.length-1][0]&&xi===vt[vt.length-1][1]||(vt=[[Ut,xi]],je.push(vt)),vt.push([vi,bi])))))}}var je,qe,pt,vt={exports:{}},Ut=function(){if(pt)return vt.exports;pt=1;var Me=F.e7(),Ae=function(){if(qe)return je;qe=1;var Me=F.e5(),Ae=F.e6().VectorTileFeature;function i(F,Me){(this||k).options=Me||{},(this||k).features=F,(this||k).length=F.length}function o(F,Me){(this||k).id="number"==typeof F.id?F.id:void 0,(this||k).type=F.type,(this||k).rawGeometry=1===F.type?[F.geometry]:F.geometry,(this||k).properties=F.tags,(this||k).extent=Me||4096}return je=i,i.prototype.feature=function(F){return new o((this||k).features[F],(this||k).options.extent)},o.prototype.loadGeometry=function(){var F=(this||k).rawGeometry;(this||k).geometry=[];for(var Ae=0;Ae<F.length;Ae++){for(var Oe=F[Ae],Fe=[],je=0;je<Oe.length;je++)Fe.push(new Me(Oe[je][0],Oe[je][1]));(this||k).geometry.push(Fe)}return(this||k).geometry},o.prototype.bbox=function(){(this||k).geometry||this.loadGeometry();for(var F=(this||k).geometry,Me=1/0,Ae=-1/0,Oe=1/0,Fe=-1/0,je=0;je<F.length;je++)for(var qe=F[je],pt=0;pt<qe.length;pt++){var vt=qe[pt];Me=Math.min(Me,vt.x),Ae=Math.max(Ae,vt.x),Oe=Math.min(Oe,vt.y),Fe=Math.max(Fe,vt.y)}return[Me,Oe,Ae,Fe]},o.prototype.toGeoJSON=Ae.prototype.toGeoJSON,je}();function i(k){var F=new Me;return function(k,F){for(var Me in k.layers)F.writeMessage(3,o,k.layers[Me])}(k,F),F.finish()}function o(k,F){var Me;F.writeVarintField(15,k.version||1),F.writeStringField(1,k.name||""),F.writeVarintField(5,k.extent||4096);var Ae={keys:[],values:[],keycache:{},valuecache:{}};for(Me=0;Me<k.length;Me++)Ae.feature=k.feature(Me),F.writeMessage(2,n,Ae);var Oe=Ae.keys;for(Me=0;Me<Oe.length;Me++)F.writeStringField(3,Oe[Me]);var Fe=Ae.values;for(Me=0;Me<Fe.length;Me++)F.writeMessage(4,h,Fe[Me])}function n(k,F){var Me=k.feature;void 0!==Me.id&&F.writeVarintField(1,Me.id),F.writeMessage(2,r,k),F.writeVarintField(3,Me.type),F.writeMessage(4,c,Me)}function r(k,F){var Me=k.feature,Ae=k.keys,Oe=k.values,Fe=k.keycache,je=k.valuecache;for(var qe in Me.properties){var pt=Me.properties[qe],vt=Fe[qe];if(null!==pt){void 0===vt&&(Ae.push(qe),Fe[qe]=vt=Ae.length-1),F.writeVarint(vt);var Ut=typeof pt;"string"!==Ut&&"boolean"!==Ut&&"number"!==Ut&&(pt=JSON.stringify(pt));var xi=Ut+":"+pt,vi=je[xi];void 0===vi&&(Oe.push(pt),je[xi]=vi=Oe.length-1),F.writeVarint(vi)}}}function a(k,F){return(F<<3)+(7&k)}function l(k){return k<<1^k>>31}function c(k,F){for(var Me=k.loadGeometry(),Ae=k.type,Oe=0,Fe=0,je=Me.length,qe=0;qe<je;qe++){var pt=Me[qe],vt=1;1===Ae&&(vt=pt.length),F.writeVarint(a(1,vt));for(var Ut=3===Ae?pt.length-1:pt.length,xi=0;xi<Ut;xi++){1===xi&&1!==Ae&&F.writeVarint(a(2,Ut-1));var vi=pt[xi].x-Oe,bi=pt[xi].y-Fe;F.writeVarint(l(vi)),F.writeVarint(l(bi)),Oe+=vi,Fe+=bi}3===Ae&&F.writeVarint(a(7,1))}}function h(k,F){var Me=typeof k;"string"===Me?F.writeStringField(1,k):"boolean"===Me?F.writeBooleanField(7,k):"number"===Me&&(k%1!=0?F.writeDoubleField(3,k):k<0?F.writeSVarintField(6,k):F.writeVarintField(5,k))}return vt.exports=i,vt.exports.fromVectorTileJs=i,vt.exports.fromGeojsonVt=function(k,F){F=F||{};var Me={};for(var Oe in k)Me[Oe]=new Ae(k[Oe].features,F),Me[Oe].name=Oe,Me[Oe].version=F.version,Me[Oe].extent=F.extent;return i({layers:Me})},vt.exports.GeoJSONWrapper=Ae,vt.exports}(),xi=F.e8(Ut);const vi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:k=>k},bi=Math.fround||(wi=new Float32Array(1),k=>(wi[0]=+k,wi[0]));var wi;const Mi=3,pr=5,Ur=6;class Z{constructor(k){this.options=Object.assign(Object.create(vi),k),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(k){const{log:F,minZoom:Me,maxZoom:Ae}=this.options;F&&console.time("total time");const Oe=`prepare ${k.length} points`;F&&console.time(Oe),this.points=k;const Fe=[];for(let F=0;F<k.length;F++){const Me=k[F];if(!Me.geometry)continue;const[Ae,Oe]=Me.geometry.coordinates,je=bi(X(Ae)),qe=bi(Y(Oe));Fe.push(je,qe,1/0,F,-1,1),this.options.reduce&&Fe.push(0)}let je=this.trees[Ae+1]=this._createTree(Fe);F&&console.timeEnd(Oe);for(let k=Ae;k>=Me;k--){const Me=+Date.now();je=this.trees[k]=this._createTree(this._cluster(je,k)),F&&console.log("z%d: %d clusters in %dms",k,je.numItems,+Date.now()-Me)}return F&&console.timeEnd("total time"),this}getClusters(k,F){let Me=((k[0]+180)%360+360)%360-180;const Ae=Math.max(-90,Math.min(90,k[1]));let Oe=180===k[2]?180:((k[2]+180)%360+360)%360-180;const Fe=Math.max(-90,Math.min(90,k[3]));if(k[2]-k[0]>=360)Me=-180,Oe=180;else if(Me>Oe){const k=this.getClusters([Me,Ae,180,Fe],F),je=this.getClusters([-180,Ae,Oe,Fe],F);return k.concat(je)}const je=this.trees[this._limitZoom(F)],qe=je.range(X(Me),Y(Fe),X(Oe),Y(Ae)),pt=je.data,vt=[];for(const k of qe){const F=this.stride*k;vt.push(pt[F+pr]>1?E(pt,F,this.clusterProps):this.points[pt[F+Mi]])}return vt}getChildren(k){const F=this._getOriginId(k),Me=this._getOriginZoom(k),Ae="No cluster with the specified id.",Oe=this.trees[Me];if(!Oe)throw new Error(Ae);const Fe=Oe.data;if(F*this.stride>=Fe.length)throw new Error(Ae);const je=this.options.radius/(this.options.extent*Math.pow(2,Me-1)),qe=Oe.within(Fe[F*this.stride],Fe[F*this.stride+1],je),pt=[];for(const F of qe){const Me=F*this.stride;Fe[Me+4]===k&&pt.push(Fe[Me+pr]>1?E(Fe,Me,this.clusterProps):this.points[Fe[Me+Mi]])}if(0===pt.length)throw new Error(Ae);return pt}getLeaves(k,F,Me){const Ae=[];return this._appendLeaves(Ae,k,F=F||10,Me=Me||0,0),Ae}getTile(k,F,Me){const Ae=this.trees[this._limitZoom(k)],Oe=Math.pow(2,k),{extent:Fe,radius:je}=this.options,qe=je/Fe,pt=(Me-qe)/Oe,vt=(Me+1+qe)/Oe,Ut={features:[]};return this._addTileFeatures(Ae.range((F-qe)/Oe,pt,(F+1+qe)/Oe,vt),Ae.data,F,Me,Oe,Ut),0===F&&this._addTileFeatures(Ae.range(1-qe/Oe,pt,1,vt),Ae.data,Oe,Me,Oe,Ut),F===Oe-1&&this._addTileFeatures(Ae.range(0,pt,qe/Oe,vt),Ae.data,-1,Me,Oe,Ut),Ut.features.length?Ut:null}getClusterExpansionZoom(k){let F=this._getOriginZoom(k)-1;for(;F<=this.options.maxZoom;){const Me=this.getChildren(k);if(F++,1!==Me.length)break;k=Me[0].properties.cluster_id}return F}_appendLeaves(k,F,Me,Ae,Oe){const Fe=this.getChildren(F);for(const F of Fe){const Fe=F.properties;if(Fe&&Fe.cluster?Oe+Fe.point_count<=Ae?Oe+=Fe.point_count:Oe=this._appendLeaves(k,Fe.cluster_id,Me,Ae,Oe):Oe<Ae?Oe++:k.push(F),k.length===Me)break}return Oe}_createTree(k){const Me=new F.bE(k.length/this.stride|0,this.options.nodeSize,Float32Array);for(let F=0;F<k.length;F+=this.stride)Me.add(k[F],k[F+1]);return Me.finish(),Me.data=k,Me}_addTileFeatures(k,F,Me,Ae,Oe,Fe){for(const je of k){const k=je*this.stride,qe=F[k+pr]>1;let pt,vt,Ut;if(qe)pt=W(F,k,this.clusterProps),vt=F[k],Ut=F[k+1];else{const Me=this.points[F[k+Mi]];pt=Me.properties;const[Ae,Oe]=Me.geometry.coordinates;vt=X(Ae),Ut=Y(Oe)}const xi={type:1,geometry:[[Math.round(this.options.extent*(vt*Oe-Me)),Math.round(this.options.extent*(Ut*Oe-Ae))]],tags:pt};let vi;vi=qe||this.options.generateId?F[k+Mi]:this.points[F[k+Mi]].id,void 0!==vi&&(xi.id=vi),Fe.features.push(xi)}}_limitZoom(k){return Math.max(this.options.minZoom,Math.min(Math.floor(+k),this.options.maxZoom+1))}_cluster(k,F){const{radius:Me,extent:Ae,reduce:Oe,minPoints:Fe}=this.options,je=Me/(Ae*Math.pow(2,F)),qe=k.data,pt=[],vt=this.stride;for(let Me=0;Me<qe.length;Me+=vt){if(qe[Me+2]<=F)continue;qe[Me+2]=F;const Ae=qe[Me],Ut=qe[Me+1],xi=k.within(qe[Me],qe[Me+1],je),vi=qe[Me+pr];let bi=vi;for(const k of xi){const Me=k*vt;qe[Me+2]>F&&(bi+=qe[Me+pr])}if(bi>vi&&bi>=Fe){let k,Fe=Ae*vi,je=Ut*vi,wi=-1;const Mi=(Me/vt<<5)+(F+1)+this.points.length;for(const Ae of xi){const pt=Ae*vt;if(qe[pt+2]<=F)continue;qe[pt+2]=F;const Ut=qe[pt+pr];Fe+=qe[pt]*Ut,je+=qe[pt+1]*Ut,qe[pt+4]=Mi,Oe&&(k||(k=this._map(qe,Me,!0),wi=this.clusterProps.length,this.clusterProps.push(k)),Oe(k,this._map(qe,pt)))}qe[Me+4]=Mi,pt.push(Fe/bi,je/bi,1/0,Mi,-1,bi),Oe&&pt.push(wi)}else{for(let k=0;k<vt;k++)pt.push(qe[Me+k]);if(bi>1)for(const k of xi){const Me=k*vt;if(!(qe[Me+2]<=F)){qe[Me+2]=F;for(let k=0;k<vt;k++)pt.push(qe[Me+k])}}}}return pt}_getOriginId(k){return k-this.points.length>>5}_getOriginZoom(k){return(k-this.points.length)%32}_map(k,F,Me){if(k[F+pr]>1){const Ae=this.clusterProps[k[F+Ur]];return Me?Object.assign({},Ae):Ae}const Ae=this.points[k[F+Mi]].properties,Oe=this.options.map(Ae);return Me&&Oe===Ae?Object.assign({},Oe):Oe}}function E(k,F,Me){return{type:"Feature",id:k[F+Mi],properties:W(k,F,Me),geometry:{type:"Point",coordinates:[(Ae=k[F],360*(Ae-.5)),G(k[F+1])]}};var Ae}function W(k,F,Me){const Ae=k[F+pr],Oe=Ae>=1e4?`${Math.round(Ae/1e3)}k`:Ae>=1e3?Math.round(Ae/100)/10+"k":Ae,Fe=k[F+Ur],je=-1===Fe?{}:Object.assign({},Me[Fe]);return Object.assign(je,{cluster:!0,cluster_id:k[F+Mi],point_count:Ae,point_count_abbreviated:Oe})}function X(k){return k/360+.5}function Y(k){const F=Math.sin(k*Math.PI/180),Me=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return Me<0?0:Me>1?1:Me}function G(k){const F=(180-360*k)*Math.PI/180;return 360*Math.atan(Math.exp(F))/Math.PI-90}function N(k,F,Me,Ae){let Oe=Ae;const Fe=F+(Me-F>>1);let je,qe=Me-F;const pt=k[F],vt=k[F+1],Ut=k[Me],xi=k[Me+1];for(let Ae=F+3;Ae<Me;Ae+=3){const F=B(k[Ae],k[Ae+1],pt,vt,Ut,xi);if(F>Oe)je=Ae,Oe=F;else if(F===Oe){const k=Math.abs(Ae-Fe);k<qe&&(je=Ae,qe=k)}}Oe>Ae&&(je-F>3&&N(k,F,je,Ae),k[je+2]=Oe,Me-je>3&&N(k,je,Me,Ae))}function B(k,F,Me,Ae,Oe,Fe){let je=Oe-Me,qe=Fe-Ae;if(0!==je||0!==qe){const pt=((k-Me)*je+(F-Ae)*qe)/(je*je+qe*qe);pt>1?(Me=Oe,Ae=Fe):pt>0&&(Me+=je*pt,Ae+=qe*pt)}return je=k-Me,qe=F-Ae,je*je+qe*qe}function R(k,F,Me,Ae){const Oe={id:k??null,type:F,geometry:Me,tags:Ae,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===F||"MultiPoint"===F||"LineString"===F)J(Oe,Me);else if("Polygon"===F)J(Oe,Me[0]);else if("MultiLineString"===F)for(const k of Me)J(Oe,k);else if("MultiPolygon"===F)for(const k of Me)J(Oe,k[0]);return Oe}function J(k,F){for(let Me=0;Me<F.length;Me+=3)k.minX=Math.min(k.minX,F[Me]),k.minY=Math.min(k.minY,F[Me+1]),k.maxX=Math.max(k.maxX,F[Me]),k.maxY=Math.max(k.maxY,F[Me+1])}function V(k,F,Me,Ae){if(!F.geometry)return;const Oe=F.geometry.coordinates;if(Oe&&0===Oe.length)return;const Fe=F.geometry.type,je=Math.pow(Me.tolerance/((1<<Me.maxZoom)*Me.extent),2);let qe=[],pt=F.id;if(Me.promoteId?pt=F.properties[Me.promoteId]:Me.generateId&&(pt=Ae||0),"Point"===Fe)$(Oe,qe);else if("MultiPoint"===Fe)for(const k of Oe)$(k,qe);else if("LineString"===Fe)U(Oe,qe,je,!1);else if("MultiLineString"===Fe){if(Me.lineMetrics){for(const Me of Oe)qe=[],U(Me,qe,je,!1),k.push(R(pt,"LineString",qe,F.properties));return}q(Oe,qe,je,!1)}else if("Polygon"===Fe)q(Oe,qe,je,!0);else{if("MultiPolygon"!==Fe){if("GeometryCollection"===Fe){for(const Oe of F.geometry.geometries)V(k,{id:pt,geometry:Oe,properties:F.properties},Me,Ae);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const k of Oe){const F=[];q(k,F,je,!0),qe.push(F)}}k.push(R(pt,Fe,qe,F.properties))}function $(k,F){F.push(Q(k[0]),H(k[1]),0)}function U(k,F,Me,Ae){let Oe,Fe,je=0;for(let Me=0;Me<k.length;Me++){const qe=Q(k[Me][0]),pt=H(k[Me][1]);F.push(qe,pt,0),Me>0&&(je+=Ae?(Oe*pt-qe*Fe)/2:Math.sqrt(Math.pow(qe-Oe,2)+Math.pow(pt-Fe,2))),Oe=qe,Fe=pt}const qe=F.length-3;F[2]=1,N(F,0,qe,Me),F[qe+2]=1,F.size=Math.abs(je),F.start=0,F.end=F.size}function q(k,F,Me,Ae){for(let Oe=0;Oe<k.length;Oe++){const Fe=[];U(k[Oe],Fe,Me,Ae),F.push(Fe)}}function Q(k){return k/360+.5}function H(k){const F=Math.sin(k*Math.PI/180),Me=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return Me<0?0:Me>1?1:Me}function K(k,F,Me,Ae,Oe,Fe,je,qe){if(Ae/=F,Fe>=(Me/=F)&&je<Ae)return k;if(je<Me||Fe>=Ae)return null;const pt=[];for(const F of k){const k=F.geometry;let Fe=F.type;const je=0===Oe?F.minX:F.minY,vt=0===Oe?F.maxX:F.maxY;if(je>=Me&&vt<Ae){pt.push(F);continue}if(vt<Me||je>=Ae)continue;let Ut=[];if("Point"===Fe||"MultiPoint"===Fe)ee(k,Ut,Me,Ae,Oe);else if("LineString"===Fe)te(k,Ut,Me,Ae,Oe,!1,qe.lineMetrics);else if("MultiLineString"===Fe)ie(k,Ut,Me,Ae,Oe,!1);else if("Polygon"===Fe)ie(k,Ut,Me,Ae,Oe,!0);else if("MultiPolygon"===Fe)for(const F of k){const k=[];ie(F,k,Me,Ae,Oe,!0),k.length&&Ut.push(k)}if(Ut.length){if(qe.lineMetrics&&"LineString"===Fe){for(const k of Ut)pt.push(R(F.id,Fe,k,F.tags));continue}"LineString"!==Fe&&"MultiLineString"!==Fe||(1===Ut.length?(Fe="LineString",Ut=Ut[0]):Fe="MultiLineString"),"Point"!==Fe&&"MultiPoint"!==Fe||(Fe=3===Ut.length?"Point":"MultiPoint"),pt.push(R(F.id,Fe,Ut,F.tags))}}return pt.length?pt:null}function ee(k,F,Me,Ae,Oe){for(let Fe=0;Fe<k.length;Fe+=3){const je=k[Fe+Oe];je>=Me&&je<=Ae&&oe(F,k[Fe],k[Fe+1],k[Fe+2])}}function te(k,F,Me,Ae,Oe,Fe,je){let qe=se(k);const pt=0===Oe?ne:re;let vt,Ut,xi=k.start;for(let vi=0;vi<k.length-3;vi+=3){const bi=k[vi],wi=k[vi+1],Mi=k[vi+2],pr=k[vi+3],Ur=k[vi+4],Wr=0===Oe?bi:wi,Jr=0===Oe?pr:Ur;let Qr=!1;je&&(vt=Math.sqrt(Math.pow(bi-pr,2)+Math.pow(wi-Ur,2))),Wr<Me?Jr>Me&&(Ut=pt(qe,bi,wi,pr,Ur,Me),je&&(qe.start=xi+vt*Ut)):Wr>Ae?Jr<Ae&&(Ut=pt(qe,bi,wi,pr,Ur,Ae),je&&(qe.start=xi+vt*Ut)):oe(qe,bi,wi,Mi),Jr<Me&&Wr>=Me&&(Ut=pt(qe,bi,wi,pr,Ur,Me),Qr=!0),Jr>Ae&&Wr<=Ae&&(Ut=pt(qe,bi,wi,pr,Ur,Ae),Qr=!0),!Fe&&Qr&&(je&&(qe.end=xi+vt*Ut),F.push(qe),qe=se(k)),je&&(xi+=vt)}let vi=k.length-3;const bi=k[vi],wi=k[vi+1],Mi=0===Oe?bi:wi;Mi>=Me&&Mi<=Ae&&oe(qe,bi,wi,k[vi+2]),vi=qe.length-3,Fe&&vi>=3&&(qe[vi]!==qe[0]||qe[vi+1]!==qe[1])&&oe(qe,qe[0],qe[1],qe[2]),qe.length&&F.push(qe)}function se(k){const F=[];return F.size=k.size,F.start=k.start,F.end=k.end,F}function ie(k,F,Me,Ae,Oe,Fe){for(const je of k)te(je,F,Me,Ae,Oe,Fe,!1)}function oe(k,F,Me,Ae){k.push(F,Me,Ae)}function ne(k,F,Me,Ae,Oe,Fe){const je=(Fe-F)/(Ae-F);return oe(k,Fe,Me+(Oe-Me)*je,1),je}function re(k,F,Me,Ae,Oe,Fe){const je=(Fe-Me)/(Oe-Me);return oe(k,F+(Ae-F)*je,Fe,1),je}function ae(k,F){const Me=[];for(let Ae=0;Ae<k.length;Ae++){const Oe=k[Ae],Fe=Oe.type;let je;if("Point"===Fe||"MultiPoint"===Fe||"LineString"===Fe)je=le(Oe.geometry,F);else if("MultiLineString"===Fe||"Polygon"===Fe){je=[];for(const k of Oe.geometry)je.push(le(k,F))}else if("MultiPolygon"===Fe){je=[];for(const k of Oe.geometry){const Me=[];for(const Ae of k)Me.push(le(Ae,F));je.push(Me)}}Me.push(R(Oe.id,Fe,je,Oe.tags))}return Me}function le(k,F){const Me=[];Me.size=k.size,void 0!==k.start&&(Me.start=k.start,Me.end=k.end);for(let Ae=0;Ae<k.length;Ae+=3)Me.push(k[Ae]+F,k[Ae+1],k[Ae+2]);return Me}function ce(k,F){if(k.transformed)return k;const Me=1<<k.z,Ae=k.x,Oe=k.y;for(const Fe of k.features){const k=Fe.geometry,je=Fe.type;if(Fe.geometry=[],1===je)for(let je=0;je<k.length;je+=2)Fe.geometry.push(he(k[je],k[je+1],F,Me,Ae,Oe));else for(let je=0;je<k.length;je++){const qe=[];for(let Fe=0;Fe<k[je].length;Fe+=2)qe.push(he(k[je][Fe],k[je][Fe+1],F,Me,Ae,Oe));Fe.geometry.push(qe)}}return k.transformed=!0,k}function he(k,F,Me,Ae,Oe,Fe){return[Math.round(Me*(k*Ae-Oe)),Math.round(Me*(F*Ae-Fe))]}function ue(k,F,Me,Ae,Oe){const Fe=F===Oe.maxZoom?0:Oe.tolerance/((1<<F)*Oe.extent),je={features:[],numPoints:0,numSimplified:0,numFeatures:k.length,source:null,x:Me,y:Ae,z:F,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const F of k)de(je,F,Fe,Oe);return je}function de(k,F,Me,Ae){const Oe=F.geometry,Fe=F.type,je=[];if(k.minX=Math.min(k.minX,F.minX),k.minY=Math.min(k.minY,F.minY),k.maxX=Math.max(k.maxX,F.maxX),k.maxY=Math.max(k.maxY,F.maxY),"Point"===Fe||"MultiPoint"===Fe)for(let F=0;F<Oe.length;F+=3)je.push(Oe[F],Oe[F+1]),k.numPoints++,k.numSimplified++;else if("LineString"===Fe)fe(je,Oe,k,Me,!1,!1);else if("MultiLineString"===Fe||"Polygon"===Fe)for(let F=0;F<Oe.length;F++)fe(je,Oe[F],k,Me,"Polygon"===Fe,0===F);else if("MultiPolygon"===Fe)for(let F=0;F<Oe.length;F++){const Ae=Oe[F];for(let F=0;F<Ae.length;F++)fe(je,Ae[F],k,Me,!0,0===F)}if(je.length){let Me=F.tags||null;if("LineString"===Fe&&Ae.lineMetrics){Me={};for(const k in F.tags)Me[k]=F.tags[k];Me.mapbox_clip_start=Oe.start/Oe.size,Me.mapbox_clip_end=Oe.end/Oe.size}const qe={geometry:je,type:"Polygon"===Fe||"MultiPolygon"===Fe?3:"LineString"===Fe||"MultiLineString"===Fe?2:1,tags:Me};null!==F.id&&(qe.id=F.id),k.features.push(qe)}}function fe(k,F,Me,Ae,Oe,Fe){const je=Ae*Ae;if(Ae>0&&F.size<(Oe?je:Ae))return void(Me.numPoints+=F.length/3);const qe=[];for(let k=0;k<F.length;k+=3)(0===Ae||F[k+2]>je)&&(Me.numSimplified++,qe.push(F[k],F[k+1])),Me.numPoints++;Oe&&function(k,F){let Me=0;for(let F=0,Ae=k.length,Oe=Ae-2;F<Ae;Oe=F,F+=2)Me+=(k[F]-k[Oe])*(k[F+1]+k[Oe+1]);if(Me>0===F)for(let F=0,Me=k.length;F<Me/2;F+=2){const Ae=k[F],Oe=k[F+1];k[F]=k[Me-2-F],k[F+1]=k[Me-1-F],k[Me-2-F]=Ae,k[Me-1-F]=Oe}}(qe,Fe),k.push(qe)}const Wr={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class ge{constructor(k,F){const Me=(F=this.options=function(k,F){for(const Me in F)k[Me]=F[Me];return k}(Object.create(Wr),F)).debug;if(Me&&console.time("preprocess data"),F.maxZoom<0||F.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(F.promoteId&&F.generateId)throw new Error("promoteId and generateId cannot be used together.");let Ae=function(k,F){const Me=[];if("FeatureCollection"===k.type)for(let Ae=0;Ae<k.features.length;Ae++)V(Me,k.features[Ae],F,Ae);else V(Me,"Feature"===k.type?k:{geometry:k},F);return Me}(k,F);this.tiles={},this.tileCoords=[],Me&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",F.indexMaxZoom,F.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Ae=function(k,F){const Me=F.buffer/F.extent;let Ae=k;const Oe=K(k,1,-1-Me,Me,0,-1,2,F),Fe=K(k,1,1-Me,2+Me,0,-1,2,F);return(Oe||Fe)&&(Ae=K(k,1,-Me,1+Me,0,-1,2,F)||[],Oe&&(Ae=ae(Oe,1).concat(Ae)),Fe&&(Ae=Ae.concat(ae(Fe,-1)))),Ae}(Ae,F),Ae.length&&this.splitTile(Ae,0,0,0),Me&&(Ae.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(k,F,Me,Ae,Oe,Fe,je){const qe=[k,F,Me,Ae],pt=this.options,vt=pt.debug;for(;qe.length;){Ae=qe.pop(),Me=qe.pop(),F=qe.pop(),k=qe.pop();const Ut=1<<F,xi=me(F,Me,Ae);let vi=this.tiles[xi];if(!vi&&(vt>1&&console.time("creation"),vi=this.tiles[xi]=ue(k,F,Me,Ae,pt),this.tileCoords.push({z:F,x:Me,y:Ae}),vt)){vt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",F,Me,Ae,vi.numFeatures,vi.numPoints,vi.numSimplified),console.timeEnd("creation"));const k=`z${F}`;this.stats[k]=(this.stats[k]||0)+1,this.total++}if(vi.source=k,null==Oe){if(F===pt.indexMaxZoom||vi.numPoints<=pt.indexMaxPoints)continue}else{if(F===pt.maxZoom||F===Oe)continue;if(null!=Oe){const k=Oe-F;if(Me!==Fe>>k||Ae!==je>>k)continue}}if(vi.source=null,0===k.length)continue;vt>1&&console.time("clipping");const bi=.5*pt.buffer/pt.extent,wi=.5-bi,Mi=.5+bi,pr=1+bi;let Ur=null,Wr=null,Jr=null,Qr=null,co=K(k,Ut,Me-bi,Me+Mi,0,vi.minX,vi.maxX,pt),mo=K(k,Ut,Me+wi,Me+pr,0,vi.minX,vi.maxX,pt);k=null,co&&(Ur=K(co,Ut,Ae-bi,Ae+Mi,1,vi.minY,vi.maxY,pt),Wr=K(co,Ut,Ae+wi,Ae+pr,1,vi.minY,vi.maxY,pt),co=null),mo&&(Jr=K(mo,Ut,Ae-bi,Ae+Mi,1,vi.minY,vi.maxY,pt),Qr=K(mo,Ut,Ae+wi,Ae+pr,1,vi.minY,vi.maxY,pt),mo=null),vt>1&&console.timeEnd("clipping"),qe.push(Ur||[],F+1,2*Me,2*Ae),qe.push(Wr||[],F+1,2*Me,2*Ae+1),qe.push(Jr||[],F+1,2*Me+1,2*Ae),qe.push(Qr||[],F+1,2*Me+1,2*Ae+1)}}getTile(k,F,Me){k=+k,F=+F,Me=+Me;const Ae=this.options,{extent:Oe,debug:Fe}=Ae;if(k<0||k>24)return null;const je=1<<k,qe=me(k,F=F+je&je-1,Me);if(this.tiles[qe])return ce(this.tiles[qe],Oe);Fe>1&&console.log("drilling down to z%d-%d-%d",k,F,Me);let pt,vt=k,Ut=F,xi=Me;for(;!pt&&vt>0;)vt--,Ut>>=1,xi>>=1,pt=this.tiles[me(vt,Ut,xi)];return pt&&pt.source?(Fe>1&&(console.log("found parent tile z%d-%d-%d",vt,Ut,xi),console.time("drilling down")),this.splitTile(pt.source,vt,Ut,xi,k,F,Me),Fe>1&&console.timeEnd("drilling down"),this.tiles[qe]?ce(this.tiles[qe],Oe):null):null}}function me(k,F,Me){return 32*((1<<k)*Me+F)+k}function ye(F,Me){const Ae=F.tileID.canonical;if(!(this||k)._geoJSONIndex)return void Me(null,null);const Oe=(this||k)._geoJSONIndex.getTile(Ae.z,Ae.x,Ae.y);if(!Oe)return void Me(null,null);const Fe=new p(Oe.features);let je=xi(Fe);0===je.byteOffset&&je.byteLength===je.buffer.byteLength||(je=new Uint8Array(je)),Me(null,{vectorTile:Fe,rawData:je.buffer})}class xe extends c{constructor(k,F,Me,Ae,Oe,Fe){super(k,F,Me,Ae,ye,Fe),Oe&&(this.loadGeoJSON=Oe),this._dynamicIndex=new y}loadData(k,Me){const Ae=k&&k.request,Oe=Ae&&Ae.collectResourceTiming;this.loadGeoJSON(k,((Fe,je)=>{if(Fe||!je)return Me(Fe);if("object"!=typeof je)return Me(new Error(`Input data given to '${k.source}' is not a valid GeoJSON object.`));{try{if(k.filter){const Me=F.U(k.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Me.result)throw new Error(Me.value.map((k=>`${k.key}: ${k.message}`)).join(", "));je.features=je.features.filter((k=>Me.value.evaluate({zoom:0},k)))}k.dynamic?("Feature"===je.type&&(je={type:"FeatureCollection",features:[je]}),k.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(je.features,this.loaded),k.cluster&&(je.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=k.cluster?new Z(function({superclusterOptions:k,clusterProperties:Me}){if(!Me||!k)return k;const Ae={},Oe={},Fe={accumulated:null,zoom:0},je={properties:null},qe=Object.keys(Me);for(const k of qe){const[Fe,je]=Me[k],qe=F.U(je),pt=F.U("string"==typeof Fe?[Fe,["accumulated"],["get",k]]:Fe);Ae[k]=qe.value,Oe[k]=pt.value}return k.map=k=>{je.properties=k;const F={};for(const k of qe)F[k]=Ae[k].evaluate(Fe,je);return F},k.reduce=(k,F)=>{je.properties=F;for(const F of qe)Fe.accumulated=k[F],k[F]=Oe[F].evaluate(Fe,je)},k}(k)).load(je.features):k.dynamic?this._dynamicIndex:function(k,F){return new ge(k,F)}(je,k.geojsonVtOptions)}catch(k){return Me(k)}const Fe={};if(Oe){const F=t(Ae);F&&(Fe.resourceTiming={},Fe.resourceTiming[k.source]=JSON.parse(JSON.stringify(F)))}Me(null,Fe)}}))}reloadTile(k,F){const Me=this.loaded;return Me&&Me[k.uid]?k.partial?F(null,void 0):super.reloadTile(k,F):this.loadTile(k,F)}loadGeoJSON(k,Me){if(k.request)F.n(k.request,Me);else{if("string"!=typeof k.data)return Me(new Error(`Input data given to '${k.source}' is not a valid GeoJSON object.`));try{return Me(null,JSON.parse(k.data))}catch(F){return Me(new Error(`Input data given to '${k.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(k,F){try{F(null,this._geoJSONIndex.getClusterExpansionZoom(k.clusterId))}catch(k){F(k)}}getClusterChildren(k,F){try{F(null,this._geoJSONIndex.getChildren(k.clusterId))}catch(k){F(k)}}getClusterLeaves(k,F){try{F(null,this._geoJSONIndex.getLeaves(k.clusterId,k.limit,k.offset))}catch(k){F(k)}}}class we{constructor(k,Me){this.tileID=new F.aG(k.tileID.overscaledZ,k.tileID.wrap,k.tileID.canonical.z,k.tileID.canonical.x,k.tileID.canonical.y),this.tileZoom=k.tileZoom,this.uid=k.uid,this.zoom=k.zoom,this.canonical=k.tileID.canonical,this.pixelRatio=k.pixelRatio,this.tileSize=k.tileSize,this.source=k.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=k.projection,this.brightness=Me}parse(k,Me,Ae,Oe){this.status="parsing";const Fe=new F.aG(Ae.tileID.overscaledZ,Ae.tileID.wrap,Ae.tileID.canonical.z,Ae.tileID.canonical.x,Ae.tileID.canonical.y),je=[],qe=Me.familiesBySource[Ae.source],pt=new F.dZ(Fe,Ae.promoteId);return pt.bucketLayerIDs=[],pt.is3DTile=!0,F.e9(k).then((k=>{if(!k)return Oe(new Error("Could not parse tile"));const Me=F.ea(k,1/F.cc(Ae.tileID.canonical)),vt=k.json.extensionsUsed&&k.json.extensionsUsed.includes("MAPBOX_mesh_features")||k.json.asset.extras&&k.json.asset.extras.MAPBOX_mesh_features,Ut=k.json.extensionsUsed&&k.json.extensionsUsed.includes("EXT_meshopt_compression"),xi=new F.a8(this.zoom,{brightness:this.brightness});for(const k in qe)for(const Ae of qe[k]){const k=Ae[0];pt.bucketLayerIDs.push(Ae.map((k=>F.aC(k.id,k.scope)))),k.recalculate(xi,[]);const Oe=new F.eb(Ae,Me,Fe,vt,Ut,this.brightness,pt);vt||(Oe.needsUpload=!0),je.push(Oe),Oe.evaluate(k)}this.status="done",Oe(null,{buckets:je,featureIndex:pt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((k=>Oe(new Error(k.message))))}}class be{constructor(k,F,Me,Ae,Oe,Fe){this.actor=k,this.layerIndex=F,this.availableImages=Me,this.brightness=Fe,this.loading={},this.loaded={}}loadTile(k,Me){const Ae=k.uid,Oe=this.loading[Ae]=new we(k,this.brightness);F.bi(k.request,((F,Fe)=>{const je=!this.loading[Ae];return delete this.loading[Ae],je||F?(Oe.status="done",je||(this.loaded[Ae]=Oe),Me(F)):Fe&&0!==Fe.byteLength?void Oe.parse(Fe,this.layerIndex,k,((k,F)=>{Oe.status="done",this.loaded=this.loaded||{},this.loaded[Ae]=Oe,k||!F?Me(k):Me(null,F)})):(Oe.status="done",this.loaded[Ae]=Oe,Me())}))}reloadTile(k,F){const Me=this.loaded,Ae=k.uid;if(Me&&Me[Ae]){const Oe=Me[Ae];Oe.projection=k.projection,Oe.brightness=k.brightness;const n=(Me,Ae)=>{Oe.reloadCallback&&(delete Oe.reloadCallback,this.loadTile(k,F)),F(Me,Ae)};"parsing"===Oe.status?Oe.reloadCallback=n:"done"===Oe.status&&this.loadTile(k,F)}}abortTile(k,F){const Me=k.uid;this.loading[Me]&&delete this.loading[Me],F()}removeTile(k,F){const Me=this.loaded,Ae=k.uid;Me&&Me[Ae]&&delete Me[Ae],F()}}class Se{constructor(k){this.self=k,this.actor=new F.ec(k,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new F.I,this.projections={},this.defaultProjection=F.bP({name:"mercator"}),this.workerSourceTypes={vector:c,geojson:xe,"batched-model":be},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(k,F)=>{if(this.workerSourceTypes[k])throw new Error(`Worker source with name "${k}" already registered.`);this.workerSourceTypes[k]=F},this.self.registerRTLTextPlugin=k=>{if(F.ed.isParsed())throw new Error("RTL text plugin already registered.");F.ed.applyArabicShaping=k.applyArabicShaping,F.ed.processBidirectionalText=k.processBidirectionalText,F.ed.processStyledBidirectionalText=k.processStyledBidirectionalText}}clearCaches(k,F,Me){delete this.layerIndexes[k],delete this.availableImages[k],delete this.workerSources[k],delete this.demWorkerSources[k],delete this.rasterArrayWorkerSource,Me()}checkIfReady(k,F,Me){Me()}setReferrer(k,F){this.referrer=F}spriteLoaded(k,{scope:Me,isLoaded:Ae}){if(this.isSpriteLoaded[k]||(this.isSpriteLoaded[k]={}),this.isSpriteLoaded[k][Me]=Ae,this.workerSources[k]&&this.workerSources[k][Me])for(const Oe in this.workerSources[k][Me]){const Fe=this.workerSources[k][Me][Oe];for(const k in Fe){const Me=Fe[k];Me instanceof c&&(Me.isSpriteLoaded=Ae,Me.fire(new F.z("isSpriteLoaded")))}}}setImages(k,{scope:F,images:Me},Ae){if(this.availableImages[k]||(this.availableImages[k]={}),this.availableImages[k][F]=Me,this.workerSources[k]&&this.workerSources[k][F]){for(const Ae in this.workerSources[k][F]){const Oe=this.workerSources[k][F][Ae];for(const k in Oe)Oe[k].availableImages=Me}Ae()}else Ae()}setProjection(k,Me){this.projections[k]=F.bP(Me)}setBrightness(k,F,Me){this.brightness=F,Me()}setLayers(k,F,Me){this.getLayerIndex(k,F.scope).replace(F.layers,F.options),Me()}updateLayers(k,F,Me){this.getLayerIndex(k,F.scope).update(F.layers,F.removedIds,F.options),Me()}loadTile(k,F,Me){F.projection=this.projections[k]||this.defaultProjection,this.getWorkerSource(k,F.type,F.source,F.scope).loadTile(F,Me)}loadDEMTile(k,F,Me){this.getDEMWorkerSource(k,F.source,F.scope).loadTile(F,Me)}decodeRasterArray(k,F,Me){this.getRasterArrayWorkerSource().decodeRasterArray(F,Me)}reloadTile(k,F,Me){F.projection=this.projections[k]||this.defaultProjection,this.getWorkerSource(k,F.type,F.source,F.scope).reloadTile(F,Me)}abortTile(k,F,Me){this.getWorkerSource(k,F.type,F.source,F.scope).abortTile(F,Me)}removeTile(k,F,Me){this.getWorkerSource(k,F.type,F.source,F.scope).removeTile(F,Me)}removeSource(k,F,Me){if(!(this.workerSources[k]&&this.workerSources[k][F.scope]&&this.workerSources[k][F.scope][F.type]&&this.workerSources[k][F.scope][F.type][F.source]))return;const Ae=this.workerSources[k][F.scope][F.type][F.source];delete this.workerSources[k][F.scope][F.type][F.source],void 0!==Ae.removeSource?Ae.removeSource(F,Me):Me()}loadWorkerSource(k,F,Me){try{this.self.importScripts(F.url),Me()}catch(k){Me(k.toString())}}syncRTLPluginState(k,Me,Ae){try{F.ed.setState(Me);const k=F.ed.getPluginURL();if(F.ed.isLoaded()&&!F.ed.isParsed()&&null!=k){this.self.importScripts(k);const Me=F.ed.isParsed();Ae(Me?void 0:new Error(`RTL Text Plugin failed to import scripts from ${k}`),Me)}}catch(k){Ae(k.toString())}}setDracoUrl(k,F){this.dracoUrl=F}getAvailableImages(k,F){this.availableImages[k]||(this.availableImages[k]={});let Me=this.availableImages[k][F];return Me||(Me=[]),Me}getLayerIndex(k,F){this.layerIndexes[k]||(this.layerIndexes[k]={});let Me=this.layerIndexes[k][F];return Me||(Me=this.layerIndexes[k][F]=new o,Me.scope=F),Me}getWorkerSource(k,F,Me,Ae){return this.workerSources[k]||(this.workerSources[k]={}),this.workerSources[k][Ae]||(this.workerSources[k][Ae]={}),this.workerSources[k][Ae][F]||(this.workerSources[k][Ae][F]={}),this.isSpriteLoaded[k]||(this.isSpriteLoaded[k]={}),this.workerSources[k][Ae][F][Me]||(this.workerSources[k][Ae][F][Me]=new this.workerSourceTypes[F]({send:(F,Me,Ae,Oe,Fe,je)=>{this.actor.send(F,Me,Ae,k,Fe,je)},scheduler:this.actor.scheduler},this.getLayerIndex(k,Ae),this.getAvailableImages(k,Ae),this.isSpriteLoaded[k][Ae],void 0,this.brightness)),this.workerSources[k][Ae][F][Me]}rasterizeImages(k,F,Me){const{imageTasks:Ae,scope:Oe}=F,Fe={};for(const F in Ae){const{image:Me,imageIdWithOptions:je}=Ae[F];Fe[F]=this.imageRasterizer.rasterize(je,Me,Oe,k)}Me(void 0,Fe)}removeRasterizedImages(k,F,Me){const{imageIds:Ae,scope:Oe}=F;this.imageRasterizer.removeImagesFromCacheByIds(Ae,Oe,k),Me()}getDEMWorkerSource(k,F,Me){return this.demWorkerSources[k]||(this.demWorkerSources[k]={}),this.demWorkerSources[k][Me]||(this.demWorkerSources[k][Me]={}),this.demWorkerSources[k][Me][F]||(this.demWorkerSources[k][Me][F]=new h),this.demWorkerSources[k][Me][F]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new u),this.rasterArrayWorkerSource}enforceCacheSizeLimit(k,Me){F.ee(Me)}getWorkerPerformanceMetrics(k,F,Me){Me(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new Se(self)),Se}));define(["./shared"],(function(k){var F="3.9.4";const Me={create:"create",load:"load",fullLoad:"fullLoad"},Ae={mark(k){performance.mark(k)},measure(k,F,Me){performance.measure(k,F,Me)}};function s(F){const Me=F.name.split("?")[0];return k.a(Me)&&Me.includes("mapbox-gl.js")?"javascript":k.a(Me)&&Me.includes("mapbox-gl.css")?"css":k.b(Me)?"fontRange":k.c(Me)?"sprite":k.i(Me)?"style":k.d(Me)?"tilejson":"other"}var Oe,Fe={},je=function(){if(Oe)return Fe;function e(k){return!t(k)}function t(F){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var k,F,Me=new Blob([""],{type:"text/javascript"}),Ae=URL.createObjectURL(Me);try{F=new Worker(Ae),k=!0}catch(F){k=!1}return F&&F.terminate(),URL.revokeObjectURL(Ae),k}()?function(){var k=document.createElement("canvas");k.width=k.height=1;var F=k.getContext("2d");if(!F)return!1;var Me=F.getImageData(0,0,1,1);return Me&&Me.width===k.width}()?(void 0===k[Me=F&&F.failIfMajorPerformanceCaveat]&&(k[Me]=function(k){var F,Me=function(k){var F=document.createElement("canvas"),Me=Object.create(e.webGLContextAttributes);return Me.failIfMajorPerformanceCaveat=k,F.getContext("webgl2",Me)}(k);if(!Me)return!1;try{F=Me.createShader(Me.VERTEX_SHADER)}catch(k){return!1}return!(!F||Me.isContextLost())&&(Me.shaderSource(F,"void main() {}"),Me.compileShader(F),!0===Me.getShaderParameter(F,Me.COMPILE_STATUS))}(Me)),k[Me]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var Me}Oe=1,Fe.supported=e,Fe.notSupportedReason=t;var k={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Fe}();function l(k,F,Me){const Ae=document.createElement(k);return null!=F&&(Ae.className=F),Me&&Me.appendChild(Ae),Ae}function c(k,F,Me){const Ae=document.createElementNS("http://www.w3.org/2000/svg",k);for(const k of Object.keys(F))Ae.setAttributeNS(null,k,String(F[k]));return Me&&Me.appendChild(Ae),Ae}const qe="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,pt=qe&&void 0!==qe.userSelect?"userSelect":"WebkitUserSelect";let vt;function _(){qe&&pt&&(vt=qe[pt],qe[pt]="none")}function p(){qe&&pt&&(qe[pt]=vt)}function f(k){k.preventDefault(),k.stopPropagation(),window.removeEventListener("click",f,!0)}function m(){window.addEventListener("click",f,!0),window.setTimeout((()=>{window.removeEventListener("click",f,!0)}),0)}function g(k,F){const Me=k.getBoundingClientRect();return x(k,Me,F)}function v(k,F){const Me=k.getBoundingClientRect(),Ae=[];for(let Oe=0;Oe<F.length;Oe++)Ae.push(x(k,Me,F[Oe]));return Ae}function y(k){return void 0!==window.InstallTrigger&&2===k.button&&k.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:k.button}function x(F,Me,Ae){const Oe=F.offsetWidth===Me.width?1:F.offsetWidth/Me.width;return new k.P((Ae.clientX-Me.left)*Oe,(Ae.clientY-Me.top)*Oe)}const Ut="01",xi="NO_ACCESS_TOKEN";class T{constructor(k,F,Me){this._transformRequestFn=k,this._customAccessToken=F,this._silenceAuthErrors=!!Me,this._createSkuToken()}_createSkuToken(){const k=function(){let k="";for(let F=0;F<10;F++)k+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ut,k].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=k.token,this._skuTokenExpiresAt=k.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(k,F){return this._transformRequestFn&&this._transformRequestFn(k,F)||{url:k}}normalizeStyleURL(Me,Ae){if(!k.f(Me))return Me;const Oe=S(Me);return Oe.params.push(`sdk=js-${F}`),Oe.path=`/styles/v1${Oe.path}`,this._makeAPIURL(Oe,this._customAccessToken||Ae)}normalizeGlyphsURL(F,Me){if(!k.f(F))return F;const Ae=S(F);return Ae.path=`/fonts/v1${Ae.path}`,this._makeAPIURL(Ae,this._customAccessToken||Me)}normalizeModelURL(F,Me){if(!k.f(F))return F;const Ae=S(F);return Ae.path=`/models/v1${Ae.path}`,this._makeAPIURL(Ae,this._customAccessToken||Me)}normalizeSourceURL(F,Me,Ae,Oe){if(!k.f(F))return F;const Fe=S(F);return Fe.path=`/v4/${Fe.authority}.json`,Fe.params.push("secure"),Ae&&Fe.params.push(`language=${Ae}`),Oe&&Fe.params.push(`worldview=${Oe}`),this._makeAPIURL(Fe,this._customAccessToken||Me)}normalizeIconsetURL(F,Me){const Ae=S(F);return k.f(F)?(Ae.path=`/styles/v1${Ae.path}/iconset.pbf`,this._makeAPIURL(Ae,this._customAccessToken||Me)):C(Ae)}normalizeSpriteURL(F,Me,Ae,Oe){const Fe=S(F);return k.f(F)?(Fe.path=`/styles/v1${Fe.path}/sprite${Me}${Ae}`,this._makeAPIURL(Fe,this._customAccessToken||Oe)):(Fe.path+=`${Me}${Ae}`,C(Fe))}normalizeTileURL(F,Me,Ae){if(this._isSkuTokenExpired()&&this._createSkuToken(),F&&!k.f(F))return F;const Oe=S(F);Oe.path=Oe.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${Me||Ae&&"raster"!==Oe.authority&&512===Ae?"@2x":""}${k.m.supported?".webp":"$1"}`),"raster"===Oe.authority?Oe.path=`/${k.e.RASTER_URL_PREFIX}${Oe.path}`:"rasterarrays"===Oe.authority?Oe.path=`/${k.e.RASTERARRAYS_URL_PREFIX}${Oe.path}`:"3dtiles"===Oe.authority?Oe.path=`/${k.e.TILES3D_URL_PREFIX}${Oe.path}`:(Oe.path=Oe.path.replace(/^.+\/v4\//,"/"),Oe.path=`/${k.e.TILE_URL_VERSION}${Oe.path}`);const Fe=this._customAccessToken||function(k){for(const F of k){const k=F.match(/^access_token=(.*)$/);if(k)return k[1]}return null}(Oe.params)||k.e.ACCESS_TOKEN;return k.e.REQUIRE_ACCESS_TOKEN&&Fe&&this._skuToken&&Oe.params.push(`sku=${this._skuToken}`),this._makeAPIURL(Oe,Fe)}canonicalizeTileURL(F,Me){const Ae=S(F);if(!Ae.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!Ae.path.match(/\.[\w]+$/))return F;let Oe="mapbox://";Ae.path.match(/^\/raster\/v1\//)?Oe+=`raster/${Ae.path.replace(`/${k.e.RASTER_URL_PREFIX}/`,"")}`:Ae.path.match(/^\/rasterarrays\/v1\//)?Oe+=`rasterarrays/${Ae.path.replace(`/${k.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:Oe+=`tiles/${Ae.path.replace(`/${k.e.TILE_URL_VERSION}/`,"")}`;let Fe=Ae.params;return Me&&(Fe=Fe.filter((k=>!k.match(/^access_token=/)))),Fe.length&&(Oe+=`?${Fe.join("&")}`),Oe}canonicalizeTileset(F,Me){const Ae=!!Me&&k.f(Me),Oe=[];for(const Me of F.tiles||[])k.h(Me)?Oe.push(this.canonicalizeTileURL(Me,Ae)):Oe.push(Me);return Oe}_makeAPIURL(F,Me){const Ae="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",Oe=S(k.e.API_URL);if(F.protocol=Oe.protocol,F.authority=Oe.authority,"http"===F.protocol){const k=F.params.indexOf("secure");k>=0&&F.params.splice(k,1)}if("/"!==Oe.path&&(F.path=`${Oe.path}${F.path}`),!k.e.REQUIRE_ACCESS_TOKEN)return C(F);if(Me=Me||k.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!Me)throw new Error(`An API access token is required to use Mapbox GL. ${Ae}`);if("s"===Me[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${Ae}`)}return F.params=F.params.filter((k=>-1===k.indexOf("access_token"))),F.params.push(`access_token=${Me||""}`),C(F)}}const vi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function S(k){const F=k.match(vi);if(!F)throw new Error("Unable to parse URL object");return{protocol:F[1],authority:F[2],path:F[3]||"/",params:F[4]?F[4].split("&"):[]}}function C(k){const F=k.params.length?`?${k.params.join("&")}`:"";return`${k.protocol}://${k.authority}${k.path}${F}`}const bi="mapbox.eventData";function R(F){if(!F)return null;const Me=F.split(".");if(!Me||3!==Me.length)return null;try{return JSON.parse(k.j(Me[1]))}catch(k){return null}}class D{constructor(k){this.type=k,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(F){const Me=R(k.e.ACCESS_TOKEN);let Ae="";return Ae=Me&&Me.u?k.k(Me.u):k.e.ACCESS_TOKEN||"",F?`${bi}.${F}:${Ae}`:`${bi}:${Ae}`}fetchEventData(){const F=k.s("localStorage"),Me=this.getStorageKey(),Ae=this.getStorageKey("uuid");if(F)try{const k=localStorage.getItem(Me);k&&(this.eventData=JSON.parse(k));const F=localStorage.getItem(Ae);F&&(this.anonId=F)}catch(F){k.w("Unable to read from LocalStorage")}}saveEventData(){const F=k.s("localStorage"),Me=this.getStorageKey(),Ae=this.getStorageKey("uuid"),Oe=this.anonId;if(F&&Oe)try{localStorage.setItem(Ae,Oe),Object.keys(this.eventData).length>=1&&localStorage.setItem(Me,JSON.stringify(this.eventData))}catch(F){k.w("Unable to write to LocalStorage")}}processRequests(k){}postEvent(F,Me,Ae,Oe){if(!k.e.EVENTS_URL)return;const Fe=S(k.e.EVENTS_URL);Fe.params.push(`access_token=${Oe||k.e.ACCESS_TOKEN||""}`);const je={event:this.type,created:new Date(F).toISOString()},qe=Me?k.l(je,Me):je,pt={url:C(Fe),headers:{"Content-Type":"text/plain"},body:JSON.stringify([qe])};this.pendingRequest=k.p(pt,(k=>{this.pendingRequest=null,Ae(k),this.saveEventData(),this.processRequests(Oe)}))}queueRequest(k,F){this.queue.push(k),this.processRequests(F)}}const wi=new class extends D{constructor(k){super("appUserTurnstile"),this._customAccessToken=k}postTurnstileEvent(F,Me){k.e.EVENTS_URL&&k.e.ACCESS_TOKEN&&Array.isArray(F)&&F.some((F=>k.f(F)||k.h(F)))&&this.queueRequest(Date.now(),Me)}processRequests(Me){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const Ae=R(k.e.ACCESS_TOKEN),Oe=Ae?Ae.u:k.e.ACCESS_TOKEN;let Fe=Oe!==this.eventData.tokenU;k.v(this.anonId)||(this.anonId=k.u(),Fe=!0);const je=this.queue.shift();if(this.eventData.lastSuccess){const k=new Date(this.eventData.lastSuccess),F=new Date(je),Me=(je-this.eventData.lastSuccess)/864e5;Fe=Fe||Me>=1||Me<-1||k.getDate()!==F.getDate()}else Fe=!0;Fe?this.postEvent(je,{sdkIdentifier:"mapbox-gl-js",sdkVersion:F,skuId:Ut,"enabled.telemetry":!1,userId:this.anonId},(k=>{k||(this.eventData.lastSuccess=je,this.eventData.tokenU=Oe)}),Me):this.processRequests()}},Mi=wi.postTurnstileEvent.bind(wi),pr=new class extends D{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(F,Me,Ae,Oe){this.skuToken=Me,this.errorCb=Oe,k.e.EVENTS_URL&&(Ae||k.e.ACCESS_TOKEN?this.queueRequest({id:F,timestamp:Date.now()},Ae):this.errorCb(new Error(xi)))}processRequests(Me){if(this.pendingRequest||0===this.queue.length)return;const{id:Ae,timestamp:Oe}=this.queue.shift();Ae&&this.success[Ae]||(this.anonId||this.fetchEventData(),k.v(this.anonId)||(this.anonId=k.u()),this.postEvent(Oe,{sdkIdentifier:"mapbox-gl-js",sdkVersion:F,skuId:Ut,skuToken:this.skuToken,userId:this.anonId},(k=>{k?this.errorCb(k):Ae&&(this.success[Ae]=!0)}),Me))}remove(){this.errorCb=null}},Ur=pr.postMapLoadEvent.bind(pr),Wr=new class extends D{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(F){let Me=this.mapInstanceIdMap.get(F);return Me||(Me=k.u(),this.mapInstanceIdMap.set(F,Me)),Me}getEventId(k){const F=this.eventIdPerMapInstanceMap.get(k)||0;return this.eventIdPerMapInstanceMap.set(k,F+1),F}postStyleLoadEvent(F,Me){const{map:Ae,style:Oe,importedStyles:Fe}=Me;if(!k.e.EVENTS_URL||!F&&!k.e.ACCESS_TOKEN)return;const je=this.getMapInstanceId(Ae),qe={mapInstanceId:je,eventId:this.getEventId(je),style:Oe};Fe.length&&(qe.importedStyles=Fe),this.queueRequest({timestamp:Date.now(),payload:qe},F)}processRequests(k){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:F,payload:Me}=this.queue.shift();this.postEvent(F,Me,(()=>{}),k)}},Jr=Wr.postStyleLoadEvent.bind(Wr),Qr=new class extends D{constructor(){super("gljs.performance")}postPerformanceEvent(F,Me){k.e.EVENTS_URL&&(F||k.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:Me},F)}processRequests(Ae){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:Oe,performanceData:Fe}=this.queue.shift(),je=function(Ae){const Oe=performance.getEntriesByType("resource"),Fe=performance.getEntriesByType("mark"),je=function(k){const F={};if(k)for(const Me in k)if("other"!==Me)for(const Ae of k[Me]){const k=`${Me}ResolveRangeMin`,Oe=`${Me}ResolveRangeMax`,Fe=`${Me}RequestCount`,je=`${Me}RequestCachedCount`;F[k]=Math.min(F[k]||1/0,Ae.startTime),F[Oe]=Math.max(F[Oe]||-1/0,Ae.responseEnd);const n=k=>{void 0===F[k]&&(F[k]=0),++F[k]};void 0!==Ae.transferSize&&0===Ae.transferSize&&n(je),n(Fe)}return F}(function(k,F){const Me={};if(k)for(const Ae of k){const k=F(Ae);void 0===Me[k]&&(Me[k]=[]),Me[k].push(Ae)}return Me}(Oe,s)),qe=window.devicePixelRatio,pt=navigator.connection||navigator.mozConnection||navigator.webkitConnection,vt=pt?pt.effectiveType:void 0,Ut={counters:[],metadata:[],attributes:[]},d=(k,F,Me)=>{null!=Me&&k.push({name:F,value:Me.toString()})};for(const k in je)d(Ut.counters,k,je[k]);if(Ae.interactionRange[0]!==1/0&&Ae.interactionRange[1]!==-1/0&&(d(Ut.counters,"interactionRangeMin",Ae.interactionRange[0]),d(Ut.counters,"interactionRangeMax",Ae.interactionRange[1])),Fe)for(const k of Object.keys(Me)){const F=Me[k],Ae=Fe.find((k=>k.name===F));Ae&&d(Ut.counters,F,Ae.startTime)}return d(Ut.counters,"visibilityHidden",Ae.visibilityHidden),d(Ut.attributes,"style",function(F){if(F)for(const Me of F){const F=Me.name.split("?")[0];if(k.i(F)){const k=F.split("/").slice(-2);if(2===k.length)return`mapbox://styles/${k[0]}/${k[1]}`}}}(Oe)),d(Ut.attributes,"terrainEnabled",Ae.terrainEnabled?"true":"false"),d(Ut.attributes,"fogEnabled",Ae.fogEnabled?"true":"false"),d(Ut.attributes,"projection",Ae.projection),d(Ut.attributes,"zoom",Ae.zoom),d(Ut.metadata,"devicePixelRatio",qe),d(Ut.metadata,"connectionEffectiveType",vt),d(Ut.metadata,"navigatorUserAgent",navigator.userAgent),d(Ut.metadata,"screenWidth",window.screen.width),d(Ut.metadata,"screenHeight",window.screen.height),d(Ut.metadata,"windowWidth",window.innerWidth),d(Ut.metadata,"windowHeight",window.innerHeight),d(Ut.metadata,"mapWidth",Ae.width/qe),d(Ut.metadata,"mapHeight",Ae.height/qe),d(Ut.metadata,"webglRenderer",Ae.renderer),d(Ut.metadata,"webglVendor",Ae.vendor),d(Ut.metadata,"sdkVersion",F),d(Ut.metadata,"sdkIdentifier","mapbox-gl-js"),Ut}(Fe);for(const k of je.metadata);for(const k of je.counters);for(const k of je.attributes);this.postEvent(Oe,je,(()=>{}),Ae)}},co=Qr.postPerformanceEvent.bind(Qr),mo=new class extends D{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(F,Me,Ae,Oe){if(!k.e.API_URL||!k.e.SESSION_PATH)return;const Fe=S(k.e.API_URL+k.e.SESSION_PATH);Fe.params.push(`sku=${Me||""}`),Fe.params.push(`access_token=${Oe||k.e.ACCESS_TOKEN||""}`);const je={url:C(Fe),headers:{"Content-Type":"text/plain"}};this.pendingRequest=k.g(je,(k=>{this.pendingRequest=null,Ae(k),this.saveEventData(),this.processRequests(Oe)}))}getSessionAPI(F,Me,Ae,Oe){this.skuToken=Me,this.errorCb=Oe,k.e.SESSION_PATH&&k.e.API_URL&&(Ae||k.e.ACCESS_TOKEN?this.queueRequest({id:F,timestamp:Date.now()},Ae):this.errorCb(new Error(xi)))}processRequests(k){if(this.pendingRequest||0===this.queue.length)return;const{id:F,timestamp:Me}=this.queue.shift();F&&this.success[F]||this.getSession(Me,this.skuToken,(k=>{k?this.errorCb(k):F&&(this.success[F]=!0)}),k)}remove(){this.errorCb=null}},yo=mo.getSessionAPI.bind(mo),To=new Set;function G(k,F){F?To.add(k):To.delete(k)}class j{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(k,F){this._updatedSourceCaches[k]=F,this.setDirty()}discardSourceCacheUpdate(k){delete this._updatedSourceCaches[k]}updateLayer(k){const F=k.scope;this._updatedLayers[F]=this._updatedLayers[F]||new Set,this._updatedLayers[F].add(k.id),this.setDirty()}removeLayer(k){const F=k.scope;this._removedLayers[F]=this._removedLayers[F]||{},this._updatedLayers[F]=this._updatedLayers[F]||new Set,this._removedLayers[F][k.id]=k,this._updatedLayers[F].delete(k.id),this._updatedPaintProps.delete(k.fqid),this.setDirty()}getRemovedLayer(k){return this._removedLayers[k.scope]?this._removedLayers[k.scope][k.id]:null}discardLayerRemoval(k){this._removedLayers[k.scope]&&delete this._removedLayers[k.scope][k.id]}getLayerUpdatesByScope(){const k={};for(const F in this._updatedLayers)k[F]=k[F]||{},k[F].updatedIds=Array.from(this._updatedLayers[F].values());for(const F in this._removedLayers)k[F]=k[F]||{},k[F].removedIds=Object.keys(this._removedLayers[F]);return k}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(k){this._updatedPaintProps.add(k.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(k){this._updatedImages.add(k),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function V(k){const{userImage:F}=k;return!!(F&&F.render&&F.render())&&(k.data.replace(new Uint8Array(F.data.buffer)),!0)}class q extends k.E{constructor(F){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=F,"raster"!==F&&k.t()&&(this.imageRasterizerDispatcher=new k.D(k.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new k.I),this._imageRasterizer}createScope(F){this.images[F]={},this.loaded[F]=!1,this.updatedImages[F]={},this.patterns[F]={},this.callbackDispatchedThisFrame[F]={},this.atlasImage[F]=new k.r({width:1,height:1})}isLoaded(){for(const k in this.loaded)if(!this.loaded[k])return!1;return!0}setLoaded(k,F){if(this.loaded[F]!==k&&(this.loaded[F]=k,k)){for(const{ids:k,callback:Me}of this.requestors)this._notify(k,F,Me);this.requestors=[]}}hasImage(k,F){return!!this.getImage(k,F)}getImage(k,F){return this.images[F][k]}addImage(k,F,Me){this._validate(k,Me)&&(this.images[F][k]=Me)}_validate(F,Me){let Ae=!0;return this._validateStretch(Me.stretchX,Me.data&&Me.data.width)||(this.fire(new k.y(new Error(`Image "${F}" has invalid "stretchX" value`))),Ae=!1),this._validateStretch(Me.stretchY,Me.data&&Me.data.height)||(this.fire(new k.y(new Error(`Image "${F}" has invalid "stretchY" value`))),Ae=!1),this._validateContent(Me.content,Me)||(this.fire(new k.y(new Error(`Image "${F}" has invalid "content" value`))),Ae=!1),Ae}_validateStretch(k,F){if(!k)return!0;let Me=0;for(const Ae of k){if(Ae[0]<Me||Ae[1]<Ae[0]||F<Ae[1])return!1;Me=Ae[1]}return!0}_validateContent(k,F){if(!k)return!0;if(4!==k.length)return!1;if(!F.usvg){if(k[0]<0||F.data.width<k[0])return!1;if(k[1]<0||F.data.height<k[1])return!1;if(k[2]<0||F.data.width<k[2])return!1;if(k[3]<0||F.data.height<k[3])return!1}return!(k[2]<k[0]||k[3]<k[1])}updateImage(k,F,Me){Me.version=this.images[F][k].version+1,this.images[F][k]=Me,this.updatedImages[F][k]=!0,this.removeFromImageRasterizerCache(k,F)}removeFromImageRasterizerCache(F,Me){"raster"!==this.spriteFormat&&(k.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[F],scope:Me}):this.imageRasterizer.removeImagesFromCacheByIds([F],Me))}removeImage(k,F){const Me=this.images[F][k];delete this.images[F][k],delete this.patterns[F][k],this.removeFromImageRasterizerCache(k,F),Me.userImage&&Me.userImage.onRemove&&Me.userImage.onRemove()}listImages(k){return Object.keys(this.images[k])}getImages(k,F,Me){let Ae=!0;const Oe=!!this.loaded[F];if(!Oe)for(const Me of k)this.images[F][Me]||(Ae=!1);Oe||Ae?this._notify(k,F,Me):this.requestors.push({ids:k,scope:F,callback:Me})}rasterizeImages({scope:F,imageTasks:Me},Ae){const Oe={};for(const k in Me){const Ae=Me[k],Fe=this.getImage(Ae.id,F);Fe&&(Oe[k]={image:Fe,imageIdWithOptions:Ae})}k.t()?this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{imageTasks:Oe,scope:F},Ae):this.rasterizeImagesInMainThread({imageTasks:Oe,scope:F},Ae)}rasterizeImagesInMainThread(k,F){const{imageTasks:Me,scope:Ae}=k,Oe={};for(const k in Me){const{image:F,imageIdWithOptions:Fe}=Me[k];Oe[k]=this.imageRasterizer.rasterize(Fe,F,Ae,"")}F(void 0,Oe)}getUpdatedImages(k){return this.updatedImages[k]}_notify(F,Me,Ae){const Oe={};for(const Ae of F){this.images[Me][Ae]||this.fire(new k.z("styleimagemissing",{id:Ae}));const F=this.images[Me][Ae];F?Oe[Ae]={data:F.usvg?null:F.data.clone(),pixelRatio:F.pixelRatio,sdf:F.sdf,usvg:F.usvg,version:F.version,stretchX:F.stretchX,stretchY:F.stretchY,content:F.content,hasRenderCallback:Boolean(F.userImage&&F.userImage.render)}:k.w(`Image "${Ae}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}Ae(null,Oe)}getPixelSize(k){const{width:F,height:Me}=this.atlasImage[k];return{width:F,height:Me}}getPattern(F,Me,Ae){const Oe=this.patterns[Me][F],Fe=this.getImage(F,Me);if(!Fe)return null;if(Oe&&Oe.position.version===Fe.version)return Oe.position;if(Oe)Oe.position.version=Fe.version;else{Fe.usvg&&!Fe.data&&(Fe.data=this.imageRasterizer.rasterize(k.A.from(F).getPrimary(),Fe,Me,""));const Ae={w:Fe.data.width+2*k.B,h:Fe.data.height+2*k.B,x:0,y:0},Oe=new k.F(Ae,Fe,k.B);this.patterns[Me][F]={bin:Ae,position:Oe}}return this._updatePatternAtlas(Me,Ae),this.patterns[Me][F].position}bind(F,Me){const Ae=F.gl;let Oe=this.atlasTexture[Me];Oe?this.dirty&&(Oe.update(this.atlasImage[Me]),this.dirty=!1):(Oe=new k.T(F,this.atlasImage[Me],Ae.RGBA8),this.atlasTexture[Me]=Oe),Oe.bind(Ae.LINEAR,Ae.CLAMP_TO_EDGE)}_updatePatternAtlas(F,Me){const Ae=[];for(const k in this.patterns[F])Ae.push(this.patterns[F][k].bin);const{w:Oe,h:Fe}=k.C(Ae),je=this.atlasImage[F];je.resize({width:Oe||1,height:Fe||1});for(const Ae in this.patterns[F]){const{bin:Oe,position:Fe}=this.patterns[F][Ae];let qe=Fe.padding;const pt=Oe.x+qe,vt=Oe.y+qe,Ut=this.images[F][Ae].data,xi=Ut.width,vi=Ut.height;qe=qe>1?qe-1:qe,k.r.copy(Ut,je,{x:0,y:0},{x:pt,y:vt},{width:xi,height:vi},Me),k.r.copy(Ut,je,{x:0,y:vi-qe},{x:pt,y:vt-qe},{width:xi,height:qe},Me),k.r.copy(Ut,je,{x:0,y:0},{x:pt,y:vt+vi},{width:xi,height:qe},Me),k.r.copy(Ut,je,{x:xi-qe,y:0},{x:pt-qe,y:vt},{width:qe,height:vi},Me),k.r.copy(Ut,je,{x:0,y:0},{x:pt+xi,y:vt},{width:qe,height:vi},Me),k.r.copy(Ut,je,{x:xi-qe,y:vi-qe},{x:pt-qe,y:vt-qe},{width:qe,height:qe},Me),k.r.copy(Ut,je,{x:0,y:vi-qe},{x:pt+xi,y:vt-qe},{width:qe,height:qe},Me),k.r.copy(Ut,je,{x:0,y:0},{x:pt+xi,y:vt+vi},{width:qe,height:qe},Me),k.r.copy(Ut,je,{x:xi-qe,y:0},{x:pt-qe,y:vt+vi},{width:qe,height:qe},Me)}this.dirty=!0}beginFrame(){for(const k in this.images)this.callbackDispatchedThisFrame[k]={}}dispatchRenderCallbacks(k,F){for(const Me of k){if(this.callbackDispatchedThisFrame[F][Me])continue;this.callbackDispatchedThisFrame[F][Me]=!0;const k=this.images[F][Me];V(k)&&this.updateImage(Me,F,k)}}}function H(F){const Me=F.key,Ae=F.value,Oe=F.valueSpec||{},Fe=F.objectElementValidators||{},je=F.style,qe=F.styleSpec;let pt=[];const vt=k.H(Ae);if("object"!==vt)return[new k.V(Me,Ae,`object expected, ${vt} found`)];for(const F in Ae){const vt=F.split(".")[0];let Ut;Fe[vt]?Ut=Fe[vt]:Oe[vt]?Ut=_e:Fe["*"]?Ut=Fe["*"]:Oe["*"]&&(Ut=_e),Ut?pt=pt.concat(Ut({key:(Me?`${Me}.`:Me)+F,value:Ae[F],valueSpec:Oe[vt]||Oe["*"],style:je,styleSpec:qe,object:Ae,objectKey:F},Ae)):pt.push(new k.G(Me,Ae[F],`unknown property "${F}"`))}for(const F in Oe)Fe[F]||Oe[F].required&&void 0===Oe[F].default&&void 0===Ae[F]&&pt.push(new k.V(Me,Ae,`missing required property "${F}"`));return pt}function Z(F){const Me=F.value,Ae=F.valueSpec,Oe=F.style,Fe=F.styleSpec,je=F.key,qe=F.arrayElementValidator||_e;if("array"!==k.H(Me))return[new k.V(je,Me,`array expected, ${k.H(Me)} found`)];if(Ae.length&&Me.length!==Ae.length)return[new k.V(je,Me,`array length ${Ae.length} expected, length ${Me.length} found`)];if(Ae["min-length"]&&Me.length<Ae["min-length"])return[new k.V(je,Me,`array length at least ${Ae["min-length"]} expected, length ${Me.length} found`)];let pt={type:Ae.value,values:Ae.values,minimum:Ae.minimum,maximum:Ae.maximum,function:void 0};Fe.$version<7&&(pt.function=Ae.function),"object"===k.H(Ae.value)&&(pt=Ae.value);let vt=[];for(let k=0;k<Me.length;k++)vt=vt.concat(qe({array:Me,arrayIndex:k,value:Me[k],valueSpec:pt,style:Oe,styleSpec:Fe,key:`${je}[${k}]`},!0));return vt}function W(F){const Me=F.key,Ae=F.value,Oe=F.valueSpec;let Fe=k.H(Ae);if("number"===Fe&&Ae!=Ae&&(Fe="NaN"),"number"!==Fe)return[new k.V(Me,Ae,`number expected, ${Fe} found`)];if("minimum"in Oe){let Fe=Oe.minimum;if("array"===k.H(Oe.minimum)&&(Fe=Oe.minimum[F.arrayIndex]),Ae<Fe)return[new k.V(Me,Ae,`${Ae} is less than the minimum value ${Fe}`)]}if("maximum"in Oe){let Fe=Oe.maximum;if("array"===k.H(Oe.maximum)&&(Fe=Oe.maximum[F.arrayIndex]),Ae>Fe)return[new k.V(Me,Ae,`${Ae} is greater than the maximum value ${Fe}`)]}return[]}function $(F){const Me=F.valueSpec,Ae=k.K(F.value.type);let Oe,Fe,je,qe={};const pt="categorical"!==Ae&&void 0===F.value.property,vt=!pt,Ut="array"===k.H(F.value.stops)&&"array"===k.H(F.value.stops[0])&&"object"===k.H(F.value.stops[0][0]),xi=H({key:F.key,value:F.value,valueSpec:F.styleSpec.function,style:F.style,styleSpec:F.styleSpec,objectElementValidators:{stops:function(F){if("identity"===Ae)return[new k.V(F.key,F.value,'identity function may not have a "stops" property')];let Me=[];const Oe=F.value;return Me=Me.concat(Z({key:F.key,value:Oe,valueSpec:F.valueSpec,style:F.style,styleSpec:F.styleSpec,arrayElementValidator:d})),"array"===k.H(Oe)&&0===Oe.length&&Me.push(new k.V(F.key,Oe,"array must have at least one stop")),Me},default:function(k){return _e({key:k.key,value:k.value,valueSpec:Me,style:k.style,styleSpec:k.styleSpec})}}});return"identity"===Ae&&pt&&xi.push(new k.V(F.key,F.value,'missing required property "property"')),"identity"===Ae||F.value.stops||xi.push(new k.V(F.key,F.value,'missing required property "stops"')),"exponential"===Ae&&F.valueSpec.expression&&!k.L(F.valueSpec)&&xi.push(new k.V(F.key,F.value,"exponential functions not supported")),F.styleSpec.$version>=8&&(vt&&!k.M(F.valueSpec)?xi.push(new k.V(F.key,F.value,"property functions not supported")):pt&&!k.N(F.valueSpec)&&xi.push(new k.V(F.key,F.value,"zoom functions not supported"))),"categorical"!==Ae&&!Ut||void 0!==F.value.property||xi.push(new k.V(F.key,F.value,'"property" property is required')),xi;function d(F){let Ae=[];const Oe=F.value,pt=F.key;if("array"!==k.H(Oe))return[new k.V(pt,Oe,`array expected, ${k.H(Oe)} found`)];if(2!==Oe.length)return[new k.V(pt,Oe,`array length 2 expected, length ${Oe.length} found`)];if(Ut){if("object"!==k.H(Oe[0]))return[new k.V(pt,Oe,`object expected, ${k.H(Oe[0])} found`)];if(void 0===Oe[0].zoom)return[new k.V(pt,Oe,"object stop key must have zoom")];if(void 0===Oe[0].value)return[new k.V(pt,Oe,"object stop key must have value")];const Me=k.K(Oe[0].zoom);if("number"!=typeof Me)return[new k.V(pt,Oe[0].zoom,"stop zoom values must be numbers")];if(je&&je>Me)return[new k.V(pt,Oe[0].zoom,"stop zoom values must appear in ascending order")];Me!==je&&(je=Me,Fe=void 0,qe={}),Ae=Ae.concat(H({key:`${pt}[0]`,value:Oe[0],valueSpec:{zoom:{}},style:F.style,styleSpec:F.styleSpec,objectElementValidators:{zoom:W,value:_}}))}else Ae=Ae.concat(_({key:`${pt}[0]`,value:Oe[0],valueSpec:{},style:F.style,styleSpec:F.styleSpec},Oe));return k.O(k.Q(Oe[1]))?Ae.concat([new k.V(`${pt}[1]`,Oe[1],"expressions are not allowed in function stops.")]):Ae.concat(_e({key:`${pt}[1]`,value:Oe[1],valueSpec:Me,style:F.style,styleSpec:F.styleSpec}))}function _(F,je){const pt=k.H(F.value),vt=k.K(F.value),Ut=null!==F.value?F.value:je;if(Oe){if(pt!==Oe)return[new k.V(F.key,Ut,`${pt} stop domain type must match previous stop domain type ${Oe}`)]}else Oe=pt;if("number"!==pt&&"string"!==pt&&"boolean"!==pt&&"number"!=typeof vt&&"string"!=typeof vt&&"boolean"!=typeof vt)return[new k.V(F.key,Ut,"stop domain value must be a number, string, or boolean")];if("number"!==pt&&"categorical"!==Ae){let Oe=`number expected, ${pt} found`;return k.M(Me)&&void 0===Ae&&(Oe+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new k.V(F.key,Ut,Oe)]}return"categorical"!==Ae||"number"!==pt||"number"==typeof vt&&isFinite(vt)&&Math.floor(vt)===vt?"categorical"!==Ae&&"number"===pt&&"number"==typeof vt&&"number"==typeof Fe&&void 0!==Fe&&vt<Fe?[new k.V(F.key,Ut,"stop domain values must appear in ascending order")]:(Fe=vt,"categorical"===Ae&&vt in qe?[new k.V(F.key,Ut,"stop domain values must be unique")]:(qe[vt]=!0,[])):[new k.V(F.key,Ut,`integer expected, found ${String(vt)}`)]}}function X(F){const Me=("property"===F.expressionContext?k.S:k.U)(k.Q(F.value),F.valueSpec);if("error"===Me.result)return Me.value.map((Me=>new k.V(`${F.key}${Me.key}`,F.value,Me.message)));const Ae=Me.value.expression||Me.value._styleExpression.expression;if("property"===F.expressionContext&&"text-font"===F.propertyKey&&!Ae.outputDefined())return[new k.V(F.key,F.value,`Invalid data expression for "${F.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===F.expressionContext&&"layout"===F.propertyType&&!k.W(Ae))return[new k.V(F.key,F.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===F.expressionContext)return K(Ae,F);if(F.expressionContext&&0===F.expressionContext.indexOf("cluster")){if(!k.X(Ae,["zoom","feature-state"]))return[new k.V(F.key,F.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===F.expressionContext&&!k.Y(Ae))return[new k.V(F.key,F.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function K(F,Me){const Ae=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(Me.valueSpec&&Me.valueSpec.expression)for(const k of Me.valueSpec.expression.parameters)Ae.delete(k);if(0===Ae.size)return[];const Oe=[];return F instanceof k.Z&&Ae.has(F.name)?[new k.V(Me.key,Me.value,`["${F.name}"] expression is not supported in a filter for a ${Me.object.type} layer with id: ${Me.object.id}`)]:(F.eachChild((k=>{Oe.push(...K(k,Me))})),Oe)}function Y(F){const Me=F.key,Ae=F.value,Oe=F.valueSpec,Fe=[];return Array.isArray(Oe.values)?-1===Oe.values.indexOf(k.K(Ae))&&Fe.push(new k.V(Me,Ae,`expected one of [${Oe.values.join(", ")}], ${JSON.stringify(Ae)} found`)):-1===Object.keys(Oe.values).indexOf(k.K(Ae))&&Fe.push(new k.V(Me,Ae,`expected one of [${Object.keys(Oe.values).join(", ")}], ${JSON.stringify(Ae)} found`)),Fe}function J(F){return k.$(k.Q(F.value))?X(k.J({},F,{expressionContext:"filter",valueSpec:F.styleSpec[`filter_${F.layerType||"fill"}`]})):Q(F)}function Q(F){const Me=F.value,Ae=F.key;if("array"!==k.H(Me))return[new k.V(Ae,Me,`array expected, ${k.H(Me)} found`)];const Oe=F.styleSpec;let Fe,je=[];if(Me.length<1)return[new k.V(Ae,Me,"filter array must have at least 1 element")];switch(je=je.concat(Y({key:`${Ae}[0]`,value:Me[0],valueSpec:Oe.filter_operator,style:F.style,styleSpec:F.styleSpec})),k.K(Me[0])){case"<":case"<=":case">":case">=":Me.length>=2&&"$type"===k.K(Me[1])&&je.push(new k.V(Ae,Me,`"$type" cannot be use with operator "${Me[0]}"`));case"==":case"!=":3!==Me.length&&je.push(new k.V(Ae,Me,`filter array for operator "${Me[0]}" must have 3 elements`));case"in":case"!in":Me.length>=2&&(Fe=k.H(Me[1]),"string"!==Fe&&je.push(new k.V(`${Ae}[1]`,Me[1],`string expected, ${Fe} found`)));for(let qe=2;qe<Me.length;qe++)Fe=k.H(Me[qe]),"$type"===k.K(Me[1])?je=je.concat(Y({key:`${Ae}[${qe}]`,value:Me[qe],valueSpec:Oe.geometry_type,style:F.style,styleSpec:F.styleSpec})):"string"!==Fe&&"number"!==Fe&&"boolean"!==Fe&&je.push(new k.V(`${Ae}[${qe}]`,Me[qe],`string, number, or boolean expected, ${Fe} found`));break;case"any":case"all":case"none":for(let k=1;k<Me.length;k++)je=je.concat(Q({key:`${Ae}[${k}]`,value:Me[k],style:F.style,styleSpec:F.styleSpec}));break;case"has":case"!has":Fe=k.H(Me[1]),2!==Me.length?je.push(new k.V(Ae,Me,`filter array for "${Me[0]}" operator must have 2 elements`)):"string"!==Fe&&je.push(new k.V(`${Ae}[1]`,Me[1],`string expected, ${Fe} found`))}return je}function ee(F,Me){const Ae=F.key,Oe=F.style,Fe=F.layer,je=F.styleSpec,qe=F.value,pt=F.objectKey,vt=je[`${Me}_${F.layerType}`];if(!vt)return[];const Ut=pt.match(/^(.*)-use-theme$/);if("paint"===Me&&Ut&&vt[Ut[1]])return _e({key:Ae,value:qe,valueSpec:{type:"string"},style:Oe,styleSpec:je});const xi=pt.match(/^(.*)-transition$/);if("paint"===Me&&xi&&vt[xi[1]]&&vt[xi[1]].transition)return _e({key:Ae,value:qe,valueSpec:je.transition,style:Oe,styleSpec:je});const vi=F.valueSpec||vt[pt];if(!vi)return[new k.G(Ae,qe,`unknown property "${pt}"`)];let bi;if("string"===k.H(qe)&&k.M(vi)&&!vi.tokens&&(bi=/^{([^}]+)}$/.exec(qe))){const F=`\`{ "type": "identity", "property": ${bi?JSON.stringify(bi[1]):'"_"'} }\``;return[new k.V(Ae,qe,`"${pt}" does not support interpolation syntax\nUse an identity property function instead: ${F}.`)]}const wi=[];if("symbol"===F.layerType)"text-field"!==pt||!Oe||Oe.glyphs||Oe.imports||wi.push(new k.V(Ae,qe,'use of "text-field" requires a style "glyphs" property')),"text-font"===pt&&k.a0(k.Q(qe))&&"identity"===k.K(qe.type)&&wi.push(new k.V(Ae,qe,'"text-font" does not support identity functions'));else if("model"===F.layerType&&"paint"===Me&&Fe&&Fe.layout&&Fe.layout.hasOwnProperty("model-id")&&k.M(vi)&&(k.a1(vi)||k.N(vi))){const F=k.S(k.Q(qe),vi),Me=F.value.expression||F.value._styleExpression.expression;Me&&!k.X(Me,["measure-light"])&&("model-emissive-strength"===pt&&k.Y(Me)&&k.W(Me)||wi.push(new k.V(Ae,qe,`${pt} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return wi.concat(_e({key:F.key,value:qe,valueSpec:vi,style:Oe,styleSpec:je,expressionContext:"property",propertyType:Me,propertyKey:pt}))}function te(k){return ee(k,"paint")}function ie(k){return ee(k,"layout")}function oe(F){let Me=[];const Ae=F.value,Oe=F.key,Fe=F.style,je=F.styleSpec;Ae.type||Ae.ref||Me.push(new k.V(Oe,Ae,'either "type" or "ref" is required'));let qe=k.K(Ae.type);const pt=k.K(Ae.ref);if(Ae.id){const je=k.K(Ae.id);for(let qe=0;qe<F.arrayIndex;qe++){const F=Fe.layers[qe];k.K(F.id)===je&&Me.push(new k.V(Oe,Ae.id,`duplicate layer id "${Ae.id}", previously used at line ${F.id.__line__}`))}}if("ref"in Ae){let F;["type","source","source-layer","filter","layout"].forEach((F=>{F in Ae&&Me.push(new k.V(Oe,Ae[F],`"${F}" is prohibited for ref layers`))})),Fe.layers.forEach((Me=>{k.K(Me.id)===pt&&(F=Me)})),F?F.ref?Me.push(new k.V(Oe,Ae.ref,"ref cannot reference another ref layer")):qe=k.K(F.type):"string"==typeof pt&&Me.push(new k.V(Oe,Ae.ref,`ref layer "${pt}" not found`))}else if("background"!==qe&&"sky"!==qe&&"slot"!==qe)if(Ae.source){const F=Fe.sources&&Fe.sources[Ae.source],je=F&&k.K(F.type);F?"vector"===je&&"raster"===qe?Me.push(new k.V(Oe,Ae.source,`layer "${Ae.id}" requires a raster source`)):"raster"===je&&"raster"!==qe?Me.push(new k.V(Oe,Ae.source,`layer "${Ae.id}" requires a vector source`)):"vector"!==je||Ae["source-layer"]?"raster-dem"===je&&"hillshade"!==qe?Me.push(new k.V(Oe,Ae.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==je||["raster","raster-particle"].includes(qe)?"line"!==qe||!Ae.paint||!Ae.paint["line-gradient"]&&!Ae.paint["line-trim-offset"]||"geojson"===je&&F.lineMetrics?"raster-particle"===qe&&"raster-array"!==je&&Me.push(new k.V(Oe,Ae.source,`layer "${Ae.id}" requires a 'raster-array' source.`)):Me.push(new k.V(Oe,Ae,`layer "${Ae.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):Me.push(new k.V(Oe,Ae.source,"raster-array source can only be used with layer type 'raster'.")):Me.push(new k.V(Oe,Ae,`layer "${Ae.id}" must specify a "source-layer"`)):Me.push(new k.V(Oe,Ae.source,`source "${Ae.source}" not found`))}else Me.push(new k.V(Oe,Ae,'missing required property "source"'));return Me=Me.concat(H({key:Oe,value:Ae,valueSpec:je.layer,style:F.style,styleSpec:F.styleSpec,objectElementValidators:{"*":()=>[],type:()=>_e({key:`${Oe}.type`,value:Ae.type,valueSpec:je.layer.type,style:F.style,styleSpec:F.styleSpec,object:Ae,objectKey:"type"}),filter:F=>J(k.J({layerType:qe},F)),layout:F=>H({layer:Ae,key:F.key,value:F.value,valueSpec:{},style:F.style,styleSpec:F.styleSpec,objectElementValidators:{"*":F=>ie(k.J({layerType:qe},F))}}),paint:F=>H({layer:Ae,key:F.key,value:F.value,valueSpec:{},style:F.style,styleSpec:F.styleSpec,objectElementValidators:{"*":F=>te(k.J({layerType:qe,layer:Ae},F))}})}})),Me}function se(F){const Me=F.value,Ae=F.key,Oe=k.H(Me);return"string"!==Oe?[new k.V(Ae,Me,`string expected, ${Oe} found`)]:[]}const zo={promoteId:function({key:F,value:Me}){if("string"===k.H(Me))return se({key:F,value:Me});{const k=[];for(const Ae in Me)k.push(...se({key:`${F}.${Ae}`,value:Me[Ae]}));return k}}};function ae(F){const Me=F.value,Ae=F.key,Oe=F.styleSpec,Fe=F.style;if(!Me.type)return[new k.V(Ae,Me,'"type" is required')];const je=k.K(Me.type);let qe=[];switch(["vector","raster","raster-dem","raster-array"].includes(je)&&(Me.url||Me.tiles||qe.push(new k.G(Ae,Me,'Either "url" or "tiles" is required.'))),je){case"vector":case"raster":case"raster-dem":case"raster-array":return qe=qe.concat(H({key:Ae,value:Me,valueSpec:Oe[`source_${je.replace("-","_")}`],style:F.style,styleSpec:Oe,objectElementValidators:zo})),qe;case"geojson":if(qe=H({key:Ae,value:Me,valueSpec:Oe.source_geojson,style:Fe,styleSpec:Oe,objectElementValidators:zo}),Me.cluster)for(const k in Me.clusterProperties){const[F,Oe]=Me.clusterProperties[k],Fe="string"==typeof F?[F,["accumulated"],["get",k]]:F;qe.push(...X({key:`${Ae}.${k}.map`,value:Oe,expressionContext:"cluster-map"})),qe.push(...X({key:`${Ae}.${k}.reduce`,value:Fe,expressionContext:"cluster-reduce"}))}return qe;case"video":return H({key:Ae,value:Me,valueSpec:Oe.source_video,style:Fe,styleSpec:Oe});case"image":return H({key:Ae,value:Me,valueSpec:Oe.source_image,style:Fe,styleSpec:Oe});case"canvas":return[new k.V(Ae,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Y({key:`${Ae}.type`,value:Me.type,valueSpec:{values:ne(Oe)},style:Fe,styleSpec:Oe})}}function ne(k){return k.source.reduce(((F,Me)=>{const Ae=k[Me];return"enum"===Ae.type.type&&(F=F.concat(Object.keys(Ae.type.values))),F}),[])}function le(F){const Me=F.value,Ae=F.styleSpec,Oe=Ae.light,Fe=F.style;let je=[];const qe=k.H(Me);if(void 0===Me)return je;if("object"!==qe)return je=je.concat([new k.V("light",Me,`object expected, ${qe} found`)]),je;for(const F in Me){const qe=F.match(/^(.*)-transition$/),pt=F.match(/^(.*)-use-theme$/);je=je.concat(pt&&Oe[pt[1]]?_e({key:F,value:Me[F],valueSpec:{type:"string"},style:Fe,styleSpec:Ae}):qe&&Oe[qe[1]]&&Oe[qe[1]].transition?_e({key:F,value:Me[F],valueSpec:Ae.transition,style:Fe,styleSpec:Ae}):Oe[F]?_e({key:F,value:Me[F],valueSpec:Oe[F],style:Fe,styleSpec:Ae}):[new k.V(F,Me[F],`unknown property "${F}"`)])}return je}function ce(F){const Me=F.value;let Ae=[];if(!Me)return Ae;const Oe=k.H(Me);if("object"!==Oe)return Ae=Ae.concat([new k.V("light-3d",Me,`object expected, ${Oe} found`)]),Ae;const Fe=F.styleSpec,je=Fe["light-3d"],qe=F.key,pt=F.style,vt=F.style.lights;for(const F of["type","id"])if(!(F in Me))return Ae=Ae.concat([new k.V("light-3d",Me,`missing property ${F} on light`)]),Ae;if(Me.type&&vt)for(let Oe=0;Oe<F.arrayIndex;Oe++){const F=k.K(Me.type),Fe=vt[Oe];k.K(Fe.type)===F&&Ae.push(new k.V(qe,Me.id,`duplicate light type "${Me.type}", previously defined at line ${Fe.id.__line__}`))}const Ut=`properties_light_${Me.type}`;if(!(Ut in Fe))return Ae=Ae.concat([new k.V("light-3d",Me,`Invalid light type ${Me.type}`)]),Ae;const xi=Fe[Ut];for(const Oe in Me)if("properties"===Oe){const je=Me[Oe],qe=k.H(je);if("object"!==qe)return Ae=Ae.concat([new k.V("properties",je,`object expected, ${qe} found`)]),Ae;for(const Me in je)Ae=Ae.concat(xi[Me]?_e({key:Me,value:je[Me],valueSpec:xi[Me],style:pt,styleSpec:Fe}):[new k.G(F.key,je[Me],`unknown property "${Me}"`)])}else{const F=Oe.match(/^(.*)-transition$/),qe=Oe.match(/^(.*)-use-theme$/);Ae=Ae.concat(qe&&je[qe[1]]?_e({key:Oe,value:Me[Oe],valueSpec:{type:"string"},style:pt,styleSpec:Fe}):F&&je[F[1]]&&je[F[1]].transition?_e({key:Oe,value:Me[Oe],valueSpec:Fe.transition,style:pt,styleSpec:Fe}):je[Oe]?_e({key:Oe,value:Me[Oe],valueSpec:je[Oe],style:pt,styleSpec:Fe}):[new k.G(Oe,Me[Oe],`unknown property "${Oe}"`)])}return Ae}function he(F){const Me=F.value,Ae=F.key,Oe=F.style,Fe=F.styleSpec,je=Fe.terrain;let qe=[];const pt=k.H(Me);if(void 0===Me)return qe;if("null"===pt)return qe;if("object"!==pt)return qe=qe.concat([new k.V("terrain",Me,`object expected, ${pt} found`)]),qe;for(const F in Me){const Ae=F.match(/^(.*)-transition$/),pt=F.match(/^(.*)-use-theme$/);qe=qe.concat(pt&&je[pt[1]]?_e({key:F,value:Me[F],valueSpec:{type:"string"},style:Oe,styleSpec:Fe}):Ae&&je[Ae[1]]&&je[Ae[1]].transition?_e({key:F,value:Me[F],valueSpec:Fe.transition,style:Oe,styleSpec:Fe}):je[F]?_e({key:F,value:Me[F],valueSpec:je[F],style:Oe,styleSpec:Fe}):[new k.G(F,Me[F],`unknown property "${F}"`)])}if(Me.source){const F=Oe.sources&&Oe.sources[Me.source],Fe=F&&k.K(F.type);F?"raster-dem"!==Fe&&qe.push(new k.V(Ae,Me.source,`terrain cannot be used with a source of type ${String(Fe)}, it only be used with a "raster-dem" source type`)):qe.push(new k.V(Ae,Me.source,`source "${Me.source}" not found`))}else qe.push(new k.V(Ae,Me,'terrain is missing required property "source"'));return qe}function ue(F){const Me=F.value,Ae=F.style,Oe=F.styleSpec,Fe=Oe.fog;let je=[];const qe=k.H(Me);if(void 0===Me)return je;if("object"!==qe)return je=je.concat([new k.V("fog",Me,`object expected, ${qe} found`)]),je;for(const F in Me){const qe=F.match(/^(.*)-transition$/),pt=F.match(/^(.*)-use-theme$/);je=je.concat(pt&&Fe[pt[1]]?_e({key:F,value:Me[F],valueSpec:{type:"string"},style:Ae,styleSpec:Oe}):qe&&Fe[qe[1]]&&Fe[qe[1]].transition?_e({key:F,value:Me[F],valueSpec:Oe.transition,style:Ae,styleSpec:Oe}):Fe[F]?_e({key:F,value:Me[F],valueSpec:Fe[F],style:Ae,styleSpec:Oe}):[new k.G(F,Me[F],`unknown property "${F}"`)])}return je}const ko={"*":()=>[],array:Z,boolean:function(F){const Me=F.value,Ae=F.key,Oe=k.H(Me);return"boolean"!==Oe?[new k.V(Ae,Me,`boolean expected, ${Oe} found`)]:[]},number:W,color:function(F){const Me=F.key,Ae=F.value,Oe=k.H(Ae);return"string"!==Oe?[new k.V(Me,Ae,`color expected, ${Oe} found`)]:null===k._.parseCSSColor(Ae)?[new k.V(Me,Ae,`color expected, "${Ae}" found`)]:[]},enum:Y,filter:J,function:$,layer:oe,object:H,source:ae,model:k.a2,light:le,"light-3d":ce,terrain:he,fog:ue,string:se,formatted:function(k){return 0===se(k).length?[]:X(k)},resolvedImage:function(k){return 0===se(k).length?[]:X(k)},projection:function(F){const Me=F.value,Ae=F.styleSpec,Oe=Ae.projection,Fe=F.style;let je=[];const qe=k.H(Me);if("object"===qe)for(const k in Me)je=je.concat(_e({key:k,value:Me[k],valueSpec:Oe[k],style:Fe,styleSpec:Ae}));else"string"!==qe&&(je=je.concat([new k.V("projection",Me,`object or string expected, ${qe} found`)]));return je},import:function(F){const{value:Me,styleSpec:Ae}=F,{data:Oe,...Fe}=Me;Object.defineProperty(Fe,"__line__",{value:Me.__line__,enumerable:!1});let je=H(k.J({},F,{value:Fe,valueSpec:Ae.import}));return""===k.K(Fe.id)&&je.push(new k.V(`${F.key}.id`,Fe,"import id can't be an empty string")),Oe&&(je=je.concat(fe(Oe,Ae,{key:`${F.key}.data`}))),je}};function _e(F,Me=!1){const Ae=F.value,Oe=F.valueSpec,Fe=F.styleSpec;if(Oe.expression&&k.a0(k.K(Ae)))return $(F);if(Oe.expression&&k.O(k.Q(Ae)))return X(F);if(Oe.type&&ko[Oe.type]){const Ae=ko[Oe.type](F);return!0===Me&&Ae.length>0&&"array"===k.H(F.value)?X(F):Ae}return H(k.J({},F,{valueSpec:Oe.type?Fe[Oe.type]:Oe}))}function pe(F){const Me=F.value,Ae=F.key,Oe=se(F);return Oe.length||(-1===Me.indexOf("{fontstack}")&&Oe.push(new k.V(Ae,Me,'"glyphs" url must include a "{fontstack}" token')),-1===Me.indexOf("{range}")&&Oe.push(new k.V(Ae,Me,'"glyphs" url must include a "{range}" token'))),Oe}function fe(F,Me=k.a3,Ae={}){return _e({key:Ae.key||"",value:F,valueSpec:Me.$root,styleSpec:Me,style:F,objectElementValidators:{glyphs:pe,"*":()=>[]}})}function me(F,Me=k.a3){return De(fe(F,Me))}const ge=k=>De(ae(k)),ve=k=>De(le(k)),ye=k=>De(ce(k)),xe=k=>De(he(k)),be=k=>De(ue(k)),we=F=>De(function(F){const Me=F.value,Ae=F.style,Oe=F.styleSpec,Fe=Oe.snow;let je=[];const qe=k.H(Me);if(void 0===Me)return je;if("object"!==qe)return je=je.concat([new k.V("snow",Me,`object expected, ${qe} found`)]),je;for(const F in Me){const qe=F.match(/^(.*)-transition$/);je=je.concat(qe&&Fe[qe[1]]&&Fe[qe[1]].transition?_e({key:F,value:Me[F],valueSpec:Oe.transition,style:Ae,styleSpec:Oe}):Fe[F]?_e({key:F,value:Me[F],valueSpec:Fe[F],style:Ae,styleSpec:Oe}):[new k.G(F,Me[F],`unknown property "${F}"`)])}return je}(F)),Te=F=>De(function(F){const Me=F.value,Ae=F.style,Oe=F.styleSpec,Fe=Oe.rain;let je=[];const qe=k.H(Me);if(void 0===Me)return je;if("object"!==qe)return je=je.concat([new k.V("rain",Me,`object expected, ${qe} found`)]),je;for(const F in Me){const qe=F.match(/^(.*)-transition$/);je=je.concat(qe&&Fe[qe[1]]&&Fe[qe[1]].transition?_e({key:F,value:Me[F],valueSpec:Oe.transition,style:Ae,styleSpec:Oe}):Fe[F]?_e({key:F,value:Me[F],valueSpec:Fe[F],style:Ae,styleSpec:Oe}):[new k.G(F,Me[F],`unknown property "${F}"`)])}return je}(F)),Ee=k=>De(oe(k)),Se=k=>De(J(k)),Ce=k=>De(te(k)),Ie=k=>De(ie(k)),Re=F=>De(k.a2(F));function De(k){return k.slice().sort(((k,F)=>k.line&&F.line?k.line-F.line:0))}function Le(F,Me){let Ae=!1;if(Me&&Me.length)for(const Oe of Me)Oe instanceof k.G?k.w(Oe.message):(F.fire(new k.y(new Error(Oe.message))),Ae=!0);return Ae}let na;class ze extends k.E{constructor(F,Me="flat"){super(),this._transitionable=new k.a4(na||(na=new k.a5({anchor:new k.a6(k.a3.light.anchor),position:new k.a7(k.a3.light.position),color:new k.a6(k.a3.light.color),intensity:new k.a6(k.a3.light.intensity)}))),this.setLight(F,Me),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(k,F,Me={}){this._validate(ve,k,Me)||(this._transitionable.setTransitionOrValue(k),this.id=F)}updateTransitions(k){this._transitioning=this._transitionable.transitioned(k,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(k){this.properties=this._transitioning.possiblyEvaluate(k)}_validate(F,Me,Ae){return(!Ae||!1!==Ae.validate)&&Le(this,F.call(me,k.l({value:Me,style:{glyphs:!0,sprite:!0},styleSpec:k.a3})))}}let aa=class extends k.E{constructor(F,Me,Ae,Oe){super(),this.scope=Ae,this._transitionable=new k.a4(new k.a5({source:new k.a6(k.a3.terrain.source),exaggeration:new k.a6(k.a3.terrain.exaggeration)}),Ae,Oe),this._transitionable.setTransitionOrValue(F,Oe),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=Me}get(){return this._transitionable.serialize()}set(k,F){this._transitionable.setTransitionOrValue(k,F)}updateTransitions(k){this._transitioning=this._transitionable.transitioned(k,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(k){this.properties=this._transitioning.possiblyEvaluate(k)}getExaggeration(F){return this._transitioning.possiblyEvaluate(new k.a8(F)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const F=this._transitionable._values.exaggeration;if(!F)return null;const Me=F.value.expression;if(!Me)return null;let Ae=-1,Oe=-1,Fe=1;for(const F of Me.zoomStops)Fe=Me.evaluate(new k.a8(F)),Fe>.01?(Ae=F,Oe=-1):Oe=F;return Fe<.01&&Ae>0&&Oe>Ae?[Ae,Oe]:null}isZoomDependent(){const F=this._transitionable._values.exaggeration;return null!=F&&null!=F.value&&null!=F.value.expression&&F.value.expression instanceof k.a9}};const _a=45,wa=65,Sa=.05;function ke(F,Me,Ae,Oe){const Fe=k.ac(_a,wa,Ae),[je,qe]=Be(F,Oe);let pt=1-Math.min(1,Math.exp((Me-je)/(qe-je)*-6));return pt*=pt*pt,pt=Math.min(1,1.00747*pt),pt*Fe*F.alpha}function Be(k,F){const Me=.5/Math.tan(.5*F);return[k.range[0]+Me,k.range[1]+Me]}function Ne(F,Me,Ae,Oe,Fe){const je=k.ab.vec3.transformMat4([],[Me,Ae,Oe],Fe.mercatorFogMatrix);return ke(F,k.ab.vec3.length(je),Fe.pitch,Fe._fov)}function Ue(F,Me,Ae,Oe,Fe,je,qe){const pt=[[Ae,Oe,0],[Fe,Oe,0],[Fe,je,0],[Ae,je,0]];let vt=Number.MAX_VALUE,Ut=-Number.MAX_VALUE;for(const F of pt){const Ae=k.ab.vec3.transformMat4([],F,Me),Oe=k.ab.vec3.length(Ae);vt=Math.min(vt,Oe),Ut=Math.max(Ut,Oe)}return[ke(F,vt,qe.pitch,qe._fov),ke(F,Ut,qe.pitch,qe._fov)]}class Ge extends k.E{constructor(F,Me,Ae,Oe){super();const Fe=new k.a5({range:new k.a6(k.a3.fog.range),color:new k.a6(k.a3.fog.color),"color-use-theme":new k.a6({type:"string","property-type":"data-constant",default:"default"}),"high-color":new k.a6(k.a3.fog["high-color"]),"high-color-use-theme":new k.a6({type:"string","property-type":"data-constant",default:"default"}),"space-color":new k.a6(k.a3.fog["space-color"]),"space-color-use-theme":new k.a6({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new k.a6(k.a3.fog["horizon-blend"]),"star-intensity":new k.a6(k.a3.fog["star-intensity"]),"vertical-range":new k.a6(k.a3.fog["vertical-range"])});this._transitionable=new k.a4(Fe,Ae,new Map(Oe)),this.set(F,Oe),this._transitioning=this._transitionable.untransitioned(),this._transform=Me,this.properties=new k.ad(Fe),this.scope=Ae}get state(){const F=this._transform,Me="globe"===F.projection.name,Ae=k.ae(F.zoom),Oe=this.properties.get("range"),Fe=[.5,3];return{range:Me?[k.af(Fe[0],Oe[0],Ae),k.af(Fe[1],Oe[1],Ae)]:Oe,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(F,Me,Ae={}){if(this._validate(be,F,Ae))return;const Oe=k.l({},F);for(const F of Object.keys(k.a3.fog))void 0===Oe[F]&&(Oe[F]=k.a3.fog[F].default);this._options=Oe,this._transitionable.setTransitionOrValue(this._options,Me)}getOpacity(F){if(!this._transform.projection.supportsFog)return 0;const Me=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:k.ac(_a,wa,F))*Me.a}getOpacityAtLatLng(F,Me){return this._transform.projection.supportsFog?function(F,Me,Ae){const Oe=k.aa.fromLngLat(Me),Fe=Ae.elevation?Ae.elevation.getAtPointOrZero(Oe):0;return Ne(F,Oe.x,Oe.y,Fe,Ae)}(this.state,F,Me):0}getOpacityForTile(F){if(!this._transform.projection.supportsFog)return[1,1];const Me=this._transform.calculateFogTileMatrix(F.toUnwrapped());return Ue(this.state,Me,0,0,k.ag,k.ag,this._transform)}getOpacityForBounds(k,F,Me,Ae,Oe){return this._transform.projection.supportsFog?Ue(this.state,k,F,Me,Ae,Oe,this._transform):[1,1]}getFovAdjustedRange(k){return this._transform.projection.supportsFog?Be(this.state,k):[0,1]}isVisibleOnFrustum(F){if(!this._transform.projection.supportsFog)return!1;const Me=[4,5,6,7];for(const Ae of Me){const Me=F.points[Ae];let Oe;if(Me[2]>=0)Oe=Me;else{const Fe=F.points[Ae-4];Oe=k.ah(Fe,Me,Fe[2]/(Fe[2]-Me[2]))}if(Ne(this.state,Oe[0],Oe[1],0,this._transform)>=Sa)return!0}return!1}updateConfig(k){this._transitionable.setTransitionOrValue(this._options,new Map(k))}updateTransitions(k){this._transitioning=this._transitionable.transitioned(k,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(k){this.properties=this._transitioning.possiblyEvaluate(k)}_validate(F,Me,Ae){return(!Ae||!1!==Ae.validate)&&Le(this,F.call(me,k.l({value:Me,style:{glyphs:!0,sprite:!0},styleSpec:k.a3})))}}let Ya,rl,sl,ml,Sl=class extends k.E{constructor(F,Me,Ae,Oe){super();const Fe=Ya||(Ya=new k.a5({density:new k.a6(k.a3.snow.density),intensity:new k.a6(k.a3.snow.intensity),color:new k.a6(k.a3.snow.color),opacity:new k.a6(k.a3.snow.opacity),vignette:new k.a6(k.a3.snow.vignette),"vignette-color":new k.a6(k.a3.snow["vignette-color"]),"center-thinning":new k.a6(k.a3.snow["center-thinning"]),direction:new k.a6(k.a3.snow.direction),"flake-size":new k.a6(k.a3.snow["flake-size"])}));this._transitionable=new k.a4(Fe,Ae,new Map(Oe)),this.set(F,Oe),this._transitioning=this._transitionable.untransitioned(),this.properties=new k.ad(Fe),this.scope=Ae}get state(){const F=this.properties.get("opacity"),Me=this.properties.get("color"),Ae=this.properties.get("direction"),Oe=k.ai(Ae[0]),Fe=-Math.max(k.ai(Ae[1]),.01),je=[Math.cos(Oe)*Math.cos(Fe),Math.sin(Oe)*Math.cos(Fe),Math.sin(Fe)],qe=this.properties.get("vignette"),pt=this.properties.get("vignette-color");return pt.a=qe,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new k.aj(Me.r,Me.g,Me.b,Me.a*F),direction:je,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:pt}}get(){return this._transitionable.serialize()}set(F,Me,Ae={}){if(this._validate(we,F,Ae))return;const Oe=k.l({},F);for(const F of Object.keys(k.a3.snow))void 0===Oe[F]&&(Oe[F]=k.a3.snow[F].default);this._options=Oe,this._transitionable.setTransitionOrValue(this._options,Me)}updateConfig(k){this._transitionable.setTransitionOrValue(this._options,new Map(k))}updateTransitions(k){this._transitioning=this._transitionable.transitioned(k,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(k){this.properties=this._transitioning.possiblyEvaluate(k)}_validate(F,Me,Ae){return(!Ae||!1!==Ae.validate)&&Le(this,F.call(me,k.l({value:Me,style:{glyphs:!0,sprite:!0},styleSpec:k.a3})))}},Il=class extends k.E{constructor(F,Me,Ae,Oe){super();const Fe=rl||(rl=new k.a5({density:new k.a6(k.a3.rain.density),intensity:new k.a6(k.a3.rain.intensity),color:new k.a6(k.a3.rain.color),opacity:new k.a6(k.a3.rain.opacity),vignette:new k.a6(k.a3.rain.vignette),"vignette-color":new k.a6(k.a3.rain["vignette-color"]),"center-thinning":new k.a6(k.a3.rain["center-thinning"]),direction:new k.a6(k.a3.rain.direction),"droplet-size":new k.a6(k.a3.rain["droplet-size"]),"distortion-strength":new k.a6(k.a3.rain["distortion-strength"])}));this._transitionable=new k.a4(Fe,Ae,new Map(Oe)),this.set(F,Oe),this._transitioning=this._transitionable.untransitioned(),this.properties=new k.ad(Fe),this.scope=Ae}get state(){const F=this.properties.get("opacity"),Me=this.properties.get("color"),Ae=this.properties.get("direction"),Oe=k.ai(Ae[0]),Fe=-Math.max(k.ai(Ae[1]),.01),je=[Math.cos(Oe)*Math.cos(Fe),Math.sin(Oe)*Math.cos(Fe),Math.sin(Fe)],qe=this.properties.get("vignette-color");return qe.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new k.aj(Me.r,Me.g,Me.b,Me.a*F),direction:je,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:qe}}get(){return this._transitionable.serialize()}set(F,Me,Ae={}){if(this._validate(Te,F,Ae))return;const Oe=k.l({},F);for(const F of Object.keys(k.a3.rain))void 0===Oe[F]&&(Oe[F]=k.a3.rain[F].default);this._options=Oe,this._transitionable.setTransitionOrValue(this._options,Me)}updateConfig(k){this._transitionable.setTransitionOrValue(this._options,new Map(k))}updateTransitions(k){this._transitioning=this._transitionable.transitioned(k,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(k){this.properties=this._transitioning.possiblyEvaluate(k)}_validate(F,Me,Ae){return(!Ae||!1!==Ae.validate)&&Le(this,F.call(me,k.l({value:Me,style:{glyphs:!0,sprite:!0},styleSpec:k.a3})))}};class $e extends k.E{constructor(F,Me,Ae,Oe){super(),this.scope=Ae,this._options=F,this.properties=new k.ad(Me),this._transitionable=new k.a4(Me,Ae,new Map(Oe)),this._transitionable.setTransitionOrValue(F.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(k){this._transitionable.setTransitionOrValue(this._options.properties,new Map(k))}updateTransitions(k){this._transitioning=this._transitionable.transitioned(k,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(k){this.properties=this._transitioning.possiblyEvaluate(k)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(k,F){this._options=k,this._transitionable.setTransitionOrValue(k.properties,F)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Xe{constructor(k,F,Me,Ae){this.screenBounds=k,this.cameraPoint=F,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=Me,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,Ae)}static createFromScreenPoints(F,Me){let Ae,Oe;if(F instanceof k.P||"number"==typeof F[0]){const Fe=k.P.convert(F);Ae=[Fe],Oe=Me.isPointAboveHorizon(Fe)}else{const Fe=k.P.convert(F[0]),je=k.P.convert(F[1]);Ae=[Fe,je],Oe=k.al(Fe,je).every((k=>Me.isPointAboveHorizon(k)))}return new Xe(Ae,Me.getCameraPoint(),Oe,Me)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(F){return k.al(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],F)}bufferedCameraGeometry(F){const Me=this.screenBounds[0],Ae=1===this.screenBounds.length?this.screenBounds[0].add(new k.P(1,1)):this.screenBounds[1],Oe=k.al(Me,Ae,0,!1);return this.cameraPoint.y>Ae.y&&(this.cameraPoint.x>Me.x&&this.cameraPoint.x<Ae.x?Oe.splice(3,0,this.cameraPoint):this.cameraPoint.x>=Ae.x?Oe[2]=this.cameraPoint:this.cameraPoint.x<=Me.x&&(Oe[3]=this.cameraPoint)),k.am(Oe,F)}bufferedCameraGeometryGlobe(F){const Me=this.screenBounds[0],Ae=1===this.screenBounds.length?this.screenBounds[0].add(new k.P(1,1)):this.screenBounds[1],Oe=k.al(Me,Ae,F),Fe=this.cameraPoint.clone();switch(3*((Fe.y>Me.y)+(Fe.y>Ae.y))+((Fe.x>Me.x)+(Fe.x>Ae.x))){case 0:Oe[0]=Fe,Oe[4]=Fe.clone();break;case 1:Oe.splice(1,0,Fe);break;case 2:Oe[1]=Fe;break;case 3:Oe.splice(4,0,Fe);break;case 5:Oe.splice(2,0,Fe);break;case 6:Oe[3]=Fe;break;case 7:Oe.splice(3,0,Fe);break;case 8:Oe[2]=Fe}return Oe}containsTile(F,Me,Ae,Oe=0){const Fe=F.queryPadding/Me._pixelsPerMercatorPixel+1,je=Ae?this._bufferedCameraMercator(Fe,Me):this._bufferedScreenMercator(Fe,Me);let qe=F.tileID.wrap+(je.unwrapped?Oe:0);const pt=je.polygon.map((Me=>k.an(F.tileTransform,Me,qe)));if(!k.ao(pt,0,0,k.ag,k.ag))return;qe=F.tileID.wrap+(this.screenGeometryMercator.unwrapped?Oe:0);const vt=this.screenGeometryMercator.polygon.map((Me=>k.ap(F.tileTransform,Me,qe))),Ut=vt.map((F=>new k.P(F[0],F[1]))),xi=Me.getFreeCameraOptions().position||new k.aa(0,0,0),vi=k.ap(F.tileTransform,xi,qe),bi=vt.map((F=>{const Me=k.ab.vec3.sub(F,F,vi);return k.ab.vec3.normalize(Me,Me),new k.aq(vi,Me)})),wi=k.ar(F,1,Me.zoom)*Me._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:Ut,tilespaceRays:bi,bufferedTilespaceGeometry:pt,bufferedTilespaceBounds:(Mi=k.as(pt),Mi.min.x=k.aw(Mi.min.x,0,k.ag),Mi.min.y=k.aw(Mi.min.y,0,k.ag),Mi.max.x=k.aw(Mi.max.x,0,k.ag),Mi.max.y=k.aw(Mi.max.y,0,k.ag),Mi),tile:F,tileID:F.tileID,pixelToTileUnitsFactor:wi};var Mi}_bufferedScreenMercator(k,F){const Me=Je(k);if(this._screenRaycastCache[Me])return this._screenRaycastCache[Me];{let Ae;return Ae="globe"===F.projection.name?this._projectAndResample(this.bufferedScreenGeometry(k),F):{polygon:this.bufferedScreenGeometry(k).map((k=>F.pointCoordinate3D(k))),unwrapped:!0},this._screenRaycastCache[Me]=Ae,Ae}}_bufferedCameraMercator(k,F){const Me=Je(k);if(this._cameraRaycastCache[Me])return this._cameraRaycastCache[Me];{let Ae;return Ae="globe"===F.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(k),F):{polygon:this.bufferedCameraGeometry(k).map((k=>F.pointCoordinate3D(k))),unwrapped:!0},this._cameraRaycastCache[Me]=Ae,Ae}}_projectAndResample(F,Me){const Ae=function(F,Me){const Ae=k.ab.mat4.multiply([],Me.pixelMatrix,Me.globeMatrix),Oe=[0,-k.ax,0,1],Fe=[0,k.ax,0,1],je=[0,0,0,1];k.ab.vec4.transformMat4(Oe,Oe,Ae),k.ab.vec4.transformMat4(Fe,Fe,Ae),k.ab.vec4.transformMat4(je,je,Ae);const qe=new k.P(Oe[0]/Oe[3],Oe[1]/Oe[3]),pt=new k.P(Fe[0]/Fe[3],Fe[1]/Fe[3]),vt=k.au(F,qe)&&Oe[3]<je[3],Ut=k.au(F,pt)&&Fe[3]<je[3];if(!vt&&!Ut)return null;const xi=function(k,F,Me){for(let Ae=1;Ae<k.length;Ae++){const Oe=Ye(F.pointCoordinate3D(k[Ae-1]).x),Fe=Ye(F.pointCoordinate3D(k[Ae]).x);if(Me<0){if(Oe<Fe)return{idx:Ae,t:-Oe/(Fe-1-Oe)}}else if(Fe<Oe)return{idx:Ae,t:(1-Oe)/(Fe+1-Oe)}}return null}(F,Me,vt?-1:1);if(!xi)return null;const{idx:vi,t:bi}=xi;let wi=vi>1?Ke(F.slice(0,vi),Me):[],Mi=vi<F.length?Ke(F.slice(vi),Me):[];wi=wi.map((F=>new k.P(Ye(F.x),F.y))),Mi=Mi.map((F=>new k.P(Ye(F.x),F.y)));const pr=[...wi];0===pr.length&&pr.push(Mi[Mi.length-1]);const Ur=k.af(pr[pr.length-1].y,(0===Mi.length?wi[0]:Mi[0]).y,bi);let Wr;return Wr=vt?[new k.P(0,Ur),new k.P(0,0),new k.P(1,0),new k.P(1,Ur)]:[new k.P(1,Ur),new k.P(1,1),new k.P(0,1),new k.P(0,Ur)],pr.push(...Wr),0===Mi.length?pr.push(wi[0]):pr.push(...Mi),{polygon:pr.map((F=>new k.aa(F.x,F.y))),unwrapped:!1}}(F,Me);if(Ae)return Ae;const Oe=function(F,Me){let Ae=!1,Oe=-1/0,Fe=0;for(let k=0;k<F.length-1;k++)F[k].x>Oe&&(Oe=F[k].x,Fe=k);for(let k=0;k<F.length-1;k++){const Me=(Fe+k)%(F.length-1),Oe=F[Me],je=F[Me+1];Math.abs(Oe.x-je.x)>.5&&(Oe.x<je.x?(Oe.x+=1,0===Me&&(F[F.length-1].x+=1)):(je.x+=1,Me+1===F.length-1&&(F[0].x+=1)),Ae=!0)}const je=k.at(Me.center.lng);return Ae&&je<Math.abs(je-1)&&F.forEach((k=>{k.x-=1})),{polygon:F,unwrapped:Ae}}(Ke(F,Me).map((F=>new k.P(Ye(F.x),F.y))),Me);return{polygon:Oe.polygon.map((F=>new k.aa(F.x,F.y))),unwrapped:Oe.unwrapped}}}function Ke(F,Me){return k.av(F,(k=>{const F=Me.pointCoordinate3D(k);k.x=F.x,k.y=F.y}),1/256)}function Ye(k){return k<0?1+k%1:k%1}function Je(k){return 100*k|0}function Qe(F,Me,Ae,Oe,Fe){const a=function(Ae,Oe){if(Ae)return Fe(Ae);if(Oe){if(F.url&&Oe.tiles&&F.tiles&&delete F.tiles,Oe.variants){if(!Array.isArray(Oe.variants))return Fe(new Error("variants must be an array"));for(const F of Oe.variants){if(null==F||"object"!=typeof F||F.constructor!==Object)return Fe(new Error("variant must be an object"));if(!Array.isArray(F.capabilities))return Fe(new Error("capabilities must be an array"));if(1===F.capabilities.length&&"meshopt"===F.capabilities[0]){Oe=k.l(Oe,F);break}}}const Ae=k.ay(k.l({},Oe,F),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);Ae.tiles=Me.canonicalizeTileset(Ae,F.url),Fe(null,Ae)}},je=function(k,F,Me){if(!k)return null;if(!F&&!Me)return k;Me=Me||k.worldview_default;const Ae=Object.values(k.language||{});if(0===Ae.length)return null;const Oe=Object.values(k.worldview||{});if(0===Oe.length)return null;const Fe=Ae.every((k=>k===F)),je=Oe.every((k=>k===Me));return Fe&&je?k:F in(k.language_options||{})||Me in(k.worldview_options||{})?null:k.language_options&&k.worldview_options?k:null}(F.data,Ae,Oe);return je?k.q.frame((()=>a(null,je))):F.url?k.n(Me.transformRequest(Me.normalizeSourceURL(F.url,null,Ae,Oe),k.R.Source),a):k.q.frame((()=>{const{data:k,...Me}=F;a(null,Me)}))}class et{constructor(F,Me,Ae){this.bounds=k.az.convert(this.validateBounds(F)),this.minzoom=Me||0,this.maxzoom=Ae||24}validateBounds(k){return Array.isArray(k)&&4===k.length?[Math.max(-180,k[0]),Math.max(-90,k[1]),Math.min(180,k[2]),Math.min(90,k[3])]:[-180,-90,180,90]}contains(F){const Me=Math.pow(2,F.z),Ae=Math.floor(k.at(this.bounds.getWest())*Me),Oe=Math.floor(k.aA(this.bounds.getNorth())*Me),Fe=Math.ceil(k.at(this.bounds.getEast())*Me),je=Math.ceil(k.aA(this.bounds.getSouth())*Me);return F.x>=Ae&&F.x<Fe&&F.y>=Oe&&F.y<je}}class tt extends k.E{constructor(F,Me,Ae,Oe){if(super(),this.id=F,this.dispatcher=Ae,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,k.l(this,k.ay(Me,["url","scheme","tileSize","promoteId"])),this._options=k.l({type:"vector"},Me),this._collectResourceTiming=!!Me.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(Oe),this._tileWorkers={},this._deduped=new k.aB}load(F){this._loaded=!1,this.fire(new k.z("dataloading",{dataType:"source"}));const Me=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Ae=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Me,Ae,((Oe,Fe)=>{if(this._tileJSONRequest=null,this._loaded=!0,Oe)Me&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Me}`),Ae&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Ae}`),this.fire(new k.y(Oe));else if(Fe){if(k.l(this,Fe),this.hasWorldviews=!!Fe.worldview_options,Fe.worldview_default&&(this.worldviewDefault=Fe.worldview_default),Fe.vector_layers){this.vectorLayers=Fe.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const k of Fe.vector_layers)this.vectorLayerIds.push(k.id),Fe.worldview&&Fe.worldview[k.source]&&this.localizableLayerIds.add(k.id)}Fe.bounds&&(this.tileBounds=new et(Fe.bounds,this.minzoom,this.maxzoom)),Mi(Fe.tiles,this.map._requestManager._customAccessToken),this.fire(new k.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new k.z("data",{dataType:"source",sourceDataType:"content"}))}F&&F(Oe)}))}loaded(){return this._loaded}hasTile(k){return!this.tileBounds||this.tileBounds.contains(k.canonical)}onAdd(k){this.map=k,this.load()}reload(){this.cancelTileJSONRequest();const F=k.aC(this.id,this.scope);this.load((()=>this.map.style.clearSource(F)))}setTiles(k){return this._options.tiles=k,this.reload(),this}setUrl(k){return this.url=k,this._options.url=k,this.reload(),this}onRemove(k){this.cancelTileJSONRequest()}serialize(){return k.l({},this._options)}loadTile(F,Me){const Ae=F.tileID.canonical.url(this.tiles,this.scheme),Oe=this.map._requestManager.normalizeTileURL(Ae),Fe=this.map._requestManager.transformRequest(Oe,k.R.Tile),je=this.map.style?this.map.style.getLut(this.scope):null,qe=je?{image:je.image.clone()}:null,pt={request:Fe,data:void 0,uid:F.uid,tileID:F.tileID,tileZoom:F.tileZoom,zoom:F.tileID.overscaledZ,maxZoom:this.maxzoom,lut:qe,tileSize:this.tileSize*F.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:k.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:F.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:F.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&k.f(Ae)&&(pt.worldview=this.map.getWorldview()||this.worldviewDefault,pt.localizableLayerIds=this.localizableLayerIds),pt.request.collectResourceTiming=this._collectResourceTiming,F.actor&&"expired"!==F.state)"loading"===F.state?F.reloadCallback=Me:F.request=F.actor.send("reloadTile",pt,c.bind(this));else if(F.actor=this._tileWorkers[Oe]=this._tileWorkers[Oe]||this.dispatcher.getActor(),this.dispatcher.ready)F.request=F.actor.send("loadTile",pt,c.bind(this),void 0,!0);else{const Me=k.aD.call({deduped:this._deduped},pt,((k,Me)=>{k||!Me?c.call(this,k):(pt.data={cacheControl:Me.cacheControl,expires:Me.expires,rawData:Me.rawData.slice(0)},F.actor&&F.actor.send("loadTile",pt,c.bind(this),void 0,!0))}),!0);F.request={cancel:Me}}function c(Ae,Oe){return delete F.request,F.aborted?Me(null):Ae&&404!==Ae.status?Me(Ae):(Oe&&Oe.resourceTiming&&(F.resourceTiming=Oe.resourceTiming),this.map._refreshExpiredTiles&&Oe&&F.setExpiryData(Oe),F.loadVectorData(Oe,this.map.painter),k.aE(this.dispatcher),Me(null),void(F.reloadCallback&&(this.loadTile(F,F.reloadCallback),F.reloadCallback=null)))}}abortTile(k){k.request&&(k.request.cancel(),delete k.request),k.actor&&k.actor.send("abortTile",{uid:k.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(k,F){k.actor&&k.actor.send("removeTile",{uid:k.uid,type:this.type,source:this.id,scope:this.scope}),k.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class it extends k.E{constructor(F,Me,Ae,Oe){super(),this.id=F,this.dispatcher=Ae,this.setEventedParent(Oe),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=k.l({type:"raster"},Me),k.l(this,k.ay(Me,["url","scheme","tileSize"]))}load(F){this._loaded=!1,this.fire(new k.z("dataloading",{dataType:"source"})),this._tileJSONRequest=Qe(this._options,this.map._requestManager,null,null,((Me,Ae)=>{this._tileJSONRequest=null,this._loaded=!0,Me?this.fire(new k.y(Me)):Ae&&(k.l(this,Ae),Ae.raster_layers&&(this.rasterLayers=Ae.raster_layers,this.rasterLayerIds=this.rasterLayers.map((k=>k.id))),Ae.bounds&&(this.tileBounds=new et(Ae.bounds,this.minzoom,this.maxzoom)),Mi(Ae.tiles),this.fire(new k.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new k.z("data",{dataType:"source",sourceDataType:"content"}))),F&&F(Me)}))}loaded(){return this._loaded}onAdd(k){this.map=k,this.load()}reload(){this.cancelTileJSONRequest();const F=k.aC(this.id,this.scope);this.load((()=>this.map.style.clearSource(F)))}setTiles(k){return this._options.tiles=k,this.reload(),this}setUrl(k){return this.url=k,this._options.url=k,this.reload(),this}onRemove(k){this.cancelTileJSONRequest()}serialize(){return k.l({},this._options)}hasTile(k){return!this.tileBounds||this.tileBounds.contains(k.canonical)}loadTile(F,Me){const Ae=k.q.devicePixelRatio>=2,Oe=this.map._requestManager.normalizeTileURL(F.tileID.canonical.url(this.tiles,this.scheme),Ae,this.tileSize);F.request=k.o(this.map._requestManager.transformRequest(Oe,k.R.Tile),((Ae,Oe,Fe,je)=>(delete F.request,F.aborted?(F.state="unloaded",Me(null)):Ae?(F.state="errored",Me(Ae)):Oe?(this.map._refreshExpiredTiles&&F.setExpiryData({cacheControl:Fe,expires:je}),F.setTexture(Oe,this.map.painter),F.state="loaded",k.aE(this.dispatcher),void Me(null)):Me(null))))}abortTile(k,F){k.request&&(k.request.cancel(),delete k.request),F&&F()}unloadTile(F,Me){F.texture&&F.texture instanceof k.T?(F.destroy(!0),F.texture&&F.texture instanceof k.T&&this.map.painter.saveTileTexture(F.texture)):F.destroy(),Me&&Me()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ot extends it{constructor(F,Me,Ae,Oe){super(F,Me,Ae,Oe),this.type="raster-array",this.maxzoom=22,this._options=k.l({type:"raster-array"},Me)}triggerRepaint(k){const F=this.map.painter._terrain,Me=this.map.style.getSourceCache(this.id);F&&F.enabled&&Me&&F._clearRenderCacheForTile(Me.id,k.tileID),this.map.triggerRepaint()}loadTile(F,Me){const Ae=this.map._requestManager.normalizeTileURL(F.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),Oe=this.map._requestManager.transformRequest(Ae,k.R.Tile);F.requestParams=Oe,F.actor||(F.actor=this.dispatcher.getActor()),F.request=F.fetchHeader(void 0,((k,Ae,Oe,Fe)=>{if(delete F.request,F.aborted)return F.state="unloaded",Me(null);if(k){if(20===k.code)return;return F.state="errored",Me(k)}this.map._refreshExpiredTiles&&F.setExpiryData({cacheControl:Oe,expires:Fe}),F.state="empty",Me(null)}))}unloadTile(F,Me){const Ae=F.texture;Ae&&Ae instanceof k.T?(F.destroy(!0),this.map.painter.saveTileTexture(Ae)):(F.destroy(),F.flushQueues(),F._isHeaderLoaded=!1,delete F._mrt,delete F.textureDescriptor),F.fbo&&(F.fbo.destroy(),delete F.fbo),delete F.request,delete F.requestParams,delete F.neighboringTiles,F.state="unloaded"}prepareTile(F,Me,Ae){F._isHeaderLoaded&&("empty"!==F.state&&(F.state="reloading"),F.fetchBand(Me,Ae,((Me,Ae)=>{if(Me)return F.state="errored",this.fire(new k.y(Me)),void this.triggerRepaint(F);Ae&&(F.setTexture(Ae,this.map.painter),F.state="loaded",this.triggerRepaint(F))})))}getInitialBand(k){if(!this.rasterLayers)return 0;const F=this.rasterLayers.find((({id:F})=>F===k)),Me=F&&F.fields,Ae=Me&&Me.bands&&Me.bands;return Ae?Ae[0]:0}getTextureDescriptor(F,Me,Ae){if(!F)return;const Oe=Me.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!Oe)return;let Fe=null;Me instanceof k.aH?Fe=Me.paint.get("raster-array-band"):Me instanceof k.aI&&(Fe=Me.paint.get("raster-particle-array-band"));const je=Fe||this.getInitialBand(Oe);if(null!=je)if(F.textureDescriptor){if(!F.updateNeeded(Oe,je)||Ae)return Object.assign({},F.textureDescriptor,{texture:F.texture})}else this.prepareTile(F,Oe,je)}}const Kl={vector:tt,raster:it,"raster-dem":class extends it{constructor(F,Me,Ae,Oe){super(F,Me,Ae,Oe),this.type="raster-dem",this.maxzoom=22,this._options=k.l({type:"raster-dem"},Me),this.encoding=Me.encoding||"mapbox"}loadTile(F,Me){const Ae=this.map._requestManager.normalizeTileURL(F.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function s(k,Ae){k&&(F.state="errored",Me(k)),Ae&&(F.dem=Ae,F.dem.onDeserialize(),F.needsHillshadePrepare=!0,F.needsDEMTextureUpload=!0,F.state="loaded",Me(null))}F.request=k.o(this.map._requestManager.transformRequest(Ae,k.R.Tile),function(Ae,Oe,Fe,je){if(delete F.request,F.aborted)F.state="unloaded",Me(null);else if(Ae)F.state="errored",Me(Ae);else if(Oe){this.map._refreshExpiredTiles&&F.setExpiryData({cacheControl:Fe,expires:je});const Me=ImageBitmap&&Oe instanceof ImageBitmap&&k.t(),Ae=1-(Oe.width-k.aF(Oe.width))/2;Ae<1||F.neighboringTiles||(F.neighboringTiles=this._getNeighboringTiles(F.tileID));const qe=Me?Oe:k.q.getImageData(Oe,Ae),pt={uid:F.uid,coord:F.tileID,source:this.id,scope:this.scope,rawImageData:qe,encoding:this.encoding,padding:Ae};F.actor&&"expired"!==F.state||(F.actor=this.dispatcher.getActor(),F.actor.send("loadDEMTile",pt,s.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(F){const Me=F.canonical,Ae=Math.pow(2,Me.z),Oe=(Me.x-1+Ae)%Ae,Fe=0===Me.x?F.wrap-1:F.wrap,je=(Me.x+1+Ae)%Ae,qe=Me.x+1===Ae?F.wrap+1:F.wrap,pt={};return pt[new k.aG(F.overscaledZ,Fe,Me.z,Oe,Me.y).key]={backfilled:!1},pt[new k.aG(F.overscaledZ,qe,Me.z,je,Me.y).key]={backfilled:!1},Me.y>0&&(pt[new k.aG(F.overscaledZ,Fe,Me.z,Oe,Me.y-1).key]={backfilled:!1},pt[new k.aG(F.overscaledZ,F.wrap,Me.z,Me.x,Me.y-1).key]={backfilled:!1},pt[new k.aG(F.overscaledZ,qe,Me.z,je,Me.y-1).key]={backfilled:!1}),Me.y+1<Ae&&(pt[new k.aG(F.overscaledZ,Fe,Me.z,Oe,Me.y+1).key]={backfilled:!1},pt[new k.aG(F.overscaledZ,F.wrap,Me.z,Me.x,Me.y+1).key]={backfilled:!1},pt[new k.aG(F.overscaledZ,qe,Me.z,je,Me.y+1).key]={backfilled:!1}),pt}},"raster-array":ot,geojson:class extends k.E{constructor(F,Me,Ae,Oe){super(),this.id=F,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=Ae.getActor(),this.setEventedParent(Oe),this._data=Me.data,this._options=k.l({},Me),this._collectResourceTiming=Me.collectResourceTiming,void 0!==Me.maxzoom&&(this.maxzoom=Me.maxzoom),void 0!==Me.minzoom&&(this.minzoom=Me.minzoom),Me.type&&(this.type=Me.type),Me.attribution&&(this.attribution=Me.attribution),this.promoteId=Me.promoteId;const Fe=k.ag/this.tileSize;this.workerOptions=k.l({source:this.id,scope:this.scope,cluster:Me.cluster||!1,geojsonVtOptions:{buffer:(void 0!==Me.buffer?Me.buffer:128)*Fe,tolerance:(void 0!==Me.tolerance?Me.tolerance:.375)*Fe,extent:k.ag,maxZoom:this.maxzoom,lineMetrics:Me.lineMetrics||!1,generateId:Me.generateId||!1},superclusterOptions:{maxZoom:void 0!==Me.clusterMaxZoom?Me.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,Me.clusterMinPoints||2),extent:k.ag,radius:(void 0!==Me.clusterRadius?Me.clusterRadius:50)*Fe,log:!1,generateId:Me.generateId||!1},clusterProperties:Me.clusterProperties,filter:Me.filter,dynamic:Me.dynamic},Me.workerOptions)}onAdd(k){this.map=k,this.setData(this._data)}setData(k){return this._data=k,this._updateWorkerData(),this}updateData(F){if(!this._options.dynamic)return this.fire(new k.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof F&&("Feature"===F.type&&(F={type:"FeatureCollection",features:[F]}),"FeatureCollection"!==F.type))return this.fire(new k.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof F&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const k=new Map;for(const F of this._data.features)k.set(F.id,F);for(const Me of F.features)k.set(Me.id,Me);this._data.features=[...k.values()]}else this._data=F;return this._updateWorkerData(!0),this}getClusterExpansionZoom(k,F){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:k,source:this.id,scope:this.scope},F),this}getClusterChildren(k,F){return this.actor.send("geojson.getClusterChildren",{clusterId:k,source:this.id,scope:this.scope},F),this}getClusterLeaves(k,F,Me,Ae){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:k,limit:F,offset:Me},Ae),this}_updateWorkerData(F=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new k.z("dataloading",{dataType:"source"})),this._loaded=!1;const Me=k.l({append:F},this.workerOptions);Me.scope=this.scope;const Ae=this._data;"string"==typeof Ae?(Me.request=this.map._requestManager.transformRequest(k.q.resolveURL(Ae),k.R.Source),Me.request.collectResourceTiming=this._collectResourceTiming):Me.data=JSON.stringify(Ae),this._pendingLoad=this.actor.send(`${this.type}.loadData`,Me,((Me,Ae)=>{if(this._loaded=!0,this._pendingLoad=null,Me)this.fire(new k.y(Me));else{const Me={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&Ae&&Ae.resourceTiming&&Ae.resourceTiming[this.id]&&(Me.resourceTiming=Ae.resourceTiming[this.id]),F&&(this._partialReload=!0),this.fire(new k.z("data",Me)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(F),this._coalesce=!1)}))}loaded(){return this._loaded}loadTile(F,Me){const Ae=F.actor?"reloadTile":"loadTile";F.actor=this.actor;const Oe=this.map.style?this.map.style.getLut(this.scope):null,Fe=Oe?{image:Oe.image.clone()}:null,je=this._partialReload,qe={type:this.type,uid:F.uid,tileID:F.tileID,tileZoom:F.tileZoom,zoom:F.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:Fe,scope:this.scope,pixelRatio:k.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:je};F.request=this.actor.send(Ae,qe,((k,Oe)=>je&&!Oe?(F.state="loaded",Me(null)):(delete F.request,F.destroy(),F.aborted?Me(null):k?Me(k):(F.loadVectorData(Oe,this.map.painter,"reloadTile"===Ae),Me(null)))),void 0,"loadTile"===Ae)}abortTile(k){k.request&&(k.request.cancel(),delete k.request),k.aborted=!0}unloadTile(k,F){this.actor.send("removeTile",{uid:k.uid,type:this.type,source:this.id,scope:this.scope}),k.destroy()}onRemove(k){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return k.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends k.aJ{constructor(k,F,Me,Ae){super(k,F,Me,Ae),this.roundZoom=!0,this.type="video",this.options=F}load(){this._loaded=!1;const F=this.options;this.urls=[];for(const Me of F.urls)this.urls.push(this.map._requestManager.transformRequest(Me,k.R.Source).url);k.aK(this.urls,((F,Me)=>{this._loaded=!0,F?this.fire(new k.y(F)):Me&&(this.video=Me,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(F){if(this.video){const Me=this.video.seekable;F<Me.start(0)||F>Me.end(0)?this.fire(new k.y(new k.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${Me.start(0)} and ${Me.end(0)}-second mark.`))):this.video.currentTime=F}}getVideo(){return this.video}onAdd(k){this.map||(this.map=k,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const F=this.map.painter.context,Me=F.gl;this.texture?this.video.paused||(this.texture.bind(Me.LINEAR,Me.CLAMP_TO_EDGE),Me.texSubImage2D(Me.TEXTURE_2D,0,0,0,Me.RGBA,Me.UNSIGNED_BYTE,this.video)):(this.texture=new k.T(F,this.video,Me.RGBA8),this.texture.bind(Me.LINEAR,Me.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(F)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:k.aJ,model:class extends k.E{constructor(k,F,Me,Ae){super(),this.id=k,this.type="model",this.models=[],this._loaded=!1,this._options=F}load(){const F=[];for(const Me in this._options.models){const Ae=this._options.models[Me],Oe=k.aM(this.map._requestManager.transformRequest(Ae.uri,k.R.Model).url).then((F=>{if(!F)return;const Oe=k.aN(F),Fe=new k.aO(Me,Ae.position,Ae.orientation,Oe);Fe.computeBoundsAndApplyParent(),this.models.push(Fe)})).catch((F=>{this.fire(new k.y(new Error(`Could not load model ${Me} from ${Ae.uri}: ${F.message}`)))}));F.push(Oe)}return Promise.allSettled(F).then((()=>{this._loaded=!0,this.fire(new k.z("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((F=>{this.fire(new k.y(new Error(`Could not load models: ${F.message}`)))}))}onAdd(k){this.map=k,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(k,F){}serialize(){return{type:"model"}}},"batched-model":class extends k.E{constructor(k,F,Me,Ae){super(),this.type="batched-model",this.id=k,this.tileSize=512,this._options=F,this.tiles=this._options.tiles,this.maxzoom=F.maxzoom||19,this.minzoom=F.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=Me,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(Ae)}onAdd(k){this.map=k,this.load()}load(F){this._loaded=!1,this.fire(new k.z("dataloading",{dataType:"source"}));const Me=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Ae=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Me,Ae,((Oe,Fe)=>{this._tileJSONRequest=null,this._loaded=!0,Oe?(Me&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Me}`),Ae&&2!==Ae.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Ae}`),this.fire(new k.y(Oe))):Fe&&(k.l(this,Fe),Fe.bounds&&(this.tileBounds=new et(Fe.bounds,this.minzoom,this.maxzoom)),Mi(Fe.tiles,this.map._requestManager._customAccessToken),this.fire(new k.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new k.z("data",{dataType:"source",sourceDataType:"content"}))),F&&F(Oe)}))}hasTransition(){return!1}hasTile(k){return!this.tileBounds||this.tileBounds.contains(k.canonical)}loaded(){return this._loaded}loadTile(F,Me){const Ae=this.map._requestManager.normalizeTileURL(F.tileID.canonical.url(this.tiles,this.scheme)),Oe={request:this.map._requestManager.transformRequest(Ae,k.R.Tile),data:void 0,uid:F.uid,tileID:F.tileID,tileZoom:F.tileZoom,zoom:F.tileID.overscaledZ,tileSize:this.tileSize*F.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:F.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,lut:null,maxZoom:null,promoteId:null,pixelRatio:null,scaleFactor:null};if(F.actor&&"expired"!==F.state)if("loading"===F.state)F.reloadCallback=Me;else{if(F.buckets){const k=Object.values(F.buckets);for(const F of k)F.dirty=!0;return void(F.state="loaded")}F.request=F.actor.send("reloadTile",Oe,r.bind(this))}else F.actor=this.dispatcher.getActor(),F.request=F.actor.send("loadTile",Oe,r.bind(this),void 0,!0);function r(k,Ae){return F.aborted?Me(null):k&&404!==k.status?Me(k):(this.map._refreshExpiredTiles&&Ae&&F.setExpiryData(Ae),F.loadModelData(Ae,this.map.painter),F.state="loaded",void Me(null))}}serialize(){return k.l({},this._options)}},canvas:class extends k.aJ{constructor(F,Me,Ae,Oe){super(F,Me,Ae,Oe),Me.coordinates?Array.isArray(Me.coordinates)&&4===Me.coordinates.length&&!Me.coordinates.some((k=>!Array.isArray(k)||2!==k.length||k.some((k=>"number"!=typeof k))))||this.fire(new k.y(new k.V(`sources.${F}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new k.y(new k.V(`sources.${F}`,null,'missing required property "coordinates"'))),Me.animate&&"boolean"!=typeof Me.animate&&this.fire(new k.y(new k.V(`sources.${F}`,null,'optional "animate" property must be a boolean value'))),Me.canvas?"string"==typeof Me.canvas||Me.canvas instanceof HTMLCanvasElement||this.fire(new k.y(new k.V(`sources.${F}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new k.y(new k.V(`sources.${F}`,null,'missing required property "canvas"'))),this.options=Me,this.animate=void 0===Me.animate||Me.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new k.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(k){this.map=k,this.load(),this.canvas&&this.animate&&this.play()}onRemove(k){this.pause()}prepare(){let F=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,F=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,F=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const Me=this.map.painter.context;this.texture?!F&&!this._playing||this.texture instanceof k.aL||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new k.T(Me,this.canvas,Me.gl.RGBA8,{premultiply:!0}),this._prepareData(Me)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const k of[this.canvas.width,this.canvas.height])if(isNaN(k)||k<=0)return!0;return!1}},custom:class extends k.E{constructor(F,Me,Ae,Oe){super(),this.id=F,this.type="custom",this._dataType="raster",this._dispatcher=Ae,this._implementation=Me,this.setEventedParent(Oe),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new k.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new k.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new et(this._implementation.bounds,this.minzoom,this.maxzoom)),Me.update=this._update.bind(this),Me.clearTiles=this._clearTiles.bind(this),Me.coveringTiles=this._coveringTiles.bind(this),k.l(this,k.ay(Me,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return k.ay(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new k.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new k.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(F){this.map=F,this._loaded=!1,this.fire(new k.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(F),this.load()}onRemove(k){this._implementation.onRemove&&this._implementation.onRemove(k)}hasTile(k){if(this._implementation.hasTile){const{x:F,y:Me,z:Ae}=k.canonical;return this._implementation.hasTile({x:F,y:Me,z:Ae})}return!this.tileBounds||this.tileBounds.contains(k.canonical)}loadTile(k,F){const{x:Me,y:Ae,z:Oe}=k.tileID.canonical,Fe=new AbortController;k.request=Promise.resolve(this._implementation.loadTile({x:Me,y:Ae,z:Oe},{signal:Fe.signal})).then(function(Me){return delete k.request,k.aborted?(k.state="unloaded",F(null)):void 0===Me?(k.state="errored",F(null)):null===Me?(this.loadTileData(k,{width:this.tileSize,height:this.tileSize,data:null}),k.state="loaded",F(null)):function(k){return k instanceof ImageData||k instanceof HTMLCanvasElement||k instanceof ImageBitmap||k instanceof HTMLImageElement}(Me)?(this.loadTileData(k,Me),k.state="loaded",void F(null)):(k.state="errored",F(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((Me=>{20!==Me.code&&(k.state="errored",F(Me))})),k.request.cancel=()=>Fe.abort()}loadTileData(k,F){k.setTexture(F,this.map.painter)}unloadTile(F,Me){if(F.texture&&F.texture instanceof k.T?(F.destroy(!0),F.texture&&F.texture instanceof k.T&&this.map.painter.saveTileTexture(F.texture)):F.destroy(),this._implementation.unloadTile){const{x:k,y:Me,z:Ae}=F.tileID.canonical;this._implementation.unloadTile({x:k,y:Me,z:Ae})}Me&&Me()}abortTile(k,F){k.request&&k.request.cancel&&(k.request.cancel(),delete k.request),F&&F()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((k=>({x:k.canonical.x,y:k.canonical.y,z:k.canonical.z})))}_clearTiles(){const F=k.aC(this.id,this.scope);this.map.style.clearSource(F)}_update(){this.fire(new k.z("data",{dataType:"source",sourceDataType:"content"}))}}},rt=function(F,Me,Ae,Oe){const Fe=new Kl[Me.type](F,Me,Ae,Oe);if(Fe.id!==F)throw new Error(`Expected Source id to be ${F} instead of ${Fe.id}`);return k.aP(["load","abort","unload","serialize","prepare"],Fe),Fe};function at(k,F,Me,Ae,Oe=!1){const Fe=F.sourceCache.transform,je=F.sourceCache.tilesIn(k,F.has3DLayers,Oe);je.sort(ct);const qe=[];for(const k of je){const je=k.tile.queryRenderedFeatures(F,k,Me,Ae,Fe,Oe);Object.keys(je).length&&qe.push({wrappedTileID:k.tile.tileID.wrapped().key,queryResults:je})}return 0===qe.length?{}:function(k){const F={},Me={};for(const Ae of k){const k=Ae.queryResults,Oe=Ae.wrappedTileID,Fe=Me[Oe]=Me[Oe]||{};for(const Me in k){const Ae=k[Me],Oe=Fe[Me]=Fe[Me]||{},je=F[Me]=F[Me]||[];for(const k of Ae)Oe[k.featureIndex]||(Oe[k.featureIndex]=!0,je.push(k))}}return F}(qe)}function nt(k,F,Me,Ae,Oe){const Fe={},je=Ae.queryRenderedSymbols(k),qe=[];for(const k of Object.keys(je).map(Number))qe.push(Oe[k]);qe.sort(ct);for(const k of qe){const Ae=k.featureIndex.lookupSymbolFeatures(je[k.bucketInstanceId],k.bucketIndex,k.sourceLayerIndex,F,Me);for(const F in Ae){const Me=Fe[F]=Fe[F]||[],Oe=Ae[F];Oe.sort(((F,Me)=>{const Ae=k.featureSortOrder;if(Ae){const k=Ae.indexOf(F.featureIndex);return Ae.indexOf(Me.featureIndex)-k}return Me.featureIndex-F.featureIndex}));for(const k of Oe)Me.push(k)}}return Fe}function lt(k,F){const Me=k.getRenderableIds().map((F=>k.getTileByID(F))),Ae=[],Oe={};for(let k=0;k<Me.length;k++){const Fe=Me[k],je=Fe.tileID.canonical.key;Oe[je]||(Oe[je]=!0,Fe.querySourceFeatures(Ae,F))}return Ae}function ct(k,F){const Me=k.tileID,Ae=F.tileID;return Me.overscaledZ-Ae.overscaledZ||Me.canonical.y-Ae.canonical.y||Me.wrap-Ae.wrap||Me.canonical.x-Ae.canonical.x}function ht(k,F){const Me={};if(!F)return Me;for(const Ae of k){const k=Ae.layerIds.map((k=>F.getLayer(k))).filter(Boolean);if(0!==k.length){Ae.layers=k,Ae.stateDependentLayerIds&&(Ae.stateDependentLayers=Ae.stateDependentLayerIds.map((F=>k.filter((k=>k.id===F))[0])));for(const F of k)Me[F.fqid]=Ae}}return Me}const Jl=32,Ql=33,ec=new Uint16Array(8184);for(let k=0;k<2046;k++){let F=k+2,Me=0,Ae=0,Oe=0,Fe=0,je=0,qe=0;for(1&F?Oe=Fe=je=Jl:Me=Ae=qe=Jl;(F>>=1)>1;){const k=Me+Oe>>1,pt=Ae+Fe>>1;1&F?(Oe=Me,Fe=Ae,Me=je,Ae=qe):(Me=Oe,Ae=Fe,Oe=je,Fe=qe),je=k,qe=pt}const pt=4*k;ec[pt+0]=Me,ec[pt+1]=Ae,ec[pt+2]=Oe,ec[pt+3]=Fe}const tc=new Uint16Array(2178),cc=new Uint8Array(1089),uc=new Uint16Array(1089);function gt(k){return 0===k?-.03125:32===k?.03125:0}const jc=(()=>({type:2,extent:k.ag,loadGeometry:()=>[[new k.P(0,0),new k.P(k.ag+1,0),new k.P(k.ag+1,k.ag+1),new k.P(0,k.ag+1),new k.P(0,0)]]}))();class yt{constructor(F,Me,Ae,Oe,Fe){this.tileID=F,this.uid=k.aV(),this.uses=0,this.tileSize=Me,this.tileZoom=Ae,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=Fe,Oe&&Oe.style&&(this._lastUpdatedBrightness=Oe.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",Oe&&Oe.transform&&(this.projection=Oe.transform.projection)}registerFadeDuration(F){const Me=F+this.timeAdded;Me<k.q.now()||this.fadeEndTime&&Me<this.fadeEndTime||(this.fadeEndTime=Me)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=k.aQ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(F,Me,Ae){if(this.unloadVectorData(),this.state="loaded",F){F.featureIndex&&(this.latestFeatureIndex=F.featureIndex,F.rawTileData?(this.latestRawTileData=F.rawTileData,this.latestFeatureIndex.rawTileData=F.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=F.collisionBoxArray,this.buckets=ht(F.buckets,Me.style),this.hasSymbolBuckets=!1;for(const F in this.buckets){const Me=this.buckets[F];if(Me instanceof k.aX){if(this.hasSymbolBuckets=!0,!Ae)break;Me.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const F in this.buckets){const Me=this.buckets[F];if(Me instanceof k.aX&&Me.hasRTLText){this.hasRTLText=!0,k.aY();break}}this.queryPadding=0;for(const k in this.buckets){const F=this.buckets[k],Ae=Me.style.getOwnLayer(k);if(!Ae)continue;const Oe=Ae.queryRadius(F);this.queryPadding=Math.max(this.queryPadding,Oe)}F.imageAtlas&&(this.imageAtlas=F.imageAtlas),F.glyphAtlasImage&&(this.glyphAtlasImage=F.glyphAtlasImage),F.lineAtlas&&(this.lineAtlas=F.lineAtlas),this._lastUpdatedBrightness=F.brightness}else this.collisionBoxArray=new k.aW}unloadVectorData(){if(this.hasData()){for(const k in this.buckets)this.buckets[k].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(k,F,Me){k&&(k.resourceTiming&&(this.resourceTiming=k.resourceTiming),this.buckets={...this.buckets,...ht(k.buckets,F.style)},k.featureIndex&&(this.latestFeatureIndex=k.featureIndex))}getBucket(k){return this.buckets[k.fqid]}upload(F){for(const k in this.buckets){const Me=this.buckets[k];Me.uploadPending()&&Me.upload(F)}const Me=F.gl,Ae=this.imageAtlas;if(Ae&&!Ae.uploaded){const Oe=!!Object.keys(Ae.patternPositions).length;this.imageAtlasTexture=new k.T(F,Ae.image,Me.RGBA8,{useMipmap:Oe}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new k.T(F,this.glyphAtlasImage,Me.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new k.T(F,this.lineAtlas.image,Me.R8),this.lineAtlas.uploaded=!0)}prepare(k,F,Me){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(k,this.imageAtlasTexture,Me),!F||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const Ae=F.style.getBrightness();(this._lastUpdatedBrightness||Ae)&&(this._lastUpdatedBrightness&&Ae&&Math.abs(this._lastUpdatedBrightness-Ae)<.001||(this.updateBuckets(F,this._lastUpdatedBrightness!==Ae),this._lastUpdatedBrightness=Ae))}queryRenderedFeatures(F,Me,Ae,Oe,Fe,je){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const qe=function(F,Me){const Ae=k.ab.mat4.fromScaling([],[.5*F.width,.5*-F.height,1]);return k.ab.mat4.translate(Ae,Ae,[1,-1,0]),k.ab.mat4.multiply(Ae,Ae,F.calculateProjMatrix(Me.toUnwrapped())),Float32Array.from(Ae)}(Fe,this.tileID);return this.latestFeatureIndex.query(F,{tilespaceGeometry:Me,pixelPosMatrix:qe,transform:Oe,availableImages:Ae,tileTransform:this.tileTransform})}querySourceFeatures(F,Me){const Ae=this.latestFeatureIndex;if(!Ae||!Ae.rawTileData)return;const Oe=Ae.loadVTLayers(),Fe=Me?Me.sourceLayer:"",je=Oe._geojsonTileLayer||Oe[Fe];if(!je)return;const qe=k.aZ(Me&&Me.filter),{z:pt,x:vt,y:Ut}=this.tileID.canonical,xi={z:pt,x:vt,y:Ut};for(let Me=0;Me<je.length;Me++){const Oe=je.feature(Me);if(qe.needGeometry){const F=k.a_(Oe,!0);if(!qe.filter(new k.a8(this.tileID.overscaledZ),F,this.tileID.canonical))continue}else if(!qe.filter(new k.a8(this.tileID.overscaledZ),Oe))continue;const vi=Ae.getId(Oe,Fe),bi=new k.a$(Oe,pt,vt,Ut,vi);bi.tile=xi,F.push(bi)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(F){const Me=this.expirationTime;if(F.cacheControl){const Me=k.b0(F.cacheControl);Me["max-age"]&&(this.expirationTime=Date.now()+1e3*Me["max-age"])}else F.expires&&(this.expirationTime=new Date(F.expires).getTime());if(this.expirationTime){const k=Date.now();let F=!1;if(this.expirationTime>k)F=!1;else if(Me)if(this.expirationTime<Me)F=!0;else{const Ae=this.expirationTime-Me;Ae?this.expirationTime=k+Math.max(Ae,3e4):F=!0}else F=!0;F?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(k){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&k&&this.updateBuckets(k)}updateBuckets(F,Me){if(!this.latestFeatureIndex)return;if(!F.style)return;const Ae=this.latestFeatureIndex.loadVTLayers(),Oe=F.style.listImages(),Fe=F.style.getBrightness();for(const je in this.buckets){if(!F.style.hasLayer(je))continue;const qe=this.buckets[je],pt=qe.layers[0],vt=pt.sourceLayer||"_geojsonTileLayer",Ut=Ae[vt],xi=F.style.getLayerSourceCache(pt);let vi={};xi&&(vi=xi._state.getState(vt,void 0));const bi=this.imageAtlas&&this.imageAtlas.patternPositions||{},wi=Object.keys(vi).length>0&&!Me;wi&&!qe.stateDependentLayers.length&&!Me||qe.update(vi,Ut,Oe,bi,wi?qe.stateDependentLayers:qe.layers,Me,Fe),(qe instanceof k.b1||qe instanceof k.b2)&&F._terrain&&F._terrain.enabled&&xi&&qe.programConfigurations.needsUpload&&F._terrain._clearRenderCacheForTile(xi.id,this.tileID);const Mi=F&&F.style&&F.style.getOwnLayer(je);Mi&&(this.queryPadding=Math.max(this.queryPadding,Mi.queryRadius(qe)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<k.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(F){this.symbolFadeHoldUntil=k.q.now()+F}setTexture(F,Me){const Ae=Me.context,Oe=Ae.gl;this.texture=this.texture||Me.getTileTexture(F.width),this.texture&&this.texture instanceof k.T?this.texture.update(F):(this.texture=new k.T(Ae,F,Oe.RGBA8,{useMipmap:!0}),this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE))}setDependencies(k,F){const Me={};for(const k of F)Me[k]=!0;this.dependencies[k]=Me}hasDependency(k,F){for(const Me of k){const k=this.dependencies[Me];if(k)for(const Me of F)if(k[Me])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(F,Me){if(!Me||"mercator"===Me.name||this._tileDebugBuffer)return;const Ae=k.b3(jc,this.tileID.canonical,this.tileTransform)[0],Oe=new k.b4,Fe=new k.b5;for(let k=0;k<Ae.length;k++){const{x:F,y:Me}=Ae[k];Oe.emplaceBack(F,Me),Fe.emplaceBack(k)}Fe.emplaceBack(0),this._tileDebugIndexBuffer=F.createIndexBuffer(Fe),this._tileDebugBuffer=F.createVertexBuffer(Oe,k.b6.members),this._tileDebugSegments=k.b7.simpleSegment(0,0,Oe.length,Fe.length)}_makeTileBoundsBuffers(F,Me){if(this._tileBoundsBuffer||!Me||"mercator"===Me.name)return;const Ae=k.b3(jc,this.tileID.canonical,this.tileTransform)[0];let Oe,Fe;if(this.isRaster){const F=function(F,Me){const Ae=k.aQ(F,Me),Oe=Math.pow(2,F.z);for(let Fe=0;Fe<Ql;Fe++)for(let je=0;je<Ql;je++){const qe=k.aR((F.x+(je+gt(je))/Jl)/Oe),pt=k.aS((F.y+(Fe+gt(Fe))/Jl)/Oe),vt=Me.project(qe,pt),Ut=Fe*Ql+je;tc[2*Ut+0]=Math.round((vt.x*Ae.scale-Ae.x)*k.ag),tc[2*Ut+1]=Math.round((vt.y*Ae.scale-Ae.y)*k.ag)}cc.fill(0),uc.fill(0);for(let k=2045;k>=0;k--){const F=4*k,Me=ec[F+0],Ae=ec[F+1],Oe=ec[F+2],Fe=ec[F+3],je=Me+Oe>>1,qe=Ae+Fe>>1,pt=je+qe-Ae,vt=qe+Me-je,Ut=Ae*Ql+Me,xi=Fe*Ql+Oe,vi=qe*Ql+je,bi=Math.hypot((tc[2*Ut+0]+tc[2*xi+0])/2-tc[2*vi+0],(tc[2*Ut+1]+tc[2*xi+1])/2-tc[2*vi+1])>=16;cc[vi]=cc[vi]||(bi?1:0),k<1022&&(cc[vi]=cc[vi]||cc[(Ae+vt>>1)*Ql+(Me+pt>>1)]||cc[(Fe+vt>>1)*Ql+(Oe+pt>>1)])}const Fe=new k.aT,je=new k.aU;let qe=0;function l(F,Me){const Ae=Me*Ql+F;return 0===uc[Ae]&&(Fe.emplaceBack(tc[2*Ae+0],tc[2*Ae+1],F*k.ag/Jl,Me*k.ag/Jl),uc[Ae]=++qe),uc[Ae]-1}function c(k,F,Me,Ae,Oe,Fe){const qe=k+Me>>1,pt=F+Ae>>1;if(Math.abs(k-Oe)+Math.abs(F-Fe)>1&&cc[pt*Ql+qe])c(Oe,Fe,k,F,qe,pt),c(Me,Ae,Oe,Fe,qe,pt);else{const qe=l(k,F),pt=l(Me,Ae),vt=l(Oe,Fe);je.emplaceBack(qe,pt,vt)}}return c(0,0,Jl,Jl,Jl,0),c(Jl,Jl,0,0,0,Jl),{vertices:Fe,indices:je}}(this.tileID.canonical,Me);Oe=F.vertices,Fe=F.indices}else{Oe=new k.aT,Fe=new k.aU;for(const{x:k,y:F}of Ae)Oe.emplaceBack(k,F,0,0);const F=k.b8(Oe.int16,void 0,4);for(let k=0;k<F.length;k+=3)Fe.emplaceBack(F[k],F[k+1],F[k+2])}this._tileBoundsBuffer=F.createVertexBuffer(Oe,k.b9.members),this._tileBoundsIndexBuffer=F.createIndexBuffer(Fe),this._tileBoundsSegments=k.b7.simpleSegment(0,0,Oe.length,Fe.length)}_makeGlobeTileDebugBuffers(F,Me){const Ae=Me.projection;if(!Ae||"globe"!==Ae.name||Me.freezeTileCoverage)return;const Oe=this.tileID.canonical,Fe=k.ba(Oe,Me),je=k.bb(Fe),qe=k.ae(Me.zoom);let pt;qe>0&&(pt=k.ab.mat4.invert(new Float64Array(16),Me.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(F,Oe,Me,je,pt,qe),this._makeGlobeTileDebugTextBuffer(F,Oe,Me,je,pt,qe)}_globePoint(F,Me,Ae,Oe,Fe,je,qe){let pt=k.bc(F,Me,Ae);if(je){const Fe=1<<Ae.z,vt=k.at(Oe.center.lng),Ut=k.aA(Oe.center.lat),xi=(Ae.x+.5)/Fe-vt;let vi=0;xi>.5?vi=-1:xi<-.5&&(vi=1);let bi=(F/k.ag+Ae.x)/Fe+vi,wi=(Me/k.ag+Ae.y)/Fe;bi=(bi-vt)*Oe._pixelsPerMercatorPixel+vt,wi=(wi-Ut)*Oe._pixelsPerMercatorPixel+Ut;const Mi=[bi*Oe.worldSize,wi*Oe.worldSize,0];k.ab.vec3.transformMat4(Mi,Mi,je),pt=k.bd(pt,Mi,qe)}return k.ab.vec3.transformMat4(pt,pt,Fe)}_makeGlobeTileDebugBorderBuffer(F,Me,Ae,Oe,Fe,je){const qe=new k.b4,pt=new k.b5,vt=new k.be,h=(k,F,Ut,xi,vi)=>{const bi=(Ut-k)/(vi-1),wi=(xi-F)/(vi-1),Mi=qe.length;for(let Ut=0;Ut<vi;Ut++){const xi=k+Ut*bi,vi=F+Ut*wi;qe.emplaceBack(xi,vi);const pr=this._globePoint(xi,vi,Me,Ae,Oe,Fe,je);vt.emplaceBack(pr[0],pr[1],pr[2]),pt.emplaceBack(Mi+Ut)}},Ut=k.ag;h(0,0,Ut,0,16),h(Ut,0,Ut,Ut,16),h(Ut,Ut,0,Ut,16),h(0,Ut,0,0,16),this._tileDebugIndexBuffer=F.createIndexBuffer(pt),this._tileDebugBuffer=F.createVertexBuffer(qe,k.b6.members),this._globeTileDebugBorderBuffer=F.createVertexBuffer(vt,k.bf.members),this._tileDebugSegments=k.b7.simpleSegment(0,0,qe.length,pt.length)}_makeGlobeTileDebugTextBuffer(F,Me,Ae,Oe,Fe,je){const qe=k.ag/4,pt=new k.b4,vt=new k.aU,Ut=new k.be,xi=25;vt.reserve(32),pt.reserve(xi),Ut.reserve(xi);const d=(k,F)=>xi*k+F;for(let k=0;k<xi;k++){const F=k*qe;for(let k=0;k<xi;k++){const vt=k*qe;pt.emplaceBack(vt,F);const xi=this._globePoint(vt,F,Me,Ae,Oe,Fe,je);Ut.emplaceBack(xi[0],xi[1],xi[2])}}for(let k=0;k<4;k++)for(let F=0;F<4;F++){const Me=d(k,F),Ae=d(k,F+1),Oe=d(k+1,F),Fe=d(k+1,F+1);vt.emplaceBack(Me,Ae,Oe),vt.emplaceBack(Oe,Ae,Fe)}this._tileDebugTextIndexBuffer=F.createIndexBuffer(vt),this._tileDebugTextBuffer=F.createVertexBuffer(pt,k.b6.members),this._globeTileDebugTextBuffer=F.createVertexBuffer(Ut,k.bf.members),this._tileDebugTextSegments=k.b7.simpleSegment(0,0,xi,32)}destroy(F=!1){for(const k in this.buckets)this.buckets[k].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!F&&this.texture&&this.texture instanceof k.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}k.bg.setPbf(k.bh);class xt extends yt{constructor(k,F,Me,Ae,Oe){super(k,F,Me,Ae,Oe),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(F,Me){const Ae=Me.context,Oe=Ae.gl;this.texture=this.texture||Me.getTileTexture(F.width),this.texture&&this.texture instanceof k.T?this.texture.update(F,{premultiply:!1}):this.texture=new k.T(Ae,F,Oe.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(F=16384,Me){const Ae=this._mrt=new k.bg(30),Oe=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(F-1)}});return this.entireBuffer=null,this.request=k.bi(Oe,((k,Oe,Fe,je)=>{if(k)Me(k);else try{const k=Ae.getHeaderLength(Oe);if(k>F)return void(this.request=this.fetchHeader(k,Me));Ae.parseHeader(Oe),this._isHeaderLoaded=!0;let qe=0;for(const k of Object.values(Ae.layers))qe=Math.max(qe,k.dataIndex[k.dataIndex.length-1].last_byte);Oe.byteLength>=qe&&(this.entireBuffer=Oe),Me(null,this.entireBuffer||Oe,Fe,je)}catch(k){Me(k)}})),this.request}fetchBand(F,Me,Ae){const Oe=this._mrt;if(!this._isHeaderLoaded||!Oe)return void Ae(new Error("Tile header is not ready"));const Fe=this.actor;if(!Fe)return void Ae(new Error("Can't fetch tile band without an actor"));let je;const n=(k,Oe)=>{je.complete(k,Oe),k?Ae(k):(this.updateTextureDescriptor(F,Me),Ae(null,this.textureDescriptor&&this.textureDescriptor.img))},l=(k,F)=>{if(k)return Ae(k);const Me=Fe.send("decodeRasterArray",{buffer:F,task:je},n,void 0,!0);this._workQueue.push((()=>{Me&&Me.cancel(),je.cancel()}))},qe=Oe.getLayer(F);if(!qe)return void Ae(new Error(`Unknown sourceLayer "${F}"`));if(qe.hasDataForBand(Me))return this.updateTextureDescriptor(F,Me),void Ae(null,this.textureDescriptor?this.textureDescriptor.img:null);const pt=qe.getDataRange([Me]);if(je=Oe.createDecodingTask(pt),!je||je.tasks.length)if(this.flushQueues(),this.entireBuffer)l(null,this.entireBuffer.slice(pt.firstByte,pt.lastByte+1));else{const F=Object.assign({},this.requestParams,{headers:{Range:`bytes=${pt.firstByte}-${pt.lastByte}`}}),Me=k.bi(F,l);this._fetchQueue.push((()=>{Me.cancel(),je.cancel()}))}else Ae(null)}updateNeeded(k,F){return(!this.textureDescriptor||this.textureDescriptor.band!==F||this.textureDescriptor.layer!==k)&&"errored"!==this.state}updateTextureDescriptor(F,Me){if(!this._mrt)return;const Ae=this._mrt.getLayer(F);if(!Ae||!Ae.hasBand(Me)||!Ae.hasDataForBand(Me))return;const{bytes:Oe,tileSize:Fe,buffer:je,offset:qe,scale:pt}=Ae.getBandView(Me),vt=Fe+2*je,Ut={data:Oe,width:vt,height:vt},xi=this.texture;xi&&xi instanceof k.T&&xi.update(Ut,{premultiply:!1}),this.textureDescriptor={layer:F,band:Me,img:Ut,buffer:je,offset:qe,tileSize:Fe,format:Ae.pixelFormat,mix:[pt,256*pt,65536*pt,16777216*pt]}}}class bt{constructor(k,F){this.max=k,this.onRemove=F,this.reset()}reset(){for(const k in this.data)for(const F of this.data[k])F.timeout&&clearTimeout(F.timeout),this.onRemove(F.value);return this.data={},this.order=[],this}add(k,F,Me){const Ae=k.wrapped().key;void 0===this.data[Ae]&&(this.data[Ae]=[]);const Oe={value:F,timeout:void 0};if(void 0!==Me&&(Oe.timeout=setTimeout((()=>{this.remove(k,Oe)}),Me)),this.data[Ae].push(Oe),this.order.push(Ae),this.order.length>this.max){const k=this._getAndRemoveByKey(this.order[0]);k&&this.onRemove(k)}return this}has(k){return k.wrapped().key in this.data}getAndRemove(k){return this.has(k)?this._getAndRemoveByKey(k.wrapped().key):null}_getAndRemoveByKey(k){const F=this.data[k].shift();return F.timeout&&clearTimeout(F.timeout),0===this.data[k].length&&delete this.data[k],this.order.splice(this.order.indexOf(k),1),F.value}getByKey(k){const F=this.data[k];return F?F[0].value:null}get(k){return this.has(k)?this.data[k.wrapped().key][0].value:null}remove(k,F){if(!this.has(k))return this;const Me=k.wrapped().key,Ae=void 0===F?0:this.data[Me].indexOf(F),Oe=this.data[Me][Ae];return this.data[Me].splice(Ae,1),Oe.timeout&&clearTimeout(Oe.timeout),0===this.data[Me].length&&delete this.data[Me],this.onRemove(Oe.value),this.order.splice(this.order.indexOf(Me),1),this}setMaxSize(k){for(this.max=k;this.order.length>this.max;){const k=this._getAndRemoveByKey(this.order[0]);k&&this.onRemove(k)}return this}filter(k){const F=[];for(const Me in this.data)for(const Ae of this.data[Me])k(Ae.value)||F.push(Ae);for(const k of F)this.remove(k.value.tileID,k)}}class wt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(F,Me,Ae){const Oe=String(Me);if(this.stateChanges[F]=this.stateChanges[F]||{},this.stateChanges[F][Oe]=this.stateChanges[F][Oe]||{},k.l(this.stateChanges[F][Oe],Ae),null===this.deletedStates[F]){this.deletedStates[F]={};for(const k in this.state[F])k!==Oe&&(this.deletedStates[F][k]=null)}else if(this.deletedStates[F]&&null===this.deletedStates[F][Oe]){this.deletedStates[F][Oe]={};for(const k in this.state[F][Oe])Ae[k]||(this.deletedStates[F][Oe][k]=null)}else for(const k in Ae)this.deletedStates[F]&&this.deletedStates[F][Oe]&&null===this.deletedStates[F][Oe][k]&&delete this.deletedStates[F][Oe][k]}removeFeatureState(k,F,Me){if(null===this.deletedStates[k])return;const Ae=String(F);if(this.deletedStates[k]=this.deletedStates[k]||{},Me&&void 0!==F)null!==this.deletedStates[k][Ae]&&(this.deletedStates[k][Ae]=this.deletedStates[k][Ae]||{},this.deletedStates[k][Ae][Me]=null);else if(void 0!==F)if(this.stateChanges[k]&&this.stateChanges[k][Ae])for(Me in this.deletedStates[k][Ae]={},this.stateChanges[k][Ae])this.deletedStates[k][Ae][Me]=null;else this.deletedStates[k][Ae]=null;else this.deletedStates[k]=null}getState(F,Me){const Ae=this.state[F]||{},Oe=this.stateChanges[F]||{},Fe=this.deletedStates[F];if(null===Fe)return{};if(void 0!==Me){const F=String(Me),je=k.l({},Ae[F],Oe[F]);if(Fe){const k=Fe[Me];if(null===k)return{};for(const F in k)delete je[F]}return je}const je=k.l({},Ae,Oe);if(Fe)for(const k in Fe)delete je[k];return je}initializeTileState(k,F){k.refreshFeatureState(F)}coalesceChanges(F,Me){const Ae={};for(const F in this.stateChanges){this.state[F]=this.state[F]||{};const Me={};for(const Ae in this.stateChanges[F])this.state[F][Ae]||(this.state[F][Ae]={}),k.l(this.state[F][Ae],this.stateChanges[F][Ae]),Me[Ae]=this.state[F][Ae];Ae[F]=Me}for(const F in this.deletedStates){this.state[F]=this.state[F]||{};const Me={};if(null===this.deletedStates[F])for(const k in this.state[F])Me[k]={},this.state[F][k]={};else for(const k in this.deletedStates[F]){if(null===this.deletedStates[F][k])this.state[F][k]={};else if(this.state[F][k])for(const Me of Object.keys(this.deletedStates[F][k]))delete this.state[F][k][Me];Me[k]=this.state[F][k]}Ae[F]=Ae[F]||{},k.l(Ae[F],Me)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(Ae).length)for(const k in F)F[k].refreshFeatureState(Me)}}class Tt extends k.E{constructor(k,F,Me){super(),this.id=k,this._onlySymbols=Me,F.on("data",(k=>{"source"===k.dataType&&"metadata"===k.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===k.dataType&&"content"===k.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),F.on("error",(()=>{this._sourceErrored=!0})),this._source=F,this._tiles={},this._cache=new bt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=F.minTileCacheSize,this._maxTileCacheSize=F.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new wt,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(k){this.map=k,this._minTileCacheSize=void 0===this._minTileCacheSize&&k?k._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&k?k._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const k in this._tiles){const F=this._tiles[k];if("loaded"!==F.state&&"errored"!==F.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const k=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,k&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(k,F){return k.isSymbolTile=this._onlySymbols,k.isExtraShadowCaster=this._shadowCasterTiles[k.tileID.key],this._source.loadTile(k,F)}_unloadTile(k){if(this._source.unloadTile)return this._source.unloadTile(k)}_abortTile(k){if(this._source.abortTile)return this._source.abortTile(k)}serialize(){return this._source.serialize()}prepare(k){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const F in this._tiles){const Me=this._tiles[F];Me.upload(k),Me.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return k.bj(this._tiles).map((k=>k.tileID)).sort(Et).map((k=>k.key))}getRenderableIds(F,Me){const Ae=[];for(const k in this._tiles)this._isIdRenderable(+k,F,Me)&&Ae.push(this._tiles[k]);return F?Ae.sort(((F,Me)=>{const Ae=F.tileID,Oe=Me.tileID,Fe=new k.P(Ae.canonical.x,Ae.canonical.y)._rotate(this.transform.angle),je=new k.P(Oe.canonical.x,Oe.canonical.y)._rotate(this.transform.angle);return Ae.overscaledZ-Oe.overscaledZ||je.y-Fe.y||je.x-Fe.x})).map((k=>k.tileID.key)):Ae.map((k=>k.tileID)).sort(Et).map((k=>k.key))}hasRenderableParent(k){const F=this.findLoadedParent(k,0);return!!F&&this._isIdRenderable(F.tileID.key)}_isIdRenderable(k,F,Me){return this._tiles[k]&&this._tiles[k].hasData()&&!this._coveredTiles[k]&&(F||!this._tiles[k].holdingForFade())&&(Me||!this._shadowCasterTiles[k])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const k in this._tiles)"errored"!==this._tiles[k].state&&this._reloadTile(+k,"reloading")}}_reloadTile(k,F){const Me=this._tiles[k];Me&&("loading"!==Me.state&&(Me.state=F),this._loadTile(Me,this._tileLoaded.bind(this,Me,k,F)))}_tileLoaded(F,Me,Ae,Oe){if(Oe)if(F.state="errored",404!==Oe.status)this._source.fire(new k.y(Oe,{tile:F}));else{if(this._source.fire(new k.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:F})),!(F.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const k=this.map.painter.terrain;this.update(this.transform,k.getScaledDemTileSize(),!0),k.resetTileLookupCache(this.id)}else this.update(this.transform)}else F.timeAdded=k.q.now(),"expired"===Ae&&(F.refreshedUponExpiration=!0),this._setTileReloadTimer(Me,F),"raster-dem"===this._source.type&&F.dem&&this._backfillDEM(F),this._state.initializeTileState(F,this.map?this.map.painter:null),this._source.fire(new k.z("data",{dataType:"source",tile:F,coord:F.tileID,sourceCacheId:this.id}))}_backfillDEM(k){const F=this.getRenderableIds();for(let Me=0;Me<F.length;Me++){const Ae=F[Me];if(k.neighboringTiles&&k.neighboringTiles[Ae]){const F=this.getTileByID(Ae);i(k,F),i(F,k)}}function i(k,F){if(!k.dem||k.dem.borderReady)return;k.needsHillshadePrepare=!0,k.needsDEMTextureUpload=!0;let Me=F.tileID.canonical.x-k.tileID.canonical.x;const Ae=F.tileID.canonical.y-k.tileID.canonical.y,Oe=Math.pow(2,k.tileID.canonical.z),Fe=F.tileID.key;0===Me&&0===Ae||Math.abs(Ae)>1||(Math.abs(Me)>1&&(1===Math.abs(Me+Oe)?Me+=Oe:1===Math.abs(Me-Oe)&&(Me-=Oe)),F.dem&&k.dem&&(k.dem.backfillBorder(F.dem,Me,Ae),k.neighboringTiles&&k.neighboringTiles[Fe]&&(k.neighboringTiles[Fe].backfilled=!0)))}}getTile(k){return this.getTileByID(k.key)}getTileByID(k){return this._tiles[k]}_retainLoadedChildren(k,F,Me,Ae){for(const Oe in this._tiles){let Fe=this._tiles[Oe];if(Ae[Oe]||!Fe.hasData()||Fe.tileID.overscaledZ<=F||Fe.tileID.overscaledZ>Me)continue;let je=Fe.tileID;for(;Fe&&Fe.tileID.overscaledZ>F+1;){const k=Fe.tileID.scaledTo(Fe.tileID.overscaledZ-1);Fe=this._tiles[k.key],Fe&&Fe.hasData()&&(je=k)}let qe=je;for(;qe.overscaledZ>F;)if(qe=qe.scaledTo(qe.overscaledZ-1),k[qe.key]){Ae[je.key]=je;break}}}findLoadedParent(k,F){if(k.key in this._loadedParentTiles){const Me=this._loadedParentTiles[k.key];return Me&&Me.tileID.overscaledZ>=F?Me:null}for(let Me=k.overscaledZ-1;Me>=F;Me--){const F=k.scaledTo(Me),Ae=this._getLoadedTile(F);if(Ae)return Ae}}_getLoadedTile(k){const F=this._tiles[k.key];return F&&F.hasData()?F:this._cache.getByKey(this._source.reparseOverscaled?k.wrapped().key:k.canonical.key)}updateCacheSize(k,F){F=F||this._source.tileSize;const Me=Math.ceil(k.width/F)+1,Ae=Math.ceil(k.height/F)+1,Oe=Math.floor(Me*Ae*5),Fe="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,Oe):Oe,je="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,Fe):Fe;this._cache.setMaxSize(je)}handleWrapJump(k){const F=Math.round((k-(void 0===this._prevLng?k:this._prevLng))/360);if(this._prevLng=k,F){const k={};for(const Me in this._tiles){const Ae=this._tiles[Me];Ae.tileID=Ae.tileID.unwrapTo(Ae.tileID.wrap+F),k[Ae.tileID.key]=Ae}this._tiles=k;for(const k in this._timers)clearTimeout(this._timers[k]),delete this._timers[k];for(const k in this._tiles)this._setTileReloadTimer(+k,this._tiles[k])}}update(F,Me,Ae,Oe){if(this.transform=F,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!Ae)return;this.updateCacheSize(F,Me),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const Fe="batched-model"===this._source.type;let je,qe=this._source.maxzoom;const pt=this.map&&this.map.painter?this.map.painter._terrain:null;if(pt&&pt.sourceCache===this&&pt.attenuationRange()){const k=pt.attenuationRange()[0],F=Math.floor(k)-Math.log2(pt.getDemUpscale());qe>F&&(qe=F)}if(this.used||this.usedForTerrain){if(this._source.tileID)je=F.getVisibleUnwrappedCoordinates(this._source.tileID).map((F=>new k.aG(F.canonical.z,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y)));else if(0!==this.tileCoverLift){const Oe=F.clone();Oe.tileCoverLift=this.tileCoverLift,je=Oe.coveringTiles({tileSize:Me||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:qe,roundZoom:this._source.roundZoom&&!Ae,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:Fe}),this._source.minzoom<=1&&"globe"===F.projection.name&&(je.push(new k.aG(1,0,1,0,0)),je.push(new k.aG(1,0,1,1,0)),je.push(new k.aG(1,0,1,0,1)),je.push(new k.aG(1,0,1,1,1)))}else if(je=F.coveringTiles({tileSize:Me||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:qe,roundZoom:this._source.roundZoom&&!Ae,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:Fe}),this._source.hasTile){const k=this._source.hasTile.bind(this._source);je=je.filter((F=>k(F)))}}else je=[];if(je.length>0&&this.castsShadows&&Oe&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!St(this._source.type)){const k=F.coveringZoomLevel({tileSize:Me||this._source.tileSize,roundZoom:this._source.roundZoom&&!Ae}),qe=Math.min(k,this._source.maxzoom);if(Fe){const k=F.extendTileCover(je,qe);for(const F of k)je.push(F)}else{const k=F.extendTileCover(je,qe,Oe);for(const F of k)this._shadowCasterTiles[F.key]=!0,je.push(F)}}const vt=this._updateRetainedTiles(je);if(St(this._source.type)&&0!==je.length){const F={},Me={},Ae=Object.keys(vt);for(const Oe of Ae){const Ae=vt[Oe],Fe=this._tiles[Oe];if(!Fe||Fe.fadeEndTime&&Fe.fadeEndTime<=k.q.now())continue;const je=this.findLoadedParent(Ae,Math.max(Ae.overscaledZ-Tt.maxOverzooming,this._source.minzoom));je&&(this._addTile(je.tileID),F[je.tileID.key]=je.tileID),Me[Oe]=Ae}const Oe=je[je.length-1].overscaledZ;for(const k in this._tiles){const F=this._tiles[k];if(vt[k]||!F.hasData())continue;let Ae=F.tileID;for(;Ae.overscaledZ>Oe;){Ae=Ae.scaledTo(Ae.overscaledZ-1);const Oe=this._tiles[Ae.key];if(Oe&&Oe.hasData()&&Me[Ae.key]){vt[k]=F.tileID;break}}}for(const k in F)vt[k]||(this._coveredTiles[k]=!0,vt[k]=F[k])}for(const k in vt)this._tiles[k].clearFadeHold();const Ut=k.bk(this._tiles,vt);for(const k of Ut){const F=this._tiles[k];F.hasSymbolBuckets&&!F.holdingForFade()?F.setHoldDuration(this.map._fadeDuration):F.hasSymbolBuckets&&!F.symbolFadeFinished()||this._removeTile(+k)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const k in this._tiles)this._tiles[k].holdingForFade()&&this._removeTile(+k)}_updateRetainedTiles(k){const F={};if(0===k.length)return F;const Me={},Ae=k.reduce(((k,F)=>Math.min(k,F.overscaledZ)),1/0),Oe=k[0].overscaledZ,Fe=Math.max(Oe-Tt.maxOverzooming,this._source.minzoom),je=Math.max(Oe+Tt.maxUnderzooming,this._source.minzoom),qe={};for(const Me of k){const k=this._addTile(Me);F[Me.key]=Me,k.hasData()||Ae<this._source.maxzoom&&(qe[Me.key]=Me)}this._retainLoadedChildren(qe,Ae,je,F);for(const Ae of k){let k=this._tiles[Ae.key];if(k.hasData())continue;if(Ae.canonical.z>=this._source.maxzoom){const k=Ae.children(this._source.maxzoom)[0],Me=this.getTile(k);if(Me&&Me.hasData()){F[k.key]=k;continue}}else{const k=Ae.children(this._source.maxzoom);if(F[k[0].key]&&F[k[1].key]&&F[k[2].key]&&F[k[3].key])continue}let Oe=k.wasRequested();for(let je=Ae.overscaledZ-1;je>=Fe;--je){const Fe=Ae.scaledTo(je);if(Me[Fe.key])break;if(Me[Fe.key]=!0,k=this.getTile(Fe),!k&&Oe&&(k=this._addTile(Fe)),k&&(F[Fe.key]=Fe,Oe=k.wasRequested(),k.hasData()))break}}return F}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const k in this._tiles){const F=[];let Me,Ae=this._tiles[k].tileID;for(;Ae.overscaledZ>0;){if(Ae.key in this._loadedParentTiles){Me=this._loadedParentTiles[Ae.key];break}F.push(Ae.key);const k=Ae.scaledTo(Ae.overscaledZ-1);if(Me=this._getLoadedTile(k),Me)break;Ae=k}for(const k of F)this._loadedParentTiles[k]=Me}}_addTile(F){let Me=this._tiles[F.key];if(Me)return!0!==Me.isExtraShadowCaster||!!this._shadowCasterTiles[F.key]||this._reloadTile(F.key,"reloading"),Me;Me=this._cache.getAndRemove(F),Me&&(this._setTileReloadTimer(F.key,Me),Me.tileID=F,this._state.initializeTileState(Me,this.map?this.map.painter:null),this._cacheTimers[F.key]&&(clearTimeout(this._cacheTimers[F.key]),delete this._cacheTimers[F.key],this._setTileReloadTimer(F.key,Me)));const Ae=Boolean(Me);if(!Ae){const k=this.map?this.map.painter:null,Ae=this._source.tileSize*F.overscaleFactor();Me="raster-array"===this._source.type?new xt(F,Ae,this.transform.tileZoom,k,this._isRaster):new yt(F,Ae,this.transform.tileZoom,k,this._isRaster),this._loadTile(Me,this._tileLoaded.bind(this,Me,F.key,Me.state))}return Me?(Me.uses++,this._tiles[F.key]=Me,Ae||this._source.fire(new k.z("dataloading",{tile:Me,coord:Me.tileID,dataType:"source"})),Me):null}_setTileReloadTimer(k,F){k in this._timers&&(clearTimeout(this._timers[k]),delete this._timers[k]);const Me=F.getExpiryTimeout();Me&&(this._timers[k]=setTimeout((()=>{this._reloadTile(k,"expired"),delete this._timers[k]}),Me))}_removeTile(k){const F=this._tiles[k];F&&(F.uses--,delete this._tiles[k],this._timers[k]&&(clearTimeout(this._timers[k]),delete this._timers[k]),F.uses>0||(F.hasData()&&"reloading"!==F.state||"empty"===F.state?this._cache.add(F.tileID,F,F.getExpiryTimeout()):(F.aborted=!0,this._abortTile(F),this._unloadTile(F))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const k in this._tiles)this._removeTile(+k);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(F,Me,Ae){const Oe=[],Fe=this.transform;if(!Fe)return Oe;const je="globe"===Fe.projection.name,qe=k.at(Fe.center.lng);for(const pt in this._tiles){const vt=this._tiles[pt];if(Ae&&vt.clearQueryDebugViz(),vt.holdingForFade())continue;let Ut;if(je){const F=vt.tileID.canonical;if(0===F.z){const Me=[Math.abs(k.aw(qe,...Ct(F,-1))-qe),Math.abs(k.aw(qe,...Ct(F,1))-qe)];Ut=[0,2*Me.indexOf(Math.min(...Me))-1]}else{const Me=[Math.abs(k.aw(qe,...Ct(F,-1))-qe),Math.abs(k.aw(qe,...Ct(F,0))-qe),Math.abs(k.aw(qe,...Ct(F,1))-qe)];Ut=[Me.indexOf(Math.min(...Me))-1]}}else Ut=[0];for(const k of Ut){const Ae=F.containsTile(vt,Fe,Me,k);Ae&&Oe.push(Ae)}}return Oe}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(k){return this._getRenderableCoordinates(k)}_getRenderableCoordinates(k,F){const Me=this.getRenderableIds(k,F).map((k=>this._tiles[k].tileID)),Ae="globe"===this.transform.projection.name;for(const k of Me)k.projMatrix=this.transform.calculateProjMatrix(k.toUnwrapped()),k.expandedProjMatrix=Ae?this.transform.calculateProjMatrix(k.toUnwrapped(),!1,!0):k.projMatrix;return Me}sortCoordinatesByDistance(k){const F=k.slice(),Me=this.transform._camera.position,Ae=this.transform._camera.forward(),Oe={};for(const k of F){const F=1/(1<<k.canonical.z);Oe[k.key]=((k.canonical.x+.5)*F+k.wrap-Me[0])*Ae[0]+((k.canonical.y+.5)*F-Me[1])*Ae[1]-Me[2]*Ae[2]}return F.sort(((k,F)=>Oe[k.key]-Oe[F.key])),F}hasTransition(){if(this._source.hasTransition())return!0;if(St(this._source.type))for(const F in this._tiles){const Me=this._tiles[F];if(void 0!==Me.fadeEndTime&&Me.fadeEndTime>=k.q.now())return!0}return!1}setFeatureState(k,F,Me){this._state.updateState(k=k||"_geojsonTileLayer",F,Me)}removeFeatureState(k,F,Me){this._state.removeFeatureState(k=k||"_geojsonTileLayer",F,Me)}getFeatureState(k,F){return this._state.getState(k=k||"_geojsonTileLayer",F)}setDependencies(k,F,Me){const Ae=this._tiles[k];Ae&&Ae.setDependencies(F,Me)}reloadTilesForDependencies(k,F){for(const Me in this._tiles)this._tiles[Me].hasDependency(k,F)&&this._reloadTile(+Me,"reloading");this._cache.filter((Me=>!Me.hasDependency(k,F)))}_preloadTiles(F,Me){if(!this._sourceLoaded){const e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(F,Me))};return void this._source.on("data",e)}const Ae=new Map,Oe=Array.isArray(F)?F:[F],Fe=this.map.painter.terrain,je=this.usedForTerrain&&Fe?Fe.getScaledDemTileSize():this._source.tileSize;for(const k of Oe){const F=k.coveringTiles({tileSize:je,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const k of F)Ae.set(k.key,k);this.usedForTerrain&&k.updateElevation(!1)}const qe=Array.from(Ae.values());k.bl(qe,((k,F)=>{const Me=new yt(k,this._source.tileSize*k.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(Me,(k=>{"raster-dem"===this._source.type&&Me.dem&&this._backfillDEM(Me),F(k,Me)}))}),Me)}}function Et(k,F){const Me=Math.abs(2*k.wrap)-+(k.wrap<0),Ae=Math.abs(2*F.wrap)-+(F.wrap<0);return k.overscaledZ-F.overscaledZ||Ae-Me||F.canonical.y-k.canonical.y||F.canonical.x-k.canonical.x}function St(k){return"raster"===k||"image"===k||"video"===k||"custom"===k}function Ct(k,F){const Me=1<<k.z;return[k.x/Me+F,(k.x+1)/Me+F]}Tt.maxOverzooming=10,Tt.maxUnderzooming=3;class It{constructor(k){this.style=k,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const k=!1,F=!1;for(const Me in this.style._mergedLayers){const Ae=this.style._mergedLayers[Me];if("fill-extrusion"===Ae.type)this.layers.push({layer:Ae,visible:k,visibilityChanged:F});else if("model"===Ae.type){const Me=this.style.getLayerSource(Ae);Me&&"batched-model"===Me.type&&this.layers.push({layer:Ae,visible:k,visibilityChanged:F})}}}onNewFrame(k){this.layersGotHidden=!1;for(const F of this.layers){const Me=F.layer;let Ae=!1;"fill-extrusion"===Me.type?Ae=!Me.isHidden(k)&&Me.paint.get("fill-extrusion-opacity")>0:"model"===Me.type&&(Ae=!Me.isHidden(k)&&Me.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!Ae&&F.visible,F.visible=Ae}}updateZOffset(k,F){this.currentBuildingBuckets=[];for(const k of this.layers){const Me=k.layer,Ae=this.style.getLayerSourceCache(Me);let Oe=1;"fill-extrusion"===Me.type&&(Oe=k.visible?Me.paint.get("fill-extrusion-vertical-scale"):0);let Fe=Ae?Ae.getTile(F):null;if(!Fe&&Ae&&F.canonical.z>Ae.getSource().minzoom){let k=F.scaledTo(Math.min(Ae.getSource().maxzoom,F.overscaledZ-1));for(;k.overscaledZ>=Ae.getSource().minzoom&&(Fe=Ae.getTile(k),!Fe&&0!==k.overscaledZ);)k=k.scaledTo(k.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:Fe?Fe.getBucket(Me):null,tileID:Fe?Fe.tileID:F,verticalScale:Oe})}k.hasAnyZOffset=!1;let Me=!1;for(let Ae=0;Ae<k.symbolInstances.length;Ae++){const Oe=k.symbolInstances.get(Ae),Fe=Oe.zOffset,je=this._getHeightAtTileOffset(F,Oe.tileAnchorX,Oe.tileAnchorY);Oe.zOffset=je!==Number.NEGATIVE_INFINITY?je:Fe,Me||Fe===Oe.zOffset||(Me=!0),k.hasAnyZOffset||0===Oe.zOffset||(k.hasAnyZOffset=!0)}Me&&(k.zOffsetBuffersNeedUpload=!0,k.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(F,Me,Ae,Oe){let Fe=Me,je=Ae;if(F.canonical.z!==Oe.canonical.z){const qe=Oe.canonical,pt=1/(1<<F.canonical.z-qe.z);Fe=(Me+F.canonical.x*k.ag)*pt-qe.x*k.ag|0,je=(Ae+F.canonical.y*k.ag)*pt-qe.y*k.ag|0}return{tileX:Fe,tileY:je}}_getHeightAtTileOffset(k,F,Me){let Ae,Oe;for(let Fe=0;Fe<this.layers.length;++Fe){if("fill-extrusion"!==this.layers[Fe].layer.type)continue;const{bucket:je,tileID:qe,verticalScale:pt}=this.currentBuildingBuckets[Fe];if(!je)continue;const{tileX:vt,tileY:Ut}=this._mapCoordToOverlappingTile(k,F,Me,qe),xi=je.getHeightAtTileCoord(vt,Ut);xi&&void 0!==xi.height&&(xi.hidden?Ae=xi.height:Oe=Math.max(xi.height*pt,Oe||0))}if(void 0!==Oe)return Oe;for(let Oe=0;Oe<this.layers.length;++Oe){const Fe=this.layers[Oe];if("model"!==Fe.layer.type||!Fe.visible)continue;const{bucket:je,tileID:qe}=this.currentBuildingBuckets[Oe];if(!je)continue;const{tileX:pt,tileY:vt}=this._mapCoordToOverlappingTile(k,F,Me,qe),Ut=je.getHeightAtTileCoord(pt,vt);if(Ut&&!Ut.hidden)return void 0===Ut.height&&void 0!==Ae?Math.min(Ut.maxHeight,Ae)*Ut.verticalScale:Ut.height?Ut.height*Ut.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Rt(F,Me){const Ae={};for(const k in F)"ref"!==k&&(Ae[k]=F[k]);return k.bm.forEach((k=>{k in Me&&(Ae[k]=Me[k])})),Ae}function Dt(k){k=k.slice();const F=Object.create(null);for(let Me=0;Me<k.length;Me++)F[k[Me].id]=k[Me];for(let Me=0;Me<k.length;Me++)"ref"in k[Me]&&(k[Me]=Rt(k[Me],F[k[Me].ref]));return k}const Gc={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function At(k,F,Me){Me.push({command:Gc.addSource,args:[k,F[k]]})}function zt(k,F,Me){F.push({command:Gc.removeSource,args:[k]}),Me[k]=!0}function Pt(k,F,Me,Ae){zt(k,Me,Ae),At(k,F,Me)}function Mt(F,Me,Ae){let Oe;for(Oe in F[Ae])if(F[Ae].hasOwnProperty(Oe)&&"data"!==Oe&&!k.bn(F[Ae][Oe],Me[Ae][Oe]))return!1;for(Oe in Me[Ae])if(Me[Ae].hasOwnProperty(Oe)&&"data"!==Oe&&!k.bn(F[Ae][Oe],Me[Ae][Oe]))return!1;return!0}function Ot(F,Me,Ae,Oe,Fe,je){let qe;for(qe in Me=Me||{},F=F||{})F.hasOwnProperty(qe)&&(k.bn(F[qe],Me[qe])||Ae.push({command:je,args:[Oe,qe,Me[qe],Fe]}));for(qe in Me)Me.hasOwnProperty(qe)&&!F.hasOwnProperty(qe)&&(k.bn(F[qe],Me[qe])||Ae.push({command:je,args:[Oe,qe,Me[qe],Fe]}))}function Ft(k){return k.id}function kt(k,F){return k[F.id]=F,k}class Bt{constructor(k,F){this.reset(k,F)}reset(k,F){this.points=k||[],this._distances=[0];for(let k=1;k<this.points.length;k++)this._distances[k]=this._distances[k-1]+this.points[k].dist(this.points[k-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(F||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(F){if(1===this.points.length)return this.points[0];F=k.aw(F,0,1);let Me=1,Ae=this._distances[Me];const Oe=F*this.paddedLength+this.padding;for(;Ae<Oe&&Me<this._distances.length;)Ae=this._distances[++Me];const Fe=Me-1,je=this._distances[Fe],qe=Ae-je,pt=qe>0?(Oe-je)/qe:0;return this.points[Fe].mult(1-pt).add(this.points[Me].mult(pt))}}class Nt{constructor(k,F,Me){const Ae=this.boxCells=[],Oe=this.circleCells=[];this.xCellCount=Math.ceil(k/Me),this.yCellCount=Math.ceil(F/Me);for(let k=0;k<this.xCellCount*this.yCellCount;k++)Ae.push([]),Oe.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=k,this.height=F,this.xScale=this.xCellCount/k,this.yScale=this.yCellCount/F,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(k,F,Me,Ae,Oe){this._forEachCell(F,Me,Ae,Oe,this._insertBoxCell,this.boxUid++),this.boxKeys.push(k),this.bboxes.push(F),this.bboxes.push(Me),this.bboxes.push(Ae),this.bboxes.push(Oe)}insertCircle(k,F,Me,Ae){this._forEachCell(F-Ae,Me-Ae,F+Ae,Me+Ae,this._insertCircleCell,this.circleUid++),this.circleKeys.push(k),this.circles.push(F),this.circles.push(Me),this.circles.push(Ae)}_insertBoxCell(k,F,Me,Ae,Oe,Fe){this.boxCells[Oe].push(Fe)}_insertCircleCell(k,F,Me,Ae,Oe,Fe){this.circleCells[Oe].push(Fe)}_query(k,F,Me,Ae,Oe,Fe){if(Me<0||k>this.width||Ae<0||F>this.height)return!Oe&&[];const je=[];if(k<=0&&F<=0&&this.width<=Me&&this.height<=Ae){if(Oe)return!0;for(let k=0;k<this.boxKeys.length;k++)je.push({key:this.boxKeys[k],x1:this.bboxes[4*k],y1:this.bboxes[4*k+1],x2:this.bboxes[4*k+2],y2:this.bboxes[4*k+3]});for(let k=0;k<this.circleKeys.length;k++){const F=this.circles[3*k],Me=this.circles[3*k+1],Ae=this.circles[3*k+2];je.push({key:this.circleKeys[k],x1:F-Ae,y1:Me-Ae,x2:F+Ae,y2:Me+Ae})}return Fe?je.filter(Fe):je}return this._forEachCell(k,F,Me,Ae,this._queryCell,je,{hitTest:Oe,seenUids:{box:{},circle:{}}},Fe),Oe?je.length>0:je}_queryCircle(k,F,Me,Ae,Oe){const Fe=k-Me,je=k+Me,qe=F-Me,pt=F+Me;if(je<0||Fe>this.width||pt<0||qe>this.height)return!Ae&&[];const vt=[];return this._forEachCell(Fe,qe,je,pt,this._queryCellCircle,vt,{hitTest:Ae,circle:{x:k,y:F,radius:Me},seenUids:{box:{},circle:{}}},Oe),Ae?vt.length>0:vt}query(k,F,Me,Ae,Oe){return this._query(k,F,Me,Ae,!1,Oe)}hitTest(k,F,Me,Ae,Oe){return this._query(k,F,Me,Ae,!0,Oe)}hitTestCircle(k,F,Me,Ae){return this._queryCircle(k,F,Me,!0,Ae)}_queryCell(k,F,Me,Ae,Oe,Fe,je,qe){const pt=je.seenUids,vt=this.boxCells[Oe];if(null!==vt){const Oe=this.bboxes;for(const Ut of vt)if(!pt.box[Ut]){pt.box[Ut]=!0;const vt=4*Ut;if(k<=Oe[vt+2]&&F<=Oe[vt+3]&&Me>=Oe[vt+0]&&Ae>=Oe[vt+1]&&(!qe||qe(this.boxKeys[Ut]))){if(je.hitTest)return Fe.push(!0),!0;Fe.push({key:this.boxKeys[Ut],x1:Oe[vt],y1:Oe[vt+1],x2:Oe[vt+2],y2:Oe[vt+3]})}}}const Ut=this.circleCells[Oe];if(null!==Ut){const Oe=this.circles;for(const vt of Ut)if(!pt.circle[vt]){pt.circle[vt]=!0;const Ut=3*vt;if(this._circleAndRectCollide(Oe[Ut],Oe[Ut+1],Oe[Ut+2],k,F,Me,Ae)&&(!qe||qe(this.circleKeys[vt]))){if(je.hitTest)return Fe.push(!0),!0;{const k=Oe[Ut],F=Oe[Ut+1],Me=Oe[Ut+2];Fe.push({key:this.circleKeys[vt],x1:k-Me,y1:F-Me,x2:k+Me,y2:F+Me})}}}}}_queryCellCircle(k,F,Me,Ae,Oe,Fe,je,qe){const pt=je.circle,vt=je.seenUids,Ut=this.boxCells[Oe];if(null!==Ut){const k=this.bboxes;for(const F of Ut)if(!vt.box[F]){vt.box[F]=!0;const Me=4*F;if(this._circleAndRectCollide(pt.x,pt.y,pt.radius,k[Me+0],k[Me+1],k[Me+2],k[Me+3])&&(!qe||qe(this.boxKeys[F])))return Fe.push(!0),!0}}const xi=this.circleCells[Oe];if(null!==xi){const k=this.circles;for(const F of xi)if(!vt.circle[F]){vt.circle[F]=!0;const Me=3*F;if(this._circlesCollide(k[Me],k[Me+1],k[Me+2],pt.x,pt.y,pt.radius)&&(!qe||qe(this.circleKeys[F])))return Fe.push(!0),!0}}}_forEachCell(k,F,Me,Ae,Oe,Fe,je,qe){const pt=this._convertToXCellCoord(k),vt=this._convertToYCellCoord(F),Ut=this._convertToXCellCoord(Me),xi=this._convertToYCellCoord(Ae);for(let vi=pt;vi<=Ut;vi++)for(let pt=vt;pt<=xi;pt++)if(Oe.call(this,k,F,Me,Ae,this.xCellCount*pt+vi,Fe,je,qe))return}_convertToXCellCoord(k){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(k*this.xScale)))}_convertToYCellCoord(k){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(k*this.yScale)))}_circlesCollide(k,F,Me,Ae,Oe,Fe){const je=Ae-k,qe=Oe-F,pt=Me+Fe;return pt*pt>je*je+qe*qe}_circleAndRectCollide(k,F,Me,Ae,Oe,Fe,je){const qe=(Fe-Ae)/2,pt=Math.abs(k-(Ae+qe));if(pt>qe+Me)return!1;const vt=(je-Oe)/2,Ut=Math.abs(F-(Oe+vt));if(Ut>vt+Me)return!1;if(pt<=qe||Ut<=vt)return!0;const xi=pt-qe,vi=Ut-vt;return xi*xi+vi*vi<=Me*Me}}const qc={unknown:0,flipRequired:1,flipNotRequired:2},Hc=Math.tan(85*Math.PI/180);function jt(F,Me,Ae,Oe,Fe,je,qe){const pt=k.ab.mat4.create();if(Ae)if("globe"===je.name){const F=k.bo(Fe,Me);k.ab.mat4.multiply(pt,pt,F)}else{const F=k.ab.mat2.invert([],qe);pt[0]=F[0],pt[1]=F[1],pt[4]=F[2],pt[5]=F[3],Oe||k.ab.mat4.rotateZ(pt,pt,Fe.angle)}else k.ab.mat4.multiply(pt,Fe.labelPlaneMatrix,F);return pt}function Vt(k,F,Me,Ae,Oe,Fe,je){const qe=jt(k,F,Me,Ae,Oe,Fe,je);return"globe"===Fe.name&&Me||(qe[2]=qe[6]=qe[10]=qe[14]=0),qe}function qt(F,Me,Ae,Oe,Fe,je,qe){if(Ae){if("globe"===je.name){const pt=jt(F,Me,Ae,Oe,Fe,je,qe);return k.ab.mat4.invert(pt,pt),k.ab.mat4.multiply(pt,F,pt),pt}{const Me=k.ab.mat4.clone(F),Ae=k.ab.mat4.identity([]);return Ae[0]=qe[0],Ae[1]=qe[1],Ae[4]=qe[2],Ae[5]=qe[3],k.ab.mat4.multiply(Me,Me,Ae),Oe||k.ab.mat4.rotateZ(Me,Me,-Fe.angle),Me}}return Fe.glCoordMatrix}function Ht(F,Me,Ae,Oe){const Fe=[F,Me,Ae,1];Ae?k.ab.vec4.transformMat4(Fe,Fe,Oe):ii(Fe,Fe,Oe);const je=Fe[3];return Fe[0]/=je,Fe[1]/=je,Fe[2]/=je,Fe}function Zt(k,F){return Math.min(.5+k/F*.5,1.5)}function Wt(k,F){const Me=k[0]/k[3],Ae=k[1]/k[3];return Me>=-F[0]&&Me<=F[0]&&Ae>=-F[1]&&Ae<=F[1]}function $t(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut){const xi=Ae.transform,vi=Oe?F.textSizeData:F.iconSizeData,bi=k.bp(vi,Ae.transform.zoom),wi="globe"===xi.projection.name,Mi=[256/Ae.width*2+1,256/Ae.height*2+1],pr=Oe?F.text.dynamicLayoutVertexArray:F.icon.dynamicLayoutVertexArray;pr.clear();let Ur=null;wi&&(Ur=Oe?F.text.globeExtVertexArray:F.icon.globeExtVertexArray);const Wr=F.lineVertexArray,Jr=Oe?F.text.placedSymbolArray:F.icon.placedSymbolArray,Qr=Ae.transform.width/Ae.transform.height;let co,mo=!1;for(let Oe=0;Oe<Jr.length;Oe++){const wi=Jr.get(Oe),{numGlyphs:yo,writingMode:To}=wi;if(To!==k.bq.vertical||mo||co===k.bq.horizontal||(mo=!0),co=To,(wi.hidden||To===k.bq.vertical)&&!mo){ti(yo,pr);continue}mo=!1;const zo=new k.P(wi.tileAnchorX,wi.tileAnchorY);let{x:ko,y:na,z:aa}=xi.projection.projectTilePoint(zo.x,zo.y,Ut.canonical);if(vt){const[k,F,Me]=vt(zo);ko+=k,na+=F,aa+=Me}const _a=[ko,na,aa,1];if(k.ab.vec4.transformMat4(_a,_a,Me),!Wt(_a,Mi)){ti(yo,pr);continue}const wa=_a[3],Sa=Zt(Ae.transform.getCameraToCenterDistance(xi.projection),wa),Ya=k.br(vi,bi,wi),rl=qe?Ya/Sa:Ya*Sa,sl=Ht(ko,na,aa,Fe);if(sl[3]<=0){ti(yo,pr);continue}let ml={};const Sl=qe?null:vt,Il=Yt(wi,rl,!1,pt,Me,Fe,je,F.glyphOffsetArray,Wr,pr,Ur,sl,zo,ml,Qr,Sl,xi.projection,Ut,qe);mo=Il.useVertical,Sl&&Il.needsFlipping&&(ml={}),(Il.notEnoughRoom||mo||Il.needsFlipping&&Yt(wi,rl,!0,pt,Me,Fe,je,F.glyphOffsetArray,Wr,pr,Ur,sl,zo,ml,Qr,Sl,xi.projection,Ut,qe).notEnoughRoom)&&ti(yo,pr)}Oe?(F.text.dynamicLayoutVertexBuffer.updateData(pr),Ur&&F.text.globeExtVertexBuffer&&F.text.globeExtVertexBuffer.updateData(Ur)):(F.icon.dynamicLayoutVertexBuffer.updateData(pr),Ur&&F.icon.globeExtVertexBuffer&&F.icon.globeExtVertexBuffer.updateData(Ur))}function Xt(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi){const{lineStartIndex:pr,glyphStartIndex:Ur,segment:Wr}=qe,Jr=Ur+qe.numGlyphs,Qr=pr+qe.lineLength,co=F.getoffsetX(Ur),mo=F.getoffsetX(Jr-1),yo=ei(k*co,Me,Ae,Oe,Fe,je,Wr,pr,Qr,pt,vt,Ut,xi,vi,!0,bi,wi,Mi);if(!yo)return null;const To=ei(k*mo,Me,Ae,Oe,Fe,je,Wr,pr,Qr,pt,vt,Ut,xi,vi,!0,bi,wi,Mi);return To?{first:yo,last:To}:null}function Kt(F,Me,Ae,Oe){return F===k.bq.horizontal&&Math.abs(Oe)>Math.abs(Ae)?{useVertical:!0}:F===k.bq.vertical?Oe>0?{needsFlipping:!0}:null:Me!==qc.unknown&&function(k,F){return 0===k||Math.abs(F/k)>Hc}(Ae,Oe)?Me===qc.flipRequired?{needsFlipping:!0}:null:Ae<0?{needsFlipping:!0}:null}function Yt(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr){const Qr=Me/24,co=F.lineOffsetX*Qr,mo=F.lineOffsetY*Qr,{lineStartIndex:yo,glyphStartIndex:To,numGlyphs:zo,segment:ko,writingMode:na,flipState:aa}=F,_a=yo+F.lineLength,L=F=>{if(xi){const[Me,Ae,Oe]=F.up,Fe=Ut.length;k.bs(xi,Fe+0,Me,Ae,Oe),k.bs(xi,Fe+1,Me,Ae,Oe),k.bs(xi,Fe+2,Me,Ae,Oe),k.bs(xi,Fe+3,Me,Ae,Oe)}const[Me,Ae,Oe]=F.point;k.bt(Ut,Me,Ae,Oe,F.angle)};if(zo>1){const k=Xt(Qr,pt,co,mo,Ae,vi,bi,F,vt,je,wi,pr,!1,Ur,Wr,Jr);if(!k)return{notEnoughRoom:!0};if(Oe&&!Ae){let[Me,Ae,Oe]=k.first.point,[Fe,je,pt]=k.last.point;[Me,Ae]=Ht(Me,Ae,Oe,qe),[Fe,je]=Ht(Fe,je,pt,qe);const vt=Kt(na,aa,(Fe-Me)*Mi,je-Ae);if(F.flipState=vt&&vt.needsFlipping?qc.flipRequired:qc.flipNotRequired,vt)return vt}L(k.first);for(let k=To+1;k<To+zo-1;k++){const F=ei(Qr*pt.getoffsetX(k),co,mo,Ae,vi,bi,ko,yo,_a,vt,je,wi,pr,!1,!1,Ur,Wr,Jr);if(!F)return Ut.length-=4*(k-To),{notEnoughRoom:!0};L(F)}L(k.last)}else{if(Oe&&!Ae){const Me=Ht(bi.x,bi.y,0,Fe),Ae=yo+ko+1,Oe=new k.P(vt.getx(Ae),vt.gety(Ae)),je=Ht(Oe.x,Oe.y,0,Fe),qe=je[3]>0?je:Qt(bi,Oe,Me,1,Fe,void 0,Ur,Wr.canonical),pt=Kt(na,aa,(qe[0]-Me[0])*Mi,qe[1]-Me[1]);if(F.flipState=pt&&pt.needsFlipping?qc.flipRequired:qc.flipNotRequired,pt)return pt}const Me=ei(Qr*pt.getoffsetX(To),co,mo,Ae,vi,bi,ko,yo,_a,vt,je,wi,pr,!1,!1,Ur,Wr,Jr);if(!Me)return{notEnoughRoom:!0};L(Me)}return{}}function Jt(k,F,Me,Ae,Oe){const{x:Fe,y:je,z:qe}=Ae.projectTilePoint(k.x,k.y,F);if(!Oe)return Ht(Fe,je,qe,Me);const[pt,vt,Ut]=Oe(k);return Ht(Fe+pt,je+vt,qe+Ut,Me)}function Qt(F,Me,Ae,Oe,Fe,je,qe,pt){const vt=Jt(F.sub(Me)._unit()._add(F),pt,Fe,qe,je);return k.ab.vec3.sub(vt,Ae,vt),k.ab.vec3.normalize(vt,vt),k.ab.vec3.scaleAndAdd(vt,Ae,vt,Oe)}function ei(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr){const Jr=Oe?F-Me:F+Me;let Qr=Jr>0?1:-1,co=0;Oe&&(Qr*=-1,co=Math.PI),Qr<0&&(co+=Math.PI);let mo=pt+qe+(Qr>0?0:1)|0,yo=Fe,To=Fe,zo=0,ko=0;const na=Math.abs(Jr),aa=[],_a=[];let wa=je,Sa=wa;const z=()=>Qt(Sa,wa,To,na-zo+1,xi,bi,pr,Ur.canonical);for(;zo+ko<=na;){if(mo+=Qr,mo<pt||mo>=vt)return null;if(To=yo,Sa=wa,aa.push(To),wi&&_a.push(Sa),wa=new k.P(Ut.getx(mo),Ut.gety(mo)),yo=vi[mo],!yo){const k=Jt(wa,Ur.canonical,xi,pr,bi);yo=k[3]>0?vi[mo]=k:z()}zo+=ko,ko=k.ab.vec3.distance(To,yo)}Mi&&bi&&(vi[mo]&&(yo=z(),ko=k.ab.vec3.distance(To,yo)),vi[mo]=yo);const Ya=(na-zo)/ko,rl=wa.sub(Sa)._mult(Ya)._add(Sa),sl=k.ab.vec3.sub([],yo,To),ml=k.ab.vec3.scaleAndAdd([],To,sl,Ya);let Sl=[0,0,1],Il=sl[0],Kl=sl[1];if(Wr&&(Sl=pr.upVector(Ur.canonical,rl.x,rl.y),0!==Sl[0]||0!==Sl[1]||1!==Sl[2])){const F=[Sl[2],0,-Sl[0]],Me=k.ab.vec3.cross([],Sl,F);k.ab.vec3.normalize(F,F),k.ab.vec3.normalize(Me,Me),Il=k.ab.vec3.dot(sl,F),Kl=k.ab.vec3.dot(sl,Me)}if(Ae){const F=k.ab.vec3.cross([],Sl,sl);k.ab.vec3.normalize(F,F),k.ab.vec3.scaleAndAdd(ml,ml,F,Ae*Qr)}const Jl=co+Math.atan2(Kl,Il);return aa.push(ml),wi&&_a.push(rl),{point:ml,angle:Jl,path:aa,tilePath:_a,up:Sl}}function ti(k,F){const Me=F.length,Ae=Me+4*k;F.resize(Ae),F.float32.fill(-1/0,4*Me,4*Ae)}function ii(k,F,Me){const Ae=F[0],Oe=F[1];return k[0]=Me[0]*Ae+Me[4]*Oe+Me[12],k[1]=Me[1]*Ae+Me[5]*Oe+Me[13],k[3]=Me[3]*Ae+Me[7]*Oe+Me[15],k}const $c=100;class si{constructor(k,F,Me=new Nt(k.width+200,k.height+200,25),Ae=new Nt(k.width+200,k.height+200,25)){this.transform=k,this.grid=Me,this.ignoredGrid=Ae,this.pitchfactor=Math.cos(k._pitch)*k.cameraToCenterDistance,this.screenRightBoundary=k.width+$c,this.screenBottomBoundary=k.height+$c,this.gridRightBoundary=k.width+200,this.gridBottomBoundary=k.height+200,this.fogState=F}placeCollisionBox(k,F,Me,Ae,Oe,Fe,je,qe){let pt=Me.projectedAnchorX,vt=Me.projectedAnchorY,Ut=Me.projectedAnchorZ;const xi=Me.elevation,vi=Me.tileID,bi=k.getProjection();if(xi&&vi){const[k,F,Ae]=bi.upVector(vi.canonical,Me.tileAnchorX,Me.tileAnchorY),Oe=bi.upVectorScale(vi.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;pt+=k*xi*Oe,vt+=F*xi*Oe,Ut+=Ae*xi*Oe}const wi=this.projectAndGetPerspectiveRatio(je,pt,vt,Ut,Me.tileID,"globe"===bi.name||!!xi||this.transform.pitch>0,bi),Mi=Fe*wi.perspectiveRatio,pr=(Me.x1*F+Ae.x-Me.padding)*Mi+wi.point.x,Ur=(Me.y1*F+Ae.y-Me.padding)*Mi+wi.point.y,Wr=(Me.x2*F+Ae.x+Me.padding)*Mi+wi.point.x,Jr=(Me.y2*F+Ae.y+Me.padding)*Mi+wi.point.y,Qr=wi.perspectiveRatio<=.55||wi.occluded;return!this.isInsideGrid(pr,Ur,Wr,Jr)||!Oe&&this.grid.hitTest(pr,Ur,Wr,Jr,qe)||Qr?{box:[],offscreen:!1,occluded:wi.occluded}:{box:[pr,Ur,Wr,Jr],offscreen:this.isOffscreen(pr,Ur,Wr,Jr),occluded:!1}}placeCollisionCircles(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi){const pr=[],Ur=this.transform.elevation,Wr=F.getProjection(),Jr=Ur?Ur.getAtTileOffsetFunc(Mi,this.transform.center.lat,this.transform.worldSize,Wr):null,Qr=new k.P(Ae.tileAnchorX,Ae.tileAnchorY);let{x:co,y:mo,z:yo}=Wr.projectTilePoint(Qr.x,Qr.y,Mi.canonical);if(Jr){const[k,F,Me]=Jr(Qr);co+=k,mo+=F,yo+=Me}const To="globe"===Wr.name,zo=this.projectAndGetPerspectiveRatio(qe,co,mo,yo,Mi,To||!!Ur||this.transform.pitch>0,Wr),{perspectiveRatio:ko}=zo,na=(xi?je/ko:je*ko)/k.bw,aa=Ht(co,mo,yo,pt),_a=zo.signedDistanceFromCamera>0?Xt(na,Fe,Ae.lineOffsetX*na,Ae.lineOffsetY*na,!1,aa,Qr,Ae,Oe,pt,{},Ur&&!xi?Jr:null,xi&&!!Ur,Wr,Mi,xi):null;let wa=!1,Sa=!1,Ya=!0;if(_a&&!zo.occluded){const F=.5*bi*ko+wi,Ae=new k.P(-100,-100),Oe=new k.P(this.screenRightBoundary,this.screenBottomBoundary),Fe=new Bt,{first:je,last:qe}=_a,pt=je.path.length;let xi=[];for(let k=pt-1;k>=1;k--)xi.push(je.path[k]);for(let k=1;k<qe.path.length;k++)xi.push(qe.path[k]);const Mi=2.5*F;vt&&(xi=xi.map((([k,F,Me],Ae)=>(Jr&&!To&&(Me=Jr(Ae<pt-1?je.tilePath[pt-1-Ae]:qe.tilePath[Ae-pt+2])[2]),Ht(k,F,Me,vt)))),xi.some((k=>k[3]<=0))&&(xi=[]));let Ur=[];if(xi.length>0){let F=1/0,Me=-1/0,Fe=1/0,je=-1/0;for(const k of xi)F=Math.min(F,k[0]),Fe=Math.min(Fe,k[1]),Me=Math.max(Me,k[0]),je=Math.max(je,k[1]);Me>=Ae.x&&F<=Oe.x&&je>=Ae.y&&Fe<=Oe.y&&(Ur=[xi.map((F=>new k.P(F[0],F[1])))],(F<Ae.x||Me>Oe.x||Fe<Ae.y||je>Oe.y)&&(Ur=k.bu(Ur,Ae.x,Ae.y,Oe.x,Oe.y)))}for(const k of Ur){Fe.reset(k,.25*F);let Ae=0;Ae=Fe.length<=.5*F?1:Math.ceil(Fe.paddedLength/Mi)+1;for(let k=0;k<Ae;k++){const Oe=k/Math.max(Ae-1,1),je=Fe.lerp(Oe),qe=je.x+$c,pt=je.y+$c;pr.push(qe,pt,F,0);const vt=qe-F,xi=pt-F,bi=qe+F,wi=pt+F;if(Ya=Ya&&this.isOffscreen(vt,xi,bi,wi),Sa=Sa||this.isInsideGrid(vt,xi,bi,wi),!Me&&this.grid.hitTestCircle(qe,pt,F,vi)&&(wa=!0,!Ut))return{circles:[],offscreen:!1,collisionDetected:wa,occluded:!1}}}}return{circles:!Ut&&wa||!Sa?[]:pr,offscreen:Ya,collisionDetected:wa,occluded:zo.occluded}}queryRenderedSymbols(F){if(0===F.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const Me=[];let Ae=1/0,Oe=1/0,Fe=-1/0,je=-1/0;for(const qe of F){const F=new k.P(qe.x+$c,qe.y+$c);Ae=Math.min(Ae,F.x),Oe=Math.min(Oe,F.y),Fe=Math.max(Fe,F.x),je=Math.max(je,F.y),Me.push(F)}const qe=this.grid.query(Ae,Oe,Fe,je).concat(this.ignoredGrid.query(Ae,Oe,Fe,je)),pt={},vt={};for(const F of qe){const Ae=F.key;if(void 0===pt[Ae.bucketInstanceId]&&(pt[Ae.bucketInstanceId]={}),pt[Ae.bucketInstanceId][Ae.featureIndex])continue;const Oe=[new k.P(F.x1,F.y1),new k.P(F.x2,F.y1),new k.P(F.x2,F.y2),new k.P(F.x1,F.y2)];k.bv(Me,Oe)&&(pt[Ae.bucketInstanceId][Ae.featureIndex]=!0,void 0===vt[Ae.bucketInstanceId]&&(vt[Ae.bucketInstanceId]=[]),vt[Ae.bucketInstanceId].push(Ae.featureIndex))}return vt}insertCollisionBox(k,F,Me,Ae,Oe){(F?this.ignoredGrid:this.grid).insert({bucketInstanceId:Me,featureIndex:Ae,collisionGroupID:Oe},k[0],k[1],k[2],k[3])}insertCollisionCircles(k,F,Me,Ae,Oe){const Fe=F?this.ignoredGrid:this.grid,je={bucketInstanceId:Me,featureIndex:Ae,collisionGroupID:Oe};for(let F=0;F<k.length;F+=4)Fe.insertCircle(je,k[F],k[F+1],k[F+2])}projectAndGetPerspectiveRatio(F,Me,Ae,Oe,Fe,je,qe){const pt=[Me,Ae,Oe,1];let vt=!1;if(Oe||this.transform.pitch>0){if(k.ab.vec4.transformMat4(pt,pt,F),this.fogState&&Fe&&"globe"!==qe.name){const F=function(F,Me,Ae,Oe,Fe,je){const qe=je.calculateFogTileMatrix(Fe),pt=[Me,Ae,Oe];return k.ab.vec3.transformMat4(pt,pt,qe),ke(F,k.ab.vec3.length(pt),je.pitch,je._fov)}(this.fogState,Me,Ae,Oe,Fe.toUnwrapped(),this.transform);vt=F>.9}}else ii(pt,pt,F);const Ut=pt[3];return{point:new k.P((pt[0]/Ut+1)/2*this.transform.width+$c,(-pt[1]/Ut+1)/2*this.transform.height+$c),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(qe)/Ut*.5,1.5),signedDistanceFromCamera:Ut,occluded:je&&pt[2]>Ut||vt}}isOffscreen(k,F,Me,Ae){return Me<$c||k>=this.screenRightBoundary||Ae<$c||F>this.screenBottomBoundary}isInsideGrid(k,F,Me,Ae){return Me>=0&&k<this.gridRightBoundary&&Ae>=0&&F<this.gridBottomBoundary}getViewportMatrix(){const F=k.ab.mat4.identity([]);return k.ab.mat4.translate(F,F,[-100,-100,0]),F}}function ri(F,Me,Ae){const Oe=Me.createTileMatrix(F,F.worldSize,Ae.toUnwrapped());return k.ab.mat4.multiply(new Float32Array(16),F.projMatrix,Oe)}function ai(k,F,Me){if(F.projection.name===Me.projection.name)return k.projMatrix;const Ae=Me.clone();return Ae.setProjection(F.projection),ri(Ae,F.getProjection(),k)}function ni(k,F,Me){return F.name===Me.projection.name?k.projMatrix:ri(Me,F,k)}class li{constructor(k,F,Me,Ae){this.opacity=k?Math.max(0,Math.min(1,k.opacity+(k.placed?F:-F))):Ae&&Me?1:0,this.placed=Me}isHidden(){return 0===this.opacity&&!this.placed}}class ci{constructor(k,F,Me,Ae,Oe,Fe=!1){this.text=new li(k?k.text:null,F,Me,Oe),this.icon=new li(k?k.icon:null,F,Ae,Oe),this.clipped=Fe}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class hi{constructor(k,F,Me,Ae=!1){this.text=k,this.icon=F,this.skipFade=Me,this.clipped=Ae}}class ui{constructor(){this.invProjMatrix=k.ab.mat4.create(),this.viewportMatrix=k.ab.mat4.create(),this.circles=[]}}class di{constructor(k,F,Me,Ae,Oe){this.bucketInstanceId=k,this.featureIndex=F,this.sourceLayerIndex=Me,this.bucketIndex=Ae,this.tileID=Oe}}class _i{constructor(k){this.crossSourceCollisions=k,this.maxGroupID=0,this.collisionGroups={}}get(k){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[k]){const F=++this.maxGroupID;this.collisionGroups[k]={ID:F,predicate:k=>k.collisionGroupID===F}}return this.collisionGroups[k]}}function pi(F,Me,Ae,Oe,Fe){const{horizontalAlign:je,verticalAlign:qe}=k.bD(F),pt=-(je-.5)*Me,vt=-(qe-.5)*Ae,Ut=k.bC(F,Oe);return new k.P(pt+Ut[0]*Fe,vt+Ut[1]*Fe)}function fi(F,Me,Ae,Oe,Fe){const je=new k.P(F,Me);return Ae&&je._rotate(Oe?Fe:-Fe),je}class mi{constructor(k,F,Me,Ae,Oe,Fe){this.transform=k.clone(),this.projection=k.projection.name,this.collisionIndex=new si(this.transform,Oe),this.buildingIndex=Fe,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=F,this.retainedQueryData={},this.collisionGroups=new _i(Me),this.collisionCircleArrays={},this.prevPlacement=Ae,Ae&&(Ae.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(F,Me,Ae,Oe,Fe=1){const je=Ae.getBucket(Me),qe=Ae.latestFeatureIndex;if(!je||!qe||Me.fqid!==je.layerIds[0])return;const pt=je.layers[0].layout,vt=je.layers[0].paint,Ut=Ae.collisionBoxArray,xi=Math.pow(2,this.transform.zoom-Ae.tileID.overscaledZ),vi=Ae.tileSize/k.ag,bi=Ae.tileID.toUnwrapped();this.transform.setProjection(je.projection);const wi=(Mi=Ae.tileID,pr=je.getProjection(),Ur=this.transform,pr.name===this.projection?Ur.calculateProjMatrix(Mi.toUnwrapped()):ri(Ur,pr,Mi));var Mi,pr,Ur;const Wr="map"===pt.get("text-pitch-alignment"),Jr="map"===pt.get("text-rotation-alignment");Me.compileFilter(Me.options);const Qr=Me.dynamicFilter(),co=Me.dynamicFilterNeedsFeature(),mo=this.transform.calculatePixelsToTileUnitsMatrix(Ae),yo=Vt(wi,Ae.tileID.canonical,Wr,Jr,this.transform,je.getProjection(),mo);let To=null;if(Wr){const F=qt(wi,Ae.tileID.canonical,Wr,Jr,this.transform,je.getProjection(),mo);To=k.ab.mat4.multiply([],this.transform.labelPlaneMatrix,F)}let zo=null;Qr&&Ae.latestFeatureIndex&&(zo={unwrappedTileID:bi,dynamicFilter:Qr,dynamicFilterNeedsFeature:co}),this.retainedQueryData[je.bucketInstanceId]=new di(je.bucketInstanceId,qe,je.sourceLayerIndex,je.index,Ae.tileID);const[ko,na]=je.layers[0].layout.get("text-size-scale-range"),aa=k.aw(Fe,ko,na),[_a,wa]=pt.get("icon-size-scale-range"),Sa=k.aw(Fe,_a,wa),Ya={bucket:je,layout:pt,paint:vt,posMatrix:wi,textLabelPlaneMatrix:yo,labelToScreenMatrix:To,clippingData:zo,scale:xi,textPixelRatio:vi,holdingForFade:Ae.holdingForFade(),collisionBoxArray:Ut,partiallyEvaluatedTextSize:k.bp(je.textSizeData,this.transform.zoom,aa),partiallyEvaluatedIconSize:k.bp(je.iconSizeData,this.transform.zoom,Sa),collisionGroup:this.collisionGroups.get(je.sourceID),latestFeatureIndex:Ae.latestFeatureIndex};if(Oe)for(const k of je.sortKeyRanges){const{sortKey:Me,symbolInstanceStart:Ae,symbolInstanceEnd:Oe}=k;F.push({sortKey:Me,symbolInstanceStart:Ae,symbolInstanceEnd:Oe,parameters:Ya})}else F.push({symbolInstanceStart:0,symbolInstanceEnd:je.symbolInstances.length,parameters:Ya})}attemptAnchorPlacement(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur){const{textOffset0:Wr,textOffset1:Jr,crossTileID:Qr}=xi,co=[Wr,Jr],mo=pi(k,Me,Ae,co,Oe),yo=this.collisionIndex.placeCollisionBox(bi,Oe,F,fi(mo.x,mo.y,Fe,je,this.transform.angle),Ut,qe,pt,vt.predicate);if(Mi){const k=bi.getSymbolInstanceIconSize(Ur,this.transform.zoom,xi.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(bi,k,Mi,fi(mo.x,mo.y,Fe,je,this.transform.angle),Ut,qe,pt,vt.predicate).box.length)return}if(yo.box.length>0){let F;return this.prevPlacement&&this.prevPlacement.variableOffsets[Qr]&&this.prevPlacement.placements[Qr]&&this.prevPlacement.placements[Qr].text&&(F=this.prevPlacement.variableOffsets[Qr].anchor),this.variableOffsets[Qr]={textOffset:co,width:Me,height:Ae,anchor:k,textScale:Oe,prevAnchor:F},this.markUsedJustification(bi,k,xi,wi),bi.allowVerticalPlacement&&(this.markUsedOrientation(bi,wi,xi),this.placedOrientations[Qr]=wi),{shift:mo,placedGlyphBoxes:yo}}}placeLayerBucketPart(F,Me,Ae,Oe,Fe=1){const{bucket:je,layout:qe,paint:pt,posMatrix:vt,textLabelPlaneMatrix:Ut,labelToScreenMatrix:xi,clippingData:vi,textPixelRatio:bi,holdingForFade:wi,collisionBoxArray:Mi,partiallyEvaluatedTextSize:pr,partiallyEvaluatedIconSize:Ur,collisionGroup:Wr,latestFeatureIndex:Jr}=F.parameters,Qr=qe.get("text-optional"),co=qe.get("icon-optional"),mo=qe.get("text-allow-overlap"),yo=qe.get("icon-allow-overlap"),To="map"===qe.get("text-rotation-alignment"),zo="map"===qe.get("text-pitch-alignment"),ko=qe.get("symbol-z-elevate"),na=pt.get("symbol-z-offset"),aa="sea"===qe.get("symbol-elevation-reference"),[_a,wa]=qe.get("text-size-scale-range"),[Sa,Ya]=qe.get("icon-size-scale-range"),rl=k.aw(Fe,_a,wa),sl=k.aw(Fe,Sa,Ya);this.transform.setProjection(je.projection);let ml=mo&&(yo||!je.hasIconData()||co),Sl=yo&&(mo||!je.hasTextData()||Qr);const Il=!na.isConstant();!je.collisionArrays&&Mi&&je.deserializeCollisionBoxes(Mi),Ae&&Oe&&je.updateCollisionDebugBuffers(this.transform.zoom,Mi,rl,sl);const B=(F,Oe,pt)=>{const{crossTileID:Mi,numVerticalGlyphVertices:ko}=F;let _a=null;if(vi&&vi.dynamicFilterNeedsFeature||Il){const k=this.retainedQueryData[je.bucketInstanceId];_a=Jr.loadFeature({featureIndex:F.featureIndex,bucketIndex:k.bucketIndex,sourceLayerIndex:k.sourceLayerIndex,layoutVertexArrayOffset:0})}if(vi&&!(0,vi.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},_a,this.retainedQueryData[je.bucketInstanceId].tileID.canonical,new k.P(F.tileAnchorX,F.tileAnchorY),this.transform.calculateDistanceTileData(vi.unwrappedTileID)))return this.placements[Mi]=new hi(!1,!1,!1,!0),void Me.add(Mi);const wa=na.evaluate(_a,{});if(Me.has(Mi))return;if(wi)return void(this.placements[Mi]=new hi(!1,!1,!1));let Sa=!1,Ya=!1,rl=!0,sl=!1,Kl=!1,Jl=null,Ql={box:null,offscreen:null,occluded:null},ec={box:null,offscreen:null,occluded:null},tc=null,cc=null,uc=null,jc=0,Gc=0,qc=0;pt.textFeatureIndex?jc=pt.textFeatureIndex:F.useRuntimeCollisionCircles&&(jc=F.featureIndex),pt.verticalTextFeatureIndex&&(Gc=pt.verticalTextFeatureIndex);const $=k=>{k.tileID=this.retainedQueryData[je.bucketInstanceId].tileID;const Me=this.transform.elevation;k.elevation=aa?wa:wa+(Me?Me.getAtTileOffset(k.tileID,k.tileAnchorX,k.tileAnchorY):0),k.elevation+=F.zOffset},Hc=pt.textBox;if(Hc){$(Hc);const i=Me=>{let Ae=k.bq.horizontal;if(je.allowVerticalPlacement&&!Me&&this.prevPlacement){const k=this.prevPlacement.placedOrientations[Mi];k&&(this.placedOrientations[Mi]=k,Ae=k,this.markUsedOrientation(je,Ae,F))}return Ae},o=(F,Me)=>{if(je.allowVerticalPlacement&&ko>0&&pt.verticalTextBox){for(const Ae of je.writingModes)if(Ae===k.bq.vertical?(Ql=Me(),ec=Ql):Ql=F(),Ql&&Ql.box&&Ql.box.length)break}else Ql=F()};if(qe.get("text-variable-anchor")){let Me=qe.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Mi]){const k=this.prevPlacement.variableOffsets[Mi];Me.indexOf(k.anchor)>0&&(Me=Me.filter((F=>F!==k.anchor)),Me.unshift(k.anchor))}const h=(k,Ae,Fe)=>{const qe=je.getSymbolInstanceTextSize(pr,F,this.transform.zoom,Oe),pt=(k.x2-k.x1)*qe+2*k.padding,Ut=(k.y2-k.y1)*qe+2*k.padding,xi=F.hasIconTextFit&&!yo?Ae:null;xi&&$(xi);let vi={box:[],offscreen:!1,occluded:!1};const wi=mo?2*Me.length:Me.length;for(let Ae=0;Ae<wi;++Ae){const wi=this.attemptAnchorPlacement(Me[Ae%Me.length],k,pt,Ut,qe,To,zo,bi,vt,Wr,Ae>=Me.length,F,Oe,je,Fe,xi,pr,Ur);if(wi&&(vi=wi.placedGlyphBoxes,vi&&vi.box&&vi.box.length)){Sa=!0,Jl=wi.shift;break}}return vi};o((()=>h(Hc,pt.iconBox,k.bq.horizontal)),(()=>{const F=pt.verticalTextBox;return F&&$(F),je.allowVerticalPlacement&&!(Ql&&Ql.box&&Ql.box.length)&&ko>0&&F?h(F,pt.verticalIconBox,k.bq.vertical):{box:null,offscreen:null,occluded:null}})),Ql&&(Sa=Ql.box,rl=Ql.offscreen,sl=Ql.occluded);const Ae=i(!(!Ql||!Ql.box));if(!Sa&&this.prevPlacement){const k=this.prevPlacement.variableOffsets[Mi];k&&(this.variableOffsets[Mi]=k,this.markUsedJustification(je,k.anchor,F,Ae))}}else{const n=(Me,Ae)=>{const qe=je.getSymbolInstanceTextSize(pr,F,this.transform.zoom,Oe,Fe),pt=this.collisionIndex.placeCollisionBox(je,qe,Me,new k.P(0,0),mo,bi,vt,Wr.predicate);return pt&&pt.box&&pt.box.length&&(this.markUsedOrientation(je,Ae,F),this.placedOrientations[Mi]=Ae),pt};o((()=>n(Hc,k.bq.horizontal)),(()=>{const F=pt.verticalTextBox;return je.allowVerticalPlacement&&ko>0&&F?($(F),n(F,k.bq.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(Ql&&Ql.box&&Ql.box.length))}}if(tc=Ql,Sa=tc&&tc.box&&tc.box.length>0,rl=tc&&tc.offscreen,sl=tc&&tc.occluded,F.useRuntimeCollisionCircles){const Me=je.text.placedSymbolArray.get(F.centerJustifiedTextSymbolIndex>=0?F.centerJustifiedTextSymbolIndex:F.verticalPlacedTextSymbolIndex),Oe=k.br(je.textSizeData,pr,Me),Fe=qe.get("text-padding");cc=this.collisionIndex.placeCollisionCircles(je,mo,Me,je.lineVertexArray,je.glyphOffsetArray,Oe,vt,Ut,xi,Ae,zo,Wr.predicate,F.collisionCircleDiameter*Oe/k.bw,Fe,this.retainedQueryData[je.bucketInstanceId].tileID),Sa=mo||cc.circles.length>0&&!cc.collisionDetected,rl=rl&&cc.offscreen,sl=cc.occluded}if(pt.iconFeatureIndex&&(qc=pt.iconFeatureIndex),pt.iconBox){const i=Me=>{$(Me);const Ae=F.hasIconTextFit&&Jl?fi(Jl.x,Jl.y,To,zo,this.transform.angle):new k.P(0,0),Oe=je.getSymbolInstanceIconSize(Ur,this.transform.zoom,F.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(je,Oe,Me,Ae,yo,bi,vt,Wr.predicate)};ec&&ec.box&&ec.box.length&&pt.verticalIconBox?(uc=i(pt.verticalIconBox),Ya=uc.box.length>0):(uc=i(pt.iconBox),Ya=uc.box.length>0),rl=rl&&uc.offscreen,Kl=uc.occluded}const $c=Qr||0===F.numHorizontalGlyphVertices&&0===ko,Wc=co||0===F.numIconVertices;if($c||Wc?Wc?$c||(Ya=Ya&&Sa):Sa=Ya&&Sa:Ya=Sa=Ya&&Sa,Sa&&tc&&tc.box&&this.collisionIndex.insertCollisionBox(tc.box,qe.get("text-ignore-placement"),je.bucketInstanceId,ec&&ec.box&&Gc?Gc:jc,Wr.ID),Ya&&uc&&this.collisionIndex.insertCollisionBox(uc.box,qe.get("icon-ignore-placement"),je.bucketInstanceId,qc,Wr.ID),cc&&(Sa&&this.collisionIndex.insertCollisionCircles(cc.circles,qe.get("text-ignore-placement"),je.bucketInstanceId,jc,Wr.ID),Ae)){const k=je.bucketInstanceId;let F=this.collisionCircleArrays[k];void 0===F&&(F=this.collisionCircleArrays[k]=new ui);for(let k=0;k<cc.circles.length;k+=4)F.circles.push(cc.circles[k+0]),F.circles.push(cc.circles[k+1]),F.circles.push(cc.circles[k+2]),F.circles.push(cc.collisionDetected?1:0)}const Kc="globe"!==je.projection.name;ml=ml&&(Kc||!sl),Sl=Sl&&(Kc||!Kl),this.placements[Mi]=new hi(Sa||ml,Ya||Sl,rl||je.justReloaded),Me.add(Mi)};if(ko&&this.buildingIndex&&(this.buildingIndex.updateZOffset(je,this.retainedQueryData[je.bucketInstanceId].tileID),je.updateZOffset()),je.sortFeaturesByY){const F=je.getSortedSymbolIndexes(this.transform.angle);for(let k=F.length-1;k>=0;--k){const Me=F[k];B(je.symbolInstances.get(Me),Me,je.collisionArrays[Me])}je.hasAnyZOffset&&k.w(`${je.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(je.hasAnyZOffset){const k=je.getSortedIndexesByZOffset();for(let F=0;F<k.length;++F){const Me=k[F];B(je.symbolInstances.get(Me),Me,je.collisionArrays[Me])}}else for(let k=F.symbolInstanceStart;k<F.symbolInstanceEnd;k++)B(je.symbolInstances.get(k),k,je.collisionArrays[k]);if(Ae&&je.bucketInstanceId in this.collisionCircleArrays){const F=this.collisionCircleArrays[je.bucketInstanceId];k.ab.mat4.invert(F.invProjMatrix,vt),F.viewportMatrix=this.collisionIndex.getViewportMatrix()}je.justReloaded=!1}markUsedJustification(F,Me,Ae,Oe){const{leftJustifiedTextSymbolIndex:Fe,centerJustifiedTextSymbolIndex:je,rightJustifiedTextSymbolIndex:qe,verticalPlacedTextSymbolIndex:pt,crossTileID:vt}=Ae,Ut=k.bB(Me),xi=Oe===k.bq.vertical?pt:"left"===Ut?Fe:"center"===Ut?je:"right"===Ut?qe:-1;Fe>=0&&(F.text.placedSymbolArray.get(Fe).crossTileID=xi>=0&&Fe!==xi?0:vt),je>=0&&(F.text.placedSymbolArray.get(je).crossTileID=xi>=0&&je!==xi?0:vt),qe>=0&&(F.text.placedSymbolArray.get(qe).crossTileID=xi>=0&&qe!==xi?0:vt),pt>=0&&(F.text.placedSymbolArray.get(pt).crossTileID=xi>=0&&pt!==xi?0:vt)}markUsedOrientation(F,Me,Ae){const Oe=Me===k.bq.horizontal||Me===k.bq.horizontalOnly?Me:0,Fe=Me===k.bq.vertical?Me:0,{leftJustifiedTextSymbolIndex:je,centerJustifiedTextSymbolIndex:qe,rightJustifiedTextSymbolIndex:pt,verticalPlacedTextSymbolIndex:vt}=Ae,Ut=F.text.placedSymbolArray;je>=0&&(Ut.get(je).placedOrientation=Oe),qe>=0&&(Ut.get(qe).placedOrientation=Oe),pt>=0&&(Ut.get(pt).placedOrientation=Oe),vt>=0&&(Ut.get(vt).placedOrientation=Fe)}commit(k){this.commitTime=k,this.zoomAtLastRecencyCheck=this.transform.zoom;const F=this.prevPlacement;let Me=!1;this.prevZoomAdjustment=F?F.zoomAdjustment(this.transform.zoom):0;const Ae=F?F.symbolFadeChange(k):1,Oe=F?F.opacities:{},Fe=F?F.variableOffsets:{},je=F?F.placedOrientations:{};for(const k in this.placements){const F=this.placements[k],Fe=Oe[k];Fe?(this.opacities[k]=new ci(Fe,Ae,F.text,F.icon,null,F.clipped),Me=Me||F.text!==Fe.text.placed||F.icon!==Fe.icon.placed):(this.opacities[k]=new ci(null,Ae,F.text,F.icon,F.skipFade,F.clipped),Me=Me||F.text||F.icon)}for(const k in Oe){const F=Oe[k];if(!this.opacities[k]){const Oe=new ci(F,Ae,!1,!1);Oe.isHidden()||(this.opacities[k]=Oe,Me=Me||F.text.placed||F.icon.placed)}}for(const k in Fe)this.variableOffsets[k]||!this.opacities[k]||this.opacities[k].isHidden()||(this.variableOffsets[k]=Fe[k]);for(const k in je)this.placedOrientations[k]||!this.opacities[k]||this.opacities[k].isHidden()||(this.placedOrientations[k]=je[k]);Me?this.lastPlacementChangeTime=k:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=F?F.lastPlacementChangeTime:k)}updateLayerOpacities(k,F,Me,Ae){const Oe=new Set;for(const Fe of F){const F=Fe.getBucket(k);F&&Fe.latestFeatureIndex&&k.fqid===F.layerIds[0]&&(this.updateBucketOpacities(F,Oe,Fe,Fe.collisionBoxArray,Me,Ae,Fe.tileID,k.scope),F.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(F,Fe.tileID),F.updateZOffset()))}}updateBucketOpacities(F,Me,Ae,Oe,Fe,je,qe,pt){F.hasTextData()&&F.text.opacityVertexArray.clear(),F.hasIconData()&&F.icon.opacityVertexArray.clear(),F.hasIconCollisionBoxData()&&F.iconCollisionBox.collisionVertexArray.clear(),F.hasTextCollisionBoxData()&&F.textCollisionBox.collisionVertexArray.clear();const vt=F.layers[0].layout,Ut=F.layers[0].paint,xi=!!F.layers[0].dynamicFilter(),vi=new ci(null,0,!1,!1,!0),bi=vt.get("text-allow-overlap"),wi=vt.get("icon-allow-overlap"),Mi=vt.get("text-variable-anchor"),pr="map"===vt.get("text-rotation-alignment"),Ur="map"===vt.get("text-pitch-alignment"),Wr=Ut.get("symbol-z-offset"),Jr="sea"===vt.get("symbol-elevation-reference"),Qr=!Wr.isConstant(),co=new ci(null,0,bi&&(wi||!F.hasIconData()||vt.get("icon-optional")),wi&&(bi||!F.hasTextData()||vt.get("text-optional")),!0);!F.collisionArrays&&Oe&&(F.hasIconCollisionBoxData()||F.hasTextCollisionBoxData())&&F.deserializeCollisionBoxes(Oe);const w=(k,F,Me)=>{for(let Ae=0;Ae<F/4;Ae++)k.opacityVertexArray.emplaceBack(Me)};let mo=0;je&&F.updateReplacement(qe,je);for(let Oe=0;Oe<F.symbolInstances.length;Oe++){const vt=F.symbolInstances.get(Oe),{numHorizontalGlyphVertices:Ut,numVerticalGlyphVertices:bi,crossTileID:wi,numIconVertices:yo,tileAnchorX:To,tileAnchorY:zo}=vt;let ko=null;const na=this.retainedQueryData[F.bucketInstanceId];Qr&&vt&&na&&(ko=Ae.latestFeatureIndex.loadFeature({featureIndex:vt.featureIndex,bucketIndex:na.bucketIndex,sourceLayerIndex:na.sourceLayerIndex,layoutVertexArrayOffset:0}));const aa=Wr.evaluate(ko,{}),_a=Me.has(wi);let wa=this.opacities[wi];_a?wa=vi:wa||(wa=co,this.opacities[wi]=wa),Me.add(wi);const Sa=Ut>0||bi>0,Ya=yo>0,rl=this.placedOrientations[wi],sl=rl===k.bq.vertical,ml=rl===k.bq.horizontal||rl===k.bq.horizontalOnly;!Sa&&!Ya||wa.isHidden()||mo++;let Sl=!1;if((Sa||Ya)&&je)for(const Me of F.activeReplacements){if(k.bx(Me,Fe,k.by.Symbol,pt))continue;if(Me.min.x>To||To>Me.max.x||Me.min.y>zo||zo>Me.max.y)continue;const F=k.bz(To,zo,qe.canonical,Me.footprintTileId.canonical);if(Sl=k.bA(F,Me.footprint),Sl)break}if(Sa){const k=Sl?rh:Si(wa.text);w(F.text,Ut,sl?rh:k),w(F.text,bi,ml?rh:k);const Me=wa.text.isHidden(),{leftJustifiedTextSymbolIndex:Ae,centerJustifiedTextSymbolIndex:Oe,rightJustifiedTextSymbolIndex:Fe,verticalPlacedTextSymbolIndex:je}=vt,qe=F.text.placedSymbolArray,pt=Me||sl?1:0;Ae>=0&&(qe.get(Ae).hidden=pt),Oe>=0&&(qe.get(Oe).hidden=pt),Fe>=0&&(qe.get(Fe).hidden=pt),je>=0&&(qe.get(je).hidden=Me||ml?1:0);const xi=this.variableOffsets[wi];xi&&this.markUsedJustification(F,xi.anchor,vt,rl);const vi=this.placedOrientations[wi];vi&&(this.markUsedJustification(F,"left",vt,vi),this.markUsedOrientation(F,vi,vt))}if(Ya){const k=Sl?rh:Si(wa.icon),{placedIconSymbolIndex:Me,verticalPlacedIconSymbolIndex:Ae}=vt,Oe=F.icon.placedSymbolArray,Fe=wa.icon.isHidden()?1:0;Me>=0&&(w(F.icon,yo,sl?rh:k),Oe.get(Me).hidden=Fe),Ae>=0&&(w(F.icon,vt.numVerticalIconVertices,ml?rh:k),Oe.get(Ae).hidden=Fe)}if(F.hasIconCollisionBoxData()||F.hasTextCollisionBoxData()){const Me=F.collisionArrays[Oe];if(Me){let Ae=new k.P(0,0),Oe=!0;if(Me.textBox||Me.verticalTextBox){if(Mi){const k=this.variableOffsets[wi];k?(Ae=pi(k.anchor,k.width,k.height,k.textOffset,k.textScale),pr&&Ae._rotate(Ur?this.transform.angle:-this.transform.angle)):Oe=!1}xi&&(Oe=!wa.clipped),Me.textBox&&gi(F.textCollisionBox.collisionVertexArray,wa.text.placed,!Oe||sl,aa,Jr,Ae.x,Ae.y),Me.verticalTextBox&&gi(F.textCollisionBox.collisionVertexArray,wa.text.placed,!Oe||ml,aa,Jr,Ae.x,Ae.y)}const Fe=Oe&&Boolean(!ml&&Me.verticalIconBox);Me.iconBox&&gi(F.iconCollisionBox.collisionVertexArray,wa.icon.placed,Fe,aa,Jr,vt.hasIconTextFit?Ae.x:0,vt.hasIconTextFit?Ae.y:0),Me.verticalIconBox&&gi(F.iconCollisionBox.collisionVertexArray,wa.icon.placed,!Fe,aa,Jr,vt.hasIconTextFit?Ae.x:0,vt.hasIconTextFit?Ae.y:0)}}}if(F.fullyClipped=0===mo,F.sortFeatures(this.transform.angle),this.retainedQueryData[F.bucketInstanceId]&&(this.retainedQueryData[F.bucketInstanceId].featureSortOrder=F.featureSortOrder),F.hasTextData()&&F.text.opacityVertexBuffer&&F.text.opacityVertexBuffer.updateData(F.text.opacityVertexArray),F.hasIconData()&&F.icon.opacityVertexBuffer&&F.icon.opacityVertexBuffer.updateData(F.icon.opacityVertexArray),F.hasIconCollisionBoxData()&&F.iconCollisionBox.collisionVertexBuffer&&F.iconCollisionBox.collisionVertexBuffer.updateData(F.iconCollisionBox.collisionVertexArray),F.hasTextCollisionBoxData()&&F.textCollisionBox.collisionVertexBuffer&&F.textCollisionBox.collisionVertexBuffer.updateData(F.textCollisionBox.collisionVertexArray),F.bucketInstanceId in this.collisionCircleArrays){const k=this.collisionCircleArrays[F.bucketInstanceId];F.placementInvProjMatrix=k.invProjMatrix,F.placementViewportMatrix=k.viewportMatrix,F.collisionCircleArray=k.circles,delete this.collisionCircleArrays[F.bucketInstanceId]}}symbolFadeChange(k){return 0===this.fadeDuration?1:(k-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(k){return Math.max(0,(this.transform.zoom-k)/1.5)}hasTransitions(k){return this.stale||k-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(k,F){const Me=this.zoomAtLastRecencyCheck===F?1-this.zoomAdjustment(F):1;return this.zoomAtLastRecencyCheck=F,this.commitTime+this.fadeDuration*Me>k}setStale(){this.stale=!0}}function gi(k,F,Me,Ae,Oe,Fe,je){k.emplaceBack(F?1:0,Me?1:0,Fe||0,je||0,Ae,Oe?1:0),k.emplaceBack(F?1:0,Me?1:0,Fe||0,je||0,Ae,Oe?1:0),k.emplaceBack(F?1:0,Me?1:0,Fe||0,je||0,Ae,Oe?1:0),k.emplaceBack(F?1:0,Me?1:0,Fe||0,je||0,Ae,Oe?1:0)}const Wc=Math.pow(2,25),Kc=Math.pow(2,24),Jc=Math.pow(2,17),Qc=Math.pow(2,16),eh=Math.pow(2,9),th=Math.pow(2,8),ih=Math.pow(2,1);function Si(k){if(0===k.opacity&&!k.placed)return 0;if(1===k.opacity&&k.placed)return 4294967295;const F=k.placed?1:0,Me=Math.floor(127*k.opacity);return Me*Wc+F*Kc+Me*Jc+F*Qc+Me*eh+F*th+Me*ih+F}const rh=0;class Ii{constructor(k){this._sortAcrossTiles="viewport-y"!==k.layout.get("symbol-z-order")&&void 0!==k.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(k,F,Me,Ae,Oe,Fe){const je=this._bucketParts;for(;this._currentTileIndex<k.length;)if(F.getBucketParts(je,Ae,k[this._currentTileIndex],this._sortAcrossTiles,Fe),this._currentTileIndex++,Oe())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,je.sort(((k,F)=>k.sortKey-F.sortKey)));this._currentPartIndex<je.length;){const k=je[this._currentPartIndex];if(F.placeLayerBucketPart(k,this._seenCrossTileIDs,Me,0===k.symbolInstanceStart,Fe),this._currentPartIndex++,Oe())return!0}return!1}}class Ri{constructor(k,F,Me,Ae,Oe,Fe,je,qe,pt){this.placement=new mi(k,Oe,Fe,je,qe,pt),this._currentPlacementIndex=F.length-1,this._forceFullPlacement=Me,this._showCollisionBoxes=Ae,this._done=!1}isDone(){return this._done}continuePlacement(F,Me,Ae,Oe,Fe){const je=k.q.now(),n=()=>{const F=k.q.now()-je;return!this._forceFullPlacement&&F>2};for(;this._currentPlacementIndex>=0;){const je=Me[F[this._currentPlacementIndex]],qe=this.placement.collisionIndex.transform.zoom;if("symbol"===je.type&&(!je.minzoom||je.minzoom<=qe)&&(!je.maxzoom||je.maxzoom>qe)){const F=je,Me=F.layout.get("symbol-z-elevate"),qe=void 0!==F.layout.get("symbol-sort-key").constantOr(1),pt=F.layout.get("symbol-z-order"),vt="viewport-y"===pt||"auto"===pt&&!("viewport-y"!==pt&&qe),Ut=F.layout.get("text-allow-overlap")||F.layout.get("icon-allow-overlap")||F.layout.get("text-ignore-placement")||F.layout.get("icon-ignore-placement"),xi=vt&&Ut,vi=this._inProgressLayer=this._inProgressLayer||new Ii(F),bi=k.aC(je.source,je.scope);if(vi.continuePlacement(Me||xi?Oe[bi]:Ae[bi],this.placement,this._showCollisionBoxes,je,n,Fe))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(k){return this.placement.commit(k),this.placement}}const nh=512/k.ag/2;class Li{constructor(F,Me,Ae){this.tileID=F,this.bucketInstanceId=Ae,this.index=new k.bE(Me.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const Oe=F.canonical.x*k.ag,Fe=F.canonical.y*k.ag;for(let k=0;k<Me.length;k++){const{key:F,crossTileID:Ae,tileAnchorX:je,tileAnchorY:qe}=Me.get(k),pt=Math.floor((Oe+je)*nh),vt=Math.floor((Fe+qe)*nh);this.index.add(pt,vt),this.keys.push(F),this.crossTileIDs.push(Ae)}this.index.finish()}findMatches(F,Me,Ae){const Oe=this.tileID.canonical.z<Me.canonical.z?1:Math.pow(2,this.tileID.canonical.z-Me.canonical.z),Fe=nh/Math.pow(2,Me.canonical.z-this.tileID.canonical.z),je=Me.canonical.x*k.ag,qe=Me.canonical.y*k.ag;for(let k=0;k<F.length;k++){const Me=F.get(k);if(Me.crossTileID)continue;const{key:pt,tileAnchorX:vt,tileAnchorY:Ut}=Me,xi=Math.floor((je+vt)*Fe),vi=Math.floor((qe+Ut)*Fe),bi=this.index.range(xi-Oe,vi-Oe,xi+Oe,vi+Oe);for(const k of bi){const F=this.crossTileIDs[k];if(this.keys[k]===pt&&!Ae.has(F)){Ae.add(F),Me.crossTileID=F;break}}}}}class Ai{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class zi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(k){const F=Math.round((k-this.lng)/360);if(0!==F)for(const k in this.indexes){const Me=this.indexes[k],Ae={};for(const k in Me){const Oe=Me[k];Oe.tileID=Oe.tileID.unwrapTo(Oe.tileID.wrap+F),Ae[Oe.tileID.key]=Oe}this.indexes[k]=Ae}this.lng=k}addBucket(k,F,Me){if(this.indexes[k.overscaledZ]&&this.indexes[k.overscaledZ][k.key]){if(this.indexes[k.overscaledZ][k.key].bucketInstanceId===F.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(k.overscaledZ,this.indexes[k.overscaledZ][k.key])}for(let k=0;k<F.symbolInstances.length;k++)F.symbolInstances.get(k).crossTileID=0;this.usedCrossTileIDs[k.overscaledZ]||(this.usedCrossTileIDs[k.overscaledZ]=new Set);const Ae=this.usedCrossTileIDs[k.overscaledZ];for(const Me in this.indexes){const Oe=this.indexes[Me];if(Number(Me)>k.overscaledZ)for(const Me in Oe){const Fe=Oe[Me];Fe.tileID.isChildOf(k)&&Fe.findMatches(F.symbolInstances,k,Ae)}else{const Fe=Oe[k.scaledTo(Number(Me)).key];Fe&&Fe.findMatches(F.symbolInstances,k,Ae)}}for(let k=0;k<F.symbolInstances.length;k++){const Oe=F.symbolInstances.get(k);Oe.crossTileID||(Oe.crossTileID=Me.generate(),Ae.add(Oe.crossTileID))}return void 0===this.indexes[k.overscaledZ]&&(this.indexes[k.overscaledZ]={}),this.indexes[k.overscaledZ][k.key]=new Li(k,F.symbolInstances,F.bucketInstanceId),!0}removeBucketCrossTileIDs(k,F){for(const Me of F.crossTileIDs)this.usedCrossTileIDs[k].delete(Me)}removeStaleBuckets(k){let F=!1;for(const Me in this.indexes){const Ae=this.indexes[Me];for(const Oe in Ae)k[Ae[Oe].bucketInstanceId]||(this.removeBucketCrossTileIDs(Me,Ae[Oe]),delete Ae[Oe],F=!0)}return F}}class Pi{constructor(){this.layerIndexes={},this.crossTileIDs=new Ai,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(k,F,Me,Ae){let Oe=this.layerIndexes[k.fqid];void 0===Oe&&(Oe=this.layerIndexes[k.fqid]=new zi);let Fe=!1;const je={};"globe"!==Ae.name&&Oe.handleWrapJump(Me);for(const Me of F){const F=Me.getBucket(k);F&&k.fqid===F.layerIds[0]&&(F.bucketInstanceId||(F.bucketInstanceId=++this.maxBucketInstanceId),Oe.addBucket(Me.tileID,F,this.crossTileIDs)&&(Fe=!0),je[F.bucketInstanceId]=!0)}return Oe.removeStaleBuckets(je)&&(Fe=!0),Fe}pruneUnusedLayers(k){const F={};k.forEach((k=>{F[k]=!0}));for(const k in this.layerIndexes)F[k]||delete this.layerIndexes[k]}}const oh=771;class Oi{constructor(k,F,Me,Ae){this.blendFunction=k,this.blendColor=F,this.mask=Me,this.blendEquation=Ae}}Oi.Replace=[1,0,1,0],Oi.disabled=new Oi(Oi.Replace,k.aj.transparent,[!1,!1,!1,!1]),Oi.unblended=new Oi(Oi.Replace,k.aj.transparent,[!0,!0,!0,!0]),Oi.alphaBlended=new Oi([1,oh,1,oh],k.aj.transparent,[!0,!0,!0,!0]),Oi.alphaBlendedNonPremultiplied=new Oi([770,oh,770,oh],k.aj.transparent,[!0,!0,!0,!0]),Oi.multiply=new Oi([774,0,774,0],k.aj.transparent,[!0,!0,!0,!0]);class Fi{constructor(k,F,Me){this.func=k,this.mask=F,this.range=Me}}Fi.ReadOnly=!1,Fi.ReadWrite=!0,Fi.disabled=new Fi(519,Fi.ReadOnly,[0,1]);const sh=7680;class Bi{constructor(k,F,Me,Ae,Oe,Fe){this.test=k,this.ref=F,this.mask=Me,this.fail=Ae,this.depthFail=Oe,this.pass=Fe}}Bi.disabled=new Bi({func:519,mask:0},0,0,sh,sh,sh);const ah=1029,lh=2305;class Gi{constructor(k,F,Me){this.enable=k,this.mode=F,this.frontFace=Me}}function ji(F,Me){const Ae=k.bG(F,3);k.ab.mat4.fromQuat(F,Me),k.bI(F,3,Ae)}function Vi(F,Me){const Ae=k.ab.quat.identity([]);return k.ab.quat.rotateZ(Ae,Ae,-Me),k.ab.quat.rotateX(Ae,Ae,-F),Ae}function qi(F,Me){const Ae=[F[0],F[1],0],Oe=[Me[0],Me[1],0];if(k.ab.vec3.length(Ae)>=1e-15){const F=k.ab.vec3.normalize([],Ae);k.ab.vec3.scale(Oe,F,k.ab.vec3.dot(Oe,F)),Me[0]=Oe[0],Me[1]=Oe[1]}const Fe=k.ab.vec3.cross([],Me,F);if(k.ab.vec3.len(Fe)<1e-15)return null;const je=Math.atan2(-Fe[1],Fe[0]);return Vi(Math.atan2(Math.sqrt(F[0]*F[0]+F[1]*F[1]),-F[2]),je)}Gi.disabled=new Gi(!1,ah,lh),Gi.backCCW=new Gi(!0,ah,lh),Gi.backCW=new Gi(!0,ah,2304),Gi.frontCW=new Gi(!0,1028,2304),Gi.frontCCW=new Gi(!0,1028,lh);class Hi{constructor(k,F){this.position=k,this.orientation=F}get position(){return this._position}set position(F){if(F){const Me=F instanceof k.aa?F:new k.aa(F[0],F[1],F[2]);this._renderWorldCopies&&(Me.x=k.bF(Me.x,0,1)),this._position=Me}else this._position=null}lookAtPoint(F,Me){if(this.orientation=null,!this.position)return;const Ae=this.position,Oe=this._elevation?this._elevation.getAtPointOrZero(k.aa.fromLngLat(F)):0,Fe=k.aa.fromLngLat(F,Oe),je=[Fe.x-Ae.x,Fe.y-Ae.y,Fe.z-Ae.z];Me||(Me=[0,0,1]),Me[2]=Math.abs(Me[2]),this.orientation=qi(je,Me)}setPitchBearing(F,Me){this.orientation=Vi(k.ai(F),k.ai(-Me))}}class Zi{constructor(F,Me){this._transform=k.ab.mat4.identity([]),this.orientation=Me,this.position=F}get mercatorPosition(){const F=this.position;return new k.aa(F[0],F[1],F[2])}get position(){const F=k.bG(this._transform,3);return[F[0],F[1],F[2]]}set position(F){var Me;F&&k.bI(this._transform,3,[(Me=F)[0],Me[1],Me[2],1])}get orientation(){return this._orientation}set orientation(F){this._orientation=F||k.ab.quat.identity([]),F&&ji(this._transform,this._orientation)}getPitchBearing(){const k=this.forward(),F=this.right();return{bearing:Math.atan2(-F[1],F[0]),pitch:Math.atan2(Math.sqrt(k[0]*k[0]+k[1]*k[1]),-k[2])}}setPitchBearing(k,F){this._orientation=Vi(k,F),ji(this._transform,this._orientation)}forward(){const F=k.bG(this._transform,2);return[-F[0],-F[1],-F[2]]}up(){const F=k.bG(this._transform,1);return[-F[0],-F[1],-F[2]]}right(){const F=k.bG(this._transform,0);return[F[0],F[1],F[2]]}getCameraToWorld(F,Me){const Ae=new Float64Array(16);return k.ab.mat4.invert(Ae,this.getWorldToCamera(F,Me)),Ae}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(F,Me,Ae){const Oe=this.position;k.ab.vec3.scale(Oe,Oe,-F);const Fe=new Float64Array(16);return k.ab.mat4.fromScaling(Fe,[Ae,Ae,Ae]),k.ab.mat4.translate(Fe,Fe,Oe),Fe[10]*=Me,Fe}getWorldToCamera(F,Me){const Ae=new Float64Array(16),Oe=new Float64Array(4),Fe=this.position;return k.ab.quat.conjugate(Oe,this._orientation),k.ab.vec3.scale(Fe,Fe,-F),k.ab.mat4.fromQuat(Ae,Oe),k.ab.mat4.translate(Ae,Ae,Fe),Ae[1]*=-1,Ae[5]*=-1,Ae[9]*=-1,Ae[13]*=-1,Ae[8]*=Me,Ae[9]*=Me,Ae[10]*=Me,Ae[11]*=Me,Ae}getCameraToClipPerspective(F,Me,Ae,Oe){const Fe=new Float64Array(16);return k.ab.mat4.perspective(Fe,F,Me,Ae,Oe),Fe}getCameraToClipOrthographic(F,Me,Ae,Oe,Fe,je){const qe=new Float64Array(16);return k.ab.mat4.ortho(qe,F,Me,Ae,Oe,Fe,je),qe}getDistanceToElevation(F,Me=!1){const Ae=0===F?0:k.bH(F,Me?k.aS(this.position[1]):this.position[1]),Oe=this.forward();return(Ae-this.position[2])/Oe[2]}clone(){return new Zi([...this.position],[...this.orientation])}}const uh={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class $i{constructor(k=0,F=0,Me=0,Ae=0){if(isNaN(k)||k<0||isNaN(F)||F<0||isNaN(Me)||Me<0||isNaN(Ae)||Ae<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=k,this.bottom=F,this.left=Me,this.right=Ae}interpolate(F,Me,Ae){return null!=Me.top&&null!=F.top&&(this.top=k.af(F.top,Me.top,Ae)),null!=Me.bottom&&null!=F.bottom&&(this.bottom=k.af(F.bottom,Me.bottom,Ae)),null!=Me.left&&null!=F.left&&(this.left=k.af(F.left,Me.left,Ae)),null!=Me.right&&null!=F.right&&(this.right=k.af(F.right,Me.right,Ae)),this}getCenter(F,Me){const Ae=k.aw((this.left+F-this.right)/2,0,F),Oe=k.aw((this.top+Me-this.bottom)/2,0,Me);return new k.P(Ae,Oe)}equals(k){return this.top===k.top&&this.bottom===k.bottom&&this.left===k.left&&this.right===k.right}clone(){return new $i(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Xi=(k,F,Me)=>(1-Me)*k+Me*F,Ki=k=>k*k*k*k*k;class Yi{constructor(F,Me,Ae,Oe,Fe,je,qe){this.tileSize=512,this._renderWorldCopies=void 0===Fe||Fe,this._minZoom=F||0,this._maxZoom=Me||22,this._minPitch=Ae??0,this._maxPitch=Oe??60,this.setProjection(je),this.setMaxBounds(qe),this.width=0,this.height=0,this._center=new k.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new $i,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Zi,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const k=new Yi(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return k._elevation=this._elevation,k._centerAltitude=this._centerAltitude,k._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,k.tileSize=this.tileSize,k.mercatorFromTransition=this.mercatorFromTransition,k.width=this.width,k.height=this.height,k.cameraElevationReference=this.cameraElevationReference,k._center=this._center,k._setZoom(this.zoom),k._seaLevelZoom=this._seaLevelZoom,k.angle=this.angle,k._fov=this._fov,k._pitch=this._pitch,k._nearZ=this._nearZ,k._farZ=this._farZ,k._averageElevation=this._averageElevation,k._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,k._unmodified=this._unmodified,k._edgeInsets=this._edgeInsets.clone(),k._camera=this._camera.clone(),k._calcMatrices(),k.freezeTileCoverage=this.freezeTileCoverage,k.frustumCorners=this.frustumCorners,k}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(k){this._elevation!==k&&(this._elevation=k,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(k,F=!1){const Me=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||Me)&&this._updateCameraOnTerrain(),(k||Me)&&this._constrainCamera(F),this._calcMatrices()}getProjection(){return k.ay(this.projection,["name","center","parallels"])}setProjection(F){this.projectionOptions=F||{name:"mercator"};const Me=this.projection?this.getProjection():void 0;this.projection=k.bP(this.projectionOptions);const Ae=this.getProjection(),Oe=!k.bn(Me,Ae);return Oe&&this._calcMatrices(),this.mercatorFromTransition=!1,Oe}setOrthographicProjectionAtLowPitch(k){return this._orthographicProjectionAtLowPitch!==k&&(this._orthographicProjectionAtLowPitch=k,this._calcMatrices(),!0)}setMercatorFromTransition(){const F=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=k.bP({name:"mercator"});const Me=F!==this.projection.name;return Me&&this._calcMatrices(),Me}get minZoom(){return this._minZoom}set minZoom(k){this._minZoom!==k&&(this._minZoom=k,this.zoom=Math.max(this.zoom,k))}get maxZoom(){return this._maxZoom}set maxZoom(k){this._maxZoom!==k&&(this._maxZoom=k,this.zoom=Math.min(this.zoom,k))}get minPitch(){return this._minPitch}set minPitch(k){this._minPitch!==k&&(this._minPitch=k,this.pitch=Math.max(this.pitch,k))}get maxPitch(){return this._maxPitch}set maxPitch(k){this._maxPitch!==k&&(this._maxPitch=k,this.pitch=Math.min(this.pitch,k))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(k){void 0===k?k=!0:null===k&&(k=!1),this._renderWorldCopies=k}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const k=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(k))}get cameraWorldSize(){const k=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(k))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return k.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new k.P(this.width,this.height)}get bearing(){return k.bF(this.rotation,-180,180)}set bearing(k){this.rotation=k}get rotation(){return-this.angle/Math.PI*180}set rotation(F){const Me=-F*Math.PI/180;this.angle!==Me&&(this._unmodified=!1,this.angle=Me,this._calcMatrices(),this.rotationMatrix=k.ab.mat2.create(),k.ab.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(F){const Me=k.aw(F,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==Me&&(this._unmodified=!1,this._pitch=Me,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const k=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/k)}set fov(F){F=Math.max(.01,Math.min(60,F)),this._fov!==F&&(this._unmodified=!1,this._fov=k.ai(F),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(k){this._averageElevation=k,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(k){const F=Math.min(Math.max(k,this.minZoom),this.maxZoom);this._zoom!==F&&(this._unmodified=!1,this._setZoom(F),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(k){this._zoom=k,this.scale=this.zoomScale(k),this.tileZoom=Math.floor(k),this.zoomFraction=k-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(k){this._tileCoverLift!==k&&(this._tileCoverLift=k)}_updateCameraOnTerrain(){const k=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,F=this.elevation&&k===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||k===Number.NEGATIVE_INFINITY&&(!F||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const Me=this._elevation;F||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&Me.exaggeration()&&this._centerAltitudeValidForExaggeration!==Me.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*Me.exaggeration(),this._centerAltitudeValidForExaggeration=Me.exaggeration()):(this._centerAltitude=k||0,this._centerAltitudeValidForExaggeration=Me.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const F=this._elevation,Me=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],Ae=this.horizonLineFromTop();let Oe=0,Fe=0;for(let je=0;je<Me.length;je++){const qe=new k.P(Me[je][0]*this.width,Ae+Me[je][1]*(this.height-Ae)),pt=F.pointCoordinate(qe);if(!pt)continue;const vt=1/Math.hypot(pt[0]-this._camera.position[0],pt[1]-this._camera.position[1]);Oe+=pt[3]*vt,Fe+=vt}return 0===Fe?NaN:Oe/Fe}get center(){return this._center}set center(k){k.lat===this._center.lat&&k.lng===this._center.lng||(this._unmodified=!1,this._center=k,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const k=this._seaLevelZoom,F=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),Me=this.pixelsPerMeter/this.worldSize*F,Ae=this._mercatorZfromZoom(k),Oe=this._mercatorZfromZoom(this._maxZoom),Fe=Math.max(Ae-Me,Oe);this._setZoom(this._zoomFromMercatorZ(Fe))}get padding(){return this._edgeInsets.toJSON()}set padding(k){this._edgeInsets.equals(k)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,k,1),this._calcMatrices())}computeZoomRelativeTo(F){const Me=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,F.toAltitude()));let Ae;Ae=F.z<this._camera.position[2]?[Me.x,Me.y,Me.z]:[F.x,F.y,F.z];const Oe=k.ab.vec3.length(k.ab.vec3.sub([],this._camera.position,Ae));return k.aw(this._zoomFromMercatorZ(Oe),this._minZoom,this._maxZoom)}setFreeCameraOptions(F){if(!this.height)return;if(!F.position&&!F.orientation)return;this._updateCameraState();let Me=!1;if(F.orientation&&!k.ab.quat.exactEquals(F.orientation,this._camera.orientation)&&(Me=this._setCameraOrientation(F.orientation)),F.position){const Ae=[F.position.x,F.position.y,F.position.z];k.ab.vec3.exactEquals(Ae,this._camera.position)||(this._setCameraPosition(Ae),Me=!0)}Me&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const F=this._camera.position,Me=new Hi;return Me.position=new k.aa(F[0],F[1],F[2]),Me.orientation=this._camera.orientation,Me._elevation=this.elevation,Me._renderWorldCopies=this.renderWorldCopies,Me}_setCameraOrientation(F){if(!k.ab.quat.length(F))return!1;k.ab.quat.normalize(F,F);const Me=k.ab.vec3.transformQuat([],[0,0,-1],F),Ae=k.ab.vec3.transformQuat([],[0,-1,0],F);if(Ae[2]<0)return!1;const Oe=qi(Me,Ae);return!!Oe&&(this._camera.orientation=Oe,!0)}_setCameraPosition(F){const Me=this.zoomScale(this.minZoom)*this.tileSize,Ae=this.zoomScale(this.maxZoom)*this.tileSize,Oe=this.cameraToCenterDistance;F[2]=k.aw(F[2],Oe/Ae,Oe/Me),this._camera.position=F}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(k){return this._edgeInsets.equals(k)}interpolatePadding(k,F,Me){this._unmodified=!1,this._edgeInsets.interpolate(k,F,Me),this._constrain(),this._calcMatrices()}coveringZoomLevel(k){const F=(k.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/k.tileSize));return Math.max(0,F)}getVisibleUnwrappedCoordinates(F){const Me=[new k.bQ(0,F)];if(this.renderWorldCopies){const Ae=this.pointCoordinate(new k.P(0,0)),Oe=this.pointCoordinate(new k.P(this.width,0)),Fe=this.pointCoordinate(new k.P(this.width,this.height)),je=this.pointCoordinate(new k.P(0,this.height)),qe=Math.floor(Math.min(Ae.x,Oe.x,Fe.x,je.x)),pt=Math.floor(Math.max(Ae.x,Oe.x,Fe.x,je.x)),vt=1;for(let Ae=qe-vt;Ae<=pt+vt;Ae++)0!==Ae&&Me.push(new k.bQ(Ae,F))}return Me}isLODDisabled(k){return(!k||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(F,Me,Ae){let Oe=[];const Fe=void 0!==Ae,je=!Fe;if(je&&this.zoom<Me)return Oe;if(Fe&&0===Ae[0]&&0===Ae[1])return Oe;const qe=new Set,l=(F,Me,Ae,Fe,je)=>{const pt=k.c5(Me,F,Ae,Fe,je);qe.has(pt)||(Oe.push(new k.aG(F,Me,Ae,Fe,je)),qe.add(pt))};for(let k=0;k<F.length;k++){const Oe=F[k];if(je&&Oe.canonical.z!==Me)continue;const qe=Oe.canonical,pt=Oe.overscaledZ,vt=Oe.wrap,Ut=1<<qe.z,xi=qe.x+1<Ut,vi=qe.x>0,bi=qe.y+1<Ut,wi=qe.y>0,Mi=Oe.wrap-(vi?0:1),pr=Oe.wrap+(xi?0:1),Ur=vi?qe.x-1:Ut-1,Wr=xi?qe.x+1:0;if(Fe)Ae[0]<0?(l(pt,pr,qe.z,Wr,qe.y),Ae[1]<0&&bi&&(l(pt,vt,qe.z,qe.x,qe.y+1),l(pt,pr,qe.z,Wr,qe.y+1)),Ae[1]>0&&wi&&(l(pt,vt,qe.z,qe.x,qe.y-1),l(pt,pr,qe.z,Wr,qe.y-1))):Ae[0]>0?(l(pt,Mi,qe.z,Ur,qe.y),Ae[1]<0&&bi&&(l(pt,vt,qe.z,qe.x,qe.y+1),l(pt,Mi,qe.z,Ur,qe.y+1)),Ae[1]>0&&wi&&(l(pt,vt,qe.z,qe.x,qe.y-1),l(pt,Mi,qe.z,Ur,qe.y-1))):Ae[1]<0&&bi?l(pt,vt,qe.z,qe.x,qe.y+1):wi&&l(pt,vt,qe.z,qe.x,qe.y-1);else{const k=Oe.visibleQuadrants;1&k&&(l(pt,Mi,qe.z,Ur,qe.y),wi&&(l(pt,vt,qe.z,qe.x,qe.y-1),l(pt,Mi,qe.z,Ur,qe.y-1))),2&k&&(l(pt,pr,qe.z,Wr,qe.y),wi&&(l(pt,vt,qe.z,qe.x,qe.y-1),l(pt,pr,qe.z,Wr,qe.y-1))),4&k&&(l(pt,Mi,qe.z,Ur,qe.y),bi&&(l(pt,vt,qe.z,qe.x,qe.y+1),l(pt,Mi,qe.z,Ur,qe.y+1))),8&k&&(l(pt,pr,qe.z,Wr,qe.y),bi&&(l(pt,vt,qe.z,qe.x,qe.y+1),l(pt,pr,qe.z,Wr,qe.y+1)))}}const pt=[];for(const k of Oe)Oe.some((F=>k.isChildOf(F)))||pt.push(k);if(Oe=pt.filter((k=>!F.some((F=>!!(k.overscaledZ<Me&&F.isChildOf(k))||k.equals(F)||k.isChildOf(F))))),je){const k=1<<Me,F="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Ae=[k*F.x,k*F.y],Fe=4,je=Fe*Fe;Oe=Oe.filter((k=>{const F=k.canonical.x+.5-Ae[0],Me=k.canonical.y+.5-Ae[1];return F*F+Me*Me<je}))}return Oe}coveringTiles(F){let Me=this.coveringZoomLevel(F);const Ae=Me,Oe=this.elevation&&this.elevation.exaggeration(),Fe=Oe&&!F.isTerrainDEM,je="mercator"===this.projection.name;if(void 0!==F.minzoom&&Me<F.minzoom)return[];void 0!==F.maxzoom&&Me>F.maxzoom&&(Me=F.maxzoom);const qe=this.locationCoordinate(this.center),pt=this.center.lat,vt=1<<Me,Ut=[vt*qe.x,vt*qe.y,0],xi="globe"===this.projection.name,vi=!xi,bi=k.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Me,vi),wi=xi?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Mi=vt*k.bH(1,this.center.lat),pr=this._camera.position[2]/k.bH(1,this.center.lat),Ur=[vt*wi.x,vt*wi.y,pr*(vi?1:Mi)],Wr=xi||Oe,Jr=this.cameraToCenterDistance/F.tileSize*(F.roundZoom?1:.502),Qr=this.isLODDisabled(!0)?Me:0;let co;if(this._elevation&&F.isTerrainDEM)co=1e4*this._elevation.exaggeration();else if(this._elevation){const k=this._elevation.getMinMaxForVisibleTiles();co=k?k.max:this._centerAltitude}else co=this._centerAltitude;const mo=F.isTerrainDEM?-co:this._elevation?this._elevation.getMinElevationBelowMSL():0,yo=this.projection.isReprojectedInTileSpace?k.bS(this):1,E=F=>{const Me=1/4e4,Ae=new k.aa(F.x+Me,F.y,F.z),Oe=new k.aa(F.x,F.y+Me,F.z),Fe=F.toLngLat(),je=Ae.toLngLat(),qe=Oe.toLngLat(),pt=this.locationCoordinate(Fe),vt=this.locationCoordinate(je),Ut=this.locationCoordinate(qe),xi=Math.hypot(vt.x-pt.x,vt.y-pt.y),vi=Math.hypot(Ut.x-pt.x,Ut.y-pt.y);return Math.sqrt(xi*vi)*yo/Me},S=F=>{const Me=co,Ae=mo;return{aabb:k.bV(this,vt,0,0,0,F,Ae,Me,this.projection),zoom:0,x:0,y:0,minZ:Ae,maxZ:Me,wrap:F,fullyVisible:!1}},To=[];let zo=[];const ko=Me,na=F.reparseOverscaled?Ae:Me,aa=(pr-this._centerAltitude)*Mi,A=k=>{if(!this._elevation||!k.tileID||!je)return;const F=this._elevation.getMinMaxForTile(k.tileID),Me=k.aabb;F?(Me.min[2]=F.min,Me.max[2]=F.max,Me.center[2]=(Me.min[2]+Me.max[2])/2):(k.shouldSplit=P(k),k.shouldSplit||(Me.min[2]=Me.max[2]=Me.center[2]=this._centerAltitude))},z=(k,F)=>{if(.707*F<k)return 1;const Me=F/k;return Me/(1.4144271570014144+(Math.pow(1.1,Me-1.4144271570014144+1)-1)/(1.1-1)-1)},P=F=>{if(F.zoom<Qr)return!0;if(F.zoom===ko)return!1;if(null!=F.shouldSplit)return F.shouldSplit;const Me=F.aabb.distanceX(Ur),Oe=F.aabb.distanceY(Ur);let qe=aa,vt=1;if(xi){qe=F.aabb.distanceZ(Ur);const Me=Math.pow(2,F.zoom),Ae=k.aS((F.y+1)/Me),Oe=k.aS(F.y/Me),Fe=Math.min(Math.max(pt,Ae),Oe),je=k.c9(Fe)/k.c9(pt);if(vt=Fe===pt?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,je/this._mercatorScaleRatio),this.zoom<=k.c6&&F.zoom===ko-1&&je>=.9)return!0}else if(Fe&&(qe=F.aabb.distanceZ(Ur)*Mi),this.projection.isReprojectedInTileSpace&&Ae<=5){const Me=Math.pow(2,F.zoom),Ae=E(new k.aa((F.x+.5)/Me,(F.y+.5)/Me));vt=Ae>.85?1:Ae}if(!je){const k=Math.sqrt(Me*Me+Oe*Oe+qe*qe);let Ae=(1<<ko-F.zoom)*Jr*vt;return Ae*=z(Math.max(qe,aa),k),k<Ae}let vi=Number.MAX_VALUE,bi=0;const wi=F.aabb.getCorners(),pr=[];for(const F of wi){k.ab.vec3.sub(pr,F,Ur),xi||(Fe?pr[2]*=Mi:pr[2]=aa);const Me=k.ab.vec3.dot(pr,this._camera.forward());Me<vi&&(vi=Me,bi=Math.abs(pr[2]))}let Wr=(1<<ko-F.zoom)*Jr*vt;if(Wr*=z(Math.max(bi,aa),vi),vi<Wr)return!0;const co=F.aabb.closestPoint(Ut);return co[0]===Ut[0]&&co[1]===Ut[1]};if(this.renderWorldCopies)for(let k=1;k<=3;k++)To.push(S(-k)),To.push(S(k));for(To.push(S(0));To.length>0;){const Ae=To.pop(),Oe=Ae.x,qe=Ae.y;let pt=Ae.fullyVisible;const d=()=>"globe"===this.projection.name&&(0===Ae.y||Ae.y===(1<<Ae.zoom)-1);if(!pt){let F=Wr?Ae.aabb.intersects(bi):Ae.aabb.intersectsFlat(bi);if(0===F&&d()){const Me=new k.bT(Ae.zoom,Oe,qe);F=k.bU(this,vt,Me,!0).intersects(bi)}if(0===F)continue;pt=2===F}if(Ae.zoom!==ko&&P(Ae))for(let F=0;F<4;F++){const Me=(Oe<<1)+F%2,Ut=(qe<<1)+(F>>1),vi={aabb:je?Ae.aabb.quadrant(F):k.bV(this,vt,Ae.zoom+1,Me,Ut,Ae.wrap,Ae.minZ,Ae.maxZ,this.projection),zoom:Ae.zoom+1,x:Me,y:Ut,wrap:Ae.wrap,fullyVisible:pt,tileID:void 0,shouldSplit:void 0,minZ:Ae.minZ,maxZ:Ae.maxZ};Fe&&!xi&&(vi.tileID=new k.aG(Ae.zoom+1===ko?na:Ae.zoom+1,Ae.wrap,Ae.zoom+1,Me,Ut),A(vi)),To.push(vi)}else{const Fe=Ae.zoom===ko?na:Ae.zoom;if(F.minzoom&&F.minzoom>Fe)continue;let je=0;if(!pt){let Me=Wr?Ae.aabb.intersectsPrecise(bi):Ae.aabb.intersectsPreciseFlat(bi);if(0===Me&&d()){const F=new k.bT(Ae.zoom,Oe,qe);Me=k.bU(this,vt,F,!0).intersectsPrecise(bi)}if(0===Me)continue;if(F.calculateQuadrantVisibility)if(bi.containsPoint(Ae.aabb.center))je=15;else for(let k=0;k<4;k++)0!==Ae.aabb.quadrant(k).intersects(bi)&&(je|=1<<k)}const xi=Ut[0]-(.5+Oe+(Ae.wrap<<Ae.zoom))*(1<<Me-Ae.zoom),vi=Ut[1]-.5-qe,wi=Ae.tileID?Ae.tileID:new k.aG(Fe,Ae.wrap,Ae.zoom,Oe,qe);F.calculateQuadrantVisibility&&(wi.visibleQuadrants=je),zo.push({tileID:wi,distanceSq:xi*xi+vi*vi})}}if(this.fogCullDistSq){const Me=this.fogCullDistSq,Ae=this.horizonLineFromTop();zo=zo.filter((Oe=>{const Fe=[0,0,0,1],je=[k.ag,k.ag,0,1],qe=this.calculateFogTileMatrix(Oe.tileID.toUnwrapped());k.ab.vec4.transformMat4(Fe,Fe,qe),k.ab.vec4.transformMat4(je,je,qe);const pt=k.ab.vec4.min([],Fe,je),vt=k.ab.vec4.max([],Fe,je),Ut=k.bW(pt,vt);if(0===Ut)return!0;let xi=!1;const vi=this._elevation;if(vi&&Ut>Me&&0!==Ae){const Me=this.calculateProjMatrix(Oe.tileID.toUnwrapped());let Fe;F.isTerrainDEM||(Fe=vi.getMinMaxForTile(Oe.tileID)),Fe||(Fe={min:mo,max:co});const je=k.c7(this.rotation),qe=[je[0]*k.ag,je[1]*k.ag,Fe.max];k.ab.vec3.transformMat4(qe,qe,Me),xi=(1-qe[1])*this.height*.5<Ae}return Ut<Me||xi}))}return zo.sort(((k,F)=>k.distanceSq-F.distanceSq)).map((k=>k.tileID))}resize(k,F){this.width=k,this.height=F,this.pixelsToGLUnits=[2/k,-2/F],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(k){return Math.pow(2,k)}scaleZoom(k){return Math.log(k)/Math.LN2}project(F){const Me=k.aw(F.lat,-k.bX,k.bX),Ae=this.projection.project(F.lng,Me);return new k.P(Ae.x*this.worldSize,Ae.y*this.worldSize)}unproject(k){return this.projection.unproject(k.x/this.worldSize,k.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/k.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(F,Me){let Ae,Oe;const Fe=this.centerPoint;if("globe"===this.projection.name){const k=this.worldSize;Ae=(Me.x-Fe.x)/k,Oe=(Me.y-Fe.y)/k}else{const k=this.pointCoordinate(Me),F=this.pointCoordinate(Fe);Ae=k.x-F.x,Oe=k.y-F.y}const je=this.locationCoordinate(F);this.setLocation(new k.aa(je.x-Ae,je.y-Oe))}setLocation(k){this.center=this.coordinateLocation(k),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(k){return this.projection.locationPoint(this,k)}locationPoint3D(k){return this.projection.locationPoint(this,k,!0)}pointLocation(k){return this.coordinateLocation(this.pointCoordinate(k))}pointLocation3D(k){return this.coordinateLocation(this.pointCoordinate3D(k))}locationCoordinate(F,Me){const Ae=Me?k.bH(Me,F.lat):void 0,Oe=this.projection.project(F.lng,F.lat);return new k.aa(Oe.x,Oe.y,Ae)}coordinateLocation(k){return this.projection.unproject(k.x,k.y)}pointRayIntersection(F,Me){const Ae=null!=Me?Me:this._centerAltitude,Oe=[F.x,F.y,0,1],Fe=[F.x,F.y,1,1];k.ab.vec4.transformMat4(Oe,Oe,this.pixelMatrixInverse),k.ab.vec4.transformMat4(Fe,Fe,this.pixelMatrixInverse);const je=Fe[3];k.ab.vec4.scale(Oe,Oe,1/Oe[3]),k.ab.vec4.scale(Fe,Fe,1/je);const qe=Oe[2],pt=Fe[2];return{p0:Oe,p1:Fe,t:qe===pt?0:(Ae-qe)/(pt-qe)}}screenPointToMercatorRay(F){const Me=[F.x,F.y,0,1],Ae=[F.x,F.y,1,1];return k.ab.vec4.transformMat4(Me,Me,this.pixelMatrixInverse),k.ab.vec4.transformMat4(Ae,Ae,this.pixelMatrixInverse),k.ab.vec4.scale(Me,Me,1/Me[3]),k.ab.vec4.scale(Ae,Ae,1/Ae[3]),Me[2]=k.bH(Me[2],this._center.lat)*this.worldSize,Ae[2]=k.bH(Ae[2],this._center.lat)*this.worldSize,k.ab.vec4.scale(Me,Me,1/this.worldSize),k.ab.vec4.scale(Ae,Ae,1/this.worldSize),new k.aq([Me[0],Me[1],Me[2]],k.ab.vec3.normalize([],k.ab.vec3.sub([],Ae,Me)))}rayIntersectionCoordinate(F){const{p0:Me,p1:Ae,t:Oe}=F,Fe=k.bH(Me[2],this._center.lat),je=k.bH(Ae[2],this._center.lat);return new k.aa(k.af(Me[0],Ae[0],Oe)/this.worldSize,k.af(Me[1],Ae[1],Oe)/this.worldSize,k.af(Fe,je,Oe))}pointCoordinate(k,F=this._centerAltitude){return this.projection.pointCoordinate(this,k.x,k.y,F)}pointCoordinate3D(F){if(!this.elevation)return this.pointCoordinate(F);let Me=this.projection.pointCoordinate3D(this,F.x,F.y);if(Me)return new k.aa(Me[0],Me[1],Me[2]);let Ae=0,Oe=this.horizonLineFromTop();if(F.y>Oe)return this.pointCoordinate(F);const Fe=.02*Oe,je=F.clone();for(let F=0;F<10&&Oe-Ae>Fe;F++){je.y=k.af(Ae,Oe,.66);const F=this.projection.pointCoordinate3D(this,je.x,je.y);F?(Oe=je.y,Me=F):Ae=je.y}return Me?new k.aa(Me[0],Me[1],Me[2]):this.pointCoordinate(F)}isPointAboveHorizon(k){return this.projection.isPointAboveHorizon(this,k)}isPointOnSurface(F){if(F.y<0||F.y>this.height||F.x<0||F.x>this.width)return!1;if(this.elevation||this.zoom>=k.bY)return!this.isPointAboveHorizon(F);const Me=this.pointCoordinate(F);return Me.y>=0&&Me.y<=1}_coordinatePoint(F,Me){const Ae=Me&&this.elevation?this.elevation.getAtPointOrZero(F,this._centerAltitude):this._centerAltitude,Oe=[F.x*this.worldSize,F.y*this.worldSize,Ae+F.toAltitude(),1];return k.ab.vec4.transformMat4(Oe,Oe,this.pixelMatrix),Oe[3]>0?new k.P(Oe[0]/Oe[3],Oe[1]/Oe[3]):new k.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:F,left:Me}=this._edgeInsets,Ae=this.height-this._edgeInsets.bottom,Oe=this.width-this._edgeInsets.right,Fe=this.pointLocation3D(new k.P(Me,F)),je=this.pointLocation3D(new k.P(Oe,F)),qe=this.pointLocation3D(new k.P(Oe,Ae)),pt=this.pointLocation3D(new k.P(Me,Ae));let vt=Math.min(Fe.lng,je.lng,qe.lng,pt.lng),Ut=Math.max(Fe.lng,je.lng,qe.lng,pt.lng),xi=Math.min(Fe.lat,je.lat,qe.lat,pt.lat),vi=Math.max(Fe.lat,je.lat,qe.lat,pt.lat);const bi=Math.pow(2,-this.zoom)/16*270,wi="globe"===this.projection.name?1:4,f=(F,Me,Ae,Oe,Fe)=>{const je=(F+Ae)/2,qe=(Me+Oe)/2,pt=new k.P(je,qe),{lng:Mi,lat:pr}=this.pointLocation3D(pt),Ur=Math.max(0,vt-Mi,xi-pr,Mi-Ut,pr-vi);vt=Math.min(vt,Mi),Ut=Math.max(Ut,Mi),xi=Math.min(xi,pr),vi=Math.max(vi,pr),(Fe<wi||Ur>bi)&&(f(F,Me,je,qe,Fe+1),f(je,qe,Ae,Oe,Fe+1))};if(f(Me,F,Oe,F,1),f(Oe,F,Oe,Ae,1),f(Oe,Ae,Me,Ae,1),f(Me,Ae,Me,F,1),"globe"===this.projection.name){const[F,Me]=k.bZ(this);F?(vi=90,Ut=180,vt=-180):Me&&(xi=-90,Ut=180,vt=-180)}return new k.az(new k.bO(vt,xi),new k.bO(Ut,vi))}_getBoundsRectangular(F,Me){const{top:Ae,left:Oe}=this._edgeInsets,Fe=this.height-this._edgeInsets.bottom,je=this.width-this._edgeInsets.right,qe=new k.P(Oe,Ae),pt=new k.P(je,Ae),vt=new k.P(je,Fe),Ut=new k.P(Oe,Fe);let xi=this.pointCoordinate(qe,F),vi=this.pointCoordinate(pt,F);const bi=this.pointCoordinate(vt,Me),wi=this.pointCoordinate(Ut,Me),f=(k,F)=>(F.y-k.y)/(F.x-k.x);return xi.y>1&&vi.y>=0?xi=new k.aa((1-wi.y)/f(wi,xi)+wi.x,1):xi.y<0&&vi.y<=1&&(xi=new k.aa(-wi.y/f(wi,xi)+wi.x,0)),vi.y>1&&xi.y>=0?vi=new k.aa((1-bi.y)/f(bi,vi)+bi.x,1):vi.y<0&&xi.y<=1&&(vi=new k.aa(-bi.y/f(bi,vi)+bi.x,0)),(new k.az).extend(this.coordinateLocation(xi)).extend(this.coordinateLocation(vi)).extend(this.coordinateLocation(wi)).extend(this.coordinateLocation(bi))}_getBoundsRectangularTerrain(){const k=this.elevation;if(!k.visibleDemTiles.length||k.isUsingMockSource())return this._getBoundsRectangular(0,0);const F=k.visibleDemTiles.reduce(((k,F)=>{if(F.dem){const Me=F.dem.tree;k.min=Math.min(k.min,Me.minimums[0]),k.max=Math.max(k.max,Me.maximums[0])}return k}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(F.min*k.exaggeration(),F.max*k.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(k=!0){const F=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,Me=this.height/2-F*(1-this._horizonShift);return k?Math.max(0,Me):Me}getMaxBounds(){return this.maxBounds}setMaxBounds(F){this.maxBounds=F,this.minLat=-k.bX,this.maxLat=k.bX,this.minLng=-180,this.maxLng=180,F&&(this.minLat=F.getSouth(),this.maxLat=F.getNorth(),this.minLng=F.getWest(),this.maxLng=F.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=k.at(this.minLng)*this.tileSize,this.worldMaxX=k.at(this.maxLng)*this.tileSize,this.worldMinY=k.aA(this.maxLat)*this.tileSize,this.worldMaxY=k.aA(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(k,F){return this.projection.createTileMatrix(this,F,k)}calculateDistanceTileData(F){const Me=F.key,Ae=this._distanceTileDataCache;if(Ae[Me])return Ae[Me];const Oe=F.canonical,Fe=1/this.height,je=this.cameraWorldSize,qe=je/this.zoomScale(Oe.z),pt=(Oe.x+Math.pow(2,Oe.z)*F.wrap)*qe,vt=Oe.y*qe,Ut=this.point;Ut.x*=je/this.worldSize,Ut.y*=je/this.worldSize;const xi=this.angle,vi=Math.sin(-xi),bi=-Math.cos(-xi);return Ae[Me]={bearing:[vi,bi],center:[(Ut.x-pt)*Fe,(Ut.y-vt)*Fe],scale:qe/k.ag*Fe},Ae[Me]}calculateFogTileMatrix(F){const Me=F.key,Ae=this._fogTileMatrixCache;if(Ae[Me])return Ae[Me];const Oe=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,F);return k.ab.mat4.multiply(Oe,this.worldToFogMatrix,Oe),Ae[Me]=new Float32Array(Oe),Ae[Me]}calculateProjMatrix(F,Me=!1,Ae=!1){const Oe=F.key;let Fe;if(Fe=Ae?this._expandedProjMatrixCache:Me?this._alignedProjMatrixCache:this._projMatrixCache,Fe[Oe])return Fe[Oe];const je=this.calculatePosMatrix(F,this.worldSize);let qe;return qe=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:Ae?this.expandedFarZProjMatrix:Me?this.alignedProjMatrix:this.projMatrix,k.ab.mat4.multiply(je,qe,je),Fe[Oe]=new Float32Array(je),Fe[Oe]}calculatePixelsToTileUnitsMatrix(F){const Me=F.tileID.key,Ae=this._pixelsToTileUnitsCache;if(Ae[Me])return Ae[Me];const Oe=k.b_(F,this);return Ae[Me]=Oe,Ae[Me]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const F=1/this.worldSize,Me=k.ab.mat4.fromScaling([],[F,F,F]);return k.ab.mat4.multiply(Me,Me,this.globeMatrix),Me}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const F=this._elevation;this._updateCameraState();const Me=k.bH(1,this._center.lat)*this.worldSize,Ae=this._computeCameraPosition(Me),Oe=this._camera.forward(),Fe=k.bH(1,this._center.lat);Ae[2]/=Fe,Oe[2]/=Fe,k.ab.vec3.normalize(Oe,Oe);const je=F.raycast(Ae,Oe,F.exaggeration());if(je){const F=k.ab.vec3.scaleAndAdd([],Ae,Oe,je),Me=new k.aa(F[0],F[1],k.bH(F[2],k.aS(F[1]))),qe=(Me.z+k.ab.vec3.length([Me.x-Ae[0],Me.y-Ae[1],Me.z-Ae[2]*Fe]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(qe),this._centerAltitude=Me.toAltitude(),this._center=this.coordinateLocation(Me),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(F=!1){if(!this._elevation)return;const Me=this._elevation,Ae=k.bH(1,this._center.lat)*this.worldSize,Oe=this._computeCameraPosition(Ae),Fe=Me.getAtPointOrZero(new k.aa(...Oe)),je=this.pixelsPerMeter/this.worldSize*Fe,qe=this._minimumHeightOverTerrain(),pt=Oe[2]-je;if(pt<=qe)if(pt<0||F){const F=this.locationCoordinate(this._center,this._centerAltitude),Me=[Oe[0],Oe[1],F.z-Oe[2]],Ae=k.ab.vec3.length(Me);Me[2]-=(qe-pt)/this._pixelsPerMercatorPixel;const Fe=k.ab.vec3.length(Me);if(0===Fe)return;k.ab.vec3.scale(Me,Me,Ae/Fe*this._pixelsPerMercatorPixel),this._camera.position=[Oe[0],Oe[1],F.z*this._pixelsPerMercatorPixel-Me[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const F="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||F){const Me=this.center;return Me.lat=k.aw(Me.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!F)&&(Me.lng=k.aw(Me.lng,this.minLng,this.maxLng)),this.center=Me,void(this._constraining=!1)}const Me=this._unmodified,{x:Ae,y:Oe}=this.point;let Fe=0,je=Ae,qe=Oe;const pt=this.width/2,vt=this.height/2,Ut=this.worldMinY*this.scale,xi=this.worldMaxY*this.scale;if(Oe-vt<Ut&&(qe=Ut+vt),Oe+vt>xi&&(qe=xi-vt),xi-Ut<this.height&&(Fe=Math.max(Fe,this.height/(xi-Ut)),qe=(xi+Ut)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const k=this.worldMinX*this.scale,F=this.worldMaxX*this.scale,Me=this.worldSize/2-(k+F)/2;je=(Ae+Me+this.worldSize)%this.worldSize-Me,je-pt<k&&(je=k+pt),je+pt>F&&(je=F-pt),F-k<this.width&&(Fe=Math.max(Fe,this.width/(F-k)),je=(F+k)/2)}je===Ae&&qe===Oe||(this.center=this.unproject(new k.P(je,qe))),Fe&&(this.zoom+=this.scaleZoom(Fe)),this._constrainCamera(),this._unmodified=Me,this._constraining=!1}_minZoomForBounds(){let k=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(k=Math.max(k,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),k}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const F=this.centerOffset,Me="globe"===this.projection.name,Ae=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=k.bH(1,this.center.lat)/k.bH(1,k.c8));const Oe=k.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,Oe),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const Fe="meters"===this.projection.zAxisUnit?Ae:1,je=this._camera.getWorldToCamera(this.worldSize,Fe);let qe;const pt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(pt[8]=2*-F.x/this.width,pt[9]=2*F.y/this.height,this.isOrthographic){let k=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Me=k*this.aspect,Ae=-Me,Oe=-k;Me-=F.x,Ae-=F.x,k+=F.y,Oe+=F.y,qe=this._camera.getCameraToClipOrthographic(Ae,Me,Oe,k,this._nearZ,this._farZ),((k,F,Me,Ae)=>{for(let Oe=0;Oe<16;Oe++)k[Oe]=Xi(F[Oe],Me[Oe],Ae)})(qe,qe,pt,Ki(this.pitch>=15?1:this.pitch/15))}else qe=pt;const vt=k.ab.mat4.mul([],pt,je);let Ut=k.ab.mat4.mul([],qe,je);if(this.projection.isReprojectedInTileSpace){const F=this.locationCoordinate(this.center),Me=k.ab.mat4.identity([]);k.ab.mat4.translate(Me,Me,[F.x*this.worldSize,F.y*this.worldSize,0]),k.ab.mat4.multiply(Me,Me,k.c0(this)),k.ab.mat4.translate(Me,Me,[-F.x*this.worldSize,-F.y*this.worldSize,0]),k.ab.mat4.multiply(Ut,Ut,Me),k.ab.mat4.multiply(vt,vt,Me),this.inverseAdjustmentMatrix=k.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=k.ab.mat4.scale([],Ut,[this.worldSize,this.worldSize,this.worldSize/Fe,1]),this.projMatrix=Ut,this.invProjMatrix=k.ab.mat4.invert(new Float64Array(16),this.projMatrix),Me){const Me=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Me[8]=2*-F.x/this.width,Me[9]=2*F.y/this.height,this.expandedFarZProjMatrix=k.ab.mat4.mul([],Me,je)}else this.expandedFarZProjMatrix=this.projMatrix;const xi=k.ab.mat4.invert([],qe);this.frustumCorners=k.c2.fromInvProjectionMatrix(xi,this.horizonLineFromTop(),this.height),this.cameraFrustum=k.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!Me);const vi=new Float32Array(16);k.ab.mat4.identity(vi),k.ab.mat4.scale(vi,vi,[1,-1,1]),k.ab.mat4.rotateX(vi,vi,this._pitch),k.ab.mat4.rotateZ(vi,vi,this.angle);const bi=k.ab.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=k.ab.mat4.clone(bi);const wi=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;bi[8]=2*-F.x/this.width,bi[9]=2*(F.y+wi)/this.height,this.skyboxMatrix=k.ab.mat4.multiply(vi,bi,vi);const Mi=this.point,pr=Mi.x,Ur=Mi.y,Wr=this.width%2/2,Jr=this.height%2/2,Qr=Math.cos(this.angle),co=Math.sin(this.angle),mo=pr-Math.round(pr)+Qr*Wr+co*Jr,yo=Ur-Math.round(Ur)+Qr*Jr+co*Wr,To=new Float64Array(Ut);if(k.ab.mat4.translate(To,To,[mo>.5?mo-1:mo,yo>.5?yo-1:yo,0]),this.alignedProjMatrix=To,Ut=k.ab.mat4.create(),k.ab.mat4.scale(Ut,Ut,[this.width/2,-this.height/2,1]),k.ab.mat4.translate(Ut,Ut,[1,-1,0]),this.labelPlaneMatrix=Ut,Ut=k.ab.mat4.create(),k.ab.mat4.scale(Ut,Ut,[1,-1,1]),k.ab.mat4.translate(Ut,Ut,[-1,-1,0]),k.ab.mat4.scale(Ut,Ut,[2/this.width,2/this.height,1]),this.glCoordMatrix=Ut,this.pixelMatrix=k.ab.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,vt),this._calcFogMatrices(),this._distanceTileDataCache={},Ut=k.ab.mat4.invert(new Float64Array(16),this.pixelMatrix),!Ut)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=Ut,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=k.c3(this);const F=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=k.ab.vec3.transformMat4(F,F,je),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=Ut;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const F=this.cameraWorldSizeForFog,Me=this.cameraPixelsPerMeter,Ae=this._camera.position,Oe=1/this.height/this._pixelsPerMercatorPixel,Fe=[F,F,Me];k.ab.vec3.scale(Fe,Fe,Oe),k.ab.vec3.scale(Ae,Ae,-1),k.ab.vec3.multiply(Ae,Ae,Fe);const je=k.ab.mat4.create();k.ab.mat4.translate(je,je,Ae),k.ab.mat4.scale(je,je,Fe),this.mercatorFogMatrix=je,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(F,Me,Oe)}_computeCameraPosition(k){const F=(k=k||this.pixelsPerMeter)/this.pixelsPerMeter,Me=this._camera.forward(),Ae=this.point,Oe=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*F-k/this.worldSize*this._centerAltitude;return[Ae.x/this.worldSize-Me[0]*Oe,Ae.y/this.worldSize-Me[1]*Oe,k/this.worldSize*this._centerAltitude-Me[2]*Oe]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(F){const Me=this._maxCameraBoundsDistance()*Math.cos(this._pitch),Ae=this._camera.position[2],Oe=F[2];let Fe=1;this.projection.wrap&&(this.center=this.center.wrap()),Oe>0&&(Fe=Math.min((Me-Ae)/Oe,1)),this._camera.position=k.ab.vec3.scaleAndAdd([],this._camera.position,F,Fe),this._updateStateFromCamera()}_updateStateFromCamera(){const F=this._camera.position,Me=this._camera.forward(),{pitch:Ae,bearing:Oe}=this._camera.getPitchBearing(),Fe=k.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,je=this._mercatorZfromZoom(this._maxZoom)*Math.cos(k.ai(this._maxPitch)),qe=Math.max((F[2]-Fe)/Math.cos(Ae),je),pt=this._zoomFromMercatorZ(qe);k.ab.vec3.scaleAndAdd(F,F,Me,qe),this._pitch=k.aw(Ae,k.ai(this.minPitch),k.ai(this.maxPitch)),this.angle=k.bF(Oe,-Math.PI,Math.PI),this._setZoom(k.aw(pt,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new k.aa(F[0],F[1],F[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(k){return Math.pow(2,k)*this.tileSize}_mercatorZfromZoom(k){return this.cameraToCenterDistance/this._worldSizeFromZoom(k)}_minimumHeightOverTerrain(){const k=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(k)}_zoomFromMercatorZ(k){return this.scaleZoom(this.cameraToCenterDistance/(k*this.tileSize))}zoomFromMercatorZAdjusted(F){let Me=0,Ae=k.bY,Oe=0,Fe=1/0;for(;Ae-Me>1e-6&&Ae>Me;){const k=Me+.5*(Ae-Me),je=this.tileSize*Math.pow(2,k),qe=this.getCameraToCenterDistance(this.projection,k,je),pt=this.scaleZoom(qe/(F*this.tileSize)),vt=Math.abs(k-pt);vt<Fe&&(Fe=vt,Oe=k),k<pt?Me=k:Ae=k}return Oe}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(k.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(F,Me){const Ae=Math.min(F.x,Me.x),Oe=Math.max(F.x,Me.x),Fe=Math.min(F.y,Me.y),je=Math.max(F.y,Me.y);if(Fe<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const qe=[new k.P(Ae,Fe),new k.P(Oe,je),new k.P(Ae,je),new k.P(Oe,Fe)],pt=this.renderWorldCopies?-3:0,vt=this.renderWorldCopies?4:1;for(const k of qe){const F=this.pointRayIntersection(k);if(F.t<0)return!0;const Me=this.rayIntersectionCoordinate(F);if(Me.x<pt||Me.y<0||Me.x>vt||Me.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+k.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new k.P(0,0),new k.P(this.width,this.height))}zoomDeltaToMovement(F,Me){const Ae=k.ab.vec3.length(k.ab.vec3.sub([],this._camera.position,F)),Oe=this._zoomFromMercatorZ(Ae)+Me;return Ae-this._mercatorZfromZoom(Oe)}getCameraPoint(){if("globe"===this.projection.name){const F=function([F,Me,Ae],Oe){const Fe=[F,Me,Ae,1];k.ab.vec4.transformMat4(Fe,Fe,Oe);const je=Fe[3]=Math.max(Fe[3],1e-6);return Fe[0]/=je,Fe[1]/=je,Fe[2]/=je,Fe}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new k.P(F[0],F[1])}{const F=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new k.P(0,F))}}getCameraToCenterDistance(F,Me=this.zoom,Ae=this.worldSize){const Oe=k.b$(F,Me,this.width,this.height,1024),Fe=F.pixelSpaceConversion(this.center.lat,Ae,Oe);let je=.5/Math.tan(.5*this._fov)*this.height*Fe;return this.isOrthographic&&(je=Xi(1,je,Ki(this.pitch>=15?1:this.pitch/15))),je}getWorldToCameraMatrix(){const F=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&k.ab.mat4.multiply(F,F,this.globeMatrix),F}getFrustum(F){return k.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,F,"meters"===this.projection.zAxisUnit)}}const Ji=(F,Me)=>{if(Me>0&&F.terrain&&k.w("Cutoff is currently disabled on terrain"),Me<=0||F.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const Ae=F.transform,Oe=Math.max(Math.abs(Ae._zoom-(F.minCutoffZoom-1)),1),Fe=Ae.isLODDisabled(!1)?k.ac(60,45,Ae.pitch):k.ac(30,15,Ae.pitch),je=Ae._farZ-Ae._nearZ,qe=Me*Ae.height,pt=((1-(vt=Fe))*Ae.cameraToCenterDistance+vt*(Ae._farZ+qe))*Oe;var vt;return{shouldRenderCutoff:Fe<1,uniformValues:{u_cutoff_params:[Ae._nearZ,Ae._farZ,(pt-Ae._nearZ)/je,(pt-qe-Ae._nearZ)/je]}}},fh={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class eo{constructor(k,F){this.aabb=k,this.lastCascade=F}}class to{add(k,F){const Me=this.receivers[k.key];void 0!==Me?(Me.aabb.min[0]=Math.min(Me.aabb.min[0],F.min[0]),Me.aabb.min[1]=Math.min(Me.aabb.min[1],F.min[1]),Me.aabb.min[2]=Math.min(Me.aabb.min[2],F.min[2]),Me.aabb.max[0]=Math.max(Me.aabb.max[0],F.max[0]),Me.aabb.max[1]=Math.max(Me.aabb.max[1],F.max[1]),Me.aabb.max[2]=Math.max(Me.aabb.max[2],F.max[2])):this.receivers[k.key]=new eo(F,null)}clear(){this.receivers={}}get(k){return this.receivers[k.key]}computeRequiredCascades(F,Me,Ae){const Oe=k.cd.fromPoints(F.points);let Fe=0;for(const F in this.receivers){const je=this.receivers[F];if(!je)continue;if(!Oe.intersectsAabb(je.aabb))continue;je.aabb.min=Oe.closestPoint(je.aabb.min),je.aabb.max=Oe.closestPoint(je.aabb.max);const qe=je.aabb.getCorners();for(let F=0;F<Ae.length;F++){let Oe=!0;for(const Fe of qe){const je=[Fe[0]*Me,Fe[1]*Me,Fe[2]];if(k.ab.vec3.transformMat4(je,je,Ae[F].matrix),je[0]<-1||je[0]>1||je[1]<-1||je[1]>1){Oe=!1;break}}if(je.lastCascade=F,Fe=Math.max(Fe,F),Oe)break}}return Fe+1}}class io{constructor(k){this.painter=k,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new to,this._depthMode=new Fi(k.context.gl.LEQUAL,Fi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,k.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),k.tp.registerParameter(fh,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),k.tp.registerParameter(fh,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),k.tp.registerParameter(fh,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),k.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const k of this._cascades)k.texture.destroy(),k.framebuffer.destroy();this._cascades=[]}updateShadowParameters(F,Me){const Ae=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!Me||!Me.properties)return;const Oe=Me.properties.get("shadow-intensity");if(!Me.shadowsEnabled()||Oe<=0)return;if(this._shadowLayerCount=Ae.style.order.reduce(((k,Me)=>{const Oe=Ae.style._mergedLayers[Me];return k+(Oe.hasShadowPass()&&!Oe.isHidden(F.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const Fe=Ae.context,je=fh.shadowMapResolution,qe=fh.shadowMapResolution;if(0===this._cascades.length||fh.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let F=0;F<fh.cascadeCount;++F){const F=Ae._shadowMapDebug,Me=Fe.gl,Oe=Fe.createFramebuffer(je,qe,F,"texture"),pt=new k.T(Fe,{width:je,height:qe,data:null},Me.DEPTH_COMPONENT16);if(Oe.depthAttachment.set(pt.texture),F){const F=new k.T(Fe,{width:je,height:qe,data:null},Me.RGBA8);Oe.colorAttachment.set(F.texture)}this._cascades.push({framebuffer:Oe,texture:pt,matrix:[],far:0,boundingSphereRadius:0,frustum:new k.bR,scale:0})}}this.shadowDirection=so(Me);let pt=0;if(F.elevation){const k=F.elevation,Me=[1e4,-1e4];k.visibleDemTiles.filter((k=>k.dem)).forEach((k=>{const F=k.dem.tree;Me[0]=Math.min(Me[0],F.minimums[0]),Me[1]=Math.max(Me[1],F.maximums[0])})),1e4!==Me[0]&&(pt=(Me[1]-Me[0])*k.exaggeration())}const vt=1.5*F.cameraToCenterDistance,Ut=3*vt,xi=new Float64Array(16);for(let Me=0;Me<this._cascades.length;++Me){const Ae=this._cascades[Me];let Oe=F.height/50,Fe=1;1===fh.cascadeCount?Fe=Ut:0===Me?Fe=vt:(Oe=vt,Fe=Ut);const[je,qe]=ao(F,this.shadowDirection,Oe,Fe,fh.shadowMapResolution,pt);Ae.scale=F.scale,Ae.matrix=je,Ae.boundingSphereRadius=qe,k.ab.mat4.invert(xi,Ae.matrix),Ae.frustum=k.bR.fromInvProjectionMatrix(xi,1,0,!0),Ae.far=Fe}const vi=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[vi].far,this._cascades[vi].far],this._uniformValues.u_shadow_intensity=Oe,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/fh.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=fh.shadowMapResolution,this._uniformValues.u_shadowmap_0=uh.ShadowMap0,this._uniformValues.u_shadowmap_1=uh.ShadowMap0+1,this._groundShadowTiles=Ae.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const bi=Ae.transform.elevation;for(const k of this._groundShadowTiles){let F={min:0,max:0};if(bi){const Me=bi.getMinMaxForTile(k);Me&&(F=Me)}this.addShadowReceiver(k.toUnwrapped(),F.min,F.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(k){this._enabled=k}drawShadowPass(F,Me){if(!this.enabled)return;const Ae=this.painter,Oe=Ae.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(Ae.transform.getFrustum(0),Ae.transform.worldSize,this._cascades),Oe.viewport.set([0,0,fh.shadowMapResolution,fh.shadowMapResolution]);for(let Fe=0;Fe<this._numCascadesToRender;++Fe){Ae.currentShadowCascade=Fe,Oe.bindFramebuffer.set(this._cascades[Fe].framebuffer.framebuffer),Oe.clear({color:k.aj.white,depth:1});for(const k of F.order){const Oe=F._mergedLayers[k];if(!Oe.hasShadowPass()||Oe.isHidden(Ae.transform.zoom))continue;const Fe=F.getLayerSourceCache(Oe),je=Fe?Me[Fe.id]:void 0;("model"===Oe.type||je&&je.length)&&Ae.renderLayer(Ae,Fe,Oe,je)}}Ae.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const k=this.painter,F=k.style,Me=k.context,Ae=F.directionalLight,Oe=F.ambientLight;if(!Ae||!Oe)return;const Fe=[],je=Ji(k,k.longestCutoffRange);je.shouldRenderCutoff&&Fe.push("RENDER_CUTOFF"),Fe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&Fe.push("NORMAL_OFFSET");const qe=ro(F,Ae,Oe),pt=new Fi(Me.gl.LEQUAL,Fi.ReadOnly,k.depthRangeFor3D);for(const F of this._groundShadowTiles){const Ae=F.toUnwrapped(),Oe=k.isTileAffectedByFog(F),vt=k.getOrCreateProgram("groundShadow",{defines:Fe,overrideFog:Oe});this.setupShadows(Ae,vt),k.uploadCommonUniforms(Me,vt,Ae,null,je);const Ut={u_matrix:k.transform.calculateProjMatrix(Ae),u_ground_shadow_factor:qe};vt.draw(k,Me.gl.TRIANGLES,pt,Bi.disabled,Oi.multiply,Gi.disabled,Ut,"ground_shadow",k.tileExtentBuffer,k.quadTriangleIndexBuffer,k.tileExtentSegments,{},k.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Oi.unblended:Oi.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(F){const Me=this.painter.transform,Ae=Me.calculatePosMatrix(F,Me.worldSize);return k.ab.mat4.multiply(Ae,this._cascades[this.painter.currentShadowCascade].matrix,Ae),Float32Array.from(Ae)}calculateShadowPassMatrixFromMatrix(F){return k.ab.mat4.multiply(F,this._cascades[this.painter.currentShadowCascade].matrix,F),Float32Array.from(F)}setupShadows(F,Me,Ae,Oe=0){if(!this.enabled)return;const Fe=this.painter.transform,je=this.painter.context,qe=je.gl,pt=this._uniformValues,vt=new Float64Array(16),Ut=Fe.calculatePosMatrix(F,Fe.worldSize);for(let F=0;F<this._cascades.length;F++)k.ab.mat4.multiply(vt,this._cascades[F].matrix,Ut),pt[0===F?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(vt),je.activeTexture.set(qe.TEXTURE0+uh.ShadowMap0+F),this._cascades[F].texture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);if(this.useNormalOffset=!!Ae,this.useNormalOffset){const Me=k.cc(F.canonical),je=2/Fe.tileSize*k.ag/fh.shadowMapResolution,qe=je*this._cascades[0].boundingSphereRadius,vt=je*this._cascades[this._cascades.length-1].boundingSphereRadius,Ut=("vector-tile"===Ae?1:3)/Math.pow(2,Oe-F.canonical.z-(1-Fe.zoom+Math.floor(Fe.zoom)));pt.u_shadow_normal_offset=[Me,qe*Ut,vt*Ut],pt.u_shadow_bias=[6e-5,.0012,.012]}else pt.u_shadow_bias=[36e-5,.0012,.012];Me.setShadowUniformValues(je,pt)}setupShadowsFromMatrix(F,Me,Ae=!1){if(!this.enabled)return;const Oe=this.painter.context,Fe=Oe.gl,je=this._uniformValues,qe=new Float64Array(16);for(let Me=0;Me<fh.cascadeCount;Me++)k.ab.mat4.multiply(qe,this._cascades[Me].matrix,F),je[0===Me?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(qe),Oe.activeTexture.set(Fe.TEXTURE0+uh.ShadowMap0+Me),this._cascades[Me].texture.bind(Fe.NEAREST,Fe.CLAMP_TO_EDGE);if(this.useNormalOffset=Ae,Ae){const k=fh.normalOffset;je.u_shadow_normal_offset=[1,k,k],je.u_shadow_bias=[6e-5,.0012,.012]}else je.u_shadow_bias=[36e-5,.0012,.012];Me.setShadowUniformValues(Oe,je)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(F,Me,Ae,Oe){if(Oe[2]>=0)return{};const Fe=function(F,Me,Ae){const Oe=Ae/(1<<F.canonical.z);return new k.cd([F.canonical.x*Oe+F.wrap*Ae,F.canonical.y*Oe+F.wrap*Ae,0],[(F.canonical.x+1)*Oe+F.wrap*Ae,(F.canonical.y+1)*Oe+F.wrap*Ae,Me])}(F,Me,Ae).getCorners(),je=Me/-Oe[2];Oe[0]<0?(k.ab.vec3.add(Fe[0],Fe[0],[Oe[0]*je,0,0]),k.ab.vec3.add(Fe[3],Fe[3],[Oe[0]*je,0,0])):Oe[0]>0&&(k.ab.vec3.add(Fe[1],Fe[1],[Oe[0]*je,0,0]),k.ab.vec3.add(Fe[2],Fe[2],[Oe[0]*je,0,0])),Oe[1]<0?(k.ab.vec3.add(Fe[0],Fe[0],[0,Oe[1]*je,0]),k.ab.vec3.add(Fe[1],Fe[1],[0,Oe[1]*je,0])):Oe[1]>0&&(k.ab.vec3.add(Fe[2],Fe[2],[0,Oe[1]*je,0]),k.ab.vec3.add(Fe[3],Fe[3],[0,Oe[1]*je,0]));const qe={};return qe.vertices=Fe,qe.planes=[oo(Fe[1],Fe[0],Fe[4]),oo(Fe[2],Fe[1],Fe[5]),oo(Fe[3],Fe[2],Fe[6]),oo(Fe[0],Fe[3],Fe[7])],qe}addShadowReceiver(F,Me,Ae){this._receivers.add(F,k.cd.fromTileIdAndHeight(F,Me,Ae))}getMaxCascadeForTile(k){const F=this._receivers.get(k);return F&&F.lastCascade?F.lastCascade:0}}function oo(F,Me,Ae){const Oe=k.ab.vec3.sub([],Ae,Me),Fe=k.ab.vec3.sub([],F,Me),je=k.ab.vec3.cross([],Oe,Fe),qe=k.ab.vec3.length(je);return 0===qe?[0,0,1,0]:(k.ab.vec3.scale(je,je,1/qe),[je[0],je[1],je[2],-k.ab.vec3.dot(je,Me)])}function so(F){const Me=F.properties.get("direction"),Ae=k.cb(Me.x,Me.y,Me.z);Ae[2]=k.aw(Ae[2],0,75);const Oe=k.ce([Ae[0],Ae[1],Ae[2]]);return k.ab.vec3.fromValues(Oe.x,Oe.y,Oe.z)}function ro(F,Me,Ae){const Oe="none"===Me.properties.get("color-use-theme"),Fe=Me.properties.get("color"),je=Me.properties.get("intensity"),qe=Me.properties.get("direction"),pt=[qe.x,qe.y,qe.z],vt="none"===Ae.properties.get("color-use-theme"),Ut=Ae.properties.get("color"),xi=Ae.properties.get("intensity"),vi=Math.max(k.ab.vec3.dot([0,0,1],pt),0),bi=[0,0,0];k.ab.vec3.scale(bi,Ut.toRenderColor(vt?null:F.getLut(Me.scope)).toArray01Linear().slice(0,3),xi);const wi=[0,0,0];return k.ab.vec3.scale(wi,Fe.toRenderColor(Oe?null:F.getLut(Ae.scope)).toArray01Linear().slice(0,3),vi*je),k.cf([bi[0]>0?bi[0]/(bi[0]+wi[0]):0,bi[1]>0?bi[1]/(bi[1]+wi[1]):0,bi[2]>0?bi[2]/(bi[2]+wi[2]):0])}function ao(F,Me,Ae,Oe,Fe,je){const qe=F.zoom,pt=F.scale,vt=F.worldSize,Ut=1/vt,xi=F.aspect,vi=Math.sqrt(1+xi*xi)*Math.tan(.5*F.fovX),bi=vi*vi,wi=Oe-Ae,Mi=Oe+Ae;let pr,Ur;bi>wi/Mi?(pr=Oe,Ur=Oe*vi):(pr=.5*Mi*(1+bi),Ur=.5*Math.sqrt(wi*wi+2*(Oe*Oe+Ae*Ae)*bi+Mi*Mi*bi*bi));const Wr=F.projection.pixelsPerMeter(F.center.lat,vt),Jr=F._camera.getCameraToWorldMercator(),Qr=[0,0,-pr*Ut];k.ab.vec3.transformMat4(Qr,Qr,Jr);let co=Ur*Ut;const mo=F._edgeInsets;if(!(0===mo.left&&0===mo.top&&0===mo.right&&0===mo.bottom||mo.left===mo.right&&mo.top===mo.bottom)){const Me=F._camera.getWorldToCamera(F.worldSize,"meters"===F.projection.zAxisUnit?Wr:1),Fe=F._camera.getCameraToClipPerspective(F._fov,F.width/F.height,Ae,Oe);Fe[8]=2*-F.centerOffset.x/F.width,Fe[9]=2*F.centerOffset.y/F.height;const je=new Float64Array(16);k.ab.mat4.mul(je,Fe,Me);const Ut=new Float64Array(16);k.ab.mat4.invert(Ut,je);const xi=k.bR.fromInvProjectionMatrix(Ut,vt,qe,!0);for(const Me of xi.points){const Ae=((yo=Me)[0]/=pt,yo[1]/=pt,yo[2]=k.bH(yo[2],F._center.lat),yo);co=Math.max(co,k.ab.vec3.len(k.ab.vec3.subtract([],Qr,Ae)))}}var yo;co*=Fe/(Fe-1);const To=Math.acos(Me[2]),zo=Math.atan2(-Me[0],-Me[1]),ko=new Zi;ko.position=Qr,ko.setPitchBearing(To,zo);const na=ko.getWorldToCamera(vt,Wr),aa=co*vt,_a=Math.min(F._mercatorZfromZoom(17)*vt*-2,-2*aa),wa=ko.getCameraToClipOrthographic(-aa,aa,-aa,aa,_a,(aa+je*Wr)/Me[2]),Sa=new Float64Array(16);k.ab.mat4.multiply(Sa,wa,na);const Ya=k.ab.vec3.fromValues(Math.floor(1e6*Qr[0])/1e6*vt,Math.floor(1e6*Qr[1])/1e6*vt,0),rl=.5*Fe,sl=[0,0,0];k.ab.vec3.transformMat4(sl,Ya,Sa),k.ab.vec3.scale(sl,sl,rl);const ml=[Math.floor(sl[0]),Math.floor(sl[1]),Math.floor(sl[2])],Sl=[0,0,0];k.ab.vec3.sub(Sl,sl,ml),k.ab.vec3.scale(Sl,Sl,-1/rl);const Il=new Float64Array(16);return k.ab.mat4.identity(Il),k.ab.mat4.translate(Il,Il,Sl),k.ab.mat4.multiply(Sa,Il,Sa),[Sa,aa]}class no extends k.E{constructor(k){super(),this.requestManager=k,this.models={"":{}},this.numModelsLoading={}}loadModel(F,Me){return k.aM(this.requestManager.transformRequest(Me,k.R.Model).url).then((Me=>{if(!Me)return;const Ae=k.aN(Me),Oe=new k.aO(F,void 0,void 0,Ae);return Oe.computeBoundsAndApplyParent(),Oe})).catch((Ae=>{if(Ae&&404===Ae.status)return null;this.fire(new k.y(new Error(`Could not load model ${F} from ${Me}: ${Ae.message}`)))}))}load(F,Me){this.models[Me]||(this.models[Me]={});const Ae=Object.keys(F);this.numModelsLoading[Me]=(this.numModelsLoading[Me]||0)+Ae.length;const Oe=[];for(const k of Ae)Oe.push(this.loadModel(k,F[k]));Promise.allSettled(Oe).then((F=>{for(let k=0;k<F.length;k++){const{status:Oe,value:Fe}=F[k];"fulfilled"===Oe&&Fe&&(this.models[Me][Ae[k]]={model:Fe,numReferences:1})}this.numModelsLoading[Me]-=Ae.length,this.fire(new k.z("data",{dataType:"style"}))})).catch((F=>{this.fire(new k.y(new Error(`Could not load models: ${F.message}`)))}))}isLoaded(){for(const k in this.numModelsLoading)if(this.numModelsLoading[k]>0)return!1;return!0}hasModel(k,F){return!!this.getModel(k,F)}getModel(k,F){return this.models[F]||(this.models[F]={}),this.models[F][k]?this.models[F][k].model:void 0}addModel(k,F,Me){this.models[Me]||(this.models[Me]={}),this.hasModel(k,Me)&&this.models[Me][k].numReferences++,this.load({[k]:this.requestManager.normalizeModelURL(F)},Me)}addModels(k,F){this.models[F]||(this.models[F]={});const Me={};for(const Ae in k)this.models[F][Ae]={},Me[Ae]=this.requestManager.normalizeModelURL(k[Ae]);this.load(Me,F)}addModelsFromBucket(k,F){this.models[F]||(this.models[F]={});const Me={};for(const Ae of k)this.hasModel(Ae,F)?this.models[F][Ae].numReferences++:Me[Ae]=this.requestManager.normalizeModelURL(Ae);this.load(Me,F)}removeModel(k,F){if(this.models[F]&&this.models[F][k]&&(this.models[F][k].numReferences--,0===this.models[F][k].numReferences)){const Me=this.models[F][k].model;delete this.models[F][k],Me.destroy()}}listModels(k){return this.models[k]||(this.models[k]={}),Object.keys(this.models[k])}upload(k,F){this.models[F]||(this.models[F]={});for(const Me in this.models[F])this.models[F][Me].model&&this.models[F][Me].model.upload(k.context)}}const vh=new k.a5({data:new k.a6(k.a3.colorTheme.data)}),Th={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function ho(k){return k=k||{},Object.assign(k,Th)}class uo extends k.E{constructor(F){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},k.aP(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=F,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle((F=>{F.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new k.y(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=F.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=F.stylesheet.indoor.buildingFeaturesetId,this._scope=F.scope))})),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:k=>(k.feature&&k.feature.properties.floorplan&&this.selectFloorplan(k.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(F){if(!this._queryFeatureSetId)return;if(!this._map.isStyleLoaded())return;if(this._map.transform.zoom<13)return;this._indoorData&&!function(k,F){const[Me,Ae]=k,{center:Oe,radius:Fe}=F,[je,qe]=Oe,pt=Math.abs(Me-je);return Math.sqrt((pt>180?360-pt:pt)**2+(Ae-qe)**2)<=Fe}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new k.z("floorplangone")));const Me={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Ae=new k.P(this._map.transform.width/2,this._map.transform.height/2),Oe=[new k.P(0,0),new k.P(this._map.transform.width,this._map.transform.height)],Fe=this._map.queryRenderedFeatures(F?Oe:Ae,Me);Fe.length>0&&(this._selectedFloorplan&&Fe[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=Fe[0],this._floorplanSelected(!1)))}_floorplanSelected(F){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(k){const[[F,Me],[Ae,Oe]]=k,Fe=(Ae-F+360)%360,je=Fe>180?360-Fe:Fe;return{center:[(F+je/2+360)%360,(Me+Oe)/2],radius:Math.sqrt(je**2+(Oe-Me)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const Me=this._floorplanStates[this._indoorData.id].selectedBuilding,Ae=this._floorplanStates[this._indoorData.id].selectedLevel;let Oe;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const k of this._indoorData.levels)k.id===this._selectedLevel.id&&(Oe=k.id);if(this.fire(new k.z("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:Oe})),Me){const k=this._indoorData.buildings.find((k=>k.id===Me));this._buildingSelected(k,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(Ae){const k=this._indoorData.levels.find((k=>k.id===Ae));this._updateLevels(k,F)}else F&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(F,Me){Me&&F&&F.extent&&this._map.fitBounds(F.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=F?F.id:void 0;const Ae=this._indoorData.levels.filter((k=>F.levels.includes(k.id)));this.fire(new k.z("buildingselected",{buildingId:F.id,levels:Ae}))}_levelSelected(F){if("overview"===F)this._updateLevels(void 0,!0);else{const k=this._indoorData.levels.find((k=>k.id===F));this._updateLevels(k,!0)}this.fire(new k.z("levelselected",{levelId:"overview"===F?void 0:F}))}_updateLevels(k,F){if(!k)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(F&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function i(k){const F=k.indexOf("/floor/");if(-1===F)return k;const Me=F+7,Ae=k.indexOf("/",Me);return-1===Ae?k.slice(Me):k.slice(Me,Ae)}this._selectedLevel=k,this._floorplanStates[this._indoorData.id].selectedLevel=k?k.id:void 0;const Me=[],Ae={},Oe={},Fe={},je={};for(const F of this._indoorData.levels)if(Me.push(F.id),Ae[F.id]=F.height,Oe[F.id]=F.base,k){if(this.mergeFloors){const Me=i(k.id),Ae=i(F.id);Fe[F.id]=Ae===Me?"true":"false"}else Fe[F.id]=F.id===k.id?"true":"false";je[F.id]=F.base<k.base?"true":"false"}else je[F.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",Me]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",Ae]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",Oe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",Fe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",je]),k&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!k.isUnderground),F&&k.extent)){const F=this._map.cameraForBounds(k.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),Me=this._map.getZoom(),Ae=F.zoom?Math.abs(Me-F.zoom):0;this._map.fitBounds(k.extent,Ae>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:Me})}}selectFloorplan(F){const Me={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Ae=[new k.P(0,0),new k.P(this._map.transform.width,this._map.transform.height)],Oe=this._map.queryRenderedFeatures(Ae,Me);if(Oe.length>0)for(const k of Oe)if(JSON.parse(k.properties["indoor-data"]).floorplanIDs.includes(F)){this._selectedFloorplan=k,this._floorplanSelected(!0);break}}selectBuilding(k){const F=this._indoorData.buildings.find((F=>F.id===k));this._buildingSelected(F,!0)}selectLevel(k){this._levelSelected(k)}}function _o(F){if(!F.metadata||!F.metadata.content_area)return;const Me=k.q.devicePixelRatio,{left:Ae,top:Oe,width:Fe,height:je}=F.metadata.content_area,qe=Ae*Me,pt=Oe*Me;return[qe,pt,qe+Fe*Me,pt+je*Me]}function po(F){if(F)return F.map((([F,Me])=>[F*k.q.devicePixelRatio,Me*k.q.devicePixelRatio]))}const fo=(k,F)=>Le(k,F&&F.filter((k=>"source.canvas"!==k.identifier))),Ch=k.ay(Gc,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),Dh=k.ay(Gc,["setCenter","setZoom","setBearing","setPitch"]),Rh=new Set(["background","sky","slot","custom"]),Lh={version:8,layers:[],sources:{}},Oh={duration:300,delay:0};class bo extends k.E{constructor(F,Me={}){super(),this.map=F,this.scope=Me.scope||"",this.globalId=null,this.fragments=[],this.importDepth=Me.importDepth||0,this.importsCache=Me.importsCache||new Map,this.resolvedImports=Me.resolvedImports||new Set,this.transition=k.l({},Oh),this._buildingIndex=new It(this),this.crossTileSymbolIndex=new Pi,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=Me.styleChanges||new j,this.dispatcher=Me.dispatcher?Me.dispatcher:new k.D(k.ci(),this),Me.imageManager?this.imageManager=Me.imageManager:(this.imageManager=new q(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=Me.glyphManager?Me.glyphManager:new k.cj(F._requestManager,Me.localFontFamily?k.ck.all:Me.localIdeographFontFamily?k.ck.ideographs:k.ck.none,Me.localFontFamily||Me.localIdeographFontFamily),Me.modelManager?this.modelManager=Me.modelManager:(this.modelManager=new no(F._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=Me.configOptions?Me.configOptions:new Map,this._configDependentLayers=Me.configDependentLayers?Me.configDependentLayers:new Set,this._config=Me.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:Me.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=Me.initialConfig,this.dispatcher.broadcast("setReferrer",k.cl());const Ae=this;this._rtlTextPluginCallback=bo.registerForPluginStateChange((F=>{Ae.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:F.pluginStatus,pluginURL:F.pluginURL},((F,Me)=>{if(k.cm(F),Me&&Me.every((k=>k)))for(const k in Ae._sourceCaches){const F=Ae._sourceCaches[k],Me=F.getSource().type;"vector"!==Me&&"geojson"!==Me||F.reload()}}))})),this.on("data",(k=>{if("source"!==k.dataType||"metadata"!==k.sourceDataType)return;const F=this.getOwnSource(k.sourceId);if(F&&F.vectorLayerIds)for(const k in this._layers){const Me=this._layers[k];Me.source===F.id&&this._validateLayer(Me)}}))}load(k){return k?("string"==typeof k?this.loadURL(k):this.loadJSON(k),this):this}_getGlobalId(F){if(!F)return null;if("string"==typeof F){if(k.f(F))return F;const Me=k.cn(F);if(!Me.startsWith("http"))try{return new URL(Me,location.href).toString()}catch(k){return Me}return Me}return`json://${k.co(JSON.stringify(F))}`}_diffStyle(F,Me,Ae){this.globalId=this._getGlobalId(F);const s=(k,F)=>{try{F(null,this.setState(k,Ae))}catch(k){F(k,!1)}};if("string"==typeof F){const Ae=this.map._requestManager.normalizeStyleURL(F),Oe=this.map._requestManager.transformRequest(Ae,k.R.Style);k.n(Oe,((F,Ae)=>{F?this.fire(new k.y(F)):Ae&&s(Ae,Me)}))}else"object"==typeof F&&s(F,Me)}loadURL(F,Me={}){this.fire(new k.z("dataloading",{dataType:"style"}));const Ae="boolean"==typeof Me.validate?Me.validate:!k.f(F);this.globalId=this._getGlobalId(F),F=this.map._requestManager.normalizeStyleURL(F,Me.accessToken),this.resolvedImports.add(F);const Oe=this.importsCache.get(F);if(Oe)return this._load(Oe,Ae);const Fe=this.map._requestManager.transformRequest(F,k.R.Style);this._request=k.n(Fe,((Me,Oe)=>{if(this._request=null,Me)this.fire(new k.y(Me));else if(Oe)return this.importsCache.set(F,Oe),this._load(Oe,Ae)}))}loadJSON(F,Me={}){this.fire(new k.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(F),this._request=k.q.frame((()=>{this._request=null,this._load(F,!1!==Me.validate)}))}loadEmpty(){this.fire(new k.z("dataloading",{dataType:"style"})),this._load(Lh,!1)}_loadImports(F,Me,Ae){if(this.importDepth>=4)return k.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const Oe=[];for(const k of F){const F=this._createFragmentStyle(k),Fe=new Promise((k=>{F.once("style.import.load",k),F.once("error",k)})).then((()=>this.mergeAll()));if(Oe.push(Fe),this.resolvedImports.has(k.url)){F.loadEmpty();continue}const je=k.data||this.importsCache.get(k.url);je?(F.loadJSON(je,{validate:Me}),this._isInternalStyle(je)&&(F.globalId=null)):k.url?F.loadURL(k.url,{validate:Me}):F.loadEmpty();const qe={style:F,id:k.id,config:k.config};if(Ae){const k=this.fragments.findIndex((({id:k})=>k===Ae));this.fragments=this.fragments.slice(0,k).concat(qe).concat(this.fragments.slice(k))}else this.fragments.push(qe)}return Promise.allSettled(Oe)}getImportGlobalIds(k=this,F=new Set){for(const Me of k.fragments)Me.style.globalId&&F.add(Me.style.globalId),this.getImportGlobalIds(Me.style,F);return[...F.values()]}_createFragmentStyle(F){const Me=this.scope?k.aC(F.id,this.scope):F.id;let Ae;const Oe=this._initialConfig&&this._initialConfig[Me];(F.config||Oe)&&(Ae=k.l({},F.config,Oe));const Fe=new bo(this.map,{scope:Me,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:Ae,configOptions:this.options,colorThemeOverride:F["color-theme"],configDependentLayers:this._configDependentLayers});return Fe.setEventedParent(this.map,{style:Fe}),Fe}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(k){return this.isRootStyle()&&(k.fragment||!!k.schema&&!1!==k.fragment)}_load(F,Me){const Ae=F.indoor?ho(F.schema):F.schema;if(this._isInternalStyle(F)){const Ae=k.l({},Lh,{imports:[{id:"basemap",data:F,url:""}]});return void this._load(Ae,Me)}if(this.updateConfig(this._config,Ae),Me&&fo(this,me(F)))return;this._loaded=!0,this.stylesheet=k.cp(F);const s=()=>{for(const k in F.sources)this.addSource(k,F.sources[k],{validate:!1,isInitialLoad:!0});F.sprite?this._loadIconset(F.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(F.glyphs,this.scope);const Ae=Dt(this.stylesheet.layers);if(this._order=Ae.map((k=>k.id)),this.stylesheet.light&&k.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const k=this.stylesheet.lights[0];this.light=new ze(k.properties,k.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ze(this.stylesheet.light)),this._layers={};for(const F of Ae){const Me=k.cu(F,this.scope,this._styleColorTheme.lut,this.options);0!==Me.configDependencies.size&&this._configDependentLayers.add(Me.fqid),Me.setEventedParent(this,{layer:{id:Me.id}}),this._layers[Me.id]=Me;const Ae=this.getOwnLayerSourceCache(Me),Oe=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Ae&&Me.canCastShadows()&&Oe&&(Ae.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const Oe=this.stylesheet.terrain;Oe&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(Oe,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new k.z("data",{dataType:"style"}));const Fe=this.isRootStyle();F.imports?this._loadImports(F.imports,Me).then((()=>{this._reloadImports(),this.fire(new k.z(Fe?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new k.z(Fe?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const Oe=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(Oe){const F=this._evaluateColorThemeData(Oe);this._loadColorTheme(F).then((()=>{s()})).catch((F=>{k.w(`Couldn't load color theme from the stylesheet: ${F}`),s()}))}else this._styleColorTheme.lut=null,s()}isRootStyle(){return 0===this.importDepth}mergeAll(){let F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut;const xi={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((k=>{if(k.stylesheet){if(null!=k.light&&(F=k.light),k.stylesheet.lights)for(const F of k.stylesheet.lights)"ambient"===F.type&&null!=k.ambientLight&&(Me=k.ambientLight),"directional"===F.type&&null!=k.directionalLight&&(Ae=k.directionalLight);Oe=this._prioritizeTerrain(Oe,k.terrain,k.stylesheet.terrain),k.stylesheet.fog&&null!=k.fog&&(Fe=k.fog),k.stylesheet.snow&&null!=k.snow&&(je=k.snow),k.stylesheet.rain&&null!=k.rain&&(qe=k.rain),null!=k.stylesheet.camera&&(Ut=k.stylesheet.camera),null!=k.stylesheet.projection&&(pt=k.stylesheet.projection),null!=k.stylesheet.transition&&(vt=k.stylesheet.transition),xi[k.scope]=k._styleColorTheme}})),this.light=F,this.ambientLight=Me,this.directionalLight=Ae,this.fog=Fe,this.snow=je,this.rain=qe,this._styleColorThemeForScope=xi,null===Oe?delete this.terrain:this.terrain=Oe,this.camera=Ut||{"camera-projection":"perspective"},this.projection=pt||{name:"mercator"},this.transition=k.l({},Oh,vt),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(k){const t=F=>{for(const k of F.fragments)t(k.style);k(F)};t(this)}_prioritizeTerrain(k,F,Me){const Ae=k&&0===k.drapeRenderMode;return null===Me?F&&0===F.drapeRenderMode?F:Ae?k:null:null!=F&&(!k||Ae||F&&1===F.drapeRenderMode)?F:k}mergeTerrain(){let k;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((F=>{k=this._prioritizeTerrain(k,F.terrain,F.stylesheet.terrain)})),null===k?delete this.terrain:this.terrain=k}mergeProjection(){let k;this.forEachFragmentStyle((F=>{null!=F.stylesheet.projection&&(k=F.stylesheet.projection)})),this.projection=k||{name:"mercator"}}mergeSources(){const F={},Me={},Ae={};this.forEachFragmentStyle((Oe=>{for(const Me in Oe._sourceCaches){const Ae=k.aC(Me,Oe.scope);F[Ae]=Oe._sourceCaches[Me]}for(const F in Oe._otherSourceCaches){const Ae=k.aC(F,Oe.scope);Me[Ae]=Oe._otherSourceCaches[F]}for(const F in Oe._symbolSourceCaches){const Me=k.aC(F,Oe.scope);Ae[Me]=Oe._symbolSourceCaches[F]}})),this._mergedSourceCaches=F,this._mergedOtherSourceCaches=Me,this._mergedSymbolSourceCaches=Ae}mergeLayers(){const F={},Me=[],Ae={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((Ae=>{for(const Oe of Ae._order){const Fe=Ae._layers[Oe];if("slot"===Fe.type){const Me=k.cq(Oe);if(F[Me])continue;F[Me]=[]}Fe.slot&&F[Fe.slot]?F[Fe.slot].push(Fe):Me.push(Fe)}})),this._mergedOrder=[];const s=(Me=[])=>{for(const Oe of Me)if("slot"===Oe.type){const Me=k.cq(Oe.id);F[Me]&&s(F[Me]),this._mergedSlots.push(Me)}else{const F=k.aC(Oe.id,Oe.scope);this._mergedOrder.push(F),Ae[F]=Oe,Oe.is3D()&&(this._has3DLayers=!0),"circle"===Oe.type&&(this._hasCircleLayers=!0),"symbol"===Oe.type&&(this._hasSymbolLayers=!0),"clip"===Oe.type&&(this._clipLayerPresent=!0)}};s(Me),this._mergedOrder.sort(((k,F)=>{const Me=Ae[k],Oe=Ae[F];return Me.hasInitialOcclusionOpacityProperties?Oe.is3D()?1:0:Me.is3D()&&Oe.hasInitialOcclusionOpacityProperties?-1:0})),this._mergedLayers=Ae,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(F){return this.stylesheet.camera=k.l({},this.stylesheet.camera,F),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(F){return F.data?function(F,Me,Ae){const Oe=k.l({},Me);for(const F of Object.keys(k.a3.colorTheme))void 0===Oe[F]&&(Oe[F]=k.a3.colorTheme[F].default);const Fe=new k.a4(vh,F,new Map(Ae));return Fe.setTransitionOrValue(Oe,Ae),Fe.untransitioned().possiblyEvaluate(new k.a8(0))}(this.scope,F,this.options).get("data"):null}_loadColorTheme(F){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const Me=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((Ae,Oe)=>{const Fe="data:image/png;base64,";if(!F||0===F.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void Ae();let je=F;je.startsWith(Fe)||(je=Fe+je);const qe="mapbox-reserved-lut",pt=new Image;pt.src=je,pt.onerror=()=>{this._styleColorTheme.lutLoading=!1,Oe(new Error("Failed to load image data"))},pt.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==Me)return void Ae();this._styleColorTheme.lutLoading=!1;const{width:Fe,height:je,data:vt}=k.q.getImageData(pt);if(je>32)return void Oe(new Error("The height of the image must be less than or equal to 32 pixels."));if(Fe!==je*je)return void Oe(new Error("The width of the image must be equal to the height squared."));this.getImage(qe)&&this.removeImage(qe),this.addImage(qe,{data:new k.r({width:Fe,height:je},vt),pixelRatio:1,sdf:!1,usvg:!1,version:0});const Ut=this.imageManager.getImage(qe,this.scope);Ut?(this._styleColorTheme.lut={image:Ut.data,data:F},Ae()):Oe(new Error("Missing LUT image."))}}))}getLut(k){const F=this._styleColorThemeForScope[k];return F?F.lut:null}setProjection(k){k?this.stylesheet.projection=k:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(F){this._spriteRequest=function(F,Me,Ae){let Oe,Fe,je;const qe=k.q.devicePixelRatio>1?"@2x":"";let pt=k.n(Me.transformRequest(Me.normalizeSpriteURL(F,qe,".json"),k.R.SpriteJSON),((k,F)=>{pt=null,je||(je=k,Oe=F,h())})),vt=k.o(Me.transformRequest(Me.normalizeSpriteURL(F,qe,".png"),k.R.SpriteImage),((k,F)=>{vt=null,je||(je=k,Fe=F,h())}));function h(){if(je)Ae(je);else if(Oe&&Fe){const F=k.q.getImageData(Fe),Me={};for(const Ae in Oe){const{width:Fe,height:je,x:qe,y:pt,sdf:vt,pixelRatio:Ut,stretchX:xi,stretchY:vi,content:bi}=Oe[Ae],wi=new k.r({width:Fe,height:je});k.r.copy(F,wi,{x:qe,y:pt},{x:0,y:0},{width:Fe,height:je},null),Me[Ae]={data:wi,pixelRatio:Ut,sdf:vt,stretchX:xi,stretchY:vi,content:bi,usvg:!1}}Ae(null,Me)}}return{cancel(){pt&&(pt.cancel(),pt=null),vt&&(vt.cancel(),vt=null)}}}(F,this.map._requestManager,((F,Me)=>{if(this._spriteRequest=null,F)this.fire(new k.y(F));else if(Me)for(const k in Me)this.imageManager.addImage(k,this.scope,Me[k]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new k.z("data",{dataType:"style"}))}))}_loadIconset(F){if(!k.f(F)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(F);const Me="auto"===this.map._spriteFormat;var Ae,Oe;this._spriteRequest=(Oe=(Ae,Oe)=>{if(this._spriteRequest=null,Ae)Me?this._loadSprite(F):this.fire(new k.y(Ae));else if(Oe)for(const k in Oe)this.imageManager.addImage(k,this.scope,Oe[k]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new k.z("data",{dataType:"style"}))},k.bi((Ae=this.map._requestManager).transformRequest(Ae.normalizeIconsetURL(F),k.R.Iconset),((F,Me)=>{if(F)return void Oe(F);const Ae={},Fe=k.cg(new k.bh(Me));for(const F of Fe.icons){const Me={version:1,pixelRatio:k.q.devicePixelRatio,content:_o(F),stretchX:F.metadata?po(F.metadata.stretch_x_areas):void 0,stretchY:F.metadata?po(F.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:F};Ae[F.name]=Me}Oe(null,Ae)})))}_validateLayer(F){const Me=this.getOwnSource(F.source);if(!Me)return;const Ae=F.sourceLayer;Ae&&("geojson"===Me.type||Me.vectorLayerIds&&-1===Me.vectorLayerIds.indexOf(Ae))&&this.fire(new k.y(new Error(`Source layer "${Ae}" does not exist on source "${Me.id}" as specified by style layer "${F.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const k in this._sourceCaches)if(!this._sourceCaches[k].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:k}of this.fragments)if(!k.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((k,F)=>{const Me=this.fragments[F];return Me&&Me.style&&(k.data=Me.style.serialize()),k}))}_serializeSources(){const k={};for(const F in this._sourceCaches){const Me=this._sourceCaches[F].getSource();k[Me.id]||(k[Me.id]=Me.serialize())}return k}_serializeLayers(k){const F=[];for(const Me of k){const k=this._layers[Me];k&&"custom"!==k.type&&F.push(k.serialize())}return F}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;if(this.hasSnowTransition())return!0;if(this.hasRainTransition())return!0;for(const k in this._sourceCaches)if(this._sourceCaches[k].hasTransition())return!0;for(const k in this._layers)if(this._layers[k].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(k){return k?this.order:this._mergedOrder}isLayerDraped(k){return!!this.terrain&&k.isDraped(this.getLayerSourceCache(k))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(F){const Me=this.getOwnLayer(F);if(Me)return Me;this.fire(new k.y(new Error(`The layer '${F}' does not exist in the map's style.`)))}_checkSource(F){const Me=this.getOwnSource(F);if(Me)return Me;this.fire(new k.y(new Error(`The source '${F}' does not exist in the map's style.`)))}precompilePrograms(k,F){const Me=this.map.painter;if(Me)for(let Ae=k.minzoom||0;Ae<(k.maxzoom||25.5);Ae++){const Ae=k.getProgramIds();if(Ae)for(const Oe of Ae){const Ae=k.getDefaultProgramParams(Oe,F.zoom,this._styleColorTheme.lut);Ae&&(Me.style=this,this.fog&&(Me._fogVisible=!0,Ae.overrideFog=!0,Me.getOrCreateProgram(Oe,Ae)),Me._fogVisible=!1,Ae.overrideFog=!1,Me.getOrCreateProgram(Oe,Ae),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(Ae.overrideRtt=!0,Me.getOrCreateProgram(Oe,Ae)))}}}update(F){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(F),this.directionalLight&&this.directionalLight.recalculate(F);const Me=this.calculateLightsBrightness();F.brightness=Me||0,Me!==this._brightness&&(this._brightness=Me,this.dispatcher.broadcast("setBrightness",Me));const Ae=this._changes.isDirty();let Oe=!1;if(this._changes.isDirty()){const k=this._changes.getLayerUpdatesByScope();for(const F in k){const{updatedIds:Me,removedIds:Ae}=k[F];(Me||Ae)&&(this._updateWorkerLayers(F,Me,Ae),Oe=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(F),this.light&&this.light.updateTransitions(F),this.ambientLight&&this.ambientLight.updateTransitions(F),this.directionalLight&&this.directionalLight.updateTransitions(F),this.fog&&this.fog.updateTransitions(F),this.snow&&this.snow.updateTransitions(F),this.rain&&this.rain.updateTransitions(F),this._changes.reset()}const Fe={};for(const k in this._mergedSourceCaches){const F=this._mergedSourceCaches[k];Fe[k]=F.used,F.used=!1,F.tileCoverLift=0}for(const k of this._mergedOrder){const Me=this._mergedLayers[k];if(Me.recalculate(F,this._availableImages),!Me.isHidden(F.zoom)){const k=this.getLayerSourceCache(Me);k&&(k.used=!0,k.tileCoverLift=Math.max(k.tileCoverLift,Me.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(Me,F)})):this.precompilePrograms(Me,F))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&Oe&&this.mergeLayers();for(const F in Fe){const Me=this._mergedSourceCaches[F];Fe[F]!==Me.used&&Me.getSource().fire(new k.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:Me.getSource().id}))}this.light&&this.light.recalculate(F),this.terrain&&this.terrain.recalculate(F),this.fog&&this.fog.recalculate(F),this.snow&&this.snow.recalculate(F),this.rain&&this.rain.recalculate(F),this.z=F.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),Ae&&this.fire(new k.z("data",{dataType:"style"}))}_updateTilesForChangedImages(){const k=this._changes.getUpdatedImages();if(k.length){for(const F in this._sourceCaches)this._sourceCaches[F].reloadTilesForDependencies(["icons","patterns"],k);this._changes.resetUpdatedImages()}}_updateWorkerLayers(k,F,Me){const Ae=this.getFragmentStyle(k);Ae&&this.dispatcher.broadcast("updateLayers",{layers:F?Ae._serializeLayers(F):[],scope:k,removedIds:Me||[],options:Ae.options})}setState(F,Me){if(this._checkLoaded(),fo(this,me(F)))return!1;(F=k.cp(F)).layers=Dt(F.layers);const Ae=function(F,Me){if(!F)return[{command:Gc.setStyle,args:[Me]}];let Ae=[];try{if(!k.bn(F.version,Me.version))return[{command:Gc.setStyle,args:[Me]}];if(k.bn(F.center,Me.center)||Ae.push({command:Gc.setCenter,args:[Me.center]}),k.bn(F.zoom,Me.zoom)||Ae.push({command:Gc.setZoom,args:[Me.zoom]}),k.bn(F.bearing,Me.bearing)||Ae.push({command:Gc.setBearing,args:[Me.bearing]}),k.bn(F.pitch,Me.pitch)||Ae.push({command:Gc.setPitch,args:[Me.pitch]}),k.bn(F.sprite,Me.sprite)||Ae.push({command:Gc.setSprite,args:[Me.sprite]}),k.bn(F.glyphs,Me.glyphs)||Ae.push({command:Gc.setGlyphs,args:[Me.glyphs]}),k.bn(F.imports,Me.imports)||function(F=[],Me=[],Ae){Me=Me||[];const Oe=(F=F||[]).map(Ft),Fe=Me.map(Ft),je=F.reduce(kt,{}),qe=Me.reduce(kt,{}),pt=Oe.slice();let vt,Ut,xi,vi;for(vt=0,Ut=0;vt<Oe.length;vt++)xi=Oe[vt],qe.hasOwnProperty(xi)?Ut++:(Ae.push({command:Gc.removeImport,args:[xi]}),pt.splice(pt.indexOf(xi,Ut),1));for(vt=0,Ut=0;vt<Fe.length;vt++)xi=Fe[Fe.length-1-vt],pt[pt.length-1-vt]!==xi&&(je.hasOwnProperty(xi)?(Ae.push({command:Gc.removeImport,args:[xi]}),pt.splice(pt.lastIndexOf(xi,pt.length-Ut),1)):Ut++,vi=pt[pt.length-vt],Ae.push({command:Gc.addImport,args:[qe[xi],vi]}),pt.splice(pt.length-vt,0,xi));for(const F of Me){const Me=je[F.id];Me&&!k.bn(Me,F)&&Ae.push({command:Gc.updateImport,args:[F.id,F]})}}(F.imports,Me.imports,Ae),k.bn(F.transition,Me.transition)||Ae.push({command:Gc.setTransition,args:[Me.transition]}),k.bn(F.light,Me.light)||Ae.push({command:Gc.setLight,args:[Me.light]}),k.bn(F.fog,Me.fog)||Ae.push({command:Gc.setFog,args:[Me.fog]}),k.bn(F.snow,Me.snow)||Ae.push({command:Gc.setSnow,args:[Me.snow]}),k.bn(F.rain,Me.rain)||Ae.push({command:Gc.setRain,args:[Me.rain]}),k.bn(F.projection,Me.projection)||Ae.push({command:Gc.setProjection,args:[Me.projection]}),k.bn(F.lights,Me.lights)||Ae.push({command:Gc.setLights,args:[Me.lights]}),k.bn(F.camera,Me.camera)||Ae.push({command:Gc.setCamera,args:[Me.camera]}),!k.bn(F["color-theme"],Me["color-theme"]))return[{command:Gc.setStyle,args:[Me]}];const Oe={},Fe=[];!function(F,Me,Ae,Oe){let Fe;for(Fe in Me=Me||{},F=F||{})F.hasOwnProperty(Fe)&&(Me.hasOwnProperty(Fe)||zt(Fe,Ae,Oe));for(Fe in Me){if(!Me.hasOwnProperty(Fe))continue;const je=Me[Fe];F.hasOwnProperty(Fe)?k.bn(F[Fe],je)||("geojson"===F[Fe].type&&"geojson"===je.type&&Mt(F,Me,Fe)?Ae.push({command:Gc.setGeoJSONSourceData,args:[Fe,je.data]}):Pt(Fe,Me,Ae,Oe)):At(Fe,Me,Ae)}}(F.sources,Me.sources,Fe,Oe);const je=[];F.layers&&F.layers.forEach((k=>{k.source&&Oe[k.source]?Ae.push({command:Gc.removeLayer,args:[k.id]}):je.push(k)}));let qe=F.terrain;qe&&Oe[qe.source]&&(Ae.push({command:Gc.setTerrain,args:[void 0]}),qe=void 0),Ae=Ae.concat(Fe),k.bn(qe,Me.terrain)||Ae.push({command:Gc.setTerrain,args:[Me.terrain]}),function(F,Me,Ae){Me=Me||[];const Oe=(F=F||[]).map(Ft),Fe=Me.map(Ft),je=F.reduce(kt,{}),qe=Me.reduce(kt,{}),pt=Oe.slice(),vt=Object.create(null);let Ut,xi,vi,bi,wi,Mi,pr;for(Ut=0,xi=0;Ut<Oe.length;Ut++)vi=Oe[Ut],qe.hasOwnProperty(vi)?xi++:(Ae.push({command:Gc.removeLayer,args:[vi]}),pt.splice(pt.indexOf(vi,xi),1));for(Ut=0,xi=0;Ut<Fe.length;Ut++)vi=Fe[Fe.length-1-Ut],pt[pt.length-1-Ut]!==vi&&(je.hasOwnProperty(vi)?(Ae.push({command:Gc.removeLayer,args:[vi]}),pt.splice(pt.lastIndexOf(vi,pt.length-xi),1)):xi++,Mi=pt[pt.length-Ut],Ae.push({command:Gc.addLayer,args:[qe[vi],Mi]}),pt.splice(pt.length-Ut,0,vi),vt[vi]=!0);for(Ut=0;Ut<Fe.length;Ut++)if(vi=Fe[Ut],bi=je[vi],wi=qe[vi],!vt[vi]&&!k.bn(bi,wi))if(k.bn(bi.source,wi.source)&&k.bn(bi["source-layer"],wi["source-layer"])&&k.bn(bi.type,wi.type)){for(pr in Ot(bi.layout,wi.layout,Ae,vi,null,Gc.setLayoutProperty),Ot(bi.paint,wi.paint,Ae,vi,null,Gc.setPaintProperty),k.bn(bi.slot,wi.slot)||Ae.push({command:Gc.setSlot,args:[vi,wi.slot]}),k.bn(bi.filter,wi.filter)||Ae.push({command:Gc.setFilter,args:[vi,wi.filter]}),k.bn(bi.minzoom,wi.minzoom)&&k.bn(bi.maxzoom,wi.maxzoom)||Ae.push({command:Gc.setLayerZoomRange,args:[vi,wi.minzoom,wi.maxzoom]}),bi)bi.hasOwnProperty(pr)&&"layout"!==pr&&"paint"!==pr&&"filter"!==pr&&"metadata"!==pr&&"minzoom"!==pr&&"maxzoom"!==pr&&"slot"!==pr&&(0===pr.indexOf("paint.")?Ot(bi[pr],wi[pr],Ae,vi,pr.slice(6),Gc.setPaintProperty):k.bn(bi[pr],wi[pr])||Ae.push({command:Gc.setLayerProperty,args:[vi,pr,wi[pr]]}));for(pr in wi)wi.hasOwnProperty(pr)&&!bi.hasOwnProperty(pr)&&"layout"!==pr&&"paint"!==pr&&"filter"!==pr&&"metadata"!==pr&&"minzoom"!==pr&&"maxzoom"!==pr&&"slot"!==pr&&(0===pr.indexOf("paint.")?Ot(bi[pr],wi[pr],Ae,vi,pr.slice(6),Gc.setPaintProperty):k.bn(bi[pr],wi[pr])||Ae.push({command:Gc.setLayerProperty,args:[vi,pr,wi[pr]]}))}else Ae.push({command:Gc.removeLayer,args:[vi]}),Mi=pt[pt.lastIndexOf(vi)+1],Ae.push({command:Gc.addLayer,args:[wi,Mi]})}(je,Me.layers,Ae)}catch(k){console.warn("Unable to compute style diff:",k),Ae=[{command:Gc.setStyle,args:[Me]}]}return Ae}(this.serialize(),F).filter((k=>!(k.command in Dh)));if(0===Ae.length)return!1;const Oe=Ae.filter((k=>!(k.command in Ch)));if(Oe.length>0)throw new Error(`Unimplemented: ${Oe.map((k=>k.command)).join(", ")}.`);const Fe=[];return Ae.forEach((k=>{Fe.push(this[k.command].apply(this,k.args))})),Me&&Promise.all(Fe).then(Me),this.stylesheet=F,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(F,Me){return this.getImage(F)?this.fire(new k.y(new Error("An image with this name already exists."))):(this.imageManager.addImage(F,this.scope,Me),this._afterImageUpdated(F),this)}updateImage(k,F,Me=!1){this.imageManager.updateImage(k,this.scope,F),Me&&this._afterImageUpdated(k)}getImage(k){return this.imageManager.getImage(k,this.scope)}removeImage(F){return this.getImage(F)?(this.imageManager.removeImage(F,this.scope),this._afterImageUpdated(F),this):this.fire(new k.y(new Error("No image with this name exists.")))}_afterImageUpdated(F){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(F),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new k.z("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(k,F,Me={}){return this._checkLoaded(),this._validate(Re,`models.${k}`,F,null,Me)||(this.modelManager.addModel(k,F,this.scope),this._changes.setDirty()),this}hasModel(k){return this.modelManager.hasModel(k,this.scope)}removeModel(F){return this.hasModel(F)?(this.modelManager.removeModel(F,this.scope),this):this.fire(new k.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(F,Me,Ae={}){if(this._checkLoaded(),void 0!==this.getOwnSource(F))throw new Error(`There is already a source with ID "${F}".`);if(!Me.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(Me).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(Me.type)>=0&&this._validate(ge,`sources.${F}`,Me,null,Ae))return;this.map&&this.map._collectResourceTiming&&(Me.collectResourceTiming=!0);const Oe=rt(F,Me,this.dispatcher,this);Oe.scope=this.scope,Oe.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(Oe.id),source:Oe.serialize(),sourceId:Oe.id})));const r=F=>{const Me=(F?"symbol:":"other:")+Oe.id,Ae=k.aC(Me,this.scope),Fe=this._sourceCaches[Me]=new Tt(Ae,Oe,F);(F?this._symbolSourceCaches:this._otherSourceCaches)[Oe.id]=Fe,Fe.onAdd(this.map)};r(!1),"vector"!==Me.type&&"geojson"!==Me.type||r(!0),Oe.onAdd&&Oe.onAdd(this.map),Ae.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(F){this._checkLoaded();const Me=this.getOwnSource(F);if(!Me)throw new Error("There is no source with this ID");for(const Me in this._layers)if(this._layers[Me].source===F)return this.fire(new k.y(new Error(`Source "${F}" cannot be removed while layer "${Me}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===F)return this.fire(new k.y(new Error(`Source "${F}" cannot be removed while terrain is using it.`)));const Ae=this.getOwnSourceCaches(F);for(const F of Ae){const Me=k.cq(F.id);delete this._sourceCaches[Me],this._changes.discardSourceCacheUpdate(F.id),F.fire(new k.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:F.getSource().id})),F.setEventedParent(null),F.clearTiles()}return delete this._otherSourceCaches[F],delete this._symbolSourceCaches[F],this.mergeSources(),Me.setEventedParent(null),Me.onRemove&&Me.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(k,F){this._checkLoaded(),this.getOwnSource(k).setData(F),this._changes.setDirty()}getOwnSource(k){const F=this.getOwnSourceCache(k);return F&&F.getSource()}getOwnSources(){const k=[];for(const F in this._otherSourceCaches){const Me=this.getOwnSourceCache(F);Me&&k.push(Me.getSource())}return k}areTilesLoaded(){const k=this._mergedSourceCaches;for(const F in k){const Me=k[F]._tiles;for(const k in Me){const F=Me[k];if("loaded"!==F.state&&"errored"!==F.state)return!1}}return!0}setLights(F){if(this._checkLoaded(),!F)return delete this.ambientLight,void delete this.directionalLight;const Me=this._getTransitionParameters();for(const Ae of F){if(this._validate(ye,"lights",Ae))return;switch(Ae.type){case"ambient":if(this.ambientLight){const k=this.ambientLight;k.set(Ae),k.updateTransitions(Me)}else this.ambientLight=new $e(Ae,sl||(sl=new k.a5({color:new k.a6(k.a3.properties_light_ambient.color),"color-use-theme":new k.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new k.a6(k.a3.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const k=this.directionalLight;k.set(Ae),k.updateTransitions(Me)}else this.directionalLight=new $e(Ae,ml||(ml=new k.a5({direction:new k.ak(k.a3.properties_light_directional.direction),color:new k.a6(k.a3.properties_light_directional.color),"color-use-theme":new k.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new k.a6(k.a3.properties_light_directional.intensity),"cast-shadows":new k.a6(k.a3.properties_light_directional["cast-shadows"]),"shadow-quality":new k.a6(k.a3.properties_light_directional["shadow-quality"]),"shadow-intensity":new k.a6(k.a3.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const Ae=new k.a8(this.z||0,Me);this.ambientLight&&this.ambientLight.recalculate(Ae),this.directionalLight&&this.directionalLight.recalculate(Ae),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const F=this.directionalLight,Me=this.ambientLight;if(!F||!Me)return;const o=k=>.2126*(k[0]<=.03928?k[0]/12.92:Math.pow((k[0]+.055)/1.055,2.4))+.7152*(k[1]<=.03928?k[1]/12.92:Math.pow((k[1]+.055)/1.055,2.4))+.0722*(k[2]<=.03928?k[2]/12.92:Math.pow((k[2]+.055)/1.055,2.4)),Ae=F.properties.get("color").toRenderColor(null).toArray01(),Oe=F.properties.get("intensity"),Fe=F.properties.get("direction"),je=1-k.cb(Fe.x,Fe.y,Fe.z)[2]/90,qe=o(Ae)*Oe*je,pt=Me.properties.get("color").toRenderColor(null).toArray01(),vt=Me.properties.get("intensity"),Ut=o(pt)*vt;return Number(((qe+Ut)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const k=[];return this.directionalLight&&k.push(this.directionalLight.get()),this.ambientLight&&k.push(this.ambientLight.get()),k}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(F){if(!F)return this;if(k.cr(F)){const Me=k.cs(F),Ae=this.fragments.find((({id:k})=>k===Me));if(!Ae)throw new Error(`Style import '${F}' not found`);const Oe=k.cq(F);return Ae.style.getFragmentStyle(Oe)}{const k=this.fragments.find((({id:k})=>k===F));if(!k)throw new Error(`Style import '${F}' not found`);return k.style}}setFeaturesetSelectors(F){if(!F)return;const Me={},o=(k,F="")=>`${k}::${F}`;this.featuresetSelectors={};for(const Ae in F){const Oe=this.featuresetSelectors[Ae]=[];for(const Fe of F[Ae].selectors){if(Fe.featureNamespace){const F=this.getOwnLayer(Fe.layer);if(!F){k.w(`Layer is undefined for selector: ${Fe.layer}`);continue}const Oe=o(F.source,F.sourceLayer);if(Oe in Me&&Me[Oe]!==Fe.featureNamespace){k.w(`"featureNamespace ${Fe.featureNamespace} of featureset ${Ae}'s selector is not associated to the same source, skip this selector`);continue}Me[Oe]=Fe.featureNamespace}let F;if(Fe.properties)for(const Me in Fe.properties){const Ae=k.U(Fe.properties[Me]);"success"===Ae.result&&(F=F||{},F[Me]=Ae.value)}Oe.push({layerId:Fe.layer,namespace:Fe.featureNamespace,properties:F})}}}getFeaturesetDescriptors(k){const F=this.getFragmentStyle(k);if(!F||!F.stylesheet.featuresets)return[];const Me=[];for(const k in F.stylesheet.featuresets)Me.push({featuresetId:k,importId:F.scope?F.scope:void 0});return Me}getFeaturesetLayers(F,Me){const Ae=this.getFragmentStyle(Me),Oe=Ae.stylesheet.featuresets;if(!Oe||!Oe[F])return this.fire(new k.y(new Error(`The featureset '${F}' does not exist in the map's style and cannot be queried.`))),[];const Fe=[];for(const k of Oe[F].selectors){const F=Ae.getOwnLayer(k.layer);F&&Fe.push(F)}return Fe}getConfigProperty(F,Me){const Ae=this.getFragmentStyle(F);if(!Ae)return null;const Oe=k.aC(Me,Ae.scope),Fe=Ae.options.get(Oe),je=Fe?Fe.value||Fe.default:null;return je?je.serialize():null}setConfigProperty(F,Me,Ae){const Oe=this.getFragmentStyle(F);if(!Oe)return;const Fe=Oe.stylesheet.indoor?ho(Oe.stylesheet.schema):Oe.stylesheet.schema;if(!Fe||!Fe[Me])return;const je=k.U(Ae);if("success"!==je.result)return void fo(this,je.value);const qe=je.value.expression,pt=k.aC(Me,Oe.scope),vt=Oe.options.get(pt);if(!vt)return;let Ut;const{minValue:xi,maxValue:vi,stepValue:bi,type:wi,values:Mi}=Fe[Me],pr=k.U(Fe[Me].default);"success"===pr.result&&(Ut=pr.value.expression),Ut?(this.options.set(pt,{...vt,value:qe,default:Ut,minValue:xi,maxValue:vi,stepValue:bi,type:wi,values:Mi}),this.updateConfigDependencies(Me)):this.fire(new k.y(new Error(`No schema defined for the config option "${Me}" in the "${F}" fragment.`)))}getConfig(F){const Me=this.getFragmentStyle(F);if(!Me)return null;const Ae=Me.stylesheet.schema;if(!Ae)return null;const Oe={};for(const F in Ae){const Ae=k.aC(F,Me.scope),Fe=Me.options.get(Ae),je=Fe?Fe.value||Fe.default:null;Oe[F]=je?je.serialize():null}return Oe}setConfig(k,F){const Me=this.getFragmentStyle(k);Me&&(Me.updateConfig(F,Me.stylesheet.schema),this.updateConfigDependencies())}getSchema(k){const F=this.getFragmentStyle(k);return F?F.stylesheet.schema:null}setSchema(k,F){const Me=this.getFragmentStyle(k);Me&&(Me.stylesheet.schema=F,Me.updateConfig(Me._config,F),this.updateConfigDependencies())}updateConfig(F,Me){if(this._config=F,F||Me)if(Me)for(const Ae in Me){let Oe,Fe;const je=k.U(Me[Ae].default);if("success"===je.result&&(Oe=je.value.expression),F&&void 0!==F[Ae]){const Me=k.U(F[Ae]);"success"===Me.result&&(Fe=Me.value.expression)}const{minValue:qe,maxValue:pt,stepValue:vt,type:Ut,values:xi}=Me[Ae];if(Oe){const F=k.aC(Ae,this.scope);this.options.set(F,{default:Oe,value:Fe,minValue:qe,maxValue:pt,stepValue:vt,type:Ut,values:xi})}else this.fire(new k.y(new Error(`No schema defined for config option "${Ae}".`)))}else this.fire(new k.y(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(k){for(const F of this._configDependentLayers){const Me=this.getLayer(F);if(Me){if(k&&!Me.configDependencies.has(k))continue;Me.possiblyEvaluateVisibility(),this._updateLayer(Me)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((k=>{const F=k._styleColorTheme.colorThemeOverride?k._styleColorTheme.colorThemeOverride:k._styleColorTheme.colorTheme;if(F){const Me=k._evaluateColorThemeData(F);(!k._styleColorTheme.lut&&""!==Me||k._styleColorTheme.lut&&Me!==k._styleColorTheme.lut.data)&&k.setColorTheme(F)}})),this._changes.setDirty()}addLayer(F,Me,Ae={}){this._checkLoaded();const Oe=F.id;if(this._layers[Oe])return void this.fire(new k.y(new Error(`Layer with id "${Oe}" already exists on this map`)));let Fe;if("custom"===F.type){if(fo(this,k.ct(F)))return;Fe=k.cu(F,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof F.source&&(this.addSource(Oe,F.source),F=k.cp(F),F=k.l(F,{source:Oe})),this._validate(Ee,`layers.${Oe}`,F,{arrayIndex:-1},Ae))return;Fe=k.cu(F,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(Fe),Fe.setEventedParent(this,{layer:{id:Oe}})}0!==Fe.configDependencies.size&&this._configDependentLayers.add(Fe.fqid);let je=this._order.length;if(Me){const F=this._order.indexOf(Me);if(-1===F)return void this.fire(new k.y(new Error(`Layer with id "${Me}" does not exist on this map.`)));Fe.slot===this._layers[Me].slot?je=F:k.w(`Layer with id "${Me}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(je,0,Oe),this._layerOrderChanged=!0,this._layers[Oe]=Fe;const qe=this.getOwnLayerSourceCache(Fe),pt=!!this.directionalLight&&this.directionalLight.shadowsEnabled();qe&&Fe.canCastShadows()&&pt&&(qe.castsShadows=!0);const vt=this._changes.getRemovedLayer(Fe);if(vt&&Fe.source&&qe&&"custom"!==Fe.type){this._changes.discardLayerRemoval(Fe);const F=k.aC(Fe.source,Fe.scope);vt.type!==Fe.type?this._changes.updateSourceCache(F,"clear"):(this._changes.updateSourceCache(F,"reload"),qe.pause())}this._updateLayer(Fe),Fe.onAdd&&Fe.onAdd(this.map),Fe.scope=this.scope,this.mergeLayers()}moveLayer(F,Me){this._checkLoaded();const Ae=this._checkLayer(F);if(!Ae)return;if(F===Me)return;const Oe=this._order.indexOf(F);this._order.splice(Oe,1);let Fe=this._order.length;if(Me){const F=this._order.indexOf(Me);if(-1===F)return void this.fire(new k.y(new Error(`Layer with id "${Me}" does not exist on this map.`)));Ae.slot===this._layers[Me].slot?Fe=F:k.w(`Layer with id "${Me}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(Fe,0,F),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(k){this._checkLoaded();const F=this._checkLayer(k);if(!F)return;F.setEventedParent(null);const Me=this._order.indexOf(k);this._order.splice(Me,1),delete this._layers[k],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(F.fqid),this._changes.removeLayer(F);const Ae=this.getOwnLayerSourceCache(F);if(Ae&&Ae.castsShadows){let k=!1;for(const Me in this._layers)if(this._layers[Me].source===F.source&&this._layers[Me].canCastShadows()){k=!0;break}Ae.castsShadows=k}F.onRemove&&F.onRemove(this.map),this.mergeLayers()}getOwnLayer(k){return this._layers[k]}hasLayer(k){return k in this._mergedLayers}hasLayerType(k){for(const F in this._layers)if(this._layers[F].type===k)return!0;return!1}setLayerZoomRange(k,F,Me){this._checkLoaded();const Ae=this._checkLayer(k);Ae&&(Ae.minzoom===F&&Ae.maxzoom===Me||(null!=F&&(Ae.minzoom=F),null!=Me&&(Ae.maxzoom=Me),this._updateLayer(Ae)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(k,F){this._checkLoaded();const Me=this._checkLayer(k);Me&&Me.slot!==F&&(Me.slot=F,this._updateLayer(Me))}setFilter(F,Me,Ae={}){this._checkLoaded();const Oe=this._checkLayer(F);if(Oe&&!k.bn(Oe.filter,Me))return null==Me?(Oe.filter=void 0,void this._updateLayer(Oe)):void(this._validate(Se,`layers.${Oe.id}.filter`,Me,{layerType:Oe.type},Ae)||(Oe.filter=k.cp(Me),this._updateLayer(Oe)))}getFilter(F){const Me=this._checkLayer(F);if(Me)return k.cp(Me.filter)}setLayoutProperty(F,Me,Ae,Oe={}){this._checkLoaded();const Fe=this._checkLayer(F);if(Fe&&!k.bn(Fe.getLayoutProperty(Me),Ae)){if(null!=Ae&&(!Oe||!1!==Oe.validate)&&fo(Fe,Ie.call(me,{key:`layers.${F}.layout.${Me}`,layerType:Fe.type,objectKey:Me,value:Ae,styleSpec:k.a3,style:{glyphs:!0,sprite:!0}})))return;Fe.setLayoutProperty(Me,Ae),0!==Fe.configDependencies.size&&this._configDependentLayers.add(Fe.fqid),this._updateLayer(Fe)}}getLayoutProperty(k,F){const Me=this._checkLayer(k);if(Me)return Me.getLayoutProperty(F)}setPaintProperty(F,Me,Ae,Oe={}){this._checkLoaded();const Fe=this._checkLayer(F);if(!Fe)return;if(k.bn(Fe.getPaintProperty(Me),Ae))return;if(null!=Ae&&(!Oe||!1!==Oe.validate)&&fo(Fe,Ce.call(me,{key:`layers.${F}.paint.${Me}`,layerType:Fe.type,objectKey:Me,value:Ae,styleSpec:k.a3})))return;const je=Fe.setPaintProperty(Me,Ae);0!==Fe.configDependencies.size&&this._configDependentLayers.add(Fe.fqid),je&&this._updateLayer(Fe),this._changes.updatePaintProperties(Fe)}getPaintProperty(k,F){const Me=this._checkLayer(k);if(Me)return Me.getPaintProperty(F)}setFeatureState(F,Me){if(this._checkLoaded(),"target"in F){if("featuresetId"in F.target){const{featuresetId:k,importId:Ae}=F.target,Oe=this.getFragmentStyle(Ae),Fe=Oe.getFeaturesetLayers(k);for(const{source:k,sourceLayer:Ae}of Fe)Oe.setFeatureState({id:F.id,source:k,sourceLayer:Ae},Me)}else if("layerId"in F.target){const{layerId:k}=F.target,Ae=this.getLayer(k);this.setFeatureState({id:F.id,source:Ae.source,sourceLayer:Ae.sourceLayer},Me)}return}const Ae=F.source,Oe=F.sourceLayer,Fe=this._checkSource(Ae);if(!Fe)return;const je=Fe.type;if("geojson"===je&&Oe)return void this.fire(new k.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===je&&!Oe)return void this.fire(new k.y(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===F.id&&this.fire(new k.y(new Error("The feature id parameter must be provided.")));const qe=this.getOwnSourceCaches(Ae);for(const k of qe)k.setFeatureState(Oe,F.id,Me)}removeFeatureState(F,Me){if(this._checkLoaded(),"target"in F){if("featuresetId"in F.target){const{featuresetId:k,importId:Ae}=F.target,Oe=this.getFragmentStyle(Ae),Fe=Oe.getFeaturesetLayers(k);for(const{source:k,sourceLayer:Ae}of Fe)Oe.removeFeatureState({id:F.id,source:k,sourceLayer:Ae},Me)}else if("layerId"in F.target){const{layerId:k}=F.target,Ae=this.getLayer(k);this.removeFeatureState({id:F.id,source:Ae.source,sourceLayer:Ae.sourceLayer},Me)}return}const Ae=F.source,Oe=this._checkSource(Ae);if(!Oe)return;const Fe=Oe.type,je="vector"===Fe?F.sourceLayer:void 0;if("vector"===Fe&&!je)return void this.fire(new k.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(Me&&"string"!=typeof F.id&&"number"!=typeof F.id)return void this.fire(new k.y(new Error("A feature id is required to remove its specific state property.")));const qe=this.getOwnSourceCaches(Ae);for(const k of qe)k.removeFeatureState(je,F.id,Me)}getFeatureState(F){if(this._checkLoaded(),"target"in F){let Me;if("featuresetId"in F.target){const{featuresetId:Ae,importId:Oe}=F.target,Fe=this.getFragmentStyle(Oe),je=Fe.getFeaturesetLayers(Ae);for(const{source:Ae,sourceLayer:Oe}of je){const je=Fe.getFeatureState({id:F.id,source:Ae,sourceLayer:Oe});if(je&&!Me)Me=je;else if(!k.bn(Me,je))return void this.fire(new k.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in F.target){const{layerId:k}=F.target,Ae=this.getLayer(k);Me=this.getFeatureState({id:F.id,source:Ae.source,sourceLayer:Ae.sourceLayer})}return Me}const Me=F.source,Ae=F.sourceLayer,Oe=this._checkSource(Me);if(Oe){if("vector"!==Oe.type||Ae)return void 0===F.id&&this.fire(new k.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(Me)[0].getFeatureState(Ae,F.id);this.fire(new k.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(F){return this.stylesheet.transition=k.l({},this.stylesheet.transition,F),this.transition=this.stylesheet.transition,this}getTransition(){return k.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const F=this.getTerrain(),Me=F&&this.terrain&&this.terrain.scope===this.scope?F:this.stylesheet.terrain;return k.cv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:Me,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(k=>void 0!==k))}_updateFilteredLayers(k){for(const F of Object.values(this._mergedLayers))k(F)&&this._updateLayer(F)}_updateLayer(F){this._changes.updateLayer(F);const Me=this.getLayerSourceCache(F),Ae=k.aC(F.source,F.scope),Oe=this._changes.getUpdatedSourceCaches();F.source&&!Oe[Ae]&&Me&&"raster"!==Me.getSource().type&&(this._changes.updateSourceCache(Ae,"reload"),Me.pause()),F.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(k){const t=k=>this._mergedLayers[k].is3D(),F=this.order,Me={},Ae=[];for(let Oe=F.length-1;Oe>=0;Oe--){const Fe=F[Oe];if(t(Fe)){Me[Fe]=Oe;for(const F of k){const k=F[Fe];if(k)for(const F of k)Ae.push(F)}}}Ae.sort(((k,F)=>F.intersectionZ-k.intersectionZ));const Oe=[];for(let Fe=F.length-1;Fe>=0;Fe--){const je=F[Fe];if(t(je))for(let k=Ae.length-1;k>=0;k--){const F=Ae[k].feature;if(F.layer&&Me[F.layer.id]<Fe)break;Oe.push(F),Ae.pop()}else for(const F of k){const k=F[je];if(k)for(const F of k)Oe.push(F.feature)}}return Oe}queryRenderedFeatures(F,Me,Ae){let Oe;Me&&!Array.isArray(Me)&&Me.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Me.filter,null,Me),Oe=k.aZ(Me.filter));const Fe={},a=k=>{if(Rh.has(k.type))return;const F=this.getOwnLayerSourceCache(k),Me=Fe[F.id]=Fe[F.id]||{sourceCache:F,layers:{},has3DLayers:!1};k.is3D()&&(Me.has3DLayers=!0),Me.layers[k.fqid]=Me.layers[k.fqid]||{styleLayer:k,targets:[]},Me.layers[k.fqid].targets.push({filter:Oe})};if(Me&&Me.layers){if(!Array.isArray(Me.layers))return this.fire(new k.y(new Error("parameters.layers must be an Array."))),[];for(const F of Me.layers){const Me=this._layers[F];if(!Me)return this.fire(new k.y(new Error(`The layer '${F}' does not exist in the map's style and cannot be queried for features.`))),[];a(Me)}}else for(const k in this._layers)a(this._layers[k]);const je=this._queryRenderedFeatures(F,Fe,Ae),qe=this._flattenAndSortRenderedFeatures(je),pt=[];for(const F of qe)k.cs(F.layer.id)===this.scope&&pt.push(F);return pt}queryRenderedFeatureset(F,Me,Ae){let Oe;Me&&!Array.isArray(Me)&&Me.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Me.filter,null,Me),Oe=k.aZ(Me.filter));const Fe="mock",je=[];if(Me&&Me.target)je.push({...Me,targetId:Fe,filter:Oe});else{const k=this.getFeaturesetDescriptors();for(const F of k)je.push({targetId:Fe,filter:Oe,target:F});for(const{style:k}of this.fragments){const F=k.getFeaturesetDescriptors();for(const k of F)je.push({targetId:Fe,filter:Oe,target:k})}}const qe=this.queryRenderedTargets(F,je,Ae),pt=[];for(const F of qe)for(const Me of F.variants[Fe])pt.push(new k.cw(F,Me));return pt}queryRenderedTargets(F,Me,Ae){const Oe={},r=(k,F,Me,Ae)=>{const Fe=Oe[F.id]=Oe[F.id]||{sourceCache:F,layers:{},has3DLayers:!1};Fe.layers[k.fqid]=Fe.layers[k.fqid]||{styleLayer:k,targets:[]},k.is3D()&&(Fe.has3DLayers=!0),Fe.layers[k.fqid].targets.push(Ae?{...Me,namespace:Ae.namespace,properties:Ae.properties}:Me)};for(const F of Me)if("featuresetId"in F.target){const{featuresetId:Me,importId:Ae}=F.target,Oe=this.getFragmentStyle(Ae),Fe=Oe.featuresetSelectors[Me];if(!Fe){this.fire(new k.y(new Error(`The featureset '${Me}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const k of Fe){const Me=Oe.getOwnLayer(k.layerId);Me&&!Rh.has(Me.type)&&r(Me,Oe.getOwnLayerSourceCache(Me),F,k)}}else if("layerId"in F.target){const{layerId:k}=F.target,Me=this.getLayer(k);if(!Me||Rh.has(Me.type))continue;r(Me,this.getLayerSourceCache(Me),F)}const Fe=this._queryRenderedFeatures(F,Oe,Ae);return this._flattenAndSortRenderedFeatures(Fe)}_queryRenderedFeatures(k,F,Me){const Ae=[],Oe=!!this.map._showQueryGeometry,Fe=Xe.createFromScreenPoints(k,Me);for(const k in F){const je=at(Fe,F[k],this._availableImages,Me,Oe);Object.keys(je).length&&Ae.push(je)}if(this.placement)for(const k in F){if(!F[k].sourceCache._onlySymbols)continue;const Me=nt(Fe.screenGeometry,F[k],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(Me).length&&Ae.push(Me)}return Ae}querySourceFeatures(k,F){const Me=F&&F.filter;Me&&this._validate(Se,"querySourceFeatures.filter",Me,null,F);let Ae=[];const Oe=this.getOwnSourceCaches(k);for(const k of Oe)Ae=Ae.concat(lt(k,F));return Ae}addSourceType(k,F,Me){return bo.getSourceType(k)?Me(new Error(`A source type called "${k}" already exists.`)):(bo.setSourceType(k,F),F.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:k,url:F.workerSourceURL},Me):Me(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(F,Me,Ae={}){this._checkLoaded();const Oe=this.light.getLight();let Fe=!1;for(const Me in F)if(!k.bn(F[Me],Oe[Me])){Fe=!0;break}if(!Fe)return;const je=this._getTransitionParameters();this.light.setLight(F,Me,Ae),this.light.updateTransitions(je)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=k.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&k.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(F,Me=1){if(this._checkLoaded(),!F)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===Me&&delete this.terrain,null===F?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let Ae=F;const Oe=null==F.source;if(1===Me){if(this.disableElevatedTerrain)return;if("object"==typeof Ae.source){const F="terrain-dem-src";this.addSource(F,Ae.source),Ae=k.cp(Ae),Ae=k.l(Ae,{source:F})}const F=k.l({},Ae),Me={};if(this.terrain&&Oe){F.source=this.terrain.get().source;const k=this.terrain?this.getFragmentStyle(this.terrain.scope):null;k&&(Me.style=k.serialize())}if(this._validate(xe,"terrain",F,Me))return}if(!this.terrain||this.terrain.scope!==this.scope&&!Oe||this.terrain&&Me!==this.terrain.drapeRenderMode){if(!Ae)return;this._createTerrain(Ae,Me),this.fire(new k.z("data",{dataType:"style"}))}else{const Me=this.terrain,Oe=Me.get();for(const F of Object.keys(k.a3.terrain))!Ae.hasOwnProperty(F)&&k.a3.terrain[F].default&&(Ae[F]=k.a3.terrain[F].default);for(const Ae in F)if(!k.bn(F[Ae],Oe[Ae])){Me.set(F,this.options),this.stylesheet.terrain=F;const Ae=this._getTransitionParameters({duration:0});Me.updateTransitions(Ae),this.fire(new k.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(k){const F=this.fog=new Ge(k,this.map.transform,this.scope,this.options);this.stylesheet.fog=F.get();const Me=this._getTransitionParameters({duration:0});F.updateTransitions(Me)}_createSnow(k){const F=this.snow=new Sl(k,this.map.transform,this.scope,this.options);this.stylesheet.snow=F.get();const Me=this._getTransitionParameters({duration:0});F.updateTransitions(Me)}_createRain(k){const F=this.rain=new Il(k,this.map.transform,this.scope,this.options);this.stylesheet.rain=F.get();const Me=this._getTransitionParameters({duration:0});F.updateTransitions(Me)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const k of this.map._markers)k._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(F){if(this._checkLoaded(),!F)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const Me=this.fog;if(!k.bn(Me.get(),F)){Me.set(F,this.options),this.stylesheet.fog=Me.get();const k=this._getTransitionParameters({duration:0});Me.updateTransitions(k)}}else this._createFog(F);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(F){if(this._checkLoaded(),!F)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const Me=this.snow;if(!k.bn(Me.get(),F)){Me.set(F,this.options),this.stylesheet.snow=Me.get();const k=this._getTransitionParameters({duration:0});Me.updateTransitions(k)}}else this._createSnow(F);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(F){if(this._checkLoaded(),!F)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const Me=this.rain;if(!k.bn(Me.get(),F)){Me.set(F,this.options),this.stylesheet.rain=Me.get();const k=this._getTransitionParameters({duration:0});Me.updateTransitions(k)}}else this._createRain(F);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const k in this._layers)this._layers[k].lut=this._styleColorTheme.lut;for(const k in this._sourceCaches)this._sourceCaches[k].clearTiles()},F=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!F)return this._styleColorTheme.lut=null,void t();const Me=this._evaluateColorThemeData(F);this._loadColorTheme(Me).then((()=>{this.fire(new k.z("colorthemeset")),t()})).catch((F=>{k.w(`Couldn't set color theme: ${F}`)}))}setColorTheme(F){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&k.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=F,this._reloadColorTheme()}setImportColorTheme(k,F){const Me=this.getFragmentStyle(k);Me&&(Me._styleColorTheme.colorThemeOverride=F,Me._reloadColorTheme())}_getTransitionParameters(F){return{now:k.q.now(),transition:k.l(this.transition,F)}}updateDrapeFirstLayers(){if(!this.terrain)return;const k=[],F=[];for(const Me of this._mergedOrder)this.isLayerDraped(this._mergedLayers[Me])?k.push(Me):F.push(Me);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...k),this._drapedFirstOrder.push(...F)}_createTerrain(k,F){const Me=this.terrain=new aa(k,F,this.scope,this.options);1===F&&(this.stylesheet.terrain=k),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const Ae=this._getTransitionParameters({duration:0});Me.updateTransitions(Ae)}_force3DLayerUpdate(){for(const k in this._layers){const F=this._layers[k];"fill-extrusion"===F.type&&this._updateLayer(F)}}_forceSymbolLayerUpdate(){for(const k in this._layers){const F=this._layers[k];"symbol"===F.type&&this._updateLayer(F)}}_validate(F,Me,Ae,Oe,Fe={}){if(Fe&&!1===Fe.validate)return!1;const je=k.l({},this.serialize());return fo(this,F.call(me,k.l({key:Me,style:je,value:Ae,styleSpec:k.a3},Oe)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),k.cx.off("pluginStateChange",this._rtlTextPluginCallback);for(const k in this._mergedLayers)this._mergedLayers[k].setEventedParent(null);for(const k in this._mergedSourceCaches)this._mergedSourceCaches[k].clearTiles(),this._mergedSourceCaches[k].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(k){const F=this.getSourceCaches(k);for(const k of F)k.clearTiles()}clearSources(){for(const k in this._mergedSourceCaches)this._mergedSourceCaches[k].clearTiles()}reloadSource(k){const F=this.getSourceCaches(k);for(const k of F)k.resume(),k.reload()}reloadSources(){for(const k of this.getSources())k.reload&&k.reload()}updateSources(k){let F;this.directionalLight&&(F=so(this.directionalLight));for(const Me in this._mergedSourceCaches)this._mergedSourceCaches[Me].update(k,void 0,void 0,F)}_generateCollisionBoxes(){for(const k in this._sourceCaches){const F=this._sourceCaches[k];F.resume(),F.reload()}}_updatePlacement(F,Me,Ae,Oe,Fe,je,qe=!1){let pt=!1,vt=!1;const Ut={},xi={};for(const F of this._mergedOrder){const Ae=this._mergedLayers[F];if("symbol"!==Ae.type)continue;const Oe=k.aC(Ae.source,Ae.scope);let Fe=Ut[Oe];if(!Fe){const k=this.getLayerSourceCache(Ae);if(!k)continue;const F=k.getRenderableIds(!0).map((F=>k.getTileByID(F)));xi[Oe]=F.slice(),Fe=Ut[Oe]=F.sort(((k,F)=>F.tileID.overscaledZ-k.tileID.overscaledZ||(k.tileID.isLessThan(F.tileID)?-1:1)))}const je=this.crossTileSymbolIndex.addLayer(Ae,Fe,Me.center.lng,Me.projection);pt=pt||je}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),qe=qe||this._layerOrderChanged||0===Oe,this._layerOrderChanged&&this.fire(new k.z("neworder")),(qe||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(k.q.now(),Me.zoom))&&(this.pauseablePlacement=new Ri(Me,this._mergedOrder,qe,Ae,Oe,Fe,this.placement,this.fog&&Me.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,Ut,xi,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(k.q.now()),vt=!0),pt&&this.pauseablePlacement.placement.setStale()),vt||pt){this._buildingIndex.onNewFrame(Me.zoom);for(let F=0;F<this._mergedOrder.length;F++){const Me=this._mergedLayers[this._mergedOrder[F]];if("symbol"!==Me.type)continue;const Ae=this.isLayerClipped(Me);this.placement.updateLayerOpacities(Me,Ut[k.aC(Me.source,Me.scope)],F,Ae?je:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(k.q.now())}}_releaseSymbolFadeTiles(){for(const k in this._sourceCaches)this._sourceCaches[k].releaseSymbolFadeTiles()}addImport(F,Me){this._checkLoaded();const Ae=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==Ae.findIndex((({id:k})=>k===F.id)))return void this.fire(new k.y(new Error(`Import with id '${F.id}' already exists in the map's style.`)));if(!Me)return Ae.push(F),this._loadImports([F],!0);const Oe=Ae.findIndex((({id:k})=>k===Me));return-1===Oe&&this.fire(new k.y(new Error(`Import with id "${Me}" does not exist on this map.`))),this.stylesheet.imports=Ae.slice(0,Oe).concat(F).concat(Ae.slice(Oe)),this._loadImports([F],!0,Me)}updateImport(F,Me){this._checkLoaded();const Ae=this.stylesheet.imports||[],Oe=this.getImportIndex(F);return-1===Oe?this:"string"==typeof Me?(this.setImportUrl(F,Me),this):(Me.url&&Me.url!==Ae[Oe].url&&this.setImportUrl(F,Me.url),k.bn(Me.config,Ae[Oe].config)||this.setImportConfig(F,Me.config),k.bn(Me.data,Ae[Oe].data)||this.setImportData(F,Me.data),this)}moveImport(k,F){this._checkLoaded();let Me=this.stylesheet.imports||[];const Ae=this.getImportIndex(k);if(-1===Ae)return this;const Oe=this.getImportIndex(F);if(-1===Oe)return this;const Fe=Me[Ae],je=this.fragments[Ae];return Me=Me.filter((({id:F})=>F!==k)),this.fragments=this.fragments.filter((({id:F})=>F!==k)),this.stylesheet.imports=Me.slice(0,Oe).concat(Fe).concat(Me.slice(Oe)),this.fragments=this.fragments.slice(0,Oe).concat(je).concat(this.fragments.slice(Oe)),this.mergeLayers(),this}setImportUrl(k,F){this._checkLoaded();const Me=this.stylesheet.imports||[],Ae=this.getImportIndex(k);if(-1===Ae)return this;Me[Ae].url=F;const Oe=this.fragments[Ae];return Oe.style=this._createFragmentStyle(Me[Ae]),Oe.style.on("style.import.load",(()=>this.mergeAll())),Oe.style.loadURL(F),this}setImportData(k,F){this._checkLoaded();const Me=this.getImportIndex(k),Ae=this.stylesheet.imports||[];return-1===Me?this:F?(this.fragments[Me].style.setState(F),this._reloadImports(),this):(delete Ae[Me].data,this.setImportUrl(k,Ae[Me].url))}setImportConfig(k,F){this._checkLoaded();const Me=this.getImportIndex(k),Ae=this.stylesheet.imports||[];if(-1===Me)return this;F?Ae[Me].config=F:delete Ae[Me].config;const Oe=this.fragments[Me],Fe=Oe.style.stylesheet&&Oe.style.stylesheet.schema;return Oe.config=F,Oe.style.updateConfig(F,Fe),this.updateConfigDependencies(),this}removeImport(k){this._checkLoaded();const F=this.stylesheet.imports||[],Me=this.getImportIndex(k);-1!==Me&&(F.splice(Me,1),this.fragments[Me].style._remove(),this.fragments.splice(Me,1),this._reloadImports())}getImportIndex(F){const Me=(this.stylesheet.imports||[]).findIndex((k=>k.id===F));return-1===Me&&this.fire(new k.y(new Error(`Import '${F}' does not exist in the map's style and cannot be updated.`))),Me}getLayer(k){return this._mergedLayers[k]}getSources(){const k=[];for(const F in this._mergedOtherSourceCaches){const Me=this._mergedOtherSourceCaches[F];Me&&k.push(Me.getSource())}return k}getSource(k,F){const Me=this.getSourceCache(k,F);return Me&&Me.getSource()}getLayerSource(k){const F=this.getLayerSourceCache(k);return F&&F.getSource()}getSourceCache(F,Me){const Ae=k.aC(F,Me);return this._mergedOtherSourceCaches[Ae]}getLayerSourceCache(F){const Me=k.aC(F.source,F.scope);return"symbol"===F.type?this._mergedSymbolSourceCaches[Me]:this._mergedOtherSourceCaches[Me]}getSourceCaches(k){if(null==k)return Object.values(this._mergedSourceCaches);const F=[];return this._mergedOtherSourceCaches[k]&&F.push(this._mergedOtherSourceCaches[k]),this._mergedSymbolSourceCaches[k]&&F.push(this._mergedSymbolSourceCaches[k]),F}updateSourceCaches(){const k=this._changes.getUpdatedSourceCaches();for(const F in k){const Me=k[F];"reload"===Me?this.reloadSource(F):"clear"===Me&&this.clearSource(F)}}updateLayers(k){const F=this._changes.getUpdatedPaintProperties();for(const Me of F){const F=this.getLayer(Me);F&&F.updateTransitions(k)}}getImages(k,F,Me){this.imageManager.getImages(F.icons,F.scope,Me),this._updateTilesForChangedImages();const o=k=>{k&&k.setDependencies(F.tileID.key,F.type,F.icons)};o(this._otherSourceCaches[F.source]),o(this._symbolSourceCaches[F.source])}rasterizeImages(k,F,Me){this.imageManager.rasterizeImages(F,Me)}getGlyphs(k,F,Me){this.glyphManager.getGlyphs(F.stacks,F.scope,Me)}getResource(F,Me,Ae){return k.cy(Me,Ae)}getOwnSourceCache(k){return this._otherSourceCaches[k]}getOwnLayerSourceCache(k){return"symbol"===k.type?this._symbolSourceCaches[k.source]:this._otherSourceCaches[k.source]}getOwnSourceCaches(k){const F=[];return this._otherSourceCaches[k]&&F.push(this._otherSourceCaches[k]),this._symbolSourceCaches[k]&&F.push(this._symbolSourceCaches[k]),F}_isSourceCacheLoaded(F){const Me=this.getOwnSourceCaches(F);return 0===Me.length?(this.fire(new k.y(new Error(`There is no source with ID '${F}'`))),!1):Me.every((k=>k.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(k,F){if(!this._clipLayerPresent&&"fill-extrusion"!==k.type)return!1;const Me="fill-extrusion"===k.type&&"building"===k.sourceLayer;if(k.is3D()){if(Me||F&&"batched-model"===F.type)return!0;if("model"===k.type)return!0}else if("symbol"===k.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((k=>{k.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}bo.getSourceType=function(k){return Kl[k]},bo.setSourceType=function(k,F){Kl[k]=F},bo.registerForPluginStateChange=k.ch;var Fh="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Vh="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",Zh="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",eu="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",tu="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",ou="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",su="highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",lu="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",cu="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",uu="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",bu="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Bu=[];No(Fh,Bu),No(Zh,Bu),No(Vh,Bu);const Uu={"_prelude_fog.vertex.glsl":ou,"_prelude_terrain.vertex.glsl":tu,"_prelude_shadow.vertex.glsl":uu,"_prelude_fog.fragment.glsl":su,"_prelude_shadow.fragment.glsl":bu,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":lu,"_prelude_raster_particle.glsl":cu},ju={};Uo("",tu),Uo(su,ou),Uo(bu,uu),Uo(lu,""),Uo(cu,"");const qu=Uo(Vh,Zh),Zu=Fh;var Hu={background:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float opacity_t=smoothstep((1.0-blur_positive)*antialiased_blur,blur_positive*antialiased_blur,extrude_length-1.0)-smoothstep(0.0,antialiasblur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Uo("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Uo('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Uo("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Uo("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Uo("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Uo("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:Uo("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Uo('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Uo("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Uo("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec2 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nhalfwidth=(u_width_scale*a_z_offset_width.y)/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset+0.01*step(0.01,a_z_offset),1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec4 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec2 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec4 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec4 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset+0.01*step(0.01,a_z_offset),1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nfloat a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:Uo("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:Uo("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Uo('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Uo('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#else\nz+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#endif\n}'),terrainRaster:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:Uo("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Uo('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',eu),skyboxGradient:Uo('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',eu),skyboxCapture:Uo("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Uo('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\nglFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Uo('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Uo("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Uo("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:Uo("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:Uo("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:Uo("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Uo("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function No(k,F){const Me=k.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let k of Me)if(k=k.trim(),"#"===k[0]&&k.includes("if")&&!k.includes("endif")){k=k.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const Me=k.split(" ");for(const k of Me)F.includes(k)||F.push(k)}}function Uo(k,F){const Me=/#include\s+"([^"]+)"/g,Ae=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let Oe=F.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);Oe&&(Oe=Oe.map((k=>{const F=k.split(" ");return F[F.length-1]})),Oe=[...new Set(Oe)]);const Fe={},je=[],qe=[];if(k=k.replace(Me,((k,F)=>(qe.push(F),""))),(F=F.replace(Me,((k,F)=>(je.push(F),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let pt=[...Bu];No(k,pt),No(F,pt);for(const k of[...je,...qe])Uu[k]||console.error(`Undefined include: ${k}`),ju[k]||(ju[k]=[],No(Uu[k],ju[k])),pt=[...pt,...ju[k]];return{fragmentSource:k=k.replace(Ae,((k,F,Me,Ae,Oe)=>(Fe[Oe]=!0,"define"===F?`\n#ifndef HAS_UNIFORM_u_${Oe}\nin ${Me} ${Ae} ${Oe};\n#else\nuniform ${Me} ${Ae} u_${Oe};\n#endif\n`:"initialize"===F?`\n#ifdef HAS_UNIFORM_u_${Oe}\n    ${Me} ${Ae} ${Oe} = u_${Oe};\n#endif\n`:"define-attribute"===F?`\n#ifdef HAS_ATTRIBUTE_a_${Oe}\n    in ${Me} ${Ae} ${Oe};\n#endif\n`:"initialize-attribute"===F?"":void 0))),vertexSource:F=F.replace(Ae,((k,F,Me,Ae,Oe)=>{const je="float"===Ae?"vec2":Ae,qe=Oe.match(/color/)?"color":je;return"define-attribute-vertex-shader-only"===F?`\n#ifdef HAS_ATTRIBUTE_a_${Oe}\nin ${Me} ${Ae} a_${Oe};\n#endif\n`:Fe[Oe]?"define"===F?`\n#ifndef HAS_UNIFORM_u_${Oe}\nuniform lowp float u_${Oe}_t;\nin ${Me} ${je} a_${Oe};\nout ${Me} ${Ae} ${Oe};\n#else\nuniform ${Me} ${Ae} u_${Oe};\n#endif\n`:"initialize"===F?"vec4"===qe?`\n#ifndef HAS_UNIFORM_u_${Oe}\n    ${Oe} = a_${Oe};\n#else\n    ${Me} ${Ae} ${Oe} = u_${Oe};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Oe}\n    ${Oe} = unpack_mix_${qe}(a_${Oe}, u_${Oe}_t);\n#else\n    ${Me} ${Ae} ${Oe} = u_${Oe};\n#endif\n`:"define-attribute"===F?`\n#ifdef HAS_ATTRIBUTE_a_${Oe}\n    in ${Me} ${Ae} a_${Oe};\n    out ${Me} ${Ae} ${Oe};\n#endif\n`:"initialize-attribute"===F?`\n#ifdef HAS_ATTRIBUTE_a_${Oe}\n    ${Oe} = a_${Oe};\n#endif\n`:void 0:"define"===F?`\n#ifndef HAS_UNIFORM_u_${Oe}\nuniform lowp float u_${Oe}_t;\nin ${Me} ${je} a_${Oe};\n#else\nuniform ${Me} ${Ae} u_${Oe};\n#endif\n`:"define-instanced"===F?"mat4"===qe?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${Oe}0;\nin vec4 a_${Oe}1;\nin vec4 a_${Oe}2;\nin vec4 a_${Oe}3;\n#else\nuniform ${Me} ${Ae} u_${Oe};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${Me} ${je} a_${Oe};\n#else\nuniform ${Me} ${Ae} u_${Oe};\n#endif\n`:"initialize-attribute-custom"===F?`\n#ifdef HAS_ATTRIBUTE_a_${Oe}\n    ${Me} ${Ae} ${Oe} = a_${Oe};\n#endif\n`:"vec4"===qe?`\n#ifndef HAS_UNIFORM_u_${Oe}\n    ${Me} ${Ae} ${Oe} = a_${Oe};\n#else\n    ${Me} ${Ae} ${Oe} = u_${Oe};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Oe}\n    ${Me} ${Ae} ${Oe} = unpack_mix_${qe}(a_${Oe}, u_${Oe}_t);\n#else\n    ${Me} ${Ae} ${Oe} = u_${Oe};\n#endif\n`})),staticAttributes:Oe,usedDefines:pt,vertexIncludes:je,fragmentIncludes:qe}}class Go{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(k,F,Me,Ae,Oe,Fe,je,qe){this.context=k;let pt=this.boundPaintVertexBuffers.length!==Ae.length;for(let k=0;!pt&&k<Ae.length;k++)this.boundPaintVertexBuffers[k]!==Ae[k]&&(pt=!0);let vt=this.boundDynamicVertexBuffers.length!==je.length;for(let k=0;!vt&&k<je.length;k++)this.boundDynamicVertexBuffers[k]!==je[k]&&(vt=!0);if(!this.vao||this.boundProgram!==F||this.boundLayoutVertexBuffer!==Me||pt||vt||this.boundIndexBuffer!==Oe||this.boundVertexOffset!==Fe)this.freshBind(F,Me,Ae,Oe,Fe,je,qe);else{k.bindVertexArrayOES.set(this.vao);for(const Me of je)Me&&(Me.bind(),qe&&Me.instanceCount&&Me.setVertexAttribDivisor(k.gl,F,qe));Oe&&Oe.dynamicDraw&&Oe.bind()}}freshBind(k,F,Me,Ae,Oe,Fe,je){const qe=k.numAttributes,pt=this.context,vt=pt.gl;this.vao&&this.destroy(),this.vao=pt.gl.createVertexArray(),pt.bindVertexArrayOES.set(this.vao),this.boundProgram=k,this.boundLayoutVertexBuffer=F,this.boundPaintVertexBuffers=Me,this.boundIndexBuffer=Ae,this.boundVertexOffset=Oe,this.boundDynamicVertexBuffers=Fe,F.enableAttributes(vt,k),F.bind(),F.setVertexAttribPointers(vt,k,Oe);for(const F of Me)F.enableAttributes(vt,k),F.bind(),F.setVertexAttribPointers(vt,k,Oe);for(const F of Fe)F&&(F.enableAttributes(vt,k),F.bind(),F.setVertexAttribPointers(vt,k,Oe),je&&F.instanceCount&&F.setVertexAttribDivisor(vt,k,je));Ae&&Ae.bind(),pt.currentNumAttributes=qe}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function jo(F,Me){const Ae=Math.pow(2,Me.canonical.z),Oe=Me.canonical.y;return[new k.aa(0,Oe/Ae).toLngLat().lat,new k.aa(0,(Oe+1)/Ae).toLngLat().lat]}function Vo(F,Me,Ae,Oe,Fe,je,qe){const pt=F.context,vt=pt.gl,Ut=Ae.hillshadeFBO;if(!Ut)return;F.prepareDrawTile();const xi=F.isTileAffectedByFog(Me),vi=F.getOrCreateProgram("hillshade",{overrideFog:xi});pt.activeTexture.set(vt.TEXTURE0),vt.bindTexture(vt.TEXTURE_2D,Ut.colorAttachment.get());const bi=((F,Me,Ae,Oe)=>{const Fe=Ae.paint.get("hillshade-shadow-color"),je="none"===Ae.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),qe=Ae.paint.get("hillshade-highlight-color"),pt="none"===Ae.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),vt=Ae.paint.get("hillshade-accent-color"),Ut="none"===Ae.paint.get("hillshade-accent-color-use-theme").constantOr("default"),xi=Ae.paint.get("hillshade-emissive-strength");let vi=k.ai(Ae.paint.get("hillshade-illumination-direction"));if("viewport"===Ae.paint.get("hillshade-illumination-anchor"))vi-=F.transform.angle;else if(F.style&&F.style.enable3dLights()&&F.style.directionalLight){const Me=F.style.directionalLight.properties.get("direction"),Ae=k.cb(Me.x,Me.y,Me.z);vi=k.ai(Ae[1])}const bi=!F.options.moving;return{u_matrix:Oe||F.transform.calculateProjMatrix(Me.tileID.toUnwrapped(),bi),u_image:0,u_latrange:jo(0,Me.tileID),u_light:[Ae.paint.get("hillshade-exaggeration"),vi],u_shadow:Fe.toRenderColor(je?null:Ae.lut),u_highlight:qe.toRenderColor(pt?null:Ae.lut),u_emissive_strength:xi,u_accent:vt.toRenderColor(Ut?null:Ae.lut)}})(F,Ae,Oe,F.terrain?Me.projMatrix:null);F.uploadCommonUniforms(pt,vi,Me.toUnwrapped());const{tileBoundsBuffer:wi,tileBoundsIndexBuffer:Mi,tileBoundsSegments:pr}=F.getTileBoundsBuffers(Ae);vi.draw(F,vt.TRIANGLES,Fe,je,qe,Gi.disabled,bi,Oe.id,wi,Mi,pr)}function qo(F,Me,Ae){if(!Me.needsDEMTextureUpload)return;const Oe=F.context,Fe=Oe.gl;Oe.pixelStoreUnpackPremultiplyAlpha.set(!1),Me.demTexture=Me.demTexture||F.getTileTexture(Ae.stride);const je=Ae.getPixels();Me.demTexture?Me.demTexture.update(je,{premultiply:!1}):Me.demTexture=new k.T(Oe,je,Fe.R32F,{premultiply:!1}),Me.needsDEMTextureUpload=!1}function Ho(F,Me,Ae){const Oe=F.context,Fe=Oe.gl;if(!Me.dem)return;const je=Me.dem;if(Oe.activeTexture.set(Fe.TEXTURE1),qo(F,Me,je),!Me.demTexture)return;Me.demTexture.bind(Fe.NEAREST,Fe.CLAMP_TO_EDGE);const qe=je.dim;Oe.activeTexture.set(Fe.TEXTURE0);let pt=Me.hillshadeFBO;if(!pt){const F=new k.T(Oe,{width:qe,height:qe,data:null},Fe.RGBA8);F.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE),pt=Me.hillshadeFBO=Oe.createFramebuffer(qe,qe,!0,"renderbuffer"),pt.colorAttachment.set(F.texture)}Oe.bindFramebuffer.set(pt.framebuffer),Oe.viewport.set([0,0,qe,qe]);const{tileBoundsBuffer:vt,tileBoundsIndexBuffer:Ut,tileBoundsSegments:xi}=F.getMercatorTileBoundsBuffers(),vi=[];F.linearFloatFilteringSupported()&&vi.push("TERRAIN_DEM_FLOAT_FORMAT"),F.getOrCreateProgram("hillshadePrepare",{defines:vi}).draw(F,Fe.TRIANGLES,Fi.disabled,Bi.disabled,Oi.unblended,Gi.disabled,((F,Me)=>{const Ae=Me.stride,Oe=k.ab.mat4.create();return k.ab.mat4.ortho(Oe,0,k.ag,-k.ag,0,0,1),k.ab.mat4.translate(Oe,Oe,[0,-k.ag,0]),{u_matrix:Oe,u_image:1,u_dimension:[Ae,Ae],u_zoom:F.overscaledZ}})(Me.tileID,je),Ae.id,vt,Ut,xi),Me.needsHillshadePrepare=!1}class Zo{constructor(k){this.gl=k.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(k){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Wo extends Zo{getDefault(){return k.aj.transparent}set(k){const F=this.current;(k.r!==F.r||k.g!==F.g||k.b!==F.b||k.a!==F.a||this.dirty)&&(this.gl.clearColor(k.r,k.g,k.b,k.a),this.current=k,this.dirty=!1)}}class $o extends Zo{getDefault(){return 1}set(k){(k!==this.current||this.dirty)&&(this.gl.clearDepth(k),this.current=k,this.dirty=!1)}}class Xo extends Zo{getDefault(){return 0}set(k){(k!==this.current||this.dirty)&&(this.gl.clearStencil(k),this.current=k,this.dirty=!1)}}class Ko extends Zo{getDefault(){return[!0,!0,!0,!0]}set(k){const F=this.current;(k[0]!==F[0]||k[1]!==F[1]||k[2]!==F[2]||k[3]!==F[3]||this.dirty)&&(this.gl.colorMask(k[0],k[1],k[2],k[3]),this.current=k,this.dirty=!1)}}class Yo extends Zo{getDefault(){return!0}set(k){(k!==this.current||this.dirty)&&(this.gl.depthMask(k),this.current=k,this.dirty=!1)}}class Jo extends Zo{getDefault(){return 255}set(k){(k!==this.current||this.dirty)&&(this.gl.stencilMask(k),this.current=k,this.dirty=!1)}}class Qo extends Zo{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(k){const F=this.current;(k.func!==F.func||k.ref!==F.ref||k.mask!==F.mask||this.dirty)&&(this.gl.stencilFunc(k.func,k.ref,k.mask),this.current=k,this.dirty=!1)}}class es extends Zo{getDefault(){const k=this.gl;return[k.KEEP,k.KEEP,k.KEEP]}set(k){const F=this.current;(k[0]!==F[0]||k[1]!==F[1]||k[2]!==F[2]||this.dirty)&&(this.gl.stencilOp(k[0],k[1],k[2]),this.current=k,this.dirty=!1)}}class ts extends Zo{getDefault(){return!1}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;k?F.enable(F.STENCIL_TEST):F.disable(F.STENCIL_TEST),this.current=k,this.dirty=!1}}class is extends Zo{getDefault(){return[0,1]}set(k){const F=this.current;(k[0]!==F[0]||k[1]!==F[1]||this.dirty)&&(this.gl.depthRange(k[0],k[1]),this.current=k,this.dirty=!1)}}class os extends Zo{getDefault(){return!1}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;k?F.enable(F.DEPTH_TEST):F.disable(F.DEPTH_TEST),this.current=k,this.dirty=!1}}class ss extends Zo{getDefault(){return this.gl.LESS}set(k){(k!==this.current||this.dirty)&&(this.gl.depthFunc(k),this.current=k,this.dirty=!1)}}class rs extends Zo{getDefault(){return!1}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;k?F.enable(F.BLEND):F.disable(F.BLEND),this.current=k,this.dirty=!1}}class as extends Zo{getDefault(){const k=this.gl;return[k.ONE,k.ZERO,k.ONE,k.ZERO]}set(k){const F=this.current;(k[0]!==F[0]||k[1]!==F[1]||k[2]!==F[2]||k[3]!==F[3]||this.dirty)&&(this.gl.blendFuncSeparate(k[0],k[1],k[2],k[3]),this.current=k,this.dirty=!1)}}class ns extends Zo{getDefault(){return k.aj.transparent}set(k){const F=this.current;(k.r!==F.r||k.g!==F.g||k.b!==F.b||k.a!==F.a||this.dirty)&&(this.gl.blendColor(k.r,k.g,k.b,k.a),this.current=k,this.dirty=!1)}}class ls extends Zo{getDefault(){return this.gl.FUNC_ADD}set(k){(k!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(k,k),this.current=k,this.dirty=!1)}}class cs extends Zo{getDefault(){return!1}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;k?F.enable(F.CULL_FACE):F.disable(F.CULL_FACE),this.current=k,this.dirty=!1}}class hs extends Zo{getDefault(){return this.gl.BACK}set(k){(k!==this.current||this.dirty)&&(this.gl.cullFace(k),this.current=k,this.dirty=!1)}}class us extends Zo{getDefault(){return this.gl.CCW}set(k){(k!==this.current||this.dirty)&&(this.gl.frontFace(k),this.current=k,this.dirty=!1)}}let $u=class extends Zo{getDefault(){return null}set(k){(k!==this.current||this.dirty)&&(this.gl.useProgram(k),this.current=k,this.dirty=!1)}};class _s extends Zo{getDefault(){return this.gl.TEXTURE0}set(k){(k!==this.current||this.dirty)&&(this.gl.activeTexture(k),this.current=k,this.dirty=!1)}}class ps extends Zo{getDefault(){const k=this.gl;return[0,0,k.drawingBufferWidth,k.drawingBufferHeight]}set(k){const F=this.current;(k[0]!==F[0]||k[1]!==F[1]||k[2]!==F[2]||k[3]!==F[3]||this.dirty)&&(this.gl.viewport(k[0],k[1],k[2],k[3]),this.current=k,this.dirty=!1)}}class fs extends Zo{getDefault(){return null}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.bindFramebuffer(F.FRAMEBUFFER,k),this.current=k,this.dirty=!1}}class ms extends Zo{getDefault(){return null}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.bindRenderbuffer(F.RENDERBUFFER,k),this.current=k,this.dirty=!1}}class gs extends Zo{getDefault(){return null}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.bindTexture(F.TEXTURE_2D,k),this.current=k,this.dirty=!1}}class vs extends Zo{getDefault(){return null}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.bindBuffer(F.ARRAY_BUFFER,k),this.current=k,this.dirty=!1}}class ys extends Zo{getDefault(){return null}set(k){const F=this.gl;F.bindBuffer(F.ELEMENT_ARRAY_BUFFER,k),this.current=k,this.dirty=!1}}class xs extends Zo{getDefault(){return null}set(k){this.gl&&(k!==this.current||this.dirty)&&(this.gl.bindVertexArray(k),this.current=k,this.dirty=!1)}}class bs extends Zo{getDefault(){return 4}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.pixelStorei(F.UNPACK_ALIGNMENT,k),this.current=k,this.dirty=!1}}class ws extends Zo{getDefault(){return!1}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.pixelStorei(F.UNPACK_PREMULTIPLY_ALPHA_WEBGL,k),this.current=k,this.dirty=!1}}class Ts extends Zo{getDefault(){return!1}set(k){if(k===this.current&&!this.dirty)return;const F=this.gl;F.pixelStorei(F.UNPACK_FLIP_Y_WEBGL,k),this.current=k,this.dirty=!1}}class Es extends Zo{constructor(k,F){super(k),this.context=k,this.parent=F}getDefault(){return null}}class Ss extends Es{setDirty(){this.dirty=!0}set(k){if(k===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const F=this.gl;F.framebufferTexture2D(F.FRAMEBUFFER,F.COLOR_ATTACHMENT0,F.TEXTURE_2D,k,0),this.current=k,this.dirty=!1}}class Cs extends Es{attachment(){return this.gl.DEPTH_ATTACHMENT}set(k){if(k===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const F=this.gl;F.framebufferRenderbuffer(F.FRAMEBUFFER,this.attachment(),F.RENDERBUFFER,k),this.current=k,this.dirty=!1}}class Is extends Es{attachment(){return this.gl.DEPTH_ATTACHMENT}set(k){if(k===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const F=this.gl;F.framebufferTexture2D(F.FRAMEBUFFER,this.attachment(),F.TEXTURE_2D,k,0),this.current=k,this.dirty=!1}}class Rs extends Cs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Ds=(k,F,Me)=>({u_matrix:k,u_image0:0,u_skirt_height:F,u_ground_shadow_factor:Me}),Ls=(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi)=>({u_proj_matrix:Float32Array.from(k),u_globe_matrix:F,u_normalize_matrix:Float32Array.from(Ae),u_merc_matrix:Me,u_zoom_transition:Oe,u_merc_center:Fe,u_image0:0,u_frustum_tl:je,u_frustum_tr:qe,u_frustum_br:pt,u_frustum_bl:vt,u_globe_pos:Ut,u_globe_radius:xi,u_viewport:vi,u_grid_matrix:Mi?Float32Array.from(Mi):new Float32Array(9),u_skirt_height:bi,u_far_z_cutoff:wi});function As(k,F){return null!=k&&null!=F&&!(!k.hasData()||!F.hasData())&&null!=k.demTexture&&null!=F.demTexture&&k.tileID.key!==F.tileID.key}const Ju=new class{constructor(){this.operations={}}newMorphing(k,F,Me,Ae,Oe){if(k in this.operations){const F=this.operations[k];F.to.tileID.key!==Me.tileID.key&&(F.queued=Me)}else this.operations[k]={startTime:Ae,phase:0,duration:Oe,from:F,to:Me,queued:null}}getMorphValuesForProxy(k){if(!(k in this.operations))return null;const F=this.operations[k];return{from:F.from,to:F.to,phase:F.phase}}update(k){for(const F in this.operations){const Me=this.operations[F];for(Me.phase=(k-Me.startTime)/Me.duration;Me.phase>=1||!this._validOp(Me);)if(!this._nextOp(Me,k)){delete this.operations[F];break}}}_nextOp(k,F){return!!k.queued&&(k.from=k.to,k.to=k.queued,k.queued=null,k.phase=0,k.startTime=F,!0)}_validOp(k){return k.from.hasData()&&k.to.hasData()}},Qu={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ms(k,F,Me){if(0===F)return 0;const Ae=F<1&&514===Me?.25/F:1;return 6*Math.pow(1.5,22-k)*Math.max(F,1)*Ae}function Os(k,F){const Me=1<<k.z;return!F&&(0===k.x||k.x===Me-1)||0===k.y||k.y===Me-1}const Fs=k=>({u_matrix:k});function ks(F,Me,Ae,Oe,Fe){if(Fe>0){const je=k.q.now(),qe=(je-F.timeAdded)/Fe,pt=Me?(je-Me.timeAdded)/Fe:-1,vt=Ae.getSource(),Ut=Oe.coveringZoomLevel({tileSize:vt.tileSize,roundZoom:vt.roundZoom}),xi=!Me||Math.abs(Me.tileID.overscaledZ-Ut)>Math.abs(F.tileID.overscaledZ-Ut),vi=xi&&F.refreshedUponExpiration?1:k.aw(xi?qe:1-pt,0,1);return F.refreshedUponExpiration&&qe>=1&&(F.refreshedUponExpiration=!1),Me?{opacity:1,mix:1-vi}:{opacity:vi,mix:0}}return{opacity:1,mix:0}}class Bs extends Tt{constructor(F){const Me={type:"raster-dem",maxzoom:F.transform.maxZoom},Ae=new k.D(k.ci(),null),Oe=rt("mock-dem",Me,Ae,F.style);super("mock-dem",Oe,!1),Oe.setEventedParent(this),this._sourceLoaded=!0}_loadTile(k,F){k.state="loaded",F(null)}}class Ns extends Tt{constructor(F){const Me=rt("proxy",{type:"geojson",maxzoom:F.transform.maxZoom},new k.D(k.ci(),null),F.style);super("proxy",Me,!1),Me.setEventedParent(this),this.map=this.getSource().map=F,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(k,F,Me){if(k.freezeTileCoverage)return;this.transform=k;const Ae=k.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((F,Me)=>{if(F[Me.key]="",!this._tiles[Me.key]){const F=new yt(Me,this._source.tileSize*Me.overscaleFactor(),k.tileZoom);F.state="loaded",this._tiles[Me.key]=F}return F}),{});for(const k in this._tiles)k in Ae||(this.freeFBO(k),this._tiles[k].unloadVectorData(),delete this._tiles[k])}freeFBO(k){const F=this.proxyCachedFBO[k];if(void 0!==F){const Me=Object.values(F);this.renderCachePool.push(...Me),delete this.proxyCachedFBO[k]}}deallocRenderCache(){this.renderCache.forEach((k=>k.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Us extends k.aG{constructor(k,F,Me){super(k.overscaledZ,k.wrap,k.canonical.z,k.canonical.x,k.canonical.y),this.proxyTileKey=F,this.projMatrix=Me}}class Gs extends k.cJ{constructor(F,Me){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},F.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),F.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),F.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=F,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[Ae,Oe,Fe]=function(F){const Me=new k.b4,Ae=new k.aU,Oe=131;Me.reserve(17161),Ae.reserve(33800);const Fe=k.ag/128,je=k.ag+Fe/2,qe=je+Fe;for(let F=-Fe;F<qe;F+=Fe)for(let Ae=-Fe;Ae<qe;Ae+=Fe){const Oe=Ae<0||Ae>je||F<0||F>je?24575:0,Fe=k.aw(Math.round(Ae),0,k.ag),qe=k.aw(Math.round(F),0,k.ag);Me.emplaceBack(Fe+Oe,qe)}const l=(k,F)=>{const Me=F*Oe+k;Ae.emplaceBack(Me+1,Me,Me+Oe),Ae.emplaceBack(Me+Oe,Me+Oe+1,Me+1)};for(let k=1;k<129;k++)for(let F=1;F<129;F++)l(F,k);return[0,129].forEach((k=>{for(let F=0;F<130;F++)l(F,k),l(k,F)})),[Me,Ae,32768]}(),je=F.context;this.gridBuffer=je.createVertexBuffer(Ae,k.b6.members),this.gridIndexBuffer=je.createIndexBuffer(Oe),this.gridSegments=k.b7.simpleSegment(0,0,Ae.length,Oe.length),this.gridNoSkirtSegments=k.b7.simpleSegment(0,0,Ae.length,Fe),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Ns(Me.map),this.orthoMatrix=k.ab.mat4.create(),k.ab.mat4.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,k.ag,0,k.ag,0,1);const qe=je.gl;this._overlapStencilMode=new Bi({func:qe.GEQUAL,mask:255},0,255,qe.KEEP,qe.KEEP,qe.REPLACE),this._previousZoom=F.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=Me,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Bs(Me.map),this._pendingGroundEffectLayers=[]}set style(k){k.on("data",this._onStyleDataEvent.bind(this)),this._style=k,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(F,Me,Ae){if(F&&F.terrain){this._style!==F&&(this.style=F,this._evaluationZoom=void 0);const Oe=F.terrain.properties,Fe=0===F.terrain.drapeRenderMode,je=F.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=k.q.now();const qe=F.terrain&&F.terrain.scope,pt=Oe.get("source"),vt=Fe?this._mockSourceCache:F.getSourceCache(pt,qe);if(!vt)return void k.w(`Couldn't find terrain source "${pt}".`);if(this.sourceCache=vt,this._attenuationRange=F.terrain.getAttenuationRange(),this._exaggeration=je?this.calculateExaggeration(Me):Oe.get("exaggeration"),!Me.projection.requiresDraping&&je&&0===this._exaggeration)return void this._disable();this.enabled=!0;const h=()=>{this.sourceCache.used&&k.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const F=this.getScaledDemTileSize();this.sourceCache.update(Me,F,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),Me.updateElevation(!0,Ae),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(Me),this._emptyDEMTextureDirty=!0,this._previousZoom=Me.zoom}else this._disable()}calculateExaggeration(F){if(this._attenuationRange&&F.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(F.zoom);const Me=this._previousCameraAltitude,Ae=F.getFreeCameraOptions().position.z/F.pixelsPerMeter*F.worldSize;this._previousCameraAltitude=Ae;const Oe=null!=Me?Ae-Me:Number.MAX_VALUE;if(Math.abs(Oe)<2)return this._exaggeration;const Fe=F.zoom,je=this._style.terrain;if(!this._previousUpdateTimestamp)return je.getExaggeration(Fe);let qe=Fe-this._previousZoom;const pt=this._previousUpdateTimestamp;let vt=Fe;null!=this._evaluationZoom&&(vt=this._evaluationZoom,Math.abs(Fe-vt)>.5&&(qe=.5*(Fe-vt+qe)),qe*Oe<0&&(vt+=qe)),this._evaluationZoom=vt;const Ut=je.getExaggeration(vt),xi=Ut===je.getExaggeration(Math.max(0,vt-.1));if(xi&&Math.abs(Ut-this._exaggeration)<.01)return Ut;let vi=Math.min(.1,.00375*(this._updateTimestamp-pt));return(xi||Ut<.1||Math.abs(qe)<1e-4)&&(vi=Math.min(.2,4*vi)),k.af(this._exaggeration,Ut,vi)}resetTileLookupCache(k){this._findCoveringTileCache[k]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(k){k.coord&&"source"===k.dataType?this._clearRenderCacheForTile(k.sourceCacheId,k.coord):"style"===k.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const k in this._style._mergedSourceCaches)this._style._mergedSourceCaches[k].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((k=>k.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const k=2*this.proxySourceCache.getSource().tileSize;return[k,k]}set useVertexMorphing(k){this._useVertexMorphing=k}updateTileBinding(F){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const Me=this.proxySourceCache,Ae=this.painter.transform;this._initializing&&(this._initializing=0===Ae._centerAltitude&&-1===this.getAtPointOrZero(k.aa.fromLngLat(Ae.center),-1),this._emptyDEMTextureDirty=!this._initializing);const Oe=this.proxyCoords=Me.getIds().map((k=>{const F=Me.getTileByID(k).tileID;return F.projMatrix=Ae.calculateProjMatrix(F.toUnwrapped()),F}));!function(F,Me){const Ae=Me.transform.pointCoordinate(Me.transform.getCameraPoint()),Oe=new k.P(Ae.x,Ae.y);F.sort(((F,Me)=>{if(Me.overscaledZ-F.overscaledZ)return Me.overscaledZ-F.overscaledZ;const Ae=new k.P(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),Fe=new k.P(Me.canonical.x+(1<<Me.canonical.z)*Me.wrap,Me.canonical.y),je=Oe.mult(1<<F.canonical.z);return je.x-=.5,je.y-=.5,je.distSqr(Ae)-je.distSqr(Fe)}))}(Oe,this.painter);const Fe=this.proxyToSource||{};this.proxyToSource={},Oe.forEach((k=>{this.proxyToSource[k.key]={}})),this.terrainTileForTile={};const je=this._style._mergedSourceCaches;for(const k in je){const Me=je[k];if(!Me.used)continue;if(Me!==this.sourceCache&&this.resetTileLookupCache(Me.id),this._setupProxiedCoordsForOrtho(Me,F[k],Fe),Me.usedForTerrain)continue;const Ae=F[k];Me.getSource().reparseOverscaled&&this._assignTerrainTiles(Ae)}this.proxiedCoords[Me.id]=Oe.map((k=>new Us(k,k.key,this.orthoMatrix))),this._assignTerrainTiles(Oe),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(Fe),this.renderingToTexture=!1;const qe={};this._visibleDemTiles=[];for(const k of this.proxyCoords){const F=this.terrainTileForTile[k.key];if(!F)continue;const Me=F.tileID.key;Me in qe||(this._visibleDemTiles.push(F),qe[Me]=Me)}}_assignTerrainTiles(k){this._initializing||k.forEach((k=>{if(this.terrainTileForTile[k.key])return;const F=this._findTileCoveringTileID(k,this.sourceCache);F&&(this.terrainTileForTile[k.key]=F)}))}_prepareDEMTextures(){const k=this.painter.context,F=k.gl;for(const Me in this.terrainTileForTile){const Ae=this.terrainTileForTile[Me],Oe=Ae.dem;!Oe||Ae.demTexture&&!Ae.needsDEMTextureUpload||(k.activeTexture.set(F.TEXTURE1),qo(this.painter,Ae,Oe))}}_prepareDemTileUniforms(k,F,Me,Ae){if(!F||null==F.demTexture)return!1;const Oe=k.tileID.canonical,Fe=Math.pow(2,F.tileID.canonical.z-Oe.z),je=Ae||"";return Me[`u_dem_tl${je}`]=[Oe.x*Fe%1,Oe.y*Fe%1],Me[`u_dem_scale${je}`]=Fe,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let k=0;const F=this._visibleDemTiles.reduce(((F,Me)=>{if(!Me.dem)return F;const Ae=Me.dem.tree.minimums[0];return Ae>0&&k++,F+Ae}),0);return k?F/k:0}_updateEmptyDEMTexture(){const F=this.painter.context,Me=F.gl;F.activeTexture.set(Me.TEXTURE2);const Ae=this._getLoadedAreaMinimum(),Oe=new k.cK({width:1,height:1},new Float32Array([Ae]));this._emptyDEMTextureDirty=!1;let Fe=this._emptyDEMTexture;return Fe?Fe.update(Oe,{premultiply:!1}):Fe=this._emptyDEMTexture=new k.T(F,Oe,Me.R32F,{premultiply:!1}),Fe}setupElevationDraw(F,Me,Ae){const Oe=this.painter.context,Fe=Oe.gl,je={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};je.u_exaggeration=this.exaggeration();let qe=null,pt=null,vt=1;if(Ae&&Ae.morphing&&this._useVertexMorphing){const k=Ae.morphing.srcDemTile,Me=Ae.morphing.dstDemTile;vt=Ae.morphing.phase,k&&Me&&(this._prepareDemTileUniforms(F,k,je,"_prev")&&(pt=k),this._prepareDemTileUniforms(F,Me,je)&&(qe=Me))}const h=k=>k&&k.demTexture&&this.painter.linearFloatFilteringSupported()?Fe.LINEAR:Fe.NEAREST;let Ut=null;var xi;if(this.enabled?pt&&qe?(Ut=qe.demTexture,Oe.activeTexture.set(Fe.TEXTURE4),pt.demTexture.bind(h(pt),Fe.CLAMP_TO_EDGE),je.u_dem_lerp=vt):(qe=this.terrainTileForTile[F.tileID.key],Ut=this._prepareDemTileUniforms(F,qe,je)?qe.demTexture:this.emptyDEMTexture):Ut=this.emptyDEMTexture,Oe.activeTexture.set(Fe.TEXTURE2),Ut&&(je.u_dem_size=1===(xi=Ut).size[0]?1:xi.size[0]-2,Ut.bind(h(qe),Fe.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(Ae&&Ae.useDepthForOcclusion,Me,je),Ae&&Ae.useMeterToDem&&qe){const F=(1<<qe.tileID.canonical.z)*k.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;je.u_meter_to_dem=F}if(Ae&&Ae.labelPlaneMatrixInv&&(je.u_label_plane_matrix_inv=Ae.labelPlaneMatrixInv),Me.setTerrainUniformValues(Oe,je),"globe"===this.painter.transform.projection.name){const k=this.globeUniformValues(this.painter.transform,F.tileID.canonical,Ae&&Ae.useDenormalizedUpVectorScale);Me.setGlobeUniformValues(Oe,k)}}globeUniformValues(F,Me,Ae){const Oe=F.projection;return{u_tile_tl_up:Oe.upVector(Me,0,0),u_tile_tr_up:Oe.upVector(Me,k.ag,0),u_tile_br_up:Oe.upVector(Me,k.ag,k.ag),u_tile_bl_up:Oe.upVector(Me,0,k.ag),u_tile_up_scale:Ae?k.cL(1):Oe.upVectorScale(Me,F.center.lat,F.worldSize).metersToTile}}renderToBackBuffer(F){const Me=this.painter,Ae=this.painter.context;0!==F.length&&(Ae.bindFramebuffer.set(null),Ae.viewport.set([0,0,Me.width,Me.height]),Me.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(F,Me,Ae,Oe,Fe){if("globe"===F.transform.projection.name)!function(F,Me,Ae,Oe,Fe){const je=F.context,qe=je.gl;let pt,vt;const Ut=F.transform,xi=k.cC(F,je,Ut),d=(k,Me)=>{if(vt===Me)return;const Ae=[Qu[Me],"PROJECTION_GLOBE_VIEW"];xi&&Ae.push("CUSTOM_ANTIALIASING");const Oe=F.isTileAffectedByFog(k);pt=F.getOrCreateProgram("globeRaster",{defines:Ae,overrideFog:Oe}),vt=Me},vi=F.colorModeForRenderPass(),bi=new Fi(qe.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D);Ju.update(Fe);const wi=k.cD(Ut),Mi=[k.at(Ut.center.lng),k.aA(Ut.center.lat)],pr=F.globeSharedBuffers,Ur=[Ut.width*k.q.devicePixelRatio,Ut.height*k.q.devicePixelRatio],Wr=Float32Array.from(Ut.globeMatrix),Jr={useDenormalizedUpVectorScale:!0};{const Ut=F.transform,xi=Ms(Ut.zoom,Me.exaggeration(),Me.sourceCache._source.tileSize);vt=-1;const Qr=qe.TRIANGLES;for(const vt of Oe){const Oe=Ae.getTile(vt),co=Bi.disabled,mo=Me.prevTerrainTileForTile[vt.key],yo=Me.terrainTileForTile[vt.key];As(mo,yo)&&Ju.newMorphing(vt.key,mo,yo,Fe,250),je.activeTexture.set(qe.TEXTURE0),Oe.texture&&Oe.texture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE);const To=Ju.getMorphValuesForProxy(vt.key),zo=To?1:0;To&&k.J(Jr,{morphing:{srcDemTile:To.from,dstDemTile:To.to,phase:k.cB(To.phase)}});const ko=k.cE(vt.canonical),na=k.cF(ko.getCenter().lat),aa=k.cG(vt.canonical,ko,na,Ut.worldSize/Ut._pixelsPerMercatorPixel),_a=k.bb(k.cH(vt.canonical)),wa=Ls(Ut.expandedFarZProjMatrix,Wr,wi,_a,k.ae(Ut.zoom),Mi,Ut.frustumCorners.TL,Ut.frustumCorners.TR,Ut.frustumCorners.BR,Ut.frustumCorners.BL,Ut.globeCenterInViewSpace,Ut.globeRadius,Ur,xi,Ut._farZ,aa);if(d(vt,zo),pt&&(Me.setupElevationDraw(Oe,pt,Jr),F.uploadCommonUniforms(je,pt,vt.toUnwrapped()),pr)){const[k,Me,Ae]=pr.getGridBuffers(na,0!==xi);pt.draw(F,Qr,bi,co,vi,Gi.backCCW,wa,"globe_raster",k,Me,Ae)}}}if(pr&&(F.renderDefaultNorthPole||F.renderDefaultSouthPole)){const Fe=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];xi&&Fe.push("CUSTOM_ANTIALIASING"),pt=F.getOrCreateProgram("globeRaster",{defines:Fe});for(const Fe of Oe){const{x:Oe,y:vt,z:xi}=Fe.canonical,wi=0===vt,Wr=vt===(1<<xi)-1,[Qr,co,mo,yo]=pr.getPoleBuffers(xi,!1);if(yo&&(wi||Wr)){const vt=Ae.getTile(Fe);je.activeTexture.set(qe.TEXTURE0),vt.texture&&vt.texture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE);let pr=k.cI(xi,Oe,Ut);const To=k.bb(k.cH(Fe.canonical)),S=(k,Me)=>k.draw(F,qe.TRIANGLES,bi,Bi.disabled,vi,Gi.disabled,Ls(Ut.expandedFarZProjMatrix,pr,pr,To,0,Mi,Ut.frustumCorners.TL,Ut.frustumCorners.TR,Ut.frustumCorners.BR,Ut.frustumCorners.BL,Ut.globeCenterInViewSpace,Ut.globeRadius,Ur,0,Ut._farZ),"globe_pole_raster",Me,mo,yo);Me.setupElevationDraw(vt,pt,Jr),F.uploadCommonUniforms(je,pt,Fe.toUnwrapped()),wi&&F.renderDefaultNorthPole&&S(pt,Qr),Wr&&F.renderDefaultSouthPole&&(pr=k.ab.mat4.scale(k.ab.mat4.create(),pr,[1,-1,1]),S(pt,co))}}}}(F,Me,Ae,Oe,Fe);else{const je=F.context,qe=je.gl;let pt,vt;const Ut=F.shadowRenderer,xi=Ji(F,F.longestCutoffRange),d=k=>{if(vt===k)return;const Me=[];Me.push(Qu[k]),xi.shouldRenderCutoff&&Me.push("RENDER_CUTOFF"),Ut&&(Me.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ut.useNormalOffset&&Me.push("NORMAL_OFFSET")),pt=F.getOrCreateProgram("terrainRaster",{defines:Me}),vt=k},vi=F.colorModeForRenderPass(),bi=new Fi(qe.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D);Ju.update(Fe);const wi=F.transform,Mi=Ms(wi.zoom,Me.exaggeration(),Me.sourceCache._source.tileSize);let pr=[0,0,0];if(Ut){const k=F.style.directionalLight,Me=F.style.ambientLight;k&&Me&&(pr=ro(F.style,k,Me))}{vt=-1;const Ur=qe.TRIANGLES,[Wr,Jr]=[Me.gridIndexBuffer,Me.gridSegments];for(const vt of Oe){const Oe=Ae.getTile(vt),Qr=Bi.disabled,co=Me.prevTerrainTileForTile[vt.key],mo=Me.terrainTileForTile[vt.key];As(co,mo)&&Ju.newMorphing(vt.key,co,mo,Fe,250),je.activeTexture.set(qe.TEXTURE0),Oe.texture&&Oe.texture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE);const yo=Ju.getMorphValuesForProxy(vt.key),To=yo?1:0;let zo;yo&&(zo={morphing:{srcDemTile:yo.from,dstDemTile:yo.to,phase:k.cB(yo.phase)}});const ko=Ds(vt.projMatrix,Os(vt.canonical,wi.renderWorldCopies)?Mi/10:Mi,pr);if(d(To),!pt)continue;Me.setupElevationDraw(Oe,pt,zo);const na=vt.toUnwrapped();Ut&&Ut.setupShadows(na,pt),F.uploadCommonUniforms(je,pt,na,null,xi),pt.draw(F,Ur,bi,Qr,vi,Gi.backCCW,ko,"terrain_raster",Me.gridBuffer,Wr,Jr)}}}}(Me,this,this.proxySourceCache,F,this._updateTimestamp),this.renderingToTexture=!0,Me.gpuTimingDeferredRenderEnd(),F.splice(0,F.length))}renderBatch(F){if(0===this._drapedRenderBatches.length)return F+1;this.renderingToTexture=!0;const Me=this.painter,Ae=this.painter.context,Oe=this.proxySourceCache,Fe=this.proxiedCoords[Oe.id],je=this._drapedRenderBatches.shift(),qe=Me.style.order,pt=[];let vt=0;for(const Ut of Fe){const Fe=Oe.getTileByID(Ut.proxyTileKey),xi=Oe.proxyCachedFBO[Ut.key]?Oe.proxyCachedFBO[Ut.key][F]:void 0,vi=void 0!==xi?Oe.renderCache[xi]:this.pool[vt++],bi=void 0!==xi;if(Fe.texture=vi.tex,bi&&!vi.dirty){pt.push(Fe.tileID);continue}let wi;Ae.bindFramebuffer.set(vi.fb.framebuffer),this.renderedToTile=!1,vi.dirty&&(Ae.clear({color:k.aj.transparent,stencil:0}),vi.dirty=!1);for(let k=je.start;k<=je.end;++k){const F=Me.style._mergedLayers[qe[k]];if(F.isHidden(Me.transform.zoom))continue;const Oe=Me.style.getLayerSourceCache(F),Fe=Oe?this.proxyToSource[Ut.key][Oe.id]:[Ut];if(!Fe)continue;const je=Fe;Ae.viewport.set([0,0,vi.fb.width,vi.fb.height]),wi!==(Oe?Oe.id:null)&&(this._setupStencil(vi,Fe,F,Oe),wi=Oe?Oe.id:null),Me.renderLayer(Me,Oe,F,je)}if(0===this._drapedRenderBatches.length)for(const k of this._pendingGroundEffectLayers){const F=Me.style._mergedLayers[qe[k]];if(F.isHidden(Me.transform.zoom))continue;const Oe=Me.style.getLayerSourceCache(F),Fe=Oe?this.proxyToSource[Ut.key][Oe.id]:[Ut];if(!Fe)continue;const je=Fe;Ae.viewport.set([0,0,vi.fb.width,vi.fb.height]),wi!==(Oe?Oe.id:null)&&(this._setupStencil(vi,Fe,F,Oe),wi=Oe?Oe.id:null),Me.renderLayer(Me,Oe,F,je)}this.renderedToTile?(vi.dirty=!0,pt.push(Fe.tileID)):bi||--vt,5===vt&&(vt=0,this.renderToBackBuffer(pt))}return this.renderToBackBuffer(pt),this.renderingToTexture=!1,Ae.bindFramebuffer.set(null),Ae.viewport.set([0,0,Me.width,Me.height]),je.end+1}postRender(){}isLayerOrderingCorrect(k){const F=k.order.length;let Me=-1,Ae=F;for(let Oe=0;Oe<F;++Oe)this._style.isLayerDraped(k._mergedLayers[k.order[Oe]])?Me=Math.max(Me,Oe):Ae=Math.min(Ae,Oe);return Ae>Me}getMinElevationBelowMSL(){let k=0;return this._visibleDemTiles.filter((k=>k.dem)).forEach((F=>{k=Math.min(k,F.dem.tree.minimums[0])})),0===k?k:(k-30)*this._exaggeration}raycast(k,F,Me){if(!this._visibleDemTiles)return null;const Ae=this._visibleDemTiles.filter((k=>k.dem)).map((Ae=>{const Oe=Ae.tileID,Fe=1<<Oe.overscaledZ,{x:je,y:qe}=Oe.canonical,pt=je/Fe,vt=(je+1)/Fe,Ut=qe/Fe,xi=(qe+1)/Fe;return{minx:pt,miny:Ut,maxx:vt,maxy:xi,t:Ae.dem.tree.raycastRoot(pt,Ut,vt,xi,k,F,Me),tile:Ae}}));Ae.sort(((k,F)=>(null!==k.t?k.t:Number.MAX_VALUE)-(null!==F.t?F.t:Number.MAX_VALUE)));for(const Oe of Ae){if(null==Oe.t)return null;const Ae=Oe.tile.dem.tree.raycast(Oe.minx,Oe.miny,Oe.maxx,Oe.maxy,k,F,Me);if(null!=Ae)return Ae}return null}_createFBO(){const F=this.painter.context,Me=F.gl,Ae=this.drapeBufferSize;F.activeTexture.set(Me.TEXTURE0);const Oe=new k.T(F,{width:Ae[0],height:Ae[1],data:null},Me.RGBA8);Oe.bind(Me.LINEAR,Me.CLAMP_TO_EDGE);const Fe=F.createFramebuffer(Ae[0],Ae[1],!0,null);return Fe.colorAttachment.set(Oe.texture),Fe.depthAttachment=new Rs(F,Fe.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=F.createRenderbuffer(F.gl.DEPTH_STENCIL,Ae[0],Ae[1]),this._stencilRef=0,Fe.depthAttachment.set(this._sharedDepthStencil),F.clear({stencil:0})):Fe.depthAttachment.set(this._sharedDepthStencil),F.extTextureFilterAnisotropic&&Me.texParameterf(Me.TEXTURE_2D,F.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,F.extTextureFilterAnisotropicMax),{fb:Fe,tex:Oe,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const k in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[k].hasTransition())return!0;return this._style.order.some((k=>{const F=this._style._mergedLayers[k],Me=F.isHidden(this.painter.transform.zoom);return"hillshade"===F.type||"custom"===F.type?!Me&&F.shouldRedrape():!Me&&F.hasTransition()}))}_clearLineLayersFromRenderCache(){let F=!1;for(const k of this._style.getSources())if(k instanceof tt){F=!0;break}if(!F)return;const Me={};for(let F=0;F<this._style.order.length;++F){const Ae=this._style._mergedLayers[this._style.order[F]],Oe=this._style.getLayerSourceCache(Ae);if(Oe&&!Me[Oe.id]&&!Ae.isHidden(this.painter.transform.zoom)&&"line"===Ae.type&&Ae.widthExpression()instanceof k.a9){Me[Oe.id]=!0;for(const k of this.proxyCoords){const F=this.proxyToSource[k.key][Oe.id];if(F)for(const k of F)this._clearRenderCacheForTile(Oe.id,k)}}}}_clearRasterLayersFromRenderCache(){let k=!1;for(const F in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[F]._source instanceof it){k=!0;break}if(!k)return;const F={};for(let k=0;k<this._style.order.length;++k){const Me=this._style._mergedLayers[this._style.order[k]],Ae=this._style.getLayerSourceCache(Me);if(!Ae||F[Ae.id])continue;if(Me.isHidden(this.painter.transform.zoom)||"raster"!==Me.type)continue;const Oe=Me.paint.get("raster-fade-duration");for(const k of this.proxyCoords){const F=this.proxyToSource[k.key][Ae.id];if(F)for(const k of F){const F=ks(Ae.getTile(k),Ae.findLoadedParent(k,0),Ae,this.painter.transform,Oe);(1!==F.opacity||0!==F.mix)&&this._clearRenderCacheForTile(Ae.id,k)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const F=this._style.order,Me=F.length;if(0===Me)return;const Ae=[];this._pendingGroundEffectLayers=[];let Oe,Fe=0,je=this._style._mergedLayers[F[Fe]];for(;!this._style.isLayerDraped(je)&&je.isHidden(this.painter.transform.zoom)&&++Fe<Me;)je=this._style._mergedLayers[F[Fe]];for(;Fe<Me;++Fe){const k=this._style._mergedLayers[F[Fe]];k.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(k)?void 0===Oe&&(Oe=Fe):("fill-extrusion"===k.type&&this._pendingGroundEffectLayers.push(Fe),void 0!==Oe&&(Ae.push({start:Oe,end:Fe-1}),Oe=void 0)))}if(void 0!==Oe&&Ae.push({start:Oe,end:Fe-1}),0!==Ae.length){const F=Ae[Ae.length-1];this._pendingGroundEffectLayers.every((k=>k>F.end))||k.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=Ae}_setupRenderCache(k){const F=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,F.renderCache.length>F.renderCachePool.length){const k=Object.values(F.proxyCachedFBO);F.proxyCachedFBO={};for(let Me=0;Me<k.length;++Me){const Ae=Object.values(k[Me]);F.renderCachePool.push(...Ae)}}return}this._clearRasterLayersFromRenderCache();const Me=this.proxyCoords,Ae=this._tilesDirty;for(let Oe=Me.length-1;Oe>=0;Oe--){const Fe=Me[Oe];if(F.getTileByID(Fe.key),void 0!==F.proxyCachedFBO[Fe.key]){const Me=k[Fe.key],Oe=this.proxyToSource[Fe.key];let je=0;for(const k in Oe){const F=Oe[k],Fe=Me[k];if(!Fe||Fe.length!==F.length||F.some(((F,Me)=>F!==Fe[Me]||Ae[k]&&Ae[k].hasOwnProperty(F.key)))){je=-1;break}++je}for(const k in F.proxyCachedFBO[Fe.key])F.renderCache[F.proxyCachedFBO[Fe.key][k]].dirty=je<0||je!==Object.values(Me).length}}const Oe=[...this._drapedRenderBatches];Oe.sort(((k,F)=>F.end-F.start-(k.end-k.start)));for(const k of Oe)for(const Ae of Me){if(F.proxyCachedFBO[Ae.key])continue;let Me=F.renderCachePool.pop();void 0===Me&&F.renderCache.length<50&&(Me=F.renderCache.length,F.renderCache.push(this._createFBO())),void 0!==Me&&(F.proxyCachedFBO[Ae.key]={},F.proxyCachedFBO[Ae.key][k.start]=Me,F.renderCache[Me].dirty=!0)}this._tilesDirty={}}_setupStencil(k,F,Me,Ae){if(!Ae||!this._sourceTilesOverlap[Ae.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const Oe=this.painter.context,Fe=Oe.gl;if(F.length<=1)return void(this._overlapStencilType=!1);let je;if(Me.isTileClipped())je=F.length,this._overlapStencilMode.test={func:Fe.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(F[0].overscaledZ>F[F.length-1].overscaledZ))return void(this._overlapStencilType=!1);je=1,this._overlapStencilMode.test={func:Fe.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+je>255&&(Oe.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=je,this._overlapStencilMode.ref=this._stencilRef,Me.isTileClipped()&&this._renderTileClippingMasks(F,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(k){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[k.key]),this._overlapStencilMode):Bi.disabled}_renderTileClippingMasks(k,F){const Me=this.painter,Ae=this.painter.context,Oe=Ae.gl;Me._tileClippingMaskIDs={},Ae.setColorMode(Oi.disabled),Ae.setDepthMode(Fi.disabled);const Fe=Me.getOrCreateProgram("clippingMask");for(const Ae of k){const k=Me._tileClippingMaskIDs[Ae.key]=--F;Fe.draw(Me,Oe.TRIANGLES,Fi.disabled,new Bi({func:Oe.ALWAYS,mask:0},k,255,Oe.KEEP,Oe.KEEP,Oe.REPLACE),Oi.disabled,Gi.disabled,Fs(Ae.projMatrix),"$clipping",Me.tileExtentBuffer,Me.quadTriangleIndexBuffer,Me.tileExtentSegments)}}pointCoordinate(F){const Me=this.painter.transform;if(F.x<0||F.x>Me.width||F.y<0||F.y>Me.height)return null;const Ae=[F.x,F.y,1,1];k.ab.vec4.transformMat4(Ae,Ae,Me.pixelMatrixInverse),k.ab.vec4.scale(Ae,Ae,1/Ae[3]),Ae[0]/=Me.worldSize,Ae[1]/=Me.worldSize;const Oe=Me._camera.position,Fe=k.bH(1,Me.center.lat),je=[Oe[0],Oe[1],Oe[2]/Fe,0],qe=k.ab.vec3.subtract([],Ae.slice(0,3),je);k.ab.vec3.normalize(qe,qe);const pt=this.raycast(je,qe,this._exaggeration);return null!==pt&&pt?(k.ab.vec3.scaleAndAdd(je,je,qe,pt),je[3]=je[2],je[2]*=Fe,je):null}_setupProxiedCoordsForOrtho(F,Me,Ae){if(F.getSource()instanceof k.aJ)return this._setupProxiedCoordsForImageSource(F,Me,Ae);this._findCoveringTileCache[F.id]=this._findCoveringTileCache[F.id]||{};const Oe=this.proxiedCoords[F.id]=[],Fe=this.proxyCoords;for(let k=0;k<Fe.length;k++){const Me=Fe[k],je=this._findTileCoveringTileID(Me,F);if(je){const k=this._createProxiedId(Me,je,Ae[Me.key]&&Ae[Me.key][F.id]);Oe.push(k),this.proxyToSource[Me.key][F.id]=[k]}}let je=!1;const qe=new Set;for(let k=0;k<Me.length;k++){const Fe=F.getTile(Me[k]);if(!Fe||!Fe.hasData())continue;const pt=this._findTileCoveringTileID(Fe.tileID,this.proxySourceCache);if(pt&&pt.tileID.canonical.z!==Fe.tileID.canonical.z){const k=this.proxyToSource[pt.tileID.key][F.id],Me=this._createProxiedId(pt.tileID,Fe,Ae[pt.tileID.key]&&Ae[pt.tileID.key][F.id]);k?k.splice(k.length-1,0,Me):this.proxyToSource[pt.tileID.key][F.id]=[Me];const vt=this.proxyToSource[pt.tileID.key][F.id];qe.has(vt)||qe.add(vt),Oe.push(Me),je=!0}}if(this._sourceTilesOverlap[F.id]=je,je&&this._debugParams.sortTilesHiZFirst)for(const k of qe)k.sort(((k,F)=>F.overscaledZ-k.overscaledZ))}_setupProxiedCoordsForImageSource(F,Me,Ae){if(!F.getSource().loaded())return;const Oe=this.proxiedCoords[F.id]=[],Fe=this.proxyCoords,je=F.getSource(),qe=je.tileID;if(!qe)return;const pt=new k.P(qe.x,qe.y)._div(1<<qe.z),vt=je.coordinates.map(k.aa.fromLngLat).reduce(((k,F)=>(k.min.x=Math.min(k.min.x,F.x-pt.x),k.min.y=Math.min(k.min.y,F.y-pt.y),k.max.x=Math.max(k.max.x,F.x-pt.x),k.max.y=Math.max(k.max.y,F.y-pt.y),k)),{min:new k.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new k.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(F,Me)=>{const Ae=F.wrap+F.canonical.x/(1<<F.canonical.z),Oe=F.canonical.y/(1<<F.canonical.z),Fe=k.ag/(1<<F.canonical.z),je=Me.wrap+Me.canonical.x/(1<<Me.canonical.z),qe=Me.canonical.y/(1<<Me.canonical.z);return Ae+Fe<je+vt.min.x||Ae>je+vt.max.x||Oe+Fe<qe+vt.min.y||Oe>qe+vt.max.y};for(let k=0;k<Fe.length;k++){const je=Fe[k];for(let k=0;k<Me.length;k++){const Fe=F.getTile(Me[k]);if(!Fe||!Fe.hasData())continue;if(h(je,Fe.tileID))continue;const qe=this._createProxiedId(je,Fe,Ae[je.key]&&Ae[je.key][F.id]),pt=this.proxyToSource[je.key][F.id];pt?pt.push(qe):this.proxyToSource[je.key][F.id]=[qe],Oe.push(qe)}}}_createProxiedId(F,Me,Ae){let Oe=this.orthoMatrix;if(Ae){const k=Ae.find((k=>k.key===Me.tileID.key));if(k)return k}if(Me.tileID.key!==F.key){const Ae=F.canonical.z-Me.tileID.canonical.z;let Fe,je,qe;Oe=k.ab.mat4.create();const pt=Me.tileID.wrap-F.wrap<<F.overscaledZ;Ae>0?(Fe=k.ag>>Ae,je=Fe*((Me.tileID.canonical.x<<Ae)-F.canonical.x+pt),qe=Fe*((Me.tileID.canonical.y<<Ae)-F.canonical.y)):(Fe=k.ag<<-Ae,je=k.ag*(Me.tileID.canonical.x-(F.canonical.x+pt<<-Ae)),qe=k.ag*(Me.tileID.canonical.y-(F.canonical.y<<-Ae))),k.ab.mat4.ortho(Oe,0,Fe,0,Fe,0,1),k.ab.mat4.translate(Oe,Oe,[je,qe,0])}return new Us(Me.tileID,F.key,Oe)}_findTileCoveringTileID(F,Me){let Ae=Me.getTile(F);if(Ae&&Ae.hasData())return Ae;const Oe=this._findCoveringTileCache[Me.id],Fe=Oe[F.key];if(Ae=Fe?Me.getTileByID(Fe):null,Ae&&Ae.hasData()||null===Fe)return Ae;let je=Ae?Ae.tileID:F,qe=je.overscaledZ;const pt=Me.getSource().minzoom,vt=[];if(!Fe){const Oe=Me.getSource().maxzoom;if(F.canonical.z>=Oe){const Ae=F.canonical.z-Oe;Me.getSource().reparseOverscaled?(qe=Math.max(F.canonical.z+2,Me.transform.tileZoom),je=new k.aG(qe,F.wrap,Oe,F.canonical.x>>Ae,F.canonical.y>>Ae)):0!==Ae&&(qe=Oe,je=new k.aG(qe,F.wrap,Oe,F.canonical.x>>Ae,F.canonical.y>>Ae))}je.key!==F.key&&(vt.push(je.key),Ae=Me.getTile(je))}const h=k=>{vt.forEach((F=>{Oe[F]=k})),vt.length=0};for(qe-=1;qe>=pt&&(!Ae||!Ae.hasData());qe--){Ae&&h(Ae.tileID.key);const k=je.calculateScaledKey(qe);if(Ae=Me.getTileByID(k),Ae&&Ae.hasData())break;const F=Oe[k];if(null===F)break;void 0===F?vt.push(k):Ae=Me.getTileByID(F)}return h(Ae?Ae.tileID.key:null),Ae&&Ae.hasData()?Ae:null}findDEMTileFor(k){return this.enabled?this._findTileCoveringTileID(k,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(k,F){let Me=this._tilesDirty[k];Me||(Me=this._tilesDirty[k]={}),Me[F.key]=!0}}function js(F,Me,Ae){const Oe=function(F,Me,Ae){const Oe=k.ab.vec3.dot(Me,F),Fe=k.ab.vec3.dot(Ae,[.2126,.7152,.0722]),a=(k,F,Me)=>(1-Me)*k+Me*F,je=a(1-.3*Math.min(Fe,1),1,Math.min(Oe+1,1));return a(.92,1,Math.asin(k.aw(Me[2],-1,1))/Math.PI+.5)*je}(F,[0,0,1],Me),Fe=[0,0,0];k.ab.vec3.scale(Fe,Ae.slice(0,3),Oe);const je=[0,0,0];k.ab.vec3.scale(je,Me.slice(0,3),F[2]);const qe=[0,0,0];return k.ab.vec3.add(qe,Fe,je),k.cf(qe)}const cd=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],ud=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","model","symbol"];class Hs{static cacheKey(k,F,Me,Ae){let Oe=`${F}${Ae?Ae.cacheKey:""}`;for(const F of Me)k.usedDefines.includes(F)&&(Oe+=`/${F}`);return Oe}constructor(F,Me,Ae,Oe,Fe,je){const qe=F.gl;this.program=qe.createProgram(),this.configuration=Oe,this.name=Me,this.fixedDefines=[...je];const pt=Oe?Oe.getBinderAttributes():[],vt=(Ae.staticAttributes||[]).concat(pt);let Ut=Oe?Oe.defines():[];Ut=Ut.concat(je.map((k=>`#define ${k}`)));const xi="#version 300 es\n";let vi=xi+Ut.concat("precision mediump float;",Zu,qu.fragmentSource).join("\n");for(const k of Ae.fragmentIncludes)vi+=`\n${Uu[k]}`;vi+=`\n${Ae.fragmentSource}`;let bi=xi+Ut.concat("precision highp float;",Zu,qu.vertexSource).join("\n");for(const k of Ae.vertexIncludes)bi+=`\n${Uu[k]}`;this.forceManualRenderingForInstanceIDShaders=F.forceManualRenderingForInstanceIDShaders&&-1!==Ae.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(bi+="\nuniform int u_instanceID;\n"),bi+=`\n${Ae.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(bi=bi.replaceAll("gl_InstanceID","u_instanceID"));const wi=qe.createShader(qe.FRAGMENT_SHADER);if(qe.isContextLost())return void(this.failedToCreate=!0);qe.shaderSource(wi,vi),qe.compileShader(wi),qe.attachShader(this.program,wi);const Mi=qe.createShader(qe.VERTEX_SHADER);if(qe.isContextLost())this.failedToCreate=!0;else{qe.shaderSource(Mi,bi),qe.compileShader(Mi),qe.attachShader(this.program,Mi),this.attributes={},this.numAttributes=vt.length;for(let k=0;k<this.numAttributes;k++)if(vt[k]){const F=vt[k].startsWith("a_")?vt[k]:`a_${vt[k]}`;qe.bindAttribLocation(this.program,k,F),this.attributes[F]=k}qe.linkProgram(this.program),qe.deleteShader(Mi),qe.deleteShader(wi),this.fixedUniforms=Fe(F),this.binderUniforms=Oe?Oe.getUniforms(F):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(F=>({u_instanceID:new k.bN(F)}))(F)),(je.includes("TERRAIN")||-1!==Me.indexOf("symbol")||-1!==Me.indexOf("circle"))&&(this.terrainUniforms=(F=>({u_dem:new k.bN(F),u_dem_prev:new k.bN(F),u_dem_tl:new k.bK(F),u_dem_scale:new k.bM(F),u_dem_tl_prev:new k.bK(F),u_dem_scale_prev:new k.bM(F),u_dem_size:new k.bM(F),u_dem_lerp:new k.bM(F),u_exaggeration:new k.bM(F),u_depth:new k.bN(F),u_depth_size_inv:new k.bK(F),u_depth_range_unpack:new k.bK(F),u_occluder_half_size:new k.bM(F),u_occlusion_depth_offset:new k.bM(F),u_meter_to_dem:new k.bM(F),u_label_plane_matrix_inv:new k.bJ(F)}))(F)),je.includes("GLOBE")&&(this.globeUniforms=(F=>({u_tile_tl_up:new k.bL(F),u_tile_tr_up:new k.bL(F),u_tile_br_up:new k.bL(F),u_tile_bl_up:new k.bL(F),u_tile_up_scale:new k.bM(F)}))(F)),je.includes("FOG")&&(this.fogUniforms=(F=>({u_fog_matrix:new k.bJ(F),u_fog_range:new k.bK(F),u_fog_color:new k.ca(F),u_fog_horizon_blend:new k.bM(F),u_fog_vertical_limit:new k.bK(F),u_fog_temporal_offset:new k.bM(F),u_frustum_tl:new k.bL(F),u_frustum_tr:new k.bL(F),u_frustum_br:new k.bL(F),u_frustum_bl:new k.bL(F),u_globe_pos:new k.bL(F),u_globe_radius:new k.bM(F),u_globe_transition:new k.bM(F),u_is_globe:new k.bN(F),u_viewport:new k.bK(F)}))(F)),je.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(F=>({u_cutoff_params:new k.ca(F)}))(F)),je.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(F=>({u_lighting_ambient_color:new k.bL(F),u_lighting_directional_dir:new k.bL(F),u_lighting_directional_color:new k.bL(F),u_ground_radiance:new k.bL(F)}))(F)),je.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(F=>({u_light_matrix_0:new k.bJ(F),u_light_matrix_1:new k.bJ(F),u_fade_range:new k.bK(F),u_shadow_normal_offset:new k.bL(F),u_shadow_intensity:new k.bM(F),u_shadow_texel_size:new k.bM(F),u_shadow_map_resolution:new k.bM(F),u_shadow_direction:new k.bL(F),u_shadow_bias:new k.bL(F),u_shadowmap_0:new k.bN(F),u_shadowmap_1:new k.bN(F)}))(F))}}setTerrainUniformValues(k,F){if(!this.terrainUniforms)return;const Me=this.terrainUniforms;if(!this.failedToCreate){k.program.set(this.program);for(const k in F)Me[k]&&Me[k].set(this.program,k,F[k])}}setGlobeUniformValues(k,F){if(!this.globeUniforms)return;const Me=this.globeUniforms;if(!this.failedToCreate){k.program.set(this.program);for(const k in F)Me[k]&&Me[k].set(this.program,k,F[k])}}setFogUniformValues(k,F){if(!this.fogUniforms)return;const Me=this.fogUniforms;if(!this.failedToCreate){k.program.set(this.program);for(const k in F)Me[k].set(this.program,k,F[k])}}setCutoffUniformValues(k,F){if(!this.cutoffUniforms)return;const Me=this.cutoffUniforms;if(!this.failedToCreate){k.program.set(this.program);for(const k in F)Me[k].set(this.program,k,F[k])}}setLightsUniformValues(k,F){if(!this.lightsUniforms)return;const Me=this.lightsUniforms;if(!this.failedToCreate){k.program.set(this.program);for(const k in F)Me[k].set(this.program,k,F[k])}}setShadowUniformValues(k,F){if(this.failedToCreate||!this.shadowUniforms)return;const Me=this.shadowUniforms;k.program.set(this.program);for(const k in F)Me[k].set(this.program,k,F[k])}_drawDebugWireframe(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut){const xi=F.options.wireframe;if(!1===xi.terrain&&!1===xi.layers2D&&!1===xi.layers3D)return;const vi=F.context;if(!(()=>!(!xi.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!xi.layers2D||F._terrain&&F._terrain.renderingToTexture||!cd.includes(this.name))||!(!xi.layers3D||!ud.includes(this.name)))())return;const bi=vi.gl,wi=F.wireframeDebugCache.getLinesFromTrianglesBuffer(F.frameCounter,Fe,vi);if(!wi)return;const Mi=[...this.fixedDefines];Mi.push("DEBUG_WIREFRAME");const pr=F.getOrCreateProgram(this.name,{config:this.configuration,defines:Mi});vi.program.set(pr.program);const g=(k,F,Me)=>{if(F[k]&&Me[k])for(const Ae in F[k])Me[k][Ae]&&Me[k][Ae].set(Me.program,Ae,F[k][Ae].current)};vt&&vt.setUniforms(pr.program,vi,pr.binderUniforms,qe,{zoom:pt}),g("fixedUniforms",this,pr),g("terrainUniforms",this,pr),g("globeUniforms",this,pr),g("fogUniforms",this,pr),g("lightsUniforms",this,pr),g("shadowUniforms",this,pr),wi.bind(),vi.setColorMode(new Oi([bi.ONE,bi.ONE_MINUS_SRC_ALPHA,bi.ZERO,bi.ONE],k.aj.transparent,[!0,!0,!0,!1])),vi.setDepthMode(new Fi(Me.func===bi.LESS?bi.LEQUAL:Me.func,Fi.ReadOnly,Me.range)),vi.setStencilMode(Bi.disabled);const Ur=3*je.primitiveLength*2,Wr=3*je.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const k=Ut||1;for(let F=0;F<k;++F)pr.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",F),bi.drawElements(bi.LINES,Ur,bi.UNSIGNED_SHORT,Wr)}else Ut&&Ut>1?bi.drawElementsInstanced(bi.LINES,Ur,bi.UNSIGNED_SHORT,Wr,Ut):bi.drawElements(bi.LINES,Ur,bi.UNSIGNED_SHORT,Wr);Fe.bind(),vi.program.set(this.program),vi.setDepthMode(Me),vi.setStencilMode(Ae),vi.setColorMode(Oe)}checkUniforms(k,F,Me){if(this.fixedDefines.includes(F))for(const Ae of Object.keys(Me))if(!Me[Ae].initialized)throw new Error(`Program '${this.name}', from draw '${k}': uniform ${Ae} not set but required by ${F} being defined`)}draw(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi){const pr=k.context,Ur=pr.gl;if(this.failedToCreate)return;pr.program.set(this.program),pr.setDepthMode(Me),pr.setStencilMode(Ae),pr.setColorMode(Oe),pr.setCullFace(Fe);for(const k of Object.keys(this.fixedUniforms))this.fixedUniforms[k].set(this.program,k,je[k]);bi&&bi.setUniforms(this.program,pr,this.binderUniforms,xi,{zoom:vi});const Wr={[Ur.POINTS]:1,[Ur.LINES]:2,[Ur.TRIANGLES]:3,[Ur.LINE_STRIP]:1}[F];this.checkUniforms(qe,"RENDER_SHADOWS",this.shadowUniforms);const Jr=Mi&&Mi>0?1:void 0;for(const Fe of Ut.get()){const je=Fe.vaos||(Fe.vaos={});if((je[qe]||(je[qe]=new Go)).bind(pr,this,pt,bi?bi.getPaintVertexBuffers():[],vt,Fe.vertexOffset,wi||[],Jr),this.forceManualRenderingForInstanceIDShaders){const k=Mi||1;for(let Me=0;Me<k;++Me)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Me),vt?Ur.drawElements(F,Fe.primitiveLength*Wr,Ur.UNSIGNED_SHORT,Fe.primitiveOffset*Wr*2):Ur.drawArrays(F,Fe.vertexOffset,Fe.vertexLength)}else Mi&&Mi>1?Ur.drawElementsInstanced(F,Fe.primitiveLength*Wr,Ur.UNSIGNED_SHORT,Fe.primitiveOffset*Wr*2,Mi):vt?Ur.drawElements(F,Fe.primitiveLength*Wr,Ur.UNSIGNED_SHORT,Fe.primitiveOffset*Wr*2):Ur.drawArrays(F,Fe.vertexOffset,Fe.vertexLength);F===Ur.TRIANGLES&&vt&&this._drawDebugWireframe(k,Me,Ae,Oe,vt,Fe,xi,vi,bi,Mi)}}}function Zs(F,Me){const Ae=Math.pow(2,Me.tileID.overscaledZ),Oe=Me.tileSize*Math.pow(2,F.transform.tileZoom)/Ae,Fe=Oe*(Me.tileID.canonical.x+Me.tileID.wrap*Ae),je=Oe*Me.tileID.canonical.y;return{u_image:0,u_texsize:Me.imageAtlasTexture?Me.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/k.ar(Me,1,F.transform.tileZoom),u_pixel_coord_upper:[Fe>>16,je>>16],u_pixel_coord_lower:[65535&Fe,65535&je]}}const dd={terrain:0,flat:1},md=k.ab.mat4.create(),Xs=(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr)=>{const Jr=Me.style.light,Qr=Jr.properties.get("position"),co=[Qr.x,Qr.y,Qr.z],mo=k.ab.mat3.create();"viewport"===Jr.properties.get("anchor")&&(k.ab.mat3.fromRotation(mo,-Me.transform.angle),k.ab.vec3.transformMat3(co,co,mo));const yo=Jr.properties.get("color"),To=Me.transform,zo={u_matrix:F,u_lightpos:co,u_lightintensity:Jr.properties.get("intensity"),u_lightcolor:[yo.r,yo.g,yo.b],u_vertical_gradient:+Ae,u_opacity:Oe,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:md,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:dd[Ut],u_base_type:dd[xi],u_ao:Fe,u_edge_radius:je,u_width_scale:qe,u_flood_light_color:Mi,u_vertical_scale:pr,u_flood_light_intensity:Ur,u_ground_shadow_factor:Wr};return"globe"===To.projection.name&&(zo.u_tile_id=[pt.canonical.x,pt.canonical.y,1<<pt.canonical.z],zo.u_zoom_transition=vi,zo.u_inv_rot_matrix=wi,zo.u_merc_center=bi,zo.u_up_dir=To.projection.upVector(new k.bT(0,0,0),bi[0]*k.ag,bi[1]*k.ag),zo.u_height_lift=vt),zo},Ks=(k,F,Me,Ae,Oe,Fe)=>({u_matrix:k,u_edge_radius:F,u_width_scale:Me,u_vertical_scale:Ae,u_height_type:dd[Oe],u_base_type:dd[Fe]}),Ys=(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur)=>{const Wr=Xs(F,Me,Ae,Oe,Fe,je,qe,pt,Ut,xi,vi,bi,wi,Mi,pr,Ur,1,[0,0,0]),Jr={u_height_factor:-Math.pow(2,pt.overscaledZ)/vt.tileSize/8};return k.l(Wr,Zs(Me,vt),Jr)},Js=(k,F)=>({u_matrix:k,u_emissive_strength:F}),Qs=(F,Me,Ae,Oe)=>k.l(Js(F,Me),Zs(Ae,Oe)),er=(k,F,Me)=>({u_matrix:k,u_world:Me,u_emissive_strength:F}),tr=(F,Me,Ae,Oe,Fe)=>k.l(Qs(F,Me,Ae,Oe),{u_world:Fe}),ir=(F,Me,Ae,Oe)=>{const Fe=k.ag/Ae.tileSize;return{u_matrix:F,u_camera_to_center_distance:Me.getCameraToCenterDistance(Oe),u_extrude_scale:[Me.pixelsToGLUnits[0]/Fe,Me.pixelsToGLUnits[1]/Fe]}},or=(k,F,Me=1)=>({u_matrix:k,u_color:F.toRenderColor(null),u_overlay:0,u_overlay_scale:Me}),Td=k.ab.mat4.create(),rr=(F,Me,Ae,Oe,Fe,je,qe)=>{const pt=F.transform,vt="globe"===pt.projection.name,Ut=vt?k.cN(pt.zoom,Me.canonical)*pt._pixelsPerMercatorPixel:k.ar(Ae,1,je),xi={u_matrix:Me.projMatrix,u_extrude_scale:Ut,u_intensity:qe,u_inv_rot_matrix:Td,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(vt){xi.u_inv_rot_matrix=Oe,xi.u_merc_center=Fe,xi.u_tile_id=[Me.canonical.x,Me.canonical.y,1<<Me.canonical.z],xi.u_zoom_transition=k.ae(pt.zoom);const F=Fe[0]*k.ag,Ae=Fe[1]*k.ag;xi.u_up_dir=pt.projection.upVector(new k.bT(0,0,0),F,Ae)}return xi};function ar(k,[F,Me,Ae,Oe],[Fe,je]){if(Fe===je)return[0,0,0,0];const qe=255*(k-1)/(k*(je-Fe));return[F*qe,Me*qe,Ae*qe,Oe*qe]}function nr(k,F,[Me,Ae]){return Me===Ae?0:.5/k+(F-Me)*(k-1)/(k*(Ae-Me))}const lr=(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co)=>({u_matrix:F,u_normalize_matrix:Me,u_globe_matrix:Ae,u_merc_matrix:Oe,u_grid_matrix:Fe,u_tl_parent:je,u_scale_parent:Ut,u_fade_t:xi.mix,u_opacity:xi.opacity*vi.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:vi.paint.get("raster-brightness-min"),u_brightness_high:vi.paint.get("raster-brightness-max"),u_saturation_factor:k.cO(vi.paint.get("raster-saturation")),u_contrast_factor:k.cP(vi.paint.get("raster-contrast")),u_spin_weights:cr(vi.paint.get("raster-hue-rotate")),u_perspective_transform:bi,u_raster_elevation:wi,u_zoom_transition:qe,u_merc_center:pt,u_cutoff_params:vt,u_colorization_mix:ar(k.cQ,pr,Wr),u_colorization_offset:nr(k.cQ,Ur,Wr),u_color_ramp:Mi,u_texture_offset:[Qr/(Jr+2*Qr),Jr/(Jr+2*Qr)],u_texture_res:[Jr+2*Qr,Jr+2*Qr],u_emissive_strength:co});function cr(k){k*=Math.PI/180;const F=Math.sin(k),Me=Math.cos(k);return[(2*Me+1)/3,(-Math.sqrt(3)*F-Me+1)/3,(Math.sqrt(3)*F-Me+1)/3]}const Ed=.05,ur=(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi)=>({u_matrix:k,u_normalize_matrix:F,u_globe_matrix:Me,u_merc_matrix:Ae,u_grid_matrix:Oe,u_tl_parent:Fe,u_scale_parent:vt,u_fade_t:Ut.mix,u_opacity:Ut.opacity,u_image0:0,u_image1:1,u_raster_elevation:xi,u_zoom_transition:je,u_merc_center:qe,u_cutoff_params:pt}),dr=(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt)=>({u_particle_texture:k,u_particle_texture_side_len:F,u_tile_offset:Me,u_velocity:Ae,u_color_ramp:Fe,u_velocity_res:Oe,u_max_speed:je,u_uv_offset:qe,u_data_scale:[255*pt[0],255*pt[1]],u_data_offset:vt,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ed,Ed]}),_r=(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt)=>({u_particle_texture:k,u_particle_texture_side_len:F,u_velocity:Me,u_velocity_res:Ae,u_max_speed:Oe,u_speed_factor:Fe,u_reset_rate:je,u_rand_seed:Math.random(),u_uv_offset:qe,u_data_scale:[255*pt[0],255*pt[1]],u_data_offset:vt,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ed,Ed]}),Ad=k.ab.mat4.create(),fr=(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr,Qr,co,mo)=>{const yo=Fe.transform,To={u_is_size_zoom_constant:+("constant"===F||"source"===F),u_is_size_feature_constant:+("constant"===F||"camera"===F),u_size_t:Me?Me.uSizeT:0,u_size:Me?Me.uSize:0,u_camera_to_center_distance:yo.getCameraToCenterDistance(Jr),u_rotate_symbol:+Ae,u_aspect_ratio:yo.width/yo.height,u_fade_change:Fe.options.fadeDuration?Fe.symbolFadeChange:1,u_matrix:je,u_label_plane_matrix:qe,u_coord_matrix:pt,u_is_text:+Ut,u_elevation_from_sea:vt?1:0,u_pitch_with_map:+Oe,u_texsize:xi,u_texsize_icon:vi,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Ad,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Ad,u_up_vector:[0,-1,0],u_color_adj_mat:Qr,u_icon_transition:co||0,u_gamma_scale:Oe?Fe.transform.getCameraToCenterDistance(Jr)*Math.cos(Fe.terrain?0:Fe.transform._pitch):1,u_device_pixel_ratio:k.q.devicePixelRatio,u_is_halo:+bi,u_scale_factor:mo||1};return"globe"===Jr.name&&(To.u_tile_id=[wi.canonical.x,wi.canonical.y,1<<wi.canonical.z],To.u_zoom_transition=Mi,To.u_inv_rot_matrix=Ur,To.u_merc_center=pr,To.u_camera_forward=yo._camera.forward(),To.u_ecef_origin=k.cR(yo.globeMatrix,wi.toUnwrapped()),To.u_tile_matrix=Float32Array.from(yo.globeMatrix),To.u_up_vector=Wr),To},mr=(k,F,Me,Ae)=>({u_matrix:k,u_emissive_strength:F,u_opacity:Me,u_color:Ae}),gr=(F,Me,Ae,Oe,Fe,je,qe,pt,vt)=>k.l(function(F,Me,Ae,Oe,Fe,je){const{width:qe,height:pt}=Oe.imageManager.getPixelSize(Me),vt=Math.pow(2,je.tileID.overscaledZ),Ut=je.tileSize*Math.pow(2,Oe.transform.tileZoom)/vt,xi=Ut*(je.tileID.canonical.x+je.tileID.wrap*vt),vi=Ut*je.tileID.canonical.y;return{u_image:0,u_pattern_tl:Ae.tl,u_pattern_br:Ae.br,u_texsize:[qe,pt],u_pattern_size:Ae.displaySize,u_pattern_units_to_pixels:Fe?[Oe.transform.width,-1*Oe.transform.height]:[1/k.ar(je,1,Oe.transform.tileZoom),1/k.ar(je,1,Oe.transform.tileZoom)],u_pixel_coord_upper:[xi>>16,vi>>16],u_pixel_coord_lower:[65535&xi,65535&vi]}}(0,je,qe,Oe,pt,vt),{u_matrix:F,u_emissive_strength:Me,u_opacity:Ae}),Cd=new Float32Array(k.ab.mat4.identity([])),yr=(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi=[0,0,0],Mi)=>{const pr=Fe.style.light,Ur=pr.properties.get("position"),Wr=[-Ur.x,-Ur.y,Ur.z],Jr=k.ab.mat3.create();"viewport"===pr.properties.get("anchor")&&(k.ab.mat3.fromRotation(Jr,-Fe.transform.angle),k.ab.vec3.transformMat3(Wr,Wr,Jr));const Qr="MASK"===xi.alphaMode,co=pr.properties.get("color").toRenderColor(null),mo=bi.paint.get("model-ambient-occlusion-intensity"),yo=bi.paint.get("model-color").constantOr(k.aj.white).toRenderColor(null),To=bi.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:F,u_lighting_matrix:Me,u_normal_matrix:Ae,u_node_matrix:Oe||Cd,u_lightpos:Wr,u_lightintensity:pr.properties.get("intensity"),u_lightcolor:[co.r,co.g,co.b],u_camera_pos:wi,u_opacity:je,u_baseTextureIsAlpha:0,u_alphaMask:+Qr,u_alphaCutoff:xi.alphaCutoff,u_baseColorFactor:[qe.r,qe.g,qe.b,qe.a],u_emissiveFactor:[pt[0],pt[1],pt[2],1],u_metallicFactor:vt,u_roughnessFactor:Ut,u_baseColorTexture:uh.BaseColor,u_metallicRoughnessTexture:uh.MetallicRoughness,u_normalTexture:uh.Normal,u_occlusionTexture:uh.Occlusion,u_emissionTexture:uh.Emission,u_lutTexture:uh.LUT,u_color_mix:[yo.r,yo.g,yo.b,To],u_aoIntensity:mo,u_emissive_strength:vi,u_occlusionTextureTransform:Mi||[0,0,0,0]}},xr=(k,F=Cd,Me=Cd)=>({u_matrix:k,u_instance:F,u_node_matrix:Me}),zd={fillExtrusion:F=>({u_matrix:new k.bJ(F),u_lightpos:new k.bL(F),u_lightintensity:new k.bM(F),u_lightcolor:new k.bL(F),u_vertical_gradient:new k.bM(F),u_opacity:new k.bM(F),u_edge_radius:new k.bM(F),u_width_scale:new k.bM(F),u_ao:new k.bK(F),u_height_type:new k.bN(F),u_base_type:new k.bN(F),u_tile_id:new k.bL(F),u_zoom_transition:new k.bM(F),u_inv_rot_matrix:new k.bJ(F),u_merc_center:new k.bK(F),u_up_dir:new k.bL(F),u_height_lift:new k.bM(F),u_flood_light_color:new k.bL(F),u_vertical_scale:new k.bM(F),u_flood_light_intensity:new k.bM(F),u_ground_shadow_factor:new k.bL(F)}),fillExtrusionDepth:F=>({u_matrix:new k.bJ(F),u_edge_radius:new k.bM(F),u_width_scale:new k.bM(F),u_vertical_scale:new k.bM(F),u_height_type:new k.bN(F),u_base_type:new k.bN(F)}),fillExtrusionPattern:F=>({u_matrix:new k.bJ(F),u_lightpos:new k.bL(F),u_lightintensity:new k.bM(F),u_lightcolor:new k.bL(F),u_vertical_gradient:new k.bM(F),u_height_factor:new k.bM(F),u_edge_radius:new k.bM(F),u_width_scale:new k.bM(F),u_ao:new k.bK(F),u_height_type:new k.bN(F),u_base_type:new k.bN(F),u_tile_id:new k.bL(F),u_zoom_transition:new k.bM(F),u_inv_rot_matrix:new k.bJ(F),u_merc_center:new k.bK(F),u_up_dir:new k.bL(F),u_height_lift:new k.bM(F),u_image:new k.bN(F),u_texsize:new k.bK(F),u_pixel_coord_upper:new k.bK(F),u_pixel_coord_lower:new k.bK(F),u_tile_units_to_pixels:new k.bM(F),u_opacity:new k.bM(F)}),fillExtrusionGroundEffect:F=>({u_matrix:new k.bJ(F),u_opacity:new k.bM(F),u_ao_pass:new k.bM(F),u_meter_to_tile:new k.bM(F),u_ao:new k.bK(F),u_flood_light_intensity:new k.bM(F),u_flood_light_color:new k.bL(F),u_attenuation:new k.bM(F),u_edge_radius:new k.bM(F),u_fb:new k.bN(F),u_fb_size:new k.bM(F),u_dynamic_offset:new k.bM(F)}),fill:F=>({u_matrix:new k.bJ(F),u_emissive_strength:new k.bM(F)}),fillPattern:F=>({u_matrix:new k.bJ(F),u_emissive_strength:new k.bM(F),u_image:new k.bN(F),u_texsize:new k.bK(F),u_pixel_coord_upper:new k.bK(F),u_pixel_coord_lower:new k.bK(F),u_tile_units_to_pixels:new k.bM(F)}),fillOutline:F=>({u_matrix:new k.bJ(F),u_emissive_strength:new k.bM(F),u_world:new k.bK(F)}),fillOutlinePattern:F=>({u_matrix:new k.bJ(F),u_emissive_strength:new k.bM(F),u_world:new k.bK(F),u_image:new k.bN(F),u_texsize:new k.bK(F),u_pixel_coord_upper:new k.bK(F),u_pixel_coord_lower:new k.bK(F),u_tile_units_to_pixels:new k.bM(F)}),circle:k.cS,collisionBox:F=>({u_matrix:new k.bJ(F),u_camera_to_center_distance:new k.bM(F),u_extrude_scale:new k.bK(F)}),collisionCircle:F=>({u_matrix:new k.bJ(F),u_inv_matrix:new k.bJ(F),u_camera_to_center_distance:new k.bM(F),u_viewport_size:new k.bK(F)}),debug:F=>({u_color:new k.cz(F),u_matrix:new k.bJ(F),u_overlay:new k.bN(F),u_overlay_scale:new k.bM(F)}),clippingMask:F=>({u_matrix:new k.bJ(F)}),heatmap:F=>({u_extrude_scale:new k.bM(F),u_intensity:new k.bM(F),u_matrix:new k.bJ(F),u_inv_rot_matrix:new k.bJ(F),u_merc_center:new k.bK(F),u_tile_id:new k.bL(F),u_zoom_transition:new k.bM(F),u_up_dir:new k.bL(F)}),heatmapTexture:F=>({u_image:new k.bN(F),u_color_ramp:new k.bN(F),u_opacity:new k.bM(F)}),hillshade:F=>({u_matrix:new k.bJ(F),u_image:new k.bN(F),u_latrange:new k.bK(F),u_light:new k.bK(F),u_shadow:new k.cz(F),u_highlight:new k.cz(F),u_emissive_strength:new k.bM(F),u_accent:new k.cz(F)}),hillshadePrepare:F=>({u_matrix:new k.bJ(F),u_image:new k.bN(F),u_dimension:new k.bK(F),u_zoom:new k.bM(F)}),line:k.cT,linePattern:k.cU,raster:F=>({u_matrix:new k.bJ(F),u_normalize_matrix:new k.bJ(F),u_globe_matrix:new k.bJ(F),u_merc_matrix:new k.bJ(F),u_grid_matrix:new k.cA(F),u_tl_parent:new k.bK(F),u_scale_parent:new k.bM(F),u_fade_t:new k.bM(F),u_opacity:new k.bM(F),u_image0:new k.bN(F),u_image1:new k.bN(F),u_brightness_low:new k.bM(F),u_brightness_high:new k.bM(F),u_saturation_factor:new k.bM(F),u_contrast_factor:new k.bM(F),u_spin_weights:new k.bL(F),u_perspective_transform:new k.bK(F),u_raster_elevation:new k.bM(F),u_zoom_transition:new k.bM(F),u_merc_center:new k.bK(F),u_cutoff_params:new k.ca(F),u_colorization_mix:new k.ca(F),u_colorization_offset:new k.bM(F),u_color_ramp:new k.bN(F),u_texture_offset:new k.bK(F),u_texture_res:new k.bK(F),u_emissive_strength:new k.bM(F)}),rasterParticle:F=>({u_matrix:new k.bJ(F),u_normalize_matrix:new k.bJ(F),u_globe_matrix:new k.bJ(F),u_merc_matrix:new k.bJ(F),u_grid_matrix:new k.cA(F),u_tl_parent:new k.bK(F),u_scale_parent:new k.bM(F),u_fade_t:new k.bM(F),u_opacity:new k.bM(F),u_image0:new k.bN(F),u_image1:new k.bN(F),u_raster_elevation:new k.bM(F),u_zoom_transition:new k.bM(F),u_merc_center:new k.bK(F),u_cutoff_params:new k.ca(F)}),rasterParticleTexture:F=>({u_texture:new k.bN(F),u_opacity:new k.bM(F)}),rasterParticleDraw:F=>({u_particle_texture:new k.bN(F),u_particle_texture_side_len:new k.bM(F),u_tile_offset:new k.bK(F),u_velocity:new k.bN(F),u_color_ramp:new k.bN(F),u_velocity_res:new k.bK(F),u_max_speed:new k.bM(F),u_uv_offset:new k.bK(F),u_data_scale:new k.bK(F),u_data_offset:new k.bM(F),u_particle_pos_scale:new k.bM(F),u_particle_pos_offset:new k.bK(F)}),rasterParticleUpdate:F=>({u_particle_texture:new k.bN(F),u_particle_texture_side_len:new k.bM(F),u_velocity:new k.bN(F),u_velocity_res:new k.bK(F),u_max_speed:new k.bM(F),u_speed_factor:new k.bM(F),u_reset_rate:new k.bM(F),u_rand_seed:new k.bM(F),u_uv_offset:new k.bK(F),u_data_scale:new k.bK(F),u_data_offset:new k.bM(F),u_particle_pos_scale:new k.bM(F),u_particle_pos_offset:new k.bK(F)}),symbol:F=>({u_is_size_zoom_constant:new k.bN(F),u_is_size_feature_constant:new k.bN(F),u_size_t:new k.bM(F),u_size:new k.bM(F),u_camera_to_center_distance:new k.bM(F),u_rotate_symbol:new k.bN(F),u_aspect_ratio:new k.bM(F),u_fade_change:new k.bM(F),u_matrix:new k.bJ(F),u_label_plane_matrix:new k.bJ(F),u_coord_matrix:new k.bJ(F),u_is_text:new k.bN(F),u_elevation_from_sea:new k.bN(F),u_pitch_with_map:new k.bN(F),u_texsize:new k.bK(F),u_texsize_icon:new k.bK(F),u_texture:new k.bN(F),u_texture_icon:new k.bN(F),u_gamma_scale:new k.bM(F),u_device_pixel_ratio:new k.bM(F),u_tile_id:new k.bL(F),u_zoom_transition:new k.bM(F),u_inv_rot_matrix:new k.bJ(F),u_merc_center:new k.bK(F),u_camera_forward:new k.bL(F),u_tile_matrix:new k.bJ(F),u_up_vector:new k.bL(F),u_ecef_origin:new k.bL(F),u_is_halo:new k.bN(F),u_icon_transition:new k.bM(F),u_color_adj_mat:new k.bJ(F),u_scale_factor:new k.bM(F)}),background:F=>({u_matrix:new k.bJ(F),u_emissive_strength:new k.bM(F),u_opacity:new k.bM(F),u_color:new k.cz(F)}),backgroundPattern:F=>({u_matrix:new k.bJ(F),u_emissive_strength:new k.bM(F),u_opacity:new k.bM(F),u_image:new k.bN(F),u_pattern_tl:new k.bK(F),u_pattern_br:new k.bK(F),u_texsize:new k.bK(F),u_pattern_size:new k.bK(F),u_pixel_coord_upper:new k.bK(F),u_pixel_coord_lower:new k.bK(F),u_pattern_units_to_pixels:new k.bK(F)}),terrainRaster:F=>({u_matrix:new k.bJ(F),u_image0:new k.bN(F),u_skirt_height:new k.bM(F),u_ground_shadow_factor:new k.bL(F)}),skybox:F=>({u_matrix:new k.bJ(F),u_sun_direction:new k.bL(F),u_cubemap:new k.bN(F),u_opacity:new k.bM(F),u_temporal_offset:new k.bM(F)}),skyboxGradient:F=>({u_matrix:new k.bJ(F),u_color_ramp:new k.bN(F),u_center_direction:new k.bL(F),u_radius:new k.bM(F),u_opacity:new k.bM(F),u_temporal_offset:new k.bM(F)}),skyboxCapture:F=>({u_matrix_3f:new k.cA(F),u_sun_direction:new k.bL(F),u_sun_intensity:new k.bM(F),u_color_tint_r:new k.ca(F),u_color_tint_m:new k.ca(F),u_luminance:new k.bM(F)}),globeRaster:F=>({u_proj_matrix:new k.bJ(F),u_globe_matrix:new k.bJ(F),u_normalize_matrix:new k.bJ(F),u_merc_matrix:new k.bJ(F),u_zoom_transition:new k.bM(F),u_merc_center:new k.bK(F),u_image0:new k.bN(F),u_grid_matrix:new k.cA(F),u_skirt_height:new k.bM(F),u_far_z_cutoff:new k.bM(F),u_frustum_tl:new k.bL(F),u_frustum_tr:new k.bL(F),u_frustum_br:new k.bL(F),u_frustum_bl:new k.bL(F),u_globe_pos:new k.bL(F),u_globe_radius:new k.bM(F),u_viewport:new k.bK(F)}),globeAtmosphere:F=>({u_frustum_tl:new k.bL(F),u_frustum_tr:new k.bL(F),u_frustum_br:new k.bL(F),u_frustum_bl:new k.bL(F),u_horizon:new k.bM(F),u_transition:new k.bM(F),u_fadeout_range:new k.bM(F),u_color:new k.ca(F),u_high_color:new k.ca(F),u_space_color:new k.ca(F),u_temporal_offset:new k.bM(F),u_horizon_angle:new k.bM(F)}),model:F=>({u_matrix:new k.bJ(F),u_lighting_matrix:new k.bJ(F),u_normal_matrix:new k.bJ(F),u_node_matrix:new k.bJ(F),u_lightpos:new k.bL(F),u_lightintensity:new k.bM(F),u_lightcolor:new k.bL(F),u_camera_pos:new k.bL(F),u_opacity:new k.bM(F),u_baseColorFactor:new k.ca(F),u_emissiveFactor:new k.ca(F),u_metallicFactor:new k.bM(F),u_roughnessFactor:new k.bM(F),u_baseTextureIsAlpha:new k.bN(F),u_alphaMask:new k.bN(F),u_alphaCutoff:new k.bM(F),u_baseColorTexture:new k.bN(F),u_metallicRoughnessTexture:new k.bN(F),u_normalTexture:new k.bN(F),u_occlusionTexture:new k.bN(F),u_emissionTexture:new k.bN(F),u_lutTexture:new k.bN(F),u_color_mix:new k.ca(F),u_aoIntensity:new k.bM(F),u_emissive_strength:new k.bM(F),u_occlusionTextureTransform:new k.ca(F)}),modelDepth:F=>({u_matrix:new k.bJ(F),u_instance:new k.bJ(F),u_node_matrix:new k.bJ(F)}),groundShadow:F=>({u_matrix:new k.bJ(F),u_ground_shadow_factor:new k.bL(F)}),stars:F=>({u_matrix:new k.bJ(F),u_up:new k.bL(F),u_right:new k.bL(F),u_intensity_multiplier:new k.bM(F)}),snowParticle:F=>({u_modelview:new k.bJ(F),u_projection:new k.bJ(F),u_time:new k.bM(F),u_cam_pos:new k.bL(F),u_velocityConeAperture:new k.bM(F),u_velocity:new k.bM(F),u_horizontalOscillationRadius:new k.bM(F),u_horizontalOscillationRate:new k.bM(F),u_boxSize:new k.bM(F),u_billboardSize:new k.bM(F),u_simpleShapeParameters:new k.bK(F),u_screenSize:new k.bK(F),u_thinningCenterPos:new k.bK(F),u_thinningShape:new k.bL(F),u_thinningAffectedRatio:new k.bM(F),u_thinningParticleOffset:new k.bM(F),u_particleColor:new k.ca(F),u_direction:new k.bL(F)}),rainParticle:F=>({u_modelview:new k.bJ(F),u_projection:new k.bJ(F),u_time:new k.bM(F),u_cam_pos:new k.bL(F),u_texScreen:new k.bN(F),u_velocityConeAperture:new k.bM(F),u_velocity:new k.bM(F),u_boxSize:new k.bM(F),u_rainDropletSize:new k.bK(F),u_distortionStrength:new k.bM(F),u_rainDirection:new k.bL(F),u_color:new k.ca(F),u_screenSize:new k.bK(F),u_thinningCenterPos:new k.bK(F),u_thinningShape:new k.bL(F),u_thinningAffectedRatio:new k.bM(F),u_thinningParticleOffset:new k.bM(F),u_shapeDirectionalPower:new k.bM(F),u_shapeNormalPower:new k.bM(F),u_mode:new k.bM(F)}),vignette:F=>({u_vignetteShape:new k.bL(F),u_vignetteColor:new k.ca(F)}),occlusion:F=>({u_matrix:new k.bJ(F),u_anchorPos:new k.bL(F),u_screenSizePx:new k.bK(F),u_occluderSizePx:new k.bK(F),u_color:new k.ca(F)})};class wr{constructor(k,F,Me,Ae){this.id=wr.uniqueIdxCounter,wr.uniqueIdxCounter++,this.context=k;const Oe=k.gl;this.buffer=Oe.createBuffer(),this.dynamicDraw=Boolean(Me),this.context.unbindVAO(),k.bindElementBuffer.set(this.buffer),Oe.bufferData(Oe.ELEMENT_ARRAY_BUFFER,F.arrayBuffer,this.dynamicDraw?Oe.DYNAMIC_DRAW:Oe.STATIC_DRAW),this.dynamicDraw||Ae||F.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(k){this.id=wr.uniqueIdxCounter,wr.uniqueIdxCounter++;const F=this.context.gl;this.context.unbindVAO(),this.bind(),F.bufferSubData(F.ELEMENT_ARRAY_BUFFER,0,k.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}wr.uniqueIdxCounter=0;const Pd={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Er{constructor(k,F,Me,Ae,Oe,Fe){this.length=F.length,this.attributes=Me,this.itemSize=F.bytesPerElement,this.dynamicDraw=Ae,this.instanceCount=Fe,this.context=k;const je=k.gl;this.buffer=je.createBuffer(),k.bindVertexBuffer.set(this.buffer),je.bufferData(je.ARRAY_BUFFER,F.arrayBuffer,this.dynamicDraw?je.DYNAMIC_DRAW:je.STATIC_DRAW),this.dynamicDraw||Oe||F.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(k){const F=this.context.gl;this.bind(),F.bufferSubData(F.ARRAY_BUFFER,0,k.arrayBuffer)}enableAttributes(k,F){for(let Me=0;Me<this.attributes.length;Me++){const Ae=F.attributes[this.attributes[Me].name];void 0!==Ae&&k.enableVertexAttribArray(Ae)}}setVertexAttribPointers(k,F,Me){for(let Ae=0;Ae<this.attributes.length;Ae++){const Oe=this.attributes[Ae],Fe=F.attributes[Oe.name];void 0!==Fe&&k.vertexAttribPointer(Fe,Oe.components,k[Pd[Oe.type]],!1,this.itemSize,Oe.offset+this.itemSize*(Me||0))}}setVertexAttribDivisor(k,F,Me){for(let Ae=0;Ae<this.attributes.length;Ae++){const Oe=F.attributes[this.attributes[Ae].name];void 0!==Oe&&this.instanceCount&&this.instanceCount>0&&k.vertexAttribDivisor(Oe,Me)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Sr{constructor(k,F,Me,Ae,Oe){this.context=k,this.width=F,this.height=Me;const Fe=this.framebuffer=k.gl.createFramebuffer();Ae&&(this.colorAttachment=new Ss(k,Fe)),Oe&&(this.depthAttachmentType=Oe,this.depthAttachment="renderbuffer"===Oe?new Cs(k,Fe):new Is(k,Fe))}destroy(){const k=this.context.gl;if(this.colorAttachment){const F=this.colorAttachment.get();F&&k.deleteTexture(F)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const F=this.depthAttachment.get();F&&k.deleteRenderbuffer(F)}else{const F=this.depthAttachment.get();F&&k.deleteTexture(F)}k.deleteFramebuffer(this.framebuffer)}}class Cr{constructor(k,F){this.gl=k,this.clearColor=new Wo(this),this.clearDepth=new $o(this),this.clearStencil=new Xo(this),this.colorMask=new Ko(this),this.depthMask=new Yo(this),this.stencilMask=new Jo(this),this.stencilFunc=new Qo(this),this.stencilOp=new es(this),this.stencilTest=new ts(this),this.depthRange=new is(this),this.depthTest=new os(this),this.depthFunc=new ss(this),this.blend=new rs(this),this.blendFunc=new as(this),this.blendColor=new ns(this),this.blendEquation=new ls(this),this.cullFace=new cs(this),this.cullFaceSide=new hs(this),this.frontFace=new us(this),this.program=new $u(this),this.activeTexture=new _s(this),this.viewport=new ps(this),this.bindFramebuffer=new fs(this),this.bindRenderbuffer=new ms(this),this.bindTexture=new gs(this),this.bindVertexBuffer=new vs(this),this.bindElementBuffer=new ys(this),this.bindVertexArrayOES=new xs(this),this.pixelStoreUnpack=new bs(this),this.pixelStoreUnpackPremultiplyAlpha=new ws(this),this.pixelStoreUnpackFlipY=new Ts(this),this.options=F?{...F}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=k.getExtension("EXT_texture_filter_anisotropic")||k.getExtension("MOZ_EXT_texture_filter_anisotropic")||k.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=k.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=k.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=k.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=k.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=F&&!!F.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=k.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=k.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=k.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=k.getParameter(k.MAX_TEXTURE_SIZE),this.maxPointSize=k.getParameter(k.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(k,F,Me){return new wr(this,k,F,Me)}createVertexBuffer(k,F,Me,Ae,Oe){return new Er(this,k,F,Me,Ae,Oe)}createRenderbuffer(k,F,Me){const Ae=this.gl,Oe=Ae.createRenderbuffer();return this.bindRenderbuffer.set(Oe),Ae.renderbufferStorage(Ae.RENDERBUFFER,k,F,Me),this.bindRenderbuffer.set(null),Oe}createFramebuffer(k,F,Me,Ae){return new Sr(this,k,F,Me,Ae)}clear({color:k,depth:F,stencil:Me,colorMask:Ae}){const Oe=this.gl;let Fe=0;k&&(Fe|=Oe.COLOR_BUFFER_BIT,this.clearColor.set(k),this.colorMask.set(Ae||[!0,!0,!0,!0])),void 0!==F&&(Fe|=Oe.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(F),this.depthMask.set(!0)),void 0!==Me&&(Fe|=Oe.STENCIL_BUFFER_BIT,this.clearStencil.set(Me),this.stencilMask.set(255)),Oe.clear(Fe)}setCullFace(k){!1===k.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(k.mode),this.frontFace.set(k.frontFace))}setDepthMode(k){k.func!==this.gl.ALWAYS||k.mask?(this.depthTest.set(!0),this.depthFunc.set(k.func),this.depthMask.set(k.mask),this.depthRange.set(k.range)):this.depthTest.set(!1)}setStencilMode(k){k.test.func!==this.gl.ALWAYS||k.mask?(this.stencilTest.set(!0),this.stencilMask.set(k.mask),this.stencilOp.set([k.fail,k.depthFail,k.pass]),this.stencilFunc.set({func:k.test.func,ref:k.ref,mask:k.test.mask})):this.stencilTest.set(!1)}setColorMode(F){k.bn(F.blendFunction,Oi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(F.blendFunction),this.blendColor.set(F.blendColor),F.blendEquation?this.blendEquation.set(F.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(F.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let kd;function Rr(F,Me,Ae,Oe,Fe,je,qe){const pt=F.context,vt=pt.gl,Ut=F.transform,xi=F.getOrCreateProgram("collisionBox"),vi=[];let bi=0,wi=0;for(let pt=0;pt<Oe.length;pt++){const Mi=Oe[pt],pr=Me.getTile(Mi),Ur=pr.getBucket(Ae);if(!Ur)continue;const Wr=ai(Mi,Ur,Ut);let Jr=Wr;0===Fe[0]&&0===Fe[1]||(Jr=F.translatePosMatrix(Wr,pr,Fe,je));const Qr=qe?Ur.textCollisionBox:Ur.iconCollisionBox,co=Ur.collisionCircleArray;if(co.length>0){const F=k.ab.mat4.create(),Me=Jr;k.ab.mat4.mul(F,Ur.placementInvProjMatrix,Ut.glCoordMatrix),k.ab.mat4.mul(F,F,Ur.placementViewportMatrix),vi.push({circleArray:co,circleOffset:wi,transform:Me,invTransform:F,projection:Ur.getProjection()}),bi+=co.length/4,wi=bi}Qr&&(F.terrain&&F.terrain.setupElevationDraw(pr,xi),xi.draw(F,vt.LINES,Fi.disabled,Bi.disabled,F.colorModeForRenderPass(),Gi.disabled,ir(Jr,Ut,pr,Ur.getProjection()),Ae.id,Qr.layoutVertexBuffer,Qr.indexBuffer,Qr.segments,null,Ut.zoom,null,[Qr.collisionVertexBuffer,Qr.collisionVertexBufferExt]))}if(!qe||!vi.length)return;const Mi=F.getOrCreateProgram("collisionCircle"),pr=new k.cV;pr.resize(4*bi),pr._trim();let Ur=0;for(const k of vi)for(let F=0;F<k.circleArray.length/4;F++){const Me=4*F,Ae=k.circleArray[Me+0],Oe=k.circleArray[Me+1],Fe=k.circleArray[Me+2],je=k.circleArray[Me+3];pr.emplace(Ur++,Ae,Oe,Fe,je,0),pr.emplace(Ur++,Ae,Oe,Fe,je,1),pr.emplace(Ur++,Ae,Oe,Fe,je,2),pr.emplace(Ur++,Ae,Oe,Fe,je,3)}(!kd||kd.length<2*bi)&&(kd=function(F){const Me=2*F,Ae=new k.aU;Ae.resize(Me),Ae._trim();for(let k=0;k<Me;k++){const F=6*k;Ae.uint16[F+0]=4*k+0,Ae.uint16[F+1]=4*k+1,Ae.uint16[F+2]=4*k+2,Ae.uint16[F+3]=4*k+2,Ae.uint16[F+4]=4*k+3,Ae.uint16[F+5]=4*k+0}return Ae}(bi));const Wr=pt.createIndexBuffer(kd,!0),Jr=pt.createVertexBuffer(pr,k.cW.members,!0);for(const Me of vi){const Oe={u_matrix:Me.transform,u_inv_matrix:Me.invTransform,u_camera_to_center_distance:(Qr=Ut).getCameraToCenterDistance(Me.projection),u_viewport_size:[Qr.width,Qr.height]};Mi.draw(F,vt.TRIANGLES,Fi.disabled,Bi.disabled,F.colorModeForRenderPass(),Gi.disabled,Oe,Ae.id,Jr,Wr,k.b7.simpleSegment(0,2*Me.circleOffset,Me.circleArray.length,Me.circleArray.length/2),null,Ut.zoom)}var Qr;Jr.destroy(),Wr.destroy()}const Fd=k.ab.mat4.create();function Lr(F){const Me=F._camera.getWorldToCamera(F.worldSize,1),Ae=k.ab.mat4.multiply([],Me,F.globeMatrix);k.ab.mat4.invert(Ae,Ae);const Oe=[0,0,0],Fe=[0,1,0,0];return k.ab.vec4.transformMat4(Fe,Fe,Ae),Oe[0]=Fe[0],Oe[1]=Fe[1],Oe[2]=Fe[2],k.ab.vec3.normalize(Oe,Oe),Oe}function Ar({width:F,height:Me,anchor:Ae,textOffset:Oe,textScale:Fe},je){const{horizontalAlign:qe,verticalAlign:pt}=k.bD(Ae),vt=-(qe-.5)*F,Ut=-(pt-.5)*Me,xi=k.bC(Ae,Oe);return new k.P((vt/Fe+xi[0])*je,(Ut/Fe+xi[1])*je)}function zr(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi){const vi=F.text.placedSymbolArray,bi=F.text.dynamicLayoutVertexArray,wi=F.icon.dynamicLayoutVertexArray,Mi={},pr=F.getProjection(),Ur=ni(pt,pr,je),Wr=je.elevation,Jr=pr.upVectorScale(pt.canonical,je.center.lat,je.worldSize).metersToTile;bi.clear();for(let wi=0;wi<vi.length;wi++){const Qr=vi.get(wi),{tileAnchorX:co,tileAnchorY:mo,numGlyphs:yo}=Qr,To=Qr.hidden||!Qr.crossTileID||F.allowVerticalPlacement&&!Qr.placedOrientation?null:Oe[Qr.crossTileID];if(To){let Oe=0,vi=0,wi=0;if(Wr){const k=Wr?Wr.getAtTileOffset(pt,co,mo):0,[F,Me,Ae]=pr.upVector(pt.canonical,co,mo);Oe=k*F*Jr,vi=k*Me*Jr,wi=k*Ae*Jr}let[zo,ko,na,aa]=Ht(Qr.projectedAnchorX+Oe,Qr.projectedAnchorY+vi,Qr.projectedAnchorZ+wi,Ae?Ur:qe);const _a=Zt(je.getCameraToCenterDistance(pr),aa);let wa=Fe.evaluateSizeForFeature(F.textSizeData,Ut,Qr)*_a/k.bw;Ae&&(wa*=F.tilePixelRatio/vt);const Sa=Ar(To,wa);Ae?(({x:zo,y:ko,z:na}=pr.projectTilePoint(co+Sa.x,mo+Sa.y,pt.canonical)),[zo,ko,na]=Ht(zo+Oe,ko+vi,na+wi,qe)):(Me&&Sa._rotate(-je.angle),zo+=Sa.x,ko+=Sa.y,na=0);const Ya=F.allowVerticalPlacement&&Qr.placedOrientation===k.bq.vertical?Math.PI/2:0;for(let F=0;F<yo;F++)k.bt(bi,zo,ko,na,Ya);xi&&Qr.associatedIconIndex>=0&&(Mi[Qr.associatedIconIndex]={x:zo,y:ko,z:na,angle:Ya})}else ti(yo,bi)}if(xi){wi.clear();const Me=F.icon.placedSymbolArray;for(let F=0;F<Me.length;F++){const Ae=Me.get(F),{numGlyphs:Oe}=Ae,Fe=Mi[F];if(Ae.hidden||!Fe)ti(Oe,wi);else{const{x:F,y:Me,z:Ae,angle:je}=Fe;for(let Fe=0;Fe<Oe;Fe++)k.bt(wi,F,Me,Ae,je)}}F.icon.dynamicLayoutVertexBuffer.updateData(wi)}F.text.dynamicLayoutVertexBuffer.updateData(bi)}function Pr(F,Me,Ae,Oe,Fe,je,qe={}){const pt=Ae.paint.get("icon-translate"),vt=Ae.paint.get("text-translate"),Ut=Ae.paint.get("icon-translate-anchor"),xi=Ae.paint.get("text-translate-anchor"),vi=Ae.layout.get("icon-rotation-alignment"),bi=Ae.layout.get("text-rotation-alignment"),wi=Ae.layout.get("icon-pitch-alignment"),Mi=Ae.layout.get("text-pitch-alignment"),pr=Ae.layout.get("icon-keep-upright"),Ur=Ae.layout.get("text-keep-upright"),Wr=Ae.paint.get("icon-color-saturation"),Jr=Ae.paint.get("icon-color-contrast"),Qr=Ae.paint.get("icon-color-brightness-min"),co=Ae.paint.get("icon-color-brightness-max"),mo="sea"===Ae.layout.get("symbol-elevation-reference"),yo=F.context,To=yo.gl,zo=F.transform,ko="map"===vi,na="map"===bi,aa="map"===wi,_a="map"===Mi,wa=void 0!==Ae.layout.get("symbol-sort-key").constantOr(1);let Sa=!1;const Ya=F.depthModeForSublayer(0,Fi.ReadOnly),rl=[k.at(zo.center.lng),k.aA(zo.center.lat)],sl=Ae.layout.get("text-variable-anchor"),ml="globe"===zo.projection.name,Sl=[],Il=[0,-1,0];for(const Fe of Oe){const Oe=Me.getTile(Fe),je=Oe.getBucket(Ae);if(!je)continue;if("mercator"===je.projection.name&&ml)continue;if(je.fullyClipped)continue;const vi="globe"===je.projection.name,bi=vi?k.ae(zo.zoom):0,wi=ni(Fe,je.getProjection(),zo),Mi=zo.calculatePixelsToTileUnitsMatrix(Oe),yo=sl&&je.hasTextData(),Ya=je.hasIconTextFit()&&yo&&je.hasIconData(),Kl=je.getProjection().createInversionMatrix(zo,Fe.canonical),N=k=>{zo.depthOcclusionForSymbolsAndCircles&&(Ae.hasInitialOcclusionOpacityProperties||F.terrain)&&(k.push("DEPTH_D24"),k.push("DEPTH_OCCLUSION"))},U=()=>{const Me=ko&&"point"!==Ae.layout.get("symbol-placement"),qe=[];N(qe);const vt=Me||Ya,xi=Ae.paint.get("icon-image-cross-fade").constantOr(0);F.terrainRenderModeElevated()&&aa&&qe.push("PITCH_WITH_MAP_TERRAIN"),vi&&(qe.push("PROJECTION_GLOBE_VIEW"),vt&&qe.push("PROJECTED_POS_ON_VIEWPORT")),xi>0&&qe.push("ICON_TRANSITION"),je.icon.zOffsetVertexBuffer&&qe.push("Z_OFFSET"),0===Wr&&0===Jr&&0===Qr&&1===co||qe.push("COLOR_ADJUSTMENT"),je.sdfIcons&&qe.push("RENDER_SDF");const Ur=je.icon.programConfigurations.get(Ae.id),yo=F.getOrCreateProgram("symbol",{config:Ur,defines:qe}),na=Oe.imageAtlasTexture?Oe.imageAtlasTexture.size:[0,0],_a=je.iconSizeData,wa=k.bp(_a,zo.zoom),Sa=aa||0!==zo.pitch,sl=jt(wi,Oe.tileID.canonical,aa,ko,zo,je.getProjection(),Mi),Sl=qt(wi,Oe.tileID.canonical,aa,ko,zo,je.getProjection(),Mi),Jl=F.translatePosMatrix(Sl,Oe,pt,Ut,!0),Ql=F.translatePosMatrix(wi,Oe,pt,Ut),ec=vt?Fd:sl,tc=ko&&!aa&&!Me;let cc=Il;!ml&&!zo.mercatorFromTransition||ko||(cc=Lr(zo));const uc=vi?cc:Il,jc=Ae.getColorAdjustmentMatrix(Wr,Jr,Qr,co),Gc=fr(_a.kind,wa,tc,aa,F,Ql,ec,Jl,mo,!1,na,[0,0],!0,Fe,bi,rl,Kl,uc,je.getProjection(),jc,xi),qc=Oe.imageAtlasTexture?Oe.imageAtlasTexture:null,Hc=1!==Ae.layout.get("icon-size").constantOr(0)||je.iconsNeedLinear,$c=je.sdfIcons||F.options.rotating||F.options.zooming||Hc||Sa?To.LINEAR:To.NEAREST,Wc=je.sdfIcons&&0!==Ae.paint.get("icon-halo-width").constantOr(1),Kc=F.terrain&&aa&&Me?k.ab.mat4.invert(k.ab.mat4.create(),sl):Fd;if(Me&&je.icon){const k=zo.elevation,Me=k?k.getAtTileOffsetFunc(Fe,zo.center.lat,zo.worldSize,je.getProjection()):null,Ae=Vt(wi,Oe.tileID.canonical,aa,ko,zo,je.getProjection(),Mi);$t(je,wi,F,!1,Ae,Sl,aa,pr,Me,Fe)}return{program:yo,buffers:je.icon,uniformValues:Gc,atlasTexture:qc,atlasTextureIcon:null,atlasInterpolation:$c,atlasInterpolationIcon:null,isSDF:je.sdfIcons,hasHalo:Wc,tile:Oe,labelPlaneMatrixInv:Kc}},G=()=>{const Me=na&&"point"!==Ae.layout.get("symbol-placement"),qe=[],pt=Me||sl||Ya;F.terrainRenderModeElevated()&&_a&&qe.push("PITCH_WITH_MAP_TERRAIN"),vi&&(qe.push("PROJECTION_GLOBE_VIEW"),pt&&qe.push("PROJECTED_POS_ON_VIEWPORT")),je.text.zOffsetVertexBuffer&&qe.push("Z_OFFSET"),je.iconsInText&&qe.push("RENDER_TEXT_AND_SYMBOL"),qe.push("RENDER_SDF"),N(qe);const Ut=je.text.programConfigurations.get(Ae.id),pr=F.getOrCreateProgram("symbol",{config:Ut,defines:qe});let Wr,Jr=[0,0],Qr=null;const co=je.textSizeData;je.iconsInText&&(Jr=Oe.imageAtlasTexture?Oe.imageAtlasTexture.size:[0,0],Qr=Oe.imageAtlasTexture?Oe.imageAtlasTexture:null,Wr=_a||0!==zo.pitch||F.options.rotating||F.options.zooming||"composite"===co.kind||"camera"===co.kind?To.LINEAR:To.NEAREST);const yo=Oe.glyphAtlasTexture?Oe.glyphAtlasTexture.size:[0,0],ko=Ae.layout.get("text-size-scale-range"),aa=k.aw(F.scaleFactor,ko[0],ko[1]),wa=k.bp(co,zo.zoom,aa),Sa=jt(wi,Oe.tileID.canonical,_a,na,zo,je.getProjection(),Mi),Sl=qt(wi,Oe.tileID.canonical,_a,na,zo,je.getProjection(),Mi),Jl=F.translatePosMatrix(Sl,Oe,vt,xi,!0),Ql=F.translatePosMatrix(wi,Oe,vt,xi),ec=pt?Fd:Sa,tc=na&&!_a&&!Me;let cc=Il;!ml&&!zo.mercatorFromTransition||na||(cc=Lr(zo));const uc=fr(co.kind,wa,tc,_a,F,Ql,ec,Jl,mo,!0,yo,Jr,!0,Fe,bi,rl,Kl,vi?cc:Il,je.getProjection(),null,null,aa),jc=Oe.glyphAtlasTexture?Oe.glyphAtlasTexture:null,Gc=To.LINEAR,qc=0!==Ae.paint.get("text-halo-width").constantOr(1),Hc=F.terrain&&_a&&Me?k.ab.mat4.invert(k.ab.mat4.create(),Sa):Fd;if(Me&&je.text){const k=zo.elevation,Me=k?k.getAtTileOffsetFunc(Fe,zo.center.lat,zo.worldSize,je.getProjection()):null,Ae=Vt(wi,Oe.tileID.canonical,_a,na,zo,je.getProjection(),Mi);$t(je,wi,F,!0,Ae,Sl,_a,Ur,Me,Fe)}return{program:pr,buffers:je.text,uniformValues:uc,atlasTexture:jc,atlasTextureIcon:Qr,atlasInterpolation:Gc,atlasInterpolationIcon:Wr,isSDF:!0,hasHalo:qc,tile:Oe,labelPlaneMatrixInv:Hc}},Jl=je.icon.segments.get().length,Ql=je.text.segments.get().length,ec=Jl&&!qe.onlyText?U():null,tc=Ql&&!qe.onlyIcons?G():null,cc=Ae.paint.get("icon-opacity").constantOr(1),uc=Ae.paint.get("text-opacity").constantOr(1);if(wa&&je.canOverlap){Sa=!0;const F=cc&&!qe.onlyText?je.icon.segments.get():[],Me=uc&&!qe.onlyIcons?je.text.segments.get():[];for(const Me of F)Sl.push({segments:new k.b7([Me]),sortKey:Me.sortKey,state:ec});for(const F of Me)Sl.push({segments:new k.b7([F]),sortKey:F.sortKey,state:tc})}else qe.onlyText||Sl.push({segments:cc?je.icon.segments:new k.b7([]),sortKey:0,state:ec}),qe.onlyIcons||Sl.push({segments:uc?je.text.segments:new k.b7([]),sortKey:0,state:tc})}Sa&&Sl.sort(((k,F)=>k.sortKey-F.sortKey));for(const k of Sl){const Me=k.state;if(Me)if(F.terrain?F.terrain.setupElevationDraw(Me.tile,Me.program,{useDepthForOcclusion:zo.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Me.labelPlaneMatrixInv}):F.setupDepthForOcclusion(zo.depthOcclusionForSymbolsAndCircles,Me.program),yo.activeTexture.set(To.TEXTURE0),Me.atlasTexture&&Me.atlasTexture.bind(Me.atlasInterpolation,To.CLAMP_TO_EDGE,!0),Me.atlasTextureIcon&&(yo.activeTexture.set(To.TEXTURE1),Me.atlasTextureIcon&&Me.atlasTextureIcon.bind(Me.atlasInterpolationIcon,To.CLAMP_TO_EDGE,!0)),F.uploadCommonLightUniforms(F.context,Me.program),Me.hasHalo){const Oe=Me.uniformValues;Oe.u_is_halo=1,Mr(Me.buffers,k.segments,Ae,F,Me.program,Ya,Fe,je,Oe,2),Oe.u_is_halo=0}else{if(Me.isSDF){const Oe=Me.uniformValues;Me.hasHalo&&(Oe.u_is_halo=1,Mr(Me.buffers,k.segments,Ae,F,Me.program,Ya,Fe,je,Oe,1)),Oe.u_is_halo=0}Mr(Me.buffers,k.segments,Ae,F,Me.program,Ya,Fe,je,Me.uniformValues,1)}}}function Mr(k,F,Me,Ae,Oe,Fe,je,qe,pt,vt){const Ut=[k.dynamicLayoutVertexBuffer,k.opacityVertexBuffer,k.iconTransitioningVertexBuffer,k.globeExtVertexBuffer,k.zOffsetVertexBuffer];Oe.draw(Ae,Ae.context.gl.TRIANGLES,Fe,je,qe,Gi.disabled,pt,Me.id,k.layoutVertexBuffer,k.indexBuffer,F,Me.paint,Ae.transform.zoom,k.programConfigurations.get(Me.id),Ut,vt)}function Or(F,Me,Ae,Oe,Fe,je,qe){const pt=F.context.gl,vt=Ae.paint.get("fill-pattern"),Ut=Ae.is3D(),xi=Ut?F.stencilModeFor3D():Bi.disabled,vi=vt&&vt.constantOr(1);let bi,wi,Mi,pr,Ur;qe?(wi=vi&&!Ae.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",bi=pt.LINES):(wi=vi?"fillPattern":"fill",bi=pt.TRIANGLES);for(const Wr of Oe){const Oe=Me.getTile(Wr);if(vi&&!Oe.patternsLoaded())continue;const Jr=Oe.getBucket(Ae);if(!Jr)continue;F.prepareDrawTile();const Qr=Jr.programConfigurations.get(Ae.id),co=F.isTileAffectedByFog(Wr),mo=F.getOrCreateProgram(wi,{config:Qr,overrideFog:co});vi&&(F.context.activeTexture.set(pt.TEXTURE0),Oe.imageAtlasTexture&&Oe.imageAtlasTexture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),Qr.updatePaintBuffers());const yo=vt.constantOr(null);if(yo&&Oe.imageAtlas){const F=Oe.imageAtlas,Me=k.A.from(yo),Ae=F.patternPositions[Me.getSerializedPrimary()];Ae&&Qr.setConstantPatternPositions(Ae)}const To=F.translatePosMatrix(Wr.projMatrix,Oe,Ae.paint.get("fill-translate"),Ae.paint.get("fill-translate-anchor")),zo=Ae.paint.get("fill-emissive-strength");if(qe){pr=Jr.indexBuffer2,Ur=Jr.segments2;const k=F.terrain&&F.terrain.renderingToTexture?F.terrain.drapeBufferSize:[pt.drawingBufferWidth,pt.drawingBufferHeight];Mi="fillOutlinePattern"===wi&&vi?tr(To,zo,F,Oe,k):er(To,zo,k)}else pr=Jr.indexBuffer,Ur=Jr.segments,Mi=vi?Qs(To,zo,F,Oe):Js(To,zo);F.uploadCommonUniforms(F.context,mo,Wr.toUnwrapped()),mo.draw(F,bi,Fe,Ut?xi:F.stencilModeForClipping(Wr),je,Gi.disabled,Mi,Ae.id,Jr.layoutVertexBuffer,pr,Ur,Ae.paint,F.transform.zoom,Qr,void 0)}}function Fr(F,Me,Ae,Oe,Fe,je,qe,pt){Ae.resetLayerRenderingStats(F);const vt=F.context,Ut=vt.gl,xi=F.transform,vi=Ae.paint.get("fill-extrusion-pattern"),bi=vi.constantOr(1),wi=Ae.paint.get("fill-extrusion-opacity"),Mi=F.style.enable3dLights(),pr=Ae.paint.get(Mi&&!bi?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Ur=[Ae.paint.get("fill-extrusion-ambient-occlusion-intensity"),pr],Wr=Ae.layout.get("fill-extrusion-edge-radius"),Jr=Wr>0&&!Ae.paint.get("fill-extrusion-rounded-roof"),Qr=Jr?0:Wr,co="globe"===xi.projection.name?k.d3():0,mo="globe"===xi.projection.name,yo=mo?k.ae(xi.zoom):0,To=[k.at(xi.center.lng),k.aA(xi.center.lat)],zo="none"===Ae.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),ko=Ae.paint.get("fill-extrusion-flood-light-color").toRenderColor(zo?null:Ae.lut).toArray01().slice(0,3),na=Ae.paint.get("fill-extrusion-flood-light-intensity"),aa=Ae.paint.get("fill-extrusion-vertical-scale"),_a=0!==Ae.paint.get("fill-extrusion-line-width").constantOr(1),wa=Ae.paint.get("fill-extrusion-height-alignment"),Sa=Ae.paint.get("fill-extrusion-base-alignment"),Ya=Ji(F,Ae.paint.get("fill-extrusion-cutoff-fade-range")),rl=[];let sl;mo&&rl.push("PROJECTION_GLOBE_VIEW"),Ur[0]>0&&rl.push("FAUX_AO"),Jr&&rl.push("ZERO_ROOF_RADIUS"),pt&&rl.push("HAS_CENTROID"),na>0&&rl.push("FLOOD_LIGHT"),Ya.shouldRenderCutoff&&rl.push("RENDER_CUTOFF"),_a&&rl.push("RENDER_WALL_MODE");const ml="shadow"===F.renderPass,Sl=F.shadowRenderer,Il=ml&&!!Sl;F.shadowRenderer&&(F.shadowRenderer.useNormalOffset=!0);let Kl=[0,0,0];if(Sl){const k=F.style.directionalLight,Me=F.style.ambientLight;k&&Me&&(Kl=ro(F.style,k,Me)),ml||(rl.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Sl.useNormalOffset&&rl.push("NORMAL_OFFSET")),sl=rl.concat(["SHADOWS_SINGLE_CASCADE"])}const Jl=Il?"fillExtrusionDepth":bi?"fillExtrusionPattern":"fillExtrusion",Ql=Ae.getLayerRenderingStats();for(const Mi of Oe){const Oe=Me.getTile(Mi),pr=Oe.getBucket(Ae);if(!pr||pr.projection.name!==xi.projection.name)continue;let Wr=!1;Sl&&(Wr=0===Sl.getMaxCascadeForTile(Mi.toUnwrapped()));const Jr=F.isTileAffectedByFog(Mi),zo=pr.programConfigurations.get(Ae.id),Il=F.getOrCreateProgram(Jl,{config:zo,defines:Wr?sl:rl,overrideFog:Jr});if(F.terrain&&F.terrain.setupElevationDraw(Oe,Il,{useMeterToDem:!0}),!pr.centroidVertexBuffer){const k=Il.attributes.a_centroid_pos;void 0!==k&&Ut.vertexAttrib2f(k,0,0)}!ml&&Sl&&Sl.setupShadows(Oe.tileID.toUnwrapped(),Il,"vector-tile",Oe.tileID.overscaledZ),bi&&(F.context.activeTexture.set(Ut.TEXTURE0),Oe.imageAtlasTexture&&Oe.imageAtlasTexture.bind(Ut.LINEAR,Ut.CLAMP_TO_EDGE),zo.updatePaintBuffers());const ec=vi.constantOr(null);if(ec&&Oe.imageAtlas){const F=Oe.imageAtlas,Me=k.A.from(ec),Ae=F.patternPositions[Me.getSerializedPrimary()];Ae&&zo.setConstantPatternPositions(Ae)}const tc=Ae.paint.get("fill-extrusion-vertical-gradient"),cc=1/pr.tileToMeter;let uc;if(ml&&Sl){if(jr(Oe.tileID,pr,F))continue;const k=Sl.calculateShadowPassMatrixFromTile(Oe.tileID.toUnwrapped());uc=Ks(k,Qr,cc,aa,wa,Sa)}else{const k=F.translatePosMatrix(Mi.expandedProjMatrix,Oe,Ae.paint.get("fill-extrusion-translate"),Ae.paint.get("fill-extrusion-translate-anchor")),Me=xi.projection.createInversionMatrix(xi,Mi.canonical);uc=bi?Ys(k,F,tc,wi,Ur,Qr,cc,Mi,Oe,co,wa,Sa,yo,To,Me,ko,aa):Xs(k,F,tc,wi,Ur,Qr,cc,Mi,co,wa,Sa,yo,To,Me,ko,aa,na,Kl)}F.uploadCommonUniforms(vt,Il,Mi.toUnwrapped(),null,Ya);let jc=pr.segments;if("mercator"===xi.projection.name&&!ml&&(jc=pr.getVisibleSegments(Oe.tileID,F.terrain,F.transform.getFrustum(0)),!jc.get().length))continue;if(Ql)if(ml)for(const k of jc.get())Ql.numRenderedVerticesInShadowPass+=k.primitiveLength;else for(const k of jc.get())Ql.numRenderedVerticesInTransparentPass+=k.primitiveLength;const Gc=[];(F.terrain||pt)&&Gc.push(pr.centroidVertexBuffer),mo&&Gc.push(pr.layoutVertexExtBuffer),_a&&Gc.push(pr.wallVertexBuffer),Il.draw(F,vt.gl.TRIANGLES,Fe,je,qe,Gi.backCCW,uc,Ae.id,pr.layoutVertexBuffer,pr.indexBuffer,jc,Ae.paint,F.transform.zoom,zo,Gc)}F.shadowRenderer&&(F.shadowRenderer.useNormalOffset=!1)}function kr(F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi,bi,wi,Mi,pr,Ur,Wr,Jr){const Qr=F.context,co=Qr.gl,mo=F.transform,yo=F.transform.zoom,To=[],zo=Ji(F,Ae.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===Ut?(To.push("CLEAR_SUBPASS"),Jr&&(To.push("CLEAR_FROM_TEXTURE"),Qr.activeTexture.set(co.TEXTURE0),Jr.bind(co.LINEAR,co.CLAMP_TO_EDGE))):"sdf"===Ut&&To.push("SDF_SUBPASS"),Ur&&To.push("HAS_CENTROID"),zo.shouldRenderCutoff&&To.push("RENDER_CUTOFF");const ko=Ae.layout.get("fill-extrusion-edge-radius"),I=(k,Me,Oe,Ut,Wr)=>{const co=Me.programConfigurations.get(Ae.id),mo=F.isTileAffectedByFog(k),na=F.getOrCreateProgram("fillExtrusionGroundEffect",{config:co,defines:To,overrideFog:mo}),aa=((k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut)=>({u_matrix:F,u_opacity:Me,u_ao_pass:Ae?1:0,u_meter_to_tile:Oe,u_ao:Fe,u_flood_light_intensity:je,u_flood_light_color:qe,u_attenuation:pt,u_edge_radius:vt,u_fb:0,u_fb_size:Ut,u_dynamic_offset:1}))(0,Ut,xi,vt,Wr,[vi,bi*Wr],wi,Mi,pr,yo>=17?0:ko*Wr,Jr?Jr.size[0]:0),_a=[];Ur&&_a.push(Me.hiddenByLandmarkVertexBuffer),F.uploadCommonUniforms(Qr,na,k.toUnwrapped(),null,zo),na.draw(F,Qr.gl.TRIANGLES,Fe,je,qe,pt,aa,Ae.id,Me.vertexBuffer,Me.indexBuffer,Oe,Ae.paint,yo,co,_a)};for(const Fe of Oe){const Oe=Me.getTile(Fe),je=Oe.getBucket(Ae);if(!je||je.projection.name!==mo.projection.name||!je.groundEffect||je.groundEffect&&!je.groundEffect.hasData())continue;const qe=je.groundEffect,pt=1/je.tileToMeter;{const k=F.translatePosMatrix(Fe.projMatrix,Oe,Ae.paint.get("fill-extrusion-translate"),Ae.paint.get("fill-extrusion-translate-anchor")),Me=qe.getDefaultSegment();I(Fe,qe,Me,k,pt)}if(Wr)for(let je=0;je<4;je++){const qe=k.d4[je](Fe),vt=Me.getTile(qe);if(!vt)continue;const Ut=vt.getBucket(Ae);if(!Ut||Ut.projection.name!==mo.projection.name||!Ut.groundEffect||Ut.groundEffect&&!Ut.groundEffect.hasData())continue;const xi=Ut.groundEffect;let vi,bi;0===je?(vi=[-k.ag,0,0],bi=1):1===je?(vi=[k.ag,0,0],bi=0):2===je?(vi=[0,-k.ag,0],bi=3):(vi=[0,k.ag,0],bi=2);const wi=xi.regionSegments[bi];if(!wi)continue;const Mi=new Float32Array(16);k.ab.mat4.translate(Mi,Fe.projMatrix,vi),I(Fe,xi,wi,F.translatePosMatrix(Mi,Oe,Ae.paint.get("fill-extrusion-translate"),Ae.paint.get("fill-extrusion-translate-anchor")),pt)}}}function Br(F,Me,Ae,Oe,Fe,je,qe){0===Oe.centroidVertexArray.length&&Oe.createCentroidsBuffer();const pt=je?je.findDEMTileFor(Ae):null;if(!(pt&&pt.dem||qe))return;je&&pt&&pt.dem&&Oe.selfDEMTileTimestamp!==pt.dem._timestamp&&(Oe.borderDoneWithNeighborZ=[-1,-1,-1,-1],Oe.selfDEMTileTimestamp=pt.dem._timestamp);const c=F=>new k.P(Math.ceil((F+k.d7)*k.d8),0),h=k=>{const F=Me.getSource().minzoom,o=k=>{const F=Me.getTileByID(k);if(F&&F.hasData())return F.getBucket(Fe)},Ae=[0,-1,1];for(const Me of Ae){if(k.overscaledZ+Me<F)continue;const Ae=o(k.calculateScaledKey(k.overscaledZ+Me));if(Ae)return Ae}},vt=[0,0,0],d=(F,Me)=>(vt[0]=Math.min(F.min.y,Me.min.y),vt[1]=Math.max(F.max.y,Me.max.y),vt[2]=k.ag-Me.min.x>F.max.x?Me.min.x-k.ag:F.max.x,vt),_=(F,Me)=>(vt[0]=Math.min(F.min.x,Me.min.x),vt[1]=Math.max(F.max.x,Me.max.x),vt[2]=k.ag-Me.min.y>F.max.y?Me.min.y-k.ag:F.max.y,vt),Ut=[(k,F)=>d(k,F),(k,F)=>d(F,k),(k,F)=>_(k,F),(k,F)=>_(F,k)],f=(F,Me,Oe,Fe,qe,vt,Ut)=>{if(!je)return 0;const xi=[[vt?Oe:F,vt?F:Oe,0],[vt?Oe:Me,vt?Me:Oe,0]],vi=Ut<0?k.ag+Ut:Ut,bi=[vt?vi:(F+Me)/2,vt?(F+Me)/2:vi,0];return 0===Oe&&Ut<0||0!==Oe&&Ut>0?je.getForTilePoints(qe,[bi],!0,Fe):xi.push(bi),je.getForTilePoints(Ae,xi,!0,pt),Math.max(xi[0][2],xi[1][2],bi[2])/je.exaggeration()};for(let F=0;F<4;F++){const Me=Oe.borderFeatureIndices[F];if(0===Me.length)continue;const Fe=k.d4[F](Ae),pt=h(Fe);if(!(pt&&pt instanceof k.d5))continue;const vt=je?je.findDEMTileFor(Fe):null;if(!(vt&&vt.dem||qe))continue;if(je&&vt&&vt.dem&&Oe.borderDEMTileTimestamp[F]!==vt.dem._timestamp&&(Oe.borderDoneWithNeighborZ[F]=-1,Oe.borderDEMTileTimestamp[F]=vt.dem._timestamp),Oe.borderDoneWithNeighborZ[F]===pt.canonical.z)continue;0===pt.centroidVertexArray.length&&pt.createCentroidsBuffer();const bi=(F<2?1:5)-F,wi=pt.borderDoneWithNeighborZ[bi]!==Oe.canonical.z,Mi=pt.borderFeatureIndices[bi];let pr=0;if(Oe.canonical.z!==pt.canonical.z){for(const k of Me)Oe.showCentroid(Oe.featuresOnBorder[k]);if(wi)for(const k of Mi)pt.showCentroid(pt.featuresOnBorder[k]);Oe.borderDoneWithNeighborZ[F]=pt.canonical.z,pt.borderDoneWithNeighborZ[bi]=Oe.canonical.z}for(const Ae of Me){const Me=Oe.featuresOnBorder[Ae],je=Oe.centroidData[Me.centroidDataIndex],wi=Me.borders[F];let Ur;for(;pr<Mi.length;){Ur=pt.featuresOnBorder[Mi[pr]];const k=Ur.borders[bi];if(k[1]>wi[0]+3||k[0]>wi[0]-3)break;pt.showCentroid(Ur),pr++}if(Ur&&pr<Mi.length){const Ae=pr;let Wr=0;for(;!(Ur.borders[bi][0]>wi[1]-3)&&(Wr++,++pr!==Mi.length);)Ur=pt.featuresOnBorder[Mi[pr]];Ur=pt.featuresOnBorder[Mi[Ae]];let Jr=!1;if(Wr>=1){const k=Ur.borders[bi];Math.abs(wi[0]-k[0])<3&&Math.abs(wi[1]-k[1])<3&&(Wr=1,Jr=!0,pr=Ae+1)}else if(0===Wr){Oe.showCentroid(Me);continue}const Qr=pt.centroidData[Ur.centroidDataIndex];qe&&Jr&&(((xi=je).flags|(vi=Qr).flags)&k.d6?(xi.flags|=k.d6,vi.flags|=k.d6):(xi.flags&=~k.d6,vi.flags&=~k.d6));const co=Me.intersectsCount()>1||Ur.intersectsCount()>1;if(Wr>1)pr=Ae,je.centroidXY=Qr.centroidXY=new k.P(0,0);else if(vt&&vt.dem&&!co){const Me=Ut[F](je,Qr),Ae=F%2?k.ag-1:0,Oe=f(Me[0],Math.min(k.ag-1,Me[1]),Ae,vt,Fe,F<2,Me[2]);je.centroidXY=Qr.centroidXY=c(Oe)}else co?je.centroidXY=Qr.centroidXY=new k.P(0,0):(je.centroidXY=Oe.encodeBorderCentroid(Me),Qr.centroidXY=pt.encodeBorderCentroid(Ur));Oe.writeCentroidToBuffer(je),pt.writeCentroidToBuffer(Qr)}else Oe.showCentroid(Me)}Oe.borderDoneWithNeighborZ[F]=pt.canonical.z,pt.borderDoneWithNeighborZ[bi]=Oe.canonical.z}var xi,vi;(Oe.needsCentroidUpdate||!Oe.centroidVertexBuffer&&0!==Oe.centroidVertexArray.length)&&Oe.uploadCentroid(F)}const Nd=[1,0,0],Gd=[0,1,0],Yd=[0,0,1];function jr(F,Me,Ae){const Oe=Ae.transform,Fe=Ae.shadowRenderer;if(!Fe)return!0;const je=F.toUnwrapped(),qe=Oe.tileSize*Fe._cascades[Ae.currentShadowCascade].scale;let pt=Me.maxHeight;if(Oe.elevation){const k=Oe.elevation.getMinMaxForTile(F);k&&(pt+=k.max)}const vt=[...Fe.shadowDirection];vt[2]=-vt[2];const Ut=Fe.computeSimplifiedTileShadowVolume(je,pt,qe,vt);if(!Ut)return!1;const xi=[Nd,Gd,Yd,vt,[vt[0],0,vt[2]],[0,vt[1],vt[2]]],vi="globe"===Oe.projection.name,bi=Oe.scaleZoom(qe),wi=k.bR.fromInvProjectionMatrix(Oe.invProjMatrix,Oe.worldSize,bi,!vi),Mi=Fe.getCurrentCascadeFrustum();return 0===wi.intersectsPrecise(Ut.vertices,Ut.planes,xi)||0===Mi.intersectsPrecise(Ut.vertices,Ut.planes,xi)}function Vr(F){return[F[0]*k.d9,F[1]*k.d9,F[2]*k.d9,0]}function qr(F,Me,Ae,Oe,Fe,je,qe,pt,vt){const Ut=Oe.getSource(),xi=Ae.globeSharedBuffers;if(!xi)return;let vi,bi,wi;if(Me&&(vi=Oe.getTile(Me)),Ut instanceof k.aJ?(bi=Ut.texture,wi=k.cI(0,0,Ae.transform)):vi&&Me&&(bi=vi.texture,wi=k.cI(Me.canonical.z,Me.canonical.x,Ae.transform)),!bi||!wi)return;F||(wi=k.ab.mat4.scale(k.ab.mat4.create(),wi,[1,-1,1]));const Mi=Ae.context,pr=Mi.gl,Ur="nearest"===Fe.paint.get("raster-resampling")?pr.NEAREST:pr.LINEAR,Wr=Ae.colorModeForDrapableLayerRenderPass(je),Jr=qe.defines;Jr.push("GLOBE_POLES");const Qr=new Fi(pr.LEQUAL,Fi.ReadWrite,Ae.depthRangeFor3D),co=Float32Array.from(Ae.transform.expandedFarZProjMatrix),mo=Float32Array.from(k.bb(k.cH(new k.bT(0,0,0))));Ae.terrain&&Ae.terrain.prepareDrawTile(),Mi.activeTexture.set(pr.TEXTURE0),bi.bind(Ur,pr.CLAMP_TO_EDGE),Mi.activeTexture.set(pr.TEXTURE1),bi.bind(Ur,pr.CLAMP_TO_EDGE),bi.useMipmap&&Mi.extTextureFilterAnisotropic&&Ae.transform.pitch>20&&pr.texParameterf(pr.TEXTURE_2D,Mi.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Mi.extTextureFilterAnisotropicMax);const[yo,To,zo,ko]=Me?xi.getPoleBuffers(Me.canonical.z,!1):xi.getPoleBuffers(0,!0),na=Fe.paint.get("raster-elevation");let aa;F?(aa=yo,Ae.renderDefaultNorthPole=0!==na):(aa=To,Ae.renderDefaultSouthPole=0!==na);const _a=Vr(qe.mix),wa=((k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi)=>lr(k,F,Me,new Float32Array(16),new Float32Array(9),[0,0],Ae,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Fe,[0,0]||[0,0],qe,2,vt,Ut,xi,1,0,vi))(co,mo,wi,k.ae(Ae.transform.zoom),0,Fe,0,na,0,_a,qe.offset,qe.range,je),Sa=Ae.getOrCreateProgram("raster",{defines:Jr});Ae.uploadCommonUniforms(Mi,Sa,null),Sa.draw(Ae,pr.TRIANGLES,Qr,vt,Wr,pt,wa,Fe.id,aa,zo,ko)}function Hr(k){const F=k._nearZ,Me=k.projection.farthestPixelDistance(k),Ae=Me-F,Oe=.2*k.height,Fe=F+Oe;return[F,Me,(Fe-Oe-F)/Ae,(Fe-F)/Ae]}function Zr(k,F,Me,Ae){if(k)return F instanceof ot&&k instanceof xt?F.getTextureDescriptor(k,Me,!0):{texture:k.texture,mix:Vr(Ae.mix),offset:Ae.offset,buffer:0,tileSize:1}}var lp=k.da([{name:"a_index",type:"Int16",components:1}]);class $r{constructor(F,Me,Ae,Oe){const Fe={width:Ae[0],height:Ae[1],data:null},je=F.gl;this.targetColorTexture=new k.T(F,Fe,je.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new k.T(F,Fe,je.RGBA8,{useMipmap:!1}),this.context=F,this.updateParticleTexture(Me,Oe),this.lastInvalidatedAt=0}updateParticleTexture(F,Me){if(this.particleTextureDimension===Me.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const Ae=this.context.gl,Oe=Me.width*Me.height;this.particleTexture0=new k.T(this.context,Me,Ae.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new k.T(this.context,Me,Ae.RGBA8,{premultiply:!1,useMipmap:!1});const Fe=new k.db;Fe.reserve(Oe);for(let k=0;k<Oe;k++)Fe.emplaceBack(k);this.particleIndexBuffer=this.context.createVertexBuffer(Fe,lp.members,!0),this.particleSegment=k.b7.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=Me.width}update(F){return!(this.lastInvalidatedAt<F&&(this.lastInvalidatedAt=k.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Xr(F,Me,Ae){if(!F)return null;const Oe=Me.getTextureDescriptor(F,Ae,!0);if(!Oe)return null;let{texture:Fe,mix:je,offset:qe,tileSize:pt,buffer:vt,format:Ut}=Oe;if(!Fe||!Ut)return null;let xi=!1;return"uint32"===Ut&&(xi=!0,je[3]=0,je=ar(k.dc,je,[0,Ae.paint.get("raster-particle-max-speed")]),qe=nr(k.dc,qe,[0,Ae.paint.get("raster-particle-max-speed")])),{texture:Fe,textureOffset:[vt/(pt+2*vt),pt/(pt+2*vt)],tileSize:pt,scalarData:xi,scale:je,offset:qe,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[Ut]]}}function Kr(k){const F=k._nearZ,Me=k.projection.farthestPixelDistance(k),Ae=Me-F,Oe=.2*k.height,Fe=F+Oe;return[F,Me,(Fe-Oe-F)/Ae,(Fe-F)/Ae]}const up=new k.aj(1,0,0,1),dp=new k.aj(0,1,0,1),fp=new k.aj(0,0,1,1),mp=new k.aj(1,0,1,1),_p=new k.aj(0,1,1,1);function ia(F,Me,Ae,Oe,Fe,je,qe){const pt=F.context,vt=F.transform,Ut=pt.gl,xi="globe"===vt.projection.name,vi=xi?["PROJECTION_GLOBE_VIEW"]:[];let bi=k.ab.mat4.clone(Ae.projMatrix);if(xi&&k.ae(vt.zoom)>0){const F=k.ba(Ae.canonical,vt),Me=k.dd(F);bi=k.ab.mat4.multiply(new Float32Array(16),vt.globeMatrix,Me),k.ab.mat4.multiply(bi,vt.projMatrix,bi)}const wi=k.ab.mat4.create();wi[12]+=2*Fe/(k.q.devicePixelRatio*vt.width),wi[13]+=2*je/(k.q.devicePixelRatio*vt.height),k.ab.mat4.multiply(bi,wi,bi);const Mi=F.getOrCreateProgram("debug",{defines:vi}),pr=Me.getTileByID(Ae.key);F.terrain&&F.terrain.setupElevationDraw(pr,Mi);const Ur=Fi.disabled,Wr=Bi.disabled,Jr=F.colorModeForRenderPass(),Qr="$debug";pt.activeTexture.set(Ut.TEXTURE0),F.emptyTexture.bind(Ut.LINEAR,Ut.CLAMP_TO_EDGE),xi?pr._makeGlobeTileDebugBuffers(F.context,vt):pr._makeDebugTileBoundsBuffers(F.context,vt.projection);const co=pr._tileDebugBuffer||F.debugBuffer,mo=pr._tileDebugIndexBuffer||F.debugIndexBuffer,yo=pr._tileDebugSegments||F.debugSegments;if(Mi.draw(F,Ut.LINE_STRIP,Ur,Wr,Jr,Gi.disabled,or(bi,Oe),Qr,co,mo,yo,null,null,null,[pr._globeTileDebugBorderBuffer]),qe){const k=pr.latestRawTileData,Me=Math.floor((k&&k.byteLength||0)/1024);let Oe=Ae.canonical.toString();Ae.overscaledZ!==Ae.canonical.z&&(Oe+=` => ${Ae.overscaledZ}`),Oe+=` ${pr.state}`,Oe+=` ${Me}kb`,function(k,F){k.initDebugOverlayCanvas();const Me=k.debugOverlayCanvas,Ae=k.context.gl,Oe=k.debugOverlayCanvas.getContext("2d");Oe.clearRect(0,0,Me.width,Me.height),Oe.shadowColor="white",Oe.shadowBlur=2,Oe.lineWidth=1.5,Oe.strokeStyle="white",Oe.textBaseline="top",Oe.font="bold 36px Open Sans, sans-serif",Oe.fillText(F,5,5),Oe.strokeText(F,5,5),k.debugOverlayTexture.update(Me),k.debugOverlayTexture.bind(Ae.LINEAR,Ae.CLAMP_TO_EDGE)}(F,Oe)}const To=Me.getTile(Ae).tileSize,zo=512/Math.min(To,512)*(Ae.overscaledZ/vt.zoom)*.5,ko=pr._tileDebugTextBuffer||F.debugBuffer,na=pr._tileDebugTextIndexBuffer||F.quadTriangleIndexBuffer,aa=pr._tileDebugTextSegments||F.debugSegments;Mi.draw(F,Ut.TRIANGLES,Ur,Wr,Oi.alphaBlended,Gi.disabled,or(bi,k.aj.transparent,zo),Qr,ko,na,aa,null,null,null,[pr._globeTileDebugTextBuffer])}function oa(k,F,Me,Ae){ra(k,0,F+Me/2,k.transform.width,Me,Ae)}function sa(k,F,Me,Ae){ra(k,F-Me/2,0,Me,k.transform.height,Ae)}function ra(F,Me,Ae,Oe,Fe,je){const qe=F.context,pt=qe.gl;pt.enable(pt.SCISSOR_TEST),pt.scissor(Me*k.q.devicePixelRatio,Ae*k.q.devicePixelRatio,Oe*k.q.devicePixelRatio,Fe*k.q.devicePixelRatio),qe.clear({color:je}),pt.disable(pt.SCISSOR_TEST)}const gp=k.da([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:yp}=gp;function la(k,F,Me,Ae){k.emplaceBack(F,Me,Ae)}class ca{constructor(F){this.vertexArray=new k.de,this.indices=new k.aU,la(this.vertexArray,-1,-1,1),la(this.vertexArray,1,-1,1),la(this.vertexArray,-1,1,1),la(this.vertexArray,1,1,1),la(this.vertexArray,-1,-1,-1),la(this.vertexArray,1,-1,-1),la(this.vertexArray,-1,1,-1),la(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=F.createVertexBuffer(this.vertexArray,yp),this.indexBuffer=F.createIndexBuffer(this.indices),this.segment=k.b7.simpleSegment(0,0,36,12)}}function ha(F,Me,Ae,Oe,Fe,je){const qe=F.context.gl,pt=Me.paint.get("sky-atmosphere-color"),vt=Me.paint.get("sky-atmosphere-halo-color"),Ut=Me.paint.get("sky-atmosphere-sun-intensity"),xi=((k,F,Me,Ae,Oe)=>({u_matrix_3f:k,u_sun_direction:F,u_sun_intensity:Me,u_color_tint_r:[Ae.r,Ae.g,Ae.b,Ae.a],u_color_tint_m:[Oe.r,Oe.g,Oe.b,Oe.a],u_luminance:5e-5}))(k.ab.mat3.fromMat4(k.ab.mat3.create(),Oe),Fe,Ut,pt,vt);qe.framebufferTexture2D(qe.FRAMEBUFFER,qe.COLOR_ATTACHMENT0,qe.TEXTURE_CUBE_MAP_POSITIVE_X+je,Me.skyboxTexture,0),Ae.draw(F,qe.TRIANGLES,Fi.disabled,Bi.disabled,Oi.unblended,Gi.frontCW,xi,"skyboxCapture",Me.skyboxGeometry.vertexBuffer,Me.skyboxGeometry.indexBuffer,Me.skyboxGeometry.segment)}const xp=k.da([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class da{constructor(F){const Me=new k.df;Me.emplaceBack(-1,1,1,0,0),Me.emplaceBack(1,1,1,1,0),Me.emplaceBack(1,-1,1,1,1),Me.emplaceBack(-1,-1,1,0,1);const Ae=new k.aU;Ae.emplaceBack(0,1,2),Ae.emplaceBack(2,3,0),this.vertexBuffer=F.createVertexBuffer(Me,xp.members),this.indexBuffer=F.createIndexBuffer(Ae),this.segments=k.b7.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const vp=k.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class pa{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class fa{constructor(F){this.colorModeAlphaBlendedWriteRGB=new Oi([1,oh,1,oh],k.aj.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Oi([1,0,1,0],k.aj.transparent,[!1,!1,!1,!0]),this.params=new pa,this.updateNeeded=!0,F.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),F.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),F.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),F.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(F){const Me=F.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new da(Me);const F=this.params.sizeRange,Ae=this.params.intensityRange,Oe=function(F){const Me=k.di(30),Ae=[];for(let Oe=0;Oe<F;++Oe){const F=2*Math.PI*Me(),Oe=Math.acos(1-2*Me())-.5*Math.PI;Ae.push(k.ab.vec3.fromValues(Math.cos(Oe)*Math.cos(F),Math.cos(Oe)*Math.sin(F),Math.sin(Oe)))}return Ae}(this.params.starsCount),Fe=k.di(300),je=new k.dg,qe=new k.aU;let pt=0;for(let Me=0;Me<Oe.length;++Me){const vt=k.ab.vec3.scale([],Oe[Me],200),Ut=Math.max(0,1+.01*F*(1*Fe()-.5)),xi=Math.max(0,1+.01*Ae*(1*Fe()-.5));je.emplaceBack(vt[0],vt[1],vt[2],-1,-1,Ut,xi),je.emplaceBack(vt[0],vt[1],vt[2],1,-1,Ut,xi),je.emplaceBack(vt[0],vt[1],vt[2],1,1,Ut,xi),je.emplaceBack(vt[0],vt[1],vt[2],-1,1,Ut,xi),qe.emplaceBack(pt+0,pt+1,pt+2),qe.emplaceBack(pt+0,pt+2,pt+3),pt+=4}this.starsVx=Me.createVertexBuffer(je,vp.members),this.starsIdx=Me.createIndexBuffer(qe),this.starsSegments=k.b7.simpleSegment(0,0,je.length,qe.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(F,Me){const Ae=F.context,Oe=Ae.gl,Fe=F.transform,je=new Fi(Oe.LEQUAL,Fi.ReadOnly,[0,1]),qe=k.ae(Fe.zoom),pt=F.style.getLut(Me.scope),vt="none"===Me.properties.get("color-use-theme"),Ut=Me.properties.get("color").toRenderColor(vt?null:pt).toArray01(),xi="none"===Me.properties.get("high-color-use-theme"),vi=Me.properties.get("high-color").toRenderColor(xi?null:pt).toArray01(),bi="none"===Me.properties.get("space-color-use-theme"),wi=Me.properties.get("space-color").toRenderColor(bi?null:pt).toArray01PremultipliedAlpha(),Mi=5e-4,pr=k.dh(Me.properties.get("horizon-blend"),0,1,Mi,.25),Ur=k.cC(F,Ae,Fe)&&pr===Mi?Fe.worldSize/(2*Math.PI*1.025)-1:Fe.globeRadius,Wr=F.frameCounter/1e3%1,Jr=k.ab.vec3.length(Fe.globeCenterInViewSpace),Qr=Math.sqrt(Math.pow(Jr,2)-Math.pow(Ur,2)),co=Math.acos(Qr/Jr),w=k=>{const Me="globe"===Fe.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];k&&Me.push("ALPHA_PASS");const pt=F.getOrCreateProgram("globeAtmosphere",{defines:Me}),vt=((k,F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi)=>({u_frustum_tl:k,u_frustum_tr:F,u_frustum_br:Me,u_frustum_bl:Ae,u_horizon:Oe,u_transition:Fe,u_fadeout_range:je,u_color:qe,u_high_color:pt,u_space_color:vt,u_temporal_offset:Ut,u_horizon_angle:xi}))(Fe.frustumCorners.TL,Fe.frustumCorners.TR,Fe.frustumCorners.BR,Fe.frustumCorners.BL,Fe.frustumCorners.horizon,qe,pr,Ut,vi,wi,Wr,co);F.uploadCommonUniforms(Ae,pt);const xi=this.atmosphereBuffer;xi&&pt.draw(F,Oe.TRIANGLES,je,Bi.disabled,k?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Gi.backCW,vt,k?"atmosphere_glow_alpha":"atmosphere_glow",xi.vertexBuffer,xi.indexBuffer,xi.segments)};w(!1),w(!0)}drawStars(F,Me){const Ae=k.aw(Me.properties.get("star-intensity"),0,1);if(0===Ae)return;const Oe=F.context,Fe=Oe.gl,je=F.transform,qe=F.getOrCreateProgram("stars"),pt=k.ab.quat.identity([]);k.ab.quat.rotateX(pt,pt,-je._pitch),k.ab.quat.rotateZ(pt,pt,-je.angle),k.ab.quat.rotateX(pt,pt,k.ai(je._center.lat)),k.ab.quat.rotateY(pt,pt,-k.ai(je._center.lng));const vt=k.ab.mat4.fromQuat(new Float32Array(16),pt),Ut=k.ab.mat4.multiply([],je.starsProjMatrix,vt),xi=k.ab.mat3.fromMat4([],vt),vi=k.ab.mat3.invert([],xi),bi=[0,1,0];k.ab.vec3.transformMat3(bi,bi,vi),k.ab.vec3.scale(bi,bi,this.params.sizeMultiplier);const wi=[1,0,0];k.ab.vec3.transformMat3(wi,wi,vi),k.ab.vec3.scale(wi,wi,this.params.sizeMultiplier);const Mi=(pr=bi,Ur=wi,Wr=Ae,{u_matrix:Float32Array.from(Ut),u_up:pr,u_right:Ur,u_intensity_multiplier:Wr});var pr,Ur,Wr;F.uploadCommonUniforms(Oe,qe),this.starsVx&&this.starsIdx&&qe.draw(F,Fe.TRIANGLES,Fi.disabled,Bi.disabled,this.colorModeAlphaBlendedWriteRGB,Gi.disabled,Mi,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function ma(F,Me){const Ae=[...F],Oe=Me.cameraWorldSizeForFog/Me.worldSize,Fe=k.ab.mat4.identity([]);return k.ab.mat4.scale(Fe,Fe,[Oe,Oe,1]),k.ab.mat4.multiply(Ae,Fe,Ae),k.ab.mat4.multiply(Ae,Me.worldToFogMatrix,Ae),Ae}function ga(F,Me,Ae,Oe,Fe){const je=Ae.material,qe=Oe.context,{baseColorTexture:pt,metallicRoughnessTexture:vt}=je.pbrMetallicRoughness,{normalTexture:Ut,occlusionTexture:xi,emissionTexture:vi}=je;function _(k,Me,Ae){if(k&&(F.push(Me),qe.activeTexture.set(qe.gl.TEXTURE0+Ae),k.gfxTexture)){const{minFilter:F,magFilter:Me,wrapS:Ae,wrapT:Oe}=k.sampler;k.gfxTexture.bindExtraParam(F,Me,Ae,Oe)}}_(pt,"HAS_TEXTURE_u_baseColorTexture",uh.BaseColor),_(vt,"HAS_TEXTURE_u_metallicRoughnessTexture",uh.MetallicRoughness),_(Ut,"HAS_TEXTURE_u_normalTexture",uh.Normal),_(xi,"HAS_TEXTURE_u_occlusionTexture",uh.Occlusion),_(vi,"HAS_TEXTURE_u_emissionTexture",uh.Emission),Fe&&(Fe.texture||(Fe.texture=new k.dk(Oe.context,Fe.image,[Fe.image.height,Fe.image.height,Fe.image.height],qe.gl.RGBA8)),qe.activeTexture.set(qe.gl.TEXTURE0+uh.LUT),Fe.texture&&Fe.texture.bind(qe.gl.LINEAR,qe.gl.CLAMP_TO_EDGE),F.push("APPLY_LUT_ON_GPU")),Ae.texcoordBuffer&&(F.push("HAS_ATTRIBUTE_a_uv_2f"),Me.push(Ae.texcoordBuffer)),Ae.colorBuffer&&(F.push(12===Ae.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),Me.push(Ae.colorBuffer)),Ae.normalBuffer&&(F.push("HAS_ATTRIBUTE_a_normal_3f"),Me.push(Ae.normalBuffer)),Ae.pbrBuffer&&(F.push("HAS_ATTRIBUTE_a_pbr"),F.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),Me.push(Ae.pbrBuffer)),"OPAQUE"!==je.alphaMode&&"MASK"!==je.alphaMode||F.push("UNPREMULT_TEXTURE_IN_SHADER"),je.defined||F.push("DIFFUSE_SHADED"),F.push("USE_STANDARD_DERIVATIVES");const bi=Oe.shadowRenderer;bi&&(F.push("RENDER_SHADOWS","DEPTH_TEXTURE"),bi.useNormalOffset&&F.push("NORMAL_OFFSET"))}function va(F,Me,Ae,Oe,Fe,je){const qe=Ae.paint.get("model-opacity").constantOr(1),pt=Me.context,vt=new Fi(Me.context.gl.LEQUAL,Fi.ReadWrite,Me.depthRangeFor3D),Ut=Me.transform,xi=F.mesh,vi=xi.material,bi=vi.pbrMetallicRoughness,wi=Me.style.fog;let Mi;Mi="pixels"===Me.transform.projection.zAxisUnit?[...F.nodeModelMatrix]:k.ab.mat4.multiply([],Oe.zScaleMatrix,F.nodeModelMatrix),k.ab.mat4.multiply(Mi,Oe.negCameraPosMatrix,Mi);const pr=k.ab.mat4.invert([],Mi);k.ab.mat4.transpose(pr,pr);const Ur="none"===Ae.paint.get("model-color-use-theme").constantOr("default"),Wr=Ae.paint.get("model-emissive-strength").constantOr(0),Jr=yr(new Float32Array(F.worldViewProjection),new Float32Array(Mi),new Float32Array(pr),null,Me,qe,bi.baseColorFactor.toRenderColor(null),vi.emissiveFactor,bi.metallicFactor,bi.roughnessFactor,vi,Wr,Ae),Qr={defines:[]},co=[],mo=Me.shadowRenderer;mo&&(mo.useNormalOffset=!1),ga(Qr.defines,co,xi,Me,Ur?null:Ae.lut);let yo=null;if(wi){const k=ma(F.nodeModelMatrix,Me.transform);if(yo=new Float32Array(k),"globe"!==Ut.projection.name){const F=xi.aabb.min,Me=xi.aabb.max,[Ae,Oe]=wi.getOpacityForBounds(k,F[0],F[1],Me[0],Me[1]);Qr.overrideFog=Ae>=Sa||Oe>=Sa}}const To=Ji(Me,Ae.paint.get("model-cutoff-fade-range"));To.shouldRenderCutoff&&Qr.defines.push("RENDER_CUTOFF");const zo=Me.getOrCreateProgram("model",Qr);Me.uploadCommonUniforms(pt,zo,null,yo,To),"shadow"!==Me.renderPass&&mo&&mo.setupShadowsFromMatrix(F.nodeModelMatrix,zo),zo.draw(Me,pt.gl.TRIANGLES,vt,Fe,je,xi.material.doubleSided?Gi.disabled:Gi.backCCW,Jr,Ae.id,xi.vertexBuffer,xi.indexBuffer,xi.segments,Ae.paint,Me.transform.zoom,void 0,co)}function ya(F,Me,Ae,Oe,Fe,je,qe){let pt;pt="globe"===F.projection.name?k.dl(Ae,F):[...Ae],k.ab.mat4.multiply(pt,pt,Me.matrix);const vt=k.ab.mat4.multiply([],Oe,pt);if(Me.meshes)for(const F of Me.meshes){if("BLEND"!==F.material.alphaMode){qe.push({mesh:F,depth:0,modelIndex:Fe,worldViewProjection:vt,nodeModelMatrix:pt});continue}const Me=k.ab.vec3.transformMat4([],F.centroid,vt);Me[2]>0&&je.push({mesh:F,depth:Me[2],modelIndex:Fe,worldViewProjection:vt,nodeModelMatrix:pt})}if(Me.children)for(const k of Me.children)ya(F,k,Ae,Oe,Fe,je,qe)}function xa(k,F,Me,Ae){const Oe=Me.shadowRenderer;if(!Oe)return;const Fe=Oe.getShadowPassDepthMode(),je=Oe.getShadowPassColorMode(),qe=Oe.calculateShadowPassMatrixFromMatrix(F),pt=xr(qe);Me.getOrCreateProgram("modelDepth",{defines:Me._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(Me,Me.context.gl.TRIANGLES,Fe,Bi.disabled,je,Gi.backCCW,pt,Ae.id,k.vertexBuffer,k.indexBuffer,k.segments,Ae.paint,Me.transform.zoom,void 0,void 0)}function ba(F,Me,Ae){const Oe=Me.updateZoomBasedPaintProperties(),Fe=function(F,Me,Ae){let Oe,Fe,je,qe=F.terrain?F.terrain.exaggeration():0;if(F.terrain&&qe>0){const Me=F.terrain,Fe=Me.findDEMTileFor(Ae);Fe&&Fe.dem?Oe=k.dn.create(Me,Ae,Fe):qe=0}if(0===qe&&(Me.terrainElevationMin=0,Me.terrainElevationMax=0),qe===Me.validForExaggeration&&(0===qe||Oe&&Oe._demTile&&Oe._demTile.tileID===Me.validForDEMTile.id&&Oe._dem._timestamp===Me.validForDEMTile.timestamp))return!1;for(const k in Me.instancesPerModel){const F=Me.instancesPerModel[k];for(let k=0;k<F.instancedDataArray.length;++k){const Ae=(Oe?qe*Oe.getElevationAt(0|F.instancedDataArray.float32[16*k],0|F.instancedDataArray.float32[16*k+1],!0,!0):0)+F.instancesEvaluatedElevation[k];F.instancedDataArray.float32[16*k+6]=Ae,Fe=Fe?Math.min(Me.terrainElevationMin,Ae):Ae,je=je?Math.max(Me.terrainElevationMax,Ae):Ae}}return Me.terrainElevationMin=Fe||0,Me.terrainElevationMax=je||0,Me.validForExaggeration=qe,Me.validForDEMTile=Oe&&Oe._demTile?{id:Oe._demTile.tileID,timestamp:Oe._dem._timestamp}:{id:void 0,timestamp:0},!0}(F,Me,Ae);(Oe||Fe)&&(Me.uploaded=!1,Me.upload(F.context))}const wp={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new k.cd([0,0,0],[k.ag,k.ag,0])};function Ta(F,Me){const Ae=1<<F.canonical.z,Oe=Me.getFreeCameraOptions().position,Fe=Me.elevation,je=F.canonical.x/Ae,qe=(F.canonical.x+1)/Ae,pt=F.canonical.y/Ae,vt=(F.canonical.y+1)/Ae;let Ut=Me._centerAltitude;if(Fe){const k=Fe.getMinMaxForTile(F);k&&k.max>Ut&&(Ut=k.max)}const xi=k.aw(Oe.x,je,qe)-Oe.x,vi=k.aw(Oe.y,pt,vt)-Oe.y,bi=k.bH(Ut,Me.center.lat)-Oe.z;return Me._zoomFromMercatorZ(Math.sqrt(xi*xi+vi*vi+bi*bi))}function Ea(k,F,Me,Ae,Oe,Fe,je){const qe=k.context,pt="shadow"===k.renderPass,vt=k.shadowRenderer,Ut=pt&&vt?vt.getShadowPassDepthMode():new Fi(qe.gl.LEQUAL,Fi.ReadWrite,k.depthRangeFor3D),xi=k.isTileAffectedByFog(Fe);if(Me.meshes)for(const vi of Me.meshes){const bi=["MODEL_POSITION_ON_GPU"],wi=[];let Mi,pr,Ur;Ae.instancedDataArray.length>20&&bi.push("INSTANCED_ARRAYS");const Wr=Ji(k,F.paint.get("model-cutoff-fade-range"));if(Wr.shouldRenderCutoff&&bi.push("RENDER_CUTOFF"),pt&&vt)Mi=k.getOrCreateProgram("modelDepth",{defines:bi}),pr=xr(je.shadowTileMatrix,je.shadowTileMatrix,Float32Array.from(Me.matrix)),Ur=vt.getShadowPassColorMode();else{ga(bi,wi,vi,k,"none"===F.paint.get("model-color-use-theme").constantOr("default")?null:F.lut),Mi=k.getOrCreateProgram("model",{defines:bi,overrideFog:xi});const Ae=vi.material,pt=Ae.pbrMetallicRoughness,Ut=F.paint.get("model-opacity").constantOr(1),Jr=F.paint.get("model-emissive-strength").constantOr(0);pr=yr(Fe.expandedProjMatrix,Float32Array.from(Me.matrix),new Float32Array(16),null,k,Ut,pt.baseColorFactor.toRenderColor(null),Ae.emissiveFactor,pt.metallicFactor,pt.roughnessFactor,Ae,Jr,F,Oe),vt&&(je.shadowUniformsInitialized?Mi.setShadowUniformValues(qe,vt.getShadowUniformValues()):(vt.setupShadows(Fe.toUnwrapped(),Mi,"model-tile",Fe.overscaledZ),je.shadowUniformsInitialized=!0)),Ur=Wr.shouldRenderCutoff||Ut<1||"OPAQUE"!==Ae.alphaMode?Oi.alphaBlended:Oi.unblended}k.uploadCommonUniforms(qe,Mi,Fe.toUnwrapped(),null,Wr);const Jr=vi.material.doubleSided?Gi.disabled:Gi.backCCW;if(Ae.instancedDataArray.length>20)wi.push(Ae.instancedDataBuffer),Mi.draw(k,qe.gl.TRIANGLES,Ut,Bi.disabled,Ur,Jr,pr,F.id,vi.vertexBuffer,vi.indexBuffer,vi.segments,F.paint,k.transform.zoom,void 0,wi,Ae.instancedDataArray.length);else{const Me=pt?"u_instance":"u_normal_matrix";for(let Oe=0;Oe<Ae.instancedDataArray.length;++Oe)pr[Me]=new Float32Array(Ae.instancedDataArray.arrayBuffer,64*Oe,16),Mi.draw(k,qe.gl.TRIANGLES,Ut,Bi.disabled,Ur,Jr,pr,F.id,vi.vertexBuffer,vi.indexBuffer,vi.segments,F.paint,k.transform.zoom,void 0,wi)}}if(Me.children)for(const qe of Me.children)Ea(k,F,qe,Ae,Oe,Fe,je)}const Mp=[1,-1,1];function Ca(F,Me,Ae,Oe){if(!Ae.modelManager)return!0;const Fe=Ae.modelManager;if(!Ae.shadowRenderer)return!0;const je=Ae.shadowRenderer,qe=Me.aabb;let pt=!0,vt=F.maxHeight;if(0===vt){let k=0;for(const Me in F.instancesPerModel){const F=Fe.getModel(Me,Oe);F?k=Math.max(k,Math.max(Math.max(F.aabb.max[0],F.aabb.max[1]),F.aabb.max[2])):pt=!1}vt=F.maxScale*k*1.41+F.maxVerticalOffset,pt&&(F.maxHeight=vt)}qe.max[2]=vt,qe.min[2]+=F.terrainElevationMin,qe.max[2]+=F.terrainElevationMax,k.ab.vec3.transformMat4(qe.min,qe.min,Me.tileMatrix),k.ab.vec3.transformMat4(qe.max,qe.max,Me.tileMatrix);const Ut=qe.intersects(je.getCurrentCascadeFrustum());return 0===Ae.currentShadowCascade&&(F.isInsideFirstShadowMapFrustum=2===Ut),0===Ut}function Ia(F,Me){const Ae=F.uniformValues.u_cutoff_params[0],Oe=F.uniformValues.u_cutoff_params[1],Fe=F.uniformValues.u_cutoff_params[2],je=F.uniformValues.u_cutoff_params[3];return Oe===Ae||je===Fe?1:k.aw(((Me-Ae)/(Oe-Ae)-Fe)/(je-Fe),0,1)}function Ra(F,Me,Ae,Oe){if(Me.pitch<20)return 1;const Fe=Me.getWorldToCameraMatrix();k.ab.mat4.multiply(Fe,Fe,F);const je=k.ab.vec4.fromValues(Ae.min[0],Ae.min[1],Ae.min[2],1);let qe=k.ab.vec4.transformMat4(k.ab.vec4.create(),je,Fe),pt=qe,vt=qe;je[1]=Ae.max[1],qe=k.ab.vec4.transformMat4(k.ab.vec4.create(),je,Fe),pt=qe[1]<pt[1]?qe:pt,vt=qe[1]>vt[1]?qe:vt,je[0]=Ae.max[0],qe=k.ab.vec4.transformMat4(k.ab.vec4.create(),je,Fe),pt=qe[1]<pt[1]?qe:pt,vt=qe[1]>vt[1]?qe:vt,je[1]=Ae.min[1],qe=k.ab.vec4.transformMat4(k.ab.vec4.create(),je,Fe),pt=qe[1]<pt[1]?qe:pt,vt=qe[1]>vt[1]?qe:vt;const Ut=k.aw(Oe[0],0,1),xi=100*Me.pixelsPerMeter*k.aw(Oe[1],0,1),vi=k.aw(Oe[2],0,1),bi=k.ab.vec4.lerp(k.ab.vec4.create(),pt,vt,Ut),wi=Math.tan(.5*Me.fovX),Mi=-bi[2]*wi;if(0===xi)return bi[1]<-Math.abs(Mi)?vi:1;const pr=(-Math.abs(Mi)-bi[1])/xi,g=(k,F,Me)=>(1-Me)*k+Me*F,Ur=k.aw(g(1,vi,pr),vi,1);return g(1,Ur,k.aw((Me.pitch-20)/20,0,1))}class Da{}class La{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(F,Me,Ae){{const k=this._storage.get(Me.id);if(k)return k.lastUsedFrameIdx=F,k.buf}const Oe=Ae.gl,Fe=Oe.getBufferParameter(Oe.ELEMENT_ARRAY_BUFFER,Oe.BUFFER_SIZE),je=new ArrayBuffer(Fe),qe=new Int16Array(je);Oe.getBufferSubData(Oe.ELEMENT_ARRAY_BUFFER,0,new Int16Array(je));const pt=new k.dq;for(let k=0;k<Fe/2;k+=3){const F=qe[k],Me=qe[k+1],Ae=qe[k+2];pt.emplaceBack(F,Me),pt.emplaceBack(Me,Ae),pt.emplaceBack(Ae,F)}const vt=Ae.bindVertexArrayOES.current,Ut=new Da;return Ut.buf=new wr(Ae,pt),Ut.lastUsedFrameIdx=F,this._storage.set(Me.id,Ut),Ae.bindVertexArrayOES.set(vt),Ut.buf}update(k){for(const[F,Me]of this._storage)k-Me.lastUsedFrameIdx>30&&(Me.buf.destroy(),this._storage.delete(F))}destroy(){for(const[k,F]of this._storage)F.buf.destroy(),this._storage.delete(k)}}class Aa{constructor(k){this.occluderSize=30,this.depthOffset=-1e-4,k.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),k.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Ip=k.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Pa{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Ma{constructor(k,F){this.revealStart=11,this.revealRange=2,k.registerParameter(this,[...F,"Reveal"],"revealStart",{min:0,max:17,step:.05}),k.registerParameter(this,[...F,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const Cp=k.da([{type:"Float32",name:"a_pos_2f",components:2}]);class Fa{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(F,Me){const Ae=F.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const Me=new k.dr,Ae=new k.aU;Me.emplaceBack(-1,-1),Me.emplaceBack(1,-1),Me.emplaceBack(1,1),Me.emplaceBack(-1,1),Ae.emplaceBack(0,1,2),Ae.emplaceBack(0,2,3),this.vignetteVx=F.context.createVertexBuffer(Me,Cp.members),this.vignetteIdx=F.context.createIndexBuffer(Ae)}const Oe=k.b7.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){F.uploadCommonUniforms(F.context,Ae);const k={u_vignetteShape:(Fe={vignetteShape:[Me.start,Me.range,Math.pow(10,Me.fadePower)],vignetteColor:[Me.color.r,Me.color.g,Me.color.b,Me.color.a*Me.strength]}).vignetteShape,u_vignetteColor:Fe.vignetteColor};Ae.draw(F,F.context.gl.TRIANGLES,Fi.disabled,Bi.disabled,Oi.alphaBlended,Gi.disabled,k,"vignette",this.vignetteVx,this.vignetteIdx,Oe,{})}var Fe}}class ka{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(F,Me){const Ae=F.getFreeCameraOptions().position,Oe=Ae.toAltitude(),Fe=Ae.toLngLat(),je=k.ai(Fe.lng),qe=k.ai(Fe.lat),pt=F.pixelsPerMeter/Me,vt=je*k.ds,Ut=k.ds*Math.log(Math.tan(Math.PI/4+qe/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const k=-this._offsetYPrev+Ut,F=-this._elevationPrev+Oe;this._accumulatedOffsetX+=(-this._offsetXPrev+vt)*pt,this._accumulatedOffsetY+=k*pt,this._accumulatedElevation+=F*pt,this._offsetXPrev=vt,this._offsetYPrev=Ut,this._elevationPrev=Oe}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Ba(k,F){return[-(k[0]-Math.floor(k[0]/F)*F),-(k[1]-Math.floor(k[1]/F)*F),-(k[2]-Math.floor(k[2]/F)*F)]}function Na(F){const Me=k.di(1323123451230),Ae=[];for(let Oe=0;Oe<F;++Oe){const F=2*Me()-1,Oe=2*Me()-1,Fe=2*Me()-1;Ae.push(k.ab.vec3.fromValues(F,Oe,Fe))}return Ae}function Ua(F,Me,Ae,Oe,Fe){const je=k.aw((Fe-Ae)/(Oe-Ae),0,1);return(1-je)*F+je*Me}class Ga{constructor(k){this._movement=new ka,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Fa,this._ppmScaleFactor=k}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(F,Me){const Ae=F.transform;this._movement.update(Ae,this._ppmScaleFactor);const Oe=Ae.starsProjMatrix,Fe=k.ab.quat.identity([]);k.ab.quat.rotateX(Fe,Fe,k.ai(90)-Ae._pitch),k.ab.quat.rotateZ(Fe,Fe,-Ae.angle);const je=k.ab.mat4.fromQuat(new Float32Array(16),Fe),qe=k.ab.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),pt=k.ab.mat4.transpose([],qe),vt=k.ab.mat4.multiply([],pt,je),Ut=Date.now()/1e3;return this._accumulatedTimeFromStart+=(Ut-this._prevTime)*Me,this._prevTime=Ut,{projectionMatrix:Oe,modelviewMatrix:vt}}}class ja extends Ga{constructor(k){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Ma(k.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(F){const Me=F.context;if(!this.particlesVx){const F=Na(this.particlesCount),Ae=new k.dt,Oe=new k.aU;let Fe=0;const je=k.di(1323123451230);for(let k=0;k<F.length;++k){const Me=F[k],qe=[2*je()-1,je(),je(),je()];Ae.emplaceBack(Me[0],Me[1],Me[2],-1,-1,...qe),Ae.emplaceBack(Me[0],Me[1],Me[2],1,-1,...qe),Ae.emplaceBack(Me[0],Me[1],Me[2],1,1,...qe),Ae.emplaceBack(Me[0],Me[1],Me[2],-1,1,...qe),Oe.emplaceBack(Fe+0,Fe+1,Fe+2),Oe.emplaceBack(Fe+0,Fe+2,Fe+3),Fe+=4}this.particlesVx=Me.createVertexBuffer(Ae,Ip.members),this.particlesIdx=Me.createIndexBuffer(Oe)}}draw(F){if(!this._params.overrideStyleParameters&&!F.style.rain)return;const Me=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},Ae=F.transform.zoom;if(Me.revealStart>Ae)return;const Oe=Ua(0,1,Me.revealStart,Me.revealStart+Me.revealRange,Ae);if(!this.particlesVx||!this.particlesIdx)return;const Fe=structuredClone(this._params);let je=[-Fe.direction.x,Fe.direction.y,-100];k.ab.vec3.normalize(je,je);const qe=structuredClone(this._vignetteParams);qe.strength*=Oe,Fe.overrideStyleParameters||(Fe.intensity=F.style.rain.state.density,Fe.timeFactor=F.style.rain.state.intensity,Fe.color=structuredClone(F.style.rain.state.color),je=structuredClone(F.style.rain.state.direction),Fe.screenThinning.intensity=F.style.rain.state.centerThinning,Fe.dropletSizeX=F.style.rain.state.dropletSize[0],Fe.dropletSizeYScale=F.style.rain.state.dropletSize[1]/F.style.rain.state.dropletSize[0],Fe.distortionStrength=100*F.style.rain.state.distortionStrength,qe.strength=1,qe.color=structuredClone(F.style.rain.state.vignetteColor));const pt=this.updateOnRender(F,Fe.timeFactor),vt=F.context,Ut=vt.gl,xi=F.transform;this.screenTexture&&this.screenTexture.size[0]===F.width&&this.screenTexture.size[1]===F.height||(this.screenTexture=new k.T(vt,{width:F.width,height:F.height,data:null},Ut.RGBA8)),Fe.distortionStrength>0&&(vt.activeTexture.set(Ut.TEXTURE0),this.screenTexture.bind(Ut.LINEAR,Ut.CLAMP_TO_EDGE),Ut.copyTexSubImage2D(Ut.TEXTURE_2D,0,0,0,0,0,F.width,F.height));const vi=F.getOrCreateProgram("rainParticle");F.uploadCommonUniforms(vt,vi),vt.activeTexture.set(Ut.TEXTURE0),this.screenTexture.bind(Ut.LINEAR,Ut.CLAMP_TO_EDGE);const bi=[Fe.color.r,Fe.color.g,Fe.color.b,Fe.color.a],p=(Me,Ae)=>{const qe=Ba(this._movement.getPosition(),Me),vt=Fe.dropletSizeX,wi=Fe.dropletSizeX*Fe.dropletSizeYScale,Mi=F.width/2,pr=F.height/2,Ur=Ua(0,Fe.screenThinning.start,0,1,Fe.screenThinning.intensity),Wr=Ua(.001,Fe.screenThinning.range,0,1,Fe.screenThinning.intensity),Jr=Ua(0,Fe.screenThinning.particleOffset,0,1,Fe.screenThinning.intensity),Qr=(co={modelview:pt.modelviewMatrix,projection:pt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:qe,velocityConeAperture:Fe.velocityConeAperture,velocity:Fe.velocity,boxSize:Me,rainDropletSize:[vt,wi],distortionStrength:Fe.distortionStrength,rainDirection:je,color:bi,screenSize:[xi.width,xi.height],thinningCenterPos:[Mi,pr],thinningShape:[Ur,Wr,Math.pow(10,Fe.screenThinning.fadePower)],thinningAffectedRatio:Fe.screenThinning.affectedRatio,thinningParticleOffset:Jr,shapeDirectionalPower:Fe.shapeDirPower,shapeNormalPower:Fe.shapeNormalPower,mode:Ae?0:1},{u_modelview:Float32Array.from(co.modelview),u_projection:Float32Array.from(co.projection),u_time:co.time,u_cam_pos:co.camPos,u_texScreen:0,u_velocityConeAperture:co.velocityConeAperture,u_velocity:co.velocity,u_boxSize:co.boxSize,u_rainDropletSize:co.rainDropletSize,u_distortionStrength:co.distortionStrength,u_rainDirection:co.rainDirection,u_color:co.color,u_screenSize:co.screenSize,u_thinningCenterPos:co.thinningCenterPos,u_thinningShape:co.thinningShape,u_thinningAffectedRatio:co.thinningAffectedRatio,u_thinningParticleOffset:co.thinningParticleOffset,u_shapeDirectionalPower:co.shapeDirectionalPower,u_shapeNormalPower:co.shapeNormalPower,u_mode:co.mode});var co;const mo=Math.round(Oe*Fe.intensity*this.particlesCount),yo=k.b7.simpleSegment(0,0,4*mo,2*mo);vi.draw(F,Ut.TRIANGLES,Fi.disabled,Bi.disabled,Oi.alphaBlended,Gi.disabled,Qr,"rain_particles",this.particlesVx,this.particlesIdx,yo,{})};Fe.distortionStrength>0&&p(Fe.boxSize,!0),p(Fe.boxSize,!1),this._vignette.draw(F,qe)}}const Pp=k.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class qa extends Ga{constructor(k){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Ma(k.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(F){const Me=F.context;if(!this.particlesVx){const F=Na(this.particlesCount),Ae=new k.du,Oe=new k.aU;let Fe=0;const je=k.di(1323123451230);for(let k=0;k<F.length;++k){const Me=F[k],qe=je(),pt=je(),vt=je(),Ut=[k/F.length,qe,pt,vt],xi=[je(),je()];Ae.emplaceBack(Me[0],Me[1],Me[2],-1,-1,...Ut,...xi),Ae.emplaceBack(Me[0],Me[1],Me[2],1,-1,...Ut,...xi),Ae.emplaceBack(Me[0],Me[1],Me[2],1,1,...Ut,...xi),Ae.emplaceBack(Me[0],Me[1],Me[2],-1,1,...Ut,...xi),Oe.emplaceBack(Fe+0,Fe+1,Fe+2),Oe.emplaceBack(Fe+0,Fe+2,Fe+3),Fe+=4}this.particlesVx=Me.createVertexBuffer(Ae,Pp.members),this.particlesIdx=Me.createIndexBuffer(Oe)}}draw(F){if(!this._params.overrideStyleParameters&&!F.style.snow)return;const Me=structuredClone(this._params);let Ae=[-Me.direction.x,Me.direction.y,-100];k.ab.vec3.normalize(Ae,Ae);const Oe=structuredClone(this._vignetteParams),Fe=Me.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},je=F.transform.zoom;if(Fe.revealStart>je)return;const qe=Ua(0,1,Fe.revealStart,Fe.revealStart+Fe.revealRange,je);Oe.strength*=qe,Me.overrideStyleParameters||(Me.intensity=F.style.snow.state.density,Me.timeFactor=F.style.snow.state.intensity,Me.color=structuredClone(F.style.snow.state.color),Ae=structuredClone(F.style.snow.state.direction),Me.screenThinning.intensity=F.style.snow.state.centerThinning,Me.billboardSize=2.79*F.style.snow.state.flakeSize,Oe.strength=1,Oe.color=structuredClone(F.style.snow.state.vignetteColor));const pt=this.updateOnRender(F,Me.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const vt=F.context,Ut=vt.gl,xi=F.transform,vi=F.getOrCreateProgram("snowParticle");F.uploadCommonUniforms(vt,vi),((Me,Oe,Fe)=>{const je=Ba(this._movement.getPosition(),Me),vt=xi.width/2,bi=xi.height/2,wi=Ua(0,Fe.screenThinning.start,0,1,Fe.screenThinning.intensity),Mi=Ua(.001,Fe.screenThinning.range,0,1,Fe.screenThinning.intensity),pr=Ua(0,Fe.screenThinning.particleOffset,0,1,Fe.screenThinning.intensity),Ur=(Wr={modelview:pt.modelviewMatrix,projection:pt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:je,velocityConeAperture:Fe.velocityConeAperture,velocity:Fe.velocity,horizontalOscillationRadius:Fe.horizontalOscillationRadius,horizontalOscillationRate:Fe.horizontalOscillationRate,boxSize:Me,billboardSize:1*Fe.billboardSize,simpleShapeParameters:[Fe.shapeFadeStart,Fe.shapeFadePower],screenSize:[xi.width,xi.height],thinningCenterPos:[vt,bi],thinningShape:[wi,Mi,Math.pow(10,Fe.screenThinning.fadePower)],thinningAffectedRatio:Fe.screenThinning.affectedRatio,thinningParticleOffset:pr,color:[Fe.color.r,Fe.color.g,Fe.color.b,Fe.color.a],direction:Ae},{u_modelview:Float32Array.from(Wr.modelview),u_projection:Float32Array.from(Wr.projection),u_time:Wr.time,u_cam_pos:Wr.camPos,u_velocityConeAperture:Wr.velocityConeAperture,u_velocity:Wr.velocity,u_horizontalOscillationRadius:Wr.horizontalOscillationRadius,u_horizontalOscillationRate:Wr.horizontalOscillationRate,u_boxSize:Wr.boxSize,u_billboardSize:Wr.billboardSize,u_simpleShapeParameters:Wr.simpleShapeParameters,u_screenSize:Wr.screenSize,u_thinningCenterPos:Wr.thinningCenterPos,u_thinningShape:Wr.thinningShape,u_thinningAffectedRatio:Wr.thinningAffectedRatio,u_thinningParticleOffset:Wr.thinningParticleOffset,u_particleColor:Wr.color,u_direction:Wr.direction});var Wr;const Jr=Math.round(qe*Fe.intensity*this.particlesCount),Qr=k.b7.simpleSegment(0,0,4*Jr,2*Jr);this.particlesVx&&this.particlesIdx&&vi.draw(F,Ut.TRIANGLES,Fi.disabled,Bi.disabled,Oi.alphaBlended,Gi.disabled,Ur,"snow_particles",this.particlesVx,this.particlesIdx,Qr,{})})(Me.boxSize,0,Me),this._vignette.draw(F,Oe)}}const Rp={symbol:function(F,Me,Ae,Oe,Fe){if("translucent"!==F.renderPass)return;const je=Bi.disabled,qe=F.colorModeForRenderPass(),pt=Ae.layout.get("text-variable-anchor"),vt=Ae.layout.get("text-size-scale-range"),Ut=k.aw(F.scaleFactor,vt[0],vt[1]);pt&&function(F,Me,Ae,Oe,Fe,je,qe,pt){const vt=Me.transform,Ut="map"===Fe,xi="map"===je;for(const Me of F){const F=Oe.getTile(Me),Fe=F.getBucket(Ae);if(!Fe||!Fe.text||!Fe.text.segments.get().length)continue;const je=k.bp(Fe.textSizeData,vt.zoom,pt),vi=ni(Me,Fe.getProjection(),vt),bi=vt.calculatePixelsToTileUnitsMatrix(F),wi=jt(vi,F.tileID.canonical,xi,Ut,vt,Fe.getProjection(),bi),Mi=Fe.hasIconTextFit()&&Fe.hasIconData();if(je){const Ae=Math.pow(2,vt.zoom-F.tileID.overscaledZ);zr(Fe,Ut,xi,qe,k.cX,vt,wi,Me,Ae,je,Mi)}}}(Oe,F,Ae,Me,Ae.layout.get("text-rotation-alignment"),Ae.layout.get("text-pitch-alignment"),Fe,Ut);const xi=0!==Ae.paint.get("icon-opacity").constantOr(1),vi=0!==Ae.paint.get("text-opacity").constantOr(1);void 0!==Ae.layout.get("symbol-sort-key").constantOr(1)&&(xi||vi)?Pr(F,Me,Ae,Oe,je,qe):(xi&&Pr(F,Me,Ae,Oe,je,qe,{onlyIcons:!0}),vi&&Pr(F,Me,Ae,Oe,je,qe,{onlyText:!0})),Me.map.showCollisionBoxes&&(Rr(F,Me,Ae,Oe,Ae.paint.get("text-translate"),Ae.paint.get("text-translate-anchor"),!0),Rr(F,Me,Ae,Oe,Ae.paint.get("icon-translate"),Ae.paint.get("icon-translate-anchor"),!1))},circle:function(F,Me,Ae,Oe){if("translucent"!==F.renderPass)return;const Fe=Ae.paint.get("circle-opacity"),je=Ae.paint.get("circle-stroke-width"),qe=Ae.paint.get("circle-stroke-opacity"),pt=void 0!==Ae.layout.get("circle-sort-key").constantOr(1),vt=Ae.paint.get("circle-emissive-strength");if(0===Fe.constantOr(1)&&(0===je.constantOr(1)||0===qe.constantOr(1)))return;const Ut=F.context,xi=Ut.gl,vi=F.transform,bi=F.depthModeForSublayer(0,Fi.ReadOnly),wi=Bi.disabled,Mi=F.colorModeForDrapableLayerRenderPass(vt),pr="globe"===vi.projection.name,Ur=[k.at(vi.center.lng),k.aA(vi.center.lat)],Wr=[];for(let Fe=0;Fe<Oe.length;Fe++){const je=Oe[Fe],qe=Me.getTile(je),vt=qe.getBucket(Ae);if(!vt||vt.projection.name!==vi.projection.name)continue;const Ut=vt.programConfigurations.get(Ae.id),xi=k.cY(Ae),bi=F.isTileAffectedByFog(je);pr&&xi.push("PROJECTION_GLOBE_VIEW"),xi.push("DEPTH_D24"),F.terrain&&vi.depthOcclusionForSymbolsAndCircles&&xi.push("DEPTH_OCCLUSION");const wi=F.getOrCreateProgram("circle",{config:Ut,defines:xi,overrideFog:bi}),Mi=vt.layoutVertexBuffer,Jr=vt.globeExtVertexBuffer,Qr=vt.indexBuffer,co=vi.projection.createInversionMatrix(vi,je.canonical),mo={programConfiguration:Ut,program:wi,layoutVertexBuffer:Mi,globeExtVertexBuffer:Jr,indexBuffer:Qr,uniformValues:k.cZ(F,je,qe,co,Ur,Ae),tile:qe};if(pt){const F=vt.segments.get();for(const Me of F)Wr.push({segments:new k.b7([Me]),sortKey:Me.sortKey,state:mo})}else Wr.push({segments:vt.segments,sortKey:0,state:mo})}pt&&Wr.sort(((k,F)=>k.sortKey-F.sortKey));const Jr={useDepthForOcclusion:vi.depthOcclusionForSymbolsAndCircles};for(const k of Wr){const{programConfiguration:Me,program:Oe,layoutVertexBuffer:Fe,globeExtVertexBuffer:je,indexBuffer:qe,uniformValues:pt,tile:vt}=k.state,pr=k.segments;F.terrain&&F.terrain.setupElevationDraw(vt,Oe,Jr),F.uploadCommonUniforms(Ut,Oe,vt.tileID.toUnwrapped()),Oe.draw(F,xi.TRIANGLES,bi,wi,Mi,Gi.disabled,pt,Ae.id,Fe,qe,pr,Ae.paint,vi.zoom,Me,[je])}},heatmap:function(F,Me,Ae,Oe){if(0!==Ae.paint.get("heatmap-opacity"))if("offscreen"===F.renderPass){const Fe=F.context,je=Fe.gl,qe=Bi.disabled,pt=new Oi([je.ONE,je.ONE,je.ONE,je.ONE],k.aj.transparent,[!0,!0,!0,!0]);!function(k,F,Me,Ae){const Oe=k.gl,Fe=F.width*Ae,je=F.height*Ae;k.activeTexture.set(Oe.TEXTURE1),k.viewport.set([0,0,Fe,je]);let qe=Me.heatmapFbo;if(!qe||qe&&(qe.width!==Fe||qe.height!==je)){qe&&qe.destroy();const F=Oe.createTexture();Oe.bindTexture(Oe.TEXTURE_2D,F),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_WRAP_S,Oe.CLAMP_TO_EDGE),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_WRAP_T,Oe.CLAMP_TO_EDGE),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_MIN_FILTER,Oe.LINEAR),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_MAG_FILTER,Oe.LINEAR),qe=Me.heatmapFbo=k.createFramebuffer(Fe,je,!0,null),function(k,F,Me,Ae,Oe,Fe){const je=k.gl;je.texImage2D(je.TEXTURE_2D,0,k.extRenderToTextureHalfFloat?je.RGBA16F:je.RGBA,Oe,Fe,0,je.RGBA,k.extRenderToTextureHalfFloat?je.HALF_FLOAT:je.UNSIGNED_BYTE,null),Ae.colorAttachment.set(Me)}(k,0,F,qe,Fe,je)}else Oe.bindTexture(Oe.TEXTURE_2D,qe.colorAttachment.get()),k.bindFramebuffer.set(qe.framebuffer)}(Fe,F,Ae,"globe"===F.transform.projection.name?.5:.25),Fe.clear({color:k.aj.transparent});const vt=F.transform,Ut="globe"===vt.projection.name,xi=Ut?["PROJECTION_GLOBE_VIEW"]:[],vi=Ut?Gi.frontCCW:Gi.disabled,bi=[k.at(vt.center.lng),k.aA(vt.center.lat)];for(let k=0;k<Oe.length;k++){const wi=Oe[k];if(Me.hasRenderableParent(wi))continue;const Mi=Me.getTile(wi),pr=Mi.getBucket(Ae);if(!pr||pr.projection.name!==vt.projection.name)continue;const Ur=F.isTileAffectedByFog(wi),Wr=pr.programConfigurations.get(Ae.id),Jr=F.getOrCreateProgram("heatmap",{config:Wr,defines:xi,overrideFog:Ur}),{zoom:Qr}=F.transform;F.terrain&&F.terrain.setupElevationDraw(Mi,Jr),F.uploadCommonUniforms(Fe,Jr,wi.toUnwrapped());const co=vt.projection.createInversionMatrix(vt,wi.canonical);Jr.draw(F,je.TRIANGLES,Fi.disabled,qe,pt,vi,rr(F,wi,Mi,co,bi,Qr,Ae.paint.get("heatmap-intensity")),Ae.id,pr.layoutVertexBuffer,pr.indexBuffer,pr.segments,Ae.paint,F.transform.zoom,Wr,Ut?[pr.globeExtVertexBuffer]:null)}Fe.viewport.set([0,0,F.width,F.height])}else"translucent"===F.renderPass&&(F.context.setColorMode(F.colorModeForRenderPass()),function(F,Me){const Ae=F.context,Oe=Ae.gl,Fe=Me.heatmapFbo;if(!Fe)return;Ae.activeTexture.set(Oe.TEXTURE0),Oe.bindTexture(Oe.TEXTURE_2D,Fe.colorAttachment.get()),Ae.activeTexture.set(Oe.TEXTURE1);let je=Me.colorRampTexture;je||(je=Me.colorRampTexture=new k.T(Ae,Me.colorRamp,Oe.RGBA8)),je.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),F.getOrCreateProgram("heatmapTexture").draw(F,Oe.TRIANGLES,Fi.disabled,Bi.disabled,F.colorModeForRenderPass(),Gi.disabled,((k,F,Me,Ae)=>({u_image:0,u_color_ramp:1,u_opacity:F.paint.get("heatmap-opacity")}))(0,Me),Me.id,F.viewportBuffer,F.quadTriangleIndexBuffer,F.viewportSegments,Me.paint,F.transform.zoom)}(F,Ae))},line:function(F,Me,Ae,Oe){if("translucent"!==F.renderPass)return;const Fe=Ae.paint.get("line-opacity"),je=Ae.paint.get("line-width");if(0===Fe.constantOr(1)||0===je.constantOr(1))return;const qe=Ae.paint.get("line-emissive-strength"),pt=Ae.paint.get("line-occlusion-opacity"),vt=Ae.layout.get("line-elevation-reference"),Ut="meters"===Ae.layout.get("line-width-unit"),xi="sea"===vt,vi=F.context,bi=vi.gl,wi=!Ae.isDraped();if(wi&&"globe"===F.transform.projection.name)return;const Mi=Ae.layout.get("line-cross-slope"),pr=void 0!==Mi,Ur=Mi<1,Wr=wi?new Fi(F.depthOcclusion?bi.GREATER:bi.LEQUAL,Fi.ReadOnly,F.depthRangeFor3D):F.depthModeForSublayer(0,Fi.ReadOnly),Jr=F.colorModeForDrapableLayerRenderPass(qe),Qr=F.terrain&&F.terrain.renderingToTexture,co=Qr?1:k.q.devicePixelRatio,mo=Ae.paint.get("line-dasharray"),yo=mo.constantOr(1),To=Ae.layout.get("line-cap"),zo=mo.constantOr(null),ko=To.constantOr(null),na=Ae.paint.get("line-pattern"),aa=na.constantOr(1),_a=na.constantOr(null),wa=Ae.paint.get("line-opacity").constantOr(1);let Sa=!aa&&1!==wa||F.depthOcclusion&&pt>0&&pt<1;const Ya=Ae.paint.get("line-gradient"),rl=aa?"linePattern":"line",sl=k.c_(Ae);let ml;if(Qr&&F.terrain&&F.terrain.clipOrMaskOverlapStencilType()&&(Sa=!1),0!==pt&&F.depthOcclusion){const F=Ae.paint._values["line-opacity"];F&&F.value&&"constant"===F.value.kind?ml=F.value:k.w(`Occlusion opacity for layer ${Ae.id} is supported only when line-opacity isn't data-driven.`)}if(wi&&(F.forceTerrainMode=!0),!wi&&0!==pt&&F.terrain&&!Qr)return void k.w(`Occlusion opacity for layer ${Ae.id} is supported on terrain only if the layer has line-z-offset enabled.`);const Sl=Sa&&wi?F.stencilModeFor3D():Bi.disabled;wi&&(sl.push("ELEVATED"),pr&&sl.push(Ur?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),xi&&sl.push("ELEVATION_REFERENCE_SEA")),"constant"!==je.value.kind&&!1===je.value.isLineProgressConstant&&sl.push("VARIABLE_LINE_WIDTH");for(const Fe of Oe){const Oe=Me.getTile(Fe);if(aa&&!Oe.patternsLoaded())continue;const je=Oe.getBucket(Ae);if(!je)continue;F.prepareDrawTile();const qe=je.programConfigurations.get(Ae.id),vt=F.isTileAffectedByFog(Fe),Mi=F.getOrCreateProgram(rl,{config:qe,defines:sl,overrideFog:vt,overrideRtt:!wi&&void 0});if(_a&&Oe.imageAtlas){const F=k.A.from(_a),Me=Oe.imageAtlas.patternPositions[F.getSerializedPrimary()];Me&&qe.setConstantPatternPositions(Me)}if(!aa&&zo&&ko&&Oe.lineAtlas){const k=Oe.lineAtlas.getDash(zo,ko);k&&qe.setConstantPatternPositions(k)}let[pr,Ur]=Ae.paint.get("line-trim-offset");if("round"===ko||"square"===ko){const k=1;pr!==Ur&&(0===pr&&(pr-=k),1===Ur&&(Ur+=k))}const mo=Qr?Fe.projMatrix:null,To=Ut?1/je.tileToMeter/k.ar(Oe,1,F.transform.zoom):1,na=Ut?1/je.tileToMeter/k.ar(Oe,1,Math.floor(F.transform.zoom)):1,Il=aa?k.c$(F,Oe,Ae,mo,co,To,na,[pr,Ur]):k.d0(F,Oe,Ae,mo,je.lineClipsArray.length,co,To,na,[pr,Ur]);if(Ya){const Oe=je.gradients[Ae.id];let qe=Oe.texture;if(Ae.gradientVersion!==Oe.version){let pt=256;if(Ae.stepInterpolant){const Ae=Me.getSource().maxzoom,Oe=Fe.canonical.z===Ae?Math.ceil(1<<F.transform.maxZoom-Fe.canonical.z):1;pt=k.aw(k.d1(je.maxLineLength/k.ag*1024*Oe),256,vi.maxTextureSize)}Oe.gradient=k.d2({expression:Ae.gradientExpression(),evaluationKey:"lineProgress",resolution:pt,image:Oe.gradient||void 0,clips:je.lineClipsArray}),Oe.texture?Oe.texture.update(Oe.gradient):Oe.texture=new k.T(vi,Oe.gradient,bi.RGBA8),Oe.version=Ae.gradientVersion,qe=Oe.texture}vi.activeTexture.set(bi.TEXTURE1),qe.bind(Ae.stepInterpolant?bi.NEAREST:bi.LINEAR,bi.CLAMP_TO_EDGE)}yo&&(vi.activeTexture.set(bi.TEXTURE0),Oe.lineAtlasTexture&&Oe.lineAtlasTexture.bind(bi.LINEAR,bi.REPEAT),qe.updatePaintBuffers()),aa&&(vi.activeTexture.set(bi.TEXTURE0),Oe.imageAtlasTexture&&Oe.imageAtlasTexture.bind(bi.LINEAR,bi.CLAMP_TO_EDGE),qe.updatePaintBuffers()),wi&&!xi&&F.terrain.setupElevationDraw(Oe,Mi),F.uploadCommonUniforms(vi,Mi,Fe.toUnwrapped());const B=k=>{null!=ml&&(ml.value=wa*pt),Mi.draw(F,bi.TRIANGLES,Wr,k,Jr,Gi.disabled,Il,Ae.id,je.layoutVertexBuffer,je.indexBuffer,je.segments,Ae.paint,F.transform.zoom,qe,[je.layoutVertexBuffer2,je.patternVertexBuffer,je.zOffsetVertexBuffer]),null!=ml&&(ml.value=wa)};if(Sa&&!wi){const k=F.stencilModeForClipping(Fe).ref;0===k&&Qr&&vi.clear({stencil:0});const Me={func:bi.EQUAL,mask:255};Il.u_alpha_discard_threshold=.8,B(new Bi(Me,k,255,bi.KEEP,bi.KEEP,bi.INVERT)),Il.u_alpha_discard_threshold=0,B(new Bi(Me,k,255,bi.KEEP,bi.KEEP,bi.KEEP))}else Sa&&wi&&(Il.u_alpha_discard_threshold=.001),B(wi?Sl:F.stencilModeForClipping(Fe))}wi&&(F.forceTerrainMode=!1),Sa&&(F.resetStencilClippingMasks(),Qr&&vi.clear({stencil:0})),0===pt||F.depthOcclusion||Qr||F.layersWithOcclusionOpacity.push(F.currentLayer)},fill:function(F,Me,Ae,Oe){const Fe=Ae.paint.get("fill-color"),je=Ae.paint.get("fill-opacity"),qe=Ae.is3D(),pt=new Fi(F.context.gl.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D);if(0===je.constantOr(1))return;const vt=Ae.paint.get("fill-emissive-strength"),Ut=F.colorModeForDrapableLayerRenderPass(vt),xi=Ae.paint.get("fill-pattern"),vi=F.opaquePassEnabledForLayer()&&!xi.constantOr(1)&&1===Fe.constantOr(k.aj.transparent).a&&1===je.constantOr(0)?"opaque":"translucent";if(F.renderPass===vi){const k=qe?pt:F.depthModeForSublayer(1,"opaque"===F.renderPass?Fi.ReadWrite:Fi.ReadOnly);Or(F,Me,Ae,Oe,k,Ut,!1)}if(!qe&&"translucent"===F.renderPass&&Ae.paint.get("fill-antialias")){const k=qe?pt:F.depthModeForSublayer(Ae.getPaintProperty("fill-outline-color")?2:0,Fi.ReadOnly);Or(F,Me,Ae,Oe,k,Ut,!0)}},"fill-extrusion":function(F,Me,Ae,Oe){const Fe=Ae.paint.get("fill-extrusion-opacity"),je=F.context,qe=je.gl,pt=F.terrain,vt=pt&&pt.renderingToTexture;if(0===Fe)return;const Ut=F.conflationActive&&F.style.isLayerClipped(Ae,Me.getSource()),xi=F.style.order.indexOf(Ae.fqid);if(Ut&&function(k,F,Me,Ae,Oe){for(const Fe of Ae){const Ae=F.getTile(Fe).getBucket(Me);Ae&&(Ae.updateReplacement(Fe,k.replacementSource,Oe),Ae.uploadCentroid(k.context))}}(F,Me,Ae,Oe,xi),pt||Ut)for(const k of Oe){const Oe=Me.getTile(k).getBucket(Ae);Oe&&Br(F.context,Me,k,Oe,Ae,pt,Ut)}if("shadow"===F.renderPass&&F.shadowRenderer){const je=F.shadowRenderer;if(pt&&Fe<.65&&Ae._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof k.a9)return;const qe=je.getShadowPassDepthMode(),vt=je.getShadowPassColorMode();Fr(F,Me,Ae,Oe,qe,Bi.disabled,vt,Ut)}else if("translucent"===F.renderPass){const xi=!Ae.paint.get("fill-extrusion-pattern").constantOr(1),vi=Ae.paint.get("fill-extrusion-color").constantOr(k.aj.white);if(!vt&&0!==vi.a){const k=new Fi(F.context.gl.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D);1===Fe&&xi?Fr(F,Me,Ae,Oe,k,Bi.disabled,Oi.unblended,Ut):(Fr(F,Me,Ae,Oe,k,Bi.disabled,Oi.disabled,Ut),Fr(F,Me,Ae,Oe,k,F.stencilModeFor3D(),F.colorModeForRenderPass(),Ut),F.resetStencilClippingMasks())}if(F.style.enable3dLights()&&xi&&(!pt&&"globe"!==F.transform.projection.name||vt)){const Fe=Ae.paint.get("fill-extrusion-opacity"),xi=Ae.paint.get("fill-extrusion-ambient-occlusion-intensity"),vi=Ae.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),bi=Ae.paint.get("fill-extrusion-flood-light-intensity"),wi="none"===Ae.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Mi=Ae.paint.get("fill-extrusion-flood-light-color").toRenderColor(wi?null:Ae.lut).toArray01().slice(0,3),pr=xi>0&&vi>0,Ur=bi>0,v=(k,F,Me)=>(1-Me)*k+Me*F,y=je=>{const pt=F.depthModeForSublayer(1,Fi.ReadOnly,qe.LEQUAL,!0),vt=Ae.paint.get(je?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),wi=v(.1,3,vt),pr=F._showOverdrawInspector;if(!pr){const vt=new Bi({func:qe.ALWAYS,mask:255},255,255,qe.KEEP,qe.KEEP,qe.REPLACE),pr=new Oi([qe.ONE,qe.ONE,qe.ONE,qe.ONE],k.aj.transparent,[!1,!1,!1,!0],qe.MIN);kr(F,Me,Ae,Oe,pt,vt,pr,Gi.disabled,je,"sdf",Fe,xi,vi,bi,Mi,wi,Ut,!1)}{const vt=pr?Bi.disabled:new Bi({func:qe.EQUAL,mask:255},255,255,qe.KEEP,qe.DECR,qe.DECR),Ur=pr?F.colorModeForRenderPass():new Oi([qe.ONE_MINUS_DST_ALPHA,qe.DST_ALPHA,qe.ONE,qe.ONE],k.aj.transparent,[!0,!0,!0,!0]);kr(F,Me,Ae,Oe,pt,vt,Ur,Gi.disabled,je,"color",Fe,xi,vi,bi,Mi,wi,Ut,!1)}};if(vt){const c=(je,pt,vt)=>{const wi=F.depthModeForSublayer(1,Fi.ReadOnly,qe.LEQUAL,!1),pr=Ae.paint.get(je?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ur=v(.1,3,pr);{const vt=new Oi([qe.ONE,qe.ONE,qe.ONE,qe.ONE],k.aj.transparent,[!1,!1,!1,!0]);kr(F,Me,Ae,Oe,wi,Bi.disabled,vt,Gi.disabled,je,"clear",Fe,xi,vi,bi,Mi,Ur,Ut,pt)}{const vt=new Bi({func:qe.ALWAYS,mask:255},255,255,qe.KEEP,qe.KEEP,qe.REPLACE),pr=new Oi([qe.ONE,qe.ONE,qe.ONE,qe.ONE],k.aj.transparent,[!1,!1,!1,!0],qe.MIN);kr(F,Me,Ae,Oe,wi,vt,pr,Gi.disabled,je,"sdf",Fe,xi,vi,bi,Mi,Ur,Ut,pt)}{const vt=je?qe.ZERO:qe.ONE_MINUS_DST_ALPHA,pr=new Bi({func:qe.EQUAL,mask:255},255,255,qe.KEEP,qe.DECR,qe.DECR),Wr=new Oi([vt,qe.DST_ALPHA,qe.ONE_MINUS_DST_ALPHA,qe.ZERO],k.aj.transparent,[!0,!0,!0,!0]);kr(F,Me,Ae,Oe,wi,pr,Wr,Gi.disabled,je,"color",Fe,xi,vi,bi,Mi,Ur,Ut,pt)}{const pr=new Oi([qe.ONE,qe.ONE,qe.ONE,je?qe.ZERO:qe.ONE],k.aj.transparent,[!1,!1,!1,!0],je?qe.FUNC_ADD:qe.MAX);kr(F,Me,Ae,Oe,wi,Bi.disabled,pr,Gi.disabled,je,"clear",Fe,xi,vi,bi,Mi,Ur,Ut,pt,vt)}};if(pr||Ur){let Me;if(F.prepareDrawTile(),pt){const F=pt.drapeBufferSize[0],Ae=pt.drapeBufferSize[1];Me=pt.framebufferCopyTexture,Me&&(!Me||Me.size[0]===F&&Me.size[1]===Ae)||(Me&&Me.destroy(),Me=pt.framebufferCopyTexture=new k.T(je,new k.r({width:F,height:Ae}),qe.RGBA8)),Me.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),qe.copyTexSubImage2D(qe.TEXTURE_2D,0,0,0,0,0,F,Ae)}pr&&c(!0,!1,Me),Ur&&c(!1,!0,Me)}}else pr&&y(!0),Ur&&y(!1),(pr||Ur)&&F.resetStencilClippingMasks()}}},hillshade:function(k,F,Me,Ae){if("offscreen"!==k.renderPass&&"translucent"!==k.renderPass)return;if(k.style.disableElevatedTerrain)return;const Oe=k.context,Fe=k.terrain&&k.terrain.renderingToTexture,[je,qe]="translucent"!==k.renderPass||Fe?[{},Ae]:k.stencilConfigForOverlap(Ae);for(const Ae of qe){const Oe=F.getTile(Ae);if(Oe.needsHillshadePrepare&&"offscreen"===k.renderPass)Ho(k,Oe,Me);else if("translucent"===k.renderPass){const F=k.depthModeForSublayer(0,Fi.ReadOnly),qe=Me.paint.get("hillshade-emissive-strength"),pt=k.colorModeForDrapableLayerRenderPass(qe),vt=Fe&&k.terrain?k.terrain.stencilModeForRTTOverlap(Ae):je[Ae.overscaledZ];Vo(k,Ae,Oe,Me,F,vt,pt)}}Oe.viewport.set([0,0,k.width,k.height]),k.resetStencilClippingMasks()},raster:function(F,Me,Ae,Oe,Fe,je){if("translucent"!==F.renderPass)return;if(0===Ae.paint.get("raster-opacity"))return;const qe="globe"===F.transform.projection.name,pt=0!==Ae.paint.get("raster-elevation"),vt=pt&&qe;if(F.renderElevatedRasterBackface&&!vt)return;const Ut=F.context,xi=Ut.gl,vi=Me.getSource(),bi=function(F,Me,Ae,Oe){const Fe=Me.paint.get("raster-color"),je="raster-array"===F.type,qe=[],pt=Me.paint.get("raster-resampling"),vt=Me.paint.get("raster-color-mix");let Ut=Me.paint.get("raster-color-range");const xi=[vt[0],vt[1],vt[2],0],vi=vt[3];let bi="nearest"===pt?Oe.NEAREST:Oe.LINEAR;if(je&&(qe.push("RASTER_ARRAY"),Fe||qe.push("RASTER_COLOR"),"linear"===pt&&qe.push("RASTER_ARRAY_LINEAR"),bi=Oe.NEAREST,!Ut&&F.rasterLayers)){const k=F.rasterLayers.find((({id:k})=>k===Me.sourceLayer));k&&k.fields&&k.fields.range&&(Ut=k.fields.range)}if(Ut=Ut||[0,1],Fe){qe.push("RASTER_COLOR"),Ae.activeTexture.set(Oe.TEXTURE2),Me.updateColorRamp(Ut);let F=Me.colorRampTexture;F||(F=Me.colorRampTexture=new k.T(Ae,Me.colorRamp,Oe.RGBA8)),F.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE)}return{mix:xi,range:Ut,offset:vi,defines:qe,resampling:bi}}(vi,Ae,Ut,xi);if(vi instanceof k.aJ&&!Oe.length&&!qe)return;const wi=Ae.paint.get("raster-emissive-strength"),Mi=F.colorModeForDrapableLayerRenderPass(wi),pr=F.terrain&&F.terrain.renderingToTexture,Ur=!F.options.moving,Wr="nearest"===Ae.paint.get("raster-resampling")?xi.NEAREST:xi.LINEAR;if(vi instanceof k.aJ&&!Oe.length&&(vi.onNorthPole||vi.onSouthPole)){const k=pt?F.stencilModeFor3D():Bi.disabled;return void qr(!!vi.onNorthPole,null,F,Me,Ae,wi,bi,Gi.disabled,k)}if(!Oe.length)return;const[Jr,Qr]=vi instanceof k.aJ||pr?[{},Oe]:F.stencilConfigForOverlap(Oe),co=Qr[Qr.length-1].overscaledZ;vt&&bi.defines.push("PROJECTION_GLOBE_VIEW"),pt&&bi.defines.push("RENDER_CUTOFF");const w=(Oe,Fe,Qr)=>{for(const mo of Oe){const Oe=mo.toUnwrapped(),yo=Me.getTile(mo);if(pr&&(!yo||!yo.hasData()))continue;Ut.activeTexture.set(xi.TEXTURE0);const To=Zr(yo,vi,Ae,bi);if(!To||!To.texture)continue;const{texture:zo,mix:ko,offset:na,tileSize:aa,buffer:_a}=To;let wa,Sa;pr?(wa=Fi.disabled,Sa=mo.projMatrix):pt?(wa=new Fi(xi.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D),Sa=qe?Float32Array.from(F.transform.expandedFarZProjMatrix):F.transform.calculateProjMatrix(Oe,Ur)):(wa=F.depthModeForSublayer(mo.overscaledZ-co,1===Ae.paint.get("raster-opacity")?Fi.ReadWrite:Fi.ReadOnly,xi.LESS),Sa=F.transform.calculateProjMatrix(Oe,Ur));const Ya=F.terrain&&pr?F.terrain.stencilModeForRTTOverlap(mo):Jr[mo.overscaledZ],rl=je?0:Ae.paint.get("raster-fade-duration");yo.registerFadeDuration(rl);const sl=Me.findLoadedParent(mo,0),ml=ks(yo,sl,Me,F.transform,rl);let Sl,Il;F.terrain&&F.terrain.prepareDrawTile(),Ut.activeTexture.set(xi.TEXTURE0),zo.bind(Wr,xi.CLAMP_TO_EDGE),Ut.activeTexture.set(xi.TEXTURE1),sl?(sl.texture&&sl.texture.bind(Wr,xi.CLAMP_TO_EDGE),Sl=Math.pow(2,sl.tileID.overscaledZ-yo.tileID.overscaledZ),Il=[yo.tileID.canonical.x*Sl%1,yo.tileID.canonical.y*Sl%1]):zo.bind(Wr,xi.CLAMP_TO_EDGE),zo.useMipmap&&Ut.extTextureFilterAnisotropic&&F.transform.pitch>20&&xi.texParameterf(xi.TEXTURE_2D,Ut.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Ut.extTextureFilterAnisotropicMax);const Kl=F.transform;let Jl;const Ql=pt?Hr(Kl):[0,0,0,0];let ec,tc,cc,uc,jc,Gc=0;if(vt&&vi instanceof k.aJ&&vi.coordinates.length>3)ec=Float32Array.from(k.bb(k.cH(new k.bT(0,0,0)))),tc=Float32Array.from(Kl.globeMatrix),cc=Float32Array.from(k.cD(Kl)),uc=[k.at(Kl.center.lng),k.aA(Kl.center.lat)],Jl=vi.elevatedGlobePerspectiveTransform,jc=vi.elevatedGlobeGridMatrix||new Float32Array(9);else if(vt){const F=k.cE(mo.canonical);Gc=k.cF(F.getCenter().lat),ec=Float32Array.from(k.bb(k.cH(mo.canonical))),tc=Float32Array.from(Kl.globeMatrix),cc=Float32Array.from(k.cD(Kl)),uc=[k.at(Kl.center.lng),k.aA(Kl.center.lat)],Jl=[0,0],jc=Float32Array.from(k.cG(mo.canonical,F,Gc,Kl.worldSize/Kl._pixelsPerMercatorPixel))}else Jl=vi instanceof k.aJ?vi.perspectiveTransform:[0,0],ec=new Float32Array(16),tc=new Float32Array(9),cc=new Float32Array(16),uc=[0,0],jc=new Float32Array(9);const qc=lr(Sa,ec,tc,cc,jc,Il||[0,0],k.ae(F.transform.zoom),uc,Ql,Sl||1,ml,Ae,Jl,pt?Ae.paint.get("raster-elevation"):0,2,ko,na,bi.range,aa,_a,wi),Hc=F.isTileAffectedByFog(mo),$c=F.getOrCreateProgram("raster",{defines:bi.defines,overrideFog:Hc});if(F.uploadCommonUniforms(Ut,$c,Oe),vi instanceof k.aJ){const Me=vi.elevatedGlobeVertexBuffer,Oe=vi.elevatedGlobeIndexBuffer;if(pr||!qe)vi.boundsBuffer&&vi.boundsSegments&&$c.draw(F,xi.TRIANGLES,wa,Bi.disabled,Mi,Gi.disabled,qc,Ae.id,vi.boundsBuffer,F.quadTriangleIndexBuffer,vi.boundsSegments);else if(Me&&Oe){const je=Kl.zoom<=k.c6?vi.elevatedGlobeSegments:vi.getSegmentsForLongitude(Kl.center.lng);je&&$c.draw(F,xi.TRIANGLES,wa,Bi.disabled,Mi,Fe,qc,Ae.id,Me,Oe,je)}}else if(vt){wa=new Fi(xi.LEQUAL,Fi.ReadOnly,F.depthRangeFor3D);const k=F.globeSharedBuffers;if(k){const[Me,Oe,je]=k.getGridBuffers(Gc,!1);$c.draw(F,xi.TRIANGLES,wa,Qr||Ya,F.colorModeForRenderPass(),Fe,qc,Ae.id,Me,Oe,je)}}else{const{tileBoundsBuffer:k,tileBoundsIndexBuffer:Me,tileBoundsSegments:Oe}=F.getTileBoundsBuffers(yo);$c.draw(F,xi.TRIANGLES,wa,Ya,Mi,Gi.disabled,qc,Ae.id,k,Me,Oe)}}if(!(vi instanceof k.aJ)&&vt)for(const k of Oe){const Oe=k.canonical.y===(1<<k.canonical.z)-1;0===k.canonical.y&&qr(!0,k,F,Me,Ae,wi,bi,Fe,Qr||Bi.disabled),Oe&&qr(!1,k,F,Me,Ae,wi,bi,Fe===Gi.frontCW?Gi.backCW:Gi.frontCW,Qr||Bi.disabled)}};vt?w(Qr,F.renderElevatedRasterBackface?Gi.backCW:Gi.frontCW,F.stencilModeFor3D()):w(Qr,Gi.disabled,void 0),F.resetStencilClippingMasks()},"raster-particle":function(F,Me,Ae,Oe,Fe,je){"offscreen"===F.renderPass&&function(F,Me,Ae,Oe){if(!Oe.length)return;const Fe=F.context,je=Fe.gl,qe=Me.getSource();if(!(qe instanceof ot))return;const pt=Math.ceil(Math.sqrt(Ae.paint.get("raster-particle-count")));let vt=Ae.particlePositionRGBAImage;if(!vt||vt.width!==pt){const F=function(k){const F=k*k,Me=new Uint8Array(4*F),o=function(k){return k|=0,k=Math.imul(2747636419^k,2654435769),k=Math.imul(k^k>>>16,2654435769),((k=Math.imul(k^k>>>16,2654435769))>>>0)/4294967296},Ae=1/1.1;for(let k=0;k<F;k++){const F=Ae*(o(2*k+0)+Ed),Oe=Ae*(o(2*k+1)+Ed),Fe=255*F%1,je=255*Oe%1,qe=Fe,pt=Oe-je/255,vt=je;Me[4*k+0]=255*(F-Fe/255),Me[4*k+1]=255*qe,Me[4*k+2]=255*pt,Me[4*k+3]=255*vt}return Me}(pt);vt=Ae.particlePositionRGBAImage=new k.r({width:pt,height:pt},F)}let Ut=Ae.particleFramebuffer;Ut?Ut.width!==pt&&(Ut.destroy(),Ut=Ae.particleFramebuffer=Fe.createFramebuffer(pt,pt,!0,null)):Ut=Ae.particleFramebuffer=Fe.createFramebuffer(pt,pt,!0,null);const xi=[];for(const k of Oe){const F=Me.getTile(k);if(!(F instanceof xt))continue;const Oe=Xr(F,qe,Ae);if(!Oe)continue;const je=[F.tileSize,F.tileSize];let Ut=Ae.tileFramebuffer;Ut||(Ut=Ae.tileFramebuffer=Fe.createFramebuffer(je[0],je[1],!0,null));let vi=F.rasterParticleState;vi||(vi=F.rasterParticleState=new $r(Fe,k,je,vt));const bi=vi.update(Ae.lastInvalidatedAt);vi.particleTextureDimension!==pt&&vi.updateParticleTexture(k,vt);const wi=vi.targetColorTexture;vi.targetColorTexture=vi.backgroundColorTexture,vi.backgroundColorTexture=wi;const Mi=vi.particleTexture0;vi.particleTexture0=vi.particleTexture1,vi.particleTexture1=Mi,xi.push([k,Oe,vi,bi])}if(0===xi.length)return;const vi=k.q.now(),bi=Ae.previousDrawTimestamp?.001*(vi-Ae.previousDrawTimestamp):.0167;if(Ae.previousDrawTimestamp=vi,Ae.hasColorMap()){Fe.activeTexture.set(je.TEXTURE0+2);let F=Ae.colorRampTexture;F||(F=Ae.colorRampTexture=new k.T(Fe,Ae.colorRamp,je.RGBA8)),F.bind(je.LINEAR,je.CLAMP_TO_EDGE)}Fe.bindFramebuffer.set(Ae.tileFramebuffer.framebuffer),function(F,Me,Ae){const Oe=F.context,Fe=Oe.gl,je=Me.tileFramebuffer;Oe.activeTexture.set(Fe.TEXTURE0);const qe={u_texture:0,u_opacity:1.05*(vt=Me.paint.get("raster-particle-fade-opacity-factor"))/(vt+.05)},pt=F.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var vt;for(const vt of Ae){const[,,Ae,Ut]=vt;je.colorAttachment.set(Ae.targetColorTexture.texture),Oe.viewport.set([0,0,je.width,je.height]),Oe.clear({color:k.aj.transparent}),Ut&&(Ae.backgroundColorTexture.bind(Fe.NEAREST,Fe.CLAMP_TO_EDGE),pt.draw(F,Fe.TRIANGLES,Fi.disabled,Bi.disabled,Oi.alphaBlended,Gi.disabled,qe,Me.id,F.viewportBuffer,F.quadTriangleIndexBuffer,F.viewportSegments))}}(F,Ae,xi),function(F,Me,Ae,Oe){const Fe=F.context,je=Fe.gl,qe=Ae.tileFramebuffer,pt="globe"===F.transform.projection.name,vt=Ae.paint.get("raster-particle-max-speed");for(const Ut of Oe){const[Oe,xi,vi]=Ut;Fe.activeTexture.set(je.TEXTURE0+0),xi.texture.bind(je.LINEAR,je.CLAMP_TO_EDGE),qe.colorAttachment.set(vi.targetColorTexture.texture);const bi=F.getOrCreateProgram("rasterParticleDraw",{defines:xi.defines,overrideFog:!1});Fe.activeTexture.set(je.TEXTURE0+1);const wi=xi.scalarData?[]:[0,1,2,3].map((F=>k.d4[F](Oe)));wi.push(Oe);const Mi=Oe.canonical.x,pr=Oe.canonical.y;for(const k of wi){const Fe=Me.getTile(pt?k.wrapped():k);if(!Fe)continue;const qe=Fe.rasterParticleState;if(!qe)continue;const Ut=k.canonical.x+(1<<k.canonical.z)*(k.wrap-Oe.wrap),vi=k.canonical.y;qe.particleTexture0.bind(je.NEAREST,je.CLAMP_TO_EDGE);const wi=dr(1,qe.particleTexture0.size[0],[Ut-Mi,vi-pr],0,xi.texture.size,2,vt,xi.textureOffset,xi.scale,xi.offset);bi.draw(F,je.POINTS,Fi.disabled,Bi.disabled,Oi.alphaBlended,Gi.disabled,wi,Ae.id,qe.particleIndexBuffer,void 0,qe.particleSegment)}}}(F,Me,Ae,xi),Fe.bindFramebuffer.set(Ae.particleFramebuffer.framebuffer),function(F,Me,Ae,Oe){const Fe=F.context,je=Fe.gl,qe=Me.paint.get("raster-particle-max-speed"),pt=Oe*Me.paint.get("raster-particle-speed-factor")*.15,vt=function(k){return Math.pow(k,6)}(.01+1*Me.paint.get("raster-particle-reset-rate-factor")),Ut=Me.particleFramebuffer;Fe.viewport.set([0,0,Ut.width,Ut.height]);for(const Oe of Ae){const[,Ae,xi]=Oe;Fe.activeTexture.set(je.TEXTURE0+0),Ae.texture.bind(je.LINEAR,je.CLAMP_TO_EDGE),Fe.activeTexture.set(je.TEXTURE0+1);const vi=xi.particleTexture0;vi.bind(je.NEAREST,je.CLAMP_TO_EDGE);const bi=_r(1,vi.size[0],0,Ae.texture.size,qe,pt,vt,Ae.textureOffset,Ae.scale,Ae.offset);Ut.colorAttachment.set(xi.particleTexture1.texture),Fe.clear({color:k.aj.transparent}),F.getOrCreateProgram("rasterParticleUpdate",{defines:Ae.defines}).draw(F,je.TRIANGLES,Fi.disabled,Bi.disabled,Oi.unblended,Gi.disabled,bi,Me.id,F.viewportBuffer,F.quadTriangleIndexBuffer,F.viewportSegments)}}(F,Ae,xi,bi)}(F,Me,Ae,Oe),"translucent"===F.renderPass&&(function(F,Me,Ae,Oe,Fe){const je=F.context,qe=je.gl,pt=Me.getSource().tileSize,vt=5*(1-k.ac(k.bY,k.bY+1,F.transform.zoom))*pt+Ae.paint.get("raster-particle-elevation"),Ut=!F.options.moving,xi="globe"===F.transform.projection.name;if(!Oe.length)return;const[vi,bi]=F.stencilConfigForOverlap(Oe),wi=[];xi&&wi.push("PROJECTION_GLOBE_VIEW");const Mi=F.stencilModeFor3D();for(const Oe of bi){const Fe=Oe.toUnwrapped(),pt=Me.getTile(Oe);if(!pt.rasterParticleState)continue;const bi=pt.rasterParticleState,pr=100;pt.registerFadeDuration(pr);const Ur=Me.findLoadedParent(Oe,0),Wr=ks(pt,Ur,Me,F.transform,pr);let Jr,Qr;F.terrain&&F.terrain.prepareDrawTile(),je.activeTexture.set(qe.TEXTURE0),bi.targetColorTexture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),je.activeTexture.set(qe.TEXTURE1),Ur&&Ur.rasterParticleState?(Ur.rasterParticleState.targetColorTexture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),Jr=Math.pow(2,Ur.tileID.overscaledZ-pt.tileID.overscaledZ),Qr=[pt.tileID.canonical.x*Jr%1,pt.tileID.canonical.y*Jr%1]):bi.targetColorTexture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE);const co=xi?Float32Array.from(F.transform.expandedFarZProjMatrix):F.transform.calculateProjMatrix(Fe,Ut),mo=F.transform,yo=Kr(mo),To=k.cE(Oe.canonical),zo=k.cF(To.getCenter().lat);let ko,na,aa,_a,wa;xi?(ko=Float32Array.from(k.bb(k.cH(Oe.canonical))),na=Float32Array.from(mo.globeMatrix),aa=Float32Array.from(k.cD(mo)),_a=[k.at(mo.center.lng),k.aA(mo.center.lat)],wa=Float32Array.from(k.cG(Oe.canonical,To,zo,mo.worldSize/mo._pixelsPerMercatorPixel))):(ko=new Float32Array(16),na=new Float32Array(9),aa=new Float32Array(16),_a=[0,0],wa=new Float32Array(9));const Sa=ur(co,ko,na,aa,wa,Qr||[0,0],k.ae(F.transform.zoom),_a,yo,Jr||1,Wr,vt),Ya=F.isTileAffectedByFog(Oe),rl=F.getOrCreateProgram("rasterParticle",{defines:wi,overrideFog:Ya});if(F.uploadCommonUniforms(je,rl,Fe),xi){const k=new Fi(qe.LEQUAL,Fi.ReadOnly,F.depthRangeFor3D),Me=0,Oe=F.globeSharedBuffers;if(Oe){const[Fe,je,pt]=Oe.getGridBuffers(zo,0!==Me);rl.draw(F,qe.TRIANGLES,k,Mi,Oi.alphaBlended,F.renderElevatedRasterBackface?Gi.frontCCW:Gi.backCCW,Sa,Ae.id,Fe,je,pt)}}else{const k=F.depthModeForSublayer(0,Fi.ReadOnly),Me=vi[Oe.overscaledZ],{tileBoundsBuffer:Fe,tileBoundsIndexBuffer:je,tileBoundsSegments:vt}=F.getTileBoundsBuffers(pt);rl.draw(F,qe.TRIANGLES,k,Me,Oi.alphaBlended,Gi.disabled,Sa,Ae.id,Fe,je,vt)}}F.resetStencilClippingMasks()}(F,Me,Ae,Oe),F.style.map.triggerRepaint())},background:function(F,Me,Ae,Oe){const Fe=Ae.paint.get("background-color"),je="none"===Ae.paint.get("background-color-use-theme").constantOr("default"),qe=Ae.paint.get("background-opacity"),pt=Ae.paint.get("background-emissive-strength"),vt="viewport"===Ae.paint.get("background-pitch-alignment");if(0===qe)return;const Ut=F.context,xi=Ut.gl,vi=F.transform,bi=vi.tileSize,wi=Ae.paint.get("background-pattern");let Mi;if(void 0!==wi){if(null===wi)return;if(Mi=F.imageManager.getPattern(wi.toString(),Ae.scope,F.style.getLut(Ae.scope)),!Mi)return}const pr=!wi&&1===Fe.a&&1===qe&&F.opaquePassEnabledForLayer()?"opaque":"translucent";if(F.renderPass!==pr)return;const Ur=Bi.disabled,Wr=F.depthModeForSublayer(0,"opaque"===pr?Fi.ReadWrite:Fi.ReadOnly),Jr=F.colorModeForDrapableLayerRenderPass(pt),Qr=wi?"backgroundPattern":"background";let co,mo=Oe;if(mo||(co=F.getBackgroundTiles(),mo=Object.values(co).map((k=>k.tileID))),wi&&(Ut.activeTexture.set(xi.TEXTURE0),F.imageManager.bind(F.context,Ae.scope)),vt){const Me=F.getOrCreateProgram(Qr,{overrideFog:!1,overrideRtt:!0}),Oe=new Float32Array(k.ab.mat4.identity([])),Ut=new k.aG(0,0,0,0,0),vi=wi?gr(Oe,pt,qe,F,0,Ae.scope,Mi,vt,{tileID:Ut,tileSize:bi}):mr(Oe,pt,qe,Fe.toRenderColor(je?null:Ae.lut));Me.draw(F,xi.TRIANGLES,Wr,Ur,Jr,Gi.disabled,vi,Ae.id,F.viewportBuffer,F.quadTriangleIndexBuffer,F.viewportSegments)}else for(const k of mo){const pr=F.isTileAffectedByFog(k),mo=F.getOrCreateProgram(Qr,{overrideFog:pr}),yo=k.toUnwrapped(),To=Oe?k.projMatrix:F.transform.calculateProjMatrix(yo);F.prepareDrawTile();const zo=Me?Me.getTile(k):co?co[k.key]:new yt(k,bi,vi.zoom,F),ko=wi?gr(To,pt,qe,F,0,Ae.scope,Mi,vt,{tileID:k,tileSize:bi}):mr(To,pt,qe,Fe.toRenderColor(je?null:Ae.lut));F.uploadCommonUniforms(Ut,mo,yo);const{tileBoundsBuffer:na,tileBoundsIndexBuffer:aa,tileBoundsSegments:_a}=F.getTileBoundsBuffers(zo);mo.draw(F,xi.TRIANGLES,Wr,Ur,Jr,Gi.disabled,ko,Ae.id,na,aa,_a)}},sky:function(F,Me,Ae){const Oe=F._atmosphere?k.ae(F.transform.zoom):1,Fe=Ae.paint.get("sky-opacity")*Oe;if(0===Fe)return;const je=F.context,qe=Ae.paint.get("sky-type"),pt=new Fi(je.gl.LEQUAL,Fi.ReadOnly,[0,1]),vt=F.frameCounter/1e3%1;"atmosphere"===qe?"offscreen"===F.renderPass?Ae.needsSkyboxCapture(F)&&(function(F,Me,Ae,Oe){const Fe=F.context,je=Fe.gl;let qe=Me.skyboxFbo;if(!qe){qe=Me.skyboxFbo=Fe.createFramebuffer(32,32,!0,null),Me.skyboxGeometry=new ca(Fe),Me.skyboxTexture=Fe.gl.createTexture(),je.bindTexture(je.TEXTURE_CUBE_MAP,Me.skyboxTexture),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_WRAP_S,je.CLAMP_TO_EDGE),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_WRAP_T,je.CLAMP_TO_EDGE),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_MIN_FILTER,je.LINEAR),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_MAG_FILTER,je.LINEAR);for(let k=0;k<6;++k)je.texImage2D(je.TEXTURE_CUBE_MAP_POSITIVE_X+k,0,je.RGBA,32,32,0,je.RGBA,je.UNSIGNED_BYTE,null)}Fe.bindFramebuffer.set(qe.framebuffer),Fe.viewport.set([0,0,32,32]);const pt=Me.getCenter(F,!0),vt=F.getOrCreateProgram("skyboxCapture"),Ut=new Float64Array(16);k.ab.mat4.identity(Ut),k.ab.mat4.rotateY(Ut,Ut,.5*-Math.PI),ha(F,Me,vt,Ut,pt,0),k.ab.mat4.identity(Ut),k.ab.mat4.rotateY(Ut,Ut,.5*Math.PI),ha(F,Me,vt,Ut,pt,1),k.ab.mat4.identity(Ut),k.ab.mat4.rotateX(Ut,Ut,.5*-Math.PI),ha(F,Me,vt,Ut,pt,2),k.ab.mat4.identity(Ut),k.ab.mat4.rotateX(Ut,Ut,.5*Math.PI),ha(F,Me,vt,Ut,pt,3),k.ab.mat4.identity(Ut),ha(F,Me,vt,Ut,pt,4),k.ab.mat4.identity(Ut),k.ab.mat4.rotateY(Ut,Ut,Math.PI),ha(F,Me,vt,Ut,pt,5),Fe.viewport.set([0,0,F.width,F.height])}(F,Ae),Ae.markSkyboxValid(F)):"sky"===F.renderPass&&function(k,F,Me,Ae,Oe){const Fe=k.context,je=Fe.gl,qe=k.transform,pt=k.getOrCreateProgram("skybox");Fe.activeTexture.set(je.TEXTURE0),je.bindTexture(je.TEXTURE_CUBE_MAP,F.skyboxTexture);const vt=((k,F,Me,Ae,Oe)=>({u_matrix:k,u_sun_direction:F,u_cubemap:0,u_opacity:Ae,u_temporal_offset:Oe}))(qe.skyboxMatrix,F.getCenter(k,!1),0,Ae,Oe);k.uploadCommonUniforms(Fe,pt),pt.draw(k,je.TRIANGLES,Me,Bi.disabled,k.colorModeForRenderPass(),Gi.backCW,vt,"skybox",F.skyboxGeometry.vertexBuffer,F.skyboxGeometry.indexBuffer,F.skyboxGeometry.segment)}(F,Ae,pt,Fe,vt):"gradient"===qe&&"sky"===F.renderPass&&function(F,Me,Ae,Oe,Fe){const je=F.context,qe=je.gl,pt=F.transform,vt=F.getOrCreateProgram("skyboxGradient");Me.skyboxGeometry||(Me.skyboxGeometry=new ca(je)),je.activeTexture.set(qe.TEXTURE0);let Ut=Me.colorRampTexture;Ut||(Ut=Me.colorRampTexture=new k.T(je,Me.colorRamp,qe.RGBA8)),Ut.bind(qe.LINEAR,qe.CLAMP_TO_EDGE);const xi=((F,Me,Ae,Oe,Fe)=>({u_matrix:F,u_color_ramp:0,u_center_direction:Me,u_radius:k.ai(Ae),u_opacity:Oe,u_temporal_offset:Fe}))(pt.skyboxMatrix,Me.getCenter(F,!1),Me.paint.get("sky-gradient-radius"),Oe,Fe);F.uploadCommonUniforms(je,vt),vt.draw(F,qe.TRIANGLES,Ae,Bi.disabled,F.colorModeForRenderPass(),Gi.backCW,xi,"skyboxGradient",Me.skyboxGeometry.vertexBuffer,Me.skyboxGeometry.indexBuffer,Me.skyboxGeometry.segment)}(F,Ae,pt,Fe,vt)},debug:function(F,Me,Ae,Oe,Fe,je){for(let qe=0;qe<Ae.length;qe++)if(Fe){const Fe=1,pt=.8,vt=new k.aj(Oe.r*pt,Oe.g*pt,Oe.b*pt,1);ia(F,Me,Ae[qe],Oe,-Fe,-Fe,je),ia(F,Me,Ae[qe],Oe,-Fe,Fe,je),ia(F,Me,Ae[qe],Oe,Fe,Fe,je),ia(F,Me,Ae[qe],Oe,Fe,-Fe,je),ia(F,Me,Ae[qe],vt,0,0,je)}else ia(F,Me,Ae[qe],Oe,0,0,je)},custom:function(F,Me,Ae,Oe){const Fe=F.context,je=Ae.implementation;if(!F.transform.projection.unsupportedLayers||!F.transform.projection.unsupportedLayers.includes("custom")||F.terrain&&(F.terrain.renderingToTexture||"offscreen"===F.renderPass)&&Ae.isDraped(Me)){if("offscreen"===F.renderPass){const Me=je.prerender;if(Me){if(F.setCustomLayerDefaults(),Fe.setColorMode(F.colorModeForRenderPass()),"globe"===F.transform.projection.name){const Ae=F.transform.pointMerc;Me.call(je,Fe.gl,F.transform.customLayerMatrix(),F.transform.getProjection(),F.transform.globeToMercatorMatrix(),k.ae(F.transform.zoom),[Ae.x,Ae.y],F.transform.pixelsPerMeterRatio)}else Me.call(je,Fe.gl,F.transform.customLayerMatrix());Fe.setDirty(),F.setBaseState()}}else if("translucent"===F.renderPass){if(F.terrain&&F.terrain.renderingToTexture){const Me=je.renderToTile;if(Me){const Ae=Oe[0].canonical,qe=new k.aa(Ae.x+Oe[0].wrap*(1<<Ae.z),Ae.y,Ae.z);Fe.setDepthMode(Fi.disabled),Fe.setStencilMode(Bi.disabled),Fe.setColorMode(F.colorModeForRenderPass()),F.setCustomLayerDefaults(),Me.call(je,Fe.gl,qe),Fe.setDirty(),F.setBaseState()}return}F.setCustomLayerDefaults(),Fe.setColorMode(F.colorModeForRenderPass()),Fe.setStencilMode(Bi.disabled);const Me="3d"===je.renderingMode?new Fi(F.context.gl.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D):F.depthModeForSublayer(0,Fi.ReadOnly);if(Fe.setDepthMode(Me),"globe"===F.transform.projection.name){const Me=F.transform.pointMerc;je.render(Fe.gl,F.transform.customLayerMatrix(),F.transform.getProjection(),F.transform.globeToMercatorMatrix(),k.ae(F.transform.zoom),[Me.x,Me.y],F.transform.pixelsPerMeterRatio)}else je.render(Fe.gl,F.transform.customLayerMatrix());Fe.setDirty(),F.setBaseState(),Fe.bindFramebuffer.set(null)}}else k.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(F,Me,Ae,Oe){if("opaque"===F.renderPass)return;const Fe=Ae.paint.get("model-opacity").constantOr(1);if(0===Fe)return;const je=Ae.paint.get("model-cast-shadows");if("shadow"===F.renderPass){if(!je)return;if(F.terrain&&Fe<.65&&Ae._transitionablePaint._values["model-opacity"].value.expression instanceof k.a9)return}const qe=F.shadowRenderer,pt=Ae.paint.get("model-receive-shadows");qe&&(qe.useNormalOffset=!0,pt||(qe.enabled=!1));const c=()=>{qe&&(qe.useNormalOffset=!0,pt||(qe.enabled=!0))},vt=Me.getSource();if("light-beam"===F.renderPass&&"batched-model"!==vt.type)return;if("vector"===vt.type||"geojson"===vt.type)return function(F,Me,Ae,Oe,Fe){const je=F.transform;if("mercator"!==je.projection.name)return void k.w(`Drawing 3D models for ${je.projection.name} projection is not yet implemented`);const qe=je.getFreeCameraOptions().position;if(!F.modelManager)return;const pt=F.modelManager;Ae.modelManager=pt;const vt=F.shadowRenderer;if(!Ae._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Ut=Ae._unevaluatedLayout._values["model-id"],xi={...Ae.layout.get("model-id").parameters},vi=F.style.order.indexOf(Ae.fqid);for(const bi of Oe){const Oe=Me.getTile(bi).getBucket(Ae);if(!Oe||Oe.projection.name!==je.projection.name)continue;const wi=Oe.getModelUris();wi&&!Oe.modelsRequested&&(pt.addModelsFromBucket(wi,Fe),Oe.modelsRequested=!0);const Mi=Ta(bi,je);xi.zoom=Mi;const pr=Ut.possiblyEvaluate(xi);if(ba(F,Oe,bi),wp.shadowUniformsInitialized=!1,wp.useSingleShadowCascade=!!vt&&0===vt.getMaxCascadeForTile(bi.toUnwrapped()),"shadow"===F.renderPass&&vt){if(1===F.currentShadowCascade&&Oe.isInsideFirstShadowMapFrustum)continue;const Me=je.calculatePosMatrix(bi.toUnwrapped(),je.worldSize);if(wp.tileMatrix.set(Me),wp.shadowTileMatrix=Float32Array.from(vt.calculateShadowPassMatrixFromMatrix(Me)),wp.aabb.min.fill(0),wp.aabb.max[0]=wp.aabb.max[1]=k.ag,wp.aabb.max[2]=0,Ca(Oe,wp,F,Ae.scope))continue}const Ur=1<<bi.canonical.z,Wr=[((qe.x-bi.wrap)*Ur-bi.canonical.x)*k.ag,(qe.y*Ur-bi.canonical.y)*k.ag,qe.z*Ur*k.ag];F.conflationActive&&Object.keys(Oe.instancesPerModel).length>0&&F.style.isLayerClipped(Ae,Me.getSource())&&Oe.updateReplacement(bi,F.replacementSource,vi,Fe)&&(Oe.uploaded=!1,Oe.upload(F.context));for(let k in Oe.instancesPerModel){const Me=Oe.instancesPerModel[k];Me.features.length>0&&(k=pr.evaluate(Me.features[0].feature,{}));const je=pt.getModel(k,Fe);if(je&&je.uploaded)for(const k of je.nodes)Ea(F,Ae,k,Me,Wr,bi,wp)}}}(F,Me,Ae,Oe,"vector"===vt.type?Ae.scope:""),void c();if(!vt.loaded())return;if("batched-model"===vt.type)return function(F,Me,Ae,Oe){Ae.resetLayerRenderingStats(F);const Fe=F.context,je=F.transform,qe=F.style.fog,pt=F.shadowRenderer;if("mercator"!==je.projection.name)return void k.w(`Drawing 3D landmark models for ${je.projection.name} projection is not yet implemented`);const vt=F.transform.getFreeCameraOptions().position,Ut=k.ab.vec3.scale([],[vt.x,vt.y,vt.z],F.transform.worldSize),xi=k.ab.vec3.negate([],Ut),vi=k.ab.mat4.identity([]),bi=k.dj(je.center.lat,je.zoom),wi=k.ab.mat4.fromScaling([],[1,1,1/bi]);k.ab.mat4.translate(vi,vi,xi);const Mi=Ae.paint.get("model-opacity").constantOr(1),pr=new Fi(Fe.gl.LEQUAL,Fi.ReadWrite,F.depthRangeFor3D),Ur=new Fi(Fe.gl.LEQUAL,Fi.ReadOnly,F.depthRangeFor3D),Wr=new k.cd([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Jr="shadow"===F.renderPass,Qr=Jr&&pt?pt.getCurrentCascadeFrustum():je.getFrustum(je.scaleZoom(je.worldSize)),co=Ae.paint.get("model-front-cutoff"),mo=co[2]<1,yo=Ji(F,Ae.paint.get("model-cutoff-fade-range")),To=Ae.getLayerRenderingStats();(function(k,F,Me,Ae){const Oe=k.terrain?k.terrain.exaggeration():0,Fe=k.transform.zoom;for(const je of Ae){const Ae=F.getTile(je).getBucket(Me);Ae&&(k.conflationActive&&Ae.updateReplacement(je,k.replacementSource),Ae.evaluateScale(k,Me),k.terrain&&Oe>0&&Ae.elevationUpdate(k.terrain,Oe,je,Me.source),Ae.needsReEvaluation(k,Fe,Me)&&Ae.evaluate(Me))}})(F,Me,Ae,Oe),function(){let vt,xi,zo;mo?(vt=Oe.length-1,xi=-1,zo=-1):(vt=0,xi=Oe.length,zo=1);const ko=new Float64Array(16),na=k.ab.vec3.create(),aa=new k.P(0,0);for(let _a=vt;_a!==xi;_a+=zo){const vt=Oe[_a],xi=Me.getTile(vt).getBucket(Ae);if(!xi||!xi.uploaded)continue;let zo=!1;pt&&(zo=0===pt.getMaxCascadeForTile(vt.toUnwrapped()));const wa=je.calculatePosMatrix(vt.toUnwrapped(),je.worldSize),Ya=xi.modelTraits;!Jr&&mo&&(k.ab.mat4.invert(ko,wa),k.ab.vec3.transformMat4(na,Ut,ko),aa.x=na[0],aa.y=na[1]);const rl=[];for(const Me of xi.getNodesInfo()){if(Me.hiddenByReplacement)continue;if(!Me.node.meshes)continue;const Ae=Me.node;let Oe=0;F.terrain&&Ae.elevation&&(Oe=Ae.elevation*F.terrain.exaggeration());const Fe=(()=>{const F=Me.aabb;return Wr.min=[...F.min],Wr.max=[...F.max],Wr.min[2]+=Oe,Wr.max[2]+=Oe,k.ab.vec3.transformMat4(Wr.min,Wr.min,wa),k.ab.vec3.transformMat4(Wr.max,Wr.max,wa),Wr})(),qe=Me.evaluatedScale;if(qe[0]<=1&&qe[1]<=1&&qe[2]<=1&&0===Fe.intersects(Qr))continue;if(!Jr&&mo){const F=1/6;Me.cameraCollisionOpacity=Ut[0]>Fe.min[0]&&Ut[0]<Fe.max[0]&&Ut[1]>Fe.min[1]&&Ut[1]<Fe.max[1]&&Ut[2]*bi<Fe.max[2]&&Ae.footprint&&k.bA(aa,Ae.footprint)?Math.max(Me.cameraCollisionOpacity-F,0):Math.min(1,Me.cameraCollisionOpacity+F)}const pt=[...wa],vt=Ae.anchor?Ae.anchor[0]:0,xi=Ae.anchor?Ae.anchor[1]:0;k.ab.mat4.translate(pt,pt,[vt*(qe[0]-1),xi*(qe[1]-1),Oe]),k.ab.vec3.exactEquals(qe,k.dm)||k.ab.mat4.scale(pt,pt,qe);const vi=k.ab.mat4.multiply([],pt,Ae.matrix),wi=k.ab.mat4.multiply([],je.expandedFarZProjMatrix,vi),pr=k.ab.mat4.multiply([],je.expandedFarZProjMatrix,pt),Ur=k.ab.vec4.transformMat4([],[vt,xi,Oe,1],wi)[2];Ae.hidden=!1;let To=Mi;Jr||(mo&&(To*=Me.cameraCollisionOpacity,To*=Ra(pt,je,Me.aabb,co)),To*=Ia(yo,Ur)),0!==To?rl.push({nodeInfo:Me,depth:Ur,opacity:To,wvpForNode:wi,wvpForTile:pr,nodeModelMatrix:vi,tileModelMatrix:pt}):Ae.hidden=!0}Jr||rl.sort(((k,F)=>!mo||1===k.opacity&&1===F.opacity?k.depth<F.depth?-1:1:1===k.opacity?-1:1===F.opacity?1:k.depth>F.depth?-1:1));for(const Me of rl){const Oe=Me.nodeInfo,vt=Oe.node;let Ut=k.ab.mat4.multiply([],wi,Me.tileModelMatrix);k.ab.mat4.multiply(Ut,vi,Ut);const xi=k.ab.mat4.invert([],Ut);k.ab.mat4.transpose(xi,xi),k.ab.mat4.scale(xi,xi,Mp),Ut=k.ab.mat4.multiply(Ut,Ut,vt.matrix);const bi="light-beam"===F.renderPass,Mi="none"===Ae.paint.get("model-color-use-theme").constantOr("default"),Wr=Ya&k.dp.HasMapboxMeshFeatures,Qr=Wr?0:Oe.evaluatedRMEA[0][2];for(let k=0;k<vt.meshes.length;++k){const vi=vt.meshes[k],wi=k===vt.lightMeshIndex;let co=Me.wvpForNode;if(wi){if(!bi&&!F.terrain&&F.shadowRenderer){F.currentLayer<F.firstLightBeamLayer&&(F.firstLightBeamLayer=F.currentLayer);continue}co=Me.wvpForTile}else if(bi)continue;const mo={defines:[]},yo=[];if(!Jr&&pt&&(pt.useNormalOffset=!!vi.normalBuffer),ga(mo.defines,yo,vi,F,Mi?null:Ae.lut),Wr||mo.defines.push("DIFFUSE_SHADED"),zo&&mo.defines.push("SHADOWS_SINGLE_CASCADE"),To&&(Jr?To.numRenderedVerticesInShadowPass+=vi.vertexArray.length:To.numRenderedVerticesInTransparentPass+=vi.vertexArray.length),Jr){xa(vi,Me.nodeModelMatrix,F,Ae);continue}let ko=null;if(qe){const k=ma(Me.nodeModelMatrix,F.transform);if(ko=new Float32Array(k),"globe"!==je.projection.name){const F=vi.aabb.min,Me=vi.aabb.max,[Ae,Oe]=qe.getOpacityForBounds(k,F[0],F[1],Me[0],Me[1]);mo.overrideFog=Ae>=Sa||Oe>=Sa}}const na=vi.material;let aa;na.occlusionTexture&&na.occlusionTexture.offsetScale&&(aa=na.occlusionTexture.offsetScale,mo.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const _a=F.getOrCreateProgram("model",mo);!Jr&&pt&&pt.setupShadowsFromMatrix(Me.tileModelMatrix,_a,pt.useNormalOffset),F.uploadCommonUniforms(Fe,_a,null,ko);const wa=na.pbrMetallicRoughness;wa.metallicFactor=.9,wa.roughnessFactor=.5;const Ya=yr(new Float32Array(co),new Float32Array(Ut),new Float32Array(xi),new Float32Array(vt.matrix),F,Me.opacity,wa.baseColorFactor.toRenderColor(null),na.emissiveFactor,wa.metallicFactor,wa.roughnessFactor,na,Qr,Ae,[0,0,0],aa);!wi&&(Oe.hasTranslucentParts||Me.opacity<1)&&_a.draw(F,Fe.gl.TRIANGLES,pr,Bi.disabled,Oi.disabled,Gi.backCCW,Ya,Ae.id,vi.vertexBuffer,vi.indexBuffer,vi.segments,Ae.paint,F.transform.zoom,void 0,yo),_a.draw(F,Fe.gl.TRIANGLES,wi?Ur:pr,Bi.disabled,wi||Me.opacity<1||Oe.hasTranslucentParts?Oi.alphaBlended:Oi.unblended,Gi.backCCW,Ya,Ae.id,vi.vertexBuffer,vi.indexBuffer,vi.segments,Ae.paint,F.transform.zoom,void 0,yo)}}}}()}(F,Me,Ae,Oe),void c();if("model"!==vt.type)return;const Ut=vt.getModels(),xi=[],vi=F.transform.getFreeCameraOptions().position,bi=k.ab.vec3.scale([],[vi.x,vi.y,vi.z],F.transform.worldSize);k.ab.vec3.negate(bi,bi);const wi=[],Mi=[];let pr=0;for(const Me of Ut){const Oe=Ae.paint.get("model-rotation").constantOr(null),Fe=Ae.paint.get("model-scale").constantOr(null),je=Ae.paint.get("model-translation").constantOr(null);Me.computeModelMatrix(F,Oe,Fe,je,!0,!0,!1);const qe=k.ab.mat4.identity([]),pt=k.dj(Me.position.lat,F.transform.zoom),vt=k.ab.mat4.fromScaling([],[1,1,1/pt]);k.ab.mat4.translate(qe,qe,bi),xi.push({zScaleMatrix:vt,negCameraPosMatrix:qe});for(const k of Me.nodes)ya(F.transform,k,Me.matrix,F.transform.expandedFarZProjMatrix,pr,wi,Mi);pr++}if(wi.sort(((k,F)=>F.depth-k.depth)),"shadow"!==F.renderPass){if(1===Fe)for(const k of Mi)va(k,F,Ae,xi[k.modelIndex],Bi.disabled,F.colorModeForRenderPass());else{for(const k of Mi)va(k,F,Ae,xi[k.modelIndex],Bi.disabled,Oi.disabled);for(const k of Mi)va(k,F,Ae,xi[k.modelIndex],F.stencilModeFor3D(),F.colorModeForRenderPass());F.resetStencilClippingMasks()}for(const k of wi)va(k,F,Ae,xi[k.modelIndex],Bi.disabled,F.colorModeForRenderPass());c()}else{for(const k of Mi)xa(k.mesh,k.nodeModelMatrix,F,Ae);for(const k of wi)xa(k.mesh,k.nodeModelMatrix,F,Ae);c()}}},Op={model:function(k,F,Me){const Ae=F.getSource();if(!Ae.loaded())return;if("vector"===Ae.type||"geojson"===Ae.type)return void(Me.modelManager&&Me.modelManager.upload(Me,"vector"===Ae.type?k.scope:""));if("batched-model"===Ae.type)return;if("model"!==Ae.type)return;const Oe=Ae.getModels();for(const k of Oe)k.upload(Me.context)},raster:function(k,F,Me){const Ae=F.getSource();if(!(Ae instanceof ot&&Ae.loaded()))return;const Oe=k.sourceLayer||Ae.rasterLayerIds&&Ae.rasterLayerIds[0];if(!Oe)return;const Fe=k.paint.get("raster-array-band")||Ae.getInitialBand(Oe);if(null==Fe)return;const je=F.getIds().map((k=>F.getTileByID(k)));for(const k of je)k.updateNeeded(Oe,Fe)&&Ae.prepareTile(k,Oe,Fe)},"raster-particle":function(k,F,Me){const Ae=F.getSource();if(!(Ae instanceof ot&&Ae.loaded()))return;const Oe=k.sourceLayer||Ae.rasterLayerIds&&Ae.rasterLayerIds[0];if(!Oe)return;const Fe=k.paint.get("raster-particle-array-band")||Ae.getInitialBand(Oe);if(null==Fe)return;const je=F.getIds().map((k=>F.getTileByID(k)));for(const k of je)k.updateNeeded(Oe,Fe)&&Ae.prepareTile(k,Oe,Fe)}};class Wa{constructor(F,Me,Ae,Oe,Fe){this.context=new Cr(F,Me),this.transform=Ae,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=Fe,this._timeStamp=k.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const je=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const k of je)this._debugParams.enabledLayers[k]=!0;Fe.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),Fe.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),Fe.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),Fe.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),Fe.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),Fe.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const k of je)Fe.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],k);this.occlusionParams=new Aa(Fe),this.setup(),this.numSublayers=Tt.maxUnderzooming+Tt.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new k.dv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new io(this),this._wireframeDebugCache=new La,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const qe=new k.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new k.T(this.context,qe,F.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=Oe}updateTerrain(k,F){const Me=!!k&&!!k.terrain&&this.transform.projection.supportsTerrain;if(!(Me||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Gs(this,k));const Ae=this._terrain;this.transform.elevation=Me?Ae:null,Ae.update(k,this.transform,F),this.transform.elevation&&!Ae.enabled&&(this.transform.elevation=null)}_updateFog(k){const F=k.fog;if(!F||"globe"===this.transform.projection.name||F.getOpacity(this.transform.pitch)<1||F.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[Me,Ae]=F.getFovAdjustedRange(this.transform._fov);if(Me>Ae)return void(this.transform.fogCullDistSq=null);const Oe=Me+.78*(Ae-Me);this.transform.fogCullDistSq=Oe*Oe}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(k){k&&!this._terrain&&(this._terrain=new Gs(this,this.style)),this._forceTerrainMode=k}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(F,Me){if(this.width=F*k.q.devicePixelRatio,this.height=Me*k.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const k of this.style.order)this.style._mergedLayers[k].resize()}setup(){const F=this.context,Me=new k.b4;Me.emplaceBack(0,0),Me.emplaceBack(k.ag,0),Me.emplaceBack(0,k.ag),Me.emplaceBack(k.ag,k.ag),this.tileExtentBuffer=F.createVertexBuffer(Me,k.b6.members),this.tileExtentSegments=k.b7.simpleSegment(0,0,4,2);const Ae=new k.b4;Ae.emplaceBack(0,0),Ae.emplaceBack(k.ag,0),Ae.emplaceBack(0,k.ag),Ae.emplaceBack(k.ag,k.ag),this.debugBuffer=F.createVertexBuffer(Ae,k.b6.members),this.debugSegments=k.b7.simpleSegment(0,0,4,5);const Oe=new k.b4;Oe.emplaceBack(-1,-1),Oe.emplaceBack(1,-1),Oe.emplaceBack(-1,1),Oe.emplaceBack(1,1),this.viewportBuffer=F.createVertexBuffer(Oe,k.b6.members),this.viewportSegments=k.b7.simpleSegment(0,0,4,2);const Fe=new k.aT;Fe.emplaceBack(0,0,0,0),Fe.emplaceBack(k.ag,0,k.ag,0),Fe.emplaceBack(0,k.ag,0,k.ag),Fe.emplaceBack(k.ag,k.ag,k.ag,k.ag),this.mercatorBoundsBuffer=F.createVertexBuffer(Fe,k.b9.members),this.mercatorBoundsSegments=k.b7.simpleSegment(0,0,4,2);const je=new k.aU;je.emplaceBack(0,1,2),je.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=F.createIndexBuffer(je);const qe=new k.b5;for(const k of[0,1,3,2,0])qe.emplaceBack(k);this.debugIndexBuffer=F.createIndexBuffer(qe),this.emptyTexture=new k.T(F,new k.r({width:1,height:1},Uint8Array.of(0,0,0,0)),F.gl.RGBA8),this.identityMat=k.ab.mat4.create();const pt=this.context.gl;this.stencilClearMode=new Bi({func:pt.ALWAYS,mask:0},0,255,pt.ZERO,pt.ZERO,pt.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(k){return k._makeTileBoundsBuffers(this.context,this.transform.projection),k._tileBoundsBuffer?{tileBoundsBuffer:k._tileBoundsBuffer,tileBoundsIndexBuffer:k._tileBoundsIndexBuffer,tileBoundsSegments:k._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const k=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,k.TRIANGLES,Fi.disabled,this.stencilClearMode,Oi.disabled,Gi.disabled,Fs(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(k,F,Me){if(!F||this.currentStencilSource===F.id||!k.isTileClipped()||!Me||0===Me.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let k=!1;for(const F of Me)if(void 0===this._tileClippingMaskIDs[F.key]){k=!0;break}if(!k)return}this.currentStencilSource=F.id;const Ae=this.context,Oe=Ae.gl;this.nextStencilID+Me.length>256&&this.clearStencil(),Ae.setColorMode(Oi.disabled),Ae.setDepthMode(Fi.disabled);const Fe=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const k of Me){const Me=F.getTile(k),Ae=this._tileClippingMaskIDs[k.key]=this.nextStencilID++,{tileBoundsBuffer:je,tileBoundsIndexBuffer:qe,tileBoundsSegments:pt}=this.getTileBoundsBuffers(Me);Fe.draw(this,Oe.TRIANGLES,Fi.disabled,new Bi({func:Oe.ALWAYS,mask:0},Ae,255,Oe.KEEP,Oe.KEEP,Oe.REPLACE),Oi.disabled,Gi.disabled,Fs(k.projMatrix),"$clipping",je,qe,pt)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const k=this.nextStencilID++,F=this.context.gl;return new Bi({func:F.NOTEQUAL,mask:255},k,255,F.KEEP,F.KEEP,F.REPLACE)}stencilModeForClipping(k){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(k);const F=this.context.gl;return new Bi({func:F.EQUAL,mask:255},this._tileClippingMaskIDs[k.key],0,F.KEEP,F.KEEP,F.REPLACE)}stencilConfigForOverlap(k){const F=this.context.gl,Me=k.sort(((k,F)=>F.overscaledZ-k.overscaledZ)),Ae=Me[Me.length-1].overscaledZ,Oe=Me[0].overscaledZ-Ae+1;if(Oe>1){this.currentStencilSource=void 0,this.nextStencilID+Oe>256&&this.clearStencil();const k={};for(let Me=0;Me<Oe;Me++)k[Me+Ae]=new Bi({func:F.GEQUAL,mask:255},Me+this.nextStencilID,255,F.KEEP,F.KEEP,F.REPLACE);return this.nextStencilID+=Oe,[k,Me]}return[{[Ae]:Bi.disabled},Me]}colorModeForRenderPass(){const F=this.context.gl;if(this._showOverdrawInspector){const Me=1/8;return new Oi([F.CONSTANT_COLOR,F.ONE,F.CONSTANT_COLOR,F.ONE],new k.aj(Me,Me,Me,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?Oi.unblended:Oi.alphaBlended}colorModeForDrapableLayerRenderPass(F){const Me=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new Oi([Me.ONE,Me.ONE_MINUS_SRC_ALPHA,Me.CONSTANT_ALPHA,Me.ONE_MINUS_SRC_ALPHA],new k.aj(0,0,0,void 0===F?0:F),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(k,F,Me,Ae=!1){if(this.depthOcclusion)return new Fi(this.context.gl.GREATER,Fi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!Ae)return Fi.disabled;const Oe=1-((1+this.currentLayer)*this.numSublayers+k)*this.depthEpsilon;return new Fi(Me||this.context.gl.LEQUAL,F,[Oe,Oe])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const F=this.context.gl,Me=Math.ceil(this.width),Ae=Math.ceil(this.height),Oe=this.context.bindFramebuffer.get(),Fe=F.getParameter(F.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===Me&&this.depthFBO.height===Ae||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==Me&&0!==Ae&&(this.depthFBO=new Sr(this.context,Me,Ae,!1,"texture"),this.depthTexture=new k.T(this.context,{width:Me,height:Ae,data:null},F.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(Oe),F.bindTexture(F.TEXTURE_2D,Fe),this.depthFBO&&(F.bindFramebuffer(F.READ_FRAMEBUFFER,null),F.bindFramebuffer(F.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),F.blitFramebuffer(0,0,Me,Ae,0,0,Me,Ae,F.DEPTH_BUFFER_BIT,F.NEAREST),F.bindFramebuffer(F.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((k,F)=>k+F/this._fpsHistory.length),0))}render(F,Me){const Ae=k.q.now();this._dt=Ae-this._timeStamp,this._timeStamp=Ae,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=F.map.repaint,this.style=F,this.options=Me;const Oe=this.style._mergedLayers,Fe=this.style._getOrder(!(!this.terrain||!this.terrain.enabled)).filter((k=>{const F=Oe[k];return!(F.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[F.type]}));let je=!1,qe=!1;for(const k of Fe){const F=Oe[k];"circle"===F.type&&(je=!0),"symbol"===F.type&&(F.hasInitialOcclusionOpacityProperties?qe=!0:je=!0)}const pt=Fe.map((k=>Oe[k])),vt=this.style._mergedSourceCaches;this.imageManager=F.imageManager,this.modelManager=F.modelManager,this.symbolFadeChange=F.placement.symbolFadeChange(k.q.now()),this.imageManager.beginFrame();let Ut=0,xi=!1;for(const k in vt){const F=vt[k];F.used&&(F.prepare(this.context),F.getSource().usedInConflation&&++Ut)}let vi=!1;for(const k of pt)k.isHidden(this.transform.zoom)||("clip"===k.type&&(vi=!0),this.prepareLayer(k));const bi={},wi={},Mi={},pr={},Ur={};for(const k in vt){const F=vt[k];bi[k]=F.getVisibleCoordinates(),wi[k]=bi[k].slice().reverse(),Mi[k]=F.getVisibleCoordinates(!0).reverse(),pr[k]=F.getShadowCasterCoordinates(),Ur[k]=F.sortCoordinatesByDistance(bi[k])}const v=k=>{const F=this.style.getLayerSourceCache(k);return F&&F.used?F.getSource():null};if(Ut||vi||this._clippingActiveLastFrame){const F=[],Me=[];let Ae=0;for(const k of pt)this.isSourceForClippingOrConflation(k,v(k))&&(F.push(k),Me.push(Ae)),Ae++;if(F&&(vi||F.length>1)||this._clippingActiveLastFrame){vi=!1;const Ae=[];for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe],je=Me[Oe],qe=this.style.getLayerSourceCache(Fe);if(!qe||!qe.used||!qe.getSource().usedInConflation&&"clip"!==Fe.type)continue;let pt=k.dx,vt=k.by.None;const Ut=[];let xi=!0;if("clip"===Fe.type){pt=je;for(const F of Fe.layout.get("clip-layer-types"))vt|="model"===F?k.by.Model:"symbol"===F?k.by.Symbol:k.by.FillExtrusion;for(const k of Fe.layout.get("clip-layer-scope"))Ut.push(k);Fe.isHidden(this.transform.zoom)?xi=!1:vi=!0}xi&&Ae.push({layer:Fe.fqid,cache:qe,order:pt,clipMask:vt,clipScope:Ut})}this.replacementSource.setSources(Ae),xi=!0}}this._clippingActiveLastFrame=vi,xi||this.replacementSource.clear(),this.conflationActive=xi,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let k=0;k<pt.length;k++){const F=pt[k],Me=F.cutoffRange();if(this.longestCutoffRange=Math.max(Me,this.longestCutoffRange),Me>0){const k=v(F);k&&(this.minCutoffZoom=Math.max(k.minzoom,this.minCutoffZoom)),F.minzoom&&(this.minCutoffZoom=Math.max(F.minzoom,this.minCutoffZoom))}F.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=k),this._lastOcclusionLayer=k)}const Wr=this.style&&this.style.fog;Wr?(this._fogVisible=0!==Wr.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=Wr.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Mi),this.opaquePassCutoff=0);const Jr=this._shadowRenderer;if(Jr){Jr.updateShadowParameters(this.transform,this.style.directionalLight);for(const k in vt)for(const F of bi[k]){let k={min:0,max:0};this.terrain&&(k=this.terrain.getMinMaxForTile(F)||k),Jr.addShadowReceiver(F.toUnwrapped(),k.min,k.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new k.dw(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new fa(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const Qr=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),co=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Qr&&!this._snow&&(this._snow=new qa(this)),!Qr&&this._snow&&(this._snow.destroy(),delete this._snow),co&&!this._rain&&(this._rain=new ja(this)),!co&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!To.has(this.context.gl))return;this.renderPass="offscreen";for(const k of pt){const Me=F.getLayerSourceCache(k);if(!k.hasOffscreenPass()||k.isHidden(this.transform.zoom))continue;const Ae=Me?wi[Me.id]:void 0;("custom"===k.type||"raster"===k.type||"raster-particle"===k.type||k.isSky()||Ae&&Ae.length)&&this.renderLayer(this,Me,k,Ae)}this.depthRangeFor3D=[0,1-(pt.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,pr)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const mo="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),yo=(()=>{if(Me.showOverdrawInspector)return k.aj.black;const F=this.style.fog;if(F&&this.transform.projection.supportsFog){const Me=this.style.getLut(F.scope);if(!mo){const Ae="none"===F.properties.get("color-use-theme"),Oe=F.properties.get("color").toRenderColor(Ae?null:Me).toArray01();return new k.aj(...Oe)}if(mo){const Ae="none"===F.properties.get("space-color-use-theme"),Oe=F.properties.get("space-color").toRenderColor(Ae?null:Me).toArray01();return new k.aj(...Oe)}}return k.aj.transparent})();if(this.context.clear({color:yo,depth:1}),this.clearStencil(),this._showOverdrawInspector=Me.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&mo&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=Fe.length-1;this.currentLayer>=0;this.currentLayer--){const k=pt[this.currentLayer],Me=F.getLayerSourceCache(k);if(k.isSky())continue;const Ae=Me?(k.is3D()?Ur:wi)[Me.id]:void 0;this._renderTileClippingMasks(k,Me,Ae),this.renderLayer(this,Me,k,Ae)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&mo&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||k.ae(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<Fe.length;this.currentLayer++){const k=pt[this.currentLayer],Me=F.getLayerSourceCache(k);k.isSky()&&this.renderLayer(this,Me,k,Me?wi[Me.id]:void 0)}function S(k,F){let Me;return F&&(Me=("symbol"===k.type?Mi:k.is3D()?Ur:wi)[F.id]),Me}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<Fe.length;){const k=pt[this.currentLayer];if("raster"===k.type||"raster-particle"===k.type){const Me=F.getLayerSourceCache(k);this.renderLayer(this,Me,k,S(k,Me))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let zo=0;Jr&&(zo=Jr.getShadowCastingLayerCount());let ko=!1,na=-1;for(let k=0;k<Fe.length;++k){const F=pt[k];F.isHidden(this.transform.zoom)||F.is3D()&&(na=k)}for(qe&&-1===na&&(je=!0);this.currentLayer<Fe.length;){const k=pt[this.currentLayer],Me=F.getLayerSourceCache(k);if(k.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(k)){if(k.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(je&&!ko&&this.terrain&&!this.transform.isOrthographic&&(ko=!0,this.blitDepth()),qe&&-1!==na&&this.currentLayer===na+1&&!this.transform.isOrthographic&&this.blitDepth(),k.is3D()||this.terrain||this._renderTileClippingMasks(k,Me,Me?bi[Me.id]:void 0),this.renderLayer(this,Me,k,S(k,Me)),!this.terrain&&Jr&&zo>0&&k.hasShadowPass()&&0==--zo&&(Jr.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const k=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=k;this.currentLayer++){const k=pt[this.currentLayer];if(!k.hasLightBeamPass())continue;const Me=F.getLayerSourceCache(k);this.renderLayer(this,Me,k,Me?wi[Me.id]:void 0)}this.currentLayer=k,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const k=this.currentLayer;this.depthOcclusion=!0;for(const k of this.layersWithOcclusionOpacity){this.currentLayer=k;const Me=pt[this.currentLayer],Ae=F.getLayerSourceCache(Me),Oe=Ae?wi[Ae.id]:void 0;Me.is3D()||this.terrain||this._renderTileClippingMasks(Me,Ae,Ae?bi[Ae.id]:void 0),this.renderLayer(this,Ae,Me,Oe)}this.depthOcclusion=!1,this.currentLayer=k,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Me=null;pt.forEach((k=>{const Ae=F.getLayerSourceCache(k);Ae&&!k.isHidden(this.transform.zoom)&&Ae.getVisibleCoordinates().length&&(!Me||Me.getSource().maxzoom<Ae.getSource().maxzoom)&&(Me=Ae)})),Me&&this.options.showTileBoundaries&&Rp.debug(this,Me,Me.getVisibleCoordinates(),k.aj.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Rp.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new k.aj(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(k){const F=k.transform.padding;oa(k,k.transform.height-(F.top||0),3,up),oa(k,F.bottom||0,3,dp),sa(k,F.left||0,3,fp),sa(k,k.transform.width-(F.right||0),3,mp);const Me=k.transform.centerPoint;!function(k,F,Me,Ae){ra(k,F-1,Me-10,2,20,Ae),ra(k,F-10,Me-1,20,2,Ae)}(k,Me.x,k.transform.height-Me.y,_p)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),xi||(this.conflationActive=!1)}prepareLayer(k){this.gpuTimingStart(k);const{unsupportedLayers:F}=this.transform.projection,Me=!F||!F.includes(k.type);if(Op[k.type]&&(Me||this.terrain&&"custom"===k.type)){const F=this.style.getLayerSourceCache(k);Op[k.type](k,F,this)}this.gpuTimingEnd()}renderLayer(k,F,Me,Ae){Me.isHidden(this.transform.zoom)||("background"===Me.type||"sky"===Me.type||"custom"===Me.type||"model"===Me.type||"raster"===Me.type||"raster-particle"===Me.type||Ae&&Ae.length)&&(this.id=Me.id,this.gpuTimingStart(Me),k.transform.projection.unsupportedLayers&&k.transform.projection.unsupportedLayers.includes(Me.type)&&(!k.terrain||"custom"!==Me.type)||"clip"===Me.type||Rp[Me.type](k,F,Me,Ae,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(k){if(!this.options.gpuTiming)return;const F=this.context.extTimerQuery,Me=this.context.gl;let Ae=this.gpuTimers[k.id];Ae||(Ae=this.gpuTimers[k.id]={calls:0,cpuTime:0,query:Me.createQuery()}),Ae.calls++,Me.beginQuery(F.TIME_ELAPSED_EXT,Ae.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const k=this.context.extTimerQuery,F=this.context.gl,Me=F.createQuery();this.deferredRenderGpuTimeQueries.push(Me),F.beginQuery(k.TIME_ELAPSED_EXT,Me)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const k=this.gpuTimers;return this.gpuTimers={},k}collectDeferredRenderGpuQueries(){const k=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],k}queryGpuTimers(k){const F={};for(const Me in k){const Ae=k[Me],Oe=this.context.extTimerQuery,Fe=Oe.getQueryParameter(Ae.query,this.context.gl.QUERY_RESULT)/1e6;Oe.deleteQueryEXT(Ae.query),F[Me]=Fe}return F}queryGpuTimeDeferredRender(k){if(!this.options.gpuTimingDeferredRender)return 0;const F=this.context.gl;let Me=0;for(const Ae of k)Me+=F.getQueryParameter(Ae,F.QUERY_RESULT)/1e6,F.deleteQuery(Ae);return Me}translatePosMatrix(F,Me,Ae,Oe,Fe){if(!Ae[0]&&!Ae[1])return F;const je=Fe?"map"===Oe?this.transform.angle:0:"viewport"===Oe?-this.transform.angle:0;if(je){const k=Math.sin(je),F=Math.cos(je);Ae=[Ae[0]*F-Ae[1]*k,Ae[0]*k+Ae[1]*F]}const qe=[Fe?Ae[0]:k.ar(Me,Ae[0],this.transform.zoom),Fe?Ae[1]:k.ar(Me,Ae[1],this.transform.zoom),0],pt=new Float32Array(16);return k.ab.mat4.translate(pt,F,qe),pt}saveTileTexture(k){const F=k.size[0],Me=this._tileTextures[F];Me?Me.push(k):this._tileTextures[F]=[k]}getTileTexture(k){const F=this._tileTextures[k];return F&&F.length>0?F.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(k,F,Me){const Ae=void 0===Me?this.terrain&&this.terrain.renderingToTexture:Me,Oe=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===k||"terrainRaster"===k?(Oe.push("LIGHTING_3D_MODE"),Oe.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):Ae||Oe.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||Oe.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(Oe.push("TERRAIN"),this.linearFloatFilteringSupported()&&Oe.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&Oe.push("GLOBE"),!this._fogVisible||Ae||void 0!==F&&!F||Oe.push("FOG","FOG_DITHERING"),Ae&&Oe.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&Oe.push("OVERDRAW_INSPECTOR"),Oe}getOrCreateProgram(k,F){this.cache=this.cache||{};const Me=F&&F.defines||[],Ae=F&&F.config,Oe=this.currentGlobalDefines(k,F&&F.overrideFog,F&&F.overrideRtt).concat(Me),Fe=Hs.cacheKey(Hu[k],k,Oe,Ae);return this.cache[Fe]||(this.cache[Fe]=new Hs(this.context,k,Hu[k],Ae,zd[k],Oe)),this.cache[Fe]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const k=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(k.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new k.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(F,Me){if(this.style.enable3dLights()){const Ae=this.style.directionalLight,Oe=this.style.ambientLight;if(Ae&&Oe){const Fe=((F,Me,Ae)=>{const Oe=F.properties.get("direction"),Fe="none"===F.properties.get("color-use-theme"),je=F.properties.get("color").toRenderColor(Fe?null:Ae.getLut(F.scope)).toArray01(),qe=F.properties.get("intensity"),pt="none"===Me.properties.get("color-use-theme"),vt=Me.properties.get("color").toRenderColor(pt?null:Ae.getLut(Me.scope)).toArray01(),Ut=Me.properties.get("intensity"),xi=[Oe.x,Oe.y,Oe.z],vi=k.cM(vt,Ut),bi=k.cM(je,qe);return{u_lighting_ambient_color:vi,u_lighting_directional_dir:xi,u_lighting_directional_color:bi,u_ground_radiance:js(xi,bi,vi)}})(Ae,Oe,this.style);Me.setLightsUniformValues(F,Fe)}}}uploadCommonUniforms(F,Me,Ae,Oe,Fe){if(this.uploadCommonLightUniforms(F,Me),this.terrain&&this.terrain.renderingToTexture)return;const je=this.style.fog;if(je){const Fe=je.getOpacity(this.transform.pitch),qe=((F,Me,Ae,Oe,Fe,je,qe,pt,vt,Ut,xi,vi)=>{const bi=F.transform,wi="none"===Me.properties.get("color-use-theme"),Mi=Me.properties.get("color").toRenderColor(wi?null:F.style.getLut(Me.scope)).toArray01();Mi[3]=Oe;const pr=F.frameCounter/1e3%1,[Ur,Wr]=Me.properties.get("vertical-range");return{u_fog_matrix:Ae?bi.calculateFogTileMatrix(Ae):vi||F.identityMat,u_fog_range:Me.getFovAdjustedRange(bi._fov),u_fog_color:Mi,u_fog_horizon_blend:Me.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Ur,Wr),Wr],u_fog_temporal_offset:pr,u_frustum_tl:Fe,u_frustum_tr:je,u_frustum_br:qe,u_frustum_bl:pt,u_globe_pos:vt,u_globe_radius:Ut,u_viewport:xi,u_globe_transition:k.ae(bi.zoom),u_is_globe:+("globe"===bi.projection.name)}})(this,je,Ae,Fe,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*k.q.devicePixelRatio,this.transform.height*k.q.devicePixelRatio],Oe);Me.setFogUniformValues(F,qe)}Fe&&Me.setCutoffUniformValues(F,Fe.uniformValues)}setTileLoadedFlag(k){this.tileLoaded=k}saveCanvasCopy(){const k=this.canvasCopy();k&&(this.frameCopies.push(k),this.tileLoaded=!1)}canvasCopy(){const k=this.context.gl,F=k.createTexture();return k.bindTexture(k.TEXTURE_2D,F),k.copyTexImage2D(k.TEXTURE_2D,0,k.RGBA,0,0,k.drawingBufferWidth,k.drawingBufferHeight,0),F}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const k=this.style&&this.style.fog;return!!k&&0!==k.getOpacity(this.transform.pitch)}getBackgroundTiles(){const k=this._backgroundTiles,F=this._backgroundTiles={},Me=this.transform.coveringTiles({tileSize:512});for(const Ae of Me)F[Ae.key]=k[Ae.key]||new yt(Ae,512,this.transform.tileZoom,this);return F}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(k,F){return!(!k.is3D()||"clip"!==k.type&&(k.minzoom&&k.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==k.sourceLayer)&&(!F||"batched-model"!==F.type)))}isTileAffectedByFog(k){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let F=this._cachedTileFogOpacities[k.key];return F||(this._cachedTileFogOpacities[k.key]=F=this.style.fog.getOpacityForTile(k)),F[0]>=Sa||F[1]>=Sa}setupDepthForOcclusion(k,F,Me){const Ae=this.context,Oe=Ae.gl,Fe=!!Me;var je;Me||(Me={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),Ae.activeTexture.set(Oe.TEXTURE3),k&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(Oe.NEAREST,Oe.CLAMP_TO_EDGE),Me.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],Me.u_depth_range_unpack=[2/((je=this.depthRangeFor3D)[1]-je[0]),-1-2*je[0]/(je[1]-je[0])],Me.u_occluder_half_size=.5*this.occlusionParams.occluderSize,Me.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(Oe.NEAREST,Oe.CLAMP_TO_EDGE),Ae.activeTexture.set(Oe.TEXTURE0),Fe||F.setTerrainUniformValues(Ae,Me)}}function $a(k,F){let Me=!1,Ae=null;const s=()=>{Ae=null,Me&&(k(),Ae=setTimeout(s,F),Me=!1)};return()=>(Me=!0,Ae||s(),Ae)}class Xa{constructor(F){this._hashName=F&&encodeURIComponent(F),k.aP(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=$a(this._updateHashUnthrottled.bind(this),300)}addTo(k){return this._map=k,window.addEventListener("hashchange",this._onHashChange,!1),k.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const k=this._map;if(!k)return"";const F=Ka(k);if(this._hashName){const k=this._hashName;let Me=!1;const Ae=location.hash.slice(1).split("&").map((Ae=>{const Oe=Ae.split("=")[0];return Oe===k?(Me=!0,`${Oe}=${F}`):Ae})).filter((k=>k));return Me||Ae.push(`${k}=${F}`),`#${Ae.join("&")}`}return`#${F}`}_getCurrentHash(){const k=location.hash.replace("#","");if(this._hashName){let F;return k.split("&").map((k=>k.split("="))).forEach((k=>{k[0]===this._hashName&&(F=k)})),(F&&F[1]||"").split("/")}return k.split("/")}_onHashChange(){const k=this._map;if(!k)return!1;const F=this._getCurrentHash();if(F.length>=3&&!F.some((k=>isNaN(k)))){const Me=k.dragRotate.isEnabled()&&k.touchZoomRotate.isEnabled()?+(F[3]||0):k.getBearing();return k.jumpTo({center:[+F[2],+F[1]],zoom:+F[0],bearing:Me,pitch:+(F[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Ka(k,F){const Me=k.getCenter(),Ae=Math.round(100*k.getZoom())/100,Oe=Math.ceil((Ae*Math.LN2+Math.log(512/360/.5))/Math.LN10),Fe=Math.pow(10,Oe),je=Math.round(Me.lng*Fe)/Fe,qe=Math.round(Me.lat*Fe)/Fe,pt=k.getBearing(),vt=k.getPitch();let Ut=F?`/${je}/${qe}/${Ae}`:`${Ae}/${qe}/${je}`;return(pt||vt)&&(Ut+="/"+Math.round(10*pt)/10),vt&&(Ut+=`/${Math.round(vt)}`),Ut}const Np={linearity:.3,easing:k.dy(0,0,.3,1)},Up=k.l({deceleration:2500,maxSpeed:1400},Np),jp=k.l({deceleration:20,maxSpeed:1400},Np),Gp=k.l({deceleration:1e3,maxSpeed:360},Np),qp=k.l({deceleration:1e3,maxSpeed:90},Np);class on{constructor(k){this._map=k,this.clear()}clear(){this._inertiaBuffer=[]}record(F){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:k.q.now(),settings:F})}_drainInertiaBuffer(){const F=this._inertiaBuffer,Me=k.q.now();for(;F.length>0&&Me-F[0].time>160;)F.shift()}_onMoveEnd(F){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const Me={zoom:0,bearing:0,pitch:0,pan:new k.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:k}of this._inertiaBuffer)Me.zoom+=k.zoomDelta||0,Me.bearing+=k.bearingDelta||0,Me.pitch+=k.pitchDelta||0,k.panDelta&&Me.pan._add(k.panDelta),k.around&&(Me.around=k.around),k.pinchAround&&(Me.pinchAround=k.pinchAround);const Ae=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,Oe={};if(Me.pan.mag()){const Fe=rn(Me.pan.mag(),Ae,k.l({},Up,F||{}));Oe.offset=Me.pan.mult(Fe.amount/Me.pan.mag()),Oe.center=this._map.transform.center,sn(Oe,Fe)}if(Me.zoom){const k=rn(Me.zoom,Ae,jp);Oe.zoom=this._map.transform.zoom+k.amount,sn(Oe,k)}if(Me.bearing){const F=rn(Me.bearing,Ae,Gp);Oe.bearing=this._map.transform.bearing+k.aw(F.amount,-179,179),sn(Oe,F)}if(Me.pitch){const k=rn(Me.pitch,Ae,qp);Oe.pitch=this._map.transform.pitch+k.amount,sn(Oe,k)}if(Oe.zoom||Oe.bearing){const k=void 0===Me.pinchAround?Me.around:Me.pinchAround;Oe.around=k?this._map.unproject(k):this._map.getCenter()}return this.clear(),Oe.noMoveStart=!0,Oe}}function sn(k,F){(!k.duration||k.duration<F.duration)&&(k.duration=F.duration,k.easing=F.easing)}function rn(F,Me,Ae){const{maxSpeed:Oe,linearity:Fe,deceleration:je}=Ae,qe=k.aw(F*Fe/(Me/1e3),-Oe,Oe),pt=Math.abs(qe)/(je*Fe);return{easing:Ae.easing,duration:1e3*pt,amount:qe*(pt/2)}}class an extends k.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(F,Me,Ae,Oe={}){const Fe=g(Me.getCanvasContainer(),Ae),je=Me.unproject(Fe);super(F,k.l({point:Fe,lngLat:je,originalEvent:Ae},Oe)),this._defaultPrevented=!1,this.target=Me}}class nn extends k.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(F,Me,Ae){const Oe="touchend"===F?Ae.changedTouches:Ae.touches,Fe=v(Me.getCanvasContainer(),Oe),je=Fe.map((k=>Me.unproject(k))),qe=Fe.reduce(((k,F,Me,Ae)=>k.add(F.div(Ae.length))),new k.P(0,0));super(F,{points:Fe,point:qe,lngLats:je,lngLat:Me.unproject(qe),originalEvent:Ae}),this._defaultPrevented=!1}}class ln extends k.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(k,F){super("wheel",{originalEvent:F}),this._defaultPrevented=!1}}class cn{constructor(k,F){this._map=k,this._clickTolerance=F.clickTolerance}reset(){this._mousedownPos=void 0}wheel(k){return this._firePreventable(new ln(this._map,k))}mousedown(k,F){return this._mousedownPos=F,this._firePreventable(new an(k.type,this._map,k))}mouseup(k){this._map.fire(new an(k.type,this._map,k))}preclick(F){const Me=k.l({},F);Me.type="preclick",this._map.fire(new an(Me.type,this._map,Me))}click(k,F){this._mousedownPos&&this._mousedownPos.dist(F)>=this._clickTolerance||(this.preclick(k),this._map.fire(new an(k.type,this._map,k)))}dblclick(k){return this._firePreventable(new an(k.type,this._map,k))}mouseover(k){this._map.fire(new an(k.type,this._map,k))}mouseout(k){this._map.fire(new an(k.type,this._map,k))}touchstart(k){return this._firePreventable(new nn(k.type,this._map,k))}touchmove(k){this._map.fire(new nn(k.type,this._map,k))}touchend(k){this._map.fire(new nn(k.type,this._map,k))}touchcancel(k){this._map.fire(new nn(k.type,this._map,k))}_firePreventable(k){if(this._map.fire(k),k.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class hn{constructor(k){this._map=k}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(k){this._map.fire(new an(k.type,this._map,k))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new an("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(k){this._delayContextMenu?this._contextMenuEvent=k:this._map.fire(new an(k.type,this._map,k)),this._map.listens("contextmenu")&&k.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class un{constructor(k,F){this._map=k,this._el=k.getCanvasContainer(),this._container=k.getContainer(),this._clickTolerance=F.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(k,F){this.isEnabled()&&k.shiftKey&&0===k.button&&(_(),this._startPos=this._lastPos=F,this._active=!0)}mousemoveWindow(k,F){if(!this._active)return;const Me=F,Ae=this._startPos,Oe=this._lastPos;if(!Ae||!Oe||Oe.equals(Me)||!this._box&&Me.dist(Ae)<this._clickTolerance)return;this._lastPos=Me,this._box||(this._box=l("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",k));const Fe=Math.min(Ae.x,Me.x),je=Math.max(Ae.x,Me.x),qe=Math.min(Ae.y,Me.y),pt=Math.max(Ae.y,Me.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${Fe}px,${qe}px)`,this._box.style.width=je-Fe+"px",this._box.style.height=pt-qe+"px")}))}mouseupWindow(F,Me){if(!this._active)return;const Ae=this._startPos,Oe=Me;if(Ae&&0===F.button){if(this.reset(),m(),Ae.x!==Oe.x||Ae.y!==Oe.y)return this._map.fire(new k.z("boxzoomend",{originalEvent:F})),{cameraAnimation:k=>k.fitScreenCoordinates(Ae,Oe,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",F)}}keydown(k){this._active&&27===k.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",k))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),p(),delete this._startPos,delete this._lastPos}_fireEvent(F,Me){return this._map.fire(new k.z(F,{originalEvent:Me}))}}function dn(k,F){const Me={};for(let Ae=0;Ae<k.length;Ae++)Me[k[Ae].identifier]=F[Ae];return Me}class _n{constructor(k){this.reset(),this.numTouches=k.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(F,Me,Ae){(this.centroid||Ae.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=F.timeStamp),Ae.length===this.numTouches&&(this.centroid=function(F){const Me=new k.P(0,0);for(const k of F)Me._add(k);return Me.div(F.length)}(Me),this.touches=dn(Ae,Me)))}touchmove(k,F,Me){if(this.aborted||!this.centroid)return;const Ae=dn(Me,F);for(const k in this.touches){const F=Ae[k];(!F||F.dist(this.touches[k])>30)&&(this.aborted=!0)}}touchend(k,F,Me){if((!this.centroid||k.timeStamp-this.startTime>500)&&(this.aborted=!0),0===Me.length){const k=!this.aborted&&this.centroid;if(this.reset(),k)return k}}}class pn{constructor(k){this.singleTap=new _n(k),this.numTaps=k.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(k,F,Me){this.singleTap.touchstart(k,F,Me)}touchmove(k,F,Me){this.singleTap.touchmove(k,F,Me)}touchend(k,F,Me){const Ae=this.singleTap.touchend(k,F,Me);if(Ae){const F=k.timeStamp-this.lastTime<500,Me=!this.lastTap||this.lastTap.dist(Ae)<30;if(F&&Me||this.reset(),this.count++,this.lastTime=k.timeStamp,this.lastTap=Ae,this.count===this.numTaps)return this.reset(),Ae}}}class fn{constructor(){this._zoomIn=new pn({numTouches:1,numTaps:2}),this._zoomOut=new pn({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(k,F,Me){this._zoomIn.touchstart(k,F,Me),this._zoomOut.touchstart(k,F,Me)}touchmove(k,F,Me){this._zoomIn.touchmove(k,F,Me),this._zoomOut.touchmove(k,F,Me)}touchend(k,F,Me){const Ae=this._zoomIn.touchend(k,F,Me),Oe=this._zoomOut.touchend(k,F,Me);return Ae?(this._active=!0,k.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:F=>F.easeTo({duration:300,zoom:F.getZoom()+1,around:F.unproject(Ae)},{originalEvent:k})}):Oe?(this._active=!0,k.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:F=>F.easeTo({duration:300,zoom:F.getZoom()-1,around:F.unproject(Oe)},{originalEvent:k})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Zp={0:1,2:2};class gn{constructor(k){this.reset(),this._clickTolerance=k.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(k,F){return!1}_move(k,F){return{}}mousedown(k,F){if(this._lastPoint)return;const Me=y(k);this._correctButton(k,Me)&&(this._lastPoint=F,this._eventButton=Me)}mousemoveWindow(k,F){const Me=this._lastPoint;if(Me)if(k.preventDefault(),null!=this._eventButton&&function(k,F){const Me=Zp[F];return void 0===k.buttons||(k.buttons&Me)!==Me}(k,this._eventButton))this.reset();else if(this._moved||!(F.dist(Me)<this._clickTolerance))return this._moved=!0,this._lastPoint=F,this._move(Me,F)}mouseupWindow(k){this._lastPoint&&y(k)===this._eventButton&&(this._moved&&m(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class vn extends gn{mousedown(k,F){super.mousedown(k,F),this._lastPoint&&(this._active=!0)}_correctButton(k,F){return 0===F&&!k.ctrlKey}_move(k,F){return{around:F,panDelta:F.sub(k)}}}class yn extends gn{_correctButton(k,F){return 0===F&&k.ctrlKey||2===F}_move(k,F){const Me=.8*(F.x-k.x);if(Me)return this._active=!0,{bearingDelta:Me}}contextmenu(k){k.preventDefault()}}class xn extends gn{_correctButton(k,F){return 0===F&&k.ctrlKey||2===F}_move(k,F){const Me=-.5*(F.y-k.y);if(Me)return this._active=!0,{pitchDelta:Me}}contextmenu(k){k.preventDefault()}}class bn{constructor(F,Me){this._map=F,this._el=F.getCanvasContainer(),this._minTouches=1,this._clickTolerance=Me.clickTolerance||1,this.reset(),k.aP(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new k.P(0,0)}touchstart(k,F,Me){return this._calculateTransform(k,F,Me)}touchmove(F,Me,Ae){if(this._active&&!(Ae.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===Ae.length&&!k.dz())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return F.cancelable&&F.preventDefault(),this._calculateTransform(F,Me,Ae)}}touchend(k,F,Me){this._calculateTransform(k,F,Me),this._active&&Me.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(F,Me,Ae){Ae.length>0&&(this._active=!0);const Oe=dn(Ae,Me),Fe=new k.P(0,0),je=new k.P(0,0);let qe=0;for(const k in Oe){const F=Oe[k],Me=this._touches[k];Me&&(Fe._add(F),je._add(F.sub(Me)),qe++,Oe[k]=F)}if(this._touches=Oe,qe<this._minTouches||!je.mag())return;const pt=je.div(qe);return this._sum._add(pt),this._sum.mag()<this._clickTolerance?void 0:{around:Fe.div(qe),panDelta:pt}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class wn{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(k){}_move(k,F,Me){return{}}touchstart(k,F,Me){this._firstTwoTouches||Me.length<2||(this._firstTwoTouches=[Me[0].identifier,Me[1].identifier],this._start([F[0],F[1]]))}touchmove(k,F,Me){const Ae=this._firstTwoTouches;if(!Ae)return;k.preventDefault();const[Oe,Fe]=Ae,je=Tn(Me,F,Oe),qe=Tn(Me,F,Fe);if(!je||!qe)return;const pt=this._aroundCenter?null:je.add(qe).div(2);return this._move([je,qe],pt,k)}touchend(k,F,Me){if(!this._firstTwoTouches)return;const[Ae,Oe]=this._firstTwoTouches,Fe=Tn(Me,F,Ae),je=Tn(Me,F,Oe);Fe&&je||(this._active&&m(),this.reset())}touchcancel(){this.reset()}enable(k){this._enabled=!0,this._aroundCenter=!!k&&"center"===k.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Tn(k,F,Me){for(let Ae=0;Ae<k.length;Ae++)if(k[Ae].identifier===Me)return F[Ae]}function En(k,F){return Math.log(k/F)/Math.LN2}class Sn extends wn{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(k){this._startDistance=this._distance=k[0].dist(k[1])}_move(k,F){const Me=this._distance;if(this._distance=k[0].dist(k[1]),this._active||!(Math.abs(En(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:En(this._distance,Me),pinchAround:F}}}function Cn(k,F){return 180*k.angleWith(F)/Math.PI}class In extends wn{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(k){this._startVector=this._vector=k[0].sub(k[1]),this._minDiameter=k[0].dist(k[1])}_move(k,F){const Me=this._vector;if(this._vector=k[0].sub(k[1]),Me&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Cn(this._vector,Me),pinchAround:F}}_isBelowThreshold(k){this._minDiameter=Math.min(this._minDiameter,k.mag());const F=25/(Math.PI*this._minDiameter)*360,Me=this._startVector;if(!Me)return!1;const Ae=Cn(k,Me);return Math.abs(Ae)<F}}function Rn(k){return Math.abs(k.y)>Math.abs(k.x)}class Dn extends wn{constructor(k){super(),this._map=k}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(k){this._lastPoints=k,Rn(k[0].sub(k[1]))&&(this._valid=!1)}_move(F,Me,Ae){const Oe=this._lastPoints;if(!Oe)return;const Fe=F[0].sub(Oe[0]),je=F[1].sub(Oe[1]);return this._map._cooperativeGestures&&!k.dz()&&Ae.touches.length<3||(this._valid=this.gestureBeginsVertically(Fe,je,Ae.timeStamp),!this._valid)?void 0:(this._lastPoints=F,this._active=!0,{pitchDelta:(Fe.y+je.y)/2*-.5})}gestureBeginsVertically(k,F,Me){if(void 0!==this._valid)return this._valid;const Ae=k.mag()>=2,Oe=F.mag()>=2;if(!Ae&&!Oe)return;if(!Ae||!Oe)return null==this._firstMove&&(this._firstMove=Me),Me-this._firstMove<100&&void 0;const Fe=k.y>0==F.y>0;return Rn(k)&&Rn(F)&&Fe}}const Hp={panStep:100,bearingStep:15,pitchStep:10};class An{constructor(){const k=Hp;this._panStep=k.panStep,this._bearingStep=k.bearingStep,this._pitchStep=k.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(k){if(k.altKey||k.ctrlKey||k.metaKey)return;let F=0,Me=0,Ae=0,Oe=0,Fe=0;switch(k.keyCode){case 61:case 107:case 171:case 187:F=1;break;case 189:case 109:case 173:F=-1;break;case 37:k.shiftKey?Me=-1:(k.preventDefault(),Oe=-1);break;case 39:k.shiftKey?Me=1:(k.preventDefault(),Oe=1);break;case 38:k.shiftKey?Ae=1:(k.preventDefault(),Fe=-1);break;case 40:k.shiftKey?Ae=-1:(k.preventDefault(),Fe=1);break;default:return}return this._rotationDisabled&&(Me=0,Ae=0),{cameraAnimation:je=>{const qe=je.getZoom();je.easeTo({duration:300,easeId:"keyboardHandler",easing:zn,zoom:F?Math.round(qe)+F*(k.shiftKey?2:1):qe,bearing:je.getBearing()+Me*this._bearingStep,pitch:je.getPitch()+Ae*this._pitchStep,offset:[-Oe*this._panStep,-Fe*this._panStep],center:je.getCenter()},{originalEvent:k})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function zn(k){return k*(2-k)}const $p=4.000244140625,Xp=1/450;class On{constructor(F,Me){this._map=F,this._el=F.getCanvasContainer(),this._handler=Me,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Xp,k.aP(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(k){this._defaultZoomRate=k}setWheelZoomRate(k){this._wheelZoomRate=k}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(k){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!k&&"center"===k.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(F){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(F.ctrlKey||F.metaKey||this.isZooming()||k.dz()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let Me=F.deltaMode===WheelEvent.DOM_DELTA_LINE?40*F.deltaY:F.deltaY;const Ae=k.q.now(),Oe=Ae-(this._lastWheelEventTime||0);this._lastWheelEventTime=Ae,0!==Me&&Me%$p==0?this._type="wheel":0!==Me&&Math.abs(Me)<4?this._type="trackpad":Oe>400?(this._type=null,this._lastValue=Me,this._timeout=window.setTimeout(this._onTimeout,40,F)):this._type||(this._type=Math.abs(Oe*Me)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,Me+=this._lastValue)),F.shiftKey&&Me&&(Me/=4),this._type&&(this._lastWheelEvent=F,this._delta-=Me,this._active||this._start(F)),F.preventDefault()}_onTimeout(k){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(k)}_start(k){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const F=g(this._el,k);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:F,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const F=this._map.transform;"wheel"===this._type&&F.projection.wrap&&(F._center.lng>=180||F._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>F._terrainEnabled()&&this._aroundCoord?F.computeZoomRelativeTo(this._aroundCoord):F.zoom;if(0!==this._delta){const k="wheel"===this._type&&Math.abs(this._delta)>$p?this._wheelZoomRate:this._defaultZoomRate;let Me=2/(1+Math.exp(-Math.abs(this._delta*k)));this._delta<0&&0!==Me&&(Me=1/Me);const Ae=i(),Oe=Math.pow(2,Ae),Fe="number"==typeof this._targetZoom?F.zoomScale(this._targetZoom):Oe;this._targetZoom=Math.min(F.maxZoom,Math.max(F.minZoom,F.scaleZoom(Fe*Me))),"wheel"===this._type&&(this._startZoom=Ae,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const Me="number"==typeof this._targetZoom?this._targetZoom:i(),Ae=this._startZoom,Oe=this._easing;let Fe,je=!1;if("wheel"===this._type&&Ae&&Oe){const F=Math.min((k.q.now()-this._lastWheelEventTime)/200,1),qe=Oe(F);Fe=k.af(Ae,Me,qe),F<1?this._frameId||(this._frameId=!0):je=!0}else Fe=Me,je=!0;this._active=!0,je&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let qe=Fe-i();return qe*this._lastDelta<0&&(qe=0),{noInertia:!0,needsRenderFrame:!je,zoomDelta:qe,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(F){let Me=k.dA;if(this._prevEase){const F=this._prevEase,Ae=(k.q.now()-F.start)/F.duration,Oe=F.easing(Ae+.01)-F.easing(Ae),Fe=.27/Math.sqrt(Oe*Oe+1e-4)*.01,je=Math.sqrt(.0729-Fe*Fe);Me=k.dy(Fe,je,.25,1)}return this._prevEase={start:k.q.now(),duration:F,easing:Me},Me}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class Fn{constructor(k,F){this._clickZoom=k,this._tapZoom=F}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class kn{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(k,F){return k.preventDefault(),{cameraAnimation:Me=>{Me.easeTo({duration:300,zoom:Me.getZoom()+(k.shiftKey?-1:1),around:Me.unproject(F)},{originalEvent:k})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Bn{constructor(){this._tap=new pn({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(k,F,Me){this._swipePoint||(this._tapTime&&k.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?Me.length>0&&(this._swipePoint=F[0],this._swipeTouch=Me[0].identifier):this._tap.touchstart(k,F,Me))}touchmove(k,F,Me){if(this._tapTime){if(this._swipePoint){if(Me[0].identifier!==this._swipeTouch)return;const Ae=F[0],Oe=Ae.y-this._swipePoint.y;return this._swipePoint=Ae,k.preventDefault(),this._active=!0,{zoomDelta:Oe/128}}}else this._tap.touchmove(k,F,Me)}touchend(k,F,Me){this._tapTime?this._swipePoint&&0===Me.length&&this.reset():this._tap.touchend(k,F,Me)&&(this._tapTime=k.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Nn{constructor(k,F,Me){this._el=k,this._mousePan=F,this._touchPan=Me}enable(k){this._inertiaOptions=k||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Un{constructor(k,F,Me){this._pitchWithRotate=k.pitchWithRotate,this._mouseRotate=F,this._mousePitch=Me}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Gn{constructor(k,F,Me,Ae){this._el=k,this._touchZoom=F,this._touchRotate=Me,this._tapDragZoom=Ae,this._rotationDisabled=!1,this._enabled=!0}enable(k){this._touchZoom.enable(k),this._rotationDisabled||this._touchRotate.enable(k),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const jn=k=>k.zoom||k.drag||k.pitch||k.rotate;class Vn extends k.z{}class qn{constructor(){this.constants=[1,1,.01],this.radius=0}setup(F,Me){const Ae=k.ab.vec3.sub([],Me,F);this.radius=k.ab.vec3.length(Ae[2]<0?k.ab.vec3.div([],Ae,this.constants):[Ae[0],Ae[1],0])}projectRay(F){k.ab.vec3.div(F,F,this.constants),k.ab.vec3.normalize(F,F),k.ab.vec3.mul(F,F,this.constants);const Me=k.ab.vec3.scale([],F,this.radius);if(Me[2]>0){const F=k.ab.vec3.scale([],[0,0,1],k.ab.vec3.dot(Me,[0,0,1])),Ae=k.ab.vec3.scale([],k.ab.vec3.normalize([],[Me[0],Me[1],0]),this.radius),Oe=k.ab.vec3.add([],Me,k.ab.vec3.scale([],k.ab.vec3.sub([],k.ab.vec3.add([],Ae,F),Me),2));Me[0]=Oe[0],Me[1]=Oe[1]}return Me}}function Hn(k){return k.panDelta&&k.panDelta.mag()||k.zoomDelta||k.bearingDelta||k.pitchDelta}class Zn{constructor(F,Me){this._map=F,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new on(F),this._bearingSnap=Me.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new qn,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(Me),k.aP(["handleEvent","handleWindowEvent"],this);const Ae=this._el;this._listeners=[[Ae,"touchstart",{passive:!0}],[Ae,"touchmove",{passive:!1}],[Ae,"touchend",void 0],[Ae,"touchcancel",void 0],[Ae,"mousedown",void 0],[Ae,"mousemove",void 0],[Ae,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[Ae,"mouseover",void 0],[Ae,"mouseout",void 0],[Ae,"dblclick",void 0],[Ae,"click",void 0],[Ae,"keydown",{capture:!1}],[Ae,"keyup",void 0],[Ae,"wheel",{passive:!1}],[Ae,"contextmenu",void 0],[window,"blur",void 0]];for(const[k,F,Me]of this._listeners){const Ae=k===document?this.handleWindowEvent:this.handleEvent;k.addEventListener(F,Ae,Me)}}destroy(){for(const[k,F,Me]of this._listeners){const Ae=k===document?this.handleWindowEvent:this.handleEvent;k.removeEventListener(F,Ae,Me)}}_addDefaultHandlers(k){const F=this._map,Me=F.getCanvasContainer();this._add("mapEvent",new cn(F,k));const Ae=F.boxZoom=new un(F,k);this._add("boxZoom",Ae);const Oe=new fn,Fe=new kn;F.doubleClickZoom=new Fn(Fe,Oe),this._add("tapZoom",Oe),this._add("clickZoom",Fe);const je=new Bn;this._add("tapDragZoom",je);const qe=F.touchPitch=new Dn(F);this._add("touchPitch",qe);const pt=new yn(k),vt=new xn(k);F.dragRotate=new Un(k,pt,vt),this._add("mouseRotate",pt,["mousePitch"]),this._add("mousePitch",vt,["mouseRotate"]);const Ut=new vn(k),xi=new bn(F,k);F.dragPan=new Nn(Me,Ut,xi),this._add("mousePan",Ut),this._add("touchPan",xi,["touchZoom","touchRotate"]);const vi=new In,bi=new Sn;F.touchZoomRotate=new Gn(Me,bi,vi,je),this._add("touchRotate",vi,["touchPan","touchZoom"]),this._add("touchZoom",bi,["touchPan","touchRotate"]),this._add("blockableMapEvent",new hn(F));const wi=F.scrollZoom=new On(F,this);this._add("scrollZoom",wi,["mousePan"]);const Mi=F.keyboard=new An;this._add("keyboard",Mi);for(const Me of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])k.interactive&&k[Me]&&F[Me].enable(k[Me])}_add(k,F,Me){this._handlers.push({handlerName:k,handler:F,allowed:Me}),this._handlersById[k]=F}stop(k){if(!this._updatingCamera){for(const{handler:k}of this._handlers)k.reset();this._inertia.clear(),this._fireEvents({},{},k),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:k}of this._handlers)if(k.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!jn(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(k,F,Me){for(const Ae in k)if(Ae!==Me&&(!F||F.indexOf(Ae)<0))return!0;return!1}handleWindowEvent(k){this.handleEvent(k,`${k.type}Window`)}_getMapTouches(k){const F=[];for(const Me of k)this._el.contains(Me.target)&&F.push(Me);return F}handleEvent(k,F){this._updatingCamera=!0;const Me="renderFrame"===k.type,Ae=Me?void 0:k,Oe={needsRenderFrame:!1},Fe={},je={},qe=k.touches?this._getMapTouches(k.touches):void 0,pt=qe?v(this._el,qe):Me?void 0:g(this._el,k);for(const{handlerName:Me,handler:vt,allowed:Ut}of this._handlers){if(!vt.isEnabled())continue;let xi;this._blockedByActive(je,Ut,Me)?vt.reset():vt[F||k.type]&&(xi=vt[F||k.type](k,pt,qe),this.mergeHandlerResult(Oe,Fe,xi,Me,Ae),xi&&xi.needsRenderFrame&&this._triggerRenderFrame()),(xi||vt.isActive())&&(je[Me]=vt)}const vt={};for(const k in this._previousActiveHandlers)je[k]||(vt[k]=Ae);this._previousActiveHandlers=je,(Object.keys(vt).length||Hn(Oe))&&(this._changes.push([Oe,Fe,vt]),this._triggerRenderFrame()),(Object.keys(je).length||Hn(Oe))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:Ut}=Oe;Ut&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],Ut(this._map))}mergeHandlerResult(F,Me,Ae,Oe,Fe){if(!Ae)return;k.l(F,Ae);const je={handlerName:Oe,originalEvent:Ae.originalEvent||Fe};void 0!==Ae.zoomDelta&&(Me.zoom=je),void 0!==Ae.panDelta&&(Me.drag=je),void 0!==Ae.pitchDelta&&(Me.pitch=je),void 0!==Ae.bearingDelta&&(Me.rotate=je)}_applyChanges(){const F={},Me={},Ae={};for(const[Oe,Fe,je]of this._changes)Oe.panDelta&&(F.panDelta=(F.panDelta||new k.P(0,0))._add(Oe.panDelta)),Oe.zoomDelta&&(F.zoomDelta=(F.zoomDelta||0)+Oe.zoomDelta),Oe.bearingDelta&&(F.bearingDelta=(F.bearingDelta||0)+Oe.bearingDelta),Oe.pitchDelta&&(F.pitchDelta=(F.pitchDelta||0)+Oe.pitchDelta),void 0!==Oe.around&&(F.around=Oe.around),void 0!==Oe.aroundCoord&&(F.aroundCoord=Oe.aroundCoord),void 0!==Oe.pinchAround&&(F.pinchAround=Oe.pinchAround),Oe.noInertia&&(F.noInertia=Oe.noInertia),k.l(Me,Fe),k.l(Ae,je);this._updateMapTransform(F,Me,Ae),this._changes=[]}_updateMapTransform(F,Me,Ae){const Oe=this._map,Fe=Oe.transform,a=k=>[k.x,k.y,k.z];if((k=>{const F=this._eventsInProgress.drag;return F&&!this._handlersById[F.handlerName].isActive()})()&&!Hn(F)){const k=Fe.zoom;Fe.cameraElevationReference="sea",null!=this._originalZoom&&Fe._orthographicProjectionAtLowPitch&&"globe"!==Fe.projection.name&&0===Fe.pitch?(Fe.cameraElevationReference="ground",Fe.zoom=this._originalZoom):(Fe.recenterOnTerrain(),Fe.cameraElevationReference="ground"),k!==Fe.zoom&&this._map._update(!0)}if(Fe._isCameraConstrained&&Oe._stop(!0),!Hn(F))return void this._fireEvents(Me,Ae,!0);let{panDelta:je,zoomDelta:qe,bearingDelta:pt,pitchDelta:vt,around:Ut,aroundCoord:xi,pinchAround:vi}=F;Fe._isCameraConstrained&&(qe>0&&(qe=0),Fe._isCameraConstrained=!1),void 0!==vi&&(Ut=vi),(qe||(k=>Me[k]&&!this._eventsInProgress[k])("drag"))&&Ut&&(this._dragOrigin=a(Fe.pointCoordinate3D(Ut)),this._originalZoom=Fe.zoom,this._trackingEllipsoid.setup(Fe._camera.position,this._dragOrigin)),Fe.cameraElevationReference="sea",Oe._stop(!0),Ut=Ut||Oe.transform.centerPoint,pt&&(Fe.bearing+=pt),vt&&(Fe.pitch+=vt),Fe._updateCameraState();const bi=[0,0,0];if(je)if("mercator"===Fe.projection.name){const k=this._trackingEllipsoid.projectRay(Fe.screenPointToMercatorRay(Ut).dir),F=this._trackingEllipsoid.projectRay(Fe.screenPointToMercatorRay(Ut.sub(je)).dir);bi[0]=F[0]-k[0],bi[1]=F[1]-k[1]}else{const F=Fe.pointCoordinate(Ut);if("globe"===Fe.projection.name){je=je.rotate(-Fe.angle);const Me=Fe._pixelsPerMercatorPixel/Fe.worldSize;bi[0]=-je.x*k.dB(k.aS(F.y))*Me,bi[1]=-je.y*k.dB(Fe.center.lat)*Me}else{const k=Fe.pointCoordinate(Ut.sub(je));F&&k&&(bi[0]=k.x-F.x,bi[1]=k.y-F.y)}}const wi=Fe.zoom,Mi=[0,0,0];if(qe){const F=a(xi||Fe.pointCoordinate3D(Ut)),Me={dir:k.ab.vec3.normalize([],k.ab.vec3.sub([],F,Fe._camera.position))};if(Me.dir[2]<0){const Ae=Fe.zoomDeltaToMovement(F,qe);k.ab.vec3.scale(Mi,Me.dir,Ae)}}const pr=k.ab.vec3.add(bi,bi,Mi);Fe._translateCameraConstrained(pr),qe&&Math.abs(Fe.zoom-wi)>1e-4&&Fe.recenterOnTerrain(),Fe.cameraElevationReference="ground",this._map._update(),F.noInertia||this._inertia.record(F),this._fireEvents(Me,Ae,!0)}_fireEvents(F,Me,Ae){const Oe=jn(this._eventsInProgress),Fe=jn(F),je={};for(const k in F){const{originalEvent:Me}=F[k];this._eventsInProgress[k]||(je[`${k}start`]=Me),this._eventsInProgress[k]=F[k]}!Oe&&Fe&&this._fireEvent("movestart",Fe.originalEvent);for(const k in je)this._fireEvent(k,je[k]);Fe&&this._fireEvent("move",Fe.originalEvent);for(const k in F){const{originalEvent:Me}=F[k];this._fireEvent(k,Me)}const qe={};let pt;for(const k in this._eventsInProgress){const{handlerName:F,originalEvent:Ae}=this._eventsInProgress[k];this._handlersById[F].isActive()||(delete this._eventsInProgress[k],pt=Me[F]||Ae,qe[`${k}end`]=pt)}for(const k in qe)this._fireEvent(k,qe[k]);const vt=jn(this._eventsInProgress);if(Ae&&(Oe||Fe)&&!vt){this._updatingCamera=!0;const F=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=k=>0!==k&&-this._bearingSnap<k&&k<this._bearingSnap;F?(i(F.bearing||this._map.getBearing())&&(F.bearing=0),this._map.easeTo(F,{originalEvent:pt})):(this._map.fire(new k.z("moveend",{originalEvent:pt})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(F,Me){this._map.fire(new k.z(F,Me?{originalEvent:Me}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((k=>{this._frameId=void 0,this.handleEvent(new Vn("renderFrame",{timeStamp:k})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Yp="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class $n extends k.E{constructor(F,Me){super(),this._moving=!1,this._zooming=!1,this.transform=F,this._bearingSnap=Me.bearingSnap,this._respectPrefersReducedMotion=!1!==Me.respectPrefersReducedMotion,k.aP(["_renderFrameCallback"],this)}getCenter(){return new k.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(k,F){return this.jumpTo({center:k},F)}panBy(F,Me,Ae){return F=k.P.convert(F).mult(-1),this.panTo(this.transform.center,k.l({offset:F},Me),Ae)}panTo(F,Me,Ae){return this.easeTo(k.l({center:F},Me),Ae)}getZoom(){return this.transform.zoom}setZoom(k,F){return this.jumpTo({zoom:k},F),this}zoomTo(F,Me,Ae){return this.easeTo(k.l({zoom:F},Me),Ae)}zoomIn(k,F){return this.zoomTo(this.getZoom()+1,k,F),this}zoomOut(k,F){return this.zoomTo(this.getZoom()-1,k,F),this}getBearing(){return this.transform.bearing}setBearing(k,F){return this.jumpTo({bearing:k},F),this}getPadding(){return this.transform.padding}setPadding(k,F){return this.jumpTo({padding:k},F),this}rotateTo(F,Me,Ae){return this.easeTo(k.l({bearing:F},Me),Ae)}resetNorth(F,Me){return this.rotateTo(0,k.l({duration:1e3},F),Me),this}resetNorthPitch(F,Me){return this.easeTo(k.l({bearing:0,pitch:0,duration:1e3},F),Me),this}snapToNorth(k,F){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(k,F):this}getPitch(){return this.transform.pitch}setPitch(k,F){return this.jumpTo({pitch:k},F),this}cameraForBounds(F,Me){F=k.az.convert(F);const Ae=Me&&Me.bearing||0,Oe=Me&&Me.pitch||0,Fe=F.getNorthWest(),je=F.getSouthEast();return this._cameraForBounds(this.transform,Fe,je,Ae,Oe,Me)}_extendPadding(F){const Me={top:0,right:0,bottom:0,left:0};return null==F?k.l({},Me,this.transform.padding):"number"==typeof F?{top:F,bottom:F,right:F,left:F}:k.l({},Me,F)}_extendCameraOptions(F){return(F=k.l({offset:[0,0],maxZoom:this.transform.maxZoom},F)).padding=this._extendPadding(F.padding),F}_minimumAABBFrustumDistance(k,F){const Me=F.max[0]-F.min[0],Ae=F.max[1]-F.min[1];return Me/Ae>k.aspect?Me/(2*Math.tan(.5*k.fovX)*k.aspect):Ae/(2*Math.tan(.5*k.fovY)*k.aspect)}_cameraForBoundsOnGlobe(F,Me,Ae,Oe,Fe,je){const qe=F.clone(),pt=this._extendCameraOptions(je);qe.bearing=Oe,qe.pitch=Fe;const vt=k.bO.convert(Me),Ut=k.bO.convert(Ae),xi=.5*(vt.lat+Ut.lat),vi=.5*(vt.lng+Ut.lng),bi=k.dC(xi,vi),wi=k.ab.vec3.normalize([],bi),Mi=k.ab.vec3.normalize([],k.ab.vec3.cross([],wi,[0,1,0])),pr=k.ab.vec3.cross([],Mi,wi),Ur=[Mi[0],Mi[1],Mi[2],0,pr[0],pr[1],pr[2],0,wi[0],wi[1],wi[2],0,0,0,0,1],Wr=[bi,k.dC(vt.lat,vt.lng),k.dC(Ut.lat,vt.lng),k.dC(Ut.lat,Ut.lng),k.dC(vt.lat,Ut.lng),k.dC(xi,vt.lng),k.dC(xi,Ut.lng),k.dC(vt.lat,vi),k.dC(Ut.lat,vi)];let Jr=k.cd.fromPoints(Wr.map((F=>[k.ab.vec3.dot(Mi,F),k.ab.vec3.dot(pr,F),k.ab.vec3.dot(wi,F)])));const Qr=k.ab.vec3.transformMat4([],Jr.center,Ur);0===k.ab.vec3.squaredLength(Qr)&&k.ab.vec3.set(Qr,0,0,1),k.ab.vec3.normalize(Qr,Qr),k.ab.vec3.scale(Qr,Qr,k.ax),qe.center=k.dD(Qr);const co=qe.getWorldToCameraMatrix(),mo=k.ab.mat4.invert(new Float64Array(16),co);Jr=k.cd.applyTransform(Jr,k.ab.mat4.multiply([],co,Ur));const yo=this._extendAABB(Jr,qe,pt,Oe);if(!yo)return void k.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Jr=yo,k.ab.vec3.transformMat4(Qr,Qr,co);const To=.5*(Jr.max[2]-Jr.min[2]),zo=this._minimumAABBFrustumDistance(qe,Jr),ko=k.ab.vec3.scale([],[0,0,1],To),na=k.ab.vec3.add(ko,Qr,ko),aa=zo+(0===qe.pitch?0:k.ab.vec3.distance(Qr,na)),_a=qe.globeCenterInViewSpace,wa=k.ab.vec3.sub([],Qr,[_a[0],_a[1],_a[2]]);k.ab.vec3.normalize(wa,wa),k.ab.vec3.scale(wa,wa,aa);const Sa=k.ab.vec3.add([],Qr,wa);k.ab.vec3.transformMat4(Sa,Sa,mo);const Ya=k.ds/k.ax,rl=k.ab.vec3.length(Sa),sl=k.bH(Math.max(rl*Ya-k.ds,Number.EPSILON),0),ml=Math.min(qe.zoomFromMercatorZAdjusted(sl),pt.maxZoom);return ml>.5*(k.c6+k.bY)?(qe.setProjection({name:"mercator"}),qe.zoom=ml,this._cameraForBounds(qe,Me,Ae,Oe,Fe,je)):{center:qe.center,zoom:ml,bearing:Oe,pitch:Fe}}_extendAABB(F,Me,Ae,Oe){const Fe=.5*((Ae.padding.left||0)+(Ae.padding.right||0)),je=.5*((Ae.padding.top||0)+(Ae.padding.bottom||0)),qe=je,pt=Fe,vt=Fe,Ut=je,xi=Me.width-(pt+vt),vi=Me.height-(qe+Ut),bi=k.ab.vec3.sub([],F.max,F.min),wi=Math.min(xi/bi[0],vi/bi[1]),Mi=Math.min(Me.scaleZoom(Me.scale*wi),Ae.maxZoom);if(isNaN(Mi))return null;const pr=Me.scale/Me.zoomScale(Mi),Ur=new k.cd([F.min[0]-pt*pr,F.min[1]-Ut*pr,F.min[2]],[F.max[0]+vt*pr,F.max[1]+qe*pr,F.max[2]]),Wr=("number"==typeof Ae.offset.x&&"number"==typeof Ae.offset.y?new k.P(Ae.offset.x,Ae.offset.y):k.P.convert(Ae.offset)).rotate(-k.ai(Oe));return Ur.center[0]-=Wr.x*pr,Ur.center[1]+=Wr.y*pr,Ur}queryTerrainElevation(F,Me){const Ae=this.transform.elevation;return Ae?(Me=k.l({},{exaggerated:!0},Me),Ae.getAtPoint(k.aa.fromLngLat(F),null,Me.exaggerated)):null}_cameraForBounds(F,Me,Ae,Oe,Fe,je){if("globe"===F.projection.name)return this._cameraForBoundsOnGlobe(F,Me,Ae,Oe,Fe,je);const qe=F.clone(),pt=this._extendCameraOptions(je);qe.bearing=Oe,qe.pitch=Fe;const vt=k.bO.convert(Me),Ut=k.bO.convert(Ae),xi=new k.bO(vt.lng,Ut.lat),vi=new k.bO(Ut.lng,vt.lat),bi=qe.project(vt),wi=qe.project(Ut),Mi=this.queryTerrainElevation(vt),pr=this.queryTerrainElevation(Ut),Ur=this.queryTerrainElevation(xi),Wr=this.queryTerrainElevation(vi),Jr=[[bi.x,bi.y,Math.min(Mi||0,pr||0,Ur||0,Wr||0)],[wi.x,wi.y,Math.max(Mi||0,pr||0,Ur||0,Wr||0)]];let Qr=k.cd.fromPoints(Jr);const co=qe.getWorldToCameraMatrix(),mo=k.ab.mat4.invert(new Float64Array(16),co);Qr=k.cd.applyTransform(Qr,co);const yo=this._extendAABB(Qr,qe,pt,Oe);if(!yo)return void k.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Qr=yo;const To=.5*k.ab.vec3.sub([],Qr.max,Qr.min)[2],zo=this._minimumAABBFrustumDistance(qe,Qr),ko=[0,0,1,0];k.ab.vec4.transformMat4(ko,ko,co),k.ab.vec4.normalize(ko,ko);const na=k.ab.vec3.scale([],ko,zo+To),aa=k.ab.vec3.add([],Qr.center,na);k.ab.vec3.transformMat4(Qr.center,Qr.center,mo),k.ab.vec3.transformMat4(aa,aa,mo);const _a=qe.unproject(new k.P(Qr.center[0],Qr.center[1])),wa=k.dE(qe.projection,_a),Sa=Math.pow(2,wa),Ya=Math.min(qe._zoomFromMercatorZ(aa[2]*qe.pixelsPerMeter*Sa/qe.worldSize),pt.maxZoom);return qe.mercatorFromTransition&&Ya<.5*(k.c6+k.bY)?(qe.setProjection({name:"globe"}),qe.zoom=Ya,this._cameraForBounds(qe,Me,Ae,Oe,Fe,je)):{center:_a,zoom:Ya,bearing:Oe,pitch:Fe}}fitBounds(k,F,Me){const Ae=this.cameraForBounds(k,F);return this._fitInternal(Ae,F,Me)}fitScreenCoordinates(F,Me,Ae,Oe,Fe){const je=k.P.convert(F),qe=k.P.convert(Me),pt=new k.P(Math.min(je.x,qe.x),Math.min(je.y,qe.y)),vt=new k.P(Math.max(je.x,qe.x),Math.max(je.y,qe.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(je,qe))return this;const Ut=this.transform.pointLocation3D(pt),xi=this.transform.pointLocation3D(vt),vi=this.transform.pointLocation3D(new k.P(pt.x,vt.y)),bi=this.transform.pointLocation3D(new k.P(vt.x,pt.y)),wi=[Math.min(Ut.lng,xi.lng,vi.lng,bi.lng),Math.min(Ut.lat,xi.lat,vi.lat,bi.lat)],Mi=[Math.max(Ut.lng,xi.lng,vi.lng,bi.lng),Math.max(Ut.lat,xi.lat,vi.lat,bi.lat)],pr=Oe&&Oe.pitch?Oe.pitch:this.getPitch(),Ur=this._cameraForBounds(this.transform,wi,Mi,Ae,pr,Oe);return this._fitInternal(Ur,Oe,Fe)}_fitInternal(F,Me,Ae){return F?(Me=k.l(F,Me)).linear?this.easeTo(Me,Ae):this.flyTo(Me,Ae):this}jumpTo(F,Me){this.stop();const Ae=F.preloadOnly?this.transform.clone():this.transform;let Oe=!1,Fe=!1,je=!1;"zoom"in F&&Ae.zoom!==+F.zoom&&(Oe=!0,Ae.zoom=+F.zoom),void 0!==F.center&&(Ae.center=k.bO.convert(F.center)),"bearing"in F&&Ae.bearing!==+F.bearing&&(Fe=!0,Ae.bearing=+F.bearing),"pitch"in F&&Ae.pitch!==+F.pitch&&(je=!0,Ae.pitch=+F.pitch);const qe="number"==typeof F.padding?this._extendPadding(F.padding):F.padding;if(null!=F.padding&&!Ae.isPaddingEqual(qe))if(!1===F.retainPadding){const k=Ae.clone();k.padding=qe,Ae.setLocationAtPoint(Ae.center,k.centerPoint)}else Ae.padding=qe;return F.preloadOnly?(this._preloadTiles(Ae),this):(this.fire(new k.z("movestart",Me)).fire(new k.z("move",Me)),Oe&&this.fire(new k.z("zoomstart",Me)).fire(new k.z("zoom",Me)).fire(new k.z("zoomend",Me)),Fe&&this.fire(new k.z("rotatestart",Me)).fire(new k.z("rotate",Me)).fire(new k.z("rotateend",Me)),je&&this.fire(new k.z("pitchstart",Me)).fire(new k.z("pitch",Me)).fire(new k.z("pitchend",Me)),this.fire(new k.z("moveend",Me)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||k.w(Yp),this.transform.getFreeCameraOptions()}setFreeCameraOptions(F,Me){const Ae=this.transform;if(!Ae.projection.supportsFreeCamera)return k.w(Yp),this;this.stop();const Oe=Ae.zoom,Fe=Ae.pitch,je=Ae.bearing;Ae.setFreeCameraOptions(F);const qe=Oe!==Ae.zoom,pt=Fe!==Ae.pitch,vt=je!==Ae.bearing;return this.fire(new k.z("movestart",Me)).fire(new k.z("move",Me)),qe&&this.fire(new k.z("zoomstart",Me)).fire(new k.z("zoom",Me)).fire(new k.z("zoomend",Me)),vt&&this.fire(new k.z("rotatestart",Me)).fire(new k.z("rotate",Me)).fire(new k.z("rotateend",Me)),pt&&this.fire(new k.z("pitchstart",Me)).fire(new k.z("pitch",Me)).fire(new k.z("pitchend",Me)),this.fire(new k.z("moveend",Me)),this}easeTo(F,Me){this._stop(!1,F.easeId),(!1===(F=k.l({offset:[0,0],duration:500,easing:k.dA},F)).animate||this._prefersReducedMotion(F))&&(F.duration=0);const Ae=this.transform,Oe=this.getZoom(),Fe=this.getBearing(),je=this.getPitch(),qe=this.getPadding(),pt="zoom"in F?+F.zoom:Oe,vt="bearing"in F?this._normalizeBearing(F.bearing,Fe):Fe,Ut="pitch"in F?+F.pitch:je,xi=this._extendPadding(F.padding),vi=k.P.convert(F.offset);let bi,wi,Mi;if("globe"===Ae.projection.name){const Me=k.aa.fromLngLat(Ae.center),Oe=vi.rotate(-Ae.angle);Me.x+=Oe.x/Ae.worldSize,Me.y+=Oe.y/Ae.worldSize;const Fe=Me.toLngLat(),je=k.bO.convert(F.center||Fe);this._normalizeCenter(je),bi=Ae.centerPoint.add(Oe),wi=new k.P(Me.x,Me.y).mult(Ae.worldSize),Mi=new k.P(k.at(je.lng),k.aA(je.lat)).mult(Ae.worldSize).sub(wi)}else{bi=Ae.centerPoint.add(vi);const Me=Ae.pointLocation(bi),Oe=k.bO.convert(F.center||Me);this._normalizeCenter(Oe),wi=Ae.project(Me),Mi=Ae.project(Oe).sub(wi)}const pr=Ae.zoomScale(pt-Oe);let Ur,Wr;F.around&&(Ur=k.bO.convert(F.around),Wr=Ae.locationPoint(Ur));const Jr=this._zooming||pt!==Oe,Qr=this._rotating||Fe!==vt,co=this._pitching||Ut!==je,mo=!Ae.isPaddingEqual(xi),yo=!1===F.retainPadding?Ae.clone():Ae,E=Ae=>To=>{if(Jr&&(Ae.zoom=k.af(Oe,pt,To)),Qr&&(Ae.bearing=k.af(Fe,vt,To)),co&&(Ae.pitch=k.af(je,Ut,To)),mo&&(yo.interpolatePadding(qe,xi,To),bi=yo.centerPoint.add(vi)),Ur)Ae.setLocationAtPoint(Ur,Wr);else{const k=Ae.zoomScale(Ae.zoom-Oe),F=pt>Oe?Math.min(2,pr):Math.max(.5,pr),Me=Math.pow(F,1-To),Fe=Ae.unproject(wi.add(Mi.mult(To*Me)).mult(k));Ae.setLocationAtPoint(Ae.renderWorldCopies?Fe.wrap():Fe,bi)}return F.preloadOnly||this._fireMoveEvents(Me),Ae};if(F.preloadOnly){const k=this._emulate(E,F.duration,Ae);return this._preloadTiles(k),this}const To={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Jr,this._rotating=Qr,this._pitching=co,this._padding=mo,this._easeId=F.easeId,this._prepareEase(Me,F.noMoveStart,To),this._ease(E(Ae),(k=>{"sea"===Ae.cameraElevationReference&&Ae.recenterOnTerrain(),this._afterEase(Me,k)}),F),this}_prepareEase(F,Me,Ae={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),Me||Ae.moving||this.fire(new k.z("movestart",F)),this._zooming&&!Ae.zooming&&this.fire(new k.z("zoomstart",F)),this._rotating&&!Ae.rotating&&this.fire(new k.z("rotatestart",F)),this._pitching&&!Ae.pitching&&this.fire(new k.z("pitchstart",F))}_fireMoveEvents(F){this.fire(new k.z("move",F)),this._zooming&&this.fire(new k.z("zoom",F)),this._rotating&&this.fire(new k.z("rotate",F)),this._pitching&&this.fire(new k.z("pitch",F))}_afterEase(F,Me){if(this._easeId&&Me&&this._easeId===Me)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const Ae=this._zooming,Oe=this._rotating,Fe=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,Ae&&this.fire(new k.z("zoomend",F)),Oe&&this.fire(new k.z("rotateend",F)),Fe&&this.fire(new k.z("pitchend",F)),this.fire(new k.z("moveend",F))}flyTo(F,Me){if(this._prefersReducedMotion(F)){const Ae=k.ay(F,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Ae,Me)}this.stop(),F=k.l({offset:[0,0],speed:1.2,curve:1.42,easing:k.dA},F);const Ae=this.transform,Oe=this.getZoom(),Fe=this.getBearing(),je=this.getPitch(),qe=this.getPadding(),pt="zoom"in F?k.aw(+F.zoom,Ae.minZoom,Ae.maxZoom):Oe,vt="bearing"in F?this._normalizeBearing(F.bearing,Fe):Fe,Ut="pitch"in F?+F.pitch:je,xi=this._extendPadding(F.padding),vi=Ae.zoomScale(pt-Oe),bi=k.P.convert(F.offset);let wi=Ae.centerPoint.add(bi);const Mi=Ae.pointLocation(wi),pr=k.bO.convert(F.center||Mi);this._normalizeCenter(pr);const Ur=Ae.project(Mi),Wr=Ae.project(pr).sub(Ur);let Jr=F.curve;const Qr=Math.max(Ae.width,Ae.height),co=Qr/vi,mo=Wr.mag();if("minZoom"in F){const Me=k.aw(Math.min(F.minZoom,Oe,pt),Ae.minZoom,Ae.maxZoom),Fe=Qr/Ae.zoomScale(Me-Oe);Jr=Math.sqrt(Fe/mo*2)}const yo=Jr*Jr;function E(k){const F=(co*co-Qr*Qr+(k?-1:1)*yo*yo*mo*mo)/(2*(k?co:Qr)*yo*mo);return Math.log(Math.sqrt(F*F+1)-F)}function S(k){return(Math.exp(k)-Math.exp(-k))/2}function C(k){return(Math.exp(k)+Math.exp(-k))/2}const To=E(0);let R=function(k){return C(To)/C(To+Jr*k)},D=function(k){return Qr*((C(To)*(S(F=To+Jr*k)/C(F))-S(To))/yo)/mo;var F},zo=(E(1)-To)/Jr;if(Math.abs(mo)<1e-6||!isFinite(zo)){if(Math.abs(Qr-co)<1e-6)return this.easeTo(F,Me);const k=co<Qr?-1:1;zo=Math.abs(Math.log(co/Qr))/Jr,D=function(){return 0},R=function(F){return Math.exp(k*Jr*F)}}F.duration="duration"in F?+F.duration:1e3*zo/("screenSpeed"in F?+F.screenSpeed/Jr:+F.speed),F.maxDuration&&F.duration>F.maxDuration&&(F.duration=0);const ko=Fe!==vt,na=Ut!==je,aa=!Ae.isPaddingEqual(xi),_a=!1===F.retainPadding?Ae.clone():Ae,O=Ae=>vi=>{const Mi=vi*zo,Jr=1/R(Mi);Ae.zoom=1===vi?pt:Oe+Ae.scaleZoom(Jr),ko&&(Ae.bearing=k.af(Fe,vt,vi)),na&&(Ae.pitch=k.af(je,Ut,vi)),aa&&(_a.interpolatePadding(qe,xi,vi),wi=_a.centerPoint.add(bi));const Qr=1===vi?pr:Ae.unproject(Ur.add(Wr.mult(D(Mi))).mult(Jr));return Ae.setLocationAtPoint(Ae.renderWorldCopies?Qr.wrap():Qr,wi),Ae._updateCameraOnTerrain(),F.preloadOnly||this._fireMoveEvents(Me),Ae};if(F.preloadOnly){const k=this._emulate(O,F.duration,Ae);return this._preloadTiles(k),this}return this._zooming=!0,this._rotating=ko,this._pitching=na,this._padding=aa,this._prepareEase(Me,!1),this._ease(O(Ae),(()=>this._afterEase(Me)),F),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(k){}_cancelRenderFrame(k){}_stop(k,F){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const k=this._onEaseEnd;this._onEaseEnd=void 0,k.call(this,F)}if(!k){const k=this.handlers;k&&k.stop(!1)}return this}_ease(F,Me,Ae){!1===Ae.animate||0===Ae.duration?(F(1),Me()):(this._easeStart=k.q.now(),this._easeOptions=Ae,this._onEaseFrame=F,this._onEaseEnd=Me,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const F=Math.min((k.q.now()-this._easeStart)/this._easeOptions.duration,1),Me=this._onEaseFrame;Me&&Me(this._easeOptions.easing(F)),F<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(F,Me){F=k.bF(F,-180,180);const Ae=Math.abs(F-Me);return Math.abs(F-360-Me)<Ae&&(F-=360),Math.abs(F+360-Me)<Ae&&(F+=360),F}_normalizeCenter(k){const F=this.transform;if(F.maxBounds)return;if("globe"!==F.projection.name&&!F.renderWorldCopies)return;const Me=k.lng-F.center.lng;k.lng+=Me>180?-360:Me<-180?360:0}_prefersReducedMotion(F){return this._respectPrefersReducedMotion&&k.q.prefersReducedMotion&&!(F&&F.essential)}_emulate(k,F,Me){const Ae=Math.ceil(15*F/1e3),Oe=[],Fe=k(Me.clone());for(let k=0;k<=Ae;k++){const F=Fe(k/Ae);Oe.push(F.clone())}return Oe}_preloadTiles(k,F){}}class Xn{constructor(F={}){this.options=F,k.aP(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(k){const F=this.options&&this.options.compact,Me=k._getUIString("AttributionControl.ToggleAttribution");this._map=k,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=l("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",Me);const Ae=l("span","mapboxgl-ctrl-icon",this._compactButton);return Ae.setAttribute("aria-hidden","true"),Ae.setAttribute("title",Me),this._innerContainer=l("div","mapboxgl-ctrl-attrib-inner",this._container),F&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===F&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let F=this._editLink;F||(F=this._editLink=this._container.querySelector(".mapbox-improve-map"));const Me=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||k.e.ACCESS_TOKEN}];if(F){const Ae=Me.reduce(((k,F,Ae)=>(F.value&&(k+=`${F.key}=${F.value}${Ae<Me.length-1?"&":""}`),k)),"?");F.href=`${k.e.FEEDBACK_URL}/${Ae}#${Ka(this._map,!0)}`,F.rel="noopener nofollow"}}_updateData(k){!k||"metadata"!==k.sourceDataType&&"visibility"!==k.sourceDataType&&"style"!==k.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let k=[];if(this._map.style.stylesheet){const k=this._map.style.stylesheet;this.styleOwner=k.owner,this.styleId=k.id}const F=this._map.style._mergedSourceCaches;for(const Me in F){const Ae=F[Me];if(Ae.used){const F=Ae.getSource();F.attribution&&k.indexOf(F.attribution)<0&&k.push(F.attribution)}}k.sort(((k,F)=>k.length-F.length)),k=k.filter(((F,Me)=>{for(let Ae=Me+1;Ae<k.length;Ae++)if(k[Ae].indexOf(F)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?k=[...this.options.customAttribution,...k]:k.unshift(this.options.customAttribution));const Me=k.join(" | ");Me!==this._attribHTML&&(this._attribHTML=Me,k.length?(this._innerContainer.innerHTML=Me,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Kn{constructor(){k.aP(["_updateLogo","_updateCompact"],this)}onAdd(k){this._map=k,this._container=l("div","mapboxgl-ctrl");const F=l("a","mapboxgl-ctrl-logo");return F.target="_blank",F.rel="noopener nofollow",F.href="https://www.mapbox.com/",F.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),F.setAttribute("rel","noopener nofollow"),this._container.appendChild(F),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(k){k&&"metadata"!==k.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const k=this._map.style._sourceCaches;if(0===Object.entries(k).length)return!0;for(const F in k){const Me=k[F].getSource();if(Me.hasOwnProperty("mapbox_logo")&&!Me.mapbox_logo)return!1}return!0}_updateCompact(){const k=this._container.children;if(k.length){const F=k[0];this._map.getCanvasContainer().offsetWidth<250?F.classList.add("mapboxgl-compact"):F.classList.remove("mapboxgl-compact")}}}class Yn{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(k){const F=++this._id;return this._queue.push({callback:k,id:F,cancelled:!1}),F}remove(k){const F=this._currentlyRunning,Me=F?this._queue.concat(F):this._queue;for(const F of Me)if(F.id===k)return void(F.cancelled=!0)}run(k=0){const F=this._currentlyRunning=this._queue;this._queue=[];for(const Me of F)if(!Me.cancelled&&(Me.callback(k),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Jn{constructor(k){this.jumpTo(k)}getValue(F){if(F<=this._startTime)return this._start;if(F>=this._endTime)return this._end;const Me=k.cB((F-this._startTime)/(this._endTime-this._startTime));return this._start*(1-Me)+this._end*Me}isEasing(k){return k>=this._startTime&&k<=this._endTime}jumpTo(k){this._startTime=-1/0,this._endTime=-1/0,this._start=k,this._end=k}easeTo(k,F,Me){this._start=this.getValue(F),this._end=k,this._startTime=F,this._endTime=F+Me}}const tf={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},rf=["mouseenter","mouseover","mouseleave","mouseout"];class tl extends k.z{constructor(k,F,Me,Ae){const{point:Oe,lngLat:Fe,originalEvent:je,target:qe}=k;super(k.type,{point:Oe,lngLat:Fe,originalEvent:je,target:qe}),this.preventDefault=()=>{k.preventDefault()},this.id=F,this.interaction=Me,this.feature=Ae}}class il{constructor(k){this.map=k,this.interactionsByType=new Map,this.typeById=new Map,this.filters=new Map,this.delegatedHandlers=new Map,this.handleType=this.handleType.bind(this)}add(F,Me){if(this.typeById.has(F))throw new Error(`Interaction id "${F}" already exists.`);const{type:Ae,filter:Oe}=Me;Oe&&this.filters.set(F,k.aZ(Oe));const Fe=this.interactionsByType.get(Ae)||new Map;if(0===Fe.size){if(rf.includes(Ae)){const{mousemove:k,mouseout:Ae}=this._createDelegatedHandlers(F,Me);this.map.on("mousemove",k),this.map.on("mouseout",Ae),this.delegatedHandlers.set(F,{mousemove:k,mouseout:Ae})}else this.map.on(Ae,this.handleType);this.interactionsByType.set(Ae,Fe)}Fe.set(F,Me),this.typeById.set(F,Ae)}get(k){const F=this.typeById.get(k);if(!F)return;const Me=this.interactionsByType.get(F);return Me?Me.get(k):void 0}remove(k){const F=this.typeById.get(k);if(!F)return;this.typeById.delete(k),this.filters.delete(k);const Me=this.interactionsByType.get(F);if(Me){if(Me.delete(k),this.delegatedHandlers.has(k)){const{mousemove:F,mouseout:Me}=this.delegatedHandlers.get(k);this.map.off("mousemove",F),this.map.off("mouseout",Me),this.delegatedHandlers.delete(k)}0===Me.size&&this.map.off(F,this.handleType)}}queryTargets(k,F){const Me=[];for(const[k,Ae]of F)Ae.target&&Me.push({targetId:k,target:Ae.target,filter:this.filters.get(k)});return this.map.style.queryRenderedTargets(k,Me,this.map.transform)}handleType(F,Me){const Ae=this.interactionsByType.get(F.type),Oe=Array.from(Ae).reverse();Me=Me||this.queryTargets(F.point,Oe);let Fe=!1;for(const Ae of Me){for(const[Me,je]of Oe){if(!je.target)continue;const Oe=Ae.variants?Ae.variants[Me]:null;if(Oe){for(const qe of Oe){const Oe=new k.cw(Ae,qe);if(!1!==je.handler(new tl(F,Me,je,Oe))){Fe=!0;break}}if(Fe)break}}if(Fe)break}if(!Fe)for(const[k,Me]of Oe){const{handler:Ae,target:Oe}=Me;if(!Oe&&!1!==Ae(new tl(F,k,Me,null)))break}}_createDelegatedHandlers(k,F){switch(F.type){case"mouseenter":case"mouseover":{let Me=!1,Ae=new Set;return{mousemove:Oe=>{const Fe=this.queryTargets(Oe.point,[[k,F]]),je=new Set;if(!Fe.length)return Me=!1,void Ae.clear();const qe=[];for(const k of Fe)Ae.has(k.id)||(je.add(k.id),qe.push(k));Me&&!qe.length||(Me=!0,Ae=je,Oe.type=F.type,this.handleType(Oe,qe))},mouseout:()=>{Me=!1,Ae.clear()}}}case"mouseleave":case"mouseout":{let Me=[];return{mousemove:Ae=>{const Oe=this.queryTargets(Ae.point,[[k,F]]);if(!Oe.length)return Ae.type=F.type,this.handleType(Ae,Me),void(Me=Oe);const Fe=[],je=new Set(Oe.map((k=>k.id)));for(const k of Me)je.has(k.id)||Fe.push(k);Fe.length&&(Ae.type=F.type,this.handleType(Ae,Fe)),Me=Oe},mouseout:k=>{Me.length&&(k.type=F.type,this.handleType(k,Me),Me=[])}}}}}}function ol(F,Me){if(Array.isArray(F)&&Array.isArray(Me)){const k=new Set(F),Ae=new Set(Me);return k.size===Ae.size&&F.every((k=>Ae.has(k)))}return k.bn(F,Me)}const of={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},sf={showCompass:!0,showZoom:!0,visualizePitch:!1};class al{constructor(F,Me,Ae=!1){this._clickTolerance=10,this.element=Me,this.mouseRotate=new yn({clickTolerance:F.dragRotate._mouseRotate._clickTolerance}),this.map=F,Ae&&(this.mousePitch=new xn({clickTolerance:F.dragRotate._mousePitch._clickTolerance})),k.aP(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),Me.addEventListener("mousedown",this.mousedown),Me.addEventListener("touchstart",this.touchstart,{passive:!1}),Me.addEventListener("touchmove",this.touchmove),Me.addEventListener("touchend",this.touchend),Me.addEventListener("touchcancel",this.reset)}down(k,F){this.mouseRotate.mousedown(k,F),this.mousePitch&&this.mousePitch.mousedown(k,F),_()}move(k,F){const Me=this.map,Ae=this.mouseRotate.mousemoveWindow(k,F),Oe=Ae&&Ae.bearingDelta;if(Oe&&Me.setBearing(Me.getBearing()+Oe),this.mousePitch){const Ae=this.mousePitch.mousemoveWindow(k,F),Oe=Ae&&Ae.pitchDelta;Oe&&Me.setPitch(Me.getPitch()+Oe)}}off(){const k=this.element;k.removeEventListener("mousedown",this.mousedown),k.removeEventListener("touchstart",this.touchstart,{passive:!1}),k.removeEventListener("touchmove",this.touchmove),k.removeEventListener("touchend",this.touchend),k.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){p(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(F){this.down(k.l({},F,{ctrlKey:!0,preventDefault:()=>F.preventDefault()}),g(this.element,F)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(k){this.move(k,g(this.element,k))}mouseup(k){this.mouseRotate.mouseupWindow(k),this.mousePitch&&this.mousePitch.mouseupWindow(k),this.offTemp()}touchstart(k){1!==k.targetTouches.length?this.reset():(this._startPos=this._lastPos=v(this.element,k.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>k.preventDefault()},this._startPos))}touchmove(k){1!==k.targetTouches.length?this.reset():(this._lastPos=v(this.element,k.targetTouches)[0],this.move({preventDefault:()=>k.preventDefault()},this._lastPos))}touchend(k){0===k.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function nl(F,Me,Ae){if(F=new k.bO(F.lng,F.lat),Me){const Oe=new k.bO(F.lng-360,F.lat),Fe=new k.bO(F.lng+360,F.lat),je=360*Math.ceil(Math.abs(F.lng-Ae.center.lng)/360),qe=Ae.locationPoint(F).distSqr(Me),pt=Me.x<0||Me.y<0||Me.x>Ae.width||Me.y>Ae.height;Ae.locationPoint(Oe).distSqr(Me)<qe&&(pt||Math.abs(Oe.lng-Ae.center.lng)<je)?F=Oe:Ae.locationPoint(Fe).distSqr(Me)<qe&&(pt||Math.abs(Fe.lng-Ae.center.lng)<je)&&(F=Fe)}for(;Math.abs(F.lng-Ae.center.lng)>180;){const k=Ae.locationPoint(F);if(k.x>=0&&k.y>=0&&k.x<=Ae.width&&k.y<=Ae.height)break;F.lng>Ae.center.lng?F.lng-=360:F.lng+=360}return F}const lf={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class cl extends k.E{constructor(F,Me){if(super(),(F instanceof HTMLElement||Me)&&(F=k.l({element:F},Me)),k.aP(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=F&&F.anchor||"center",this._color=F&&F.color||"#3FB1CE",this._scale=F&&F.scale||1,this._draggable=F&&F.draggable||!1,this._clickTolerance=F&&F.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=F&&F.rotation||0,this._rotationAlignment=F&&F.rotationAlignment||"auto",this._pitchAlignment=F&&F.pitchAlignment&&F.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=F&&F.occludedOpacity||.2,F&&F.element)this._element=F.element,this._offset=k.P.convert(F&&F.offset||[0,0]);else{this._defaultMarker=!0,this._element=l("div");const Me=41,Ae=27,Oe=c("svg",{display:"block",height:Me*this._scale+"px",width:Ae*this._scale+"px",viewBox:`0 0 ${Ae} ${Me}`},this._element),Fe=c("radialGradient",{id:"shadowGradient"},c("defs",{},Oe));c("stop",{offset:"10%","stop-opacity":.4},Fe),c("stop",{offset:"100%","stop-opacity":.05},Fe),c("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},Oe),c("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},Oe),c("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},Oe),c("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},Oe),this._offset=k.P.convert(F&&F.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(k=>{k.preventDefault()})),this._element.addEventListener("mousedown",(k=>{k.preventDefault()}));const Ae=this._element.classList;for(const k in lf)Ae.remove(`mapboxgl-marker-anchor-${k}`);Ae.add(`mapboxgl-marker-anchor-${this._anchor}`);const Oe=F&&F.className?F.className.trim().split(/\s+/):[];Ae.add(...Oe),this._popup=null}addTo(k){return k===this._map||(this.remove(),this._map=k,k.getCanvasContainer().appendChild(this._element),k.on("move",this._updateMoving),k.on("moveend",this._update),k.on("remove",this._clearFadeTimer),k._addMarker(this),this.setDraggable(this._draggable),this._update(),k.on("click",this._onMapClick)),this}remove(){const k=this._map;return k&&(k.off("click",this._onMapClick),k.off("move",this._updateMoving),k.off("moveend",this._update),k.off("mousedown",this._addDragHandler),k.off("touchstart",this._addDragHandler),k.off("mouseup",this._onUp),k.off("touchend",this._onUp),k.off("mousemove",this._onMove),k.off("touchmove",this._onMove),k.off("remove",this._clearFadeTimer),k._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(F){return this._lngLat=k.bO.convert(F),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(k){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),k){if(!("offset"in k.options)){const F=38.1,Me=13.5,Ae=Math.sqrt(Math.pow(Me,2)/2);k.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-F],"bottom-left":[Ae,-1*(F-Me+Ae)],"bottom-right":[-Ae,-1*(F-Me+Ae)],left:[Me,-1*(F-Me)],right:[-Me,-1*(F-Me)]}:this._offset}this._popup=k,k._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(k){const F=k.code,Me=k.charCode||k.keyCode;"Space"!==F&&"Enter"!==F&&32!==Me&&13!==Me||this.togglePopup()}_onMapClick(k){const F=k.originalEvent.target,Me=this._element;this._popup&&(F===Me||Me.contains(F))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const k=this._popup;return k?(k.isOpen()?(k.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(k.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const k=this._map,F=this._pos;if(!k||!F)return!1;const Me=k.unproject(F),Ae=k.getFreeCameraOptions();if(!Ae.position)return!1;const Oe=Ae.position.toLngLat();return Oe.distanceTo(Me)<.9*Oe.distanceTo(this._lngLat)}_evaluateOpacity(){const F=this._map;if(!F)return;const Me=this._pos;if(!Me||Me.x<0||Me.x>F.transform.width||Me.y<0||Me.y>F.transform.height)return void this._clearFadeTimer();const Ae=F.unproject(Me);let Oe;F._showingGlobe()&&k.dH(F.transform,this._lngLat)?Oe=0:(Oe=1-F._queryFogOpacity(Ae),F.transform._terrainEnabled()&&F.getTerrain()&&this._behindTerrain()&&(Oe*=this._occludedOpacity)),this._element.style.opacity=`${Oe}`,this._element.style.pointerEvents=Oe>0?"auto":"none",this._popup&&this._popup._setOpacity(Oe),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const k=this._pos;if(!k||!this._map)return;const F=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${k.x}px,${k.y}px)\n            ${lf[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${F.x}px,${F.y}px)\n        `}_calculateXYTransform(){const F=this._pos,Me=this._map,Ae=this.getPitchAlignment();if(!Me||!F||"map"!==Ae)return"";if(!Me._showingGlobe()){const k=Me.getPitch();return k?`rotateX(${k}deg)`:""}const Oe=k.c4(k.dI(Me.transform,this._lngLat)),Fe=F.sub(k.dJ(Me.transform)),je=Math.abs(Fe.x)+Math.abs(Fe.y);if(0===je)return"";const qe=Oe/je;return`rotateX(${-Fe.y*qe}deg) rotateY(${Fe.x*qe}deg)`}_calculateZTransform(){const F=this._pos,Me=this._map;if(!Me||!F)return"";let Ae=0;const Oe=this.getRotationAlignment();if("map"===Oe)if(Me._showingGlobe()){const F=Me.project(new k.bO(this._lngLat.lng,this._lngLat.lat+.001)),Oe=Me.project(new k.bO(this._lngLat.lng,this._lngLat.lat-.001)).sub(F);Ae=k.c4(Math.atan2(Oe.y,Oe.x))-90}else Ae=-Me.getBearing();else if("horizon"===Oe){const Oe=k.ac(4,6,Me.getZoom()),Fe=k.dJ(Me.transform);Fe.y+=Oe*Me.transform.height;const je=F.sub(Fe),qe=k.c4(Math.atan2(je.y,je.x));Ae=(qe>90?qe-270:qe+90)*(1-Oe)}return Ae+=this._rotation,Ae?`rotateZ(${Ae}deg)`:""}_update(k){cancelAnimationFrame(this._updateFrameId);const F=this._map;F&&(F.transform.renderWorldCopies&&(this._lngLat=nl(this._lngLat,this._pos,F.transform)),this._pos=F.project(this._lngLat),!0===k?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),F._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(F._showingGlobe()||F.getTerrain()||F.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(F){return this._offset=k.P.convert(F),this._update(),this}addClassName(k){return this._element.classList.add(k),this}removeClassName(k){return this._element.classList.remove(k),this}toggleClassName(k){return this._element.classList.toggle(k)}_onMove(F){const Me=this._map;if(!Me)return;const Ae=this._pointerdownPos,Oe=this._positionDelta;if(Ae&&Oe){if(!this._isDragging){const k=this._clickTolerance||Me._clickTolerance;if(F.point.dist(Ae)<k)return;this._isDragging=!0}this._pos=F.point.sub(Oe),this._lngLat=Me.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new k.z("dragstart"))),this.fire(new k.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const F=this._map;F&&(F.off("mousemove",this._onMove),F.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new k.z("dragend")),this._state="inactive"}_addDragHandler(k){const F=this._map,Me=this._pos;F&&Me&&this._element.contains(k.originalEvent.target)&&(k.preventDefault(),this._positionDelta=k.point.sub(Me),this._pointerdownPos=k.point,this._state="pending",F.on("mousemove",this._onMove),F.on("touchmove",this._onMove),F.once("mouseup",this._onUp),F.once("touchend",this._onUp))}setDraggable(k){this._draggable=!!k;const F=this._map;return F&&(k?(F.on("mousedown",this._addDragHandler),F.on("touchstart",this._addDragHandler)):(F.off("mousedown",this._addDragHandler),F.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(k){return this._rotation=k||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(k){return this._rotationAlignment=k||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(k){return this._pitchAlignment=k||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(k){return this._occludedOpacity=k||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const uf={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},pf={maxWidth:100,unit:"metric"},ff={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},gf={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},xf=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function fl(F=new k.P(0,0),Me="bottom"){if("number"==typeof F){const Ae=Math.round(Math.sqrt(.5*Math.pow(F,2)));switch(Me){case"top":return new k.P(0,F);case"top-left":return new k.P(Ae,Ae);case"top-right":return new k.P(-Ae,Ae);case"bottom":return new k.P(0,-F);case"bottom-left":return new k.P(Ae,-Ae);case"bottom-right":return new k.P(-Ae,-Ae);case"left":return new k.P(F,0);case"right":return new k.P(-F,0)}return new k.P(0,0)}return F instanceof k.P||Array.isArray(F)?k.P.convert(F):k.P.convert(F[Me]||[0,0])}const wf={version:F,supported:je.supported,setRTLTextPlugin:k.dK,getRTLTextPluginStatus:k.dL,Map:class extends $n{constructor(F){Ae.mark(Me.create);const Oe=F;if(null!=(F=k.l({},of,F)).minZoom&&null!=F.maxZoom&&F.minZoom>F.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=F.minPitch&&null!=F.maxPitch&&F.minPitch>F.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=F.minPitch&&F.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=F.maxPitch&&F.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(F.antialias&&k.dF(window)&&(F.antialias=!1,k.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Yi(F.minZoom,F.maxZoom,F.minPitch,F.maxPitch,F.renderWorldCopies),F),this._repaint=!!F.repaint,this._interactive=F.interactive,this._minTileCacheSize=F.minTileCacheSize,this._maxTileCacheSize=F.maxTileCacheSize,this._failIfMajorPerformanceCaveat=F.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=F.preserveDrawingBuffer,this._antialias=F.antialias,this._trackResize=F.trackResize,this._bearingSnap=F.bearingSnap,this._refreshExpiredTiles=F.refreshExpiredTiles,this._fadeDuration=F.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=F.crossSourceCollisions,this._collectResourceTiming=F.collectResourceTiming,this._language=this._parseLanguage(F.language),this._worldview=F.worldview,this._renderTaskQueue=new Yn,this._domRenderTaskQueue=new Yn,this._controls=[],this._markers=[],this._popups=[],this._mapId=k.aV(),this._locale=k.l({},tf,F.locale),this._clickTolerance=F.clickTolerance,this._cooperativeGestures=F.cooperativeGestures,this._performanceMetricsCollection=F.performanceMetricsCollection,this._tessellationStep=F.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=F.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Jn(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=F.scaleFactor,this._requestManager=new T(F.transformRequest,F.accessToken,F.testMode),this._silenceAuthErrors=!!F.testMode,this._contextCreateOptions=F.contextCreateOptions?{...F.contextCreateOptions}:{},"string"==typeof F.container){const k=document.getElementById(F.container);if(!k)throw new Error(`Container '${F.container.toString()}' not found.`);this._container=k}else{if(!(F.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=F.container}if(this._container.childNodes.length>0&&k.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),F.maxBounds&&this.setMaxBounds(F.maxBounds),this._spriteFormat=F.spriteFormat,k.aP(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Pa),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Zn(this,F),this._localFontFamily=F.localFontFamily,this._localIdeographFontFamily=F.localIdeographFontFamily,(F.style||!F.testMode)&&this.setStyle(F.style||k.e.DEFAULT_STYLE,{config:F.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),F.projection&&this.setProjection(F.projection),this.indoor=new uo(this),F.hash&&(this._hash=new Xa("string"==typeof F.hash&&F.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==Oe.center&&null==Oe.zoom||(this.transform._unmodified=!1),this.jumpTo({center:F.center,zoom:F.zoom,bearing:F.bearing,pitch:F.pitch});const Me=F.bounds;Me&&(this.resize(),this.fitBounds(Me,k.l({},F.fitBoundsOptions,{duration:0})))}this.resize(),F.attributionControl&&this.addControl(new Xn({customAttribution:F.customAttribution})),this._logoControl=new Kn,this.addControl(this._logoControl,F.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(F=>{this._update("style"===F.dataType),this.fire(new k.z(`${F.dataType}data`,F))})),this.on("dataloading",(F=>{this.fire(new k.z(`${F.dataType}dataloading`,F))})),this._interactions=new il(this)}_getMapId(){return this._mapId}addControl(F,Me){if(void 0===Me&&(Me=F.getDefaultPosition?F.getDefaultPosition():"top-right"),!F||!F.onAdd)return this.fire(new k.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const Ae=F.onAdd(this);this._controls.push(F);const Oe=this._controlPositions[Me];return-1!==Me.indexOf("bottom")?Oe.insertBefore(Ae,Oe.firstChild):Oe.appendChild(Ae),this}removeControl(F){if(!F||!F.onRemove)return this.fire(new k.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const Me=this._controls.indexOf(F);return Me>-1&&this._controls.splice(Me,1),F.onRemove(this),this}hasControl(k){return this._controls.indexOf(k)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(F){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const Me=!this._moving;return Me&&this.fire(new k.z("movestart",F)).fire(new k.z("move",F)),this.fire(new k.z("resize",F)),Me&&this.fire(new k.z("moveend",F)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(F){return this.transform.setMaxBounds(k.az.convert(F)),this._update()}setMinZoom(F){if((F=F??-2)>=-2&&F<=this.transform.maxZoom)return this.transform.minZoom=F,this._update(),this.getZoom()<F?this.setZoom(F):this.fire(new k.z("zoomstart")).fire(new k.z("zoom")).fire(new k.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(F){if((F=F??22)>=this.transform.minZoom)return this.transform.maxZoom=F,this._update(),this.getZoom()>F?this.setZoom(F):this.fire(new k.z("zoomstart")).fire(new k.z("zoom")).fire(new k.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(F){if((F=F??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(F>=0&&F<=this.transform.maxPitch)return this.transform.minPitch=F,this._update(),this.getPitch()<F?this.setPitch(F):this.fire(new k.z("pitchstart")).fire(new k.z("pitch")).fire(new k.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(F){if((F=F??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(F>=this.transform.minPitch)return this.transform.maxPitch=F,this._update(),this.getPitch()>F?this.setPitch(F):this.fire(new k.z("pitchstart")).fire(new k.z("pitch")).fire(new k.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(k){return this._scaleFactor=k,this.painter.scaleFactor=k,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((k=>"symbol"===k.type)),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(k){return this.transform.renderWorldCopies=k,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(k){return"auto"===k?navigator.language:Array.isArray(k)?0===k.length?void 0:k.map((k=>"auto"===k?navigator.language:k)):k}setLanguage(k){const F=this._parseLanguage(k);if(!this.style||F===this._language)return this;this._language=F,this.style.reloadSources();for(const k of this._controls)k._setLanguage&&k._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(k){return this.style&&k!==this._worldview?(this._worldview=k,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(k){return this._lazyInitEmptyStyle(),k?"string"==typeof k&&(k={name:k}):k=null,this._useExplicitProjection=!!k,this._prioritizeAndUpdateProjection(k,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const F=this.transform,Me=F.projection.name;let Ae;"globe"===Me&&F.zoom>=k.bY?(F.setMercatorFromTransition(),Ae=!0):"mercator"===Me&&F.zoom<k.bY&&(F.setProjection({name:"globe"}),Ae=!0),Ae&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(k,F){return this._updateProjection(k||F||{name:"mercator"})}_updateProjection(F){let Me;return Me="globe"===F.name&&this.transform.zoom>=k.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(F),this.style.applyProjectionUpdate(),Me&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(F){return this.transform.locationPoint3D(k.bO.convert(F))}unproject(F){return this.transform.pointLocation3D(k.P.convert(F))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(k,F,Me){const o=k=>{let Me=[];if(Array.isArray(F)){const Ae=F.filter((k=>this.getLayer(k)));Me=Ae.length?this.queryRenderedFeatures(k,{layers:Ae}):[]}else Me=this.queryRenderedFeatures(k,{target:F});return Me};if("mouseenter"===k||"mouseover"===k){let Ae=!1;const r=F=>{const Oe=o(F.point);Oe.length?Ae||(Ae=!0,Me.call(this,new an(k,this,F.originalEvent,{features:Oe}))):Ae=!1};return{listener:Me,targets:F,delegates:{mousemove:r,mouseout:()=>{Ae=!1}}}}if("mouseleave"===k||"mouseout"===k){let Ae=!1;const r=F=>{o(F.point).length?Ae=!0:Ae&&(Ae=!1,Me.call(this,new an(k,this,F.originalEvent)))},a=F=>{Ae&&(Ae=!1,Me.call(this,new an(k,this,F.originalEvent)))};return{listener:Me,targets:F,delegates:{mousemove:r,mouseout:a}}}{const s=k=>{const F=o(k.point);F.length&&(k.features=F,Me.call(this,k),delete k.features)};return{listener:Me,targets:F,delegates:{[k]:s}}}}on(k,F,Me){if("function"==typeof F||void 0===Me)return super.on(k,F);if("string"==typeof F&&(F=[F]),!this._areTargetsValid(F))return this;const Ae=this._createDelegatedListener(k,F,Me);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[k]=this._delegatedListeners[k]||[],this._delegatedListeners[k].push(Ae);for(const k in Ae.delegates)this.on(k,Ae.delegates[k]);return this}once(k,F,Me){if("function"==typeof F||void 0===Me)return super.once(k,F);if("string"==typeof F&&(F=[F]),!this._areTargetsValid(F))return this;const Ae=this._createDelegatedListener(k,F,Me);for(const k in Ae.delegates)this.once(k,Ae.delegates[k]);return this}off(k,F,Me){if("function"==typeof F||void 0===Me)return super.off(k,F);if("string"==typeof F&&(F=[F]),!this._areTargetsValid(F))return this;const Ae=this._delegatedListeners?this._delegatedListeners[k]:void 0;return Ae&&(k=>{for(let Ae=0;Ae<k.length;Ae++){const Oe=k[Ae];if(Oe.listener===Me&&ol(Oe.targets,F)){for(const k in Oe.delegates)this.off(k,Oe.delegates[k]);return k.splice(Ae,1),this}}})(Ae),this}queryRenderedFeatures(F,Me){if(!this.style)return[];if(void 0===F||F instanceof k.P||Array.isArray(F)||void 0!==Me||(Me=F,F=void 0),F=F||[[0,0],[this.transform.width,this.transform.height]],!Me){const k=this.style.queryRenderedFeatures(F,void 0,this.transform),Me=this.style.queryRenderedFeatureset(F,void 0,this.transform);return k.concat(Me)}let Ae=!0;if(Me.target&&(Ae=this._isTargetValid(Me.target),Ae&&!Me.layers))return this.style.queryRenderedFeatureset(F,Me,this.transform);let Oe=!0;if(Me.layers&&Array.isArray(Me.layers)){for(const k of Me.layers)if(!this._isValidId(k)){Oe=!1;break}if(Oe&&!Me.target)return this.style.queryRenderedFeatures(F,Me,this.transform)}let Fe=[];return Oe&&(Fe=Fe.concat(this.style.queryRenderedFeatures(F,Me,this.transform))),Ae&&(Fe=Fe.concat(this.style.queryRenderedFeatureset(F,Me,this.transform))),Fe}querySourceFeatures(k,F){return!k||"string"==typeof k&&!this._isValidId(k)?[]:this.style.querySourceFeatures(k,F)}isPointOnSurface(F){const{name:Me}=this.transform.projection;return"globe"!==Me&&"mercator"!==Me&&k.w(`${Me} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(k.P.convert(F))}addInteraction(k,F){return this._interactions.add(k,F),this}removeInteraction(k){return this._interactions.remove(k),this}setStyle(F,Me){return Me=k.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},Me),this.style&&F&&!1!==Me.diff&&Me.localFontFamily===this._localFontFamily&&Me.localIdeographFontFamily===this._localIdeographFontFamily&&!Me.config?(this.style._diffStyle(F,((Ae,Oe)=>{Ae?(k.w(`Unable to perform style diff: ${String(Ae.message||Ae.error||Ae)}. Rebuilding the style from scratch.`),this._updateStyle(F,Me)):Oe&&this._update(!0)}),(()=>{this._postStyleLoadEvent()})),this):(this._localIdeographFontFamily=Me.localIdeographFontFamily,this._localFontFamily=Me.localFontFamily,this._updateStyle(F,Me))}_getUIString(k){const F=this._locale[k];if(null==F)throw new Error(`Missing UI string '${k}'`);return F}_updateStyle(F,Me){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),F){const Ae=k.l({},Me);Me&&Me.config&&(Ae.initialConfig=Me.config,delete Ae.config),this.style=new bo(this,Ae).load(F),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new bo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(k.w("There is no style added to the map."),!1)}_isValidId(F){return null==F?(this.fire(new k.y(new Error("IDs can't be empty."))),!1):!k.cr(F)||(this.fire(new k.y(new Error(`IDs can't contain special symbols: "${F}".`))),!1)}_isTargetValid(k){return"featuresetId"in k?this._isValidId("importId"in k?k.importId:k.featuresetId):"layerId"in k&&this._isValidId(k.layerId)}_areTargetsValid(k){if(Array.isArray(k)){for(const F of k)if(!this._isValidId(F))return!1;return!0}return this._isTargetValid(k)}addSource(k,F){return this._isValidId(k)?(this._lazyInitEmptyStyle(),this.style.addSource(k,F),this._update(!0)):this}isSourceLoaded(k){return!!this._isValidId(k)&&!!this.style&&this.style._isSourceCacheLoaded(k)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(k,F,Me){this._lazyInitEmptyStyle(),this.style.addSourceType(k,F,Me)}removeSource(k){return this._isValidId(k)?(this.style.removeSource(k),this._updateTerrain(),this._update(!0)):this}getSource(k){return this._isValidId(k)?this.style.getOwnSource(k):null}addImage(F,Me,{pixelRatio:Ae=1,sdf:Oe=!1,stretchX:Fe,stretchY:je,content:qe}={}){if(this._lazyInitEmptyStyle(),Me instanceof HTMLImageElement||ImageBitmap&&Me instanceof ImageBitmap){const{width:pt,height:vt,data:Ut}=k.q.getImageData(Me);this.style.addImage(F,{data:new k.r({width:pt,height:vt},Ut),pixelRatio:Ae,stretchX:Fe,stretchY:je,content:qe,sdf:Oe,version:0,usvg:!1})}else if(void 0===Me.width||void 0===Me.height)this.fire(new k.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:pt,height:vt}=Me,Ut=Me;this.style.addImage(F,{data:new k.r({width:pt,height:vt},new Uint8Array(Ut.data)),pixelRatio:Ae,stretchX:Fe,stretchY:je,content:qe,sdf:Oe,usvg:!1,version:0,userImage:Ut}),Ut.onAdd&&Ut.onAdd(this,F)}}updateImage(F,Me){this._lazyInitEmptyStyle();const Ae=this.style.getImage(F);if(!Ae)return void this.fire(new k.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const Oe=Me instanceof HTMLImageElement||ImageBitmap&&Me instanceof ImageBitmap?k.q.getImageData(Me):Me,{width:Fe,height:je,data:qe}=Oe;if(void 0===Fe||void 0===je)return void this.fire(new k.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(Fe!==(Ae.usvg?Ae.icon.usvg_tree.width:Ae.data.width)||je!==(Ae.usvg?Ae.icon.usvg_tree.height:Ae.data.height))return void this.fire(new k.y(new Error(`The width and height of the updated image (${Fe}, ${je})\n                must be that same as the previous version of the image\n                (${Ae.data.width}, ${Ae.data.height})`)));const pt=!(Me instanceof HTMLImageElement||ImageBitmap&&Me instanceof ImageBitmap);let vt=!1;Ae.usvg?(Ae.data=new k.r({width:Fe,height:je},new Uint8Array(qe)),Ae.usvg=!1,Ae.icon=void 0,vt=!0):Ae.data.replace(qe,pt),this.style.updateImage(F,Ae,vt)}hasImage(F){return F?!!this.style&&!!this.style.getImage(F):(this.fire(new k.y(new Error("Missing required image id"))),!1)}removeImage(k){this.style.removeImage(k)}loadImage(F,Me){k.o(this._requestManager.transformRequest(F,k.R.Image),((F,Ae)=>{Me(F,Ae instanceof HTMLImageElement?k.q.getImageData(Ae):Ae)}))}listImages(){return this.style.listImages()}addModel(k,F){this._lazyInitEmptyStyle(),this.style.addModel(k,F)}hasModel(F){return F?this.style.hasModel(F):(this.fire(new k.y(new Error("Missing required model id"))),!1)}removeModel(k){this.style.removeModel(k)}listModels(){return this.style.listModels()}addLayer(k,F){return this._isValidId(k.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(k,F),this._update(!0)):this}getSlot(k){const F=this.getLayer(k);return F&&F.slot||null}setSlot(k,F){return this.style.setSlot(k,F),this.style.mergeLayers(),this._update(!0)}addImport(k,F){return this.style.addImport(k,F),this}updateImport(k,F){return"string"!=typeof F&&F.id!==k?(this.removeImport(k),this.addImport(F)):(this.style.updateImport(k,F),this._update(!0))}removeImport(k){return this.style.removeImport(k),this}moveImport(k,F){return this.style.moveImport(k,F),this._update(!0)}moveLayer(k,F){return this._isValidId(k)?(this.style.moveLayer(k,F),this._update(!0)):this}removeLayer(k){return this._isValidId(k)?(this.style.removeLayer(k),this._update(!0)):this}getLayer(k){if(!this._isValidId(k))return null;const F=this.style.getOwnLayer(k);return F?"custom"===F.type?F.implementation:F.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(k,F,Me){return this._isValidId(k)?(this.style.setLayerZoomRange(k,F,Me),this._update(!0)):this}setFilter(k,F,Me={}){return this._isValidId(k)?(this.style.setFilter(k,F,Me),this._update(!0)):this}getFilter(k){return this._isValidId(k)?this.style.getFilter(k):null}setPaintProperty(k,F,Me,Ae={}){return this._isValidId(k)?(this.style.setPaintProperty(k,F,Me,Ae),this._update(!0)):this}getPaintProperty(k,F){return this._isValidId(k)?this.style.getPaintProperty(k,F):null}setLayoutProperty(k,F,Me,Ae={}){return this._isValidId(k)?(this.style.setLayoutProperty(k,F,Me,Ae),this._update(!0)):this}getLayoutProperty(k,F){return this._isValidId(k)?this.style.getLayoutProperty(k,F):null}getSchema(k){return this.style.getSchema(k)}setSchema(k,F){return this.style.setSchema(k,F),this._update(!0)}getConfig(k){return this.style.getConfig(k)}setConfig(k,F){return this.style.setConfig(k,F),this._update(!0)}getConfigProperty(k,F){return this.style.getConfigProperty(k,F)}setConfigProperty(k,F,Me){return this.style.setConfigProperty(k,F,Me),this._update(!0)}getFeaturesetDescriptors(k){return this.style.getFeaturesetDescriptors(k)}setLights(k){if(this._lazyInitEmptyStyle(),k&&1===k.length&&"flat"===k[0].type){const F=k[0];F.properties?this.style.setFlatLight(F.properties,F.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(k),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const k=this.style.getLights()||[];return 0===k.length&&k.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),k}setLight(k,F={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:k}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(k){return this._lazyInitEmptyStyle(),!k&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(k),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(k){return this._lazyInitEmptyStyle(),this.style.setFog(k),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(k){return this._lazyInitEmptyStyle(),this.style.setSnow(k),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(k){return this._lazyInitEmptyStyle(),this.style.setRain(k),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(k){return this._lazyInitEmptyStyle(),this.style.setColorTheme(k),this._update(!0)}setImportColorTheme(k,F){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(k,F),this._update(!0)}setCamera(k){return this.style.setCamera(k),this._triggerCameraUpdate(k)}_triggerCameraUpdate(k){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===k["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(F){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(k.bO.convert(F),this.transform):0}setFeatureState(k,F){return k.source&&!this._isValidId(k.source)?this:(this.style.setFeatureState(k,F),this._update())}removeFeatureState(k,F){return k.source&&!this._isValidId(k.source)?this:(this.style.removeFeatureState(k,F),this._update())}getFeatureState(k){return k.source&&!this._isValidId(k.source)?null:this.style.getFeatureState(k)}_updateContainerDimensions(){if(!this._container)return;const k=this._container.getBoundingClientRect().width||400,F=this._container.getBoundingClientRect().height||300;let Me,Ae,Oe,Fe=this._container;for(;Fe&&(!Ae||!Oe);){const k=window.getComputedStyle(Fe).transform;k&&"none"!==k&&(Me=k.match(/matrix.*\((.+)\)/)[1].split(", "),Me[0]&&"0"!==Me[0]&&"1"!==Me[0]&&(Ae=Me[0]),Me[3]&&"0"!==Me[3]&&"1"!==Me[3]&&(Oe=Me[3])),Fe=Fe.parentElement}this._containerWidth=Ae?Math.abs(k/Ae):k,this._containerHeight=Oe?Math.abs(F/Oe):F}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&k.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const k=this._container;k.classList.add("mapboxgl-map"),(this._missingCSSCanary=l("div","mapboxgl-canary",k)).style.visibility="hidden",this._detectMissingCSS();const F=this._canvasContainer=l("div","mapboxgl-canvas-container",k);this._canvas=l("canvas","mapboxgl-canvas",F),this._interactive&&(F.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const Me=this._controlContainer=l("div","mapboxgl-control-container",k),Ae=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((k=>{Ae[k]=l("div",`mapboxgl-ctrl-${k}`,Me)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(F,Me){const Ae=k.q.devicePixelRatio||1;this._canvas.width=Ae*Math.ceil(F),this._canvas.height=Ae*Math.ceil(Me),this._canvas.style.width=`${F}px`,this._canvas.style.height=`${Me}px`}_addMarker(k){this._markers.push(k)}_removeMarker(k){const F=this._markers.indexOf(k);-1!==F&&this._markers.splice(F,1)}_addPopup(k){this._popups.push(k)}_removePopup(k){const F=this._popups.indexOf(k);-1!==F&&this._popups.splice(F,1)}_setupPainter(){const F=k.l({},je.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),Me=this._canvas.getContext("webgl2",F);Me?(G(Me,!0),this.painter=new Wa(Me,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",(k=>{"source"===k.dataType&&this.painter.setTileLoadedFlag(!0)})),k.m.testSupport(Me)):this.fire(new k.y(new Error("Failed to initialize WebGL")))}_contextLost(F){F.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new k.z("webglcontextlost",{originalEvent:F}))}_contextRestored(F){this._setupPainter(),this.resize(),this._update(),this.fire(new k.z("webglcontextrestored",{originalEvent:F}))}_onMapScroll(k){if(k.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(k){return this.style?(this._styleDirty=this._styleDirty||k,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(k){return this._update(),this._renderTaskQueue.add(k)}_cancelRenderFrame(k){this._renderTaskQueue.remove(k)}_requestDomTask(k){!this.loaded()||this.loaded()&&!this.isMoving()?k():this._domRenderTaskQueue.add(k)}_render(F){let Oe;this.fire(new k.z("renderstart")),++this._frameId;const Fe=this.painter.context.extTimerQuery,je=k.q.now(),qe=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(Oe=qe.createQuery(),qe.beginQuery(Fe.TIME_ELAPSED_EXT,Oe)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(F),this._domRenderTaskQueue.run(F),this._removed)return;this._updateProjectionTransition();const pt=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const F=this.transform.zoom,Me=this.transform.pitch,Ae=k.q.now(),Oe=new k.a8(F,{now:Ae,fadeDuration:pt,pitch:Me,transition:this.style.transition});this.style.update(Oe)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let vt=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),vt=this._updateAverageElevation(je),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):vt=this._updateAverageElevation(je);const Ut=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,pt,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),Ut&&(this._placementDirty=Ut.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:pt,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new k.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Ae.mark(Me.load),this.fire(new k.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),Oe){const F=k.q.now()-je;qe.endQuery(Fe.TIME_ELAPSED_EXT),setTimeout((()=>{const Me=qe.getQueryParameter(Oe,qe.QUERY_RESULT)/1e6;qe.deleteQuery(Oe),this.fire(new k.z("gpu-timing-frame",{cpuTime:F,gpuTime:Me}))}),50)}if(this.listens("gpu-timing-layer")){const F=this.painter.collectGpuTimers();setTimeout((()=>{const Me=this.painter.queryGpuTimers(F);this.fire(new k.z("gpu-timing-layer",{layerTimes:Me}))}),50)}if(this.listens("gpu-timing-deferred-render")){const F=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const Me=this.painter.queryGpuTimeDeferredRender(F);this.fire(new k.z("gpu-timing-deferred-render",{gpuTime:Me}))}),50)}const xi=this._sourcesDirty||this._styleDirty||this._placementDirty||vt;if(xi||this._repaint)this.triggerRepaint();else{const F=this.idle();if(F&&(vt=this._updateAverageElevation(je,!0)),vt)this.triggerRepaint();else if(this._triggerFrame(!1),F&&(this.fire(new k.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const F=this._calculateSpeedIndex();this.fire(new k.z("speedindexcompleted",{speedIndex:F})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||xi||(this._fullyLoaded=!0,Ae.mark(Me.fullLoad),this._performanceMetricsCollection&&co(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(k){for(const F of this._markers)k&&!this.getRenderWorldCopies()&&(F._lngLat=F._lngLat.wrap()),F._update();for(const F of this._popups)!k||this.getRenderWorldCopies()||F._trackPointer||(F._lngLat=F._lngLat.wrap()),F._update()}_updateAverageElevation(k,F=!1){const i=k=>(this.transform.averageElevation=k,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const Me=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(Me||(F||k-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(k)){const F=this.transform.averageElevation;let Ae=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(Ae)?Ae=0:this._averageElevationLastSampledAt=k;const Oe=Math.abs(F-Ae);if(Oe>1){if(this._isInitialLoad||Me)return this._averageElevation.jumpTo(Ae),i(Ae);this._averageElevation.easeTo(Ae,k,300)}else if(Oe>1e-4)return this._averageElevation.jumpTo(Ae),i(Ae)}return!!this._averageElevation.isEasing(k)&&i(this._averageElevation.getValue(k))}_authenticate(){yo(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(F=>{if(F&&(F.message===xi||401===F.status)){const F=this.painter.context.gl;G(F,!1),this._logoControl instanceof Kn&&this._logoControl._updateLogo(),F&&F.clear(F.DEPTH_BUFFER_BIT|F.COLOR_BUFFER_BIT|F.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new k.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),Ur(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&Jr(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const k=this._isDragging();this.painter.updateTerrain(this.style,k)}_calculateSpeedIndex(){const k=this.painter.canvasCopy(),F=this.painter.getCanvasCopiesAndTimestamps();F.timeStamps.push(performance.now());const Me=this.painter.context.gl,Ae=Me.createFramebuffer();function s(k){Me.framebufferTexture2D(Me.FRAMEBUFFER,Me.COLOR_ATTACHMENT0,Me.TEXTURE_2D,k,0);const F=new Uint8Array(Me.drawingBufferWidth*Me.drawingBufferHeight*4);return Me.readPixels(0,0,Me.drawingBufferWidth,Me.drawingBufferHeight,Me.RGBA,Me.UNSIGNED_BYTE,F),F}return Me.bindFramebuffer(Me.FRAMEBUFFER,Ae),this._canvasPixelComparison(s(k),F.canvasCopies.map(s),F.timeStamps)}_canvasPixelComparison(k,F,Me){let Ae=Me[1]-Me[0];const Oe=k.length/4;for(let Fe=0;Fe<F.length;Fe++){const je=F[Fe];let qe=0;for(let F=0;F<je.length;F+=4)je[F]===k[F]&&je[F+1]===k[F+1]&&je[F+2]===k[F+2]&&je[F+3]===k[F+3]&&(qe+=1);Ae+=(Me[Fe+2]-Me[Fe+1])*(1-qe/Oe)}return Ae}remove(){this._hash&&this._hash.remove();for(const k of this._controls)k.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const F=this.painter.context.gl.getExtension("WEBGL_lose_context");F&&F.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),To.delete(this.painter.context.gl),mo.remove(),pr.remove(),this._removed=!0,this.fire(new k.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(F){this._renderNextFrame=this._renderNextFrame||F,this.style&&!this._frame&&(this._frame=k.q.frame((k=>{const F=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,F&&this._render(k)})))}_preloadTiles(F){const Me=this.style?this.style.getSourceCaches():[];return k.bl(Me,((k,Me)=>k._preloadTiles(F,Me)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(k){this._trackResize&&this.resize({originalEvent:k})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(k){this._showTileBoundaries!==k&&(this._showTileBoundaries=k,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(k){this._showParseStatus!==k&&(this._showParseStatus=k,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(k){this._showTerrainWireframe!==k&&(this._showTerrainWireframe=k,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(k){this._showLayers2DWireframe!==k&&(this._showLayers2DWireframe=k,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(k){this._showLayers3DWireframe!==k&&(this._showLayers3DWireframe=k,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(k){this._speedIndexTiming!==k&&(this._speedIndexTiming=k,this._update())}get showPadding(){return!!this._showPadding}set showPadding(k){this._showPadding!==k&&(this._showPadding=k,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(k){this._showCollisionBoxes!==k&&(this._showCollisionBoxes=k,this._tp.refreshUI(),k?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(k){this._showOverdrawInspector!==k&&(this._showOverdrawInspector=k,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(k){this._repaint!==k&&(this._repaint=k,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(k){this._vertices=k,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(k){this._showTileAABBs!==k&&(this._showTileAABBs=k,this._tp.refreshUI(),k&&this._update())}_setCacheLimits(F,Me){k.dG(F,Me)}get version(){return F}},NavigationControl:class{constructor(F={}){this.options=k.l({},sf,F),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(k=>k.preventDefault())),this.options.showZoom&&(k.aP(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(k=>{this._map&&this._map.zoomIn({},{originalEvent:k})})),l("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(k=>{this._map&&this._map.zoomOut({},{originalEvent:k})})),l("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(k.aP(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(k=>{const F=this._map;F&&(this.options.visualizePitch?F.resetNorthPitch({},{originalEvent:k}):F.resetNorth({},{originalEvent:k}))})),this._compassIcon=l("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const k=this._map;if(!k)return;const F=k.getZoom(),Me=F===k.getMaxZoom(),Ae=F===k.getMinZoom();this._zoomInButton.disabled=Me,this._zoomOutButton.disabled=Ae,this._zoomInButton.setAttribute("aria-disabled",Me.toString()),this._zoomOutButton.setAttribute("aria-disabled",Ae.toString())}_rotateCompassArrow(){const k=this._map;if(!k)return;const F=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(k.transform.pitch*(Math.PI/180)),.5)}) rotateX(${k.transform.pitch}deg) rotateZ(${k.transform.angle*(180/Math.PI)}deg)`:`rotate(${k.transform.angle*(180/Math.PI)}deg)`;k._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=F)}))}onAdd(k){return this._map=k,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),k.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&k.on("pitch",this._rotateCompassArrow),k.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new al(k,this._compass,this.options.visualizePitch)),this._container}onRemove(){const k=this._map;k&&(this._container.remove(),this.options.showZoom&&k.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&k.off("pitch",this._rotateCompassArrow),k.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(k,F){const Me=l("button",k,this._container);return Me.type="button",Me.addEventListener("click",F),Me}_setButtonTitle(k,F){if(!this._map)return;const Me=this._map._getUIString(`NavigationControl.${F}`);k.setAttribute("aria-label",Me),k.firstElementChild&&k.firstElementChild.setAttribute("title",Me)}},GeolocateControl:class extends k.E{constructor(F={}){super();const Me=navigator.geolocation;this.options=k.l({geolocation:Me},uf,F),k.aP(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=$a(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(k){return this._map=k,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(k){const t=(F=!!this.options.geolocation)=>{this._supportsGeolocation=F,k(F)};void 0!==this._supportsGeolocation?k(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((k=>t("denied"!==k.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(k){const F=this._map.getMaxBounds(),Me=k.coords;return!!F&&(Me.longitude<F.getWest()||Me.longitude>F.getEast()||Me.latitude<F.getSouth()||Me.latitude>F.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(F){if(this._map){if(this._isOutOfMapMaxBounds(F))return this._setErrorState(),this.fire(new k.z("outofmaxbounds",F)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=F,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(F),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(F),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new k.z("geolocate",F)),this._finish()}}_updateCamera(F){const Me=new k.bO(F.coords.longitude,F.coords.latitude),Ae=F.coords.accuracy,Oe=this._map.getBearing(),Fe=k.l({bearing:Oe},this.options.fitBoundsOptions);this._map.fitBounds(Me.toBounds(Ae),Fe,{geolocateSource:!0})}_updateMarker(F){if(F){const Me=new k.bO(F.coords.longitude,F.coords.latitude);this._accuracyCircleMarker.setLngLat(Me).addTo(this._map),this._userLocationDotMarker.setLngLat(Me).addTo(this._map),this._accuracy=F.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const F=this._map.transform,Me=k.bH(1,F._center.lat)*F.worldSize,Ae=Math.ceil(2*this._accuracy*Me);this._circleElement.style.width=`${Ae}px`,this._circleElement.style.height=`${Ae}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(F){if(this._map){if(this.options.trackUserLocation)if(1===F.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const k=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",k),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",k),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===F.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new k.z("error",F)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(F){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(k=>k.preventDefault())),this._geolocateButton=l("button","mapboxgl-ctrl-geolocate",this._container),l("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===F){k.w("Geolocation support is not available so the GeolocateControl will be disabled.");const F=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F)}else{const k=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",k),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",k)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l("div","mapboxgl-user-location"),this._dotElement.appendChild(l("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(l("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new cl({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=l("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new cl({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(F=>{F.geolocateSource||"ACTIVE_LOCK"!==this._watchState||F.originalEvent&&"resize"===F.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new k.z("trackuserlocationend")))}))}}_onDeviceOrientation(k){this._userLocationDotMarker&&(k.webkitCompassHeading?this._heading=k.webkitCompassHeading:!0===k.absolute&&(this._heading=-1*k.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return k.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new k.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new k.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new k.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let k;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(k={maximumAge:6e5,timeout:0},this._noTimeout=!0):(k=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,k),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((k=>{"granted"===k&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Xn,ScaleControl:class{constructor(F={}){this.options=k.l({},pf,F),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(k){return!1}}(),k.aP(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const k=this.options.maxWidth||100,F=this._map,Me=F._containerHeight/2,Ae=F._containerWidth/2-k/2,Oe=F.unproject([Ae,Me]),Fe=F.unproject([Ae+k,Me]),je=Oe.distanceTo(Fe);if("imperial"===this.options.unit){const F=3.2808*je;F>5280?this._setScale(k,F/5280,"mile"):this._setScale(k,F,"foot")}else"nautical"===this.options.unit?this._setScale(k,je/1852,"nautical-mile"):je>=1e3?this._setScale(k,je/1e3,"kilometer"):this._setScale(k,je,"meter")}_setScale(k,F,Me){this._map._requestDomTask((()=>{const Ae=function(k){const F=Math.pow(10,`${Math.floor(k)}`.length-1);let Me=k/F;return Me=Me>=10?10:Me>=5?5:Me>=3?3:Me>=2?2:Me>=1?1:function(k){const F=Math.pow(10,Math.ceil(-Math.log(k)/Math.LN10));return Math.round(k*F)/F}(Me),F*Me}(F),Oe=Ae/F;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==Me?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:Me}).format(Ae):`${Ae}&nbsp;${ff[Me]}`,this._container.style.width=k*Oe+"px"}))}onAdd(k){return this._map=k,this._language=k.getLanguage(),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-scale",k.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(k){this._language=k,this._update()}setUnit(k){this.options.unit=k,this._update()}},FullscreenControl:class{constructor(F={}){this._fullscreen=!1,F&&F.container&&(F.container instanceof HTMLElement?this._container=F.container:k.w("Full screen control 'container' must be a DOM element.")),k.aP(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(F){return this._map=F,this._container||(this._container=this._map.getContainer()),this._controlContainer=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",k.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const k=this._fullscreenButton=l("button","mapboxgl-ctrl-fullscreen",this._controlContainer);l("span","mapboxgl-ctrl-icon",k).setAttribute("aria-hidden","true"),k.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const k=this._getTitle();this._fullscreenButton.setAttribute("aria-label",k),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",k)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends k.E{constructor(F){super(),this.options=k.l(Object.create(gf),F),k.aP(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(F&&F.className?F.className.trim().split(/\s+/):[])}addTo(F){return this._map&&this.remove(),this._map=F,this.options.closeOnClick&&F.on("preclick",this._onClose),this.options.closeOnMove&&F.on("move",this._onClose),F.on("remove",this.remove),this._update(),F._addPopup(this),this._focusFirstElement(),this._trackPointer?(F.on("mousemove",this._onMouseEvent),F.on("mouseup",this._onMouseEvent),F._canvasContainer.classList.add("mapboxgl-track-pointer")):F.on("move",this._update),this.fire(new k.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const F=this._map;return F&&(F.off("move",this._update),F.off("move",this._onClose),F.off("preclick",this._onClose),F.off("click",this._onClose),F.off("remove",this.remove),F.off("mousemove",this._onMouseEvent),F.off("mouseup",this._onMouseEvent),F.off("drag",this._onMouseEvent),F._canvasContainer&&F._canvasContainer.classList.remove("mapboxgl-track-pointer"),F._removePopup(this),this._map=void 0),this.fire(new k.z("close")),this}getLngLat(){return this._lngLat}setLngLat(F){this._lngLat=k.bO.convert(F),this._pos=null,this._trackPointer=!1,this._update();const Me=this._map;return Me&&(Me.on("move",this._update),Me.off("mousemove",this._onMouseEvent),Me._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const k=this._map;return k&&(k.off("move",this._update),k.on("mousemove",this._onMouseEvent),k.on("drag",this._onMouseEvent),k._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(k){return this.setDOMContent(document.createTextNode(k))}setHTML(k){const F=document.createDocumentFragment(),Me=document.createElement("body");let Ae;for(Me.innerHTML=k;Ae=Me.firstChild,Ae;)F.appendChild(Ae);return this.setDOMContent(F)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(k){return this.options.maxWidth=k,this._update(),this}setDOMContent(k){let F=this._content;if(F)for(;F.hasChildNodes();)F.firstChild&&F.removeChild(F.firstChild);else F=this._content=l("div","mapboxgl-popup-content",this._container||void 0);if(F.appendChild(k),this.options.closeButton){const k=this._closeButton=l("button","mapboxgl-popup-close-button",F);k.type="button",k.setAttribute("aria-label","Close popup"),k.setAttribute("aria-hidden","true"),k.innerHTML="&#215;",k.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(k){return this._classList.add(k),this._updateClassList(),this}removeClassName(k){return this._classList.delete(k),this._updateClassList(),this}setOffset(k){return this.options.offset=k,this._update(),this}toggleClassName(k){let F;return this._classList.delete(k)?F=!1:(this._classList.add(k),F=!0),this._updateClassList(),F}_onMouseEvent(k){this._update(k.point)}_getAnchor(k){if(this.options.anchor)return this.options.anchor;const F=this._map,Me=this._container,Ae=this._pos;if(!F||!Me||!Ae)return"bottom";const Oe=Me.offsetWidth,Fe=Me.offsetHeight,je=Ae.x<Oe/2,qe=Ae.x>F.transform.width-Oe/2;if(Ae.y+k<Fe)return je?"top-left":qe?"top-right":"top";if(Ae.y>F.transform.height-Fe){if(je)return"bottom-left";if(qe)return"bottom-right"}return je?"left":qe?"right":"bottom"}_updateClassList(){const k=this._container;if(!k)return;const F=[...this._classList];F.push("mapboxgl-popup"),this._anchor&&F.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&F.push("mapboxgl-popup-track-pointer"),k.className=F.join(" ")}_update(F){const Me=this._map,Ae=this._content;if(!Me||!this._lngLat&&!this._trackPointer||!Ae)return;let Oe=this._container;if(Oe||(Oe=this._container=l("div","mapboxgl-popup",Me.getContainer()),this._tip=l("div","mapboxgl-popup-tip",Oe),Oe.appendChild(Ae)),this.options.maxWidth&&Oe.style.maxWidth!==this.options.maxWidth&&(Oe.style.maxWidth=this.options.maxWidth),Me.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=nl(this._lngLat,this._pos,Me.transform)),!this._trackPointer||F){const Ae=this._pos=this._trackPointer&&F instanceof k.P?F:Me.project(this._lngLat),Oe=fl(this.options.offset),Fe=this._anchor=this._getAnchor(Oe.y),je=fl(this.options.offset,Fe),qe=Ae.add(je).round();Me._requestDomTask((()=>{this._container&&Fe&&(this._container.style.transform=`${lf[Fe]} translate(${qe.x}px,${qe.y}px)`)}))}if(!this._marker&&Me._showingGlobe()){const F=k.dH(Me.transform,this._lngLat)?0:1;this._setOpacity(F)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const k=this._container.querySelector(xf);k&&k.focus()}_onClose(){this.remove()}_setOpacity(k){this._container&&(this._container.style.opacity=`${k}`),this._content&&(this._content.style.pointerEvents=k?"auto":"none")}},Marker:cl,Style:bo,LngLat:k.bO,LngLatBounds:k.az,Point:k.P,MercatorCoordinate:k.aa,FreeCameraOptions:Hi,Evented:k.E,config:k.e,prewarm:k.dM,clearPrewarmedResources:k.dN,get accessToken(){return k.e.ACCESS_TOKEN},set accessToken(F){k.e.ACCESS_TOKEN=F},get baseApiUrl(){return k.e.API_URL},set baseApiUrl(F){k.e.API_URL=F},get workerCount(){return k.dO.workerCount},set workerCount(F){k.dO.workerCount=F},get maxParallelImageRequests(){return k.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(F){k.e.MAX_PARALLEL_IMAGE_REQUESTS=F},clearStorage(F){k.dP(F)},get workerUrl(){return k.dQ.workerUrl},set workerUrl(F){k.dQ.workerUrl=F},get workerClass(){return k.dQ.workerClass},set workerClass(F){k.dQ.workerClass=F},get workerParams(){return k.dQ.workerParams},set workerParams(F){k.dQ.workerParams=F},get dracoUrl(){return k.dR()},set dracoUrl(F){k.dS(F)},get meshoptUrl(){return k.dT()},set meshoptUrl(F){k.dU(F)},setNow:k.q.setNow,restoreNow:k.q.restoreNow};return wf}));var Oe=Ae;return Oe}));var Me=F;export{Me as default};

